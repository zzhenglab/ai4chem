
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lecture 14 - Bayesian Optimization &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lecture-14';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to CHEM 5080: AI for Chemistry
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="lecture-01.html">Lecture 1 - Python Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-02.html">Lecture 2 - Pandas and Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-03.html">Lecture 3 - SMILES and RDKit</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-04.html">Lecture 4 - Chemical Structure Identifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-05.html">Lecture 5 - Regression and Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-06.html">Lecture 6 - Cross-Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-07.html">Lecture 7 - Decision Trees and Random Forests</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-08.html">Lecture 8 - Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-09.html">Lecture 9 - Graph Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-10.html">Lecture 10 - Property &amp; Reaction Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-11.html">Lecture 11 - Dimension Reduction for Data Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-12.html">Lecture 12 - Self-Supervised Learning</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Flecture-14.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/lecture-14.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lecture 14 - Bayesian Optimization</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals-and-setup">1. Learning goals and setup</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-and-global-settings">1.1 Imports and global settings</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#small-helpers-for-plotting">1.2 Small helpers for plotting</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-bayesian-optimization">2. What is Bayesian Optimization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-tiny-1d-objective-for-intuition">2.1 A tiny 1D objective for intuition</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-process-surrogate-prior-posterior-kernel">3. Gaussian Process surrogate: prior, posterior, kernel</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#draw-function-samples-from-the-prior">3.1 Draw function samples from the prior</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-gp-posterior-on-a-few-points">3.2 Fit GP posterior on a few points</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#acquisition-functions-ei-ucb-pi-greedy">4. Acquisition functions: EI, UCB, PI, greedy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implement-acquisition-functions">4.1 Implement acquisition functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-acquisition-shapes">4.2 Visualize acquisition shapes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-bo-loop-in-1d-step-by-step">5. The BO loop in 1D step by step</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#small-utility-argmax-on-a-grid">5.1 Small utility: argmax on a grid</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-bo-with-ei">5.2 Run BO with EI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#where-did-bo-sample">5.3 Where did BO sample</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#surrogate-alternatives-and-simple-diagnostics">6. Surrogate alternatives and simple diagnostics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest-surrogate-mean-and-std-from-trees">6.1 Random Forest surrogate: mean and std from trees</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bo-loop-with-rf-surrogate-ucb">6.2 BO loop with RF surrogate (UCB)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#small-neural-surrogate-optional">6.3 Small neural surrogate (optional)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#chemistry-case-study-suzuki-coupling-toy-dataset">8. Chemistry case study: Suzuki coupling toy dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-the-toy-suzuki-dataset">8.1 Create the toy Suzuki dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visual-slices-of-the-surface">8.2 Visual slices of the surface</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#normalize-the-space-to-0-1-3">8.3 Normalize the space to [0,1]^3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bo-on-the-suzuki-surface-with-a-gp-surrogate">8.4 BO on the Suzuki surface with a GP surrogate</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compare-to-grid-and-random-for-the-same-number-of-lab-runs">8.5 Compare to grid and random for the same number of lab runs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-quick-rf-surrogate-on-suzuki">8.6 A quick RF surrogate on Suzuki</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">9. Glossary</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lecture-14-bayesian-optimization">
<h1>Lecture 14 - Bayesian Optimization<a class="headerlink" href="#lecture-14-bayesian-optimization" title="Link to this heading">#</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#learning-goals-and-setup" id="id1">1. Learning goals and setup</a></p></li>
<li><p><a class="reference internal" href="#what-is-bayesian-optimization" id="id2">2. What is Bayesian Optimization</a></p></li>
<li><p><a class="reference internal" href="#gaussian-process-surrogate-prior-posterior-kernel" id="id3">3. Gaussian Process surrogate: prior, posterior, kernel</a></p></li>
<li><p><a class="reference internal" href="#acquisition-functions-ei-ucb-pi-greedy" id="id4">4. Acquisition functions: EI, UCB, PI, greedy</a></p></li>
<li><p><a class="reference internal" href="#the-bo-loop-in-1d-step-by-step" id="id5">5. The BO loop in 1D step by step</a></p></li>
<li><p><a class="reference internal" href="#surrogate-alternatives-and-simple-diagnostics" id="id6">6. Surrogate alternatives and simple diagnostics</a></p></li>
<li><p><a class="reference internal" href="#chemistry-case-study-suzuki-coupling-toy-dataset" id="id7">8. Chemistry case study: Suzuki coupling toy dataset</a></p></li>
<li><p><a class="reference internal" href="#glossary" id="id8">9. Glossary</a></p></li>
</ul>
</nav>
<section id="learning-goals-and-setup">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">1. Learning goals and setup</a><a class="headerlink" href="#learning-goals-and-setup" title="Link to this heading">#</a></h2>
<p><strong>Learning goals</strong></p>
<ul class="simple">
<li><p>Explain the ideas behind <strong>Bayesian Optimization</strong> for expensive experiments.</p></li>
<li><p>Define <strong>prior belief</strong>, <strong>surrogate model</strong> (GP, RF, small NN), and <strong>acquisition function</strong> (EI, UCB, PI, greedy).</p></li>
<li><p>Code the BO loop step by step: fit surrogate, compute acquisition, pick next point, update data.</p></li>
<li><p>Compare BO to grid and random search for <strong>hyperparameter tuning</strong>.</p></li>
<li><p>Run a chemistry case study: toy <strong>Suzuki coupling</strong> with three controllable factors (time, temperature, concentration) to optimize yield.</p></li>
</ul>
<p>We will keep each code step small, print key shapes, and visualize intermediate structures. Exercises appear after short sections so you can practice by changing something nearby.</p>
<hr class="docutils" />
<section id="imports-and-global-settings">
<h3>1.1 Imports and global settings<a class="headerlink" href="#imports-and-global-settings" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1.1 Imports and global settings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="c1"># scikit-learn pieces</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">MinMaxScaler</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.gaussian_process</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.gaussian_process.kernels</span><span class="w"> </span><span class="kn">import</span> <span class="n">RBF</span><span class="p">,</span> <span class="n">Matern</span><span class="p">,</span> <span class="n">WhiteKernel</span><span class="p">,</span> <span class="n">ConstantKernel</span> <span class="k">as</span> <span class="n">C</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neural_network</span><span class="w"> </span><span class="kn">import</span> <span class="n">MLPRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">KFold</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">5.2</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<p>We will use <strong>GaussianProcessRegressor</strong> for the GP surrogate, <strong>RandomForestRegressor</strong> for a tree ensemble surrogate, and a small <strong>MLPRegressor</strong> for a neural surrogate. You will see how to read out mean and uncertainty from each.</p>
</section>
<hr class="docutils" />
<section id="small-helpers-for-plotting">
<h3>1.2 Small helpers for plotting<a class="headerlink" href="#small-helpers-for-plotting" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1.2 Small plotting helpers</span>
<span class="k">def</span><span class="w"> </span><span class="nf">parity</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Parity&quot;</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="n">lo</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_true</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_true</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">],</span> <span class="p">[</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">],</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;True&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Predicted&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">line_plot_with_ci</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">):</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="n">x_ord</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">m_ord</span> <span class="o">=</span> <span class="n">mean</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">s_ord</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_ord</span><span class="p">,</span> <span class="n">m_ord</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_ord</span><span class="p">,</span> <span class="n">m_ord</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">s_ord</span><span class="p">,</span> <span class="n">m_ord</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">s_ord</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Each helper is short. We keep them minimal so you can reuse them in exercises.</p>
</section>
</section>
<hr class="docutils" />
<section id="what-is-bayesian-optimization">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">2. What is Bayesian Optimization</a><a class="headerlink" href="#what-is-bayesian-optimization" title="Link to this heading">#</a></h2>
<p>Bayesian Optimization (BO) is a strategy to optimize an unknown objective <span class="math notranslate nohighlight">\(f(x)\)</span> when evaluations are expensive. Think of <span class="math notranslate nohighlight">\(f(x)\)</span> as a reaction yield produced by a full experiment. We want to find <span class="math notranslate nohighlight">\(x^*\)</span> that maximizes <span class="math notranslate nohighlight">\(f(x)\)</span> using as few experiments as possible.</p>
<p>The workflow:</p>
<ol class="arabic simple">
<li><p><strong>Prior belief</strong> about <span class="math notranslate nohighlight">\(f\)</span> (for example a GP prior).</p></li>
<li><p><strong>Surrogate model</strong> that maps <span class="math notranslate nohighlight">\(x \mapsto\)</span> a predictive <strong>mean</strong> <span class="math notranslate nohighlight">\(\mu(x)\)</span> and <strong>uncertainty</strong> <span class="math notranslate nohighlight">\(\sigma(x)\)</span>.</p></li>
<li><p><strong>Acquisition function</strong> <span class="math notranslate nohighlight">\(a(x)\)</span> that scores how attractive <span class="math notranslate nohighlight">\(x\)</span> is to try next, combining exploration and exploitation.</p></li>
<li><p><strong>Update</strong> the dataset with the new measurement and refit the surrogate.</p></li>
</ol>
<p>We repeat 2 to 4 until the budget is used.</p>
<hr class="docutils" />
<section id="a-tiny-1d-objective-for-intuition">
<h3>2.1 A tiny 1D objective for intuition<a class="headerlink" href="#a-tiny-1d-objective-for-intuition" title="Link to this heading">#</a></h3>
<p>We define a 1D function as a stand-in for an expensive lab run. You will not see this function inside the BO loop. The optimizer only sees measured points.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 2.1 A 1D &quot;hidden&quot; objective (for teaching)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f_true_1d</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># x shape: (n, 1)</span>
    <span class="c1"># multi-peak, smooth, with a small penalty on the right</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">0.6</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">3.2</span><span class="o">*</span><span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
        <span class="mf">0.9</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">1.2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span>
        <span class="mf">0.4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.8</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span>
        <span class="mf">0.08</span><span class="o">*</span><span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="c1"># Grid for plotting the landscape (which BO will never peek)</span>
<span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y_grid</span> <span class="o">=</span> <span class="n">f_true_1d</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>

<span class="n">x_grid</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y_grid</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([-2.        , -1.98997494, -1.97994987]),
 array([0.07299499, 0.09041552, 0.10784925]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Inspect the shape and a quick plot to build intuition</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;x_grid shape:&quot;</span><span class="p">,</span> <span class="n">x_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;y_grid shape:&quot;</span><span class="p">,</span> <span class="n">y_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Hidden objective f_true_1d (for visualization only)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;f(x)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>x_grid shape: (400, 1) y_grid shape: (400,)
</pre></div>
</div>
<img alt="_images/4800a554816258652c8c963b8f14fd53252d2ae035332976a07d88d39fcef84e.png" src="_images/4800a554816258652c8c963b8f14fd53252d2ae035332976a07d88d39fcef84e.png" />
</div>
</div>
<p>We will now forget the formula and pretend we only get noisy measurements of <span class="math notranslate nohighlight">\(f(x)\)</span> at points we choose.</p>
<hr class="docutils" />
<div class="admonition-exercise-2-1 admonition">
<p class="admonition-title">Exercise 2.1</p>
<p>Change the function by adding <code class="docutils literal notranslate"><span class="pre">+</span> <span class="pre">0.15*np.cos(5.5*x[:,0])</span></code> inside <code class="docutils literal notranslate"><span class="pre">f_true_1d</span></code>. Re-run the plot to see how the landscape changes. Which region becomes more attractive?</p>
</div>
</section>
</section>
<hr class="docutils" />
<section id="gaussian-process-surrogate-prior-posterior-kernel">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">3. Gaussian Process surrogate: prior, posterior, kernel</a><a class="headerlink" href="#gaussian-process-surrogate-prior-posterior-kernel" title="Link to this heading">#</a></h2>
<p>A <strong>Gaussian Process (GP)</strong> defines a distribution over functions. You can think of it as a smooth prior belief about how <span class="math notranslate nohighlight">\(f\)</span> behaves.</p>
<ul class="simple">
<li><p>Prior: <span class="math notranslate nohighlight">\(f(x) \sim \mathcal{GP}(m(x), k(x, x'))\)</span> with mean <span class="math notranslate nohighlight">\(m(x)\)</span> (often zero) and kernel <span class="math notranslate nohighlight">\(k\)</span>.</p></li>
<li><p>After observing data <span class="math notranslate nohighlight">\(\mathcal{D} = \{(x_i, y_i)\}\)</span>, the GP produces a <strong>posterior</strong> with mean <span class="math notranslate nohighlight">\(\mu(x)\)</span> and standard deviation <span class="math notranslate nohighlight">\(\sigma(x)\)</span> at any new <span class="math notranslate nohighlight">\(x\)</span>.</p></li>
</ul>
<p>Key knob: the <strong>kernel</strong> (RBF, Matern, etc.) and its <strong>length scale</strong> which controls smoothness. We will use RBF and Matern.</p>
<hr class="docutils" />
<section id="draw-function-samples-from-the-prior">
<h3>3.1 Draw function samples from the prior<a class="headerlink" href="#draw-function-samples-from-the-prior" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 3.1 Sample from a GP prior to feel how kernels shape functions</span>
<span class="n">kernel_prior</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">RBF</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">gpr_prior</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel_prior</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">normalize_y</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># not fitted</span>
<span class="n">ys</span> <span class="o">=</span> <span class="n">gpr_prior</span><span class="o">.</span><span class="n">sample_y</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Prior sample matrix shape:&quot;</span><span class="p">,</span> <span class="n">ys</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># 400 x 3</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Samples from GP prior (RBF, length_scale=0.6)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;sampled f(x)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Prior sample matrix shape: (400, 3)
</pre></div>
</div>
<img alt="_images/1cdaa1ab5587ce7473baf987209a1ab0fc461906c3af00c85fb6b1917e07ae45.png" src="_images/1cdaa1ab5587ce7473baf987209a1ab0fc461906c3af00c85fb6b1917e07ae45.png" />
</div>
</div>
<p>Longer length scale gives smoother functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Try a longer length scale</span>
<span class="n">kernel_prior2</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">RBF</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">gpr_prior2</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel_prior2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">)</span>
<span class="n">ys2</span> <span class="o">=</span> <span class="n">gpr_prior2</span><span class="o">.</span><span class="n">sample_y</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">ys2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Samples from GP prior (RBF, length_scale=1.5)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;sampled f(x)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9b9896e4de3fe53cd9854bb30e4dd88ed3553f00eb506e8157042fc515dd7068.png" src="_images/9b9896e4de3fe53cd9854bb30e4dd88ed3553f00eb506e8157042fc515dd7068.png" />
</div>
</div>
</section>
<hr class="docutils" />
<section id="fit-gp-posterior-on-a-few-points">
<h3>3.2 Fit GP posterior on a few points<a class="headerlink" href="#fit-gp-posterior-on-a-few-points" title="Link to this heading">#</a></h3>
<p>We start with 3 random points. Measurements are noisy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 3.2 Initial data</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">X_init</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">y_init</span> <span class="o">=</span> <span class="n">f_true_1d</span><span class="p">(</span><span class="n">X_init</span><span class="p">)</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,))</span>

<span class="n">X_init</span><span class="p">,</span> <span class="n">y_init</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([[0.19525402],
        [0.86075747],
        [0.4110535 ]]),
 array([0.71004833, 1.07242262, 1.14352324]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build a GP with a small noise term (WhiteKernel)</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">))</span> <span class="o">*</span> <span class="n">RBF</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">length_scale_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">))</span> <span class="o">+</span> <span class="n">WhiteKernel</span><span class="p">(</span><span class="n">noise_level</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>
<span class="n">gp</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">n_restarts_optimizer</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">normalize_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_init</span><span class="p">,</span> <span class="n">y_init</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Learned kernel:&quot;</span><span class="p">,</span> <span class="n">gp</span><span class="o">.</span><span class="n">kernel_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Learned kernel: 0.998**2 * RBF(length_scale=0.01) + WhiteKernel(noise_level=0.00389)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Predict posterior mean and std on a dense grid</span>
<span class="n">mu</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">line_plot_with_ci</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;GP posterior after 3 points&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;mean  1.96 std&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7d3136dbf510d615f849685663dfef5cae72081d1a1a12d1a278a1a31ea5ff1b.png" src="_images/7d3136dbf510d615f849685663dfef5cae72081d1a1a12d1a278a1a31ea5ff1b.png" />
</div>
</div>
<p>We can overlay the current data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Overlay data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;posterior mean&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_grid</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">mu</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">std</span><span class="p">,</span> <span class="n">mu</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">std</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;95% CI&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_init</span><span class="p">,</span> <span class="n">y_init</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;observed&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;GP posterior and data&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9f4db0cf25fa5699872995d4ec366589be8ccc753900d6549a488a00cffb7622.png" src="_images/9f4db0cf25fa5699872995d4ec366589be8ccc753900d6549a488a00cffb7622.png" />
</div>
</div>
<div class="admonition-exercise-3-2 admonition">
<p class="admonition-title">Exercise 3.2</p>
<p>Change the kernel to <code class="docutils literal notranslate"><span class="pre">Matern(length_scale=0.8,</span> <span class="pre">nu=2.5)</span></code> plus <code class="docutils literal notranslate"><span class="pre">WhiteKernel</span></code>. Fit again and compare the uncertainty band. Which kernel seems to capture sharper bumps?</p>
</div>
</section>
</section>
<hr class="docutils" />
<section id="acquisition-functions-ei-ucb-pi-greedy">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">4. Acquisition functions: EI, UCB, PI, greedy</a><a class="headerlink" href="#acquisition-functions-ei-ucb-pi-greedy" title="Link to this heading">#</a></h2>
<p>An <strong>acquisition function</strong> <span class="math notranslate nohighlight">\(a(x)\)</span> scores how useful a new evaluation at <span class="math notranslate nohighlight">\(x\)</span> would be. It uses <span class="math notranslate nohighlight">\(\mu(x)\)</span> and <span class="math notranslate nohighlight">\(\sigma(x)\)</span> from the surrogate.</p>
<p>We will maximize the acquisition (so higher is better) for <strong>maximization</strong> problems.</p>
<p>Let <span class="math notranslate nohighlight">\(y^+\)</span> be the best observed value so far and <span class="math notranslate nohighlight">\(\xi \ge 0\)</span> a small margin to encourage exploration.</p>
<ul class="simple">
<li><p><strong>Expected Improvement</strong><br />
$<span class="math notranslate nohighlight">\(
\mathrm{EI}(x) = (\mu(x) - y^+ - \xi)\,\Phi(z) + \sigma(x)\,\phi(z)
\)</span><span class="math notranslate nohighlight">\(
where \)</span>z = \frac{\mu(x) - y^+ - \xi}{\sigma(x)}<span class="math notranslate nohighlight">\(, and \)</span>\Phi<span class="math notranslate nohighlight">\( and \)</span>\phi$ are the CDF and PDF of the standard normal.</p></li>
<li><p><strong>Upper Confidence Bound</strong><br />
$<span class="math notranslate nohighlight">\(
\mathrm{UCB}(x) = \mu(x) + \kappa\,\sigma(x)
\)</span><span class="math notranslate nohighlight">\(
where \)</span>\kappa &gt; 0$ controls exploration.</p></li>
<li><p><strong>Probability of Improvement</strong><br />
$<span class="math notranslate nohighlight">\(
\mathrm{PI}(x) = \Phi\!\left(\frac{\mu(x) - y^+ - \xi}{\sigma(x)}\right)
\)</span>$</p></li>
<li><p><strong>Greedy</strong> (exploitation only)<br />
$<span class="math notranslate nohighlight">\(
a(x) = \mu(x)
\)</span>$</p></li>
</ul>
<hr class="docutils" />
<section id="implement-acquisition-functions">
<h3>4.1 Implement acquisition functions<a class="headerlink" href="#implement-acquisition-functions" title="Link to this heading">#</a></h3>
<p>We write short functions that accept arrays of <span class="math notranslate nohighlight">\(\mu\)</span>, <span class="math notranslate nohighlight">\(\sigma\)</span>, and the current best <span class="math notranslate nohighlight">\(y^+\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 4.1 Acquisition functions</span>
<span class="k">def</span><span class="w"> </span><span class="nf">acq_ei</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">y_best</span><span class="p">,</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">y_best</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">y_best</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">acq_ucb</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">kappa</span> <span class="o">*</span> <span class="n">sigma</span>

<span class="k">def</span><span class="w"> </span><span class="nf">acq_pi</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">y_best</span><span class="p">,</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">y_best</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span>
    <span class="k">return</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">acq_greedy</span><span class="p">(</span><span class="n">mu</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mu</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sanity check: simple arrays</span>
<span class="n">mu_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
<span class="n">sd_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EI:&quot;</span><span class="p">,</span> <span class="n">acq_ei</span><span class="p">(</span><span class="n">mu_test</span><span class="p">,</span> <span class="n">sd_test</span><span class="p">,</span> <span class="n">y_best</span><span class="o">=</span><span class="mf">0.15</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;UCB:&quot;</span><span class="p">,</span> <span class="n">acq_ucb</span><span class="p">(</span><span class="n">mu_test</span><span class="p">,</span> <span class="n">sd_test</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PI:&quot;</span><span class="p">,</span> <span class="n">acq_pi</span><span class="p">(</span><span class="n">mu_test</span><span class="p">,</span> <span class="n">sd_test</span><span class="p">,</span> <span class="n">y_best</span><span class="o">=</span><span class="mf">0.15</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Greedy:&quot;</span><span class="p">,</span> <span class="n">acq_greedy</span><span class="p">(</span><span class="n">mu_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>EI: [0.00280512 0.06304388 0.34365756]
UCB: [0.15 0.3  0.7 ]
PI: [0.11506967 0.65542174 0.95543454]
Greedy: [0.1 0.2 0.5]
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="visualize-acquisition-shapes">
<h3>4.2 Visualize acquisition shapes<a class="headerlink" href="#visualize-acquisition-shapes" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 4.2 Acquisition profiles over x_grid with current GP</span>
<span class="n">y_best</span> <span class="o">=</span> <span class="n">y_init</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">mu</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ei_vals</span> <span class="o">=</span> <span class="n">acq_ei</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">y_best</span><span class="o">=</span><span class="n">y_best</span><span class="p">,</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">ucb_vals</span> <span class="o">=</span> <span class="n">acq_ucb</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
<span class="n">pi_vals</span>  <span class="o">=</span> <span class="n">acq_pi</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">y_best</span><span class="o">=</span><span class="n">y_best</span><span class="p">,</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">greedy_v</span> <span class="o">=</span> <span class="n">acq_greedy</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">ei_vals</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Expected Improvement&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">ucb_vals</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Upper Confidence Bound&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">pi_vals</span><span class="p">);</span>  <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Probability of Improvement&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">greedy_v</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Greedy (mean)&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;acq value&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d15299ab77275d004af96006a18117754294f56f4e19bfbe17a1d4f385176868.png" src="_images/d15299ab77275d004af96006a18117754294f56f4e19bfbe17a1d4f385176868.png" />
</div>
</div>
<div class="admonition-tip admonition">
<p class="admonition-title">Tip</p>
<ul class="simple">
<li><p>EI and PI look at improvement over the current best.</p></li>
<li><p>UCB trades off mean and uncertainty with a single knob kappa.</p></li>
<li><p>Greedy ignores uncertainty and will often get stuck.</p></li>
</ul>
</div>
<div class="admonition-exercise-4-2 admonition">
<p class="admonition-title">Exercise 4.2</p>
<p>Increase <code class="docutils literal notranslate"><span class="pre">kappa</span></code> from 2.0 to 4.0 in UCB and replot. What regions rise in score when you increase exploration?</p>
</div>
</section>
</section>
<hr class="docutils" />
<section id="the-bo-loop-in-1d-step-by-step">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">5. The BO loop in 1D step by step</a><a class="headerlink" href="#the-bo-loop-in-1d-step-by-step" title="Link to this heading">#</a></h2>
<p>We now implement the loop:</p>
<ol class="arabic simple">
<li><p>Fit surrogate to <span class="math notranslate nohighlight">\((X, y)\)</span>.</p></li>
<li><p>Compute <span class="math notranslate nohighlight">\(\mu\)</span>, <span class="math notranslate nohighlight">\(\sigma\)</span> on a candidate set.</p></li>
<li><p>Compute acquisition <span class="math notranslate nohighlight">\(a(x)\)</span> and pick <span class="math notranslate nohighlight">\(x_{next} = \arg\max a(x)\)</span>.</p></li>
<li><p>Run the experiment (here we call <code class="docutils literal notranslate"><span class="pre">f_true_1d</span></code>) to get <span class="math notranslate nohighlight">\(y_{next}\)</span>.</p></li>
<li><p>Append to data and go back to step 1.</p></li>
</ol>
<p>We will do 15 iterations and look at the history.</p>
<hr class="docutils" />
<section id="small-utility-argmax-on-a-grid">
<h3>5.1 Small utility: argmax on a grid<a class="headerlink" href="#small-utility-argmax-on-a-grid" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 5.1 Argmax on a grid</span>
<span class="k">def</span><span class="w"> </span><span class="nf">argmax_on_grid</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">grid</span><span class="p">):</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">grid</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">idx</span>

<span class="c1"># Quick check</span>
<span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">])</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x_star</span><span class="p">,</span> <span class="n">idx_star</span> <span class="o">=</span> <span class="n">argmax_on_grid</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>
<span class="n">x_star</span><span class="p">,</span> <span class="n">idx_star</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([[40]]), np.int64(3))
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="run-bo-with-ei">
<h3>5.2 Run BO with EI<a class="headerlink" href="#run-bo-with-ei" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 5.2 BO loop with EI</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">X_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">y_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># same kernel as before</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">RBF</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span> <span class="o">+</span> <span class="n">WhiteKernel</span><span class="p">(</span><span class="n">noise_level</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>
<span class="n">gp</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">normalize_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_restarts_optimizer</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">history_best</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>

<span class="n">n_iter</span> <span class="o">=</span> <span class="mi">15</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iter</span><span class="p">):</span>
    <span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">mu</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">acq</span> <span class="o">=</span> <span class="n">acq_ei</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">y_best</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">x_next</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">argmax_on_grid</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">)</span>
    <span class="n">y_next</span> <span class="o">=</span> <span class="n">f_true_1d</span><span class="p">(</span><span class="n">x_next</span><span class="p">)</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">x_next</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">y_next</span><span class="p">])</span>
    <span class="n">history_best</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">history_best</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(18, 18, 16)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot final posterior and points</span>
<span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">mu</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;posterior mean&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_grid</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">mu</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">std</span><span class="p">,</span> <span class="n">mu</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">std</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;95% CI&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Posterior after EI-BO iterations&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ae2fcde1f15ce71bd5e194bd3fcc87997c594a1932491671c74b0834d2155d10.png" src="_images/ae2fcde1f15ce71bd5e194bd3fcc87997c594a1932491671c74b0834d2155d10.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Track best-so-far vs iteration</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_best</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Best observed f(x)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;EI: best-so-far improvement&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/783e583190768d81a9ec50894d3672f91dc6acf79a3af955c12da4be638d3e95.png" src="_images/783e583190768d81a9ec50894d3672f91dc6acf79a3af955c12da4be638d3e95.png" />
</div>
</div>
<div class="admonition-exercise-5-2 admonition">
<p class="admonition-title">Exercise 5.2</p>
<p>Replace EI with UCB using <code class="docutils literal notranslate"><span class="pre">kappa=2.5</span></code>. Plot the best-so-far curve again. Which method reached a good point faster on this function?</p>
</div>
</section>
<hr class="docutils" />
<section id="where-did-bo-sample">
<h3>5.3 Where did BO sample<a class="headerlink" href="#where-did-bo-sample" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 5.3 Visualize chosen locations on the x axis</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">ravel</span><span class="p">()),</span> <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;order of sampling&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Order of samples chosen by EI&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/36f9445d5db2726fc3eabf7615c6bff6a889cc67ab0f14bd48714266bd4c5b81.png" src="_images/36f9445d5db2726fc3eabf7615c6bff6a889cc67ab0f14bd48714266bd4c5b81.png" />
</div>
</div>
<p>A healthy pattern often shows some early exploration across the space, then a focus on promising regions.</p>
</section>
</section>
<hr class="docutils" />
<section id="surrogate-alternatives-and-simple-diagnostics">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">6. Surrogate alternatives and simple diagnostics</a><a class="headerlink" href="#surrogate-alternatives-and-simple-diagnostics" title="Link to this heading">#</a></h2>
<p>Gaussian Processes are a common surrogate for low to moderate dimensional spaces. For higher dimensions or larger datasets, tree ensembles and small neural surrogates can help.</p>
<p>We try a <strong>RandomForestRegressor</strong> as a surrogate. Its mean is the average prediction across trees, and an uncertainty proxy is the <strong>standard deviation across trees</strong>.</p>
<hr class="docutils" />
<section id="random-forest-surrogate-mean-and-std-from-trees">
<h3>6.1 Random Forest surrogate: mean and std from trees<a class="headerlink" href="#random-forest-surrogate-mean-and-std-from-trees" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 6.1 RF surrogate: using tree-wise predictions for mean and std</span>
<span class="k">def</span><span class="w"> </span><span class="nf">rf_mean_std</span><span class="p">(</span><span class="n">rf</span><span class="p">:</span> <span class="n">RandomForestRegressor</span><span class="p">,</span> <span class="n">Xc</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="c1"># collect predictions from each tree</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xc</span><span class="p">)</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="n">rf</span><span class="o">.</span><span class="n">estimators_</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># shape (n, n_trees)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sd</span>

<span class="c1"># Tiny demo on a few random numbers</span>
<span class="n">rf_demo</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">)</span>
<span class="n">mu_demo</span><span class="p">,</span> <span class="n">sd_demo</span> <span class="o">=</span> <span class="n">rf_mean_std</span><span class="p">(</span><span class="n">rf_demo</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
<span class="n">mu_demo</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">sd_demo</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([0.07822115, 0.08693141, 0.11133447]),
 array([0.00798309, 0.00696821, 0.00697044]))
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="bo-loop-with-rf-surrogate-ucb">
<h3>6.2 BO loop with RF surrogate (UCB)<a class="headerlink" href="#bo-loop-with-rf-surrogate-ucb" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 6.2 RF-based BO with UCB</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">f_true_1d</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,))</span>

<span class="n">history_best_rf</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">mu</span><span class="p">,</span> <span class="n">sd</span> <span class="o">=</span> <span class="n">rf_mean_std</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">)</span>
    <span class="n">acq</span> <span class="o">=</span> <span class="n">acq_ucb</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>  <span class="c1"># adjust kappa to see different exploration levels</span>
    <span class="n">x_next</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">argmax_on_grid</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">)</span>
    <span class="n">y_next</span> <span class="o">=</span> <span class="n">f_true_1d</span><span class="p">(</span><span class="n">x_next</span><span class="p">)</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">x_next</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">y_next</span><span class="p">])</span>
    <span class="n">history_best_rf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_best_rf</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Best observed f(x)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;RF surrogate with UCB&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/40fbb7db4d19bc07427cb4c03a14117e32f12bdbfca5cff048855b3b94fa6cfe.png" src="_images/40fbb7db4d19bc07427cb4c03a14117e32f12bdbfca5cff048855b3b94fa6cfe.png" />
</div>
</div>
<p>The RF surrogate can handle more points without much tuning, and the spread across trees gives a simple uncertainty estimate.</p>
<div class="admonition-exercise-6-2 admonition">
<p class="admonition-title">Exercise 6.2</p>
<p>Switch to a greedy rule with the RF surrogate by setting <code class="docutils literal notranslate"><span class="pre">acq</span> <span class="pre">=</span> <span class="pre">mu</span></code> (the mean). Compare best-so-far curves. What changed?</p>
</div>
</section>
<hr class="docutils" />
<section id="small-neural-surrogate-optional">
<h3>6.3 Small neural surrogate (optional)<a class="headerlink" href="#small-neural-surrogate-optional" title="Link to this heading">#</a></h3>
<p>A one-hidden-layer MLP can be used as a surrogate but uncertainty is not natural. One way is to train several MLPs with different seeds and use the ensemble standard deviation as a proxy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 6.3 Tiny MLP ensemble as surrogate (mean + std across seeds)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mlp_ensemble_mean_std</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">Xc</span><span class="p">,</span> <span class="n">n_models</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_models</span><span class="p">):</span>
        <span class="n">mdl</span> <span class="o">=</span> <span class="n">MLPRegressor</span><span class="p">(</span><span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,),</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span>
                           <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">learning_rate_init</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                           <span class="n">max_iter</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">mdl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mdl</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xc</span><span class="p">))</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (n, n_models)</span>
    <span class="k">return</span> <span class="n">preds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">preds</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Quick test on a small slice</span>
<span class="n">mu_e</span><span class="p">,</span> <span class="n">sd_e</span> <span class="o">=</span> <span class="n">mlp_ensemble_mean_std</span><span class="p">(</span><span class="n">x_grid</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span> <span class="n">y_grid</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span> <span class="n">x_grid</span><span class="p">[:</span><span class="mi">100</span><span class="p">])</span>
<span class="n">mu_e</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">sd_e</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([0.36277799, 0.36438048, 0.36598297]),
 array([0.09908656, 0.0950063 , 0.09095212]))
</pre></div>
</div>
</div>
</div>
<p>This is slower than RF and GP and is here for curiosity. Use only if you have time in class.</p>
</section>
</section>
<hr class="docutils" />
<section id="chemistry-case-study-suzuki-coupling-toy-dataset">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">8. Chemistry case study: Suzuki coupling toy dataset</a><a class="headerlink" href="#chemistry-case-study-suzuki-coupling-toy-dataset" title="Link to this heading">#</a></h2>
<p>We now switch to a chemistry example that mirrors a common experimental optimization. Consider <strong>Suzuki cross coupling</strong> where you can control:</p>
<ul class="simple">
<li><p>Reaction time <span class="math notranslate nohighlight">\(t\)</span> in minutes</p></li>
<li><p>Temperature <span class="math notranslate nohighlight">\(T\)</span> in Celsius</p></li>
<li><p>Substrate concentration <span class="math notranslate nohighlight">\(C\)</span> in molar</p></li>
</ul>
<p>Our goal is to <strong>maximize yield</strong>. We will build a toy function that captures a plausible shape: yield grows with time then plateaus, has a sweet spot in temperature, and prefers a moderate concentration. We also add mild interactions and noise.</p>
<p>We generate 800 points to form a dataset you can explore and also use as an oracle to simulate experiments.</p>
<hr class="docutils" />
<section id="create-the-toy-suzuki-dataset">
<h3>8.1 Create the toy Suzuki dataset<a class="headerlink" href="#create-the-toy-suzuki-dataset" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 8.1 Simulated Suzuki yield function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">suzuki_yield</span><span class="p">(</span><span class="n">time_min</span><span class="p">,</span> <span class="n">temp_c</span><span class="p">,</span> <span class="n">conc_m</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># time_min in 10..180</span>
    <span class="c1"># temp_c in 50..110</span>
    <span class="c1"># conc_m in 0.05..1.00</span>
    <span class="c1"># returns yield in 0..100</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time_min</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temp_c</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">conc_m</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Time effect: saturating curve</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="mf">35.0</span>
    <span class="n">time_term</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="mf">10.0</span><span class="p">)</span><span class="o">/</span><span class="n">t0</span><span class="p">)</span>
    <span class="n">time_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">time_term</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># Temperature: optimal around ~95 but shifts slightly with concentration</span>
    <span class="n">T_opt</span> <span class="o">=</span> <span class="mf">96.0</span> <span class="o">-</span> <span class="mf">6.0</span><span class="o">*</span><span class="p">(</span><span class="n">C</span> <span class="o">-</span> <span class="mf">0.35</span><span class="p">)</span>   <span class="c1"># small interaction: higher C prefers slightly lower T</span>
    <span class="n">sigma_T</span> <span class="o">=</span> <span class="mf">9.0</span>
    <span class="n">temp_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">T</span> <span class="o">-</span> <span class="n">T_opt</span><span class="p">)</span><span class="o">/</span><span class="n">sigma_T</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Concentration: moderate optimum</span>
    <span class="n">C_opt</span> <span class="o">=</span> <span class="mf">0.35</span>
    <span class="n">sigma_C</span> <span class="o">=</span> <span class="mf">0.18</span>
    <span class="n">conc_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">C</span> <span class="o">-</span> <span class="n">C_opt</span><span class="p">)</span><span class="o">/</span><span class="n">sigma_C</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Mild over-cooking penalty</span>
    <span class="n">over</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="mf">140.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">burn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">over</span><span class="o">/</span><span class="mf">25.0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">base</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">time_term</span> <span class="o">*</span> <span class="n">temp_term</span> <span class="o">*</span> <span class="n">conc_term</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.85</span> <span class="o">+</span> <span class="mf">0.15</span><span class="o">*</span><span class="n">burn</span><span class="p">)</span>

    <span class="c1"># small nonlinear coupling term</span>
    <span class="n">coupling</span> <span class="o">=</span> <span class="mf">6.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">0.015</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="mf">70.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">3.0</span><span class="o">*</span><span class="p">(</span><span class="n">C</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">coupling</span>

    <span class="k">if</span> <span class="n">rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>  <span class="c1"># lab noise</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate 800 random experiments</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">800</span>
<span class="n">time_vals</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">temp_vals</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">conc_vals</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>

<span class="n">yield_vals</span> <span class="o">=</span> <span class="n">suzuki_yield</span><span class="p">(</span><span class="n">time_vals</span><span class="p">,</span> <span class="n">temp_vals</span><span class="p">,</span> <span class="n">conc_vals</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

<span class="n">df_suzuki</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;time_min&quot;</span><span class="p">:</span> <span class="n">time_vals</span><span class="p">,</span>
    <span class="s2">&quot;temp_c&quot;</span><span class="p">:</span> <span class="n">temp_vals</span><span class="p">,</span>
    <span class="s2">&quot;conc_m&quot;</span><span class="p">:</span> <span class="n">conc_vals</span><span class="p">,</span>
    <span class="s2">&quot;yield&quot;</span><span class="p">:</span> <span class="n">yield_vals</span>
<span class="p">})</span>
<span class="n">df_suzuki</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time_min</th>
      <th>temp_c</th>
      <th>conc_m</th>
      <th>yield</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>22.972409</td>
      <td>64.034585</td>
      <td>0.345220</td>
      <td>0.393040</td>
    </tr>
    <tr>
      <th>1</th>
      <td>142.586195</td>
      <td>53.914309</td>
      <td>0.623064</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>84.529569</td>
      <td>66.327423</td>
      <td>0.435255</td>
      <td>4.342228</td>
    </tr>
    <tr>
      <th>3</th>
      <td>132.989080</td>
      <td>87.929129</td>
      <td>0.897018</td>
      <td>5.917039</td>
    </tr>
    <tr>
      <th>4</th>
      <td>176.258217</td>
      <td>104.653480</td>
      <td>0.323985</td>
      <td>57.983674</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Inspect ranges and a few quantiles</span>
<span class="n">df_suzuki</span><span class="o">.</span><span class="n">describe</span><span class="p">()[[</span><span class="s2">&quot;time_min&quot;</span><span class="p">,</span><span class="s2">&quot;temp_c&quot;</span><span class="p">,</span><span class="s2">&quot;conc_m&quot;</span><span class="p">,</span><span class="s2">&quot;yield&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time_min</th>
      <th>temp_c</th>
      <th>conc_m</th>
      <th>yield</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>800.000000</td>
      <td>800.000000</td>
      <td>800.000000</td>
      <td>800.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>94.616242</td>
      <td>79.418759</td>
      <td>0.510738</td>
      <td>14.535193</td>
    </tr>
    <tr>
      <th>std</th>
      <td>49.425893</td>
      <td>17.436767</td>
      <td>0.274654</td>
      <td>22.092498</td>
    </tr>
    <tr>
      <th>min</th>
      <td>10.031436</td>
      <td>50.102473</td>
      <td>0.051375</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>51.989009</td>
      <td>64.015690</td>
      <td>0.276434</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>92.955198</td>
      <td>80.123321</td>
      <td>0.493572</td>
      <td>2.801323</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>138.782055</td>
      <td>94.581001</td>
      <td>0.740081</td>
      <td>22.791306</td>
    </tr>
    <tr>
      <th>max</th>
      <td>179.954612</td>
      <td>109.870879</td>
      <td>0.998107</td>
      <td>97.916358</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<hr class="docutils" />
<section id="visual-slices-of-the-surface">
<h3>8.2 Visual slices of the surface<a class="headerlink" href="#visual-slices-of-the-surface" title="Link to this heading">#</a></h3>
<p>We fix one variable and show how yield changes with the other two.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fix conc at 0.35 M and scan time, temp</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">TT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">TT_grid</span><span class="p">,</span> <span class="n">tt_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">TT</span><span class="p">,</span> <span class="n">tt</span><span class="p">)</span>
<span class="n">C_fixed</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">YY</span> <span class="o">=</span> <span class="n">suzuki_yield</span><span class="p">(</span><span class="n">tt_grid</span><span class="p">,</span> <span class="n">TT_grid</span><span class="p">,</span> <span class="n">C_fixed</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">TT_grid</span><span class="p">,</span> <span class="n">tt_grid</span><span class="p">,</span> <span class="n">YY</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;yield&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;temp_c&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;time_min&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Yield at conc=0.35 M&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/00e952f35af12478a7ede37c0c3471c6c683dc36ff1f0eacc93a792dc4158aaf.png" src="_images/00e952f35af12478a7ede37c0c3471c6c683dc36ff1f0eacc93a792dc4158aaf.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fix time at 80 min and scan temp vs conc</span>
<span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>
<span class="n">TT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">TT_grid</span><span class="p">,</span> <span class="n">cc_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">TT</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span>
<span class="n">t_fixed</span> <span class="o">=</span> <span class="mf">80.0</span>
<span class="n">YY2</span> <span class="o">=</span> <span class="n">suzuki_yield</span><span class="p">(</span><span class="n">t_fixed</span><span class="p">,</span> <span class="n">TT_grid</span><span class="p">,</span> <span class="n">cc_grid</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">TT_grid</span><span class="p">,</span> <span class="n">cc_grid</span><span class="p">,</span> <span class="n">YY2</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;yield&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;temp_c&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;conc_m&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Yield at time=80 min&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/dd2141b37e27f2793d44f9015ca01702288b14f1c8b791847f2ab512d0eaffe5.png" src="_images/dd2141b37e27f2793d44f9015ca01702288b14f1c8b791847f2ab512d0eaffe5.png" />
</div>
</div>
<p>These slices show a sweet region that we want BO to find in as few trials as possible.</p>
</section>
<hr class="docutils" />
<section id="normalize-the-space-to-0-1-3">
<h3>8.3 Normalize the space to [0,1]^3<a class="headerlink" href="#normalize-the-space-to-0-1-3" title="Link to this heading">#</a></h3>
<p>GPs like normalized inputs. We scale time, temp, conc to 0..1. We also keep inverse transforms for readability.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 8.3 Fit a MinMax scaler</span>
<span class="n">scaler_3d</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_suzuki</span><span class="p">[[</span><span class="s2">&quot;time_min&quot;</span><span class="p">,</span><span class="s2">&quot;temp_c&quot;</span><span class="p">,</span><span class="s2">&quot;conc_m&quot;</span><span class="p">]])</span>
<span class="n">X_all</span> <span class="o">=</span> <span class="n">scaler_3d</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df_suzuki</span><span class="p">[[</span><span class="s2">&quot;time_min&quot;</span><span class="p">,</span><span class="s2">&quot;temp_c&quot;</span><span class="p">,</span><span class="s2">&quot;conc_m&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">y_all</span> <span class="o">=</span> <span class="n">df_suzuki</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="n">X_all</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">y_all</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([[0.07615779, 0.23310162, 0.31037802],
        [0.7800864 , 0.06377678, 0.60385531],
        [0.43842244, 0.27146366, 0.4054797 ]]),
 array([0.39303965, 0.        , 4.34222798]))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Helpers to decode to lab units</span>
<span class="k">def</span><span class="w"> </span><span class="nf">decode_3d</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">scaler_3d</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">decode_3d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([44.01607147, 97.91719799,  0.33539433])
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="bo-on-the-suzuki-surface-with-a-gp-surrogate">
<h3>8.4 BO on the Suzuki surface with a GP surrogate<a class="headerlink" href="#bo-on-the-suzuki-surface-with-a-gp-surrogate" title="Link to this heading">#</a></h3>
<p>We treat <code class="docutils literal notranslate"><span class="pre">suzuki_yield</span></code> as the lab experiment. At each step, BO proposes a normalized point <code class="docutils literal notranslate"><span class="pre">u</span></code> in [0,1]^3, we decode to lab units, run the experiment, and get a yield.</p>
<p>We use <strong>EI</strong> as the acquisition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 8.4 BO loop on 3D Suzuki with GP + EI</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># initial 8 random runs</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">lab_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">decode_3d</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">U</span><span class="p">])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">suzuki_yield</span><span class="p">(</span><span class="n">lab_pts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">lab_pts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">lab_pts</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

<span class="n">kernel3</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">50.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">Matern</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="n">nu</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span> <span class="o">+</span> <span class="n">WhiteKernel</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">gp3</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel3</span><span class="p">,</span> <span class="n">normalize_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_restarts_optimizer</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">best_hist</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
<span class="n">trace</span> <span class="o">=</span> <span class="p">[</span><span class="n">lab_pts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">)]]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Candidate grid for acquisition (random Latin-style sampling)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">candidate_cloud</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">U_cand</span> <span class="o">=</span> <span class="n">candidate_cloud</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">U_cand</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[4.17022005e-01, 7.20324493e-01, 1.14374817e-04],
       [3.02332573e-01, 1.46755891e-01, 9.23385948e-02],
       [1.86260211e-01, 3.45560727e-01, 3.96767474e-01]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># BO iterations</span>
<span class="n">n_iter</span> <span class="o">=</span> <span class="mi">30</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iter</span><span class="p">):</span>
    <span class="n">gp3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">mu</span><span class="p">,</span> <span class="n">sd</span> <span class="o">=</span> <span class="n">gp3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">U_cand</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ei</span> <span class="o">=</span> <span class="n">acq_ei</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">y_best</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">u_next</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">argmax_on_grid</span><span class="p">(</span><span class="n">ei</span><span class="p">,</span> <span class="n">U_cand</span><span class="p">)</span>
    <span class="n">lab_next</span> <span class="o">=</span> <span class="n">decode_3d</span><span class="p">(</span><span class="n">u_next</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="n">y_next</span> <span class="o">=</span> <span class="n">suzuki_yield</span><span class="p">(</span><span class="n">lab_next</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lab_next</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lab_next</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

    <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">U</span><span class="p">,</span> <span class="n">u_next</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">y_next</span><span class="p">])</span>
    <span class="n">best_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">y_next</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lab_next</span><span class="p">)</span>

<span class="nb">len</span><span class="p">(</span><span class="n">U</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_hist</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(38, 38, 31, 12)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot improvement</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">best_hist</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Best yield&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Suzuki: BO with GP + EI (best yield vs iter)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9aec50f42d59dcb8acb30c0a747edbaf0c2a5ece2bc0011b123bd7794b0a15cb.png" src="_images/9aec50f42d59dcb8acb30c0a747edbaf0c2a5ece2bc0011b123bd7794b0a15cb.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;time_min&quot;</span><span class="p">,</span><span class="s2">&quot;temp_c&quot;</span><span class="p">,</span><span class="s2">&quot;conc_m&quot;</span><span class="p">]</span>
<span class="n">df_last</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">decode_3d</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">U</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]],</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

<span class="c1"># Option 1: assign via **dict (works with keyword collisions)</span>
<span class="n">df_last</span> <span class="o">=</span> <span class="n">df_last</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;yield&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]})</span>

<span class="c1"># Option 2: set the column directly</span>
<span class="c1"># df_last[&quot;yield&quot;] = y[-10:]</span>

<span class="n">df_last</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time_min</th>
      <th>temp_c</th>
      <th>conc_m</th>
      <th>yield</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>139.647778</td>
      <td>95.855006</td>
      <td>0.343132</td>
      <td>100.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>139.647778</td>
      <td>95.855006</td>
      <td>0.343132</td>
      <td>99.288451</td>
    </tr>
    <tr>
      <th>2</th>
      <td>167.332810</td>
      <td>96.793277</td>
      <td>0.342383</td>
      <td>93.942525</td>
    </tr>
    <tr>
      <th>3</th>
      <td>139.647778</td>
      <td>95.855006</td>
      <td>0.343132</td>
      <td>100.000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>139.647778</td>
      <td>95.855006</td>
      <td>0.343132</td>
      <td>98.582025</td>
    </tr>
    <tr>
      <th>5</th>
      <td>139.647778</td>
      <td>95.855006</td>
      <td>0.343132</td>
      <td>100.000000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>139.647778</td>
      <td>95.855006</td>
      <td>0.343132</td>
      <td>100.000000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>139.647778</td>
      <td>95.855006</td>
      <td>0.343132</td>
      <td>99.920253</td>
    </tr>
    <tr>
      <th>8</th>
      <td>139.647778</td>
      <td>95.855006</td>
      <td>0.343132</td>
      <td>100.000000</td>
    </tr>
    <tr>
      <th>9</th>
      <td>139.647778</td>
      <td>95.855006</td>
      <td>0.343132</td>
      <td>100.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearSegmentedColormap</span>

<span class="c1"># custom colormap from grey to red</span>
<span class="n">grey_red</span> <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s2">&quot;grey_red&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">])</span>

<span class="n">orders</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">U</span><span class="p">))</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>   
<span class="n">size_scale</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># adjust scaling factor to taste</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mf">3.5</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">orders</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">grey_red</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">Y</span><span class="o">*</span><span class="n">size_scale</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time_u&quot;</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;temp_u&quot;</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;time vs temp&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">orders</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">grey_red</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">Y</span><span class="o">*</span><span class="n">size_scale</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time_u&quot;</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;conc_u&quot;</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;time vs conc&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">orders</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">grey_red</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">Y</span><span class="o">*</span><span class="n">size_scale</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;temp_u&quot;</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;conc_u&quot;</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;temp vs conc&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Order of samples during BO (size ~ yield)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/26f0e0c1f32427998820b14eae6f5ff9eb9792d6c0aaec291a2b78959b918310.png" src="_images/26f0e0c1f32427998820b14eae6f5ff9eb9792d6c0aaec291a2b78959b918310.png" />
</div>
</div>
</section>
<hr class="docutils" />
<section id="compare-to-grid-and-random-for-the-same-number-of-lab-runs">
<h3>8.5 Compare to grid and random for the same number of lab runs<a class="headerlink" href="#compare-to-grid-and-random-for-the-same-number-of-lab-runs" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build a small grid across each axis (5 x 5 x 5 = 125)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_strategy</span><span class="p">(</span><span class="n">U_points</span><span class="p">):</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">U_points</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">decode_3d</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">suzuki_yield</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>

<span class="n">budget</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>  <span class="c1"># how many points BO used</span>
<span class="n">best_grid</span> <span class="o">=</span> <span class="n">run_strategy</span><span class="p">(</span><span class="n">G</span><span class="p">[:</span><span class="n">budget</span><span class="p">])</span>
<span class="n">best_rand</span> <span class="o">=</span> <span class="n">run_strategy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">best_bo</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;Method&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;BO (EI)&quot;</span><span class="p">,</span> <span class="s2">&quot;Grid&quot;</span><span class="p">,</span> <span class="s2">&quot;Random&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Best yield&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">best_bo</span><span class="p">,</span> <span class="n">best_grid</span><span class="p">,</span> <span class="n">best_rand</span><span class="p">]</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Method</th>
      <th>Best yield</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>BO (EI)</td>
      <td>100.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Grid</td>
      <td>2.986924</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Random</td>
      <td>84.515504</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="admonition-exercise-8-5 admonition">
<p class="admonition-title">Exercise 8.5</p>
<p>Change the BO acquisition to UCB with <code class="docutils literal notranslate"><span class="pre">kappa=2.2</span></code> and re-run Section 8.4 through 8.5. Do you see more exploration early on? How does the final best yield compare?</p>
</div>
</section>
<hr class="docutils" />
<section id="a-quick-rf-surrogate-on-suzuki">
<h3>8.6 A quick RF surrogate on Suzuki<a class="headerlink" href="#a-quick-rf-surrogate-on-suzuki" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 8.6 Repeat BO with RF + UCB on Suzuki</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<span class="n">U_rf</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">lab_rf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">decode_3d</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">U_rf</span><span class="p">])</span>
<span class="n">y_rf</span> <span class="o">=</span> <span class="n">suzuki_yield</span><span class="p">(</span><span class="n">lab_rf</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">lab_rf</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">lab_rf</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

<span class="n">best_hist_rf</span> <span class="o">=</span> <span class="p">[</span><span class="n">y_rf</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">):</span>
    <span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">U_rf</span><span class="p">,</span> <span class="n">y_rf</span><span class="p">)</span>
    <span class="n">mu</span><span class="p">,</span> <span class="n">sd</span> <span class="o">=</span> <span class="n">rf_mean_std</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">U_cand</span><span class="p">)</span>
    <span class="n">acq</span> <span class="o">=</span> <span class="n">acq_ucb</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">1.6</span><span class="p">)</span>
    <span class="n">u_next</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">argmax_on_grid</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">U_cand</span><span class="p">)</span>
    <span class="n">lab_next</span> <span class="o">=</span> <span class="n">decode_3d</span><span class="p">(</span><span class="n">u_next</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="n">y_next</span> <span class="o">=</span> <span class="n">suzuki_yield</span><span class="p">(</span><span class="n">lab_next</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lab_next</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lab_next</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

    <span class="n">U_rf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">U_rf</span><span class="p">,</span> <span class="n">u_next</span><span class="p">])</span>
    <span class="n">y_rf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">y_rf</span><span class="p">,</span> <span class="n">y_next</span><span class="p">])</span>
    <span class="n">best_hist_rf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_rf</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">best_hist_rf</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Best yield&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Suzuki: RF surrogate with UCB&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b852f646257cc9166ade9be6ffb22598c7da3d829521bc56be37c624d956bb44.png" src="_images/b852f646257cc9166ade9be6ffb22598c7da3d829521bc56be37c624d956bb44.png" />
</div>
</div>
<div class="admonition-exercise-8-6 admonition">
<p class="admonition-title">Exercise 8.6</p>
<p>Reduce the number of trees to 100. Does the curve become noisier or slower to improve?</p>
</div>
</section>
</section>
<hr class="docutils" />
<section id="glossary">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">9. Glossary</a><a class="headerlink" href="#glossary" title="Link to this heading">#</a></h2>
<dl class="simple glossary">
<dt id="term-Bayesian-Optimization">Bayesian Optimization<a class="headerlink" href="#term-Bayesian-Optimization" title="Link to this term">#</a></dt><dd><p>A method to optimize expensive black-box functions by fitting a surrogate with uncertainty and choosing the next experiment via an acquisition function.</p>
</dd>
<dt id="term-Surrogate-model">Surrogate model<a class="headerlink" href="#term-Surrogate-model" title="Link to this term">#</a></dt><dd><p>A fast predictive model (GP, random forest, small NN) that provides a mean <span class="math notranslate nohighlight">\(\mu(x)\)</span> and an uncertainty proxy <span class="math notranslate nohighlight">\(\sigma(x)\)</span>.</p>
</dd>
<dt id="term-Prior-belief">Prior belief<a class="headerlink" href="#term-Prior-belief" title="Link to this term">#</a></dt><dd><p>Initial assumption about the shape of the objective before data, such as a GP with a chosen kernel.</p>
</dd>
<dt id="term-Posterior">Posterior<a class="headerlink" href="#term-Posterior" title="Link to this term">#</a></dt><dd><p>Updated belief after seeing data. For a GP this yields closed-form <span class="math notranslate nohighlight">\(\mu(x)\)</span> and <span class="math notranslate nohighlight">\(\sigma(x)\)</span>.</p>
</dd>
<dt id="term-Kernel-covariance-function">Kernel (covariance function)<a class="headerlink" href="#term-Kernel-covariance-function" title="Link to this term">#</a></dt><dd><p>Function defining similarity between inputs. Common choices: RBF, Matern. The length scale sets smoothness.</p>
</dd>
<dt id="term-Expected-Improvement-EI">Expected Improvement (EI)<a class="headerlink" href="#term-Expected-Improvement-EI" title="Link to this term">#</a></dt><dd><p>Acquisition that scores the expected gain over the current best.</p>
</dd>
<dt id="term-Upper-Confidence-Bound-UCB">Upper Confidence Bound (UCB)<a class="headerlink" href="#term-Upper-Confidence-Bound-UCB" title="Link to this term">#</a></dt><dd><p>Acquisition that adds a multiple of uncertainty to the mean: <span class="math notranslate nohighlight">\(\mu + \kappa \sigma\)</span>.</p>
</dd>
<dt id="term-Probability-of-Improvement-PI">Probability of Improvement (PI)<a class="headerlink" href="#term-Probability-of-Improvement-PI" title="Link to this term">#</a></dt><dd><p>Acquisition that scores the probability to improve over the best by at least a margin.</p>
</dd>
<dt id="term-Exploration">Exploration<a class="headerlink" href="#term-Exploration" title="Link to this term">#</a></dt><dd><p>Trying uncertain regions with high <span class="math notranslate nohighlight">\(\sigma(x)\)</span> to gain information.</p>
</dd>
<dt id="term-Exploitation">Exploitation<a class="headerlink" href="#term-Exploitation" title="Link to this term">#</a></dt><dd><p>Focusing near known good regions with high <span class="math notranslate nohighlight">\(\mu(x)\)</span>.</p>
</dd>
</dl>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals-and-setup">1. Learning goals and setup</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-and-global-settings">1.1 Imports and global settings</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#small-helpers-for-plotting">1.2 Small helpers for plotting</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-bayesian-optimization">2. What is Bayesian Optimization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-tiny-1d-objective-for-intuition">2.1 A tiny 1D objective for intuition</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-process-surrogate-prior-posterior-kernel">3. Gaussian Process surrogate: prior, posterior, kernel</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#draw-function-samples-from-the-prior">3.1 Draw function samples from the prior</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-gp-posterior-on-a-few-points">3.2 Fit GP posterior on a few points</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#acquisition-functions-ei-ucb-pi-greedy">4. Acquisition functions: EI, UCB, PI, greedy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implement-acquisition-functions">4.1 Implement acquisition functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-acquisition-shapes">4.2 Visualize acquisition shapes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-bo-loop-in-1d-step-by-step">5. The BO loop in 1D step by step</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#small-utility-argmax-on-a-grid">5.1 Small utility: argmax on a grid</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-bo-with-ei">5.2 Run BO with EI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#where-did-bo-sample">5.3 Where did BO sample</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#surrogate-alternatives-and-simple-diagnostics">6. Surrogate alternatives and simple diagnostics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest-surrogate-mean-and-std-from-trees">6.1 Random Forest surrogate: mean and std from trees</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bo-loop-with-rf-surrogate-ucb">6.2 BO loop with RF surrogate (UCB)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#small-neural-surrogate-optional">6.3 Small neural surrogate (optional)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#chemistry-case-study-suzuki-coupling-toy-dataset">8. Chemistry case study: Suzuki coupling toy dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-the-toy-suzuki-dataset">8.1 Create the toy Suzuki dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visual-slices-of-the-surface">8.2 Visual slices of the surface</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#normalize-the-space-to-0-1-3">8.3 Normalize the space to [0,1]^3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bo-on-the-suzuki-surface-with-a-gp-surrogate">8.4 BO on the Suzuki surface with a GP surrogate</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compare-to-grid-and-random-for-the-same-number-of-lab-runs">8.5 Compare to grid and random for the same number of lab runs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-quick-rf-surrogate-on-suzuki">8.6 A quick RF surrogate on Suzuki</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">9. Glossary</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>