
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lecture 14 - Bayesian Optimization for Chemical Reactions &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lecture-14';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to CHEM 5080: AI for Chemistry
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="lecture-01.html">Lecture 1 - Python Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-02.html">Lecture 2 - Pandas and Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-03.html">Lecture 3 - SMILES and RDKit</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-04.html">Lecture 4 - Chemical Structure Identifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-05.html">Lecture 5 - Regression and Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-06.html">Lecture 6 - Cross-Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-07.html">Lecture 7 - Decision Trees and Random Forests</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-08.html">Lecture 8 - Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-09.html">Lecture 9 - Graph Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-10.html">Lecture 10 - Property &amp; Reaction Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-11.html">Lecture 11 - Dimension Reduction for Data Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-12.html">Lecture 12 - Self-Supervised Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-13.html">Lecture 13 - De Novo Molecule Generation</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Flecture-14.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/lecture-14.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lecture 14 - Bayesian Optimization for Chemical Reactions</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1"></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">1. Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-bayesian-optimization">2. What is Bayesian Optimization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-tiny-1d-objective-for-intuition">2.1 A tiny 1D objective for intuition</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-process-surrogate-prior-posterior-kernel">3. Gaussian Process surrogate: prior, posterior, kernel</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#draw-function-samples-from-the-prior">3.1 Draw function samples from the prior</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-gp-posterior-on-a-few-points">3.2 Fit GP posterior on a few points</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#acquisition-functions-ei-ucb-pi-greedy">4. Acquisition functions: EI, UCB, PI, greedy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implement-acquisition-functions">4.1 Implement acquisition functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-acquisition-shapes">4.2 Visualize acquisition shapes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-bo-loop-in-1d-step-by-step">5. The BO loop in 1D step by step</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#small-utility-argmax-on-a-grid">5.1 Small utility: argmax on a grid</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-bo-with-ei">5.2 Run BO with EI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#where-did-bo-sample">5.3 Where did BO sample</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#surrogate-alternatives-and-simple-diagnostics">6. Surrogate alternatives and simple diagnostics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest-surrogate-mean-and-std-from-trees">6.1 Random Forest surrogate: mean and std from trees</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bo-loop-with-rf-surrogate-ei">6.2 BO loop with RF surrogate (EI)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#small-neural-surrogate-via-mc-dropout">6.3 Small neural surrogate via MC Dropout</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#chemistry-case-study-suzuki-coupling-toy-dataset">7. Chemistry case study: Suzuki coupling toy dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-the-toy-suzuki-dataset">7.1 Create the toy Suzuki dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visual-slices-of-the-surface">7.2 Visual slices of the surface</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#normalize-the-space-to-0-1-3">7.3 Normalize the space to [0,1]^3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bo-on-the-suzuki-surface-with-a-gp-surrogate">7.4 BO on the Suzuki surface with a GP surrogate</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compare-to-grid-and-random-for-the-same-number-of-lab-runs">7.5 Compare to grid and random for the same number of lab runs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-quick-rf-surrogate-on-suzuki">7.6 A quick RF surrogate on Suzuki</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">8. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-class-activity">9. In-class activity</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lecture-14-bayesian-optimization-for-chemical-reactions">
<h1>Lecture 14 - Bayesian Optimization for Chemical Reactions<a class="headerlink" href="#lecture-14-bayesian-optimization-for-chemical-reactions" title="Link to this heading">#</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#id1" id="id2">Colab</a></p></li>
<li><p><a class="reference internal" href="#setup" id="id3">1. Setup</a></p></li>
<li><p><a class="reference internal" href="#what-is-bayesian-optimization" id="id4">2. What is Bayesian Optimization</a></p></li>
<li><p><a class="reference internal" href="#gaussian-process-surrogate-prior-posterior-kernel" id="id5">3. Gaussian Process surrogate: prior, posterior, kernel</a></p></li>
<li><p><a class="reference internal" href="#acquisition-functions-ei-ucb-pi-greedy" id="id6">4. Acquisition functions: EI, UCB, PI, greedy</a></p></li>
<li><p><a class="reference internal" href="#the-bo-loop-in-1d-step-by-step" id="id7">5. The BO loop in 1D step by step</a></p></li>
<li><p><a class="reference internal" href="#surrogate-alternatives-and-simple-diagnostics" id="id8">6. Surrogate alternatives and simple diagnostics</a></p></li>
<li><p><a class="reference internal" href="#chemistry-case-study-suzuki-coupling-toy-dataset" id="id9">7. Chemistry case study: Suzuki coupling toy dataset</a></p></li>
<li><p><a class="reference internal" href="#glossary" id="id10">8. Glossary</a></p></li>
<li><p><a class="reference internal" href="#in-class-activity" id="id11">9. In-class activity</a></p></li>
</ul>
</nav>
<p><strong>Learning goals</strong></p>
<ul class="simple">
<li><p>Explain the ideas behind <strong>Bayesian Optimization</strong> for expensive experiments.</p></li>
<li><p>Define <strong>prior belief</strong>, <strong>surrogate model</strong> (GP, RF, small NN), and <strong>acquisition function</strong> (EI, UCB, PI, greedy).</p></li>
<li><p>Code the BO loop step by step: fit surrogate, compute acquisition, pick next point, update data.</p></li>
<li><p>Run a chemistry case study: toy <strong>Suzuki coupling</strong> with three controllable factors (time, temperature, concentration) to optimize yield.</p></li>
</ul>
<section id="id1">
<h2><a class="reference external" href="https://colab.research.google.com/drive/1rmLQ2MKbReYka9tDFUZYK9u9xbcARNS8?usp=sharing"><img alt="Colab" src="https://img.shields.io/badge/Open-Colab-orange" /></a><a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
</section>
<section id="setup">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">1. Setup</a><a class="headerlink" href="#setup" title="Link to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1.1 Imports and global settings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="c1"># scikit-learn pieces</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">MinMaxScaler</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.gaussian_process</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.gaussian_process.kernels</span><span class="w"> </span><span class="kn">import</span> <span class="n">RBF</span><span class="p">,</span> <span class="n">Matern</span><span class="p">,</span> <span class="n">WhiteKernel</span><span class="p">,</span> <span class="n">ConstantKernel</span> <span class="k">as</span> <span class="n">C</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neural_network</span><span class="w"> </span><span class="kn">import</span> <span class="n">MLPRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">KFold</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">5.2</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Small helpers for plotting</span>
<span class="k">def</span><span class="w"> </span><span class="nf">parity</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Parity&quot;</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="n">lo</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_true</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_true</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">],</span> <span class="p">[</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">],</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;True&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Predicted&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">line_plot_with_ci</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">):</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="n">x_ord</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">m_ord</span> <span class="o">=</span> <span class="n">mean</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">s_ord</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_ord</span><span class="p">,</span> <span class="n">m_ord</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_ord</span><span class="p">,</span> <span class="n">m_ord</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">s_ord</span><span class="p">,</span> <span class="n">m_ord</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">s_ord</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="what-is-bayesian-optimization">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">2. What is Bayesian Optimization</a><a class="headerlink" href="#what-is-bayesian-optimization" title="Link to this heading">#</a></h2>
<p>Bayesian Optimization (BO) is a strategy to optimize an unknown objective <span class="math notranslate nohighlight">\(f(x)\)</span> when evaluations are expensive. Think of <span class="math notranslate nohighlight">\(f(x)\)</span> as a reaction yield produced by a full experiment. We want to find <span class="math notranslate nohighlight">\(x^*\)</span> that maximizes <span class="math notranslate nohighlight">\(f(x)\)</span> using as few experiments as possible.</p>
<p>The workflow:</p>
<ol class="arabic simple">
<li><p><strong>Prior belief</strong> about <span class="math notranslate nohighlight">\(f\)</span> (for example a GP prior).</p></li>
<li><p><strong>Surrogate model</strong> that maps <span class="math notranslate nohighlight">\(x \mapsto\)</span> a predictive <strong>mean</strong> <span class="math notranslate nohighlight">\(\mu(x)\)</span> and <strong>uncertainty</strong> <span class="math notranslate nohighlight">\(\sigma(x)\)</span>.</p></li>
<li><p><strong>Acquisition function</strong> <span class="math notranslate nohighlight">\(a(x)\)</span> that scores how attractive <span class="math notranslate nohighlight">\(x\)</span> is to try next, combining exploration and exploitation.</p></li>
<li><p><strong>Update</strong> the dataset with the new measurement and refit the surrogate.</p></li>
</ol>
<p>We repeat 2 to 4 until the budget is used.</p>
<section id="a-tiny-1d-objective-for-intuition">
<h3>2.1 A tiny 1D objective for intuition<a class="headerlink" href="#a-tiny-1d-objective-for-intuition" title="Link to this heading">#</a></h3>
<p>We define a 1D function as a stand-in for an expensive lab run. The optimizer only sees measured points.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 2.1 A 1D &quot;hidden&quot; objective</span>
<span class="c1"># Target points that the true function must pass through</span>
<span class="n">X_knots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y_knots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Challenging baseline that is high on [0, 2]</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f_base</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">left</span>  <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">30.0</span><span class="o">*</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">)))</span>
    <span class="n">right</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mf">30.0</span><span class="o">*</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">1.95</span><span class="p">)))</span>
    <span class="n">plateau</span> <span class="o">=</span> <span class="mf">1.8</span> <span class="o">*</span> <span class="n">left</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">right</span><span class="p">)</span>
    <span class="n">inner_peak</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="mf">1.20</span><span class="p">)</span><span class="o">/</span><span class="mf">0.06</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">cliff</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.2</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">40.0</span><span class="o">*</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">2.05</span><span class="p">))))</span>
    <span class="n">valley</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="mf">2.10</span><span class="p">)</span><span class="o">/</span><span class="mf">0.05</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ripples</span> <span class="o">=</span> <span class="mf">0.22</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">8.5</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="mf">3.0</span><span class="p">)</span><span class="o">/</span><span class="mf">0.7</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">bumps</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">0.35</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="mf">2.55</span><span class="p">)</span><span class="o">/</span><span class="mf">0.10</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
        <span class="mf">0.28</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="mf">3.35</span><span class="p">)</span><span class="o">/</span><span class="mf">0.12</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">trend</span> <span class="o">=</span> <span class="mf">0.06</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.12</span><span class="o">*</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">3.2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">plateau</span> <span class="o">+</span> <span class="n">inner_peak</span> <span class="o">+</span> <span class="n">cliff</span> <span class="o">+</span> <span class="n">valley</span> <span class="o">+</span> <span class="n">ripples</span> <span class="o">+</span> <span class="n">bumps</span> <span class="o">+</span> <span class="n">trend</span>

<span class="n">taus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">])</span>  <span class="c1"># widths for the 3 RBFs</span>
<span class="k">def</span><span class="w"> </span><span class="nf">rbf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span><span class="o">/</span><span class="n">tau</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Build interpolation system A w = residual</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X_knots</span><span class="o">.</span><span class="n">ravel</span><span class="p">()):</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">cj</span><span class="p">,</span> <span class="n">tj</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">X_knots</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">taus</span><span class="p">)):</span>
        <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbf</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">cj</span><span class="p">,</span> <span class="n">tj</span><span class="p">)</span>

<span class="n">residual</span> <span class="o">=</span> <span class="n">y_knots</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">-</span> <span class="n">f_base</span><span class="p">(</span><span class="n">X_knots</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">residual</span><span class="p">)</span>  <span class="c1"># weights for the RBF corrections</span>

<span class="c1"># Final true function that passes through the three knots</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f_true_1d</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">f_base</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">rbf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">X_knots</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">taus</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
            <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">rbf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">X_knots</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">taus</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
            <span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">rbf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">X_knots</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">taus</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="n">corr</span>

<span class="c1"># Grid for plotting the landscape</span>
<span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y_grid</span> <span class="o">=</span> <span class="n">f_true_1d</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;x_grid shape:&quot;</span><span class="p">,</span> <span class="n">x_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;y_grid shape:&quot;</span><span class="p">,</span> <span class="n">y_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Blackbox objective for reaction yield&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Reaction time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Reaction yield&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>x_grid shape: (400, 1) y_grid shape: (400, 1)
</pre></div>
</div>
<img alt="_images/b0b4d0b380be3f8032c06aa27cc7de5ebea630e5e53bfdac531438352cc6059f.png" src="_images/b0b4d0b380be3f8032c06aa27cc7de5ebea630e5e53bfdac531438352cc6059f.png" />
</div>
</div>
<div class="admonition-try-it admonition">
<p class="admonition-title">Try it</p>
<p>Try a different set of <code class="docutils literal notranslate"><span class="pre">X_knots</span></code> and <code class="docutils literal notranslate"><span class="pre">y_knots</span></code> and rebuild <code class="docutils literal notranslate"><span class="pre">f_true_1d</span></code>. Does BO still find the right peak quickly?</p>
</div>
</section>
</section>
<section id="gaussian-process-surrogate-prior-posterior-kernel">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">3. Gaussian Process surrogate: prior, posterior, kernel</a><a class="headerlink" href="#gaussian-process-surrogate-prior-posterior-kernel" title="Link to this heading">#</a></h2>
<p>A <strong>Gaussian Process (GP)</strong> defines a distribution over functions. You can think of it as a smooth prior belief about how <span class="math notranslate nohighlight">\(f\)</span> behaves.</p>
<ul class="simple">
<li><p><em>Prior</em>: Your belief about the function before you see any data. <span class="math notranslate nohighlight">\(f(x) \sim \mathcal{GP}(m(x), k(x, x'))\)</span> with mean <span class="math notranslate nohighlight">\(m(x)\)</span> (often zero) and kernel <span class="math notranslate nohighlight">\(k\)</span>.</p></li>
<li><p><em>Posterior</em>: After observing data <span class="math notranslate nohighlight">\(\mathcal{D} = \{(x_i, y_i)\}\)</span>, the GP produces a <strong>posterior</strong> with mean <span class="math notranslate nohighlight">\(\mu(x)\)</span> and standard deviation <span class="math notranslate nohighlight">\(\sigma(x)\)</span> at any new <span class="math notranslate nohighlight">\(x\)</span>.</p></li>
</ul>
<p>Key knob: the <strong>kernel</strong> (RBF, Matern, etc.) and its <strong>length scale</strong> which controls smoothness. We will use RBF and Matern. A kernel (also called a covariance function) is the mathematical function that encodes how similar two input points are and how correlated their function values should be.</p>
<p>Now,
Imagine you want to optimize a synthetic reaction yield (say, % yield of a new product).</p>
<p><strong>Prior</strong>: Before running any experiments, you have a belief about how yield depends on conditions (e.g., you assume the relation between yield and temperature like smooth sin wave). The prior says: “Yields at nearby temperatures are likely similar.”</p>
<p><strong>Kernel</strong>:</p>
<ol class="arabic simple">
<li><p>If you choose an RBF kernel, you are assuming the yield curve is very smooth (small changes in temperature or catalyst concentration won’t cause sudden jumps).</p></li>
<li><p>If you choose a Matern kernel with small smoothness parameter, you allow for more abrupt changes, which might make sense if you expect sharp phase transitions or catalyst deactivation.</p></li>
</ol>
<p><strong>Posterior</strong>: After you actually run 5 experiments at different temperatures and record yields, the GP updates. Now:</p>
<ol class="arabic simple">
<li><p>At the tested temperatures, you have high confidence (low uncertainty).</p></li>
<li><p>At untested ones, you still predict yields, but with wider error bars.</p></li>
</ol>
<p>The posterior reflects both your data and your initial assumption (kernel).</p>
<section id="draw-function-samples-from-the-prior">
<h3>3.1 Draw function samples from the prior<a class="headerlink" href="#draw-function-samples-from-the-prior" title="Link to this heading">#</a></h3>
<p>Below let’s look at sample from a GP prior to feel how kernels shape functions.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kernel_prior</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">RBF</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span> <span class="c1"># ConstantKernel + RBF</span>
<span class="n">gpr_prior</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel_prior</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">normalize_y</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># not fitted</span>
<span class="n">ys</span> <span class="o">=</span> <span class="n">gpr_prior</span><span class="o">.</span><span class="n">sample_y</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Prior sample matrix shape:&quot;</span><span class="p">,</span> <span class="n">ys</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># 400 x 3</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Samples from GP prior (RBF, length_scale=0.6)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;sampled f(x)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Try a longer length scale</span>
<span class="n">kernel_prior2</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">RBF</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">gpr_prior2</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel_prior2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">)</span>
<span class="n">ys2</span> <span class="o">=</span> <span class="n">gpr_prior2</span><span class="o">.</span><span class="n">sample_y</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">ys2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Samples from GP prior (RBF, length_scale=1.5)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;sampled f(x)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Try more samples</span>
<span class="n">kernel_prior3</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">RBF</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">gpr_prior3</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel_prior3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">)</span>
<span class="n">ys3</span> <span class="o">=</span> <span class="n">gpr_prior3</span><span class="o">.</span><span class="n">sample_y</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">ys3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Samples from GP prior (RBF, length_scale=1.5), many draws&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;sampled f(x)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Prior sample matrix shape: (400, 3)
</pre></div>
</div>
<img alt="_images/360ea3e651bd11352a9a520e650542557f2db0e530a49eacb339a4b2674ba068.png" src="_images/360ea3e651bd11352a9a520e650542557f2db0e530a49eacb339a4b2674ba068.png" />
<img alt="_images/da61e0d7a1ff0bba72b927ea8fea4dded1ea3fe5113779e6463d95559cc066c3.png" src="_images/da61e0d7a1ff0bba72b927ea8fea4dded1ea3fe5113779e6463d95559cc066c3.png" />
<img alt="_images/ccc3a36af51a86564c42487a6ae203caa3ec36d109b6c261208760cd78df13ba.png" src="_images/ccc3a36af51a86564c42487a6ae203caa3ec36d109b6c261208760cd78df13ba.png" />
</div>
</div>
</section>
<section id="fit-gp-posterior-on-a-few-points">
<h3>3.2 Fit GP posterior on a few points<a class="headerlink" href="#fit-gp-posterior-on-a-few-points" title="Link to this heading">#</a></h3>
<p>We start with 3 points <code class="docutils literal notranslate"><span class="pre">(2,</span> <span class="pre">0.5)</span></code>, <code class="docutils literal notranslate"><span class="pre">(3,</span> <span class="pre">1.7)</span></code>, <code class="docutils literal notranslate"><span class="pre">(3.5,</span> <span class="pre">1.2)</span></code>.
Think about we run 3 reactions and got the actual yields.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 3.2 Initial data</span>
<span class="n">X_list</span><span class="o">=</span> <span class="p">[[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">]]</span>
<span class="n">y_list</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.7</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.2</span><span class="p">]]</span>

<span class="n">X_init</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_list</span><span class="p">)</span>
<span class="n">y_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_list</span><span class="p">)</span>

<span class="c1"># Build a GP</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">))</span> <span class="o">*</span> <span class="n">RBF</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">length_scale_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">))</span>
<span class="n">gp</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">n_restarts_optimizer</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">normalize_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_init</span><span class="p">,</span> <span class="n">y_init</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Learned kernel:&quot;</span><span class="p">,</span> <span class="n">gp</span><span class="o">.</span><span class="n">kernel_</span><span class="p">)</span>

<span class="c1"># Predict posterior mean and std on a dense grid</span>
<span class="n">mu</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">line_plot_with_ci</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;GP posterior after 3 points&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;mean ± 1.96 std&quot;</span><span class="p">)</span>

<span class="c1"># Overlay data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;posterior mean&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_grid</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">mu</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">std</span><span class="p">,</span> <span class="n">mu</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">std</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;95% CI&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_init</span><span class="p">,</span> <span class="n">y_init</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;observed&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;GP posterior and data&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Learned kernel: 1**2 * RBF(length_scale=0.293)
</pre></div>
</div>
<img alt="_images/b72fcdd355e040fb792bb797191d26cf6a7b09a6170a58af9c71e04620337e02.png" src="_images/b72fcdd355e040fb792bb797191d26cf6a7b09a6170a58af9c71e04620337e02.png" />
<img alt="_images/e989695d76c5ed0c01ad0874fd2b16506b8f63c09f6f6d3182b0370bc2fbd595.png" src="_images/e989695d76c5ed0c01ad0874fd2b16506b8f63c09f6f6d3182b0370bc2fbd595.png" />
</div>
</div>
<div class="admonition-exercise admonition">
<p class="admonition-title">⏰ <strong>Exercise</strong></p>
<p>Swap RBF for <code class="docutils literal notranslate"><span class="pre">Matern(length_scale=0.8,</span> <span class="pre">nu=2.5)</span></code>. Compare uncertainty bands. Which kernel handles sharper bumps better?</p>
</div>
<p>The <strong>confidence interval (CI) band</strong> you see in the GP plots (the shaded area between <code class="docutils literal notranslate"><span class="pre">mu</span> <span class="pre">±</span> <span class="pre">1.96*std</span></code>) comes directly from the <strong>posterior distribution</strong> of the Gaussian Process.
where:</p>
<ul class="simple">
<li><p>mu(x) is the posterior mean (the “best guess”).</p></li>
<li><p>sigma(x) is the posterior standard deviation (the uncertainty).</p></li>
<li><p>A Gaussian distribution has about <strong>95% probability</strong> that the true value lies within ±1.96 standard deviations of the mean.</p></li>
</ul>
</section>
</section>
<section id="acquisition-functions-ei-ucb-pi-greedy">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">4. Acquisition functions: EI, UCB, PI, greedy</a><a class="headerlink" href="#acquisition-functions-ei-ucb-pi-greedy" title="Link to this heading">#</a></h2>
<p>An <strong>acquisition function</strong> <span class="math notranslate nohighlight">\(a(x)\)</span> scores how useful a new evaluation at <span class="math notranslate nohighlight">\(x\)</span> would be. It uses <span class="math notranslate nohighlight">\(\mu(x)\)</span> and <span class="math notranslate nohighlight">\(\sigma(x)\)</span> from the surrogate.</p>
<p>We will maximize the acquisition (so higher is better) for <strong>maximization</strong> problems.</p>
<p>Let <span class="math notranslate nohighlight">\(y^+\)</span> be the best observed value so far and <span class="math notranslate nohighlight">\(\xi \ge 0\)</span> a small margin to encourage exploration.</p>
<ul class="simple">
<li><p><strong>Expected Improvement</strong><br />
$<span class="math notranslate nohighlight">\(
\mathrm{EI}(x) = (\mu(x) - y^+ - \xi)\,\Phi(z) + \sigma(x)\,\phi(z)
\)</span><span class="math notranslate nohighlight">\(
where \)</span>z = \frac{\mu(x) - y^+ - \xi}{\sigma(x)}<span class="math notranslate nohighlight">\(, and \)</span>\Phi<span class="math notranslate nohighlight">\( and \)</span>\phi$ are the CDF and PDF of the standard normal.</p></li>
<li><p><strong>Upper Confidence Bound</strong><br />
$<span class="math notranslate nohighlight">\(
\mathrm{UCB}(x) = \mu(x) + \kappa\,\sigma(x)
\)</span><span class="math notranslate nohighlight">\(
where \)</span>\kappa &gt; 0$ controls exploration.</p></li>
<li><p><strong>Probability of Improvement</strong><br />
$<span class="math notranslate nohighlight">\(
\mathrm{PI}(x) = \Phi\!\left(\frac{\mu(x) - y^+ - \xi}{\sigma(x)}\right)
\)</span>$</p></li>
<li><p><strong>Greedy</strong> (exploitation only)<br />
$<span class="math notranslate nohighlight">\(
a(x) = \mu(x)
\)</span>$</p></li>
</ul>
<section id="implement-acquisition-functions">
<h3>4.1 Implement acquisition functions<a class="headerlink" href="#implement-acquisition-functions" title="Link to this heading">#</a></h3>
<p>We write short functions that accept arrays of <span class="math notranslate nohighlight">\(\mu\)</span>, <span class="math notranslate nohighlight">\(\sigma\)</span>, and the current best <span class="math notranslate nohighlight">\(y^+\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 4.1 Acquisition functions</span>
<span class="k">def</span><span class="w"> </span><span class="nf">acq_ei</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">y_best</span><span class="p">,</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">y_best</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">y_best</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">acq_ucb</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">kappa</span> <span class="o">*</span> <span class="n">sigma</span>

<span class="k">def</span><span class="w"> </span><span class="nf">acq_pi</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">y_best</span><span class="p">,</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">y_best</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span>
    <span class="k">return</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">acq_greedy</span><span class="p">(</span><span class="n">mu</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mu</span>

<span class="c1"># Sanity check: simple arrays</span>
<span class="n">mu_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
<span class="n">sd_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EI:&quot;</span><span class="p">,</span> <span class="n">acq_ei</span><span class="p">(</span><span class="n">mu_test</span><span class="p">,</span> <span class="n">sd_test</span><span class="p">,</span> <span class="n">y_best</span><span class="o">=</span><span class="mf">0.15</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;UCB:&quot;</span><span class="p">,</span> <span class="n">acq_ucb</span><span class="p">(</span><span class="n">mu_test</span><span class="p">,</span> <span class="n">sd_test</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PI:&quot;</span><span class="p">,</span> <span class="n">acq_pi</span><span class="p">(</span><span class="n">mu_test</span><span class="p">,</span> <span class="n">sd_test</span><span class="p">,</span> <span class="n">y_best</span><span class="o">=</span><span class="mf">0.15</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Greedy:&quot;</span><span class="p">,</span> <span class="n">acq_greedy</span><span class="p">(</span><span class="n">mu_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>EI: [0.00280512 0.06304388 0.34365756]
UCB: [0.15 0.3  0.7 ]
PI: [0.11506967 0.65542174 0.95543454]
Greedy: [0.1 0.2 0.5]
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualize-acquisition-shapes">
<h3>4.2 Visualize acquisition shapes<a class="headerlink" href="#visualize-acquisition-shapes" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 4.2 Acquisition profiles over x_grid with current GP</span>
<span class="n">y_best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_init</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">mu</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ei_vals</span> <span class="o">=</span> <span class="n">acq_ei</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">y_best</span><span class="o">=</span><span class="n">y_best</span><span class="p">,</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">ucb_vals</span> <span class="o">=</span> <span class="n">acq_ucb</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
<span class="n">pi_vals</span>  <span class="o">=</span> <span class="n">acq_pi</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">y_best</span><span class="o">=</span><span class="n">y_best</span><span class="p">,</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">greedy_v</span> <span class="o">=</span> <span class="n">acq_greedy</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">ei_vals</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Expected Improvement&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">ucb_vals</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Upper Confidence Bound&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">pi_vals</span><span class="p">);</span>  <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Probability of Improvement&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">greedy_v</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Greedy (mean)&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;acq value&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8ebb8531ff887ad19de8699727202b6537e0ef5e4351db852c462ba5929285cf.png" src="_images/8ebb8531ff887ad19de8699727202b6537e0ef5e4351db852c462ba5929285cf.png" />
</div>
</div>
<div class="admonition-tip admonition">
<p class="admonition-title">Tip</p>
<ul class="simple">
<li><p>EI and PI look at improvement over the current best.</p></li>
<li><p>UCB trades off mean and uncertainty with a single knob <code class="docutils literal notranslate"><span class="pre">kappa</span></code>.</p></li>
<li><p>Greedy ignores uncertainty and often gets stuck.</p></li>
</ul>
</div>
</section>
</section>
<section id="the-bo-loop-in-1d-step-by-step">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">5. The BO loop in 1D step by step</a><a class="headerlink" href="#the-bo-loop-in-1d-step-by-step" title="Link to this heading">#</a></h2>
<p>We now implement the loop:</p>
<ol class="arabic simple">
<li><p>Fit surrogate to <span class="math notranslate nohighlight">\((X, y)\)</span>.</p></li>
<li><p>Compute <span class="math notranslate nohighlight">\(\mu\)</span>, <span class="math notranslate nohighlight">\(\sigma\)</span> on a candidate set.</p></li>
<li><p>Compute acquisition <span class="math notranslate nohighlight">\(a(x)\)</span> and pick <span class="math notranslate nohighlight">\(x_{next} = \arg\max a(x)\)</span>.</p></li>
<li><p>Run the experiment (here we call <code class="docutils literal notranslate"><span class="pre">f_true_1d</span></code>) to get <span class="math notranslate nohighlight">\(y_{next}\)</span>.</p></li>
<li><p>Append to data and go back to step 1.</p></li>
</ol>
<p>We will do 15 to 20 iterations and look at the history.</p>
<section id="small-utility-argmax-on-a-grid">
<h3>5.1 Small utility: argmax on a grid<a class="headerlink" href="#small-utility-argmax-on-a-grid" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 5.1 Argmax on a grid</span>
<span class="k">def</span><span class="w"> </span><span class="nf">argmax_on_grid</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">grid</span><span class="p">):</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">grid</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">idx</span>

<span class="c1"># Quick check</span>
<span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">])</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x_star</span><span class="p">,</span> <span class="n">idx_star</span> <span class="o">=</span> <span class="n">argmax_on_grid</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>
<span class="n">x_star</span><span class="p">,</span> <span class="n">idx_star</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([[40]]), np.int64(3))
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-bo-with-ei">
<h3>5.2 Run BO with EI<a class="headerlink" href="#run-bo-with-ei" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ----- Initial data -----</span>
<span class="n">X_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">2.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">]])</span>
<span class="n">y_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">])</span>

<span class="c1"># ----- Grid and RNG -----</span>
<span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># ----- BO setup: GP with RBF + White -----</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">RBF</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span> <span class="o">+</span> <span class="n">WhiteKernel</span><span class="p">(</span><span class="n">noise_level</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>
<span class="n">gp</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">normalize_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_restarts_optimizer</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># ----- BO state -----</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">X_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">y_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">history_best</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>

<span class="c1"># ----- Run 15 iterations with per-iteration plots -----</span>
<span class="n">n_iter</span> <span class="o">=</span> <span class="mi">15</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="c1"># Fit surrogate</span>
    <span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c1"># Posterior over grid</span>
    <span class="n">mu</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Acquisition on grid</span>
    <span class="n">acq</span> <span class="o">=</span> <span class="n">acq_ei</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">y_best</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="c1"># Choose next point</span>
    <span class="n">x_next</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">argmax_on_grid</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">)</span>
    <span class="c1"># Noisy observation from the true function</span>
    <span class="n">y_next</span> <span class="o">=</span> <span class="n">f_true_1d</span><span class="p">(</span><span class="n">x_next</span><span class="p">)</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>

    <span class="c1"># Log iteration info</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iter </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">: x_next=</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">x_next</span><span class="p">)</span><span class="si">}</span><span class="s2">, y_next=</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">y_next</span><span class="p">)</span><span class="si">}</span><span class="s2">, best_so_far=</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="w"> </span><span class="n">y_next</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Plot: posterior (top) and EI (bottom)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Top: posterior mean and 95% CI, with observed points</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;posterior mean&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_grid</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">mu</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">std</span><span class="p">,</span> <span class="n">mu</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">std</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;95% CI&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;observed&quot;</span><span class="p">)</span>
    <span class="c1"># Mark proposed point</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x_next</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;x_next&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;f(x)&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Posterior at iteration </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Bottom: EI</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">acq</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;EI&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x_next</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;acq value&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Expected Improvement&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Update data</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">x_next</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">y_next</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>
    <span class="n">history_best</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="c1"># Plot the true function on [0, 4]</span>
<span class="n">xg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>
<span class="n">y_true</span> <span class="o">=</span> <span class="n">f_true_1d</span><span class="p">(</span><span class="n">xg</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xg</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;f_true_1d(x) updated&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Blackbox Objective Function&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;f(x)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Track best-so-far vs iteration</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_best</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Best observed f(x)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;EI: best-so-far improvement&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 1: x_next=2.987468671679198, y_next=1.751929766965282, best_so_far=1.751929766965282
</pre></div>
</div>
<img alt="_images/749b82d368b409221d7a2dcb03fff6cfcbe24341ae92ff3d8f6ea9559dfded41.png" src="_images/749b82d368b409221d7a2dcb03fff6cfcbe24341ae92ff3d8f6ea9559dfded41.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 2: x_next=2.756892230576441, y_next=0.6551551807430195, best_so_far=1.751929766965282
</pre></div>
</div>
<img alt="_images/7f7e9e532f33aefefdc52a3b4e592021693a1f63628f9634e47bd453172825ff.png" src="_images/7f7e9e532f33aefefdc52a3b4e592021693a1f63628f9634e47bd453172825ff.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 3: x_next=2.9373433583959896, y_next=1.440981135962244, best_so_far=1.751929766965282
</pre></div>
</div>
<img alt="_images/1d92fc673d73e920de33815007a1e4f36e77df2af42bfe223b7482ebcffbef4c.png" src="_images/1d92fc673d73e920de33815007a1e4f36e77df2af42bfe223b7482ebcffbef4c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 4: x_next=3.0977443609022552, y_next=1.5688864052195108, best_so_far=1.751929766965282
</pre></div>
</div>
<img alt="_images/bde726f19bc3063f3f03f43f9757e9bf76bf1ea0fc85515a6710b3c0ad953df0.png" src="_images/bde726f19bc3063f3f03f43f9757e9bf76bf1ea0fc85515a6710b3c0ad953df0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 5: x_next=0.0, y_next=-1.1855296185337663, best_so_far=1.751929766965282
</pre></div>
</div>
<img alt="_images/8ccea2fd5d333cd294d0856a53acb148c9531bd5769a2dd43721ee0b721aad00.png" src="_images/8ccea2fd5d333cd294d0856a53acb148c9531bd5769a2dd43721ee0b721aad00.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 6: x_next=3.789473684210526, y_next=0.7607467191519236, best_so_far=1.751929766965282
</pre></div>
</div>
<img alt="_images/ce5a5d0a5e109371e68353ce27757ee02277ad0fc417f2a2ee371514685a453d.png" src="_images/ce5a5d0a5e109371e68353ce27757ee02277ad0fc417f2a2ee371514685a453d.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 7: x_next=1.0225563909774436, y_next=-0.4062831800840925, best_so_far=1.751929766965282
</pre></div>
</div>
<img alt="_images/759af5623d2d48775ddcd545dc76f5d881157c868834a2b3227c7fe51f5bf97b.png" src="_images/759af5623d2d48775ddcd545dc76f5d881157c868834a2b3227c7fe51f5bf97b.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 8: x_next=2.406015037593985, y_next=0.9081980588839931, best_so_far=1.751929766965282
</pre></div>
</div>
<img alt="_images/98a9fcbb01313405140713db2934323cea5e28275ac1b1d97a7db33743151aa5.png" src="_images/98a9fcbb01313405140713db2934323cea5e28275ac1b1d97a7db33743151aa5.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 9: x_next=1.5538847117794485, y_next=-0.20037966426685516, best_so_far=1.751929766965282
</pre></div>
</div>
<img alt="_images/f45d0fa445de0566d683997a62965432bad638f4c5c29bb6229c8159e482e1e7.png" src="_images/f45d0fa445de0566d683997a62965432bad638f4c5c29bb6229c8159e482e1e7.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 10: x_next=3.1378446115288217, y_next=1.4854980266232756, best_so_far=1.751929766965282
</pre></div>
</div>
<img alt="_images/017c1795d2810120f8022604d5087a4c6ace517739bf1d3b33727e55774dad81.png" src="_images/017c1795d2810120f8022604d5087a4c6ace517739bf1d3b33727e55774dad81.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 11: x_next=3.117794486215539, y_next=1.6351712270821586, best_so_far=1.751929766965282
</pre></div>
</div>
<img alt="_images/b1052abad0f4df872e9b1011ca1d821fcdad0d42d26315e241aa5ced96257af8.png" src="_images/b1052abad0f4df872e9b1011ca1d821fcdad0d42d26315e241aa5ced96257af8.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 12: x_next=0.5413533834586466, y_next=-0.9191920723545901, best_so_far=1.751929766965282
</pre></div>
</div>
<img alt="_images/6e20dc467071c3b224961d1cdc0e6fb5ce92117bfaa42f4fe01f1ba8844f28af.png" src="_images/6e20dc467071c3b224961d1cdc0e6fb5ce92117bfaa42f4fe01f1ba8844f28af.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 13: x_next=3.1278195488721803, y_next=1.51403716027239, best_so_far=1.751929766965282
</pre></div>
</div>
<img alt="_images/b967ed1704c91de220faa602413eec78edf02fb8db17b6da61ee4e4a012b982e.png" src="_images/b967ed1704c91de220faa602413eec78edf02fb8db17b6da61ee4e4a012b982e.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 14: x_next=3.1278195488721803, y_next=1.5109553027396445, best_so_far=1.751929766965282
</pre></div>
</div>
<img alt="_images/b3e597cbd8a9f18184e16361de2936f34dfe828e719951d2e4b736724fff1f2d.png" src="_images/b3e597cbd8a9f18184e16361de2936f34dfe828e719951d2e4b736724fff1f2d.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 15: x_next=4.0, y_next=0.8618457095301242, best_so_far=1.751929766965282
</pre></div>
</div>
<img alt="_images/be7454cfd185516b245d3b1c17609b1c5b5a72f7dd476ef514e3d99a1a3bfe0f.png" src="_images/be7454cfd185516b245d3b1c17609b1c5b5a72f7dd476ef514e3d99a1a3bfe0f.png" />
<img alt="_images/32a7ec41b81a292c3f735be3e4dd718b071c5a61283af3787750b91cee529e73.png" src="_images/32a7ec41b81a292c3f735be3e4dd718b071c5a61283af3787750b91cee529e73.png" />
<img alt="_images/1f7fccf366e41f2e29b33adf0886cef218ee5b66816d2505d683a94a6c1efc82.png" src="_images/1f7fccf366e41f2e29b33adf0886cef218ee5b66816d2505d683a94a6c1efc82.png" />
</div>
</div>
<div class="admonition-exercise admonition">
<p class="admonition-title">⏰ <strong>Exercise</strong></p>
<p>Replace EI with UCB using <code class="docutils literal notranslate"><span class="pre">kappa=2.5</span></code>. Plot the best-so-far curve. Which method reaches a good point faster on this function?</p>
</div>
</section>
<section id="where-did-bo-sample">
<h3>5.3 Where did BO sample<a class="headerlink" href="#where-did-bo-sample" title="Link to this heading">#</a></h3>
<p>A healthy pattern often shows some early exploration across the space, then a focus on promising regions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 5.3 Visualize chosen locations on the x axis</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">ravel</span><span class="p">()),</span> <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;order of sampling&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Order of samples chosen by EI&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0223887d1f9cb03dea8d48e687f0bd82923c7a38b529b14ff885c425768a0935.png" src="_images/0223887d1f9cb03dea8d48e687f0bd82923c7a38b529b14ff885c425768a0935.png" />
</div>
</div>
</section>
</section>
<section id="surrogate-alternatives-and-simple-diagnostics">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">6. Surrogate alternatives and simple diagnostics</a><a class="headerlink" href="#surrogate-alternatives-and-simple-diagnostics" title="Link to this heading">#</a></h2>
<p>Gaussian Processes are a common surrogate for low to moderate dimensional spaces. For higher dimensions or larger datasets, tree ensembles and small neural surrogates can help.</p>
<p>We try a <strong>RandomForestRegressor</strong> as a surrogate. Its mean is the average prediction across trees, and an uncertainty <em>proxy</em> is the <strong>standard deviation across trees</strong>.</p>
<section id="random-forest-surrogate-mean-and-std-from-trees">
<h3>6.1 Random Forest surrogate: mean and std from trees<a class="headerlink" href="#random-forest-surrogate-mean-and-std-from-trees" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 6.1 RF surrogate: using tree-wise predictions for mean and std</span>
<span class="k">def</span><span class="w"> </span><span class="nf">rf_mean_std</span><span class="p">(</span><span class="n">rf</span><span class="p">:</span> <span class="n">RandomForestRegressor</span><span class="p">,</span> <span class="n">Xc</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="c1"># collect predictions from each tree</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xc</span><span class="p">)</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="n">rf</span><span class="o">.</span><span class="n">estimators_</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># shape (n, n_trees)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sd</span>

<span class="c1"># Tiny demo on a few random numbers</span>
<span class="n">rf_demo</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">)</span>
<span class="n">mu_demo</span><span class="p">,</span> <span class="n">sd_demo</span> <span class="o">=</span> <span class="n">rf_mean_std</span><span class="p">(</span><span class="n">rf_demo</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
<span class="n">mu_demo</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">sd_demo</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([-1.22631278, -1.22216741, -1.21224479]),
 array([0.00379929, 0.00331629, 0.00369172]))
</pre></div>
</div>
</div>
</div>
</section>
<section id="bo-loop-with-rf-surrogate-ei">
<h3>6.2 BO loop with RF surrogate (EI)<a class="headerlink" href="#bo-loop-with-rf-surrogate-ei" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># RF surrogate + EI, 15 iterations</span>
<span class="n">X_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">2.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">]])</span>
<span class="n">y_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">])</span>

<span class="c1"># Grid over [0, 4]</span>
<span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rf_mean_std</span><span class="p">(</span><span class="n">rf</span><span class="p">:</span> <span class="n">RandomForestRegressor</span><span class="p">,</span> <span class="n">Xc</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xc</span><span class="p">)</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="n">rf</span><span class="o">.</span><span class="n">estimators_</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (n, n_trees)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sd</span>

<span class="c1"># EI using RF&#39;s Gaussian approximation</span>
<span class="k">def</span><span class="w"> </span><span class="nf">acq_ei_from_mu_std</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">y_best</span><span class="p">,</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">sd</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">z</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_best</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">/</span> <span class="n">sd</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">ei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="n">ei</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_best</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span> <span class="o">+</span> <span class="n">sd</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ei</span>

<span class="k">def</span><span class="w"> </span><span class="nf">argmax_on_grid</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">grid</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_rf_bo_ei</span><span class="p">(</span><span class="n">n_iter</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">noise_sd</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">best_hist</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
    <span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span>
        <span class="n">n_estimators</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
        <span class="n">max_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">bootstrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">snapshots</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Fit RF on current data</span>
        <span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="c1"># RF posterior over grid</span>
        <span class="n">mu_rf</span><span class="p">,</span> <span class="n">sd_rf</span> <span class="o">=</span> <span class="n">rf_mean_std</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">)</span>

        <span class="c1"># EI on grid</span>
        <span class="n">acq_vals</span> <span class="o">=</span> <span class="n">acq_ei_from_mu_std</span><span class="p">(</span><span class="n">mu_rf</span><span class="p">,</span> <span class="n">sd_rf</span><span class="p">,</span> <span class="n">y_best</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

        <span class="c1"># Choose next point</span>
        <span class="n">x_next</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">argmax_on_grid</span><span class="p">(</span><span class="n">acq_vals</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">)</span>

        <span class="c1"># Observe noisy value</span>
        <span class="n">y_next</span> <span class="o">=</span> <span class="n">f_true_1d</span><span class="p">(</span><span class="n">x_next</span><span class="p">)</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noise_sd</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>

        <span class="c1"># Update data</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">x_next</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">y_next</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>
        <span class="n">best_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">n_iter</span><span class="p">:</span>
            <span class="n">snapshots</span><span class="p">[</span><span class="s2">&quot;final&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">mu_rf</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">sd_rf</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">best_hist</span><span class="p">,</span> <span class="n">snapshots</span>

<span class="c1"># Run RF+EI for 15 iterations</span>
<span class="n">hist_rf_ei</span><span class="p">,</span> <span class="n">snaps</span> <span class="o">=</span> <span class="n">run_rf_bo_ei</span><span class="p">(</span><span class="n">n_iter</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">noise_sd</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">X_obs</span><span class="p">,</span> <span class="n">y_obs</span><span class="p">,</span> <span class="n">mu_final</span><span class="p">,</span> <span class="n">sd_final</span> <span class="o">=</span> <span class="n">snaps</span><span class="p">[</span><span class="s2">&quot;final&quot;</span><span class="p">]</span>

<span class="c1"># Plot RF posterior after 15 iterations</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">mu_final</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;RF posterior mean&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_grid</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">mu_final</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">sd_final</span><span class="p">,</span> <span class="n">mu_final</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">sd_final</span><span class="p">,</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;RF 95% CI&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_obs</span><span class="p">,</span> <span class="n">y_obs</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;observed&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;f(x)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;RF surrogate posterior after 15 EI iterations&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Best-so-far curve for RF+EI</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_rf_ei</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;RF+EI&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Best observed f(x)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Best-so-far: RF + EI (15 iterations)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/93e2b2987b9eed983f1f79c437eeb885a9887b55b87f08df40f41a99c5e698d9.png" src="_images/93e2b2987b9eed983f1f79c437eeb885a9887b55b87f08df40f41a99c5e698d9.png" />
<img alt="_images/09efa0030ea4dcfe83446626622cf61e6d94160d754c3b14be376bbc83f813a8.png" src="_images/09efa0030ea4dcfe83446626622cf61e6d94160d754c3b14be376bbc83f813a8.png" />
</div>
</div>
<p>The RF surrogate can handle more points without much tuning, and the spread across trees gives a simple uncertainty estimate.</p>
<div class="admonition-exercise admonition">
<p class="admonition-title">⏰ <strong>Exercise</strong></p>
<p>Try UCB with RF (<code class="docutils literal notranslate"><span class="pre">kappa</span> <span class="pre">in</span> <span class="pre">[1.0,</span> <span class="pre">2.0,</span> <span class="pre">3.0]</span></code>). Does a larger <code class="docutils literal notranslate"><span class="pre">kappa</span></code> avoid early over-exploitation here?</p>
</div>
</section>
<section id="small-neural-surrogate-via-mc-dropout">
<h3>6.3 Small neural surrogate via MC Dropout<a class="headerlink" href="#small-neural-surrogate-via-mc-dropout" title="Link to this heading">#</a></h3>
<p>Bayesian Optimization needs a surrogate that gives a prediction and an uncertainty. A Bayesian Neural Network does this by treating the network’s predictions as random rather than fixed. A simple and practical way to get there is MC Dropout. You train a normal MLP with dropout, then at prediction time you keep dropout on and run many stochastic forward passes.</p>
<ol class="arabic simple">
<li><p>Mean: Consider the mean as the network’s best guess of the function value at a point, averaged over many dropout passes (or weight samples).</p></li>
<li><p>Standard deviation: Consider the std as the spread of those predictions, which reflects how uncertain the network is at that point.</p></li>
</ol>
<p>Below is a compact, runnable PyTorch example that uses MC Dropout as a simple BNN surrogate with EI for 15 iterations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simple BNN surrogate via MC Dropout + EI for Bayesian Optimization</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>

<span class="k">def</span><span class="w"> </span><span class="nf">argmax_on_grid</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">grid</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span>

<span class="c1"># Simple MLP with dropout. Keep dropout active at prediction time to sample.</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MCDropoutNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fit_mcdropout</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">X_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">weight_decay</span><span class="p">)</span>
    <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X_t</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">y_t</span><span class="p">)</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">predict_mcdropout</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Xc</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MC Dropout predictions.</span>
<span class="sd">    Returns mean and std over T stochastic forward passes with dropout active.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>  <span class="c1"># keep dropout ON</span>
    <span class="n">X_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">Xc</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
            <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">X_t</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>  <span class="c1"># shape (n, T)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sd</span>

<span class="k">def</span><span class="w"> </span><span class="nf">acq_ei_from_mu_std</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">y_best</span><span class="p">,</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">sd</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">z</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_best</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">/</span> <span class="n">sd</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">ei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="n">ei</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_best</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span> <span class="o">+</span> <span class="n">sd</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ei</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_bo_bnn_ei</span><span class="p">(</span><span class="n">n_iter</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">noise_sd</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">dropout_p</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y_init</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">best_hist</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
    <span class="n">snapshots</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Fit BNN on current data</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MCDropoutNet</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout_p</span><span class="p">)</span>
        <span class="n">fit_mcdropout</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span>

        <span class="c1"># Posterior over grid by MC sampling</span>
        <span class="n">mu_nn</span><span class="p">,</span> <span class="n">sd_nn</span> <span class="o">=</span> <span class="n">predict_mcdropout</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># EI on grid</span>
        <span class="n">acq_vals</span> <span class="o">=</span> <span class="n">acq_ei_from_mu_std</span><span class="p">(</span><span class="n">mu_nn</span><span class="p">,</span> <span class="n">sd_nn</span><span class="p">,</span> <span class="n">y_best</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

        <span class="c1"># Choose next x</span>
        <span class="n">x_next</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">argmax_on_grid</span><span class="p">(</span><span class="n">acq_vals</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">)</span>

        <span class="c1"># Observe noisy value from true function</span>
        <span class="n">y_next</span> <span class="o">=</span> <span class="n">f_true_1d</span><span class="p">(</span><span class="n">x_next</span><span class="p">)</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noise_sd</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>

        <span class="c1"># Update data</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">x_next</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">y_next</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>
        <span class="n">best_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">n_iter</span><span class="p">:</span>
            <span class="n">snapshots</span><span class="p">[</span><span class="s2">&quot;final&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">mu_nn</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">sd_nn</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">best_hist</span><span class="p">,</span> <span class="n">snapshots</span>

<span class="c1"># Run BNN + EI for 15 iterations</span>
<span class="n">hist_bnn_ei</span><span class="p">,</span> <span class="n">snaps</span> <span class="o">=</span> <span class="n">run_bo_bnn_ei</span><span class="p">(</span>
    <span class="n">n_iter</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">noise_sd</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">dropout_p</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>   <span class="c1"># increase dropout to widen uncertainty if needed</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>      <span class="c1"># a bit more training since data are small</span>
    <span class="n">T</span><span class="o">=</span><span class="mi">300</span>             <span class="c1"># more MC samples for a smoother band</span>
<span class="p">)</span>

<span class="c1"># Posterior after 15 iterations</span>
<span class="n">X_obs</span><span class="p">,</span> <span class="n">y_obs</span><span class="p">,</span> <span class="n">mu_final</span><span class="p">,</span> <span class="n">sd_final</span> <span class="o">=</span> <span class="n">snaps</span><span class="p">[</span><span class="s2">&quot;final&quot;</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">mu_final</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;BNN mean (MC Dropout)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_grid</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">mu_final</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">sd_final</span><span class="p">,</span> <span class="n">mu_final</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">sd_final</span><span class="p">,</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;BNN 95% band&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_obs</span><span class="p">,</span> <span class="n">y_obs</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;observed&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;f(x)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;BNN surrogate posterior after 15 EI iterations&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/776e2088d344eaa3b1564f7c077873afbfc454d95fae0c46010a9f53d16586ea.png" src="_images/776e2088d344eaa3b1564f7c077873afbfc454d95fae0c46010a9f53d16586ea.png" />
</div>
</div>
</section>
</section>
<section id="chemistry-case-study-suzuki-coupling-toy-dataset">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">7. Chemistry case study: Suzuki coupling toy dataset</a><a class="headerlink" href="#chemistry-case-study-suzuki-coupling-toy-dataset" title="Link to this heading">#</a></h2>
<p>We now switch to a chemistry example that mirrors a common experimental optimization. Consider <strong>Suzuki cross coupling</strong> where you can control:</p>
<ul class="simple">
<li><p>Reaction time <span class="math notranslate nohighlight">\(t\)</span> in minutes</p></li>
<li><p>Temperature <span class="math notranslate nohighlight">\(T\)</span> in Celsius</p></li>
<li><p>Substrate concentration <span class="math notranslate nohighlight">\(C\)</span> in molar</p></li>
</ul>
<p>Our goal is to <strong>maximize yield</strong>. We will build a toy function that captures a plausible shape: yield grows with time then plateaus, has a sweet spot in temperature, and prefers a moderate concentration. We also add mild interactions and noise.</p>
<p>We generate 800 points to form a dataset you can explore and also use as an oracle to simulate experiments.</p>
<section id="create-the-toy-suzuki-dataset">
<h3>7.1 Create the toy Suzuki dataset<a class="headerlink" href="#create-the-toy-suzuki-dataset" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 7.1 Simulated Suzuki yield function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">suzuki_yield</span><span class="p">(</span><span class="n">time_min</span><span class="p">,</span> <span class="n">temp_c</span><span class="p">,</span> <span class="n">conc_m</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># time_min in 10..180</span>
    <span class="c1"># temp_c in 50..110</span>
    <span class="c1"># conc_m in 0.05..1.00</span>
    <span class="c1"># returns yield in 0..100</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time_min</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temp_c</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">conc_m</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Time effect: saturating curve</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="mf">35.0</span>
    <span class="n">time_term</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="mf">10.0</span><span class="p">)</span><span class="o">/</span><span class="n">t0</span><span class="p">)</span>
    <span class="n">time_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">time_term</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># Temperature: optimal around ~95 but shifts slightly with concentration</span>
    <span class="n">T_opt</span> <span class="o">=</span> <span class="mf">96.0</span> <span class="o">-</span> <span class="mf">6.0</span><span class="o">*</span><span class="p">(</span><span class="n">C</span> <span class="o">-</span> <span class="mf">0.35</span><span class="p">)</span>
    <span class="n">sigma_T</span> <span class="o">=</span> <span class="mf">9.0</span>
    <span class="n">temp_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">T</span> <span class="o">-</span> <span class="n">T_opt</span><span class="p">)</span><span class="o">/</span><span class="n">sigma_T</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Concentration: moderate optimum</span>
    <span class="n">C_opt</span> <span class="o">=</span> <span class="mf">0.35</span>
    <span class="n">sigma_C</span> <span class="o">=</span> <span class="mf">0.18</span>
    <span class="n">conc_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">C</span> <span class="o">-</span> <span class="n">C_opt</span><span class="p">)</span><span class="o">/</span><span class="n">sigma_C</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Mild over-cooking penalty</span>
    <span class="n">over</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="mf">140.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">burn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">over</span><span class="o">/</span><span class="mf">25.0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">base</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">time_term</span> <span class="o">*</span> <span class="n">temp_term</span> <span class="o">*</span> <span class="n">conc_term</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.85</span> <span class="o">+</span> <span class="mf">0.15</span><span class="o">*</span><span class="n">burn</span><span class="p">)</span>

    <span class="c1"># small nonlinear coupling term</span>
    <span class="n">coupling</span> <span class="o">=</span> <span class="mf">6.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">0.015</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="mf">70.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">3.0</span><span class="o">*</span><span class="p">(</span><span class="n">C</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">coupling</span>

    <span class="k">if</span> <span class="n">rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>  <span class="c1"># lab noise</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">)</span>

<span class="c1"># Generate 800 random experiments</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">800</span>
<span class="n">time_vals</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">temp_vals</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">conc_vals</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>

<span class="n">yield_vals</span> <span class="o">=</span> <span class="n">suzuki_yield</span><span class="p">(</span><span class="n">time_vals</span><span class="p">,</span> <span class="n">temp_vals</span><span class="p">,</span> <span class="n">conc_vals</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

<span class="n">df_suzuki</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;time_min&quot;</span><span class="p">:</span> <span class="n">time_vals</span><span class="p">,</span>
    <span class="s2">&quot;temp_c&quot;</span><span class="p">:</span> <span class="n">temp_vals</span><span class="p">,</span>
    <span class="s2">&quot;conc_m&quot;</span><span class="p">:</span> <span class="n">conc_vals</span><span class="p">,</span>
    <span class="s2">&quot;yield&quot;</span><span class="p">:</span> <span class="n">yield_vals</span>
<span class="p">})</span>
<span class="n">df_suzuki</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

<span class="c1"># Inspect ranges and a few quantiles</span>
<span class="n">df_suzuki</span><span class="o">.</span><span class="n">describe</span><span class="p">()[[</span><span class="s2">&quot;time_min&quot;</span><span class="p">,</span><span class="s2">&quot;temp_c&quot;</span><span class="p">,</span><span class="s2">&quot;conc_m&quot;</span><span class="p">,</span><span class="s2">&quot;yield&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time_min</th>
      <th>temp_c</th>
      <th>conc_m</th>
      <th>yield</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>800.000000</td>
      <td>800.000000</td>
      <td>800.000000</td>
      <td>800.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>94.616242</td>
      <td>79.418759</td>
      <td>0.510738</td>
      <td>14.535193</td>
    </tr>
    <tr>
      <th>std</th>
      <td>49.425893</td>
      <td>17.436767</td>
      <td>0.274654</td>
      <td>22.092498</td>
    </tr>
    <tr>
      <th>min</th>
      <td>10.031436</td>
      <td>50.102473</td>
      <td>0.051375</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>51.989009</td>
      <td>64.015690</td>
      <td>0.276434</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>92.955198</td>
      <td>80.123321</td>
      <td>0.493572</td>
      <td>2.801323</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>138.782055</td>
      <td>94.581001</td>
      <td>0.740081</td>
      <td>22.791306</td>
    </tr>
    <tr>
      <th>max</th>
      <td>179.954612</td>
      <td>109.870879</td>
      <td>0.998107</td>
      <td>97.916358</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="visual-slices-of-the-surface">
<h3>7.2 Visual slices of the surface<a class="headerlink" href="#visual-slices-of-the-surface" title="Link to this heading">#</a></h3>
<p>We fix one variable and show how yield changes with the other two.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fix conc at 0.35 M and scan time, temp</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">TT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">TT_grid</span><span class="p">,</span> <span class="n">tt_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">TT</span><span class="p">,</span> <span class="n">tt</span><span class="p">)</span>
<span class="n">C_fixed</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">YY</span> <span class="o">=</span> <span class="n">suzuki_yield</span><span class="p">(</span><span class="n">tt_grid</span><span class="p">,</span> <span class="n">TT_grid</span><span class="p">,</span> <span class="n">C_fixed</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">TT_grid</span><span class="p">,</span> <span class="n">tt_grid</span><span class="p">,</span> <span class="n">YY</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;yield&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;temp_c&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;time_min&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Yield at conc=0.35 M&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Fix time at 80 min and scan temp vs conc</span>
<span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>
<span class="n">TT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">TT_grid</span><span class="p">,</span> <span class="n">cc_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">TT</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span>
<span class="n">t_fixed</span> <span class="o">=</span> <span class="mf">80.0</span>
<span class="n">YY2</span> <span class="o">=</span> <span class="n">suzuki_yield</span><span class="p">(</span><span class="n">t_fixed</span><span class="p">,</span> <span class="n">TT_grid</span><span class="p">,</span> <span class="n">cc_grid</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">TT_grid</span><span class="p">,</span> <span class="n">cc_grid</span><span class="p">,</span> <span class="n">YY2</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;yield&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;temp_c&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;conc_m&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Yield at time=80 min&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/00e952f35af12478a7ede37c0c3471c6c683dc36ff1f0eacc93a792dc4158aaf.png" src="_images/00e952f35af12478a7ede37c0c3471c6c683dc36ff1f0eacc93a792dc4158aaf.png" />
<img alt="_images/dd2141b37e27f2793d44f9015ca01702288b14f1c8b791847f2ab512d0eaffe5.png" src="_images/dd2141b37e27f2793d44f9015ca01702288b14f1c8b791847f2ab512d0eaffe5.png" />
</div>
</div>
<p>These slices show a sweet region that we want BO to find in as few trials as possible.</p>
</section>
<section id="normalize-the-space-to-0-1-3">
<h3>7.3 Normalize the space to [0,1]^3<a class="headerlink" href="#normalize-the-space-to-0-1-3" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Helpers to decode to lab units</span>
<span class="k">def</span><span class="w"> </span><span class="nf">decode_3d</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">scaler_3d</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">scaler_3d</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_suzuki</span><span class="p">[[</span><span class="s2">&quot;time_min&quot;</span><span class="p">,</span><span class="s2">&quot;temp_c&quot;</span><span class="p">,</span><span class="s2">&quot;conc_m&quot;</span><span class="p">]])</span>
<span class="n">X_all</span> <span class="o">=</span> <span class="n">scaler_3d</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df_suzuki</span><span class="p">[[</span><span class="s2">&quot;time_min&quot;</span><span class="p">,</span><span class="s2">&quot;temp_c&quot;</span><span class="p">,</span><span class="s2">&quot;conc_m&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">y_all</span> <span class="o">=</span> <span class="n">df_suzuki</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="n">X_all</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">y_all</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([[0.07615779, 0.23310162, 0.31037802],
        [0.7800864 , 0.06377678, 0.60385531],
        [0.43842244, 0.27146366, 0.4054797 ]]),
 array([0.39303965, 0.        , 4.34222798]))
</pre></div>
</div>
</div>
</div>
</section>
<section id="bo-on-the-suzuki-surface-with-a-gp-surrogate">
<h3>7.4 BO on the Suzuki surface with a GP surrogate<a class="headerlink" href="#bo-on-the-suzuki-surface-with-a-gp-surrogate" title="Link to this heading">#</a></h3>
<p>We treat <code class="docutils literal notranslate"><span class="pre">suzuki_yield</span></code> as the lab experiment. At each step, BO proposes a normalized point <code class="docutils literal notranslate"><span class="pre">u</span></code> in [0,1]^3, we decode to lab units, run the experiment, and get a yield.</p>
<p>We use <strong>EI</strong> as the acquisition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 7.4 BO loop on 3D Suzuki with GP + EI</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># initial 8 random runs</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">lab_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">decode_3d</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">U</span><span class="p">])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">suzuki_yield</span><span class="p">(</span><span class="n">lab_pts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">lab_pts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">lab_pts</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

<span class="n">kernel3</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">50.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">Matern</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="n">nu</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span> <span class="o">+</span> <span class="n">WhiteKernel</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">gp3</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel3</span><span class="p">,</span> <span class="n">normalize_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_restarts_optimizer</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">best_hist</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
<span class="n">trace</span> <span class="o">=</span> <span class="p">[</span><span class="n">lab_pts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">)]]</span>

<span class="c1"># Candidate grid for acquisition (random Latin-style sampling)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">candidate_cloud</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">U_cand</span> <span class="o">=</span> <span class="n">candidate_cloud</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># BO iterations</span>
<span class="n">n_iter</span> <span class="o">=</span> <span class="mi">30</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iter</span><span class="p">):</span>
    <span class="n">gp3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">mu</span><span class="p">,</span> <span class="n">sd</span> <span class="o">=</span> <span class="n">gp3</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">U_cand</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ei</span> <span class="o">=</span> <span class="n">acq_ei</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">y_best</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">u_next</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">argmax_on_grid</span><span class="p">(</span><span class="n">ei</span><span class="p">,</span> <span class="n">U_cand</span><span class="p">)</span>
    <span class="n">lab_next</span> <span class="o">=</span> <span class="n">decode_3d</span><span class="p">(</span><span class="n">u_next</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="n">y_next</span> <span class="o">=</span> <span class="n">suzuki_yield</span><span class="p">(</span><span class="n">lab_next</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lab_next</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lab_next</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

    <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">U</span><span class="p">,</span> <span class="n">u_next</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">y_next</span><span class="p">])</span>
    <span class="n">best_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">y_next</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lab_next</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot improvement</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">best_hist</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Best yield&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Suzuki: BO with GP + EI (best yield vs iter)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearSegmentedColormap</span>

<span class="c1"># custom colormap from grey to red</span>
<span class="n">grey_red</span> <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s2">&quot;grey_red&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">])</span>

<span class="n">orders</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">U</span><span class="p">))</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">size_scale</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># adjust scaling factor to taste</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mf">3.5</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">orders</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">grey_red</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">Y</span><span class="o">*</span><span class="n">size_scale</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time_u&quot;</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;temp_u&quot;</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;time vs temp&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">orders</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">grey_red</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">Y</span><span class="o">*</span><span class="n">size_scale</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time_u&quot;</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;conc_u&quot;</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;time vs conc&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">orders</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">grey_red</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">Y</span><span class="o">*</span><span class="n">size_scale</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;temp_u&quot;</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;conc_u&quot;</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;temp vs conc&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Order of samples during BO (size ~ yield)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/9aec50f42d59dcb8acb30c0a747edbaf0c2a5ece2bc0011b123bd7794b0a15cb.png" src="_images/9aec50f42d59dcb8acb30c0a747edbaf0c2a5ece2bc0011b123bd7794b0a15cb.png" />
<img alt="_images/26f0e0c1f32427998820b14eae6f5ff9eb9792d6c0aaec291a2b78959b918310.png" src="_images/26f0e0c1f32427998820b14eae6f5ff9eb9792d6c0aaec291a2b78959b918310.png" />
</div>
</div>
</section>
<section id="compare-to-grid-and-random-for-the-same-number-of-lab-runs">
<h3>7.5 Compare to grid and random for the same number of lab runs<a class="headerlink" href="#compare-to-grid-and-random-for-the-same-number-of-lab-runs" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define budgets you want to test</span>
<span class="n">budgets</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">140</span><span class="p">]</span>

<span class="c1"># Build a coarse grid once for comparison</span>
<span class="n">G_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">G_lin</span><span class="p">,</span> <span class="n">G_lin</span><span class="p">,</span> <span class="n">G_lin</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_strategy</span><span class="p">(</span><span class="n">U_points</span><span class="p">):</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">U_points</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">decode_3d</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">suzuki_yield</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">B</span> <span class="ow">in</span> <span class="n">budgets</span><span class="p">:</span>
    <span class="c1"># Grid: take first B points from grid</span>
    <span class="n">best_grid</span> <span class="o">=</span> <span class="n">run_strategy</span><span class="p">(</span><span class="n">G</span><span class="p">[:</span><span class="n">B</span><span class="p">])</span>
    <span class="c1"># Random: draw B random points</span>
    <span class="n">best_rand</span> <span class="o">=</span> <span class="n">run_strategy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="c1"># BO: best after B BO evaluations (use first B y values if available)</span>
    <span class="n">best_bo</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">B</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">B</span> <span class="k">else</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Budget&quot;</span><span class="p">:</span> <span class="n">B</span><span class="p">,</span> <span class="s2">&quot;Method&quot;</span><span class="p">:</span> <span class="s2">&quot;BO (EI)&quot;</span><span class="p">,</span> <span class="s2">&quot;Best yield&quot;</span><span class="p">:</span> <span class="n">best_bo</span><span class="p">})</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Budget&quot;</span><span class="p">:</span> <span class="n">B</span><span class="p">,</span> <span class="s2">&quot;Method&quot;</span><span class="p">:</span> <span class="s2">&quot;Grid&quot;</span><span class="p">,</span> <span class="s2">&quot;Best yield&quot;</span><span class="p">:</span> <span class="n">best_grid</span><span class="p">})</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Budget&quot;</span><span class="p">:</span> <span class="n">B</span><span class="p">,</span> <span class="s2">&quot;Method&quot;</span><span class="p">:</span> <span class="s2">&quot;Random&quot;</span><span class="p">,</span> <span class="s2">&quot;Best yield&quot;</span><span class="p">:</span> <span class="n">best_rand</span><span class="p">})</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Budget&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Best yield&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;Method&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Best yield vs budget&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Best observed yield&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/2b8e61e663a9ed7689d4f7083b5881156d3923d0e71c0b79c7e2ac48d9538f45.png" src="_images/2b8e61e663a9ed7689d4f7083b5881156d3923d0e71c0b79c7e2ac48d9538f45.png" />
</div>
</div>
</section>
<section id="a-quick-rf-surrogate-on-suzuki">
<h3>7.6 A quick RF surrogate on Suzuki<a class="headerlink" href="#a-quick-rf-surrogate-on-suzuki" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 7.6 Repeat BO with RF + UCB on Suzuki</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<span class="n">U_rf</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">lab_rf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">decode_3d</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">U_rf</span><span class="p">])</span>
<span class="n">y_rf</span> <span class="o">=</span> <span class="n">suzuki_yield</span><span class="p">(</span><span class="n">lab_rf</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">lab_rf</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">lab_rf</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

<span class="n">best_hist_rf</span> <span class="o">=</span> <span class="p">[</span><span class="n">y_rf</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">):</span>
    <span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">U_rf</span><span class="p">,</span> <span class="n">y_rf</span><span class="p">)</span>
    <span class="n">mu</span><span class="p">,</span> <span class="n">sd</span> <span class="o">=</span> <span class="n">rf_mean_std</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">U_cand</span><span class="p">)</span>
    <span class="n">acq</span> <span class="o">=</span> <span class="n">acq_ucb</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">1.6</span><span class="p">)</span>
    <span class="n">u_next</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">argmax_on_grid</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">U_cand</span><span class="p">)</span>
    <span class="n">lab_next</span> <span class="o">=</span> <span class="n">decode_3d</span><span class="p">(</span><span class="n">u_next</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="n">y_next</span> <span class="o">=</span> <span class="n">suzuki_yield</span><span class="p">(</span><span class="n">lab_next</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lab_next</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lab_next</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

    <span class="n">U_rf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">U_rf</span><span class="p">,</span> <span class="n">u_next</span><span class="p">])</span>
    <span class="n">y_rf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">y_rf</span><span class="p">,</span> <span class="n">y_next</span><span class="p">])</span>
    <span class="n">best_hist_rf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_rf</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">best_hist_rf</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Best yield&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Suzuki: RF surrogate with UCB&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/b852f646257cc9166ade9be6ffb22598c7da3d829521bc56be37c624d956bb44.png" src="_images/b852f646257cc9166ade9be6ffb22598c7da3d829521bc56be37c624d956bb44.png" />
</div>
</div>
</section>
</section>
<section id="glossary">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">8. Glossary</a><a class="headerlink" href="#glossary" title="Link to this heading">#</a></h2>
<dl class="simple glossary">
<dt id="term-Bayesian-Optimization">Bayesian Optimization<a class="headerlink" href="#term-Bayesian-Optimization" title="Link to this term">#</a></dt><dd><p>A method to optimize expensive black-box functions by fitting a surrogate with uncertainty and choosing the next experiment via an acquisition function.</p>
</dd>
<dt id="term-Surrogate-model">Surrogate model<a class="headerlink" href="#term-Surrogate-model" title="Link to this term">#</a></dt><dd><p>A fast predictive model (GP, random forest, small NN) that provides a mean <span class="math notranslate nohighlight">\(\mu(x)\)</span> and an uncertainty proxy <span class="math notranslate nohighlight">\(\sigma(x)\)</span>.</p>
</dd>
<dt id="term-Prior-belief">Prior belief<a class="headerlink" href="#term-Prior-belief" title="Link to this term">#</a></dt><dd><p>Initial assumption about the shape of the objective before data, such as a GP with a chosen kernel.</p>
</dd>
<dt id="term-Posterior">Posterior<a class="headerlink" href="#term-Posterior" title="Link to this term">#</a></dt><dd><p>Updated belief after seeing data. For a GP this yields closed-form <span class="math notranslate nohighlight">\(\mu(x)\)</span> and <span class="math notranslate nohighlight">\(\sigma(x)\)</span>.</p>
</dd>
<dt id="term-Kernel-covariance-function">Kernel (covariance function)<a class="headerlink" href="#term-Kernel-covariance-function" title="Link to this term">#</a></dt><dd><p>Function defining similarity between inputs. Common choices: RBF, Matern. The length scale sets smoothness.</p>
</dd>
<dt id="term-Expected-Improvement-EI">Expected Improvement (EI)<a class="headerlink" href="#term-Expected-Improvement-EI" title="Link to this term">#</a></dt><dd><p>Acquisition that scores the expected gain over the current best.</p>
</dd>
<dt id="term-Upper-Confidence-Bound-UCB">Upper Confidence Bound (UCB)<a class="headerlink" href="#term-Upper-Confidence-Bound-UCB" title="Link to this term">#</a></dt><dd><p>Acquisition that adds a multiple of uncertainty to the mean: <span class="math notranslate nohighlight">\(\mu + \kappa \sigma\)</span>.</p>
</dd>
<dt id="term-Probability-of-Improvement-PI">Probability of Improvement (PI)<a class="headerlink" href="#term-Probability-of-Improvement-PI" title="Link to this term">#</a></dt><dd><p>Acquisition that scores the probability to improve over the best by at least a margin.</p>
</dd>
<dt id="term-Exploration">Exploration<a class="headerlink" href="#term-Exploration" title="Link to this term">#</a></dt><dd><p>Trying uncertain regions with high <span class="math notranslate nohighlight">\(\sigma(x)\)</span> to gain information.</p>
</dd>
<dt id="term-Exploitation">Exploitation<a class="headerlink" href="#term-Exploitation" title="Link to this term">#</a></dt><dd><p>Focusing near known good regions with high <span class="math notranslate nohighlight">\(\mu(x)\)</span>.</p>
</dd>
</dl>
</section>
<section id="in-class-activity">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">9. In-class activity</a><a class="headerlink" href="#in-class-activity" title="Link to this heading">#</a></h2>
<p><strong>Q1</strong></p>
<ol class="arabic simple">
<li><p>Run BO on the Suzuki surface using RF + EI for 20 rounds with <code class="docutils literal notranslate"><span class="pre">n_estimators=100</span></code>, same initial design. Capture best yield per round.</p></li>
<li><p>Repeat with <code class="docutils literal notranslate"><span class="pre">n_estimators=1000</span></code>.</p></li>
<li><p>Run GP + EI for 20 rounds on the same initial points and the same candidate cloud.</p></li>
<li><p>Plot the three best so far curves together. Comment on stability and speed.</p></li>
</ol>
<p>Yes, this lecture only has one in class question to work on.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#TO DO</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1"></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">1. Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-bayesian-optimization">2. What is Bayesian Optimization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-tiny-1d-objective-for-intuition">2.1 A tiny 1D objective for intuition</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-process-surrogate-prior-posterior-kernel">3. Gaussian Process surrogate: prior, posterior, kernel</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#draw-function-samples-from-the-prior">3.1 Draw function samples from the prior</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-gp-posterior-on-a-few-points">3.2 Fit GP posterior on a few points</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#acquisition-functions-ei-ucb-pi-greedy">4. Acquisition functions: EI, UCB, PI, greedy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implement-acquisition-functions">4.1 Implement acquisition functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-acquisition-shapes">4.2 Visualize acquisition shapes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-bo-loop-in-1d-step-by-step">5. The BO loop in 1D step by step</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#small-utility-argmax-on-a-grid">5.1 Small utility: argmax on a grid</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-bo-with-ei">5.2 Run BO with EI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#where-did-bo-sample">5.3 Where did BO sample</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#surrogate-alternatives-and-simple-diagnostics">6. Surrogate alternatives and simple diagnostics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest-surrogate-mean-and-std-from-trees">6.1 Random Forest surrogate: mean and std from trees</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bo-loop-with-rf-surrogate-ei">6.2 BO loop with RF surrogate (EI)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#small-neural-surrogate-via-mc-dropout">6.3 Small neural surrogate via MC Dropout</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#chemistry-case-study-suzuki-coupling-toy-dataset">7. Chemistry case study: Suzuki coupling toy dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-the-toy-suzuki-dataset">7.1 Create the toy Suzuki dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visual-slices-of-the-surface">7.2 Visual slices of the surface</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#normalize-the-space-to-0-1-3">7.3 Normalize the space to [0,1]^3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bo-on-the-suzuki-surface-with-a-gp-surrogate">7.4 BO on the Suzuki surface with a GP surrogate</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compare-to-grid-and-random-for-the-same-number-of-lab-runs">7.5 Compare to grid and random for the same number of lab runs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-quick-rf-surrogate-on-suzuki">7.6 A quick RF surrogate on Suzuki</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">8. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-class-activity">9. In-class activity</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>