
<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lecture 16 - Reinforcement Learning &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css?v=6ad1a40c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js?v=2b91c5f0"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js?v=afe5de03"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lecture-16';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Lecture 17 - PU Learning" href="lecture-17.html" />
    <link rel="prev" title="Lecture 15 - Multi-objective Bayesian Optimization" href="lecture-15.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to CHEM 5080: AI for Experimental Chemistry
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="lecture-01.html">Lecture 1 - Python Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-02.html">Lecture 2 - Pandas and Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-03.html">Lecture 3 - SMILES and RDKit</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-04.html">Lecture 4 - Chemical Structure Identifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-05.html">Lecture 5 - Regression and Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-06.html">Lecture 6 - Cross-Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-07.html">Lecture 7 - Decision Trees and Random Forests</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-08.html">Lecture 8 - Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-09.html">Lecture 9 - Graph Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-10.html">Lecture 10 - Property &amp; Reaction Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-11.html">Lecture 11 - Dimension Reduction for Data Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-12.html">Lecture 12 - Self-Supervised Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-13.html">Lecture 13 - De Novo Molecule Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-14.html">Lecture 14 - Bayesian Optimization for Synthesis Conditions</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-15.html">Lecture 15 - Multi-objective Bayesian Optimization</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Lecture 16 - Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-17.html">Lecture 17 - PU Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-18.html">Lecture 18 - Contrastive Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-19.html">Lecture 19 - Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-20.html">Lecture 20 - Large Language Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-21.html">Lecture 21 - Computer Vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-22.html">Lecture 22 - Vision Languge Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-23.html">Lecture 23 - Prompt Engineering and Function Calling</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Flecture-16.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/lecture-16.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lecture 16 - Reinforcement Learning</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">0. Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reinforcement-learning-concepts">1. Reinforcement learning concepts</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#let-s-play-games-to-understand-q-learning">2. Let’s play games to understand Q-Learning!</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interactive-game-1-breakout">2.1 Interactive Game 1 — Breakout</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interactive-game-2-maze">2.2 Interactive Game 2 — Maze</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interactive-game-3-reaction-surface-screening">2.3 Interactive Game 3 — Reaction Surface Screening</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">2.3 Interactive Game 3 — Reaction Surface Screening</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#q-learning-on-a-chemistry-grid">3. Q-learning on a Chemistry Grid</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bridge-to-multi-armed-bandits">4. Bridge to Multi-Armed Bandits</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#case-study-mof-synthesis-as-a-bandit-on-yield">5. Case study: MOF synthesis as a bandit on yield</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-and-process-the-dataset">5.1 Load and process the dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bandit-framing-and-algorithms">5.2 Bandit framing and algorithms</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-agents-and-building-a-compact-report">5.3  Running the agents and building a compact report</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interpreting-the-results-and-tracking-learning">5.4 Interpreting the results and tracking learning</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#general-synthesis-condition-works-best-across-all-linkers">5.5 General synthesis condition works best across all linkers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">6. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-class-activity">7. In-class activity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q1">Q1</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lecture-16-reinforcement-learning">
<h1>Lecture 16 - Reinforcement Learning<a class="headerlink" href="#lecture-16-reinforcement-learning" title="Permalink to this heading">#</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#learning-goals" id="id2">Learning goals</a></p></li>
<li><p><a class="reference internal" href="#setup" id="id3">0. Setup</a></p></li>
<li><p><a class="reference internal" href="#reinforcement-learning-concepts" id="id4">1. Reinforcement learning concepts</a></p></li>
<li><p><a class="reference internal" href="#let-s-play-games-to-understand-q-learning" id="id5">2. Let’s play games to understand Q-Learning!</a></p></li>
<li><p><a class="reference internal" href="#q-learning-on-a-chemistry-grid" id="id6">3. Q-learning on a Chemistry Grid</a></p></li>
<li><p><a class="reference internal" href="#bridge-to-multi-armed-bandits" id="id7">4. Bridge to Multi-Armed Bandits</a></p></li>
<li><p><a class="reference internal" href="#case-study-mof-synthesis-as-a-bandit-on-yield" id="id8">5. Case study: MOF synthesis as a bandit on yield</a></p></li>
<li><p><a class="reference internal" href="#glossary" id="id9">6. Glossary</a></p></li>
<li><p><a class="reference internal" href="#in-class-activity" id="id10">7. In-class activity</a></p></li>
</ul>
</nav>
<section id="learning-goals">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Learning goals</a><a class="headerlink" href="#learning-goals" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Understand the definition of agent, environment, state, action, reward, trajectory, policy, and value.</p></li>
<li><p>Build a tiny grid world with a chemistry flavor and implement tabular Q-learning step by step.</p></li>
<li><p>Compare exploration strategies such as epsilon greedy, optimistic starts, UCB1, and Thompson sampling in bandits.</p></li>
<li><p>Practice a simplified policy gradient on a bandit.
<a class="reference external" href="https://colab.research.google.com/drive/1dLok-Ve2VyvyKwLRY-08n-MCCKd88XiN?usp=sharing"><img alt="Colab" src="https://img.shields.io/badge/Open-Colab-orange" /></a></p></li>
</ul>
</section>
<section id="setup">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">0. Setup</a><a class="headerlink" href="#setup" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Circle</span><span class="p">,</span> <span class="n">FancyBboxPatch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patheffects</span><span class="w"> </span><span class="kn">import</span> <span class="n">withStroke</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="reinforcement-learning-concepts">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">1. Reinforcement learning concepts</a><a class="headerlink" href="#reinforcement-learning-concepts" title="Permalink to this heading">#</a></h2>
<p>Reinforcement learning studies decision making through repeated interaction.</p>
<p>An agent observes a state <span class="math notranslate nohighlight">\(s\)</span>, chooses an action <span class="math notranslate nohighlight">\(a\)</span>, gets a reward <span class="math notranslate nohighlight">\(r\)</span>, and moves to a new state <span class="math notranslate nohighlight">\(s'\)</span>.</p>
<p>The aim is to maximize expected return <span class="math notranslate nohighlight">\(G = r_0 + \gamma r_1 + \gamma^2 r_2 + \cdots\)</span> with <span class="math notranslate nohighlight">\(\gamma \in [0,1)\)</span>.</p>
<p>For example, in closed-loop chemistry discovery the agent proposes the next experiment and the environment is the lab system that reports outcomes like yield.</p>
<p>Here are key terms:</p>
<ul class="simple">
<li><p><strong>State <span class="math notranslate nohighlight">\(s\)</span></strong>: summary of what matters right now.</p></li>
<li><p><strong>Action <span class="math notranslate nohighlight">\(a\)</span></strong>: a choice such as a set of synthesis conditions.</p></li>
<li><p><strong>Reward <span class="math notranslate nohighlight">\(r\)</span></strong>: scalar signal such as yield or a utility of yield and purity.</p></li>
<li><p><strong>Policy <span class="math notranslate nohighlight">\(\pi(a\mid s)\)</span></strong>: a rule to pick actions given a state.</p></li>
<li><p><strong>Value <span class="math notranslate nohighlight">\(V^{\pi}(s)\)</span></strong>: expected return from state <span class="math notranslate nohighlight">\(s\)</span> under policy <span class="math notranslate nohighlight">\(\pi\)</span>.</p></li>
<li><p><strong>Action value <span class="math notranslate nohighlight">\(Q^{\pi}(s,a)\)</span></strong>: expected return if we choose <span class="math notranslate nohighlight">\(a\)</span> in <span class="math notranslate nohighlight">\(s\)</span> then follow <span class="math notranslate nohighlight">\(\pi\)</span>.</p></li>
<li><p><strong>Model</strong>: transition and reward dynamics, often unknown in labs.</p></li>
</ul>
<p>The next plot shows this loop visually.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_outlined_text</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="p">[</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="n">ha</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="n">va</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">path_effects</span><span class="o">=</span><span class="n">pe</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">draw_agent_environment_diagram</span><span class="p">():</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="c1"># Agent (circle)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">((</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;#bfd7ff&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
    <span class="n">_outlined_text</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="s2">&quot;Agent&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

    <span class="c1"># Environment (rounded rectangle)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">FancyBboxPatch</span><span class="p">(</span>
        <span class="p">(</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.2,rounding_size=0.2&quot;</span><span class="p">,</span>
        <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;#c8e6c9&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">_outlined_text</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="s2">&quot;Environment&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

    <span class="c1"># Arrows: action (Agent -&gt; Env), observation+reward (Env -&gt; Agent)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">),</span>
        <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_outlined_text</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">3.25</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;action $a_t$&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">2.6</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">2.6</span><span class="p">),</span>
        <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_outlined_text</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">2.25</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;state $s_t$, reward $r_t$&quot;</span><span class="p">)</span>

    <span class="c1"># Timeline hint</span>
    <span class="n">_outlined_text</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.2</span><span class="p">,</span> <span class="s2">&quot;repeat for t = 0, 1, 2, ...&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Agent–Environment interaction&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">draw_agent_environment_diagram</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/f7211d164a34bba1b2b9bffad2a138b877235734bd446797e380071c65722b8c.png" src="_images/f7211d164a34bba1b2b9bffad2a138b877235734bd446797e380071c65722b8c.png" />
</div>
</div>
</section>
<section id="let-s-play-games-to-understand-q-learning">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">2. Let’s play games to understand Q-Learning!</a><a class="headerlink" href="#let-s-play-games-to-understand-q-learning" title="Permalink to this heading">#</a></h2>
<p>One of the simplest ways of doing Reinforcement Learning is called Q-learning. Here we want to estimate so-called <strong>Q-values</strong> which are also called action-values, because they map a state of the game-environment to a numerical value for <em>each possible action that the agent may take</em>. The Q-values indicate which action is expected to result in the highest <strong>future reward</strong>, thus telling the agent which action to take.</p>
<div class="math notranslate nohighlight">
\[
    Q(s_{t},a_{t}) \leftarrow \underbrace{r_{t}}_{\rm reward} + \underbrace{\gamma}_{\rm discount} \cdot \underbrace{\max_{a}Q(s_{t+1}, a)}_{\rm estimate~of~future~rewards}
\]</div>
<p>Most of time, we do not know what the Q-values are supposed to be, so we first initialize all to zero and then updated repeatedly as new information is collected from the agent playing the game. When update the Q-valu, we consider <strong>discount-factor</strong> slightly below 1, which this causes more distant rewards (e.g. take 10 steps to get 1 point vs. take 2 step to get 1 point) to contribute less to the Q-value, thus making the agent favour rewards that are closer in time.</p>
<p>Therefore, the formula for updating the Q-value is:</p>
<blockquote>
<div><p>Q-value for state and action = reward + discount * max Q-value for next state</p>
</div></blockquote>
<p>Next, we’ll play interactive “games” that make these updates visible.</p>
<section id="interactive-game-1-breakout">
<h3>2.1 Interactive Game 1 — Breakout<a class="headerlink" href="#interactive-game-1-breakout" title="Permalink to this heading">#</a></h3>
<p><strong>State</strong></p>
<p>Binned ball and paddle positions plus ball velocity signs.</p>
<p><strong>Actions</strong></p>
<p>Left, Stay, Right.</p>
<p><strong>Controls</strong></p>
<ul class="simple">
<li><p>← / → or A / D to move the paddle.</p></li>
<li><p>Try manual mode first.</p></li>
<li><p>Enable <strong>Agent</strong> in the panel to let Q-learning play automatically.</p></li>
<li><p>Adjust:</p>
<ul>
<li><p>ε (epsilon): exploration rate</p></li>
<li><p>α (alpha): learning rate</p></li>
<li><p>γ (gamma): discount factor</p></li>
</ul>
</li>
</ul>
<p><strong>Rewards</strong></p>
<ul class="simple">
<li><p>+1 for breaking a brick</p></li>
<li><p>+0.01 for hitting the ball with the paddle</p></li>
<li><p>−1 for losing a life</p></li>
<li><p>−0.001 per step to encourage faster play</p></li>
</ul>
<p>Try training for several episodes and then watch the agent’s learned behavior.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTML</span>

<span class="n">HTML</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;div id=&quot;breakout-container&quot; style=&quot;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 1rem 0;&quot;&gt;</span>
<span class="s2">  &lt;div style=&quot;display:flex;flex-wrap:wrap;align-items:center;gap:.5rem;margin-bottom:.5rem;&quot;&gt;</span>
<span class="s2">    &lt;button id=&quot;bo-start&quot; style=&quot;padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Start&lt;/button&gt;</span>
<span class="s2">    &lt;button id=&quot;bo-pause&quot; style=&quot;padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Pause&lt;/button&gt;</span>
<span class="s2">    &lt;button id=&quot;bo-reset&quot; style=&quot;padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Reset&lt;/button&gt;</span>
<span class="s2">    &lt;label style=&quot;margin-left:1rem;display:flex;align-items:center;gap:.35rem;color:#ddd;&quot;&gt;</span>
<span class="s2">      &lt;input type=&quot;checkbox&quot; id=&quot;stopAtZero&quot; /&gt;</span>
<span class="s2">      Stop at 0 lives</span>
<span class="s2">    &lt;/label&gt;</span>
<span class="s2">    &lt;span style=&quot;opacity:.85;&quot;&gt;Controls: ←/→ or A/D, P pause, R reset&lt;/span&gt;</span>
<span class="s2">  &lt;/div&gt;</span>

<span class="s2">  &lt;canvas id=&quot;breakout&quot; width=&quot;800&quot; height=&quot;560&quot; style=&quot;max-width:100%;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);background:#0b1021;display:block;outline:none;&quot;&gt;&lt;/canvas&gt;</span>

<span class="s2">  &lt;div id=&quot;bo-msg&quot; style=&quot;margin-top:.5rem;color:#ddd;opacity:.9;&quot;&gt;Click the canvas to focus.&lt;/div&gt;</span>

<span class="s2">  &lt;details style=&quot;margin-top:1rem;background:#0f1329;border:1px solid #222;border-radius:10px;padding:.75rem;color:#e6e6e6;&quot;&gt;</span>
<span class="s2">    &lt;summary style=&quot;cursor:pointer;font-weight:600;&quot;&gt;Reinforcement Learning demo&lt;/summary&gt;</span>
<span class="s2">    &lt;div style=&quot;margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.75rem;&quot;&gt;</span>
<span class="s2">      &lt;label style=&quot;display:flex;align-items:center;gap:.5rem;&quot;&gt;</span>
<span class="s2">        &lt;input type=&quot;checkbox&quot; id=&quot;agentEnabled&quot;/&gt;</span>
<span class="s2">        Agent enabled</span>
<span class="s2">      &lt;/label&gt;</span>
<span class="s2">      &lt;label&gt;ε (explore): &lt;input id=&quot;eps&quot; type=&quot;range&quot; min=&quot;0&quot; max=&quot;1&quot; step=&quot;0.01&quot; value=&quot;0.10&quot; style=&quot;width:140px;&quot;&gt;</span>
<span class="s2">        &lt;span id=&quot;epsV&quot;&gt;0.10&lt;/span&gt;&lt;/label&gt;</span>
<span class="s2">      &lt;label&gt;α (learn rate): &lt;input id=&quot;alpha&quot; type=&quot;range&quot; min=&quot;0&quot; max=&quot;1&quot; step=&quot;0.01&quot; value=&quot;0.20&quot; style=&quot;width:140px;&quot;&gt;</span>
<span class="s2">        &lt;span id=&quot;alphaV&quot;&gt;0.20&lt;/span&gt;&lt;/label&gt;</span>
<span class="s2">      &lt;label&gt;γ (discount): &lt;input id=&quot;gamma&quot; type=&quot;range&quot; min=&quot;0&quot; max=&quot;1&quot; step=&quot;0.01&quot; value=&quot;0.95&quot; style=&quot;width:140px;&quot;&gt;</span>
<span class="s2">        &lt;span id=&quot;gammaV&quot;&gt;0.95&lt;/span&gt;&lt;/label&gt;</span>
<span class="s2">      &lt;button id=&quot;train1&quot; style=&quot;padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Train 1 episode&lt;/button&gt;</span>
<span class="s2">      &lt;button id=&quot;train50&quot; style=&quot;padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Train 50 episodes&lt;/button&gt;</span>
<span class="s2">      &lt;button id=&quot;resetQ&quot; style=&quot;padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Reset Q-table&lt;/button&gt;</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">    &lt;div style=&quot;margin-top:.5rem;font-size:.95rem;opacity:.9;line-height:1.4;&quot;&gt;</span>
<span class="s2">      &lt;strong&gt;What it shows&lt;/strong&gt;: The agent gets &lt;code&gt;+1&lt;/code&gt; for breaking a brick, &lt;code&gt;+0.01&lt;/code&gt; for paddle hits, &lt;code&gt;-1&lt;/code&gt; for losing a life, and a tiny &lt;code&gt;-0.001&lt;/code&gt; per step.</span>
<span class="s2">      &lt;strong&gt;State&lt;/strong&gt;: binned ball x, paddle x, ball vx sign, ball vy sign.</span>
<span class="s2">      &lt;strong&gt;Actions&lt;/strong&gt;: Left, Stay, Right.</span>
<span class="s2">      ε-greedy Q-learning: &lt;code&gt;Q(s,a) ← Q + α[r + γ max_a&#39; Q(s&#39;,a&#39;) - Q]&lt;/code&gt;.</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">    &lt;div id=&quot;rlStats&quot; style=&quot;margin-top:.5rem;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;&quot;&gt;&lt;/div&gt;</span>
<span class="s2">  &lt;/details&gt;</span>

<span class="s2">  &lt;div style=&quot;margin-top:.75rem;padding-top:.5rem;border-top:1px solid #222;display:flex;align-items:center;gap:.5rem;color:#ddd;&quot;&gt;</span>
<span class="s2">    &lt;label style=&quot;display:flex;align-items:center;gap:.4rem;&quot;&gt;</span>
<span class="s2">      &lt;input type=&quot;checkbox&quot; id=&quot;noMove&quot;/&gt;</span>
<span class="s2">      Don’t move (freeze paddle)</span>
<span class="s2">    &lt;/label&gt;</span>
<span class="s2">    &lt;span style=&quot;opacity:.75;&quot;&gt;When checked, paddle stays still. Useful to show a baseline or to watch the ball.&lt;/span&gt;</span>
<span class="s2">  &lt;/div&gt;</span>
<span class="s2">&lt;/div&gt;</span>

<span class="s2">&lt;script&gt;</span>
<span class="s2">(() =&gt; {</span>
<span class="s2">  const cvs = document.getElementById(&#39;breakout&#39;);</span>
<span class="s2">  const ctx = cvs.getContext(&#39;2d&#39;, { alpha: false });</span>
<span class="s2">  const startBtn = document.getElementById(&#39;bo-start&#39;);</span>
<span class="s2">  const pauseBtn = document.getElementById(&#39;bo-pause&#39;);</span>
<span class="s2">  const resetBtn = document.getElementById(&#39;bo-reset&#39;);</span>
<span class="s2">  const stopAtZero = document.getElementById(&#39;stopAtZero&#39;);</span>
<span class="s2">  const msg = document.getElementById(&#39;bo-msg&#39;);</span>
<span class="s2">  const noMove = document.getElementById(&#39;noMove&#39;);</span>

<span class="s2">  // RL controls</span>
<span class="s2">  const agentEnabledEl = document.getElementById(&#39;agentEnabled&#39;);</span>
<span class="s2">  const epsEl = document.getElementById(&#39;eps&#39;), epsV = document.getElementById(&#39;epsV&#39;);</span>
<span class="s2">  const alphaEl = document.getElementById(&#39;alpha&#39;), alphaV = document.getElementById(&#39;alphaV&#39;);</span>
<span class="s2">  const gammaEl = document.getElementById(&#39;gamma&#39;), gammaV = document.getElementById(&#39;gammaV&#39;);</span>
<span class="s2">  const train1 = document.getElementById(&#39;train1&#39;);</span>
<span class="s2">  const train50 = document.getElementById(&#39;train50&#39;);</span>
<span class="s2">  const resetQ = document.getElementById(&#39;resetQ&#39;);</span>
<span class="s2">  const rlStats = document.getElementById(&#39;rlStats&#39;);</span>

<span class="s2">  epsEl.oninput = ()=&gt; epsV.textContent = Number(epsEl.value).toFixed(2);</span>
<span class="s2">  alphaEl.oninput = ()=&gt; alphaV.textContent = Number(alphaEl.value).toFixed(2);</span>
<span class="s2">  gammaEl.oninput = ()=&gt; gammaV.textContent = Number(gammaEl.value).toFixed(2);</span>
<span class="s2">  epsV.textContent = Number(epsEl.value).toFixed(2);</span>
<span class="s2">  alphaV.textContent = Number(alphaEl.value).toFixed(2);</span>
<span class="s2">  gammaV.textContent = Number(gammaEl.value).toFixed(2);</span>

<span class="s2">  const W = cvs.width, H = cvs.height;</span>
<span class="s2">  const PADDLE_W = 120, PADDLE_H = 14, PADDLE_Y = H - 36, PADDLE_SPEED = 8;</span>
<span class="s2">  const BALL_R = 8, BASE_BALL_SPD = 5.5;</span>
<span class="s2">  const TOP_MARGIN = 64;</span>
<span class="s2">  const ROWS = 7, COLS = 12, GAP = 4, PAD = 16, BRICK_H = 22;</span>
<span class="s2">  const COLORS = [&quot;#ff6b6b&quot;,&quot;#ffd93d&quot;,&quot;#6bcbef&quot;,&quot;#51cf66&quot;,&quot;#845ef7&quot;,&quot;#ffa94d&quot;,&quot;#f06595&quot;];</span>
<span class="s2">  const HUD = {color:&quot;#e6e6e6&quot;};</span>

<span class="s2">  let paddle, ball, bricks, score, lives, level;</span>
<span class="s2">  let running = false, paused = false, rafId = null;</span>

<span class="s2">  // Agent control flags</span>
<span class="s2">  let training = false, abortAgent = false;</span>

<span class="s2">  const keys = {left:false, right:false};</span>

<span class="s2">  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }</span>

<span class="s2">  function initPaddle(){</span>
<span class="s2">    return { x:(W-PADDLE_W)/2, y:PADDLE_Y, w:PADDLE_W, h:PADDLE_H, dx:0 };</span>
<span class="s2">  }</span>

<span class="s2">  function initBall(centerOnP=true){</span>
<span class="s2">    const x = centerOnP ? paddle.x + paddle.w/2 : W/2;</span>
<span class="s2">    const y = centerOnP ? paddle.y - BALL_R - 1 : H/2;</span>
<span class="s2">    const angle = (Math.random()*0.8 - 0.4);</span>
<span class="s2">    const speed = BASE_BALL_SPD * (1 + (level-1)*0.06);</span>
<span class="s2">    return { x, y, r:BALL_R, dx: speed * (Math.random()&lt;.5?-1:1) * Math.abs(angle*1.6),</span>
<span class="s2">             dy: -speed * (1.1 - Math.abs(angle)) };</span>
<span class="s2">  }</span>

<span class="s2">  function makeBricks(){</span>
<span class="s2">    const totalGap = (COLS-1)*GAP;</span>
<span class="s2">    const bw = (W - 2*PAD - totalGap) / COLS;</span>
<span class="s2">    const arr = [];</span>
<span class="s2">    for(let r=0;r&lt;ROWS;r++){</span>
<span class="s2">      for(let c=0;c&lt;COLS;c++){</span>
<span class="s2">        const x = PAD + c*(bw + GAP);</span>
<span class="s2">        const y = TOP_MARGIN + r*(BRICK_H + GAP);</span>
<span class="s2">        const hits = 1;</span>
<span class="s2">        arr.push({x,y,w:bw,h:BRICK_H,color:COLORS[r%COLORS.length],hits,score:60+10*r, alive:true});</span>
<span class="s2">      }</span>
<span class="s2">    }</span>
<span class="s2">    return arr;</span>
<span class="s2">  }</span>

<span class="s2">  function resetGame(){</span>
<span class="s2">    score = 0; lives = 3; level = 1;</span>
<span class="s2">    paddle = initPaddle();</span>
<span class="s2">    bricks = makeBricks();</span>
<span class="s2">    ball = initBall();</span>
<span class="s2">    paused = false; running = false;</span>
<span class="s2">    msg.textContent = &quot;Press Start or hit P to play. Click the canvas to focus.&quot;;</span>
<span class="s2">    draw();</span>
<span class="s2">  }</span>

<span class="s2">  function nextLevel(){</span>
<span class="s2">    level++;</span>
<span class="s2">    bricks = makeBricks();</span>
<span class="s2">    ball = initBall(true);</span>
<span class="s2">    msg.textContent = &quot;Level &quot; + level;</span>
<span class="s2">    setTimeout(()=&gt;{ if(msg.textContent.startsWith(&quot;Level&quot;)) msg.textContent=&quot;&quot;; }, 700);</span>
<span class="s2">  }</span>

<span class="s2">  function rectsIntersect(a, b){</span>
<span class="s2">    return a.x &lt; b.x+b.w &amp;&amp; a.x+a.w &gt; b.x &amp;&amp; a.y &lt; b.y+b.h &amp;&amp; a.y+a.h &gt; b.y;</span>
<span class="s2">  }</span>

<span class="s2">  function drawHUD(){</span>
<span class="s2">    ctx.fillStyle = HUD.color;</span>
<span class="s2">    ctx.font = &quot;16px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial&quot;;</span>
<span class="s2">    ctx.textBaseline = &quot;top&quot;;</span>
<span class="s2">    ctx.fillText(`Score: $</span><span class="si">{score}</span><span class="s2">`, 10, 10);</span>
<span class="s2">    ctx.fillText(`Lives: $</span><span class="si">{lives}</span><span class="s2">`, 10, 30);</span>
<span class="s2">    ctx.fillText(`Level: $</span><span class="si">{level}</span><span class="s2">`, 10, 50);</span>
<span class="s2">    ctx.strokeStyle = &quot;#263238&quot;;</span>
<span class="s2">    ctx.beginPath(); ctx.moveTo(0, TOP_MARGIN); ctx.lineTo(W, TOP_MARGIN); ctx.stroke();</span>
<span class="s2">  }</span>

<span class="s2">  function draw(){</span>
<span class="s2">    ctx.fillStyle = &quot;#0b1021&quot;;</span>
<span class="s2">    ctx.fillRect(0,0,W,H);</span>
<span class="s2">    // Paddle</span>
<span class="s2">    ctx.fillStyle = &quot;#e6e6e6&quot;;</span>
<span class="s2">    ctx.fillRect(paddle.x, paddle.y, paddle.w, paddle.h);</span>
<span class="s2">    // Ball</span>
<span class="s2">    ctx.fillStyle = &quot;#ffdd57&quot;;</span>
<span class="s2">    ctx.beginPath();</span>
<span class="s2">    ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);</span>
<span class="s2">    ctx.fill();</span>
<span class="s2">    // Bricks</span>
<span class="s2">    for(const b of bricks){</span>
<span class="s2">      if(!b.alive) continue;</span>
<span class="s2">      ctx.fillStyle = b.color;</span>
<span class="s2">      ctx.fillRect(b.x, b.y, b.w, b.h);</span>
<span class="s2">    }</span>
<span class="s2">    drawHUD();</span>
<span class="s2">  }</span>

<span class="s2">  // ---------- RL bits ----------</span>
<span class="s2">  const A_LEFT = 0, A_STAY = 1, A_RIGHT = 2;</span>
<span class="s2">  const ACTIONS = [A_LEFT, A_STAY, A_RIGHT];</span>
<span class="s2">  let Q = new Map(); // key -&gt; Float32Array(3)</span>

<span class="s2">  function qGet(key){</span>
<span class="s2">    if(!Q.has(key)) Q.set(key, new Float32Array(3)); // zeros</span>
<span class="s2">    return Q.get(key);</span>
<span class="s2">  }</span>
<span class="s2">  function argmax(arr){ let mi=0, mv=arr[0]; for(let i=1;i&lt;arr.length;i++){ if(arr[i]&gt;mv){mv=arr[i];mi=i;} } return mi; }</span>

<span class="s2">  // Discretize state</span>
<span class="s2">  const BX_BINS = 12, PX_BINS = 12;</span>
<span class="s2">  function stateKey(){</span>
<span class="s2">    const bx = Math.floor(clamp(ball.x,0,W-1) / (W/BX_BINS));</span>
<span class="s2">    const px = Math.floor(clamp(paddle.x,0,W-paddle.w) / ((W-paddle.w)/PX_BINS));</span>
<span class="s2">    const vx = ball.dx &gt; 0 ? 1 : (ball.dx &lt; 0 ? -1 : 0);</span>
<span class="s2">    const vy = ball.dy &gt; 0 ? 1 : -1;</span>
<span class="s2">    return `$</span><span class="si">{bx}</span><span class="s2">|$</span><span class="si">{px}</span><span class="s2">|$</span><span class="si">{vx}</span><span class="s2">|$</span><span class="si">{vy}</span><span class="s2">`;</span>
<span class="s2">  }</span>

<span class="s2">  function agentAct(eps){</span>
<span class="s2">    if(Math.random() &lt; eps) return ACTIONS[Math.floor(Math.random()*ACTIONS.length)];</span>
<span class="s2">    const q = qGet(stateKey());</span>
<span class="s2">    return argmax(q);</span>
<span class="s2">  }</span>

<span class="s2">  function applyAction(a){</span>
<span class="s2">    if(a === A_LEFT) { keys.left = true; keys.right = false; }</span>
<span class="s2">    else if(a === A_RIGHT) { keys.right = true; keys.left = false; }</span>
<span class="s2">    else { keys.left = false; keys.right = false; } // A_STAY</span>
<span class="s2">  }</span>

<span class="s2">  function stepReward({hitBrick=false, hitPaddle=false, lostLife=false}){</span>
<span class="s2">    let r = -0.001;</span>
<span class="s2">    if(hitBrick) r += 1.0;</span>
<span class="s2">    if(hitPaddle) r += 0.01;</span>
<span class="s2">    if(lostLife) r -= 1;</span>
<span class="s2">    return r;</span>
<span class="s2">  }</span>

<span class="s2">  let epReward = 0, epSteps = 0, episodesDone = 0;</span>

<span class="s2">  // Helper to stop the agent cleanly</span>
<span class="s2">  function stopAgent(reason = &quot;&quot;){</span>
<span class="s2">    abortAgent = true;</span>
<span class="s2">    training = false;</span>
<span class="s2">    agentEnabledEl.checked = false;</span>
<span class="s2">    msg.textContent = reason || &quot;Agent stopped.&quot;;</span>
<span class="s2">  }</span>

<span class="s2">  // ---------- Game update ----------</span>
<span class="s2">  function update(){</span>
<span class="s2">    // Freeze mode overrides everything</span>
<span class="s2">    if(noMove.checked){</span>
<span class="s2">      keys.left = false;</span>
<span class="s2">      keys.right = false;</span>
<span class="s2">    }</span>

<span class="s2">    // Choose action if agent enabled and not frozen</span>
<span class="s2">    const agentOn = agentEnabledEl?.checked &amp;&amp; !noMove.checked;</span>
<span class="s2">    let prevKey, a, qArr;</span>
<span class="s2">    if(agentOn){</span>
<span class="s2">      prevKey = stateKey();</span>
<span class="s2">      a = agentAct(Number(epsEl.value));</span>
<span class="s2">      qArr = qGet(prevKey);</span>
<span class="s2">      applyAction(a);</span>
<span class="s2">    }</span>

<span class="s2">    // Paddle control</span>
<span class="s2">    paddle.dx = (keys.left?-PADDLE_SPEED:0) + (keys.right?PADDLE_SPEED:0);</span>
<span class="s2">    if(noMove.checked) paddle.dx = 0;</span>
<span class="s2">    paddle.x += paddle.dx;</span>
<span class="s2">    paddle.x = clamp(paddle.x, 0, W - paddle.w);</span>

<span class="s2">    // Move ball</span>
<span class="s2">    ball.x += ball.dx;</span>
<span class="s2">    ball.y += ball.dy;</span>

<span class="s2">    // Walls</span>
<span class="s2">    if(ball.x - ball.r &lt;= 0){ ball.x = ball.r; ball.dx *= -1; }</span>
<span class="s2">    if(ball.x + ball.r &gt;= W){ ball.x = W - ball.r; ball.dx *= -1; }</span>
<span class="s2">    if(ball.y - ball.r &lt;= TOP_MARGIN){ ball.y = TOP_MARGIN + ball.r; ball.dy *= -1; }</span>

<span class="s2">    // Collisions</span>
<span class="s2">    let hitPaddle = false, hitBrick = false, lostLife = false;</span>

<span class="s2">    // Paddle hit</span>
<span class="s2">    const pRect = {x:paddle.x,y:paddle.y,w:paddle.w,h:paddle.h};</span>
<span class="s2">    const bRect = {x:ball.x-ball.r,y:ball.y-ball.r,w:ball.r*2,h:ball.r*2};</span>
<span class="s2">    if(rectsIntersect(pRect, bRect) &amp;&amp; ball.dy &gt; 0){</span>
<span class="s2">      hitPaddle = true;</span>
<span class="s2">      const hitPos = (ball.x - paddle.x) / paddle.w;</span>
<span class="s2">      const angle = (hitPos - 0.5) * 1.2;</span>
<span class="s2">      const speed = Math.hypot(ball.dx, ball.dy) || (BASE_BALL_SPD*(1+(level-1)*0.06));</span>
<span class="s2">      ball.dx = speed * angle * 1.6;</span>
<span class="s2">      ball.dy = -Math.abs(speed * (1.0 - Math.abs(angle)));</span>
<span class="s2">      ball.y = paddle.y - ball.r - 0.01;</span>
<span class="s2">    }</span>

<span class="s2">    // Brick hits</span>
<span class="s2">    for(let i=0;i&lt;bricks.length;i++){</span>
<span class="s2">      const b = bricks[i];</span>
<span class="s2">      if(!b.alive) continue;</span>
<span class="s2">      const br = {x:b.x,y:b.y,w:b.w,h:b.h};</span>
<span class="s2">      if(rectsIntersect(br, {x:ball.x-ball.r,y:ball.y-ball.r,w:ball.r*2,h:ball.r*2})){</span>
<span class="s2">        const overlapLeft = (ball.x + ball.r) - b.x;</span>
<span class="s2">        const overlapRight = (b.x + b.w) - (ball.x - ball.r);</span>
<span class="s2">        const overlapTop = (ball.y + ball.r) - b.y;</span>
<span class="s2">        const overlapBottom = (b.y + b.h) - (ball.y - ball.r);</span>
<span class="s2">        const minOv = Math.min(overlapLeft, overlapRight, overlapTop, overlapBottom);</span>
<span class="s2">        if(minOv === overlapLeft || minOv === overlapRight) ball.dx *= -1; else ball.dy *= -1;</span>

<span class="s2">        b.hits -= 1;</span>
<span class="s2">        if(b.hits &lt;= 0){ b.alive = false; score += b.score; hitBrick = true; }</span>
<span class="s2">        break;</span>
<span class="s2">      }</span>
<span class="s2">    }</span>

<span class="s2">    // Lose life</span>
<span class="s2">    if(ball.y - ball.r &gt; H){</span>
<span class="s2">      lives -= 1;</span>
<span class="s2">      lostLife = true;</span>
<span class="s2">      ball = initBall(true);</span>
<span class="s2">      msg.textContent = &quot;Life lost.&quot;;</span>
<span class="s2">      setTimeout(()=&gt;{ if(msg.textContent === &quot;Life lost.&quot;) msg.textContent=&quot;&quot;; }, 500);</span>
<span class="s2">      if(lives &lt;= 0 &amp;&amp; stopAtZero.checked){</span>
<span class="s2">        running = false;</span>
<span class="s2">        msg.textContent = &quot;Game over. Press Reset or R.&quot;;</span>
<span class="s2">      }</span>
<span class="s2">    }</span>

<span class="s2">    // Next level</span>
<span class="s2">    if(bricks.every(b =&gt; !b.alive)){</span>
<span class="s2">      nextLevel();</span>
<span class="s2">    }</span>

<span class="s2">    // RL update</span>
<span class="s2">    if(agentEnabledEl?.checked &amp;&amp; !noMove.checked){</span>
<span class="s2">      const r = stepReward({hitBrick, hitPaddle, lostLife});</span>
<span class="s2">      const nextKey = stateKey();</span>
<span class="s2">      const qNext = qGet(nextKey);</span>
<span class="s2">      const tdTarget = r + Number(gammaEl.value) * Math.max(qNext[0], qNext[1], qNext[2]);</span>
<span class="s2">      const aIdx = typeof a === &quot;number&quot; ? a : 1;</span>
<span class="s2">      qArr[aIdx] = qArr[aIdx] + Number(alphaEl.value) * (tdTarget - qArr[aIdx]);</span>
<span class="s2">      epReward += r;</span>
<span class="s2">      epSteps += 1;</span>
<span class="s2">    }</span>
<span class="s2">  }</span>

<span class="s2">  function loop(){</span>
<span class="s2">    if(!running || paused){</span>
<span class="s2">      draw();</span>
<span class="s2">    } else {</span>
<span class="s2">      update();</span>
<span class="s2">      draw();</span>
<span class="s2">    }</span>
<span class="s2">    rafId = requestAnimationFrame(loop);</span>
<span class="s2">  }</span>

<span class="s2">  // Input: handle pause and reset even when agent is enabled</span>
<span class="s2">  function setKey(e, isDown){</span>
<span class="s2">    const key = e.key || e.code;</span>

<span class="s2">    // Always allow pause and reset</span>
<span class="s2">    if(isDown){</span>
<span class="s2">      if(key === &quot;p&quot; || key === &quot;P&quot;){</span>
<span class="s2">        paused = !paused;</span>
<span class="s2">        msg.textContent = paused ? &quot;Paused&quot; : &quot;&quot;;</span>
<span class="s2">      }</span>
<span class="s2">      if(key === &quot;r&quot; || key === &quot;R&quot;){</span>
<span class="s2">        if(training || agentEnabledEl.checked) stopAgent(&quot;Reset&quot;);</span>
<span class="s2">        resetGame();</span>
<span class="s2">      }</span>
<span class="s2">    }</span>

<span class="s2">    // Block manual movement while agent is enabled or frozen</span>
<span class="s2">    const blockMovement = agentEnabledEl?.checked || noMove.checked;</span>

<span class="s2">    if(!blockMovement){</span>
<span class="s2">      if(key === &quot;ArrowLeft&quot; || key === &quot;Left&quot; || key === &quot;a&quot; || key === &quot;A&quot;){ keys.left = isDown; e.preventDefault(); }</span>
<span class="s2">      if(key === &quot;ArrowRight&quot; || key === &quot;Right&quot; || key === &quot;d&quot; || key === &quot;D&quot;){ keys.right = isDown; e.preventDefault(); }</span>
<span class="s2">    }</span>
<span class="s2">  }</span>

<span class="s2">  cvs.tabIndex = 0;</span>
<span class="s2">  cvs.addEventListener(&#39;keydown&#39;, (e)=&gt;setKey(e, true));</span>
<span class="s2">  cvs.addEventListener(&#39;keyup&#39;,   (e)=&gt;setKey(e, false));</span>
<span class="s2">  cvs.addEventListener(&#39;mousedown&#39;, ()=&gt;{ cvs.focus(); });</span>

<span class="s2">  // Buttons</span>
<span class="s2">  startBtn.onclick = () =&gt; {</span>
<span class="s2">    running = true; paused = false; msg.textContent = &quot;&quot;; cvs.focus();</span>
<span class="s2">  };</span>

<span class="s2">  pauseBtn.onclick = () =&gt; {</span>
<span class="s2">    if(running){</span>
<span class="s2">      paused = !paused;</span>
<span class="s2">      msg.textContent = paused ? &quot;Paused&quot; : &quot;&quot;;</span>
<span class="s2">      cvs.focus();</span>
<span class="s2">    }</span>
<span class="s2">  };</span>

<span class="s2">  resetBtn.onclick = () =&gt; {</span>
<span class="s2">    if(training || agentEnabledEl.checked) stopAgent(&quot;Reset&quot;);</span>
<span class="s2">    resetGame();</span>
<span class="s2">    cvs.focus();</span>
<span class="s2">  };</span>

<span class="s2">  // Abort training if user disables the agent</span>
<span class="s2">  agentEnabledEl.addEventListener(&#39;change&#39;, ()=&gt;{</span>
<span class="s2">    if(!agentEnabledEl.checked &amp;&amp; training){</span>
<span class="s2">      stopAgent(&quot;Agent disabled&quot;);</span>
<span class="s2">    }</span>
<span class="s2">  });</span>

<span class="s2">  document.addEventListener(&#39;keydown&#39;, (e)=&gt;{ if(document.activeElement===cvs) setKey(e, true); });</span>
<span class="s2">  document.addEventListener(&#39;keyup&#39;,   (e)=&gt;{ if(document.activeElement===cvs) setKey(e, false); });</span>

<span class="s2">  // RL helpers</span>
<span class="s2">  function resetQTable(){ Q = new Map(); }</span>

<span class="s2">  function runEpisode(maxSteps=4000){</span>
<span class="s2">    const prevAgent = agentEnabledEl.checked;</span>
<span class="s2">    const prevFreeze = noMove.checked;</span>
<span class="s2">    agentEnabledEl.checked = true;</span>
<span class="s2">    noMove.checked = false;</span>
<span class="s2">    epReward = 0; epSteps = 0;</span>

<span class="s2">    if(!running){ resetGame(); running = true; paused = false; }</span>
<span class="s2">    const targetZero = stopAtZero.checked;</span>
<span class="s2">    stopAtZero.checked = true;</span>

<span class="s2">    let steps = 0;</span>
<span class="s2">    abortAgent = false;</span>
<span class="s2">    training = true;</span>

<span class="s2">    return new Promise(resolve=&gt;{</span>
<span class="s2">      function cleanup(){</span>
<span class="s2">        running = false;</span>
<span class="s2">        paused = false;</span>
<span class="s2">        stopAtZero.checked = targetZero;</span>
<span class="s2">        agentEnabledEl.checked = prevAgent &amp;&amp; !abortAgent;</span>
<span class="s2">        noMove.checked = prevFreeze;</span>
<span class="s2">        episodesDone += 1;</span>
<span class="s2">        rlStats.textContent = `Episodes: $</span><span class="si">{episodesDone}</span><span class="s2"> | Steps: $</span><span class="si">{epSteps}</span><span class="s2"> | Return: ${epReward.toFixed(2)} | Q-states: $</span><span class="si">{Q.size}</span><span class="s2">`;</span>
<span class="s2">        training = false;</span>
<span class="s2">      }</span>

<span class="s2">      function tick(){</span>
<span class="s2">        if(abortAgent){</span>
<span class="s2">          cleanup();</span>
<span class="s2">          resolve();</span>
<span class="s2">          return;</span>
<span class="s2">        }</span>
<span class="s2">        if(paused){</span>
<span class="s2">          requestAnimationFrame(tick);</span>
<span class="s2">          return;</span>
<span class="s2">        }</span>
<span class="s2">        if(steps &gt;= maxSteps || lives &lt;= 0){</span>
<span class="s2">          cleanup();</span>
<span class="s2">          resolve();</span>
<span class="s2">          return;</span>
<span class="s2">        }</span>
<span class="s2">        update();</span>
<span class="s2">        steps++;</span>
<span class="s2">        requestAnimationFrame(tick);</span>
<span class="s2">      }</span>
<span class="s2">      requestAnimationFrame(tick);</span>
<span class="s2">    });</span>
<span class="s2">  }</span>

<span class="s2">  train1.onclick = async ()=&gt;{ await runEpisode(3000); };</span>
<span class="s2">  train50.onclick = async ()=&gt;{</span>
<span class="s2">    for(let i=0;i&lt;50;i++){</span>
<span class="s2">      if(abortAgent) break;</span>
<span class="s2">      await runEpisode(3000);</span>
<span class="s2">    }</span>
<span class="s2">  };</span>
<span class="s2">  resetQ.onclick = ()=&gt;{ resetQTable(); rlStats.textContent = &quot;Q-table cleared.&quot;; };</span>

<span class="s2">  // Init</span>
<span class="s2">  resetGame();</span>
<span class="s2">  cancelAnimationFrame(rafId);</span>
<span class="s2">  loop();</span>
<span class="s2">})();</span>
<span class="s2">&lt;/script&gt;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html">
<div id="breakout-container" style="font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 1rem 0;">
  <div style="display:flex;flex-wrap:wrap;align-items:center;gap:.5rem;margin-bottom:.5rem;">
    <button id="bo-start" style="padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Start</button>
    <button id="bo-pause" style="padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Pause</button>
    <button id="bo-reset" style="padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Reset</button>
    <label style="margin-left:1rem;display:flex;align-items:center;gap:.35rem;color:#ddd;">
      <input type="checkbox" id="stopAtZero" />
      Stop at 0 lives
    </label>
    <span style="opacity:.85;">Controls: ←/→ or A/D, P pause, R reset</span>
  </div>

  <canvas id="breakout" width="800" height="560" style="max-width:100%;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);background:#0b1021;display:block;outline:none;"></canvas>

  <div id="bo-msg" style="margin-top:.5rem;color:#ddd;opacity:.9;">Click the canvas to focus.</div>

  <details style="margin-top:1rem;background:#0f1329;border:1px solid #222;border-radius:10px;padding:.75rem;color:#e6e6e6;">
    <summary style="cursor:pointer;font-weight:600;">Reinforcement Learning demo</summary>
    <div style="margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.75rem;">
      <label style="display:flex;align-items:center;gap:.5rem;">
        <input type="checkbox" id="agentEnabled"/>
        Agent enabled
      </label>
      <label>ε (explore): <input id="eps" type="range" min="0" max="1" step="0.01" value="0.10" style="width:140px;">
        <span id="epsV">0.10</span></label>
      <label>α (learn rate): <input id="alpha" type="range" min="0" max="1" step="0.01" value="0.20" style="width:140px;">
        <span id="alphaV">0.20</span></label>
      <label>γ (discount): <input id="gamma" type="range" min="0" max="1" step="0.01" value="0.95" style="width:140px;">
        <span id="gammaV">0.95</span></label>
      <button id="train1" style="padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Train 1 episode</button>
      <button id="train50" style="padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Train 50 episodes</button>
      <button id="resetQ" style="padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Reset Q-table</button>
    </div>
    <div style="margin-top:.5rem;font-size:.95rem;opacity:.9;line-height:1.4;">
      <strong>What it shows</strong>: The agent gets <code>+1</code> for breaking a brick, <code>+0.01</code> for paddle hits, <code>-1</code> for losing a life, and a tiny <code>-0.001</code> per step.
      <strong>State</strong>: binned ball x, paddle x, ball vx sign, ball vy sign.
      <strong>Actions</strong>: Left, Stay, Right.
      ε-greedy Q-learning: <code>Q(s,a) ← Q + α[r + γ max_a' Q(s',a') - Q]</code>.
    </div>
    <div id="rlStats" style="margin-top:.5rem;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;"></div>
  </details>

  <div style="margin-top:.75rem;padding-top:.5rem;border-top:1px solid #222;display:flex;align-items:center;gap:.5rem;color:#ddd;">
    <label style="display:flex;align-items:center;gap:.4rem;">
      <input type="checkbox" id="noMove"/>
      Don’t move (freeze paddle)
    </label>
    <span style="opacity:.75;">When checked, paddle stays still. Useful to show a baseline or to watch the ball.</span>
  </div>
</div>

<script>
(() => {
  const cvs = document.getElementById('breakout');
  const ctx = cvs.getContext('2d', { alpha: false });
  const startBtn = document.getElementById('bo-start');
  const pauseBtn = document.getElementById('bo-pause');
  const resetBtn = document.getElementById('bo-reset');
  const stopAtZero = document.getElementById('stopAtZero');
  const msg = document.getElementById('bo-msg');
  const noMove = document.getElementById('noMove');

  // RL controls
  const agentEnabledEl = document.getElementById('agentEnabled');
  const epsEl = document.getElementById('eps'), epsV = document.getElementById('epsV');
  const alphaEl = document.getElementById('alpha'), alphaV = document.getElementById('alphaV');
  const gammaEl = document.getElementById('gamma'), gammaV = document.getElementById('gammaV');
  const train1 = document.getElementById('train1');
  const train50 = document.getElementById('train50');
  const resetQ = document.getElementById('resetQ');
  const rlStats = document.getElementById('rlStats');

  epsEl.oninput = ()=> epsV.textContent = Number(epsEl.value).toFixed(2);
  alphaEl.oninput = ()=> alphaV.textContent = Number(alphaEl.value).toFixed(2);
  gammaEl.oninput = ()=> gammaV.textContent = Number(gammaEl.value).toFixed(2);
  epsV.textContent = Number(epsEl.value).toFixed(2);
  alphaV.textContent = Number(alphaEl.value).toFixed(2);
  gammaV.textContent = Number(gammaEl.value).toFixed(2);

  const W = cvs.width, H = cvs.height;
  const PADDLE_W = 120, PADDLE_H = 14, PADDLE_Y = H - 36, PADDLE_SPEED = 8;
  const BALL_R = 8, BASE_BALL_SPD = 5.5;
  const TOP_MARGIN = 64;
  const ROWS = 7, COLS = 12, GAP = 4, PAD = 16, BRICK_H = 22;
  const COLORS = ["#ff6b6b","#ffd93d","#6bcbef","#51cf66","#845ef7","#ffa94d","#f06595"];
  const HUD = {color:"#e6e6e6"};

  let paddle, ball, bricks, score, lives, level;
  let running = false, paused = false, rafId = null;

  // Agent control flags
  let training = false, abortAgent = false;

  const keys = {left:false, right:false};

  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

  function initPaddle(){
    return { x:(W-PADDLE_W)/2, y:PADDLE_Y, w:PADDLE_W, h:PADDLE_H, dx:0 };
  }

  function initBall(centerOnP=true){
    const x = centerOnP ? paddle.x + paddle.w/2 : W/2;
    const y = centerOnP ? paddle.y - BALL_R - 1 : H/2;
    const angle = (Math.random()*0.8 - 0.4);
    const speed = BASE_BALL_SPD * (1 + (level-1)*0.06);
    return { x, y, r:BALL_R, dx: speed * (Math.random()<.5?-1:1) * Math.abs(angle*1.6),
             dy: -speed * (1.1 - Math.abs(angle)) };
  }

  function makeBricks(){
    const totalGap = (COLS-1)*GAP;
    const bw = (W - 2*PAD - totalGap) / COLS;
    const arr = [];
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const x = PAD + c*(bw + GAP);
        const y = TOP_MARGIN + r*(BRICK_H + GAP);
        const hits = 1;
        arr.push({x,y,w:bw,h:BRICK_H,color:COLORS[r%COLORS.length],hits,score:60+10*r, alive:true});
      }
    }
    return arr;
  }

  function resetGame(){
    score = 0; lives = 3; level = 1;
    paddle = initPaddle();
    bricks = makeBricks();
    ball = initBall();
    paused = false; running = false;
    msg.textContent = "Press Start or hit P to play. Click the canvas to focus.";
    draw();
  }

  function nextLevel(){
    level++;
    bricks = makeBricks();
    ball = initBall(true);
    msg.textContent = "Level " + level;
    setTimeout(()=>{ if(msg.textContent.startsWith("Level")) msg.textContent=""; }, 700);
  }

  function rectsIntersect(a, b){
    return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
  }

  function drawHUD(){
    ctx.fillStyle = HUD.color;
    ctx.font = "16px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.textBaseline = "top";
    ctx.fillText(`Score: ${score}`, 10, 10);
    ctx.fillText(`Lives: ${lives}`, 10, 30);
    ctx.fillText(`Level: ${level}`, 10, 50);
    ctx.strokeStyle = "#263238";
    ctx.beginPath(); ctx.moveTo(0, TOP_MARGIN); ctx.lineTo(W, TOP_MARGIN); ctx.stroke();
  }

  function draw(){
    ctx.fillStyle = "#0b1021";
    ctx.fillRect(0,0,W,H);
    // Paddle
    ctx.fillStyle = "#e6e6e6";
    ctx.fillRect(paddle.x, paddle.y, paddle.w, paddle.h);
    // Ball
    ctx.fillStyle = "#ffdd57";
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
    ctx.fill();
    // Bricks
    for(const b of bricks){
      if(!b.alive) continue;
      ctx.fillStyle = b.color;
      ctx.fillRect(b.x, b.y, b.w, b.h);
    }
    drawHUD();
  }

  // ---------- RL bits ----------
  const A_LEFT = 0, A_STAY = 1, A_RIGHT = 2;
  const ACTIONS = [A_LEFT, A_STAY, A_RIGHT];
  let Q = new Map(); // key -> Float32Array(3)

  function qGet(key){
    if(!Q.has(key)) Q.set(key, new Float32Array(3)); // zeros
    return Q.get(key);
  }
  function argmax(arr){ let mi=0, mv=arr[0]; for(let i=1;i<arr.length;i++){ if(arr[i]>mv){mv=arr[i];mi=i;} } return mi; }

  // Discretize state
  const BX_BINS = 12, PX_BINS = 12;
  function stateKey(){
    const bx = Math.floor(clamp(ball.x,0,W-1) / (W/BX_BINS));
    const px = Math.floor(clamp(paddle.x,0,W-paddle.w) / ((W-paddle.w)/PX_BINS));
    const vx = ball.dx > 0 ? 1 : (ball.dx < 0 ? -1 : 0);
    const vy = ball.dy > 0 ? 1 : -1;
    return `${bx}|${px}|${vx}|${vy}`;
  }

  function agentAct(eps){
    if(Math.random() < eps) return ACTIONS[Math.floor(Math.random()*ACTIONS.length)];
    const q = qGet(stateKey());
    return argmax(q);
  }

  function applyAction(a){
    if(a === A_LEFT) { keys.left = true; keys.right = false; }
    else if(a === A_RIGHT) { keys.right = true; keys.left = false; }
    else { keys.left = false; keys.right = false; } // A_STAY
  }

  function stepReward({hitBrick=false, hitPaddle=false, lostLife=false}){
    let r = -0.001;
    if(hitBrick) r += 1.0;
    if(hitPaddle) r += 0.01;
    if(lostLife) r -= 1;
    return r;
  }

  let epReward = 0, epSteps = 0, episodesDone = 0;

  // Helper to stop the agent cleanly
  function stopAgent(reason = ""){
    abortAgent = true;
    training = false;
    agentEnabledEl.checked = false;
    msg.textContent = reason || "Agent stopped.";
  }

  // ---------- Game update ----------
  function update(){
    // Freeze mode overrides everything
    if(noMove.checked){
      keys.left = false;
      keys.right = false;
    }

    // Choose action if agent enabled and not frozen
    const agentOn = agentEnabledEl?.checked && !noMove.checked;
    let prevKey, a, qArr;
    if(agentOn){
      prevKey = stateKey();
      a = agentAct(Number(epsEl.value));
      qArr = qGet(prevKey);
      applyAction(a);
    }

    // Paddle control
    paddle.dx = (keys.left?-PADDLE_SPEED:0) + (keys.right?PADDLE_SPEED:0);
    if(noMove.checked) paddle.dx = 0;
    paddle.x += paddle.dx;
    paddle.x = clamp(paddle.x, 0, W - paddle.w);

    // Move ball
    ball.x += ball.dx;
    ball.y += ball.dy;

    // Walls
    if(ball.x - ball.r <= 0){ ball.x = ball.r; ball.dx *= -1; }
    if(ball.x + ball.r >= W){ ball.x = W - ball.r; ball.dx *= -1; }
    if(ball.y - ball.r <= TOP_MARGIN){ ball.y = TOP_MARGIN + ball.r; ball.dy *= -1; }

    // Collisions
    let hitPaddle = false, hitBrick = false, lostLife = false;

    // Paddle hit
    const pRect = {x:paddle.x,y:paddle.y,w:paddle.w,h:paddle.h};
    const bRect = {x:ball.x-ball.r,y:ball.y-ball.r,w:ball.r*2,h:ball.r*2};
    if(rectsIntersect(pRect, bRect) && ball.dy > 0){
      hitPaddle = true;
      const hitPos = (ball.x - paddle.x) / paddle.w;
      const angle = (hitPos - 0.5) * 1.2;
      const speed = Math.hypot(ball.dx, ball.dy) || (BASE_BALL_SPD*(1+(level-1)*0.06));
      ball.dx = speed * angle * 1.6;
      ball.dy = -Math.abs(speed * (1.0 - Math.abs(angle)));
      ball.y = paddle.y - ball.r - 0.01;
    }

    // Brick hits
    for(let i=0;i<bricks.length;i++){
      const b = bricks[i];
      if(!b.alive) continue;
      const br = {x:b.x,y:b.y,w:b.w,h:b.h};
      if(rectsIntersect(br, {x:ball.x-ball.r,y:ball.y-ball.r,w:ball.r*2,h:ball.r*2})){
        const overlapLeft = (ball.x + ball.r) - b.x;
        const overlapRight = (b.x + b.w) - (ball.x - ball.r);
        const overlapTop = (ball.y + ball.r) - b.y;
        const overlapBottom = (b.y + b.h) - (ball.y - ball.r);
        const minOv = Math.min(overlapLeft, overlapRight, overlapTop, overlapBottom);
        if(minOv === overlapLeft || minOv === overlapRight) ball.dx *= -1; else ball.dy *= -1;

        b.hits -= 1;
        if(b.hits <= 0){ b.alive = false; score += b.score; hitBrick = true; }
        break;
      }
    }

    // Lose life
    if(ball.y - ball.r > H){
      lives -= 1;
      lostLife = true;
      ball = initBall(true);
      msg.textContent = "Life lost.";
      setTimeout(()=>{ if(msg.textContent === "Life lost.") msg.textContent=""; }, 500);
      if(lives <= 0 && stopAtZero.checked){
        running = false;
        msg.textContent = "Game over. Press Reset or R.";
      }
    }

    // Next level
    if(bricks.every(b => !b.alive)){
      nextLevel();
    }

    // RL update
    if(agentEnabledEl?.checked && !noMove.checked){
      const r = stepReward({hitBrick, hitPaddle, lostLife});
      const nextKey = stateKey();
      const qNext = qGet(nextKey);
      const tdTarget = r + Number(gammaEl.value) * Math.max(qNext[0], qNext[1], qNext[2]);
      const aIdx = typeof a === "number" ? a : 1;
      qArr[aIdx] = qArr[aIdx] + Number(alphaEl.value) * (tdTarget - qArr[aIdx]);
      epReward += r;
      epSteps += 1;
    }
  }

  function loop(){
    if(!running || paused){
      draw();
    } else {
      update();
      draw();
    }
    rafId = requestAnimationFrame(loop);
  }

  // Input: handle pause and reset even when agent is enabled
  function setKey(e, isDown){
    const key = e.key || e.code;

    // Always allow pause and reset
    if(isDown){
      if(key === "p" || key === "P"){
        paused = !paused;
        msg.textContent = paused ? "Paused" : "";
      }
      if(key === "r" || key === "R"){
        if(training || agentEnabledEl.checked) stopAgent("Reset");
        resetGame();
      }
    }

    // Block manual movement while agent is enabled or frozen
    const blockMovement = agentEnabledEl?.checked || noMove.checked;

    if(!blockMovement){
      if(key === "ArrowLeft" || key === "Left" || key === "a" || key === "A"){ keys.left = isDown; e.preventDefault(); }
      if(key === "ArrowRight" || key === "Right" || key === "d" || key === "D"){ keys.right = isDown; e.preventDefault(); }
    }
  }

  cvs.tabIndex = 0;
  cvs.addEventListener('keydown', (e)=>setKey(e, true));
  cvs.addEventListener('keyup',   (e)=>setKey(e, false));
  cvs.addEventListener('mousedown', ()=>{ cvs.focus(); });

  // Buttons
  startBtn.onclick = () => {
    running = true; paused = false; msg.textContent = ""; cvs.focus();
  };

  pauseBtn.onclick = () => {
    if(running){
      paused = !paused;
      msg.textContent = paused ? "Paused" : "";
      cvs.focus();
    }
  };

  resetBtn.onclick = () => {
    if(training || agentEnabledEl.checked) stopAgent("Reset");
    resetGame();
    cvs.focus();
  };

  // Abort training if user disables the agent
  agentEnabledEl.addEventListener('change', ()=>{
    if(!agentEnabledEl.checked && training){
      stopAgent("Agent disabled");
    }
  });

  document.addEventListener('keydown', (e)=>{ if(document.activeElement===cvs) setKey(e, true); });
  document.addEventListener('keyup',   (e)=>{ if(document.activeElement===cvs) setKey(e, false); });

  // RL helpers
  function resetQTable(){ Q = new Map(); }

  function runEpisode(maxSteps=4000){
    const prevAgent = agentEnabledEl.checked;
    const prevFreeze = noMove.checked;
    agentEnabledEl.checked = true;
    noMove.checked = false;
    epReward = 0; epSteps = 0;

    if(!running){ resetGame(); running = true; paused = false; }
    const targetZero = stopAtZero.checked;
    stopAtZero.checked = true;

    let steps = 0;
    abortAgent = false;
    training = true;

    return new Promise(resolve=>{
      function cleanup(){
        running = false;
        paused = false;
        stopAtZero.checked = targetZero;
        agentEnabledEl.checked = prevAgent && !abortAgent;
        noMove.checked = prevFreeze;
        episodesDone += 1;
        rlStats.textContent = `Episodes: ${episodesDone} | Steps: ${epSteps} | Return: ${epReward.toFixed(2)} | Q-states: ${Q.size}`;
        training = false;
      }

      function tick(){
        if(abortAgent){
          cleanup();
          resolve();
          return;
        }
        if(paused){
          requestAnimationFrame(tick);
          return;
        }
        if(steps >= maxSteps || lives <= 0){
          cleanup();
          resolve();
          return;
        }
        update();
        steps++;
        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    });
  }

  train1.onclick = async ()=>{ await runEpisode(3000); };
  train50.onclick = async ()=>{
    for(let i=0;i<50;i++){
      if(abortAgent) break;
      await runEpisode(3000);
    }
  };
  resetQ.onclick = ()=>{ resetQTable(); rlStats.textContent = "Q-table cleared."; };

  // Init
  resetGame();
  cancelAnimationFrame(rafId);
  loop();
})();
</script>
</div></div>
</div>
<div class="admonition-exercise admonition">
<p class="admonition-title">⏰ <strong>Exercise</strong></p>
<p>Use very large or small <code class="docutils literal notranslate"><span class="pre">ɛ̝</span></code> and <code class="docutils literal notranslate"><span class="pre">γ</span></code> values (e.g. <code class="docutils literal notranslate"><span class="pre">0</span></code> and <code class="docutils literal notranslate"><span class="pre">1</span></code>) to see any changes on the agent’s behaviour.</p>
</div>
</section>
<section id="interactive-game-2-maze">
<h3>2.2 Interactive Game 2 — Maze<a class="headerlink" href="#interactive-game-2-maze" title="Permalink to this heading">#</a></h3>
<p>In this grid world, each cell is a <strong>state</strong>, and the agent learns to reach the goal.</p>
<p><strong>Reward:</strong></p>
<p>−1 per move, +100 at the goal → shorter paths yield higher return</p>
<p><strong>Actions:</strong></p>
<p>Up, Down, Left, Right</p>
<p><strong>Learning rule:</strong><br />
$<span class="math notranslate nohighlight">\(
  Q(s,a) \leftarrow Q(s,a) + \alpha [r + \gamma \max_{a'} Q(s',a') - Q(s,a)]
  \)</span>$</p>
<p>Enable the agent, train for multiple episodes, and observe how the route shortens over time.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTML</span>

<span class="n">HTML</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;div id=&quot;maze2-container&quot; style=&quot;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 1rem 0;&quot;&gt;</span>
<span class="s2">  &lt;div style=&quot;display:flex;flex-wrap:wrap;align-items:center;gap:.5rem;margin-bottom:.5rem;&quot;&gt;</span>
<span class="s2">    &lt;button id=&quot;mz2-start&quot; style=&quot;padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Start&lt;/button&gt;</span>
<span class="s2">    &lt;button id=&quot;mz2-pause&quot; style=&quot;padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Pause&lt;/button&gt;</span>
<span class="s2">    &lt;button id=&quot;mz2-reset&quot; style=&quot;padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Reset&lt;/button&gt;</span>
<span class="s2">    &lt;label style=&quot;display:flex;align-items:center;gap:.35rem;color:#ddd;&quot;&gt;</span>
<span class="s2">      &lt;input type=&quot;checkbox&quot; id=&quot;freezeAgent&quot; /&gt;</span>
<span class="s2">      Don’t move (freeze agent)</span>
<span class="s2">    &lt;/label&gt;</span>
<span class="s2">    &lt;label style=&quot;display:flex;align-items:center;gap:.35rem;color:#ddd;&quot;&gt;</span>
<span class="s2">      &lt;input type=&quot;checkbox&quot; id=&quot;autoContinue&quot; /&gt;</span>
<span class="s2">      Auto-continue episodes</span>
<span class="s2">    &lt;/label&gt;</span>
<span class="s2">    &lt;span style=&quot;opacity:.85;&quot;&gt;Play with ←/→/↑/↓. R resets. P pauses. Click the canvas to focus.&lt;/span&gt;</span>
<span class="s2">  &lt;/div&gt;</span>

<span class="s2">  &lt;canvas id=&quot;maze2&quot; width=&quot;384&quot; height=&quot;384&quot; style=&quot;max-width:100%;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);background:#000;display:block;outline:none;&quot;&gt;&lt;/canvas&gt;</span>

<span class="s2">  &lt;details style=&quot;margin-top:1rem;background:#0f1329;border:1px solid #222;border-radius:10px;padding:.75rem;color:#e6e6e6;&quot;&gt;</span>
<span class="s2">    &lt;summary style=&quot;cursor:pointer;font-weight:600;&quot;&gt;Reinforcement Learning demo&lt;/summary&gt;</span>
<span class="s2">    &lt;div style=&quot;margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.75rem;&quot;&gt;</span>
<span class="s2">      &lt;label style=&quot;display:flex;align-items:center;gap:.5rem;&quot;&gt;</span>
<span class="s2">        &lt;input type=&quot;checkbox&quot; id=&quot;agentEnabled&quot;/&gt;</span>
<span class="s2">        Agent enabled</span>
<span class="s2">      &lt;/label&gt;</span>
<span class="s2">      &lt;label&gt;ε (explore): &lt;input id=&quot;mz2-eps&quot; type=&quot;range&quot; min=&quot;0&quot; max=&quot;1&quot; step=&quot;0.01&quot; value=&quot;0.10&quot; style=&quot;width:140px;&quot;&gt;</span>
<span class="s2">        &lt;span id=&quot;mz2-epsV&quot;&gt;0.10&lt;/span&gt;&lt;/label&gt;</span>
<span class="s2">      &lt;label&gt;α (learn rate): &lt;input id=&quot;mz2-alpha&quot; type=&quot;range&quot; min=&quot;0&quot; max=&quot;1&quot; step=&quot;0.01&quot; value=&quot;0.20&quot; style=&quot;width:140px;&quot;&gt;</span>
<span class="s2">        &lt;span id=&quot;mz2-alphaV&quot;&gt;0.20&lt;/span&gt;&lt;/label&gt;</span>
<span class="s2">      &lt;label&gt;γ (discount): &lt;input id=&quot;mz2-gamma&quot; type=&quot;range&quot; min=&quot;0&quot; max=&quot;1&quot; step=&quot;0.01&quot; value=&quot;0.95&quot; style=&quot;width:140px;&quot;&gt;</span>
<span class="s2">        &lt;span id=&quot;mz2-gammaV&quot;&gt;0.95&lt;/span&gt;&lt;/label&gt;</span>
<span class="s2">      &lt;button id=&quot;mz2-train1&quot; style=&quot;padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Train 1 episode&lt;/button&gt;</span>
<span class="s2">      &lt;button id=&quot;mz2-train50&quot; style=&quot;padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Train 100 episodes&lt;/button&gt;</span>
<span class="s2">      &lt;button id=&quot;mz2-resetQ&quot; style=&quot;padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Reset Q-table&lt;/button&gt;</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">    &lt;div style=&quot;margin-top:.5rem;font-size:.95rem;opacity:.9;line-height:1.4;&quot;&gt;</span>
<span class="s2">      &lt;strong&gt;What it shows&lt;/strong&gt;: Reward is &lt;code&gt;-1&lt;/code&gt; every time step and &lt;code&gt;+100&lt;/code&gt; at the goal. Shorter paths earn higher return.&lt;br&gt;</span>
<span class="s2">      &lt;strong&gt;State&lt;/strong&gt;: grid cell (x,y). &lt;strong&gt;Actions&lt;/strong&gt;: Up, Down, Left, Right.&lt;br&gt;</span>
<span class="s2">      ε-greedy Q-learning: &lt;code&gt;Q(s,a) ← Q(s,a) + α[r + γ max_a&#39; Q(s&#39;,a&#39;) − Q(s,a)]&lt;/code&gt;.</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">    &lt;div id=&quot;mz2-stats&quot; style=&quot;margin-top:.5rem;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;&quot;&gt;&lt;/div&gt;</span>
<span class="s2">  &lt;/details&gt;</span>
<span class="s2">&lt;/div&gt;</span>

<span class="s2">&lt;script&gt;</span>
<span class="s2">(() =&gt; {</span>
<span class="s2">  const cvs = document.getElementById(&#39;maze2&#39;);</span>
<span class="s2">  const ctx = cvs.getContext(&#39;2d&#39;);</span>
<span class="s2">  const startBtn = document.getElementById(&#39;mz2-start&#39;);</span>
<span class="s2">  const pauseBtn = document.getElementById(&#39;mz2-pause&#39;);</span>
<span class="s2">  const resetBtn = document.getElementById(&#39;mz2-reset&#39;);</span>
<span class="s2">  const freezeAgentEl = document.getElementById(&#39;freezeAgent&#39;);</span>
<span class="s2">  const autoContinueEl = document.getElementById(&#39;autoContinue&#39;);</span>
<span class="s2">  const stats = document.getElementById(&#39;mz2-stats&#39;);</span>

<span class="s2">  // RL panel</span>
<span class="s2">  const agentEnabledEl = document.getElementById(&#39;agentEnabled&#39;);</span>
<span class="s2">  const epsEl = document.getElementById(&#39;mz2-eps&#39;), epsV = document.getElementById(&#39;mz2-epsV&#39;);</span>
<span class="s2">  const alphaEl = document.getElementById(&#39;mz2-alpha&#39;), alphaV = document.getElementById(&#39;mz2-alphaV&#39;);</span>
<span class="s2">  const gammaEl = document.getElementById(&#39;mz2-gamma&#39;), gammaV = document.getElementById(&#39;mz2-gammaV&#39;);</span>
<span class="s2">  const train1 = document.getElementById(&#39;mz2-train1&#39;);</span>
<span class="s2">  const train50 = document.getElementById(&#39;mz2-train50&#39;);</span>
<span class="s2">  const resetQBtn = document.getElementById(&#39;mz2-resetQ&#39;);</span>

<span class="s2">  // Training control flags</span>
<span class="s2">  let training = false;</span>
<span class="s2">  let abortAgent = false;</span>

<span class="s2">  function syncVals(){</span>
<span class="s2">    epsV.textContent = Number(epsEl.value).toFixed(2);</span>
<span class="s2">    alphaV.textContent = Number(alphaEl.value).toFixed(2);</span>
<span class="s2">    gammaV.textContent = Number(gammaEl.value).toFixed(2);</span>
<span class="s2">  }</span>
<span class="s2">  epsEl.oninput = syncVals; alphaEl.oninput = syncVals; gammaEl.oninput = syncVals; syncVals();</span>

<span class="s2">  // Maze: 1 open, 0 wall</span>
<span class="s2">  const maze = [</span>
<span class="s2">    [0,1,1,1,0,1,0,1],</span>
<span class="s2">    [1,1,1,1,1,1,1,1],</span>
<span class="s2">    [1,1,0,0,0,1,0,0],</span>
<span class="s2">    [0,1,1,0,0,1,1,1],</span>
<span class="s2">    [0,0,1,1,0,0,0,1],</span>
<span class="s2">    [0,1,0,1,0,1,0,1],</span>
<span class="s2">    [0,1,0,1,0,1,0,1],</span>
<span class="s2">    [0,1,1,1,1,1,0,1],</span>
<span class="s2">  ];</span>
<span class="s2">  const N = maze.length;</span>
<span class="s2">  const CELL = Math.floor(cvs.width / N);</span>

<span class="s2">  // Colors</span>
<span class="s2">  const WHITE=&quot;#ffffff&quot;;</span>
<span class="s2">  const BLACK=&quot;#000000&quot;;</span>
<span class="s2">  const WALL=&quot;#1a1a1a&quot;;</span>
<span class="s2">  const AGENT=&quot;#3af&quot;;</span>
<span class="s2">  const GOAL=&quot;#ffdd57&quot;;</span>
<span class="s2">  const GRID=&quot;#333&quot;;</span>

<span class="s2">  // Start at first open cell on left edge</span>
<span class="s2">  let start = null;</span>
<span class="s2">  for(let y=0;y&lt;N;y++){ if(maze[y][0]===1){ start={x:0,y:y}; break; } }</span>
<span class="s2">  if(!start) start = {x:0,y:1};</span>
<span class="s2">  const goal = {x:N-1, y:N-1};</span>

<span class="s2">  let agent = {...start};</span>
<span class="s2">  let running = false, paused = false;</span>

<span class="s2">  // Fog of war</span>
<span class="s2">  let seenOpen = Array.from({length:N}, ()=&gt;Array(N).fill(false));</span>
<span class="s2">  let seenWall = Array.from({length:N}, ()=&gt;Array(N).fill(false));</span>

<span class="s2">  function reveal(x,y){</span>
<span class="s2">    if(x&lt;0||y&lt;0||x&gt;=N||y&gt;=N) return;</span>
<span class="s2">    if(maze[y][x]===1) seenOpen[y][x] = true;</span>
<span class="s2">    else seenWall[y][x] = true;</span>
<span class="s2">  }</span>

<span class="s2">  // Human control</span>
<span class="s2">  const keys = {left:false,right:false,up:false,down:false};</span>
<span class="s2">  function setKey(e,down){</span>
<span class="s2">    const k = e.key || e.code;</span>

<span class="s2">    // Always allow pause and reset even in agent mode</span>
<span class="s2">    if(down){</span>
<span class="s2">      if(k===&#39;p&#39; || k===&#39;P&#39;){</span>
<span class="s2">        paused = !paused;</span>
<span class="s2">      }</span>
<span class="s2">      if(k===&#39;r&#39; || k===&#39;R&#39;){</span>
<span class="s2">        if(training || agentEnabledEl.checked) stopAgent(&quot;Reset&quot;);</span>
<span class="s2">        resetGame();</span>
<span class="s2">      }</span>
<span class="s2">    }</span>

<span class="s2">    // Movement blocked when agent is on or frozen</span>
<span class="s2">    const blockMovement = agentEnabledEl.checked || freezeAgentEl.checked;</span>
<span class="s2">    if(!blockMovement){</span>
<span class="s2">      if(k===&#39;ArrowLeft&#39; || k===&#39;Left&#39;){ keys.left=down; e.preventDefault(); }</span>
<span class="s2">      if(k===&#39;ArrowRight&#39;|| k===&#39;Right&#39;){ keys.right=down; e.preventDefault(); }</span>
<span class="s2">      if(k===&#39;ArrowUp&#39;   || k===&#39;Up&#39;){ keys.up=down; e.preventDefault(); }</span>
<span class="s2">      if(k===&#39;ArrowDown&#39; || k===&#39;Down&#39;){ keys.down=down; e.preventDefault(); }</span>
<span class="s2">    }</span>
<span class="s2">  }</span>
<span class="s2">  cvs.tabIndex = 0;</span>
<span class="s2">  cvs.addEventListener(&#39;keydown&#39;, e=&gt;setKey(e,true));</span>
<span class="s2">  cvs.addEventListener(&#39;keyup&#39;, e=&gt;setKey(e,false));</span>
<span class="s2">  document.addEventListener(&#39;keydown&#39;, e=&gt;{ if(document.activeElement===cvs) setKey(e,true); });</span>
<span class="s2">  document.addEventListener(&#39;keyup&#39;, e=&gt;{ if(document.activeElement===cvs) setKey(e,false); });</span>
<span class="s2">  cvs.addEventListener(&#39;mousedown&#39;, ()=&gt;cvs.focus());</span>

<span class="s2">  // RL</span>
<span class="s2">  const ACTIONS = [</span>
<span class="s2">    {dx:0,dy:-1,name:&#39;U&#39;},</span>
<span class="s2">    {dx:0,dy: 1,name:&#39;D&#39;},</span>
<span class="s2">    {dx:-1,dy:0,name:&#39;L&#39;},</span>
<span class="s2">    {dx: 1,dy:0,name:&#39;R&#39;},</span>
<span class="s2">  ];</span>
<span class="s2">  function keyOf(x,y){ return `$</span><span class="si">{x}</span><span class="s2">,$</span><span class="si">{y}</span><span class="s2">`; }</span>
<span class="s2">  let Q = new Map(); // key -&gt; Float32Array(4)</span>
<span class="s2">  function qGet(k){ if(!Q.has(k)) Q.set(k,new Float32Array(4)); return Q.get(k); }</span>
<span class="s2">  function argmax(arr){ let i=0,m=arr[0]; for(let j=1;j&lt;arr.length;j++) if(arr[j]&gt;m){ m=arr[j]; i=j; } return i; }</span>

<span class="s2">  let epReward=0, epSteps=0, episodes=0;</span>

<span class="s2">  function canMove(nx,ny){</span>
<span class="s2">    if(nx&lt;0||ny&lt;0||nx&gt;=N||ny&gt;=N) return false;</span>
<span class="s2">    return maze[ny][nx]===1;</span>
<span class="s2">  }</span>

<span class="s2">  // Reward: -1 per step, 0 at goal</span>
<span class="s2">  function rewardFor(nx,ny){</span>
<span class="s2">    if(nx===goal.x &amp;&amp; ny===goal.y) return 0;</span>
<span class="s2">    return -1;</span>
<span class="s2">  }</span>

<span class="s2">  function agentAttemptMove(dx,dy){</span>
<span class="s2">    const tx = agent.x + dx;</span>
<span class="s2">    const ty = agent.y + dy;</span>
<span class="s2">    reveal(tx, ty);</span>
<span class="s2">    if(canMove(tx,ty)){</span>
<span class="s2">      agent.x = tx; agent.y = ty;</span>
<span class="s2">      return true;</span>
<span class="s2">    }</span>
<span class="s2">    return false;</span>
<span class="s2">  }</span>

<span class="s2">  function agentStep(){</span>
<span class="s2">    const s = keyOf(agent.x,agent.y);</span>
<span class="s2">    const q = qGet(s);</span>
<span class="s2">    const eps = Number(epsEl.value);</span>
<span class="s2">    let aIdx = Math.random()&lt;eps ? Math.floor(Math.random()*ACTIONS.length) : argmax(q);</span>

<span class="s2">    const a = ACTIONS[aIdx];</span>
<span class="s2">    agentAttemptMove(a.dx, a.dy);</span>

<span class="s2">    const r = rewardFor(agent.x, agent.y);</span>
<span class="s2">    const s2 = keyOf(agent.x, agent.y);</span>
<span class="s2">    const q2 = qGet(s2);</span>
<span class="s2">    const alpha = Number(alphaEl.value), gamma = Number(gammaEl.value);</span>
<span class="s2">    const tdTarget = r + gamma * Math.max(q2[0], q2[1], q2[2], q2[3]);</span>
<span class="s2">    q[aIdx] = q[aIdx] + alpha * (tdTarget - q[aIdx]);</span>

<span class="s2">    reveal(agent.x, agent.y);</span>

<span class="s2">    epReward += r; epSteps += 1;</span>
<span class="s2">  }</span>

<span class="s2">  // Human</span>
<span class="s2">  let _humanTick = 0;</span>
<span class="s2">  function humanStep(){</span>
<span class="s2">    _humanTick = (_humanTick + 1) % 8;</span>
<span class="s2">    if(_humanTick !== 0) return;</span>
<span class="s2">    let nx = agent.x, ny = agent.y;</span>
<span class="s2">    if(keys.left)  nx -= 1;</span>
<span class="s2">    if(keys.right) nx += 1;</span>
<span class="s2">    if(keys.up)    ny -= 1;</span>
<span class="s2">    if(keys.down)  ny += 1;</span>

<span class="s2">    reveal(nx, ny);</span>

<span class="s2">    if(canMove(nx,ny)){</span>
<span class="s2">      agent.x = nx; agent.y = ny;</span>
<span class="s2">      reveal(agent.x, agent.y);</span>
<span class="s2">    }</span>
<span class="s2">  }</span>

<span class="s2">  function draw(){</span>
<span class="s2">    for(let y=0;y&lt;N;y++){</span>
<span class="s2">      for(let x=0;x&lt;N;x++){</span>
<span class="s2">        let fill = BLACK;</span>
<span class="s2">        if(seenOpen[y][x]) fill = WHITE;</span>
<span class="s2">        else if(seenWall[y][x]) fill = WALL;</span>
<span class="s2">        ctx.fillStyle = fill;</span>
<span class="s2">        ctx.fillRect(x*CELL, y*CELL, CELL, CELL);</span>
<span class="s2">      }</span>
<span class="s2">    }</span>
<span class="s2">    // Grid</span>
<span class="s2">    ctx.strokeStyle = GRID;</span>
<span class="s2">    for(let i=0;i&lt;=N;i++){</span>
<span class="s2">      ctx.beginPath(); ctx.moveTo(0,i*CELL); ctx.lineTo(N*CELL,i*CELL); ctx.stroke();</span>
<span class="s2">      ctx.beginPath(); ctx.moveTo(i*CELL,0); ctx.lineTo(i*CELL,N*CELL); ctx.stroke();</span>
<span class="s2">    }</span>
<span class="s2">    // Goal if known or reached</span>
<span class="s2">    if(seenOpen[goal.y][goal.x] || (agent.x===goal.x &amp;&amp; agent.y===goal.y)){</span>
<span class="s2">      ctx.fillStyle = GOAL;</span>
<span class="s2">      ctx.fillRect(goal.x*CELL, goal.y*CELL, CELL, CELL);</span>
<span class="s2">    }</span>
<span class="s2">    // Agent</span>
<span class="s2">    ctx.fillStyle = AGENT;</span>
<span class="s2">    ctx.beginPath();</span>
<span class="s2">    ctx.arc(agent.x*CELL + CELL/2, agent.y*CELL + CELL/2, CELL*0.33, 0, Math.PI*2);</span>
<span class="s2">    ctx.fill();</span>
<span class="s2">  }</span>

<span class="s2">  function onEpisodeEnd(){</span>
<span class="s2">    episodes += 1;</span>
<span class="s2">    stats.textContent = `Episodes: $</span><span class="si">{episodes}</span><span class="s2"> | Steps: $</span><span class="si">{epSteps}</span><span class="s2"> | Return: ${epReward.toFixed(2)} | Q-states: $</span><span class="si">{Q.size}</span><span class="s2">`;</span>
<span class="s2">    if(autoContinueEl.checked){</span>
<span class="s2">      resetGame();</span>
<span class="s2">      running = true;</span>
<span class="s2">    } else {</span>
<span class="s2">      running = false;</span>
<span class="s2">    }</span>
<span class="s2">  }</span>

<span class="s2">  function update(){</span>
<span class="s2">    if(agentEnabledEl.checked &amp;&amp; !freezeAgentEl.checked){</span>
<span class="s2">      agentStep();</span>
<span class="s2">    } else {</span>
<span class="s2">      humanStep();</span>
<span class="s2">    }</span>
<span class="s2">    if(agent.x===goal.x &amp;&amp; agent.y===goal.y &amp;&amp; agentEnabledEl.checked){</span>
<span class="s2">      onEpisodeEnd();</span>
<span class="s2">    }</span>
<span class="s2">  }</span>

<span class="s2">  function loop(){</span>
<span class="s2">    if(running &amp;&amp; !paused) update();</span>
<span class="s2">    draw();</span>
<span class="s2">    requestAnimationFrame(loop);</span>
<span class="s2">  }</span>

<span class="s2">  function resetGame(){</span>
<span class="s2">    agent = {...start};</span>
<span class="s2">    epReward = 0; epSteps = 0;</span>
<span class="s2">    paused = false;</span>
<span class="s2">    seenOpen = Array.from({length:N}, ()=&gt;Array(N).fill(false));</span>
<span class="s2">    seenWall = Array.from({length:N}, ()=&gt;Array(N).fill(false));</span>
<span class="s2">    reveal(agent.x, agent.y);</span>
<span class="s2">  }</span>

<span class="s2">  // Stop agent helper</span>
<span class="s2">  function stopAgent(reason = &quot;&quot;){</span>
<span class="s2">    abortAgent = true;</span>
<span class="s2">    training = false;</span>
<span class="s2">    agentEnabledEl.checked = false;</span>
<span class="s2">    if(reason) stats.textContent = reason;</span>
<span class="s2">  }</span>

<span class="s2">  // Buttons</span>
<span class="s2">  startBtn.onclick = () =&gt; { running = true; paused = false; cvs.focus(); };</span>
<span class="s2">  pauseBtn.onclick = () =&gt; { if(running){ paused = !paused; cvs.focus(); } };</span>
<span class="s2">  resetBtn.onclick = () =&gt; { if(training || agentEnabledEl.checked) stopAgent(&quot;Agent stopped by Reset.&quot;); resetGame(); cvs.focus(); };</span>

<span class="s2">  // Turn off agent mid-episode</span>
<span class="s2">  agentEnabledEl.addEventListener(&#39;change&#39;, ()=&gt;{</span>
<span class="s2">    if(!agentEnabledEl.checked &amp;&amp; training){</span>
<span class="s2">      stopAgent(&quot;Agent disabled.&quot;);</span>
<span class="s2">    }</span>
<span class="s2">  });</span>

<span class="s2">  function resetQ(){ Q = new Map(); stats.textContent = &quot;Q-table cleared.&quot;; }</span>
<span class="s2">  resetQBtn.onclick = resetQ;</span>

<span class="s2">  async function runEpisode(maxSteps=500){</span>
<span class="s2">    const prevAuto = autoContinueEl.checked;</span>
<span class="s2">    autoContinueEl.checked = false;</span>

<span class="s2">    const prevRun = running, prevPause = paused, prevAgent = agentEnabledEl.checked, prevFreeze = freezeAgentEl.checked;</span>
<span class="s2">    agentEnabledEl.checked = true;</span>
<span class="s2">    freezeAgentEl.checked = false;</span>
<span class="s2">    resetGame();</span>
<span class="s2">    running = true; paused = false;</span>

<span class="s2">    let steps = 0;</span>
<span class="s2">    abortAgent = false;</span>
<span class="s2">    training = true;</span>

<span class="s2">    await new Promise(resolve=&gt;{</span>
<span class="s2">      function cleanup(){</span>
<span class="s2">        onEpisodeEnd();</span>
<span class="s2">        running = prevRun;</span>
<span class="s2">        paused = prevPause;</span>
<span class="s2">        agentEnabledEl.checked = prevAgent &amp;&amp; !abortAgent;</span>
<span class="s2">        freezeAgentEl.checked = prevFreeze;</span>
<span class="s2">        autoContinueEl.checked = prevAuto;</span>
<span class="s2">        training = false;</span>
<span class="s2">      }</span>
<span class="s2">      function tick(){</span>
<span class="s2">        if(abortAgent){</span>
<span class="s2">          cleanup();</span>
<span class="s2">          resolve();</span>
<span class="s2">          return;</span>
<span class="s2">        }</span>
<span class="s2">        if(paused){</span>
<span class="s2">          requestAnimationFrame(tick);</span>
<span class="s2">          return;</span>
<span class="s2">        }</span>
<span class="s2">        if(steps &gt;= maxSteps || (agent.x===goal.x &amp;&amp; agent.y===goal.y)){</span>
<span class="s2">          cleanup();</span>
<span class="s2">          resolve();</span>
<span class="s2">          return;</span>
<span class="s2">        }</span>
<span class="s2">        agentStep();</span>
<span class="s2">        draw();</span>
<span class="s2">        steps++;</span>
<span class="s2">        requestAnimationFrame(tick);</span>
<span class="s2">      }</span>
<span class="s2">      requestAnimationFrame(tick);</span>
<span class="s2">    });</span>
<span class="s2">  }</span>

<span class="s2">  // Train buttons</span>
<span class="s2">  train1.onclick = async ()=&gt;{ await runEpisode(500); };</span>
<span class="s2">  train50.onclick = async ()=&gt;{</span>
<span class="s2">    for(let i=0;i&lt;100;i++){</span>
<span class="s2">      if(abortAgent) break;</span>
<span class="s2">      await runEpisode(500);</span>
<span class="s2">    }</span>
<span class="s2">  };</span>

<span class="s2">  // Init</span>
<span class="s2">  resetGame();</span>
<span class="s2">  loop();</span>
<span class="s2">})();</span>
<span class="s2">&lt;/script&gt;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html">
<div id="maze2-container" style="font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 1rem 0;">
  <div style="display:flex;flex-wrap:wrap;align-items:center;gap:.5rem;margin-bottom:.5rem;">
    <button id="mz2-start" style="padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Start</button>
    <button id="mz2-pause" style="padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Pause</button>
    <button id="mz2-reset" style="padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Reset</button>
    <label style="display:flex;align-items:center;gap:.35rem;color:#ddd;">
      <input type="checkbox" id="freezeAgent" />
      Don’t move (freeze agent)
    </label>
    <label style="display:flex;align-items:center;gap:.35rem;color:#ddd;">
      <input type="checkbox" id="autoContinue" />
      Auto-continue episodes
    </label>
    <span style="opacity:.85;">Play with ←/→/↑/↓. R resets. P pauses. Click the canvas to focus.</span>
  </div>

  <canvas id="maze2" width="384" height="384" style="max-width:100%;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);background:#000;display:block;outline:none;"></canvas>

  <details style="margin-top:1rem;background:#0f1329;border:1px solid #222;border-radius:10px;padding:.75rem;color:#e6e6e6;">
    <summary style="cursor:pointer;font-weight:600;">Reinforcement Learning demo</summary>
    <div style="margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.75rem;">
      <label style="display:flex;align-items:center;gap:.5rem;">
        <input type="checkbox" id="agentEnabled"/>
        Agent enabled
      </label>
      <label>ε (explore): <input id="mz2-eps" type="range" min="0" max="1" step="0.01" value="0.10" style="width:140px;">
        <span id="mz2-epsV">0.10</span></label>
      <label>α (learn rate): <input id="mz2-alpha" type="range" min="0" max="1" step="0.01" value="0.20" style="width:140px;">
        <span id="mz2-alphaV">0.20</span></label>
      <label>γ (discount): <input id="mz2-gamma" type="range" min="0" max="1" step="0.01" value="0.95" style="width:140px;">
        <span id="mz2-gammaV">0.95</span></label>
      <button id="mz2-train1" style="padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Train 1 episode</button>
      <button id="mz2-train50" style="padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Train 100 episodes</button>
      <button id="mz2-resetQ" style="padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Reset Q-table</button>
    </div>
    <div style="margin-top:.5rem;font-size:.95rem;opacity:.9;line-height:1.4;">
      <strong>What it shows</strong>: Reward is <code>-1</code> every time step and <code>+100</code> at the goal. Shorter paths earn higher return.<br>
      <strong>State</strong>: grid cell (x,y). <strong>Actions</strong>: Up, Down, Left, Right.<br>
      ε-greedy Q-learning: <code>Q(s,a) ← Q(s,a) + α[r + γ max_a' Q(s',a') − Q(s,a)]</code>.
    </div>
    <div id="mz2-stats" style="margin-top:.5rem;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;"></div>
  </details>
</div>

<script>
(() => {
  const cvs = document.getElementById('maze2');
  const ctx = cvs.getContext('2d');
  const startBtn = document.getElementById('mz2-start');
  const pauseBtn = document.getElementById('mz2-pause');
  const resetBtn = document.getElementById('mz2-reset');
  const freezeAgentEl = document.getElementById('freezeAgent');
  const autoContinueEl = document.getElementById('autoContinue');
  const stats = document.getElementById('mz2-stats');

  // RL panel
  const agentEnabledEl = document.getElementById('agentEnabled');
  const epsEl = document.getElementById('mz2-eps'), epsV = document.getElementById('mz2-epsV');
  const alphaEl = document.getElementById('mz2-alpha'), alphaV = document.getElementById('mz2-alphaV');
  const gammaEl = document.getElementById('mz2-gamma'), gammaV = document.getElementById('mz2-gammaV');
  const train1 = document.getElementById('mz2-train1');
  const train50 = document.getElementById('mz2-train50');
  const resetQBtn = document.getElementById('mz2-resetQ');

  // Training control flags
  let training = false;
  let abortAgent = false;

  function syncVals(){
    epsV.textContent = Number(epsEl.value).toFixed(2);
    alphaV.textContent = Number(alphaEl.value).toFixed(2);
    gammaV.textContent = Number(gammaEl.value).toFixed(2);
  }
  epsEl.oninput = syncVals; alphaEl.oninput = syncVals; gammaEl.oninput = syncVals; syncVals();

  // Maze: 1 open, 0 wall
  const maze = [
    [0,1,1,1,0,1,0,1],
    [1,1,1,1,1,1,1,1],
    [1,1,0,0,0,1,0,0],
    [0,1,1,0,0,1,1,1],
    [0,0,1,1,0,0,0,1],
    [0,1,0,1,0,1,0,1],
    [0,1,0,1,0,1,0,1],
    [0,1,1,1,1,1,0,1],
  ];
  const N = maze.length;
  const CELL = Math.floor(cvs.width / N);

  // Colors
  const WHITE="#ffffff";
  const BLACK="#000000";
  const WALL="#1a1a1a";
  const AGENT="#3af";
  const GOAL="#ffdd57";
  const GRID="#333";

  // Start at first open cell on left edge
  let start = null;
  for(let y=0;y<N;y++){ if(maze[y][0]===1){ start={x:0,y:y}; break; } }
  if(!start) start = {x:0,y:1};
  const goal = {x:N-1, y:N-1};

  let agent = {...start};
  let running = false, paused = false;

  // Fog of war
  let seenOpen = Array.from({length:N}, ()=>Array(N).fill(false));
  let seenWall = Array.from({length:N}, ()=>Array(N).fill(false));

  function reveal(x,y){
    if(x<0||y<0||x>=N||y>=N) return;
    if(maze[y][x]===1) seenOpen[y][x] = true;
    else seenWall[y][x] = true;
  }

  // Human control
  const keys = {left:false,right:false,up:false,down:false};
  function setKey(e,down){
    const k = e.key || e.code;

    // Always allow pause and reset even in agent mode
    if(down){
      if(k==='p' || k==='P'){
        paused = !paused;
      }
      if(k==='r' || k==='R'){
        if(training || agentEnabledEl.checked) stopAgent("Reset");
        resetGame();
      }
    }

    // Movement blocked when agent is on or frozen
    const blockMovement = agentEnabledEl.checked || freezeAgentEl.checked;
    if(!blockMovement){
      if(k==='ArrowLeft' || k==='Left'){ keys.left=down; e.preventDefault(); }
      if(k==='ArrowRight'|| k==='Right'){ keys.right=down; e.preventDefault(); }
      if(k==='ArrowUp'   || k==='Up'){ keys.up=down; e.preventDefault(); }
      if(k==='ArrowDown' || k==='Down'){ keys.down=down; e.preventDefault(); }
    }
  }
  cvs.tabIndex = 0;
  cvs.addEventListener('keydown', e=>setKey(e,true));
  cvs.addEventListener('keyup', e=>setKey(e,false));
  document.addEventListener('keydown', e=>{ if(document.activeElement===cvs) setKey(e,true); });
  document.addEventListener('keyup', e=>{ if(document.activeElement===cvs) setKey(e,false); });
  cvs.addEventListener('mousedown', ()=>cvs.focus());

  // RL
  const ACTIONS = [
    {dx:0,dy:-1,name:'U'},
    {dx:0,dy: 1,name:'D'},
    {dx:-1,dy:0,name:'L'},
    {dx: 1,dy:0,name:'R'},
  ];
  function keyOf(x,y){ return `${x},${y}`; }
  let Q = new Map(); // key -> Float32Array(4)
  function qGet(k){ if(!Q.has(k)) Q.set(k,new Float32Array(4)); return Q.get(k); }
  function argmax(arr){ let i=0,m=arr[0]; for(let j=1;j<arr.length;j++) if(arr[j]>m){ m=arr[j]; i=j; } return i; }

  let epReward=0, epSteps=0, episodes=0;

  function canMove(nx,ny){
    if(nx<0||ny<0||nx>=N||ny>=N) return false;
    return maze[ny][nx]===1;
  }

  // Reward: -1 per step, 0 at goal
  function rewardFor(nx,ny){
    if(nx===goal.x && ny===goal.y) return 0;
    return -1;
  }

  function agentAttemptMove(dx,dy){
    const tx = agent.x + dx;
    const ty = agent.y + dy;
    reveal(tx, ty);
    if(canMove(tx,ty)){
      agent.x = tx; agent.y = ty;
      return true;
    }
    return false;
  }

  function agentStep(){
    const s = keyOf(agent.x,agent.y);
    const q = qGet(s);
    const eps = Number(epsEl.value);
    let aIdx = Math.random()<eps ? Math.floor(Math.random()*ACTIONS.length) : argmax(q);

    const a = ACTIONS[aIdx];
    agentAttemptMove(a.dx, a.dy);

    const r = rewardFor(agent.x, agent.y);
    const s2 = keyOf(agent.x, agent.y);
    const q2 = qGet(s2);
    const alpha = Number(alphaEl.value), gamma = Number(gammaEl.value);
    const tdTarget = r + gamma * Math.max(q2[0], q2[1], q2[2], q2[3]);
    q[aIdx] = q[aIdx] + alpha * (tdTarget - q[aIdx]);

    reveal(agent.x, agent.y);

    epReward += r; epSteps += 1;
  }

  // Human
  let _humanTick = 0;
  function humanStep(){
    _humanTick = (_humanTick + 1) % 8;
    if(_humanTick !== 0) return;
    let nx = agent.x, ny = agent.y;
    if(keys.left)  nx -= 1;
    if(keys.right) nx += 1;
    if(keys.up)    ny -= 1;
    if(keys.down)  ny += 1;

    reveal(nx, ny);

    if(canMove(nx,ny)){
      agent.x = nx; agent.y = ny;
      reveal(agent.x, agent.y);
    }
  }

  function draw(){
    for(let y=0;y<N;y++){
      for(let x=0;x<N;x++){
        let fill = BLACK;
        if(seenOpen[y][x]) fill = WHITE;
        else if(seenWall[y][x]) fill = WALL;
        ctx.fillStyle = fill;
        ctx.fillRect(x*CELL, y*CELL, CELL, CELL);
      }
    }
    // Grid
    ctx.strokeStyle = GRID;
    for(let i=0;i<=N;i++){
      ctx.beginPath(); ctx.moveTo(0,i*CELL); ctx.lineTo(N*CELL,i*CELL); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(i*CELL,0); ctx.lineTo(i*CELL,N*CELL); ctx.stroke();
    }
    // Goal if known or reached
    if(seenOpen[goal.y][goal.x] || (agent.x===goal.x && agent.y===goal.y)){
      ctx.fillStyle = GOAL;
      ctx.fillRect(goal.x*CELL, goal.y*CELL, CELL, CELL);
    }
    // Agent
    ctx.fillStyle = AGENT;
    ctx.beginPath();
    ctx.arc(agent.x*CELL + CELL/2, agent.y*CELL + CELL/2, CELL*0.33, 0, Math.PI*2);
    ctx.fill();
  }

  function onEpisodeEnd(){
    episodes += 1;
    stats.textContent = `Episodes: ${episodes} | Steps: ${epSteps} | Return: ${epReward.toFixed(2)} | Q-states: ${Q.size}`;
    if(autoContinueEl.checked){
      resetGame();
      running = true;
    } else {
      running = false;
    }
  }

  function update(){
    if(agentEnabledEl.checked && !freezeAgentEl.checked){
      agentStep();
    } else {
      humanStep();
    }
    if(agent.x===goal.x && agent.y===goal.y && agentEnabledEl.checked){
      onEpisodeEnd();
    }
  }

  function loop(){
    if(running && !paused) update();
    draw();
    requestAnimationFrame(loop);
  }

  function resetGame(){
    agent = {...start};
    epReward = 0; epSteps = 0;
    paused = false;
    seenOpen = Array.from({length:N}, ()=>Array(N).fill(false));
    seenWall = Array.from({length:N}, ()=>Array(N).fill(false));
    reveal(agent.x, agent.y);
  }

  // Stop agent helper
  function stopAgent(reason = ""){
    abortAgent = true;
    training = false;
    agentEnabledEl.checked = false;
    if(reason) stats.textContent = reason;
  }

  // Buttons
  startBtn.onclick = () => { running = true; paused = false; cvs.focus(); };
  pauseBtn.onclick = () => { if(running){ paused = !paused; cvs.focus(); } };
  resetBtn.onclick = () => { if(training || agentEnabledEl.checked) stopAgent("Agent stopped by Reset."); resetGame(); cvs.focus(); };

  // Turn off agent mid-episode
  agentEnabledEl.addEventListener('change', ()=>{
    if(!agentEnabledEl.checked && training){
      stopAgent("Agent disabled.");
    }
  });

  function resetQ(){ Q = new Map(); stats.textContent = "Q-table cleared."; }
  resetQBtn.onclick = resetQ;

  async function runEpisode(maxSteps=500){
    const prevAuto = autoContinueEl.checked;
    autoContinueEl.checked = false;

    const prevRun = running, prevPause = paused, prevAgent = agentEnabledEl.checked, prevFreeze = freezeAgentEl.checked;
    agentEnabledEl.checked = true;
    freezeAgentEl.checked = false;
    resetGame();
    running = true; paused = false;

    let steps = 0;
    abortAgent = false;
    training = true;

    await new Promise(resolve=>{
      function cleanup(){
        onEpisodeEnd();
        running = prevRun;
        paused = prevPause;
        agentEnabledEl.checked = prevAgent && !abortAgent;
        freezeAgentEl.checked = prevFreeze;
        autoContinueEl.checked = prevAuto;
        training = false;
      }
      function tick(){
        if(abortAgent){
          cleanup();
          resolve();
          return;
        }
        if(paused){
          requestAnimationFrame(tick);
          return;
        }
        if(steps >= maxSteps || (agent.x===goal.x && agent.y===goal.y)){
          cleanup();
          resolve();
          return;
        }
        agentStep();
        draw();
        steps++;
        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    });
  }

  // Train buttons
  train1.onclick = async ()=>{ await runEpisode(500); };
  train50.onclick = async ()=>{
    for(let i=0;i<100;i++){
      if(abortAgent) break;
      await runEpisode(500);
    }
  };

  // Init
  resetGame();
  loop();
})();
</script>
</div></div>
</div>
<div class="admonition-exercise admonition">
<p class="admonition-title">⏰ <strong>Exercise</strong></p>
<p>Try <code class="docutils literal notranslate"><span class="pre">ɛ̝</span> <span class="pre">=</span> <span class="pre">0</span></code> or <code class="docutils literal notranslate"><span class="pre">γ</span> <span class="pre">=</span> <span class="pre">0</span></code> with any learning rate, what do you see?</p>
</div>
</section>
<section id="interactive-game-3-reaction-surface-screening">
<h3>2.3 Interactive Game 3 — Reaction Surface Screening<a class="headerlink" href="#interactive-game-3-reaction-surface-screening" title="Permalink to this heading">#</a></h3>
</section>
<section id="id1">
<h3>2.3 Interactive Game 3 — Reaction Surface Screening<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<p>This environment resembles a reaction optimization problem.<br />
Cells represent combinations of temperature <span class="math notranslate nohighlight">\(T\)</span> and composition <span class="math notranslate nohighlight">\(x\)</span>.<br />
There are:</p>
<ul class="simple">
<li><p><strong>Walls (black)</strong> that block motion</p></li>
<li><p>A <strong>true optimum</strong> (yellow) with reward <span class="math notranslate nohighlight">\(100\)</span></p></li>
<li><p>A <strong>decoy optimum</strong> (red) with reward <span class="math notranslate nohighlight">\(-50\)</span></p></li>
</ul>
<p>Every step costs −1.<br />
The agent uses ε-greedy Q-learning to find the best route.</p>
<p>Watch how, after enough training, it learns to avoid the decoy and reach the true goal.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTML</span>

<span class="n">HTML</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;div id=&quot;chem-container&quot; style=&quot;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 1rem 0;&quot;&gt;</span>
<span class="s2">  &lt;div style=&quot;display:flex;flex-wrap:wrap;align-items:center;gap:.5rem;margin-bottom:.5rem;&quot;&gt;</span>
<span class="s2">    &lt;button id=&quot;ch-start&quot; style=&quot;padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Start&lt;/button&gt;</span>
<span class="s2">    &lt;button id=&quot;ch-pause&quot; style=&quot;padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Pause&lt;/button&gt;</span>
<span class="s2">    &lt;button id=&quot;ch-reset&quot; style=&quot;padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Reset&lt;/button&gt;</span>
<span class="s2">    &lt;label style=&quot;display:flex;align-items:center;gap:.35rem;color:#ddd;&quot;&gt;</span>
<span class="s2">      &lt;input type=&quot;checkbox&quot; id=&quot;ch-freeze&quot;/&gt; Don’t move (freeze agent)</span>
<span class="s2">    &lt;/label&gt;</span>
<span class="s2">    &lt;label style=&quot;display:flex;align-items:center;gap:.35rem;color:#ddd;&quot;&gt;</span>
<span class="s2">      &lt;input type=&quot;checkbox&quot; id=&quot;ch-autonext&quot;/&gt; Auto-continue episodes</span>
<span class="s2">    &lt;/label&gt;</span>
<span class="s2">    &lt;span style=&quot;opacity:.85;&quot;&gt;Manual: ←/→/↑/↓. R resets. P pauses. Click the canvas to focus.&lt;/span&gt;</span>
<span class="s2">  &lt;/div&gt;</span>

<span class="s2">  &lt;canvas id=&quot;chem&quot; width=&quot;660&quot; height=&quot;660&quot; style=&quot;max-width:100%;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);background:#000;display:block;outline:none;&quot;&gt;&lt;/canvas&gt;</span>

<span class="s2">  &lt;div id=&quot;legend&quot; style=&quot;margin-top:.5rem;color:#3399ff;display:flex;flex-wrap:wrap;gap:1rem;align-items:center;&quot;&gt;</span>
<span class="s2">    &lt;span style=&quot;display:inline-flex;align-items:center;gap:.4rem;&quot;&gt;</span>
<span class="s2">      &lt;span style=&quot;width:14px;height:14px;border-radius:50%;background:#ff8800;display:inline-block;&quot;&gt;&lt;/span&gt; Orange = current</span>
<span class="s2">    &lt;/span&gt;</span>
<span class="s2">    &lt;span style=&quot;display:inline-flex;align-items:center;gap:.4rem;&quot;&gt;</span>
<span class="s2">      &lt;span style=&quot;width:14px;height:14px;border-radius:50%;border:3px solid #ffd84d;box-sizing:border-box;display:inline-block;&quot;&gt;&lt;/span&gt; Yellow = best so far</span>
<span class="s2">    &lt;/span&gt;</span>
<span class="s2">    &lt;span style=&quot;display:inline-flex;align-items:center;gap:.4rem;&quot;&gt;</span>
<span class="s2">      &lt;span style=&quot;width:14px;height:14px;background:#ffdd57;display:inline-block;&quot;&gt;&lt;/span&gt; True optimum</span>
<span class="s2">    &lt;/span&gt;</span>
<span class="s2">    &lt;span style=&quot;display:inline-flex;align-items:center;gap:.4rem;&quot;&gt;</span>
<span class="s2">      &lt;span style=&quot;width:14px;height:14px;background:#ff6b6b;display:inline-block;&quot;&gt;&lt;/span&gt; Decoy optimum</span>
<span class="s2">    &lt;/span&gt;</span>
<span class="s2">  &lt;/div&gt;</span>

<span class="s2">  &lt;div id=&quot;ch-hud&quot; style=&quot;margin-top:.5rem;color:#3399ff;font-family:ui-monospace;&quot;&gt;&lt;/div&gt;</span>

<span class="s2">  &lt;details style=&quot;margin-top:1rem;background:#0f1329;border:1px solid #222;border-radius:10px;padding:.75rem;color:#e6e6e6;&quot; open&gt;</span>
<span class="s2">    &lt;summary style=&quot;cursor:pointer;font-weight:600;&quot;&gt;Define wall map (0 = wall, 1 = open)&lt;/summary&gt;</span>
<span class="s2">    &lt;div style=&quot;display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem;&quot;&gt;</span>
<span class="s2">      &lt;textarea id=&quot;mapText&quot; rows=&quot;12&quot; style=&quot;width:100%;background:#0b1021;color:#e6e6e6;border:1px solid #333;border-radius:8px;padding:.5rem;white-space:pre; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;&quot;&gt;</span>
<span class="s2">1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span>
<span class="s2">1 1 0 1 0 0 0 1 1 1 0 0 0 1 1 1 0 1 1 1 1 1 1 1 1</span>
<span class="s2">1 0 0 1 1 1 0 1 0 1 1 1 0 1 0 1 0 1 0 0 0 0 0 1 1</span>
<span class="s2">1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1 1 1 1 0 1 1</span>
<span class="s2">1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 0 0 0 0 1 0 1 1</span>
<span class="s2">1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1 1 1 1 0 1 0 1 1</span>
<span class="s2">1 1 0 1 0 1 1 1 0 1 0 1 0 1 0 0 0 0 0 1 0 1 0 1 1</span>
<span class="s2">0 1 0 1 0 1 0 1 0 1 0 1 0 1 1 1 1 1 0 1 0 1 0 1 1</span>
<span class="s2">0 1 0 1 0 1 0 1 0 1 0 1 0 0 0 0 0 1 0 1 0 1 0 1 1</span>
<span class="s2">1 1 0 1 0 1 0 0 0 1 0 1 1 1 1 1 0 1 0 1 0 1 0 1 1</span>
<span class="s2">1 1 0 1 1 1 0 1 0 0 0 1 0 0 0 1 0 1 0 1 0 1 0 1 1</span>
<span class="s2">1 1 0 1 0 1 0 1 1 1 1 1 0 1 0 1 0 1 0 1 0 1 0 1 1</span>
<span class="s2">1 1 0 1 0 1 0 0 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1</span>
<span class="s2">1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1</span>
<span class="s2">1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1</span>
<span class="s2">1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1</span>
<span class="s2">1 1 0 1 0 1 1 1 1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1</span>
<span class="s2">1 1 0 1 0 1 0 1 0 1 0 0 1 1 0 1 0 1 0 1 0 1 0 1 1</span>
<span class="s2">1 1 0 1 0 1 0 1 0 0 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1</span>
<span class="s2">1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1</span>
<span class="s2">1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1</span>
<span class="s2">1 1 0 1 1 1 0 0 0 1 1 1 0 1 0 1 1 1 0 1 1 1 0 1 1</span>
<span class="s2">1 1 0 0 0 0 0 1 1 1 0 0 0 1 1 1 0 1 1 1 1 1 0 1 1</span>
<span class="s2">1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span>
<span class="s2">      &lt;/textarea&gt;</span>
<span class="s2">      &lt;div style=&quot;display:flex;gap:.5rem;align-items:center;&quot;&gt;</span>
<span class="s2">        &lt;button id=&quot;loadMap&quot; style=&quot;padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Load map&lt;/button&gt;</span>
<span class="s2">        &lt;span style=&quot;opacity:.8;&quot;&gt;Tip: rows can be any size, just keep each row the same width.&lt;/span&gt;</span>
<span class="s2">      &lt;/div&gt;</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">  &lt;/details&gt;</span>

<span class="s2">  &lt;details style=&quot;margin-top:1rem;background:#0f1329;border:1px solid #222;border-radius:10px;padding:.75rem;color:#e6e6e6;&quot;&gt;</span>
<span class="s2">    &lt;summary style=&quot;cursor:pointer;font-weight:600;&quot;&gt;Reinforcement Learning demo&lt;/summary&gt;</span>
<span class="s2">    &lt;div style=&quot;margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.75rem;&quot;&gt;</span>
<span class="s2">      &lt;label style=&quot;display:flex;align-items:center;gap:.5rem;&quot;&gt;</span>
<span class="s2">        &lt;input type=&quot;checkbox&quot; id=&quot;ch-agent&quot;/&gt;</span>
<span class="s2">        Agent enabled</span>
<span class="s2">      &lt;/label&gt;</span>
<span class="s2">      &lt;label&gt;ε (explore): &lt;input id=&quot;ch-eps&quot; type=&quot;range&quot; min=&quot;0&quot; max=&quot;1&quot; step=&quot;0.01&quot; value=&quot;0.15&quot; style=&quot;width:140px;&quot;&gt;</span>
<span class="s2">        &lt;span id=&quot;ch-epsV&quot;&gt;0.15&lt;/span&gt;&lt;/label&gt;</span>
<span class="s2">      &lt;label&gt;α (learn rate): &lt;input id=&quot;ch-alpha&quot; type=&quot;range&quot; min=&quot;0&quot; max=&quot;1&quot; step=&quot;0.01&quot; value=&quot;0.25&quot; style=&quot;width:140px;&quot;&gt;</span>
<span class="s2">        &lt;span id=&quot;ch-alphaV&quot;&gt;0.25&lt;/span&gt;&lt;/label&gt;</span>
<span class="s2">      &lt;label&gt;γ (discount): &lt;input id=&quot;ch-gamma&quot; type=&quot;range&quot; min=&quot;0&quot; max=&quot;1&quot; step=&quot;0.01&quot; value=&quot;0.98&quot; style=&quot;width:140px;&quot;&gt;</span>
<span class="s2">        &lt;span id=&quot;ch-gammaV&quot;&gt;0.98&lt;/span&gt;&lt;/label&gt;</span>
<span class="s2">      &lt;button id=&quot;ch-train1&quot; style=&quot;padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Train 1 episode&lt;/button&gt;</span>
<span class="s2">      &lt;button id=&quot;ch-train50&quot; style=&quot;padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Train 50 episodes&lt;/button&gt;</span>
<span class="s2">      &lt;button id=&quot;ch-resetQ&quot; style=&quot;padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Reset Q-table&lt;/button&gt;</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">    &lt;div style=&quot;margin-top:.5rem;font-size:.95rem;opacity:.9;line-height:1.4;&quot;&gt;</span>
<span class="s2">      What it shows: a 2D (T, x) map with yield heatmap. 0 cells are black walls.</span>
<span class="s2">      Rewards: -1 per step, 0 at the true optimum, -2 at the decoy optimum.</span>
<span class="s2">      State: grid cell. Actions: Up, Down, Left, Right.</span>
<span class="s2">      ε greedy Q learning: &lt;code&gt;Q(s,a) ← Q(s,a) + α[r + γ max_a&#39; Q(s&#39;,a&#39;) − Q(s,a)]&lt;/code&gt;.</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">    &lt;div id=&quot;ch-stats&quot; style=&quot;margin-top:.5rem;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;&quot;&gt;&lt;/div&gt;</span>
<span class="s2">  &lt;/details&gt;</span>
<span class="s2">&lt;/div&gt;</span>

<span class="s2">&lt;script&gt;</span>
<span class="s2">(() =&gt; {</span>
<span class="s2">  // UI</span>
<span class="s2">  const cvs = document.getElementById(&#39;chem&#39;);</span>
<span class="s2">  const ctx = cvs.getContext(&#39;2d&#39;, {alpha:false});</span>
<span class="s2">  const startBtn = document.getElementById(&#39;ch-start&#39;);</span>
<span class="s2">  const pauseBtn = document.getElementById(&#39;ch-pause&#39;);</span>
<span class="s2">  const resetBtn = document.getElementById(&#39;ch-reset&#39;);</span>
<span class="s2">  const freezeEl = document.getElementById(&#39;ch-freeze&#39;);</span>
<span class="s2">  const autoEl = document.getElementById(&#39;ch-autonext&#39;);</span>
<span class="s2">  const hud = document.getElementById(&#39;ch-hud&#39;);</span>
<span class="s2">  const mapText = document.getElementById(&#39;mapText&#39;);</span>
<span class="s2">  const loadMapBtn = document.getElementById(&#39;loadMap&#39;);</span>

<span class="s2">  // RL panel</span>
<span class="s2">  const agentEl = document.getElementById(&#39;ch-agent&#39;);</span>
<span class="s2">  const epsEl = document.getElementById(&#39;ch-eps&#39;), epsV = document.getElementById(&#39;ch-epsV&#39;);</span>
<span class="s2">  const alphaEl = document.getElementById(&#39;ch-alpha&#39;), alphaV = document.getElementById(&#39;ch-alphaV&#39;);</span>
<span class="s2">  const gammaEl = document.getElementById(&#39;ch-gamma&#39;), gammaV = document.getElementById(&#39;ch-gammaV&#39;);</span>
<span class="s2">  const train1 = document.getElementById(&#39;ch-train1&#39;);</span>
<span class="s2">  const train50 = document.getElementById(&#39;ch-train50&#39;);</span>
<span class="s2">  const resetQBtn = document.getElementById(&#39;ch-resetQ&#39;);</span>
<span class="s2">  const stats = document.getElementById(&#39;ch-stats&#39;);</span>

<span class="s2">  // Training flags</span>
<span class="s2">  let training = false;</span>
<span class="s2">  let abortAgent = false;</span>

<span class="s2">  function syncVals(){</span>
<span class="s2">    epsV.textContent = Number(epsEl.value).toFixed(2);</span>
<span class="s2">    alphaV.textContent = Number(alphaEl.value).toFixed(2);</span>
<span class="s2">    gammaV.textContent = Number(gammaEl.value).toFixed(2);</span>
<span class="s2">  }</span>
<span class="s2">  epsEl.oninput = syncVals; alphaEl.oninput = syncVals; gammaEl.oninput = syncVals; syncVals();</span>

<span class="s2">  // Yield surface (friendlier colors). Independent of walls.</span>
<span class="s2">  function gauss2d(x, y, x0, y0, sx, sy, h){</span>
<span class="s2">    const dx=(x-x0)/sx, dy=(y-y0)/sy;</span>
<span class="s2">    return h*Math.exp(-0.5*(dx*dx + dy*dy));</span>
<span class="s2">  }</span>

<span class="s2">  // State</span>
<span class="s2">  let NT=0, NX=0, CELL=0, ORGX=0, ORGY=0;</span>
<span class="s2">  let EV=[], walls=[], s={i:0,j:0}, start={i:0,j:0};</span>
<span class="s2">  let trueOpt={i:0,j:0}, decoy={i:0,j:0};</span>

<span class="s2">  function parseMap(text){</span>
<span class="s2">    const rows = text.trim().split(/\n+/).map(r =&gt; r.trim().split(/\s+/).map(Number));</span>
<span class="s2">    const nx = rows[0].length;</span>
<span class="s2">    for(const r of rows) if(r.length!==nx) throw new Error(&quot;All rows must have the same number of columns.&quot;);</span>
<span class="s2">    for(const r of rows) for(const v of r) if(v!==0 &amp;&amp; v!==1) throw new Error(&quot;Only 0 or 1 allowed.&quot;);</span>
<span class="s2">    return rows; // [ny][nx]</span>
<span class="s2">  }</span>

<span class="s2">  function rebuildFromMatrix(M){</span>
<span class="s2">    const ny = M.length, nx = M[0].length;</span>
<span class="s2">    NT = ny; NX = nx;</span>
<span class="s2">    CELL = Math.floor(Math.min(cvs.width/NT, cvs.height/NX));</span>
<span class="s2">    ORGX = Math.floor((cvs.width - CELL*NX)/2);</span>
<span class="s2">    ORGY = Math.floor((cvs.height - CELL*NT)/2);</span>

<span class="s2">    walls = Array.from({length:NT}, (_,i)=&gt;Array.from({length:NX}, (_,j)=&gt;M[i][j]===0));</span>

<span class="s2">    // Build a smooth yield surface that respects grid size</span>
<span class="s2">    const T_min=80, T_max=160, x_min=0.0, x_max=1.0;</span>
<span class="s2">    function T_of(i){ return T_min + (T_max - T_min) * i/(NT-1 || 1); }</span>
<span class="s2">    function x_of(j){ return x_min + (x_max - x_min) * j/(NX-1 || 1); }</span>
<span class="s2">    const truePos = {T: 118, x: 0.28}, decPos = {T: 145, x: 0.78};</span>
<span class="s2">    EV = Array.from({length:NT}, ()=&gt;Array(NX).fill(0));</span>
<span class="s2">    for(let i=0;i&lt;NT;i++){</span>
<span class="s2">      for(let j=0;j&lt;NX;j++){</span>
<span class="s2">        const T = T_of(i), x = x_of(j);</span>
<span class="s2">        let v = 0.04</span>
<span class="s2">          + gauss2d(T, x, truePos.T, truePos.x, 9.0, 0.06, 0.58)</span>
<span class="s2">          + gauss2d(T, x, decPos.T,  decPos.x, 11.0, 0.09, 0.36);</span>
<span class="s2">        v += 0.03 * Math.sin((i/NT)*Math.PI) * (1 - j/(NX-1 || 1));</span>
<span class="s2">        v = Math.max(0, Math.min(1, v));</span>
<span class="s2">        if(walls[i][j]) v = 0;</span>
<span class="s2">        EV[i][j] = v;</span>
<span class="s2">      }</span>
<span class="s2">    }</span>

<span class="s2">    // Choose start</span>
<span class="s2">    start = {i: NT-1, j: 0};</span>
<span class="s2">    if(walls[start.i][start.j]){</span>
<span class="s2">      let found=false;</span>
<span class="s2">      for(let ii=NT-1; ii&gt;=0; ii--){</span>
<span class="s2">        if(!walls[ii][0]){ start={i:ii,j:0}; found=true; break; }</span>
<span class="s2">      }</span>
<span class="s2">      if(!found){</span>
<span class="s2">        outer: for(let ii=NT-1; ii&gt;=0; ii--) for(let jj=0; jj&lt;NX; jj++) if(!walls[ii][jj]){ start={i:ii,j:jj}; break outer; }</span>
<span class="s2">      }</span>
<span class="s2">    }</span>
<span class="s2">    s = {...start};</span>

<span class="s2">    // Place true and decoy near EV maxima but on open cells</span>
<span class="s2">    function nearestOpen(ii,jj){</span>
<span class="s2">      if(!walls[ii][jj]) return {i:ii,j:jj};</span>
<span class="s2">      const q=[[ii,jj]], seen=new Set([`$</span><span class="si">{ii}</span><span class="s2">,$</span><span class="si">{jj}</span><span class="s2">`]);</span>
<span class="s2">      while(q.length){</span>
<span class="s2">        const [ci,cj]=q.shift();</span>
<span class="s2">        for(const [di,dj] of [[1,0],[-1,0],[0,1],[0,-1]]){</span>
<span class="s2">          const ni=ci+di, nj=cj+dj;</span>
<span class="s2">          if(ni&lt;0||nj&lt;0||ni&gt;=NT||nj&gt;=NX) continue;</span>
<span class="s2">          const k=`$</span><span class="si">{ni}</span><span class="s2">,$</span><span class="si">{nj}</span><span class="s2">`; if(seen.has(k)) continue;</span>
<span class="s2">          if(!walls[ni][nj]) return {i:ni,j:nj};</span>
<span class="s2">          seen.add(k); q.push([ni,nj]);</span>
<span class="s2">        }</span>
<span class="s2">      }</span>
<span class="s2">      return {i:ii,j:jj};</span>
<span class="s2">    }</span>
<span class="s2">    const tI = Math.round((truePos.T-80)/(160-80)*(NT-1 || 1));</span>
<span class="s2">    const tJ = Math.round((truePos.x-0)/(1-0)*(NX-1 || 1));</span>
<span class="s2">    const dI = Math.round((decPos.T-80)/(160-80)*(NT-1 || 1));</span>
<span class="s2">    const dJ = Math.round((decPos.x-0)/(1-0)*(NX-1 || 1));</span>
<span class="s2">    trueOpt = nearestOpen(Math.max(0,Math.min(NT-1,tI)), Math.max(0,Math.min(NX-1,tJ)));</span>
<span class="s2">    decoy   = nearestOpen(Math.max(0,Math.min(NT-1,dI)), Math.max(0,Math.min(NX-1,dJ)));</span>

<span class="s2">    resetGame();</span>
<span class="s2">    draw();</span>
<span class="s2">  }</span>

<span class="s2">  // Default load</span>
<span class="s2">  try { rebuildFromMatrix(parseMap(mapText.value)); } catch(e){ console.error(e); }</span>

<span class="s2">  // Controls</span>
<span class="s2">  let running=false, paused=false;</span>
<span class="s2">  const keys = {l:false,r:false,u:false,d:false};</span>

<span class="s2">  // Stop agent helper</span>
<span class="s2">  function stopAgent(reason = &quot;&quot;){</span>
<span class="s2">    abortAgent = true;</span>
<span class="s2">    training = false;</span>
<span class="s2">    agentEl.checked = false;</span>
<span class="s2">    if(reason) stats.textContent = reason;</span>
<span class="s2">  }</span>

<span class="s2">  function setKey(e, down){</span>
<span class="s2">    const k = e.key || e.code;</span>

<span class="s2">    // Always allow pause and reset</span>
<span class="s2">    if(down){</span>
<span class="s2">      if(k===&#39;p&#39; || k===&#39;P&#39;){</span>
<span class="s2">        paused = !paused;</span>
<span class="s2">      }</span>
<span class="s2">      if(k===&#39;r&#39; || k===&#39;R&#39;){</span>
<span class="s2">        if(training || agentEl.checked) stopAgent(&quot;Agent stopped by Reset.&quot;);</span>
<span class="s2">        resetGame();</span>
<span class="s2">      }</span>
<span class="s2">    }</span>

<span class="s2">    // Block manual movement when agent is on or frozen</span>
<span class="s2">    const blockMove = agentEl.checked || freezeEl.checked;</span>
<span class="s2">    if(!blockMove){</span>
<span class="s2">      if(k===&#39;ArrowLeft&#39;||k===&#39;Left&#39;){ keys.l=down; e.preventDefault(); }</span>
<span class="s2">      if(k===&#39;ArrowRight&#39;||k===&#39;Right&#39;){ keys.r=down; e.preventDefault(); }</span>
<span class="s2">      if(k===&#39;ArrowUp&#39;||k===&#39;Up&#39;){ keys.u=down; e.preventDefault(); }</span>
<span class="s2">      if(k===&#39;ArrowDown&#39;||k===&#39;Down&#39;){ keys.d=down; e.preventDefault(); }</span>
<span class="s2">    }</span>
<span class="s2">  }</span>
<span class="s2">  cvs.tabIndex=0;</span>
<span class="s2">  cvs.addEventListener(&#39;keydown&#39;, e=&gt;setKey(e,true));</span>
<span class="s2">  cvs.addEventListener(&#39;keyup&#39;, e=&gt;setKey(e,false));</span>
<span class="s2">  document.addEventListener(&#39;keydown&#39;, e=&gt;{ if(document.activeElement===cvs) setKey(e,true); });</span>
<span class="s2">  document.addEventListener(&#39;keyup&#39;, e=&gt;{ if(document.activeElement===cvs) setKey(e,false); });</span>
<span class="s2">  cvs.addEventListener(&#39;mousedown&#39;, ()=&gt;cvs.focus());</span>
<span class="s2">  loadMapBtn.onclick = ()=&gt;{</span>
<span class="s2">    try{</span>
<span class="s2">      const M = parseMap(mapText.value);</span>
<span class="s2">      Q = new Map(); stats.textContent = &quot;Q-table cleared.&quot;;</span>
<span class="s2">      rebuildFromMatrix(M);</span>
<span class="s2">    }catch(err){</span>
<span class="s2">      alert(&quot;Parse error: &quot; + err.message);</span>
<span class="s2">    }</span>
<span class="s2">  };</span>

<span class="s2">  // Movement and RL</span>
<span class="s2">  const ACTIONS = [{di:-1,dj:0},{di:1,dj:0},{di:0,dj:1},{di:0,dj:-1}];</span>
<span class="s2">  function canMove(i,j){ return !(i&lt;0||i&gt;=NT||j&lt;0||j&gt;=NX||walls[i][j]); }</span>

<span class="s2">  // Rewards</span>
<span class="s2">  function reward(i,j){</span>
<span class="s2">    if(i===trueOpt.i &amp;&amp; j===trueOpt.j) return 100;</span>
<span class="s2">    if(i===decoy.i &amp;&amp; j===decoy.j) return -50;</span>
<span class="s2">    return -1;</span>
<span class="s2">  }</span>

<span class="s2">  // Q table</span>
<span class="s2">  let Q = new Map(); // &quot;i,j&quot; -&gt; Float32Array(4)</span>
<span class="s2">  function qGet(i,j){ const k=`$</span><span class="si">{i}</span><span class="s2">,$</span><span class="si">{j}</span><span class="s2">`; if(!Q.has(k)) Q.set(k,new Float32Array(4)); return Q.get(k); }</span>
<span class="s2">  function argmax(a){ let m=a[0], mi=0; for(let k=1;k&lt;a.length;k++){ if(a[k]&gt;m){m=a[k]; mi=k;} } return mi; }</span>

<span class="s2">  // Episode stats</span>
<span class="s2">  let epSteps=0, epReturn=0, episodes=0, experiments=0;</span>
<span class="s2">  let bestAt={i:0,j:0}, bestVal=0;</span>

<span class="s2">  function resetGame(){</span>
<span class="s2">    // start at first open on left edge else any open</span>
<span class="s2">    start = {i:NT-1, j:0};</span>
<span class="s2">    if(walls[start.i][start.j]){</span>
<span class="s2">      let found=false;</span>
<span class="s2">      for(let ii=NT-1; ii&gt;=0; ii--){</span>
<span class="s2">        if(!walls[ii][0]){ start={i:ii,j:0}; found=true; break; }</span>
<span class="s2">      }</span>
<span class="s2">      if(!found){</span>
<span class="s2">        outer: for(let ii=NT-1; ii&gt;=0; ii--) for(let jj=0; jj&lt;NX; jj++) if(!walls[ii][jj]){ start={i:ii,j:jj}; break outer; }</span>
<span class="s2">      }</span>
<span class="s2">    }</span>
<span class="s2">    s = {...start};</span>
<span class="s2">    epSteps=0; epReturn=0; experiments=0;</span>
<span class="s2">    bestAt = {...s}; bestVal = EV[s.i][s.j];</span>
<span class="s2">    paused=false;</span>
<span class="s2">  }</span>

<span class="s2">  function agentStep(){</span>
<span class="s2">    const eps = Number(epsEl.value), alpha = Number(alphaEl.value), gamma = Number(gammaEl.value);</span>
<span class="s2">    const q = qGet(s.i,s.j);</span>
<span class="s2">    const aIdx = Math.random()&lt;eps ? Math.floor(Math.random()*ACTIONS.length) : argmax(q);</span>
<span class="s2">    const a = ACTIONS[aIdx];</span>
<span class="s2">    let ni=s.i+a.di, nj=s.j+a.dj;</span>
<span class="s2">    if(!canMove(ni,nj)){ ni=s.i; nj=s.j; }</span>
<span class="s2">    const r = reward(ni,nj);</span>
<span class="s2">    const q2 = qGet(ni,nj);</span>
<span class="s2">    const tdTarget = r + gamma * Math.max(q2[0],q2[1],q2[2],q2[3]);</span>
<span class="s2">    q[aIdx] = q[aIdx] + alpha * (tdTarget - q[aIdx]);</span>
<span class="s2">    s={i:ni,j:nj};</span>
<span class="s2">    epSteps++; epReturn+=r; experiments++;</span>
<span class="s2">    const val = EV[s.i][s.j]; if(val&gt;bestVal){ bestVal=val; bestAt={...s}; }</span>
<span class="s2">  }</span>

<span class="s2">  let tick=0;</span>
<span class="s2">  function humanStep(){</span>
<span class="s2">    tick=(tick+1)%8; if(tick!==0) return;</span>
<span class="s2">    let ni=s.i, nj=s.j;</span>
<span class="s2">    if(keys.l) nj--; if(keys.r) nj++; if(keys.u) ni--; if(keys.d) ni++;</span>
<span class="s2">    if(canMove(ni,nj)){</span>
<span class="s2">      s={i:ni,j:nj}; experiments++;</span>
<span class="s2">      const val = EV[s.i][s.j]; if(val&gt;bestVal){ bestVal=val; bestAt={...s}; }</span>
<span class="s2">    }</span>
<span class="s2">  }</span>

<span class="s2">  // Drawing</span>
<span class="s2">  function colorFor(v){</span>
<span class="s2">    if(v&lt;=0) return &quot;#000&quot;;</span>
<span class="s2">    const t = Math.max(0, Math.min(1, v));</span>
<span class="s2">    const r = Math.floor(255 * Math.min(1, Math.max(0, 2*(t-0.5))));</span>
<span class="s2">    const g = Math.floor(255 * Math.min(1, Math.max(0, 2*t)));</span>
<span class="s2">    const b = Math.floor(255 * Math.min(1, Math.max(0, 1-2*t)));</span>
<span class="s2">    return `rgb($</span><span class="si">{r}</span><span class="s2">,$</span><span class="si">{g}</span><span class="s2">,$</span><span class="si">{b}</span><span class="s2">)`;</span>
<span class="s2">  }</span>
<span class="s2">  function draw(){</span>
<span class="s2">    // sizes</span>
<span class="s2">    CELL = Math.floor(Math.min(cvs.width/NX, cvs.height/NT));</span>
<span class="s2">    ORGX = Math.floor((cvs.width - CELL*NX)/2);</span>
<span class="s2">    ORGY = Math.floor((cvs.height - CELL*NT)/2);</span>

<span class="s2">    // cells</span>
<span class="s2">    for(let i=0;i&lt;NT;i++){</span>
<span class="s2">      for(let j=0;j&lt;NX;j++){</span>
<span class="s2">        const v = walls[i][j] ? 0 : EV[i][j];</span>
<span class="s2">        ctx.fillStyle = v&lt;=0 ? &quot;#000&quot; : colorFor(v);</span>
<span class="s2">        ctx.fillRect(ORGX+j*CELL, ORGY+i*CELL, CELL, CELL);</span>
<span class="s2">      }</span>
<span class="s2">    }</span>
<span class="s2">    // grid</span>
<span class="s2">    ctx.strokeStyle = &quot;rgba(255,255,255,.08)&quot;;</span>
<span class="s2">    for(let i=0;i&lt;=NT;i++){ ctx.beginPath(); ctx.moveTo(ORGX, ORGY+i*CELL); ctx.lineTo(ORGX+NX*CELL, ORGY+i*CELL); ctx.stroke(); }</span>
<span class="s2">    for(let j=0;j&lt;=NX;j++){ ctx.beginPath(); ctx.moveTo(ORGX+j*CELL, ORGY); ctx.lineTo(ORGX+j*CELL, ORGY+NT*CELL); ctx.stroke(); }</span>

<span class="s2">    // goals</span>
<span class="s2">    ctx.fillStyle=&quot;#ffdd57&quot;; ctx.fillRect(ORGX+trueOpt.j*CELL+CELL*0.25, ORGY+trueOpt.i*CELL+CELL*0.25, CELL*0.5, CELL*0.5);</span>
<span class="s2">    ctx.fillStyle=&quot;#ff6b6b&quot;; ctx.fillRect(ORGX+decoy.j*CELL+CELL*0.3, ORGY+decoy.i*CELL+CELL*0.3, CELL*0.4, CELL*0.4);</span>

<span class="s2">    // best so far (yellow ring)</span>
<span class="s2">    ctx.strokeStyle=&quot;#ffd84d&quot;; ctx.lineWidth=Math.max(2, CELL*0.09);</span>
<span class="s2">    ctx.beginPath();</span>
<span class="s2">    ctx.arc(ORGX+bestAt.j*CELL+CELL/2, ORGY+bestAt.i*CELL+CELL/2, CELL*0.32, 0, Math.PI*2);</span>
<span class="s2">    ctx.stroke();</span>

<span class="s2">    // current (orange dot)</span>
<span class="s2">    ctx.fillStyle=&quot;#ff8800&quot;;</span>
<span class="s2">    ctx.beginPath();</span>
<span class="s2">    ctx.arc(ORGX+s.j*CELL+CELL/2, ORGY+s.i*CELL+CELL/2, CELL*0.28, 0, Math.PI*2);</span>
<span class="s2">    ctx.fill();</span>

<span class="s2">    // HUD</span>
<span class="s2">    const here = EV[s.i][s.j].toFixed(3), best = EV[bestAt.i][bestAt.j].toFixed(3);</span>
<span class="s2">    hud.textContent = `Experiments: $</span><span class="si">{experiments}</span><span class="s2"> | Here cell=($</span><span class="si">{s.i}</span><span class="s2">,$</span><span class="si">{s.j}</span><span class="s2">) yield≈$</span><span class="si">{here}</span><span class="s2"> | Best cell=($</span><span class="si">{bestAt.i}</span><span class="s2">,$</span><span class="si">{bestAt.j}</span><span class="s2">) yield≈$</span><span class="si">{best}</span><span class="s2">`;</span>
<span class="s2">  }</span>

<span class="s2">  function onEpisodeEnd(kind){</span>
<span class="s2">    episodes += 1;</span>
<span class="s2">    stats.textContent = `Episodes: $</span><span class="si">{episodes}</span><span class="s2"> | Steps: $</span><span class="si">{epSteps}</span><span class="s2"> | Return: ${epReturn.toFixed(2)} | Q-states: $</span><span class="si">{Q.size}</span><span class="s2"> | End: $</span><span class="si">{kind}</span><span class="s2">`;</span>
<span class="s2">    if(autoEl.checked){ resetGame(); running=true; } else { running=false; }</span>
<span class="s2">  }</span>

<span class="s2">  function update(){</span>
<span class="s2">    if(agentEl.checked &amp;&amp; !freezeEl.checked) agentStep(); else humanStep();</span>
<span class="s2">    if(agentEl.checked){</span>
<span class="s2">      if(s.i===trueOpt.i &amp;&amp; s.j===trueOpt.j) onEpisodeEnd(&quot;true&quot;);</span>
<span class="s2">      else if(s.i===decoy.i &amp;&amp; s.j===decoy.j) onEpisodeEnd(&quot;decoy&quot;);</span>
<span class="s2">    }</span>
<span class="s2">  }</span>

<span class="s2">  function loop(){ if(running &amp;&amp; !paused) update(); draw(); requestAnimationFrame(loop); }</span>

<span class="s2">  // Buttons</span>
<span class="s2">  startBtn.onclick=()=&gt;{ running=true; paused=false; cvs.focus(); };</span>
<span class="s2">  pauseBtn.onclick=()=&gt;{ if(running){ paused=!paused; cvs.focus(); } };</span>
<span class="s2">  resetBtn.onclick=()=&gt;{ if(training || agentEl.checked) stopAgent(&quot;Agent stopped by Reset.&quot;); resetGame(); cvs.focus(); };</span>

<span class="s2">  // Disable agent mid training</span>
<span class="s2">  agentEl.addEventListener(&#39;change&#39;, ()=&gt;{</span>
<span class="s2">    if(!agentEl.checked &amp;&amp; training){</span>
<span class="s2">      stopAgent(&quot;Agent disabled.&quot;);</span>
<span class="s2">    }</span>
<span class="s2">  });</span>

<span class="s2">  function resetQ(){ Q = new Map(); stats.textContent = &quot;Q-table cleared.&quot;; }</span>
<span class="s2">  resetQBtn.onclick = resetQ;</span>

<span class="s2">  async function runEpisode(maxSteps=2000){</span>
<span class="s2">    const prevAuto = autoEl.checked; autoEl.checked=false;</span>
<span class="s2">    const prevRun=running, prevPause=paused, prevAgent=agentEl.checked, prevFreeze=freezeEl.checked;</span>
<span class="s2">    agentEl.checked = true; freezeEl.checked = false;</span>
<span class="s2">    resetGame(); running = true; paused = false;</span>

<span class="s2">    let steps=0;</span>
<span class="s2">    abortAgent = false;</span>
<span class="s2">    training = true;</span>

<span class="s2">    await new Promise(resolve=&gt;{</span>
<span class="s2">      function cleanup(){</span>
<span class="s2">        const endKind = (s.i===trueOpt.i &amp;&amp; s.j===trueOpt.j) ? &quot;true&quot; : ((s.i===decoy.i &amp;&amp; s.j===decoy.j) ? &quot;decoy&quot; : &quot;limit&quot;);</span>
<span class="s2">        onEpisodeEnd(endKind);</span>
<span class="s2">        running=prevRun; paused=prevPause; agentEl.checked=prevAgent &amp;&amp; !abortAgent; freezeEl.checked=prevFreeze; autoEl.checked=prevAuto;</span>
<span class="s2">        training = false;</span>
<span class="s2">      }</span>
<span class="s2">      function tick(){</span>
<span class="s2">        if(abortAgent){</span>
<span class="s2">          cleanup();</span>
<span class="s2">          resolve();</span>
<span class="s2">          return;</span>
<span class="s2">        }</span>
<span class="s2">        if(paused){</span>
<span class="s2">          requestAnimationFrame(tick);</span>
<span class="s2">          return;</span>
<span class="s2">        }</span>
<span class="s2">        if(steps&gt;=maxSteps || (s.i===trueOpt.i &amp;&amp; s.j===trueOpt.j) || (s.i===decoy.i &amp;&amp; s.j===decoy.j)){</span>
<span class="s2">          cleanup();</span>
<span class="s2">          resolve();</span>
<span class="s2">          return;</span>
<span class="s2">        }</span>
<span class="s2">        agentStep(); draw(); steps++; requestAnimationFrame(tick);</span>
<span class="s2">      }</span>
<span class="s2">      requestAnimationFrame(tick);</span>
<span class="s2">    });</span>
<span class="s2">  }</span>

<span class="s2">  // Train buttons</span>
<span class="s2">  train1.onclick = async ()=&gt;{ await runEpisode(1200); };</span>
<span class="s2">  train50.onclick = async ()=&gt;{</span>
<span class="s2">    for(let k=0;k&lt;50;k++){</span>
<span class="s2">      if(abortAgent) break;</span>
<span class="s2">      await runEpisode(1200);</span>
<span class="s2">    }</span>
<span class="s2">  };</span>

<span class="s2">  // Init</span>
<span class="s2">  resetGame();</span>
<span class="s2">  loop();</span>
<span class="s2">})();</span>
<span class="s2">&lt;/script&gt;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html">
<div id="chem-container" style="font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 1rem 0;">
  <div style="display:flex;flex-wrap:wrap;align-items:center;gap:.5rem;margin-bottom:.5rem;">
    <button id="ch-start" style="padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Start</button>
    <button id="ch-pause" style="padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Pause</button>
    <button id="ch-reset" style="padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Reset</button>
    <label style="display:flex;align-items:center;gap:.35rem;color:#ddd;">
      <input type="checkbox" id="ch-freeze"/> Don’t move (freeze agent)
    </label>
    <label style="display:flex;align-items:center;gap:.35rem;color:#ddd;">
      <input type="checkbox" id="ch-autonext"/> Auto-continue episodes
    </label>
    <span style="opacity:.85;">Manual: ←/→/↑/↓. R resets. P pauses. Click the canvas to focus.</span>
  </div>

  <canvas id="chem" width="660" height="660" style="max-width:100%;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);background:#000;display:block;outline:none;"></canvas>

  <div id="legend" style="margin-top:.5rem;color:#3399ff;display:flex;flex-wrap:wrap;gap:1rem;align-items:center;">
    <span style="display:inline-flex;align-items:center;gap:.4rem;">
      <span style="width:14px;height:14px;border-radius:50%;background:#ff8800;display:inline-block;"></span> Orange = current
    </span>
    <span style="display:inline-flex;align-items:center;gap:.4rem;">
      <span style="width:14px;height:14px;border-radius:50%;border:3px solid #ffd84d;box-sizing:border-box;display:inline-block;"></span> Yellow = best so far
    </span>
    <span style="display:inline-flex;align-items:center;gap:.4rem;">
      <span style="width:14px;height:14px;background:#ffdd57;display:inline-block;"></span> True optimum
    </span>
    <span style="display:inline-flex;align-items:center;gap:.4rem;">
      <span style="width:14px;height:14px;background:#ff6b6b;display:inline-block;"></span> Decoy optimum
    </span>
  </div>

  <div id="ch-hud" style="margin-top:.5rem;color:#3399ff;font-family:ui-monospace;"></div>

  <details style="margin-top:1rem;background:#0f1329;border:1px solid #222;border-radius:10px;padding:.75rem;color:#e6e6e6;" open>
    <summary style="cursor:pointer;font-weight:600;">Define wall map (0 = wall, 1 = open)</summary>
    <div style="display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem;">
      <textarea id="mapText" rows="12" style="width:100%;background:#0b1021;color:#e6e6e6;border:1px solid #333;border-radius:8px;padding:.5rem;white-space:pre; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;">
1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
1 1 0 1 0 0 0 1 1 1 0 0 0 1 1 1 0 1 1 1 1 1 1 1 1
1 0 0 1 1 1 0 1 0 1 1 1 0 1 0 1 0 1 0 0 0 0 0 1 1
1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1 1 1 1 0 1 1
1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 0 0 0 0 1 0 1 1
1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1 1 1 1 0 1 0 1 1
1 1 0 1 0 1 1 1 0 1 0 1 0 1 0 0 0 0 0 1 0 1 0 1 1
0 1 0 1 0 1 0 1 0 1 0 1 0 1 1 1 1 1 0 1 0 1 0 1 1
0 1 0 1 0 1 0 1 0 1 0 1 0 0 0 0 0 1 0 1 0 1 0 1 1
1 1 0 1 0 1 0 0 0 1 0 1 1 1 1 1 0 1 0 1 0 1 0 1 1
1 1 0 1 1 1 0 1 0 0 0 1 0 0 0 1 0 1 0 1 0 1 0 1 1
1 1 0 1 0 1 0 1 1 1 1 1 0 1 0 1 0 1 0 1 0 1 0 1 1
1 1 0 1 0 1 0 0 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1
1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1
1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1
1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1
1 1 0 1 0 1 1 1 1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1
1 1 0 1 0 1 0 1 0 1 0 0 1 1 0 1 0 1 0 1 0 1 0 1 1
1 1 0 1 0 1 0 1 0 0 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1
1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1
1 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 1
1 1 0 1 1 1 0 0 0 1 1 1 0 1 0 1 1 1 0 1 1 1 0 1 1
1 1 0 0 0 0 0 1 1 1 0 0 0 1 1 1 0 1 1 1 1 1 0 1 1
1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      </textarea>
      <div style="display:flex;gap:.5rem;align-items:center;">
        <button id="loadMap" style="padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Load map</button>
        <span style="opacity:.8;">Tip: rows can be any size, just keep each row the same width.</span>
      </div>
    </div>
  </details>

  <details style="margin-top:1rem;background:#0f1329;border:1px solid #222;border-radius:10px;padding:.75rem;color:#e6e6e6;">
    <summary style="cursor:pointer;font-weight:600;">Reinforcement Learning demo</summary>
    <div style="margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.75rem;">
      <label style="display:flex;align-items:center;gap:.5rem;">
        <input type="checkbox" id="ch-agent"/>
        Agent enabled
      </label>
      <label>ε (explore): <input id="ch-eps" type="range" min="0" max="1" step="0.01" value="0.15" style="width:140px;">
        <span id="ch-epsV">0.15</span></label>
      <label>α (learn rate): <input id="ch-alpha" type="range" min="0" max="1" step="0.01" value="0.25" style="width:140px;">
        <span id="ch-alphaV">0.25</span></label>
      <label>γ (discount): <input id="ch-gamma" type="range" min="0" max="1" step="0.01" value="0.98" style="width:140px;">
        <span id="ch-gammaV">0.98</span></label>
      <button id="ch-train1" style="padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Train 1 episode</button>
      <button id="ch-train50" style="padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Train 50 episodes</button>
      <button id="ch-resetQ" style="padding:.35rem .6rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Reset Q-table</button>
    </div>
    <div style="margin-top:.5rem;font-size:.95rem;opacity:.9;line-height:1.4;">
      What it shows: a 2D (T, x) map with yield heatmap. 0 cells are black walls.
      Rewards: -1 per step, 0 at the true optimum, -2 at the decoy optimum.
      State: grid cell. Actions: Up, Down, Left, Right.
      ε greedy Q learning: <code>Q(s,a) ← Q(s,a) + α[r + γ max_a' Q(s',a') − Q(s,a)]</code>.
    </div>
    <div id="ch-stats" style="margin-top:.5rem;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;"></div>
  </details>
</div>

<script>
(() => {
  // UI
  const cvs = document.getElementById('chem');
  const ctx = cvs.getContext('2d', {alpha:false});
  const startBtn = document.getElementById('ch-start');
  const pauseBtn = document.getElementById('ch-pause');
  const resetBtn = document.getElementById('ch-reset');
  const freezeEl = document.getElementById('ch-freeze');
  const autoEl = document.getElementById('ch-autonext');
  const hud = document.getElementById('ch-hud');
  const mapText = document.getElementById('mapText');
  const loadMapBtn = document.getElementById('loadMap');

  // RL panel
  const agentEl = document.getElementById('ch-agent');
  const epsEl = document.getElementById('ch-eps'), epsV = document.getElementById('ch-epsV');
  const alphaEl = document.getElementById('ch-alpha'), alphaV = document.getElementById('ch-alphaV');
  const gammaEl = document.getElementById('ch-gamma'), gammaV = document.getElementById('ch-gammaV');
  const train1 = document.getElementById('ch-train1');
  const train50 = document.getElementById('ch-train50');
  const resetQBtn = document.getElementById('ch-resetQ');
  const stats = document.getElementById('ch-stats');

  // Training flags
  let training = false;
  let abortAgent = false;

  function syncVals(){
    epsV.textContent = Number(epsEl.value).toFixed(2);
    alphaV.textContent = Number(alphaEl.value).toFixed(2);
    gammaV.textContent = Number(gammaEl.value).toFixed(2);
  }
  epsEl.oninput = syncVals; alphaEl.oninput = syncVals; gammaEl.oninput = syncVals; syncVals();

  // Yield surface (friendlier colors). Independent of walls.
  function gauss2d(x, y, x0, y0, sx, sy, h){
    const dx=(x-x0)/sx, dy=(y-y0)/sy;
    return h*Math.exp(-0.5*(dx*dx + dy*dy));
  }

  // State
  let NT=0, NX=0, CELL=0, ORGX=0, ORGY=0;
  let EV=[], walls=[], s={i:0,j:0}, start={i:0,j:0};
  let trueOpt={i:0,j:0}, decoy={i:0,j:0};

  function parseMap(text){
    const rows = text.trim().split(/\n+/).map(r => r.trim().split(/\s+/).map(Number));
    const nx = rows[0].length;
    for(const r of rows) if(r.length!==nx) throw new Error("All rows must have the same number of columns.");
    for(const r of rows) for(const v of r) if(v!==0 && v!==1) throw new Error("Only 0 or 1 allowed.");
    return rows; // [ny][nx]
  }

  function rebuildFromMatrix(M){
    const ny = M.length, nx = M[0].length;
    NT = ny; NX = nx;
    CELL = Math.floor(Math.min(cvs.width/NT, cvs.height/NX));
    ORGX = Math.floor((cvs.width - CELL*NX)/2);
    ORGY = Math.floor((cvs.height - CELL*NT)/2);

    walls = Array.from({length:NT}, (_,i)=>Array.from({length:NX}, (_,j)=>M[i][j]===0));

    // Build a smooth yield surface that respects grid size
    const T_min=80, T_max=160, x_min=0.0, x_max=1.0;
    function T_of(i){ return T_min + (T_max - T_min) * i/(NT-1 || 1); }
    function x_of(j){ return x_min + (x_max - x_min) * j/(NX-1 || 1); }
    const truePos = {T: 118, x: 0.28}, decPos = {T: 145, x: 0.78};
    EV = Array.from({length:NT}, ()=>Array(NX).fill(0));
    for(let i=0;i<NT;i++){
      for(let j=0;j<NX;j++){
        const T = T_of(i), x = x_of(j);
        let v = 0.04
          + gauss2d(T, x, truePos.T, truePos.x, 9.0, 0.06, 0.58)
          + gauss2d(T, x, decPos.T,  decPos.x, 11.0, 0.09, 0.36);
        v += 0.03 * Math.sin((i/NT)*Math.PI) * (1 - j/(NX-1 || 1));
        v = Math.max(0, Math.min(1, v));
        if(walls[i][j]) v = 0;
        EV[i][j] = v;
      }
    }

    // Choose start
    start = {i: NT-1, j: 0};
    if(walls[start.i][start.j]){
      let found=false;
      for(let ii=NT-1; ii>=0; ii--){
        if(!walls[ii][0]){ start={i:ii,j:0}; found=true; break; }
      }
      if(!found){
        outer: for(let ii=NT-1; ii>=0; ii--) for(let jj=0; jj<NX; jj++) if(!walls[ii][jj]){ start={i:ii,j:jj}; break outer; }
      }
    }
    s = {...start};

    // Place true and decoy near EV maxima but on open cells
    function nearestOpen(ii,jj){
      if(!walls[ii][jj]) return {i:ii,j:jj};
      const q=[[ii,jj]], seen=new Set([`${ii},${jj}`]);
      while(q.length){
        const [ci,cj]=q.shift();
        for(const [di,dj] of [[1,0],[-1,0],[0,1],[0,-1]]){
          const ni=ci+di, nj=cj+dj;
          if(ni<0||nj<0||ni>=NT||nj>=NX) continue;
          const k=`${ni},${nj}`; if(seen.has(k)) continue;
          if(!walls[ni][nj]) return {i:ni,j:nj};
          seen.add(k); q.push([ni,nj]);
        }
      }
      return {i:ii,j:jj};
    }
    const tI = Math.round((truePos.T-80)/(160-80)*(NT-1 || 1));
    const tJ = Math.round((truePos.x-0)/(1-0)*(NX-1 || 1));
    const dI = Math.round((decPos.T-80)/(160-80)*(NT-1 || 1));
    const dJ = Math.round((decPos.x-0)/(1-0)*(NX-1 || 1));
    trueOpt = nearestOpen(Math.max(0,Math.min(NT-1,tI)), Math.max(0,Math.min(NX-1,tJ)));
    decoy   = nearestOpen(Math.max(0,Math.min(NT-1,dI)), Math.max(0,Math.min(NX-1,dJ)));

    resetGame();
    draw();
  }

  // Default load
  try { rebuildFromMatrix(parseMap(mapText.value)); } catch(e){ console.error(e); }

  // Controls
  let running=false, paused=false;
  const keys = {l:false,r:false,u:false,d:false};

  // Stop agent helper
  function stopAgent(reason = ""){
    abortAgent = true;
    training = false;
    agentEl.checked = false;
    if(reason) stats.textContent = reason;
  }

  function setKey(e, down){
    const k = e.key || e.code;

    // Always allow pause and reset
    if(down){
      if(k==='p' || k==='P'){
        paused = !paused;
      }
      if(k==='r' || k==='R'){
        if(training || agentEl.checked) stopAgent("Agent stopped by Reset.");
        resetGame();
      }
    }

    // Block manual movement when agent is on or frozen
    const blockMove = agentEl.checked || freezeEl.checked;
    if(!blockMove){
      if(k==='ArrowLeft'||k==='Left'){ keys.l=down; e.preventDefault(); }
      if(k==='ArrowRight'||k==='Right'){ keys.r=down; e.preventDefault(); }
      if(k==='ArrowUp'||k==='Up'){ keys.u=down; e.preventDefault(); }
      if(k==='ArrowDown'||k==='Down'){ keys.d=down; e.preventDefault(); }
    }
  }
  cvs.tabIndex=0;
  cvs.addEventListener('keydown', e=>setKey(e,true));
  cvs.addEventListener('keyup', e=>setKey(e,false));
  document.addEventListener('keydown', e=>{ if(document.activeElement===cvs) setKey(e,true); });
  document.addEventListener('keyup', e=>{ if(document.activeElement===cvs) setKey(e,false); });
  cvs.addEventListener('mousedown', ()=>cvs.focus());
  loadMapBtn.onclick = ()=>{
    try{
      const M = parseMap(mapText.value);
      Q = new Map(); stats.textContent = "Q-table cleared.";
      rebuildFromMatrix(M);
    }catch(err){
      alert("Parse error: " + err.message);
    }
  };

  // Movement and RL
  const ACTIONS = [{di:-1,dj:0},{di:1,dj:0},{di:0,dj:1},{di:0,dj:-1}];
  function canMove(i,j){ return !(i<0||i>=NT||j<0||j>=NX||walls[i][j]); }

  // Rewards
  function reward(i,j){
    if(i===trueOpt.i && j===trueOpt.j) return 100;
    if(i===decoy.i && j===decoy.j) return -50;
    return -1;
  }

  // Q table
  let Q = new Map(); // "i,j" -> Float32Array(4)
  function qGet(i,j){ const k=`${i},${j}`; if(!Q.has(k)) Q.set(k,new Float32Array(4)); return Q.get(k); }
  function argmax(a){ let m=a[0], mi=0; for(let k=1;k<a.length;k++){ if(a[k]>m){m=a[k]; mi=k;} } return mi; }

  // Episode stats
  let epSteps=0, epReturn=0, episodes=0, experiments=0;
  let bestAt={i:0,j:0}, bestVal=0;

  function resetGame(){
    // start at first open on left edge else any open
    start = {i:NT-1, j:0};
    if(walls[start.i][start.j]){
      let found=false;
      for(let ii=NT-1; ii>=0; ii--){
        if(!walls[ii][0]){ start={i:ii,j:0}; found=true; break; }
      }
      if(!found){
        outer: for(let ii=NT-1; ii>=0; ii--) for(let jj=0; jj<NX; jj++) if(!walls[ii][jj]){ start={i:ii,j:jj}; break outer; }
      }
    }
    s = {...start};
    epSteps=0; epReturn=0; experiments=0;
    bestAt = {...s}; bestVal = EV[s.i][s.j];
    paused=false;
  }

  function agentStep(){
    const eps = Number(epsEl.value), alpha = Number(alphaEl.value), gamma = Number(gammaEl.value);
    const q = qGet(s.i,s.j);
    const aIdx = Math.random()<eps ? Math.floor(Math.random()*ACTIONS.length) : argmax(q);
    const a = ACTIONS[aIdx];
    let ni=s.i+a.di, nj=s.j+a.dj;
    if(!canMove(ni,nj)){ ni=s.i; nj=s.j; }
    const r = reward(ni,nj);
    const q2 = qGet(ni,nj);
    const tdTarget = r + gamma * Math.max(q2[0],q2[1],q2[2],q2[3]);
    q[aIdx] = q[aIdx] + alpha * (tdTarget - q[aIdx]);
    s={i:ni,j:nj};
    epSteps++; epReturn+=r; experiments++;
    const val = EV[s.i][s.j]; if(val>bestVal){ bestVal=val; bestAt={...s}; }
  }

  let tick=0;
  function humanStep(){
    tick=(tick+1)%8; if(tick!==0) return;
    let ni=s.i, nj=s.j;
    if(keys.l) nj--; if(keys.r) nj++; if(keys.u) ni--; if(keys.d) ni++;
    if(canMove(ni,nj)){
      s={i:ni,j:nj}; experiments++;
      const val = EV[s.i][s.j]; if(val>bestVal){ bestVal=val; bestAt={...s}; }
    }
  }

  // Drawing
  function colorFor(v){
    if(v<=0) return "#000";
    const t = Math.max(0, Math.min(1, v));
    const r = Math.floor(255 * Math.min(1, Math.max(0, 2*(t-0.5))));
    const g = Math.floor(255 * Math.min(1, Math.max(0, 2*t)));
    const b = Math.floor(255 * Math.min(1, Math.max(0, 1-2*t)));
    return `rgb(${r},${g},${b})`;
  }
  function draw(){
    // sizes
    CELL = Math.floor(Math.min(cvs.width/NX, cvs.height/NT));
    ORGX = Math.floor((cvs.width - CELL*NX)/2);
    ORGY = Math.floor((cvs.height - CELL*NT)/2);

    // cells
    for(let i=0;i<NT;i++){
      for(let j=0;j<NX;j++){
        const v = walls[i][j] ? 0 : EV[i][j];
        ctx.fillStyle = v<=0 ? "#000" : colorFor(v);
        ctx.fillRect(ORGX+j*CELL, ORGY+i*CELL, CELL, CELL);
      }
    }
    // grid
    ctx.strokeStyle = "rgba(255,255,255,.08)";
    for(let i=0;i<=NT;i++){ ctx.beginPath(); ctx.moveTo(ORGX, ORGY+i*CELL); ctx.lineTo(ORGX+NX*CELL, ORGY+i*CELL); ctx.stroke(); }
    for(let j=0;j<=NX;j++){ ctx.beginPath(); ctx.moveTo(ORGX+j*CELL, ORGY); ctx.lineTo(ORGX+j*CELL, ORGY+NT*CELL); ctx.stroke(); }

    // goals
    ctx.fillStyle="#ffdd57"; ctx.fillRect(ORGX+trueOpt.j*CELL+CELL*0.25, ORGY+trueOpt.i*CELL+CELL*0.25, CELL*0.5, CELL*0.5);
    ctx.fillStyle="#ff6b6b"; ctx.fillRect(ORGX+decoy.j*CELL+CELL*0.3, ORGY+decoy.i*CELL+CELL*0.3, CELL*0.4, CELL*0.4);

    // best so far (yellow ring)
    ctx.strokeStyle="#ffd84d"; ctx.lineWidth=Math.max(2, CELL*0.09);
    ctx.beginPath();
    ctx.arc(ORGX+bestAt.j*CELL+CELL/2, ORGY+bestAt.i*CELL+CELL/2, CELL*0.32, 0, Math.PI*2);
    ctx.stroke();

    // current (orange dot)
    ctx.fillStyle="#ff8800";
    ctx.beginPath();
    ctx.arc(ORGX+s.j*CELL+CELL/2, ORGY+s.i*CELL+CELL/2, CELL*0.28, 0, Math.PI*2);
    ctx.fill();

    // HUD
    const here = EV[s.i][s.j].toFixed(3), best = EV[bestAt.i][bestAt.j].toFixed(3);
    hud.textContent = `Experiments: ${experiments} | Here cell=(${s.i},${s.j}) yield≈${here} | Best cell=(${bestAt.i},${bestAt.j}) yield≈${best}`;
  }

  function onEpisodeEnd(kind){
    episodes += 1;
    stats.textContent = `Episodes: ${episodes} | Steps: ${epSteps} | Return: ${epReturn.toFixed(2)} | Q-states: ${Q.size} | End: ${kind}`;
    if(autoEl.checked){ resetGame(); running=true; } else { running=false; }
  }

  function update(){
    if(agentEl.checked && !freezeEl.checked) agentStep(); else humanStep();
    if(agentEl.checked){
      if(s.i===trueOpt.i && s.j===trueOpt.j) onEpisodeEnd("true");
      else if(s.i===decoy.i && s.j===decoy.j) onEpisodeEnd("decoy");
    }
  }

  function loop(){ if(running && !paused) update(); draw(); requestAnimationFrame(loop); }

  // Buttons
  startBtn.onclick=()=>{ running=true; paused=false; cvs.focus(); };
  pauseBtn.onclick=()=>{ if(running){ paused=!paused; cvs.focus(); } };
  resetBtn.onclick=()=>{ if(training || agentEl.checked) stopAgent("Agent stopped by Reset."); resetGame(); cvs.focus(); };

  // Disable agent mid training
  agentEl.addEventListener('change', ()=>{
    if(!agentEl.checked && training){
      stopAgent("Agent disabled.");
    }
  });

  function resetQ(){ Q = new Map(); stats.textContent = "Q-table cleared."; }
  resetQBtn.onclick = resetQ;

  async function runEpisode(maxSteps=2000){
    const prevAuto = autoEl.checked; autoEl.checked=false;
    const prevRun=running, prevPause=paused, prevAgent=agentEl.checked, prevFreeze=freezeEl.checked;
    agentEl.checked = true; freezeEl.checked = false;
    resetGame(); running = true; paused = false;

    let steps=0;
    abortAgent = false;
    training = true;

    await new Promise(resolve=>{
      function cleanup(){
        const endKind = (s.i===trueOpt.i && s.j===trueOpt.j) ? "true" : ((s.i===decoy.i && s.j===decoy.j) ? "decoy" : "limit");
        onEpisodeEnd(endKind);
        running=prevRun; paused=prevPause; agentEl.checked=prevAgent && !abortAgent; freezeEl.checked=prevFreeze; autoEl.checked=prevAuto;
        training = false;
      }
      function tick(){
        if(abortAgent){
          cleanup();
          resolve();
          return;
        }
        if(paused){
          requestAnimationFrame(tick);
          return;
        }
        if(steps>=maxSteps || (s.i===trueOpt.i && s.j===trueOpt.j) || (s.i===decoy.i && s.j===decoy.j)){
          cleanup();
          resolve();
          return;
        }
        agentStep(); draw(); steps++; requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    });
  }

  // Train buttons
  train1.onclick = async ()=>{ await runEpisode(1200); };
  train50.onclick = async ()=>{
    for(let k=0;k<50;k++){
      if(abortAgent) break;
      await runEpisode(1200);
    }
  };

  // Init
  resetGame();
  loop();
})();
</script>
</div></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="q-learning-on-a-chemistry-grid">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">3. Q-learning on a Chemistry Grid</a><a class="headerlink" href="#q-learning-on-a-chemistry-grid" title="Permalink to this heading">#</a></h2>
<p>Similar to the Demo 3, this part we build a <span class="math notranslate nohighlight">\((T,x)\)</span> grid environment in Python.<br />
It places two reward peaks (true and decoy) and scripted walls separating regions.</p>
<p>We train tabular Q-learning with decaying ε and compare:</p>
<ul class="simple">
<li><p><strong>Early Q-table:</strong> prefers the nearby decoy (shorter but worse path)</p></li>
<li><p><strong>Late Q-table:</strong> learns the long path to the true optimum</p></li>
</ul>
<p>Why? Early training underestimates distant rewards.<br />
As updates propagate, the agent learns that long paths with small penalties lead to higher return overall.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Q-learning on a chemistry (T, x) grid</span>
<span class="c1"># Visual proof: there is a path to the true goal (BFS in green),</span>
<span class="c1"># early policy goes to decoy, late policy learns the true goal.</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>

<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">4.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># ---- Chemistry-like surface with two centers (one high, one medium) ----</span>
<span class="k">def</span><span class="w"> </span><span class="nf">true_yield</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">T0_1</span><span class="p">,</span> <span class="n">x0_1</span> <span class="o">=</span> <span class="mf">115.0</span><span class="p">,</span> <span class="mf">0.30</span>   <span class="c1"># high</span>
    <span class="n">T0_2</span><span class="p">,</span> <span class="n">x0_2</span> <span class="o">=</span> <span class="mf">137.0</span><span class="p">,</span> <span class="mf">0.72</span>   <span class="c1"># medium</span>
    <span class="n">h1</span><span class="p">,</span> <span class="n">wT1</span><span class="p">,</span> <span class="n">wx1</span> <span class="o">=</span> <span class="mf">0.90</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">,</span> <span class="mf">0.05</span>
    <span class="n">h2</span><span class="p">,</span> <span class="n">wT2</span><span class="p">,</span> <span class="n">wx2</span> <span class="o">=</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">14.0</span><span class="p">,</span> <span class="mf">0.08</span>
    <span class="n">base</span> <span class="o">=</span> <span class="mf">0.10</span>
    <span class="n">g1</span> <span class="o">=</span> <span class="n">h1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">T</span> <span class="o">-</span> <span class="n">T0_1</span><span class="p">)</span><span class="o">/</span><span class="n">wT1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0_1</span><span class="p">)</span><span class="o">/</span><span class="n">wx1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">g2</span> <span class="o">=</span> <span class="n">h2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">T</span> <span class="o">-</span> <span class="n">T0_2</span><span class="p">)</span><span class="o">/</span><span class="n">wT2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0_2</span><span class="p">)</span><span class="o">/</span><span class="n">wx2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="n">g1</span> <span class="o">+</span> <span class="n">g2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">expected_value</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">true_yield</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.15</span><span class="o">*</span><span class="n">x</span>

<span class="c1"># ---- Fixed-wall environment with two reachable goals ----</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ChemGrid</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Actions: 0 up (T-), 1 right (x+), 2 down (T+), 3 left (x-)</span>
<span class="sd">    Reward: -1 per step, 0 at true goal, -5 at decoy goal</span>
<span class="sd">    Walls block movement. Pushing into a wall keeps you in place.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T_vals</span><span class="p">,</span> <span class="n">x_vals</span><span class="p">,</span> <span class="n">start_mode</span><span class="o">=</span><span class="s2">&quot;bottom_right&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">T_vals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">T_vals</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nT</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="mi">4</span>

        <span class="n">Tm</span><span class="p">,</span> <span class="n">Xm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_vals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EV</span> <span class="o">=</span> <span class="n">expected_value</span><span class="p">(</span><span class="n">Tm</span><span class="p">,</span> <span class="n">Xm</span><span class="p">)</span>

        <span class="c1"># Place goals by EV peaks</span>
        <span class="n">gi</span><span class="p">,</span> <span class="n">gj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EV</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">EV</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_goal</span> <span class="o">=</span> <span class="p">(</span><span class="n">gi</span><span class="p">,</span> <span class="n">gj</span><span class="p">)</span>
        <span class="c1"># second peak far from true</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoy_goal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_second_peak_far_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">true_goal</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>

        <span class="c1"># Scripted wall layout that separates regions but leaves gates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wall_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_scripted_walls</span><span class="p">()</span>

        <span class="c1"># Snap goals to open if needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_goal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nearest_open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">true_goal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoy_goal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nearest_open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoy_goal</span><span class="p">)</span>

        <span class="c1"># Start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nearest_open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pick_start</span><span class="p">(</span><span class="n">start_mode</span><span class="p">))</span>

        <span class="c1"># Verify both are reachable. If not, open extra gates.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_goal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoy_goal</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_pick_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="n">corners</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bottom_right&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nT</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;bottom_left&quot;</span><span class="p">:</span>  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nT</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;top_left&quot;</span><span class="p">:</span>     <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;top_right&quot;</span><span class="p">:</span>    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">corners</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nT</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_second_peak_far_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avoid_ij</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="mf">0.35</span><span class="p">):</span>
        <span class="n">ai</span><span class="p">,</span> <span class="n">aj</span> <span class="o">=</span> <span class="n">avoid_ij</span>
        <span class="n">EV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EV</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">EV</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ai</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nT</span><span class="p">,</span><span class="n">ai</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">aj</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span><span class="n">aj</span><span class="o">+</span><span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nT</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">EV</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]):</span> <span class="k">continue</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="n">ai</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nT</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">aj</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">sep</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="n">EV</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
                    <span class="n">best_score</span> <span class="o">=</span> <span class="n">EV</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">];</span> <span class="n">best</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">EV</span><span class="p">),</span> <span class="n">EV</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_scripted_walls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># Serpentine barrier across the grid</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nT</span><span class="o">*</span><span class="mf">0.48</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">):</span>
            <span class="n">wiggle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">6.0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="n">wiggle</span> <span class="o">+</span> <span class="n">k</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nT</span><span class="p">:</span>
                    <span class="n">W</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Gates in the barrier</span>
        <span class="n">gate_cols</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">22</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gate_cols</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">6.0</span><span class="p">))</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nT</span><span class="p">:</span>
                    <span class="n">W</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Extra maze lines near the decoy side</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nT</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">W</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">*</span><span class="mf">0.72</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">*</span><span class="mf">0.60</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">W</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nT</span><span class="o">*</span><span class="mf">0.75</span><span class="p">),</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Do not wall the goals</span>
        <span class="n">ti</span><span class="p">,</span> <span class="n">tj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EV</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">EV</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">W</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">tj</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">di</span><span class="p">,</span> <span class="n">dj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_second_peak_far_from</span><span class="p">((</span><span class="n">ti</span><span class="p">,</span> <span class="n">tj</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>
        <span class="n">W</span><span class="p">[</span><span class="n">di</span><span class="p">,</span> <span class="n">dj</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">W</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_nearest_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ij</span><span class="p">):</span>
        <span class="n">i0</span><span class="p">,</span> <span class="n">j0</span> <span class="o">=</span> <span class="n">ij</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wall_mask</span><span class="p">[</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="n">ij</span><span class="p">]);</span> <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="n">ij</span><span class="p">}</span>
        <span class="k">while</span> <span class="n">q</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">di</span><span class="p">,</span> <span class="n">dj</span> <span class="ow">in</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]:</span>
                <span class="n">ni</span><span class="p">,</span> <span class="n">nj</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="n">di</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="n">dj</span>
                <span class="k">if</span> <span class="n">ni</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">nj</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">ni</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">nT</span> <span class="ow">or</span> <span class="n">nj</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">nj</span><span class="p">)</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wall_mask</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span> <span class="n">nj</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">nj</span><span class="p">)</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">ni</span><span class="p">,</span> <span class="n">nj</span><span class="p">));</span> <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ni</span><span class="p">,</span> <span class="n">nj</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ij</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
        <span class="n">si</span><span class="p">,</span> <span class="n">sj</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span> <span class="n">ti</span><span class="p">,</span> <span class="n">tj</span> <span class="o">=</span> <span class="n">dst</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wall_mask</span><span class="p">[</span><span class="n">si</span><span class="p">,</span> <span class="n">sj</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">wall_mask</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="n">tj</span><span class="p">]:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="n">src</span><span class="p">]);</span> <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="n">src</span><span class="p">}</span>
        <span class="k">while</span> <span class="n">q</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">tj</span><span class="p">):</span> <span class="k">return</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">di</span><span class="p">,</span> <span class="n">dj</span> <span class="ow">in</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]:</span>
                <span class="n">ni</span><span class="p">,</span> <span class="n">nj</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="n">di</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="n">dj</span>
                <span class="k">if</span> <span class="n">ni</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">nj</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">ni</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">nT</span> <span class="ow">or</span> <span class="n">nj</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">nj</span><span class="p">)</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">wall_mask</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span> <span class="n">nj</span><span class="p">]:</span> <span class="k">continue</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">ni</span><span class="p">,</span> <span class="n">nj</span><span class="p">));</span> <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ni</span><span class="p">,</span> <span class="n">nj</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_connectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
        <span class="c1"># Open the closest barrier cells until connected</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="c1"># carve a straight tunnel along x</span>
        <span class="n">si</span><span class="p">,</span> <span class="n">sj</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span> <span class="n">ti</span><span class="p">,</span> <span class="n">tj</span> <span class="o">=</span> <span class="n">dst</span>
        <span class="n">jdir</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">tj</span> <span class="o">&gt;=</span> <span class="n">sj</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sj</span><span class="p">,</span> <span class="n">tj</span> <span class="o">+</span> <span class="n">jdir</span><span class="p">,</span> <span class="n">jdir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wall_mask</span><span class="p">[</span><span class="n">si</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># carve along y</span>
        <span class="n">idir</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">ti</span> <span class="o">&gt;=</span> <span class="n">si</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">ti</span> <span class="o">+</span> <span class="n">idir</span><span class="p">,</span> <span class="n">idir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wall_mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">tj</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">return</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">+</span> <span class="n">j</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span>
        <span class="n">ni</span><span class="p">,</span> <span class="n">nj</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>   <span class="n">ni</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>          <span class="c1"># up</span>
        <span class="k">elif</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">nj</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># right</span>
        <span class="k">elif</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="n">ni</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nT</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># down</span>
        <span class="k">elif</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="n">nj</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>          <span class="c1"># left</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wall_mask</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span> <span class="n">nj</span><span class="p">]:</span>
            <span class="n">ni</span><span class="p">,</span> <span class="n">nj</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">nj</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_goal</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">nj</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoy_goal</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span><span class="p">;</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">nj</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="nb">bool</span><span class="p">(</span><span class="n">done</span><span class="p">),</span> <span class="p">{}</span>

<span class="c1"># Build environment as usual</span>
<span class="n">T_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">ChemGrid</span><span class="p">(</span><span class="n">T_vals</span><span class="p">,</span> <span class="n">x_vals</span><span class="p">,</span> <span class="n">start_mode</span><span class="o">=</span><span class="s2">&quot;bottom_right&quot;</span><span class="p">)</span>




<span class="k">def</span><span class="w"> </span><span class="nf">set_start_only</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">T_target</span><span class="p">,</span> <span class="n">x_target</span><span class="p">):</span>
    <span class="c1"># find nearest grid indices to the desired coordinates</span>
    <span class="n">iT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">T_vals</span> <span class="o">-</span> <span class="n">T_target</span><span class="p">)))</span>
    <span class="n">jX</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">x_vals</span> <span class="o">-</span> <span class="n">x_target</span><span class="p">)))</span>
    <span class="c1"># snap to an open cell but do NOT rebuild walls or goals</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;_nearest_open&quot;</span><span class="p">):</span>
        <span class="n">env</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">_nearest_open</span><span class="p">((</span><span class="n">iT</span><span class="p">,</span> <span class="n">jX</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">env</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">iT</span><span class="p">,</span> <span class="n">jX</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<span class="n">set_start_only</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">T_target</span><span class="o">=</span><span class="mf">150.0</span><span class="p">,</span> <span class="n">x_target</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>

<span class="c1"># optional: sanity check that EV and goals did not change</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;true goal:&quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">true_goal</span><span class="p">,</span> <span class="s2">&quot;decoy:&quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">decoy_goal</span><span class="p">)</span>


<span class="c1"># ---- BFS shortest path to the true goal (to prove reachability) ----</span>
<span class="k">def</span><span class="w"> </span><span class="nf">bfs_shortest_path</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">walls</span><span class="p">):</span>
    <span class="n">si</span><span class="p">,</span> <span class="n">sj</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span> <span class="n">ti</span><span class="p">,</span> <span class="n">tj</span> <span class="o">=</span> <span class="n">dst</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="n">src</span><span class="p">]);</span> <span class="n">parent</span> <span class="o">=</span> <span class="p">{</span><span class="n">src</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="k">while</span> <span class="n">q</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">tj</span><span class="p">):</span>
            <span class="c1"># reconstruct</span>
            <span class="n">path</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">tj</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">cur</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span>
            <span class="n">path</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="k">for</span> <span class="n">di</span><span class="p">,</span> <span class="n">dj</span> <span class="ow">in</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)]:</span>
            <span class="n">ni</span><span class="p">,</span> <span class="n">nj</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="n">di</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="n">dj</span>
            <span class="k">if</span> <span class="n">ni</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">nj</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">ni</span><span class="o">&gt;=</span><span class="n">env</span><span class="o">.</span><span class="n">nT</span> <span class="ow">or</span> <span class="n">nj</span><span class="o">&gt;=</span><span class="n">env</span><span class="o">.</span><span class="n">nx</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">walls</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span> <span class="n">nj</span><span class="p">]:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">nj</span><span class="p">)</span> <span class="ow">in</span> <span class="n">parent</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">parent</span><span class="p">[(</span><span class="n">ni</span><span class="p">,</span> <span class="n">nj</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
            <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ni</span><span class="p">,</span> <span class="n">nj</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="n">shortest_true</span> <span class="o">=</span> <span class="n">bfs_shortest_path</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">true_goal</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">wall_mask</span><span class="p">)</span>

<span class="c1"># ---- Q-learning helpers with snapshots ----</span>
<span class="k">def</span><span class="w"> </span><span class="nf">eps_greedy</span><span class="p">(</span><span class="n">q_row</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">local_rng</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">local_rng</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">local_rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_row</span><span class="p">)))</span>
    <span class="n">mx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">q_row</span><span class="p">)</span>
    <span class="n">cand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">q_row</span><span class="p">,</span> <span class="n">mx</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">local_rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">cand</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_episode</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.22</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.985</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="mi">700</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">))</span>
    <span class="n">local</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">G</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_steps</span><span class="p">):</span>
        <span class="n">si</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">idx</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">eps_greedy</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">si</span><span class="p">],</span> <span class="n">eps</span><span class="p">,</span> <span class="n">local</span><span class="p">)</span>
        <span class="n">s2</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">si2</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">idx</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
        <span class="n">Q</span><span class="p">[</span><span class="n">si</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">Q</span><span class="p">[</span><span class="n">si2</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">Q</span><span class="p">[</span><span class="n">si</span><span class="p">,</span> <span class="n">a</span><span class="p">])</span>
        <span class="n">G</span> <span class="o">+=</span> <span class="n">r</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s2</span>
        <span class="k">if</span> <span class="n">done</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">return</span> <span class="n">Q</span><span class="p">,</span> <span class="n">G</span>

<span class="k">def</span><span class="w"> </span><span class="nf">train_with_snapshots</span><span class="p">(</span><span class="n">episodes</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span> <span class="n">eps0</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">eps_min</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mf">350.0</span><span class="p">,</span>
                         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.22</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.985</span><span class="p">,</span> <span class="n">snaps</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">850</span><span class="p">)):</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">env</span><span class="o">.</span><span class="n">nS</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">nA</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Q_early</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">episodes</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">eps_min</span><span class="p">,</span> <span class="n">eps0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">ep</span><span class="o">/</span><span class="n">tau</span><span class="p">))</span>
        <span class="n">Q</span><span class="p">,</span> <span class="n">G</span> <span class="o">=</span> <span class="n">run_episode</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span>
                           <span class="n">seed</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1_000_000</span><span class="p">)))</span>
        <span class="n">returns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ep</span> <span class="o">==</span> <span class="n">snaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">Q_early</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">Q_late</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">Q_early</span><span class="p">,</span> <span class="n">Q_late</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">returns</span><span class="p">),</span> <span class="n">snaps</span>

<span class="n">Q_early</span><span class="p">,</span> <span class="n">Q_late</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">snaps</span> <span class="o">=</span> <span class="n">train_with_snapshots</span><span class="p">()</span>

<span class="c1"># ---- Greedy rollouts ----</span>
<span class="k">def</span><span class="w"> </span><span class="nf">rollout</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="mi">400</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_steps</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">idx</span><span class="p">(</span><span class="n">s</span><span class="p">)]))</span>
        <span class="n">s2</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s2</span>
        <span class="k">if</span> <span class="n">done</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">return</span> <span class="n">path</span>

<span class="n">path_early</span> <span class="o">=</span> <span class="n">rollout</span><span class="p">(</span><span class="n">Q_early</span><span class="p">)</span>
<span class="n">path_late</span>  <span class="o">=</span> <span class="n">rollout</span><span class="p">(</span><span class="n">Q_late</span><span class="p">)</span>

<span class="c1"># ---- Plot 0: rolling return with snapshot markers ----</span>
<span class="n">roll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span><span class="o">/</span><span class="mi">25</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">roll</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snaps</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">25</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#888&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Episode&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Rolling return&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Q-learning rolling return&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># ---- Plot 2 and 3: early vs late greedy trajectories ----</span>
<span class="k">def</span><span class="w"> </span><span class="nf">panel</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
    <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">T_vals</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">EV</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;(early)&quot;</span><span class="p">):</span>  <span class="c1"># colorbar on left panel</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;expected net value&quot;</span><span class="p">)</span>
    <span class="n">wi</span><span class="p">,</span> <span class="n">wj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">wall_mask</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">T_vals</span><span class="p">[</span><span class="n">wi</span><span class="p">],</span> <span class="n">env</span><span class="o">.</span><span class="n">x_vals</span><span class="p">[</span><span class="n">wj</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>

    <span class="n">Ti</span> <span class="o">=</span> <span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">T_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">path</span><span class="p">]</span>
    <span class="n">Xi</span> <span class="o">=</span> <span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">x_vals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">path</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Ti</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;greedy path&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">T_vals</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">env</span><span class="o">.</span><span class="n">x_vals</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;#ff8800&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Start&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">env</span><span class="o">.</span><span class="n">T_vals</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">true_goal</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">x_vals</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">true_goal</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">-</span><span class="mf">0.05</span><span class="p">),</span>
                               <span class="mf">2.4</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#ffdd57&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True goal&quot;</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">env</span><span class="o">.</span><span class="n">T_vals</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">decoy_goal</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">x_vals</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">decoy_goal</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">-</span><span class="mf">0.05</span><span class="p">),</span>
                               <span class="mf">2.4</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#ff6b6b&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Decoy goal&quot;</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;T [°C]&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

<span class="n">end_early</span> <span class="o">=</span> <span class="n">path_early</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">end_late</span>  <span class="o">=</span> <span class="n">path_late</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">early_tag</span> <span class="o">=</span> <span class="s2">&quot;decoy&quot;</span> <span class="k">if</span> <span class="n">end_early</span> <span class="o">==</span> <span class="n">env</span><span class="o">.</span><span class="n">decoy_goal</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;true&quot;</span> <span class="k">if</span> <span class="n">end_early</span> <span class="o">==</span> <span class="n">env</span><span class="o">.</span><span class="n">true_goal</span> <span class="k">else</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="n">late_tag</span>  <span class="o">=</span> <span class="s2">&quot;true&quot;</span>  <span class="k">if</span> <span class="n">end_late</span>  <span class="o">==</span> <span class="n">env</span><span class="o">.</span><span class="n">true_goal</span>  <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;decoy&quot;</span> <span class="k">if</span> <span class="n">end_late</span>  <span class="o">==</span> <span class="n">env</span><span class="o">.</span><span class="n">decoy_goal</span>  <span class="k">else</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mf">5.6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">panel</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">path_early</span><span class="p">,</span> <span class="s2">&quot;#e74c3c&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Greedy trajectory (early) → </span><span class="si">{</span><span class="n">early_tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">panel</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">path_late</span><span class="p">,</span>  <span class="s2">&quot;#2980b9&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Greedy trajectory (late)  → </span><span class="si">{</span><span class="n">late_tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># single legend bottom</span>
<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
    <span class="n">handles</span> <span class="o">+=</span> <span class="n">h</span><span class="p">;</span> <span class="n">labels</span> <span class="o">+=</span> <span class="n">l</span>
<span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">();</span> <span class="n">H</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">L</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span> <span class="k">continue</span>
    <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">l</span><span class="p">);</span> <span class="n">H</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">);</span> <span class="n">L</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower center&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.04</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># ---- Plot 1: EV + walls + both goals + BFS shortest path to true ----</span>
<span class="n">EV</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">EV</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">7.2</span><span class="p">,</span> <span class="mf">6.2</span><span class="p">))</span>
<span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">T_vals</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">EV</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;expected net value&quot;</span><span class="p">)</span>

<span class="c1"># walls</span>
<span class="n">wi</span><span class="p">,</span> <span class="n">wj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">wall_mask</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">T_vals</span><span class="p">[</span><span class="n">wi</span><span class="p">],</span> <span class="n">env</span><span class="o">.</span><span class="n">x_vals</span><span class="p">[</span><span class="n">wj</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>

<span class="c1"># goals and start</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">T_vals</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">env</span><span class="o">.</span><span class="n">x_vals</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;#ff8800&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Start&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">env</span><span class="o">.</span><span class="n">T_vals</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">true_goal</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">x_vals</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">true_goal</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">-</span><span class="mf">0.05</span><span class="p">),</span>
                           <span class="mf">2.4</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#ffdd57&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True goal&quot;</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">env</span><span class="o">.</span><span class="n">T_vals</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">decoy_goal</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">x_vals</span><span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">decoy_goal</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">-</span><span class="mf">0.05</span><span class="p">),</span>
                           <span class="mf">2.4</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#ff6b6b&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Decoy goal&quot;</span><span class="p">))</span>

<span class="c1"># shortest path to true</span>
<span class="k">if</span> <span class="n">shortest_true</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">Ti</span> <span class="o">=</span> <span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">T_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">shortest_true</span><span class="p">]</span>
    <span class="n">Xi</span> <span class="o">=</span> <span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">x_vals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">shortest_true</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Ti</span><span class="p">,</span> <span class="n">Xi</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;#2ecc71&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Shortest path to true (BFS)&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;T [°C]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;There is a route to the true goal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower center&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.12</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>true goal: (11, 7) decoy: (17, 17)
</pre></div>
</div>
<img alt="_images/00fd885db971b2aad2f515e6ac2c7e48da4cae52cbc972e7cac827243aaa70dd.png" src="_images/00fd885db971b2aad2f515e6ac2c7e48da4cae52cbc972e7cac827243aaa70dd.png" />
<img alt="_images/ace605611c801c8639ecf4a4842b594ad35bdc2c92c764c91c6cabef56ace301.png" src="_images/ace605611c801c8639ecf4a4842b594ad35bdc2c92c764c91c6cabef56ace301.png" />
<img alt="_images/47a3e092288ff062e03f8a48ece4ca9a051471d6f1cf0beda247aa2ca702373d.png" src="_images/47a3e092288ff062e03f8a48ece4ca9a051471d6f1cf0beda247aa2ca702373d.png" />
</div>
</div>
<p>Early training has fewer updates. The path to the true goal is long and costs many <code class="docutils literal notranslate"><span class="pre">-1</span></code> steps before the +100 reward at the goal.</p>
<p>The decoy has a terminal penalty (for example <code class="docutils literal notranslate"><span class="pre">−50</span></code>) but may sit behind short corridors. Early Q often overestimates short routes and underestimates long ones. Greedy on an undertrained Q picks the locally better-looking path, which is often the decoy.</p>
<div class="admonition-note admonition">
<p class="admonition-title">Note</p>
<p>With more episodes the updates push up Q along the route to the true goal and push down Q around the decoy due to its terminal penalty. Then greedy flips to the true route.</p>
</div>
</section>
<hr class="docutils" />
<section id="bridge-to-multi-armed-bandits">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">4. Bridge to Multi-Armed Bandits</a><a class="headerlink" href="#bridge-to-multi-armed-bandits" title="Permalink to this heading">#</a></h2>
<p>In chemical research we often choose the <strong>next experiment anywhere in the space</strong>, informed by past data (as in Bayesian optimization and active learning we learned in the previous lecture). Unlike a reinforcement learning (RL) grid world shown above, in practice it’s less frequent that we move only to <em>neighboring</em> conditions (like “up”, “down”, “left”, “right”) after each reaction.</p>
<p>Instead, every experiment can be any point in the search space.</p>
<p>Because there is no meaningful notion of “current position” (enviroment), we can simplify the RL setup:<br />
there is effectively <strong>only one state</strong> that repeats each round.
This simplification leads to the <strong>multi-armed bandit</strong> formulation.</p>
<p>Under this one-state bandit setting, think about doing experiment in your lab like going to casino, we have <span class="math notranslate nohighlight">\(K\)</span> possible actions (arms), each representing an experimental condition such as a catalyst, solvent, or temperature combination.</p>
<p>Each arm <span class="math notranslate nohighlight">\(i\)</span> has an unknown expected reward <span class="math notranslate nohighlight">\(\mu_i\)</span> (e.g., expected yield) for different reactions (for example, reaction time 12h give an average reaction yield for suzuki coupling on 70% for 100 substrates, while 200C only give 10% success rate for the same pool of substrates).</p>
<p>At each trial <span class="math notranslate nohighlight">\(t = 1, 2, \dots, T\)</span>:</p>
<ol class="arabic simple">
<li><p>Select an arm <span class="math notranslate nohighlight">\(A_t \in \{1, \dots, K\}\)</span></p></li>
<li><p>Observe a reward <span class="math notranslate nohighlight">\(R_t\)</span> drawn from a distribution with mean <span class="math notranslate nohighlight">\(\mu_{A_t}\)</span></p></li>
<li><p>Update your estimates based on what you learned</p></li>
</ol>
<p>The objective is to maximize the <strong>total reward</strong>:</p>
<div class="math notranslate nohighlight">
\[
\max \; \mathbb{E}\!\left[\sum_{t=1}^{T} R_t\right]
\]</div>
<p>or equivalently, to minimize the <strong>regret</strong>, which measures how much we lose compared to always picking the best arm:</p>
<div class="math notranslate nohighlight">
\[
\mathcal{R}_T = T \mu^* - \mathbb{E}\!\left[\sum_{t=1}^T R_t\right],
\quad
\text{where } \mu^* = \max_i \mu_i
\]</div>
<p>Below is a mini-game to give you an idea of this:</p>
<ul class="simple">
<li><p>Each arm (catalyst or condition) is like a slot machine with an unknown payout probability.</p></li>
<li><p>You can pull one arm per round — that’s one experiment.</p></li>
<li><p>After observing the outcome (success or yield), update your belief about that arm.</p></li>
<li><p>Decide whether to <strong>explore</strong> new arms or <strong>exploit</strong> the best one so far.</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTML</span>

<span class="n">HTML</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;div id=&quot;bandit-chemlab&quot; style=&quot;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:#e6e6e6;&quot;&gt;</span>
<span class="s2">  &lt;div style=&quot;background:#0b1021;border:1px solid #1e2a44;border-radius:12px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.35);&quot;&gt;</span>
<span class="s2">    &lt;h3 style=&quot;margin:0 0 .4rem 0;color:#ffd84d;&quot;&gt;ChemLab: explore vs exploit&lt;/h3&gt;</span>
<span class="s2">    &lt;p style=&quot;margin:.2rem 0 1rem 0;opacity:.95&quot;&gt;</span>
<span class="s2">      You are screening &lt;b&gt;catalysts&lt;/b&gt; for a reaction. Each catalyst has an unknown success rate (yield).</span>
<span class="s2">      You can run one experiment per round. Try a strategy:</span>
<span class="s2">      &lt;b&gt;explore&lt;/b&gt; new catalysts to learn their true performance or &lt;b&gt;exploit&lt;/b&gt; the best one you know so far.</span>
<span class="s2">      Compare strategies and watch how average yield and regret evolve.</span>
<span class="s2">    &lt;/p&gt;</span>

<span class="s2">    &lt;div style=&quot;display:flex;flex-wrap:wrap;gap:12px;align-items:flex-start;&quot;&gt;</span>
<span class="s2">      &lt;!-- Controls --&gt;</span>
<span class="s2">      &lt;div style=&quot;flex:1 1 280px;min-width:280px;background:#0f1329;border:1px solid #1f2a48;border-radius:10px;padding:10px;&quot;&gt;</span>
<span class="s2">        &lt;div style=&quot;display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px;&quot;&gt;</span>
<span class="s2">          &lt;span&gt;Mode:&lt;/span&gt;</span>
<span class="s2">          &lt;label style=&quot;display:flex;align-items:center;gap:.35rem;&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;algo&quot; value=&quot;Manual&quot; checked&gt; Manual&lt;/label&gt;</span>
<span class="s2">          &lt;label style=&quot;display:flex;align-items:center;gap:.35rem;&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;algo&quot; value=&quot;Eps&quot;&gt; ε-greedy&lt;/label&gt;</span>
<span class="s2">          &lt;label style=&quot;display:flex;align-items:center;gap:.35rem;&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;algo&quot; value=&quot;UCB&quot;&gt; UCB1&lt;/label&gt;</span>
<span class="s2">          &lt;label style=&quot;display:flex;align-items:center;gap:.35rem;&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;algo&quot; value=&quot;TS&quot;&gt; Thompson&lt;/label&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">        &lt;div id=&quot;panel-eps&quot; style=&quot;display:none;margin:.3rem 0 .4rem 0;&quot;&gt;</span>
<span class="s2">          &lt;label&gt;ε explore:</span>
<span class="s2">            &lt;input id=&quot;epsSlider&quot; type=&quot;range&quot; min=&quot;0&quot; max=&quot;1&quot; step=&quot;0.01&quot; value=&quot;0.10&quot;&gt;</span>
<span class="s2">            &lt;span id=&quot;epsVal&quot;&gt;0.10&lt;/span&gt;</span>
<span class="s2">          &lt;/label&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">        &lt;div style=&quot;display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:.6rem 0;&quot;&gt;</span>
<span class="s2">          &lt;label&gt;Steps/run:</span>
<span class="s2">            &lt;input id=&quot;stepsSlider&quot; type=&quot;range&quot; min=&quot;1&quot; max=&quot;300&quot; step=&quot;1&quot; value=&quot;5&quot;&gt;</span>
<span class="s2">            &lt;span id=&quot;stepsVal&quot;&gt;50&lt;/span&gt;</span>
<span class="s2">          &lt;/label&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">        &lt;div style=&quot;display:flex;gap:8px;flex-wrap:wrap;margin-top:.2rem;&quot;&gt;</span>
<span class="s2">          &lt;button id=&quot;runBtn&quot;   style=&quot;padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Run agent&lt;/button&gt;</span>
<span class="s2">          &lt;button id=&quot;stepBtn&quot;  style=&quot;padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Step 1&lt;/button&gt;</span>
<span class="s2">          &lt;button id=&quot;resetBtn&quot; style=&quot;padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;&quot;&gt;Reset&lt;/button&gt;</span>
<span class="s2">          &lt;label style=&quot;margin-left:auto;display:flex;align-items:center;gap:.35rem;&quot;&gt;</span>
<span class="s2">            &lt;input id=&quot;revealChk&quot; type=&quot;checkbox&quot;&gt; Reveal true yields</span>
<span class="s2">          &lt;/label&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">        &lt;div style=&quot;margin-top:.6rem;font-size:.95rem;opacity:.9;line-height:1.35;&quot;&gt;</span>
<span class="s2">          &lt;b&gt;Keys&lt;/b&gt;: press 1..8 to test a catalyst in Manual mode.</span>
<span class="s2">          &lt;b&gt;Story&lt;/b&gt;: think of each catalyst as a recipe variant with its own success rate.</span>
<span class="s2">          Your goal is to maximize average yield while keeping regret low.</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">      &lt;/div&gt;</span>

<span class="s2">      &lt;!-- Charts --&gt;</span>
<span class="s2">      &lt;div style=&quot;flex:2 1 520px;min-width:520px;display:grid;grid-template-columns:1fr 1fr;gap:12px;&quot;&gt;</span>
<span class="s2">        &lt;div style=&quot;background:#0f1329;border:1px solid #1f2a48;border-radius:10px;padding:10px;&quot;&gt;</span>
<span class="s2">          &lt;div style=&quot;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;&quot;&gt;</span>
<span class="s2">            &lt;div&gt;Estimated yield by catalyst&lt;/div&gt;</span>
<span class="s2">            &lt;div id=&quot;labelline&quot; style=&quot;opacity:.8;font-size:.9rem;&quot;&gt;&lt;/div&gt;</span>
<span class="s2">          &lt;/div&gt;</span>
<span class="s2">          &lt;canvas id=&quot;barChart&quot; width=&quot;520&quot; height=&quot;300&quot; style=&quot;width:100%;height:auto;display:block;background:#0b1021;border-radius:8px;&quot;&gt;&lt;/canvas&gt;</span>
<span class="s2">          &lt;div style=&quot;margin-top:6px;opacity:.8;&quot;&gt;Click a bar in Manual mode to run that experiment.&lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">        &lt;div style=&quot;background:#0f1329;border:1px solid #1f2a48;border-radius:10px;padding:10px;&quot;&gt;</span>
<span class="s2">          &lt;div&gt;Average yield and cumulative regret&lt;/div&gt;</span>
<span class="s2">          &lt;canvas id=&quot;lineChart&quot; width=&quot;520&quot; height=&quot;300&quot; style=&quot;width:100%;height:auto;display:block;background:#0b1021;border-radius:8px;&quot;&gt;&lt;/canvas&gt;</span>
<span class="s2">          &lt;div style=&quot;margin-top:6px;opacity:.8;&quot;&gt;&lt;span style=&quot;color:#91d5ff;&quot;&gt;Avg yield&lt;/span&gt; should climb. &lt;span style=&quot;color:#ffa39e;&quot;&gt;Regret&lt;/span&gt; should grow more slowly when you find the best catalyst.&lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">      &lt;/div&gt;</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">  &lt;/div&gt;</span>
<span class="s2">&lt;/div&gt;</span>

<span class="s2">&lt;script&gt;</span>
<span class="s2">(() =&gt; {</span>
<span class="s2">  // ---------- Helpers ----------</span>
<span class="s2">  const clamp = (v, lo, hi)=&gt;Math.max(lo, Math.min(hi, v));</span>
<span class="s2">  function randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }</span>

<span class="s2">  // ---------- Environment: Bernoulli bandit in chemistry flavor ----------</span>
<span class="s2">  // 8 catalysts with fixed true success rates (hidden)</span>
<span class="s2">  const labels = [&quot;Cat A&quot;,&quot;Cat B&quot;,&quot;Cat C&quot;,&quot;Cat D&quot;,&quot;Cat E&quot;,&quot;Cat F&quot;,&quot;Cat G&quot;,&quot;Cat H&quot;];</span>
<span class="s2">  const trueP = (()=&gt;{</span>
<span class="s2">    // One clearly best, one close, rest mixed</span>
<span class="s2">    return [0.78, 0.72, 0.48, 0.44, 0.36, 0.30, 0.25, 0.18];</span>
<span class="s2">  })();</span>
<span class="s2">  const K = trueP.length;</span>
<span class="s2">  const bestIdx = trueP.indexOf(Math.max(...trueP));</span>

<span class="s2">  // ---------- State ----------</span>
<span class="s2">  let t = 0;</span>
<span class="s2">  let est = Array(K).fill(0);       // running mean per arm</span>
<span class="s2">  let pulls = Array(K).fill(0);     // count per arm</span>
<span class="s2">  let postA = Array(K).fill(1);     // Thompson alpha</span>
<span class="s2">  let postB = Array(K).fill(1);     // Thompson beta</span>
<span class="s2">  let rewards = [];                 // 0/1 outcomes</span>
<span class="s2">  let regret = [];                  // cumulative regret</span>
<span class="s2">  let cumReward = 0;</span>

<span class="s2">  // UI refs</span>
<span class="s2">  const barCanvas  = document.getElementById(&quot;barChart&quot;);</span>
<span class="s2">  const lineCanvas = document.getElementById(&quot;lineChart&quot;);</span>
<span class="s2">  const ctxBar  = barCanvas.getContext(&quot;2d&quot;);</span>
<span class="s2">  const ctxLine = lineCanvas.getContext(&quot;2d&quot;);</span>
<span class="s2">  const labelline = document.getElementById(&quot;labelline&quot;);</span>

<span class="s2">  const epsSlider   = document.getElementById(&quot;epsSlider&quot;);</span>
<span class="s2">  const epsVal      = document.getElementById(&quot;epsVal&quot;);</span>
<span class="s2">  const stepsSlider = document.getElementById(&quot;stepsSlider&quot;);</span>
<span class="s2">  const stepsVal    = document.getElementById(&quot;stepsVal&quot;);</span>
<span class="s2">  const revealChk   = document.getElementById(&quot;revealChk&quot;);</span>
<span class="s2">  const runBtn      = document.getElementById(&quot;runBtn&quot;);</span>
<span class="s2">  const stepBtn     = document.getElementById(&quot;stepBtn&quot;);</span>
<span class="s2">  const resetBtn    = document.getElementById(&quot;resetBtn&quot;);</span>
<span class="s2">  const radioAlgos  = [...document.querySelectorAll(&#39;input[name=&quot;algo&quot;]&#39;)];</span>
<span class="s2">  const panelEps    = document.getElementById(&quot;panel-eps&quot;);</span>

<span class="s2">  // ---- UI sync</span>
<span class="s2">  epsSlider.oninput = ()=&gt; epsVal.textContent = Number(epsSlider.value).toFixed(2);</span>
<span class="s2">  stepsSlider.oninput = ()=&gt; stepsVal.textContent = stepsSlider.value;</span>
<span class="s2">  epsVal.textContent = Number(epsSlider.value).toFixed(2);</span>
<span class="s2">  stepsVal.textContent = stepsSlider.value;</span>

<span class="s2">  function getAlgo(){</span>
<span class="s2">    const a = radioAlgos.find(r=&gt;r.checked).value;</span>
<span class="s2">    return a;</span>
<span class="s2">  }</span>
<span class="s2">  radioAlgos.forEach(r =&gt; r.onchange = ()=&gt;{</span>
<span class="s2">    panelEps.style.display = (getAlgo()===&quot;Eps&quot;) ? &quot;block&quot; : &quot;none&quot;;</span>
<span class="s2">  });</span>

<span class="s2">  // ---------- Algorithms ----------</span>
<span class="s2">  function actEpsGreedy(){</span>
<span class="s2">    const eps = Number(epsSlider.value);</span>
<span class="s2">    if(Math.random() &lt; eps){</span>
<span class="s2">      return Math.floor(Math.random()*K);</span>
<span class="s2">    }</span>
<span class="s2">    const m = Math.max(...est);</span>
<span class="s2">    const cand = [];</span>
<span class="s2">    for(let i=0;i&lt;K;i++) if(Math.abs(est[i]-m)&lt;1e-12) cand.push(i);</span>
<span class="s2">    return randChoice(cand);</span>
<span class="s2">  }</span>
<span class="s2">  function actUCB1(){</span>
<span class="s2">    // Pull each arm once at start</span>
<span class="s2">    for(let i=0;i&lt;K;i++) if(pulls[i]===0) return i;</span>
<span class="s2">    const logt = Math.log(t+1);</span>
<span class="s2">    let best = -1, bestVal = -Infinity;</span>
<span class="s2">    for(let i=0;i&lt;K;i++){</span>
<span class="s2">      const bonus = Math.sqrt(2*logt / pulls[i]);</span>
<span class="s2">      const ucb = est[i] + bonus;</span>
<span class="s2">      if(ucb &gt; bestVal - 1e-12){ bestVal = ucb; best = i; }</span>
<span class="s2">    }</span>
<span class="s2">    return best;</span>
<span class="s2">  }</span>
<span class="s2">  function actThompson(){</span>
<span class="s2">    let samples = [];</span>
<span class="s2">    for(let i=0;i&lt;K;i++){</span>
<span class="s2">      // simple Beta sampler using Math.random + inverse CDF approx is heavy; use JS gamma trick</span>
<span class="s2">      // Here we approximate with many small sum uniforms for simplicity</span>
<span class="s2">      // Quick and light: sample using library-free approximation</span>
<span class="s2">      const a = postA[i], b = postB[i];</span>
<span class="s2">      // Cheng&#39;s algorithm would be better, but for teaching this light approx is fine</span>
<span class="s2">      // Fallback: draw 100 uniforms and average to get a rough rank</span>
<span class="s2">      let sA=0, sB=0;</span>
<span class="s2">      for(let k=0;k&lt;Math.max(2, Math.floor(a));k++) sA += Math.random();</span>
<span class="s2">      for(let k=0;k&lt;Math.max(2, Math.floor(b));k++) sB += Math.random();</span>
<span class="s2">      const betaLike = sA/(sA+sB+1e-9);</span>
<span class="s2">      samples.push(betaLike);</span>
<span class="s2">    }</span>
<span class="s2">    const m = Math.max(...samples);</span>
<span class="s2">    const cand = [];</span>
<span class="s2">    for(let i=0;i&lt;K;i++) if(Math.abs(samples[i]-m)&lt;1e-12) cand.push(i);</span>
<span class="s2">    return randChoice(cand);</span>
<span class="s2">  }</span>

<span class="s2">  // ---------- One round ----------</span>
<span class="s2">  function bernoulliDraw(p){ return Math.random() &lt; p ? 1 : 0; }</span>

<span class="s2">  function stepOnce(action){</span>
<span class="s2">    const r = bernoulliDraw(trueP[action]);</span>
<span class="s2">    t += 1;</span>
<span class="s2">    cumReward += r;</span>
<span class="s2">    const bestMean = trueP[bestIdx];</span>
<span class="s2">    regret.push(bestMean*t - cumReward);</span>

<span class="s2">    // update estimates</span>
<span class="s2">    pulls[action] += 1;</span>
<span class="s2">    const n = pulls[action];</span>
<span class="s2">    est[action] += (r - est[action]) / n;</span>

<span class="s2">    // update Thompson posterior</span>
<span class="s2">    postA[action] += r;</span>
<span class="s2">    postB[action] += 1 - r;</span>

<span class="s2">    rewards.push(r);</span>
<span class="s2">  }</span>

<span class="s2">  // ---------- Drawing ----------</span>
<span class="s2">  function drawBars(){</span>
<span class="s2">    const W = barCanvas.width, H = barCanvas.height;</span>
<span class="s2">    ctxBar.clearRect(0,0,W,H);</span>
<span class="s2">    // axes</span>
<span class="s2">    ctxBar.strokeStyle = &quot;#243042&quot;; ctxBar.lineWidth = 1;</span>
<span class="s2">    ctxBar.beginPath(); ctxBar.moveTo(40,10); ctxBar.lineTo(40,H-30); ctxBar.lineTo(W-10,H-30); ctxBar.stroke();</span>

<span class="s2">    const maxY = 1.0;</span>
<span class="s2">    const plotW = W-60, plotH = H-50;</span>
<span class="s2">    const bw = plotW / K * 0.7;</span>
<span class="s2">    const gap = plotW / K * 0.3;</span>
<span class="s2">    const x0 = 40 + gap*0.5;</span>

<span class="s2">    // gridlines</span>
<span class="s2">    ctxBar.strokeStyle = &quot;rgba(255,255,255,.06)&quot;;</span>
<span class="s2">    for(let y=0;y&lt;=10;y++){</span>
<span class="s2">      const yy = 10 + plotH - plotH*(y/10);</span>
<span class="s2">      ctxBar.beginPath(); ctxBar.moveTo(40, yy); ctxBar.lineTo(W-10, yy); ctxBar.stroke();</span>
<span class="s2">    }</span>

<span class="s2">    // bars</span>
<span class="s2">      for(let i=0;i&lt;K;i++){</span>
<span class="s2">        const x = x0 + i*(bw+gap);</span>
<span class="s2">        const y = 10 + plotH - plotH*clamp(est[i]/maxY,0,1);</span>
<span class="s2">        const h = plotH - (y-10);</span>
<span class="s2">        ctxBar.fillStyle = &quot;#51cf66&quot;;</span>
<span class="s2">        ctxBar.fillRect(x, y, bw, h);</span>

<span class="s2">        // SUCCESS / TOTAL on top</span>
<span class="s2">        const succ = Math.max(0, postA[i] - 1);   // successes tracked via Beta alpha</span>
<span class="s2">        const total = pulls[i];                    // total runs for this catalyst</span>
<span class="s2">        ctxBar.fillStyle = &quot;#e6e6e6&quot;;</span>
<span class="s2">        ctxBar.font = &quot;12px ui-sans-serif&quot;;</span>
<span class="s2">        ctxBar.textAlign = &quot;center&quot;;</span>
<span class="s2">        ctxBar.fillText(`$</span><span class="si">{succ}</span><span class="s2">/$</span><span class="si">{total}</span><span class="s2">`, x + bw/2, y - 6);</span>

<span class="s2">        // catalyst label</span>
<span class="s2">        ctxBar.fillStyle = &quot;#a3b3c2&quot;;</span>
<span class="s2">        ctxBar.save();</span>
<span class="s2">        ctxBar.translate(x + bw/2, H-15);</span>
<span class="s2">        ctxBar.rotate(-0.1);</span>
<span class="s2">        ctxBar.fillText(labels[i], 0, 0);</span>
<span class="s2">        ctxBar.restore();</span>

<span class="s2">        // true mean overlay if reveal</span>
<span class="s2">        if(revealChk.checked){</span>
<span class="s2">          const yTrue = 10 + plotH - plotH*clamp(trueP[i]/maxY,0,1);</span>
<span class="s2">          ctxBar.strokeStyle = &quot;#ffd84d&quot;;</span>
<span class="s2">          ctxBar.beginPath(); ctxBar.moveTo(x, yTrue); ctxBar.lineTo(x+bw, yTrue); ctxBar.stroke();</span>
<span class="s2">        }</span>
<span class="s2">      }</span>

<span class="s2">    labelline.textContent = `Rounds $</span><span class="si">{t}</span><span class="s2"> | Best true catalyst = $</span><span class="si">{labels[bestIdx]}</span><span class="s2">`;</span>
<span class="s2">    // capture clickable bar bounds</span>
<span class="s2">    clickRegions = [];</span>
<span class="s2">    for(let i=0;i&lt;K;i++){</span>
<span class="s2">      const x = x0 + i*(bw+gap);</span>
<span class="s2">      clickRegions.push({i, x, w:bw, y:10, h:plotH});</span>
<span class="s2">    }</span>
<span class="s2">  }</span>

<span class="s2">  function drawLines(){</span>
<span class="s2">    const W = lineCanvas.width, H = lineCanvas.height;</span>
<span class="s2">    ctxLine.clearRect(0,0,W,H);</span>
<span class="s2">    // axes</span>
<span class="s2">    ctxLine.strokeStyle = &quot;#243042&quot;; ctxLine.lineWidth = 1;</span>
<span class="s2">    ctxLine.beginPath(); ctxLine.moveTo(40,10); ctxLine.lineTo(40,H-30); ctxLine.lineTo(W-10,H-30); ctxLine.stroke();</span>

<span class="s2">    const plotW = W-60, plotH = H-50;</span>
<span class="s2">    // grid</span>
<span class="s2">    ctxLine.strokeStyle = &quot;rgba(255,255,255,.06)&quot;;</span>
<span class="s2">    for(let y=0;y&lt;=10;y++){</span>
<span class="s2">      const yy = 10 + plotH - plotH*(y/10);</span>
<span class="s2">      ctxLine.beginPath(); ctxLine.moveTo(40, yy); ctxLine.lineTo(W-10, yy); ctxLine.stroke();</span>
<span class="s2">    }</span>
<span class="s2">    // avg reward</span>
<span class="s2">    if(t&gt;0){</span>
<span class="s2">      const avg = []; let s=0;</span>
<span class="s2">      for(let i=0;i&lt;rewards.length;i++){ s+=rewards[i]; avg.push(s/(i+1)); }</span>

<span class="s2">      ctxLine.strokeStyle = &quot;#91d5ff&quot;; ctxLine.lineWidth = 2;</span>
<span class="s2">      ctxLine.beginPath();</span>
<span class="s2">      for(let i=0;i&lt;avg.length;i++){</span>
<span class="s2">        const x = 40 + plotW * (i/(rewards.length-1 || 1));</span>
<span class="s2">        const y = 10 + plotH - plotH*clamp(avg[i],0,1);</span>
<span class="s2">        if(i===0) ctxLine.moveTo(x,y); else ctxLine.lineTo(x,y);</span>
<span class="s2">      }</span>
<span class="s2">      ctxLine.stroke();</span>

<span class="s2">      // regret (rescale to fit nicely)</span>
<span class="s2">      const reg = regret.slice();</span>
<span class="s2">      const maxReg = Math.max(1, ...reg);</span>
<span class="s2">      ctxLine.strokeStyle = &quot;#ffa39e&quot;; ctxLine.lineWidth = 2;</span>
<span class="s2">      ctxLine.beginPath();</span>
<span class="s2">      for(let i=0;i&lt;reg.length;i++){</span>
<span class="s2">        const x = 40 + plotW * (i/(reg.length-1 || 1));</span>
<span class="s2">        const y = 10 + plotH - plotH*clamp(reg[i]/maxReg,0,1);</span>
<span class="s2">        if(i===0) ctxLine.moveTo(x,y); else ctxLine.lineTo(x,y);</span>
<span class="s2">      }</span>
<span class="s2">      ctxLine.stroke();</span>
<span class="s2">    }</span>
<span class="s2">  }</span>

<span class="s2">  // ---------- Interaction ----------</span>
<span class="s2">  let clickRegions = []; // set by drawBars()</span>

<span class="s2">  function canvasToLocal(canvas, evt){</span>
<span class="s2">    const r = canvas.getBoundingClientRect();</span>
<span class="s2">    const scaleX = canvas.width / r.width;</span>
<span class="s2">    const scaleY = canvas.height / r.height;</span>
<span class="s2">    return { x: (evt.clientX - r.left) * scaleX, y: (evt.clientY - r.top) * scaleY };</span>
<span class="s2">    }</span>

<span class="s2">  barCanvas.addEventListener(&quot;click&quot;, (e)=&gt;{</span>
<span class="s2">    if(getAlgo()!==&quot;Manual&quot;) return;</span>
<span class="s2">    const p = canvasToLocal(barCanvas, e);</span>
<span class="s2">    for(const reg of clickRegions){</span>
<span class="s2">      if(p.x&gt;=reg.x &amp;&amp; p.x&lt;=reg.x+reg.w &amp;&amp; p.y&gt;=reg.y &amp;&amp; p.y&lt;=reg.y+reg.h){</span>
<span class="s2">        stepOnce(reg.i);</span>
<span class="s2">        drawBars(); drawLines();</span>
<span class="s2">        return;</span>
<span class="s2">      }</span>
<span class="s2">    }</span>
<span class="s2">  });</span>

<span class="s2">  // keyboard 1..8</span>
<span class="s2">  window.addEventListener(&quot;keydown&quot;, (e)=&gt;{</span>
<span class="s2">    if(getAlgo()!==&quot;Manual&quot;) return;</span>
<span class="s2">    if(e.key&gt;=&quot;1&quot; &amp;&amp; e.key&lt;=&quot;8&quot;){</span>
<span class="s2">      const i = parseInt(e.key,10)-1;</span>
<span class="s2">      if(i&gt;=0 &amp;&amp; i&lt;K){ stepOnce(i); drawBars(); drawLines(); }</span>
<span class="s2">    }</span>
<span class="s2">  });</span>

<span class="s2">  // Buttons</span>
<span class="s2">  runBtn.onclick = ()=&gt;{</span>
<span class="s2">    const algo = getAlgo();</span>
<span class="s2">    if(algo===&quot;Manual&quot;) return;</span>
<span class="s2">    const steps = parseInt(stepsSlider.value,10);</span>
<span class="s2">    for(let s=0;s&lt;steps;s++){</span>
<span class="s2">      let a = 0;</span>
<span class="s2">      if(algo===&quot;Eps&quot;) a = actEpsGreedy();</span>
<span class="s2">      else if(algo===&quot;UCB&quot;) a = actUCB1();</span>
<span class="s2">      else if(algo===&quot;TS&quot;)  a = actThompson();</span>
<span class="s2">      stepOnce(a);</span>
<span class="s2">    }</span>
<span class="s2">    drawBars(); drawLines();</span>
<span class="s2">  };</span>

<span class="s2">  stepBtn.onclick = ()=&gt;{</span>
<span class="s2">    const algo = getAlgo();</span>
<span class="s2">    if(algo===&quot;Manual&quot;) return;</span>
<span class="s2">    let a = 0;</span>
<span class="s2">    if(algo===&quot;Eps&quot;) a = actEpsGreedy();</span>
<span class="s2">    else if(algo===&quot;UCB&quot;) a = actUCB1();</span>
<span class="s2">    else if(algo===&quot;TS&quot;)  a = actThompson();</span>
<span class="s2">    stepOnce(a);</span>
<span class="s2">    drawBars(); drawLines();</span>
<span class="s2">  };</span>

<span class="s2">  resetBtn.onclick = ()=&gt;{</span>
<span class="s2">    t=0; est=Array(K).fill(0); pulls=Array(K).fill(0);</span>
<span class="s2">    postA=Array(K).fill(1); postB=Array(K).fill(1);</span>
<span class="s2">    rewards=[]; regret=[]; cumReward=0;</span>
<span class="s2">    drawBars(); drawLines();</span>
<span class="s2">  };</span>

<span class="s2">  // Initial draw</span>
<span class="s2">  drawBars(); drawLines();</span>
<span class="s2">})();</span>
<span class="s2">&lt;/script&gt;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html">
<div id="bandit-chemlab" style="font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:#e6e6e6;">
  <div style="background:#0b1021;border:1px solid #1e2a44;border-radius:12px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.35);">
    <h3 style="margin:0 0 .4rem 0;color:#ffd84d;">ChemLab: explore vs exploit</h3>
    <p style="margin:.2rem 0 1rem 0;opacity:.95">
      You are screening <b>catalysts</b> for a reaction. Each catalyst has an unknown success rate (yield).
      You can run one experiment per round. Try a strategy:
      <b>explore</b> new catalysts to learn their true performance or <b>exploit</b> the best one you know so far.
      Compare strategies and watch how average yield and regret evolve.
    </p>

    <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:flex-start;">
      <!-- Controls -->
      <div style="flex:1 1 280px;min-width:280px;background:#0f1329;border:1px solid #1f2a48;border-radius:10px;padding:10px;">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
          <span>Mode:</span>
          <label style="display:flex;align-items:center;gap:.35rem;"><input type="radio" name="algo" value="Manual" checked> Manual</label>
          <label style="display:flex;align-items:center;gap:.35rem;"><input type="radio" name="algo" value="Eps"> ε-greedy</label>
          <label style="display:flex;align-items:center;gap:.35rem;"><input type="radio" name="algo" value="UCB"> UCB1</label>
          <label style="display:flex;align-items:center;gap:.35rem;"><input type="radio" name="algo" value="TS"> Thompson</label>
        </div>
        <div id="panel-eps" style="display:none;margin:.3rem 0 .4rem 0;">
          <label>ε explore:
            <input id="epsSlider" type="range" min="0" max="1" step="0.01" value="0.10">
            <span id="epsVal">0.10</span>
          </label>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:.6rem 0;">
          <label>Steps/run:
            <input id="stepsSlider" type="range" min="1" max="300" step="1" value="5">
            <span id="stepsVal">50</span>
          </label>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:.2rem;">
          <button id="runBtn"   style="padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Run agent</button>
          <button id="stepBtn"  style="padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Step 1</button>
          <button id="resetBtn" style="padding:.4rem .7rem;border:1px solid #222;border-radius:.5rem;background:#111;color:#eee;cursor:pointer;">Reset</button>
          <label style="margin-left:auto;display:flex;align-items:center;gap:.35rem;">
            <input id="revealChk" type="checkbox"> Reveal true yields
          </label>
        </div>
        <div style="margin-top:.6rem;font-size:.95rem;opacity:.9;line-height:1.35;">
          <b>Keys</b>: press 1..8 to test a catalyst in Manual mode.
          <b>Story</b>: think of each catalyst as a recipe variant with its own success rate.
          Your goal is to maximize average yield while keeping regret low.
        </div>
      </div>

      <!-- Charts -->
      <div style="flex:2 1 520px;min-width:520px;display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div style="background:#0f1329;border:1px solid #1f2a48;border-radius:10px;padding:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <div>Estimated yield by catalyst</div>
            <div id="labelline" style="opacity:.8;font-size:.9rem;"></div>
          </div>
          <canvas id="barChart" width="520" height="300" style="width:100%;height:auto;display:block;background:#0b1021;border-radius:8px;"></canvas>
          <div style="margin-top:6px;opacity:.8;">Click a bar in Manual mode to run that experiment.</div>
        </div>
        <div style="background:#0f1329;border:1px solid #1f2a48;border-radius:10px;padding:10px;">
          <div>Average yield and cumulative regret</div>
          <canvas id="lineChart" width="520" height="300" style="width:100%;height:auto;display:block;background:#0b1021;border-radius:8px;"></canvas>
          <div style="margin-top:6px;opacity:.8;"><span style="color:#91d5ff;">Avg yield</span> should climb. <span style="color:#ffa39e;">Regret</span> should grow more slowly when you find the best catalyst.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // ---------- Helpers ----------
  const clamp = (v, lo, hi)=>Math.max(lo, Math.min(hi, v));
  function randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  // ---------- Environment: Bernoulli bandit in chemistry flavor ----------
  // 8 catalysts with fixed true success rates (hidden)
  const labels = ["Cat A","Cat B","Cat C","Cat D","Cat E","Cat F","Cat G","Cat H"];
  const trueP = (()=>{
    // One clearly best, one close, rest mixed
    return [0.78, 0.72, 0.48, 0.44, 0.36, 0.30, 0.25, 0.18];
  })();
  const K = trueP.length;
  const bestIdx = trueP.indexOf(Math.max(...trueP));

  // ---------- State ----------
  let t = 0;
  let est = Array(K).fill(0);       // running mean per arm
  let pulls = Array(K).fill(0);     // count per arm
  let postA = Array(K).fill(1);     // Thompson alpha
  let postB = Array(K).fill(1);     // Thompson beta
  let rewards = [];                 // 0/1 outcomes
  let regret = [];                  // cumulative regret
  let cumReward = 0;

  // UI refs
  const barCanvas  = document.getElementById("barChart");
  const lineCanvas = document.getElementById("lineChart");
  const ctxBar  = barCanvas.getContext("2d");
  const ctxLine = lineCanvas.getContext("2d");
  const labelline = document.getElementById("labelline");

  const epsSlider   = document.getElementById("epsSlider");
  const epsVal      = document.getElementById("epsVal");
  const stepsSlider = document.getElementById("stepsSlider");
  const stepsVal    = document.getElementById("stepsVal");
  const revealChk   = document.getElementById("revealChk");
  const runBtn      = document.getElementById("runBtn");
  const stepBtn     = document.getElementById("stepBtn");
  const resetBtn    = document.getElementById("resetBtn");
  const radioAlgos  = [...document.querySelectorAll('input[name="algo"]')];
  const panelEps    = document.getElementById("panel-eps");

  // ---- UI sync
  epsSlider.oninput = ()=> epsVal.textContent = Number(epsSlider.value).toFixed(2);
  stepsSlider.oninput = ()=> stepsVal.textContent = stepsSlider.value;
  epsVal.textContent = Number(epsSlider.value).toFixed(2);
  stepsVal.textContent = stepsSlider.value;

  function getAlgo(){
    const a = radioAlgos.find(r=>r.checked).value;
    return a;
  }
  radioAlgos.forEach(r => r.onchange = ()=>{
    panelEps.style.display = (getAlgo()==="Eps") ? "block" : "none";
  });

  // ---------- Algorithms ----------
  function actEpsGreedy(){
    const eps = Number(epsSlider.value);
    if(Math.random() < eps){
      return Math.floor(Math.random()*K);
    }
    const m = Math.max(...est);
    const cand = [];
    for(let i=0;i<K;i++) if(Math.abs(est[i]-m)<1e-12) cand.push(i);
    return randChoice(cand);
  }
  function actUCB1(){
    // Pull each arm once at start
    for(let i=0;i<K;i++) if(pulls[i]===0) return i;
    const logt = Math.log(t+1);
    let best = -1, bestVal = -Infinity;
    for(let i=0;i<K;i++){
      const bonus = Math.sqrt(2*logt / pulls[i]);
      const ucb = est[i] + bonus;
      if(ucb > bestVal - 1e-12){ bestVal = ucb; best = i; }
    }
    return best;
  }
  function actThompson(){
    let samples = [];
    for(let i=0;i<K;i++){
      // simple Beta sampler using Math.random + inverse CDF approx is heavy; use JS gamma trick
      // Here we approximate with many small sum uniforms for simplicity
      // Quick and light: sample using library-free approximation
      const a = postA[i], b = postB[i];
      // Cheng's algorithm would be better, but for teaching this light approx is fine
      // Fallback: draw 100 uniforms and average to get a rough rank
      let sA=0, sB=0;
      for(let k=0;k<Math.max(2, Math.floor(a));k++) sA += Math.random();
      for(let k=0;k<Math.max(2, Math.floor(b));k++) sB += Math.random();
      const betaLike = sA/(sA+sB+1e-9);
      samples.push(betaLike);
    }
    const m = Math.max(...samples);
    const cand = [];
    for(let i=0;i<K;i++) if(Math.abs(samples[i]-m)<1e-12) cand.push(i);
    return randChoice(cand);
  }

  // ---------- One round ----------
  function bernoulliDraw(p){ return Math.random() < p ? 1 : 0; }

  function stepOnce(action){
    const r = bernoulliDraw(trueP[action]);
    t += 1;
    cumReward += r;
    const bestMean = trueP[bestIdx];
    regret.push(bestMean*t - cumReward);

    // update estimates
    pulls[action] += 1;
    const n = pulls[action];
    est[action] += (r - est[action]) / n;

    // update Thompson posterior
    postA[action] += r;
    postB[action] += 1 - r;

    rewards.push(r);
  }

  // ---------- Drawing ----------
  function drawBars(){
    const W = barCanvas.width, H = barCanvas.height;
    ctxBar.clearRect(0,0,W,H);
    // axes
    ctxBar.strokeStyle = "#243042"; ctxBar.lineWidth = 1;
    ctxBar.beginPath(); ctxBar.moveTo(40,10); ctxBar.lineTo(40,H-30); ctxBar.lineTo(W-10,H-30); ctxBar.stroke();

    const maxY = 1.0;
    const plotW = W-60, plotH = H-50;
    const bw = plotW / K * 0.7;
    const gap = plotW / K * 0.3;
    const x0 = 40 + gap*0.5;

    // gridlines
    ctxBar.strokeStyle = "rgba(255,255,255,.06)";
    for(let y=0;y<=10;y++){
      const yy = 10 + plotH - plotH*(y/10);
      ctxBar.beginPath(); ctxBar.moveTo(40, yy); ctxBar.lineTo(W-10, yy); ctxBar.stroke();
    }

    // bars
      for(let i=0;i<K;i++){
        const x = x0 + i*(bw+gap);
        const y = 10 + plotH - plotH*clamp(est[i]/maxY,0,1);
        const h = plotH - (y-10);
        ctxBar.fillStyle = "#51cf66";
        ctxBar.fillRect(x, y, bw, h);

        // SUCCESS / TOTAL on top
        const succ = Math.max(0, postA[i] - 1);   // successes tracked via Beta alpha
        const total = pulls[i];                    // total runs for this catalyst
        ctxBar.fillStyle = "#e6e6e6";
        ctxBar.font = "12px ui-sans-serif";
        ctxBar.textAlign = "center";
        ctxBar.fillText(`${succ}/${total}`, x + bw/2, y - 6);

        // catalyst label
        ctxBar.fillStyle = "#a3b3c2";
        ctxBar.save();
        ctxBar.translate(x + bw/2, H-15);
        ctxBar.rotate(-0.1);
        ctxBar.fillText(labels[i], 0, 0);
        ctxBar.restore();

        // true mean overlay if reveal
        if(revealChk.checked){
          const yTrue = 10 + plotH - plotH*clamp(trueP[i]/maxY,0,1);
          ctxBar.strokeStyle = "#ffd84d";
          ctxBar.beginPath(); ctxBar.moveTo(x, yTrue); ctxBar.lineTo(x+bw, yTrue); ctxBar.stroke();
        }
      }

    labelline.textContent = `Rounds ${t} | Best true catalyst = ${labels[bestIdx]}`;
    // capture clickable bar bounds
    clickRegions = [];
    for(let i=0;i<K;i++){
      const x = x0 + i*(bw+gap);
      clickRegions.push({i, x, w:bw, y:10, h:plotH});
    }
  }

  function drawLines(){
    const W = lineCanvas.width, H = lineCanvas.height;
    ctxLine.clearRect(0,0,W,H);
    // axes
    ctxLine.strokeStyle = "#243042"; ctxLine.lineWidth = 1;
    ctxLine.beginPath(); ctxLine.moveTo(40,10); ctxLine.lineTo(40,H-30); ctxLine.lineTo(W-10,H-30); ctxLine.stroke();

    const plotW = W-60, plotH = H-50;
    // grid
    ctxLine.strokeStyle = "rgba(255,255,255,.06)";
    for(let y=0;y<=10;y++){
      const yy = 10 + plotH - plotH*(y/10);
      ctxLine.beginPath(); ctxLine.moveTo(40, yy); ctxLine.lineTo(W-10, yy); ctxLine.stroke();
    }
    // avg reward
    if(t>0){
      const avg = []; let s=0;
      for(let i=0;i<rewards.length;i++){ s+=rewards[i]; avg.push(s/(i+1)); }

      ctxLine.strokeStyle = "#91d5ff"; ctxLine.lineWidth = 2;
      ctxLine.beginPath();
      for(let i=0;i<avg.length;i++){
        const x = 40 + plotW * (i/(rewards.length-1 || 1));
        const y = 10 + plotH - plotH*clamp(avg[i],0,1);
        if(i===0) ctxLine.moveTo(x,y); else ctxLine.lineTo(x,y);
      }
      ctxLine.stroke();

      // regret (rescale to fit nicely)
      const reg = regret.slice();
      const maxReg = Math.max(1, ...reg);
      ctxLine.strokeStyle = "#ffa39e"; ctxLine.lineWidth = 2;
      ctxLine.beginPath();
      for(let i=0;i<reg.length;i++){
        const x = 40 + plotW * (i/(reg.length-1 || 1));
        const y = 10 + plotH - plotH*clamp(reg[i]/maxReg,0,1);
        if(i===0) ctxLine.moveTo(x,y); else ctxLine.lineTo(x,y);
      }
      ctxLine.stroke();
    }
  }

  // ---------- Interaction ----------
  let clickRegions = []; // set by drawBars()

  function canvasToLocal(canvas, evt){
    const r = canvas.getBoundingClientRect();
    const scaleX = canvas.width / r.width;
    const scaleY = canvas.height / r.height;
    return { x: (evt.clientX - r.left) * scaleX, y: (evt.clientY - r.top) * scaleY };
    }

  barCanvas.addEventListener("click", (e)=>{
    if(getAlgo()!=="Manual") return;
    const p = canvasToLocal(barCanvas, e);
    for(const reg of clickRegions){
      if(p.x>=reg.x && p.x<=reg.x+reg.w && p.y>=reg.y && p.y<=reg.y+reg.h){
        stepOnce(reg.i);
        drawBars(); drawLines();
        return;
      }
    }
  });

  // keyboard 1..8
  window.addEventListener("keydown", (e)=>{
    if(getAlgo()!=="Manual") return;
    if(e.key>="1" && e.key<="8"){
      const i = parseInt(e.key,10)-1;
      if(i>=0 && i<K){ stepOnce(i); drawBars(); drawLines(); }
    }
  });

  // Buttons
  runBtn.onclick = ()=>{
    const algo = getAlgo();
    if(algo==="Manual") return;
    const steps = parseInt(stepsSlider.value,10);
    for(let s=0;s<steps;s++){
      let a = 0;
      if(algo==="Eps") a = actEpsGreedy();
      else if(algo==="UCB") a = actUCB1();
      else if(algo==="TS")  a = actThompson();
      stepOnce(a);
    }
    drawBars(); drawLines();
  };

  stepBtn.onclick = ()=>{
    const algo = getAlgo();
    if(algo==="Manual") return;
    let a = 0;
    if(algo==="Eps") a = actEpsGreedy();
    else if(algo==="UCB") a = actUCB1();
    else if(algo==="TS")  a = actThompson();
    stepOnce(a);
    drawBars(); drawLines();
  };

  resetBtn.onclick = ()=>{
    t=0; est=Array(K).fill(0); pulls=Array(K).fill(0);
    postA=Array(K).fill(1); postB=Array(K).fill(1);
    rewards=[]; regret=[]; cumReward=0;
    drawBars(); drawLines();
  };

  // Initial draw
  drawBars(); drawLines();
})();
</script>
</div></div>
</div>
<p>Below are the equations we use for the above examples:</p>
<p><strong>ε-greedy</strong>: explore random arm with prob ε, otherwise pick highest mean estimate.
<code class="docutils literal notranslate"><span class="pre">est</span> <span class="pre">=</span> <span class="pre">s/n</span></code> is average reward per arm; we update counts each step.
<code class="docutils literal notranslate"><span class="pre">avg</span></code> is cumulative average reward over time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.78</span><span class="p">,</span> <span class="mf">0.72</span><span class="p">,</span> <span class="mf">0.48</span><span class="p">,</span> <span class="mf">0.44</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="c1">#cat A to H</span>
<span class="n">K</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">pull</span><span class="p">(</span><span class="n">arm</span><span class="p">,</span> <span class="n">rng</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">means</span><span class="p">[</span><span class="n">arm</span><span class="p">]))</span>

<span class="c1"># ε-greedy (simple math: est = s/n, pick max; cum avg = total/t)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">run_eps_greedy</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="nb">int</span><span class="p">);</span> <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">K</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">est</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">ties</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">est</span> <span class="o">==</span> <span class="n">est</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">ties</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">pull</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">rng</span><span class="p">);</span> <span class="n">n</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">s</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+=</span> <span class="n">r</span><span class="p">;</span> <span class="n">total</span> <span class="o">+=</span> <span class="n">r</span>
        <span class="n">avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span> <span class="o">/</span> <span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">avg</span><span class="p">),</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span>

<span class="n">avg_e</span><span class="p">,</span> <span class="n">n_e</span><span class="p">,</span> <span class="n">s_e</span> <span class="o">=</span> <span class="n">run_eps_greedy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">avg_e</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;average reward&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Epsilon greedy&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1e850e523b8baa019d032d57b13265b0ec405a51836d6b230ed6caa351348a9f.png" src="_images/1e850e523b8baa019d032d57b13265b0ec405a51836d6b230ed6caa351348a9f.png" />
</div>
</div>
<p><strong>UCB1</strong>: each arm starts once; after that use <code class="docutils literal notranslate"><span class="pre">est</span> <span class="pre">+</span> <span class="pre">sqrt(2</span> <span class="pre">ln</span> <span class="pre">t</span> <span class="pre">/</span> <span class="pre">n)</span></code>.
This bonus term encourages <strong>early exploration</strong> and <strong>later exploitation</strong>.
<code class="docutils literal notranslate"><span class="pre">avg</span></code> shows how the average reward improves over time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># UCB1 (simple math: est = s/n, bonus = sqrt(2 ln t / n); cum avg)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">run_ucb1</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="nb">int</span><span class="p">);</span> <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="c1"># pull each arm once</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">pull</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">rng</span><span class="p">);</span> <span class="n">n</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">s</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+=</span> <span class="n">r</span><span class="p">;</span> <span class="n">total</span> <span class="o">+=</span> <span class="n">r</span>
        <span class="n">avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1"># then UCB</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">est</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">n</span>
        <span class="n">bonus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">est</span> <span class="o">+</span> <span class="n">bonus</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">pull</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">rng</span><span class="p">);</span> <span class="n">n</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">s</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+=</span> <span class="n">r</span><span class="p">;</span> <span class="n">total</span> <span class="o">+=</span> <span class="n">r</span>
        <span class="n">avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span> <span class="o">/</span> <span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">avg</span><span class="p">),</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span>

<span class="n">avg_u</span><span class="p">,</span> <span class="n">n_u</span><span class="p">,</span> <span class="n">s_u</span> <span class="o">=</span> <span class="n">run_ucb1</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">avg_u</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;average reward&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;UCB1&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ca73986d534054210fb306c2530a9a36a43594d88acf7dc954c89b8daec4ca28.png" src="_images/ca73986d534054210fb306c2530a9a36a43594d88acf7dc954c89b8daec4ca28.png" />
</div>
</div>
<p><strong>Thompson sampling</strong>: each arm has <code class="docutils literal notranslate"><span class="pre">Beta(a,b)</span></code> belief; sample, pick highest.
Update <code class="docutils literal notranslate"><span class="pre">a+=r</span></code> (success) and <code class="docutils literal notranslate"><span class="pre">b+=(1−r)</span></code> (failure) each step.
<code class="docutils literal notranslate"><span class="pre">avg</span></code> shows how Bayesian exploration converges to best catalyst.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Thompson (simple math: Beta(a,b); sample; update a+=r, b+=(1-r); cum avg)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">run_thompson</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">a_cnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">K</span><span class="p">);</span> <span class="n">b_cnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">a_cnt</span><span class="p">,</span> <span class="n">b_cnt</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">pull</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">rng</span><span class="p">);</span> <span class="n">total</span> <span class="o">+=</span> <span class="n">r</span>
        <span class="n">a_cnt</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+=</span> <span class="n">r</span><span class="p">;</span> <span class="n">b_cnt</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span> <span class="o">/</span> <span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">avg</span><span class="p">),</span> <span class="n">a_cnt</span><span class="p">,</span> <span class="n">b_cnt</span>

<span class="n">avg_t</span><span class="p">,</span> <span class="n">a_t</span><span class="p">,</span> <span class="n">b_t</span> <span class="o">=</span> <span class="n">run_thompson</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">avg_t</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;average reward&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Thompson sampling&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/121bf78ac435e6574857add38f4863dcaae7de7257475455b41cb29a81940a27.png" src="_images/121bf78ac435e6574857add38f4863dcaae7de7257475455b41cb29a81940a27.png" />
</div>
</div>
<p>Beta(a,b) belief:
Each curve below shows how the distribution changes as successes (<code class="docutils literal notranslate"><span class="pre">a</span></code>) and failures (<code class="docutils literal notranslate"><span class="pre">b</span></code>) grow.</p>
<ul class="simple">
<li><p>High a → belief shifts toward 1.</p></li>
<li><p>High b → belief shifts toward 0.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Beta(1,1)</span></code> is uniform (complete uncertainty).</p>
<p><code class="docutils literal notranslate"><span class="pre">Beta(1,1)</span></code> → flat line (no knowledge yet).</p>
<p><code class="docutils literal notranslate"><span class="pre">Beta(5,2)</span></code> → skewed right (we’ve seen mostly successes).</p>
<p><code class="docutils literal notranslate"><span class="pre">Beta(2,5)</span></code> → skewed left (mostly failures).</p>
<p>As counts rise (e.g., <code class="docutils literal notranslate"><span class="pre">Beta(20,5)</span></code>), the curve narrows — higher confidence in the estimate.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Beta(a,b) belief plot:</span>
<span class="sd">Each curve shows how the distribution changes as successes (a) and failures (b) grow.</span>
<span class="sd">High a → belief shifts toward 1. High b → belief shifts toward 0.</span>
<span class="sd">Beta(1,1) is uniform (complete uncertainty).</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span><span class="o">,</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">beta</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">5</span><span class="p">)]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">beta</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;a=</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">, b=</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Beta(a,b) belief distributions&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;success probability (p)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;density&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/9af59cf72b13582ce63c2f8887d9e5799c5c464cda56941526b71baeb0a7ef71.png" src="_images/9af59cf72b13582ce63c2f8887d9e5799c5c464cda56941526b71baeb0a7ef71.png" />
</div>
</div>
</section>
<hr class="docutils" />
<section id="case-study-mof-synthesis-as-a-bandit-on-yield">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">5. Case study: MOF synthesis as a bandit on yield</a><a class="headerlink" href="#case-study-mof-synthesis-as-a-bandit-on-yield" title="Permalink to this heading">#</a></h2>
<p>We will use the synthetic MOF dataset we seen in the last lecture. It records outcomes for combinations of <code class="docutils literal notranslate"><span class="pre">temperature</span></code>, <code class="docutils literal notranslate"><span class="pre">time</span></code>, <code class="docutils literal notranslate"><span class="pre">concentration</span></code>, <code class="docutils literal notranslate"><span class="pre">solvent</span> <span class="pre">identity</span></code>, and the <code class="docutils literal notranslate"><span class="pre">organic</span> <span class="pre">linker</span></code>.</p>
<p>For this version we focus on <strong>yield only</strong> in the range [0, 1]. The goal is to find <strong>general synthesis conditions</strong> that give high yield for each of 10 linkers.</p>
<p>The dataset acts as our simulator. Each time the bandit chooses a recipe the simulator samples a matching row and returns its yield.</p>
<div class="admonition-note admonition">
<p class="admonition-title">Note</p>
<p>For this section, please use Google Colab to run.
Below only code is shown.</p>
</div>
<section id="load-and-process-the-dataset">
<h3>5.1 Load and process the dataset<a class="headerlink" href="#load-and-process-the-dataset" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load full dataset</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/zzhenglab/ai4chem/main/book/_data/mof_yield_dataset.csv&quot;</span>
<span class="n">df_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="c1"># Pick the 10 most frequent linkers so each has adequate coverage in the table</span>
<span class="n">top_linkers</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">linker_actions</span><span class="p">(</span><span class="n">df_like</span><span class="p">,</span> <span class="n">linker</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;All condition tuples that actually exist for this linker.&quot;&quot;&quot;</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">df_like</span><span class="p">[</span><span class="n">df_like</span><span class="p">[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">linker</span><span class="p">]</span>
    <span class="n">acts</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">sub</span><span class="p">[[</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span><span class="s1">&#39;time_h&#39;</span><span class="p">,</span><span class="s1">&#39;concentration_M&#39;</span><span class="p">,</span><span class="s1">&#39;solvent_DMF&#39;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">acts</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_pull_yield</span><span class="p">(</span><span class="n">df_like</span><span class="p">,</span> <span class="n">linker</span><span class="p">,</span> <span class="n">acts</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a function pull(action, rng) -&gt; yield in [0,1], sampling from rows observed for this linker+action.</span>
<span class="sd">    If an action is not present for the linker it is skipped upstream, so we do not synthesize data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pools</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">sub_all</span> <span class="o">=</span> <span class="n">df_like</span><span class="p">[</span><span class="n">df_like</span><span class="p">[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">linker</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">acts</span><span class="p">:</span>
        <span class="n">T</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">S</span> <span class="o">=</span> <span class="n">a</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">sub_all</span><span class="p">[</span>
            <span class="p">(</span><span class="n">sub_all</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">T</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">sub_all</span><span class="p">[</span><span class="s1">&#39;time_h&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">H</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">sub_all</span><span class="p">[</span><span class="s1">&#39;concentration_M&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">C</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">sub_all</span><span class="p">[</span><span class="s1">&#39;solvent_DMF&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">S</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pool</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">pools</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pull_fn</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">rng</span><span class="p">):</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">pools</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pool</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="p">)))]</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;yield&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pull_fn</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fmt_action</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="n">T</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">S</span> <span class="o">=</span> <span class="n">a</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;T=</span><span class="si">{</span><span class="n">T</span><span class="si">}</span><span class="s2">°C, t=</span><span class="si">{</span><span class="n">H</span><span class="si">}</span><span class="s2">h, c=</span><span class="si">{</span><span class="n">C</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> M, solvent=</span><span class="si">{</span><span class="s1">&#39;DMF&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">S</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;H2O&#39;</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="n">top_linkers</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">HTTPError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># Load full dataset</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/zzhenglab/ai4chem/main/book/_data/mof_yield_dataset.csv&quot;</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">df_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="c1"># Pick the 10 most frequent linkers so each has adequate coverage in the table</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">top_linkers</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="nn">File c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\pandas\io\parsers\readers.py:912,</span> in <span class="ni">read_csv</span><span class="nt">(filepath_or_buffer, sep, delimiter, header, names, index_col, usecols, dtype, engine, converters, true_values, false_values, skipinitialspace, skiprows, skipfooter, nrows, na_values, keep_default_na, na_filter, verbose, skip_blank_lines, parse_dates, infer_datetime_format, keep_date_col, date_parser, date_format, dayfirst, cache_dates, iterator, chunksize, compression, thousands, decimal, lineterminator, quotechar, quoting, doublequote, escapechar, comment, encoding, encoding_errors, dialect, on_bad_lines, delim_whitespace, low_memory, memory_map, float_precision, storage_options, dtype_backend)</span>
<span class="g g-Whitespace">    </span><span class="mi">899</span> <span class="n">kwds_defaults</span> <span class="o">=</span> <span class="n">_refine_defaults_read</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">900</span>     <span class="n">dialect</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">901</span>     <span class="n">delimiter</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">908</span>     <span class="n">dtype_backend</span><span class="o">=</span><span class="n">dtype_backend</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">909</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">910</span> <span class="n">kwds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwds_defaults</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">912</span> <span class="k">return</span> <span class="n">_read</span><span class="p">(</span><span class="n">filepath_or_buffer</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span>

<span class="nn">File c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\pandas\io\parsers\readers.py:577,</span> in <span class="ni">_read</span><span class="nt">(filepath_or_buffer, kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">574</span> <span class="n">_validate_names</span><span class="p">(</span><span class="n">kwds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;names&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">576</span> <span class="c1"># Create the parser.</span>
<span class="ne">--&gt; </span><span class="mi">577</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">TextFileReader</span><span class="p">(</span><span class="n">filepath_or_buffer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">579</span> <span class="k">if</span> <span class="n">chunksize</span> <span class="ow">or</span> <span class="n">iterator</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">580</span>     <span class="k">return</span> <span class="n">parser</span>

<span class="nn">File c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\pandas\io\parsers\readers.py:1407,</span> in <span class="ni">TextFileReader.__init__</span><span class="nt">(self, f, engine, **kwds)</span>
<span class="g g-Whitespace">   </span><span class="mi">1404</span>     <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;has_index_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;has_index_names&quot;</span><span class="p">]</span>
<span class="g g-Whitespace">   </span><span class="mi">1406</span> <span class="bp">self</span><span class="o">.</span><span class="n">handles</span><span class="p">:</span> <span class="n">IOHandles</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="ne">-&gt; </span><span class="mi">1407</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_engine</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

<span class="nn">File c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\pandas\io\parsers\readers.py:1661,</span> in <span class="ni">TextFileReader._make_engine</span><span class="nt">(self, f, engine)</span>
<span class="g g-Whitespace">   </span><span class="mi">1659</span>     <span class="k">if</span> <span class="s2">&quot;b&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1660</span>         <span class="n">mode</span> <span class="o">+=</span> <span class="s2">&quot;b&quot;</span>
<span class="ne">-&gt; </span><span class="mi">1661</span> <span class="bp">self</span><span class="o">.</span><span class="n">handles</span> <span class="o">=</span> <span class="n">get_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1662</span>     <span class="n">f</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1663</span>     <span class="n">mode</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1664</span>     <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;encoding&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1665</span>     <span class="n">compression</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compression&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1666</span>     <span class="n">memory_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;memory_map&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1667</span>     <span class="n">is_text</span><span class="o">=</span><span class="n">is_text</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1668</span>     <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;encoding_errors&quot;</span><span class="p">,</span> <span class="s2">&quot;strict&quot;</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1669</span>     <span class="n">storage_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;storage_options&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1670</span> <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1671</span> <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">handles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="g g-Whitespace">   </span><span class="mi">1672</span> <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handles</span><span class="o">.</span><span class="n">handle</span>

<span class="nn">File c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\pandas\io\common.py:716,</span> in <span class="ni">get_handle</span><span class="nt">(path_or_buf, mode, encoding, compression, memory_map, is_text, errors, storage_options)</span>
<span class="g g-Whitespace">    </span><span class="mi">713</span>     <span class="n">codecs</span><span class="o">.</span><span class="n">lookup_error</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">715</span> <span class="c1"># open URLs</span>
<span class="ne">--&gt; </span><span class="mi">716</span> <span class="n">ioargs</span> <span class="o">=</span> <span class="n">_get_filepath_or_buffer</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">717</span>     <span class="n">path_or_buf</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">718</span>     <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">719</span>     <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">720</span>     <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">721</span>     <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">722</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">724</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">ioargs</span><span class="o">.</span><span class="n">filepath_or_buffer</span>
<span class="g g-Whitespace">    </span><span class="mi">725</span> <span class="n">handles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseBuffer</span><span class="p">]</span>

<span class="nn">File c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\pandas\io\common.py:368,</span> in <span class="ni">_get_filepath_or_buffer</span><span class="nt">(filepath_or_buffer, encoding, compression, mode, storage_options)</span>
<span class="g g-Whitespace">    </span><span class="mi">366</span> <span class="c1"># assuming storage_options is to be interpreted as headers</span>
<span class="g g-Whitespace">    </span><span class="mi">367</span> <span class="n">req_info</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">filepath_or_buffer</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">storage_options</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">368</span> <span class="k">with</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">req_info</span><span class="p">)</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">369</span>     <span class="n">content_encoding</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Encoding&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">370</span>     <span class="k">if</span> <span class="n">content_encoding</span> <span class="o">==</span> <span class="s2">&quot;gzip&quot;</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">371</span>         <span class="c1"># Override compression based on Content-Encoding header</span>

<span class="nn">File c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\pandas\io\common.py:270,</span> in <span class="ni">urlopen</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span><span class="sd"> Lazy-import wrapper for stdlib urlopen, as that imports a big chunk of</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span><span class="sd"> the stdlib.</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span> <span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
<span class="ne">--&gt; </span><span class="mi">270</span> <span class="k">return</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File c:\users\52377\appdata\local\programs\python\python38\lib\urllib\request.py:222,</span> in <span class="ni">urlopen</span><span class="nt">(url, data, timeout, cafile, capath, cadefault, context)</span>
<span class="g g-Whitespace">    </span><span class="mi">220</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">221</span>     <span class="n">opener</span> <span class="o">=</span> <span class="n">_opener</span>
<span class="ne">--&gt; </span><span class="mi">222</span> <span class="k">return</span> <span class="n">opener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>

<span class="nn">File c:\users\52377\appdata\local\programs\python\python38\lib\urllib\request.py:531,</span> in <span class="ni">OpenerDirector.open</span><span class="nt">(self, fullurl, data, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span> <span class="k">for</span> <span class="n">processor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="p">[]):</span>
<span class="g g-Whitespace">    </span><span class="mi">530</span>     <span class="n">meth</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">meth_name</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">531</span>     <span class="n">response</span> <span class="o">=</span> <span class="n">meth</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">533</span> <span class="k">return</span> <span class="n">response</span>

<span class="nn">File c:\users\52377\appdata\local\programs\python\python38\lib\urllib\request.py:640,</span> in <span class="ni">HTTPErrorProcessor.http_response</span><span class="nt">(self, request, response)</span>
<span class="g g-Whitespace">    </span><span class="mi">637</span> <span class="c1"># According to RFC 2616, &quot;2xx&quot; code indicates that the client&#39;s</span>
<span class="g g-Whitespace">    </span><span class="mi">638</span> <span class="c1"># request was successfully received, understood, and accepted.</span>
<span class="g g-Whitespace">    </span><span class="mi">639</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">200</span> <span class="o">&lt;=</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">640</span>     <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">641</span>         <span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">hdrs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">643</span> <span class="k">return</span> <span class="n">response</span>

<span class="nn">File c:\users\52377\appdata\local\programs\python\python38\lib\urllib\request.py:569,</span> in <span class="ni">OpenerDirector.error</span><span class="nt">(self, proto, *args)</span>
<span class="g g-Whitespace">    </span><span class="mi">567</span> <span class="k">if</span> <span class="n">http_err</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">568</span>     <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;http_error_default&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">orig_args</span>
<span class="ne">--&gt; </span><span class="mi">569</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_chain</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="nn">File c:\users\52377\appdata\local\programs\python\python38\lib\urllib\request.py:502,</span> in <span class="ni">OpenerDirector._call_chain</span><span class="nt">(self, chain, kind, meth_name, *args)</span>
<span class="g g-Whitespace">    </span><span class="mi">500</span> <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">handlers</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">501</span>     <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">meth_name</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">502</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">503</span>     <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">504</span>         <span class="k">return</span> <span class="n">result</span>

<span class="nn">File c:\users\52377\appdata\local\programs\python\python38\lib\urllib\request.py:649,</span> in <span class="ni">HTTPDefaultErrorHandler.http_error_default</span><span class="nt">(self, req, fp, code, msg, hdrs)</span>
<span class="g g-Whitespace">    </span><span class="mi">648</span> <span class="k">def</span><span class="w"> </span><span class="nf">http_error_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">hdrs</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">649</span>     <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">full_url</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">hdrs</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>

<span class="ne">HTTPError</span>: HTTP Error 404: Not Found
</pre></div>
</div>
</div>
</div>
</section>
<section id="bandit-framing-and-algorithms">
<h3>5.2 Bandit framing and algorithms<a class="headerlink" href="#bandit-framing-and-algorithms" title="Permalink to this heading">#</a></h3>
<p>We treat each unique recipe as an arm and the yield as the reward. Rewards are bounded in <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">1]</span></code>, which suits UCB1 on sample means.</p>
<p>For Thompson sampling we use a Beta posterior heuristic that accumulates alpha plus equal to yield and beta plus equal to 1 minus yield. This gives a simple way to sample optimistic beliefs for continuous bounded outcomes without converting to binary success. We also include ε greedy on the mean yield for a familiar baseline.</p>
<p>All algorithms run per linker so each linker gets a focused search over the actions that actually appear in the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Section 2: Bandit agents for bounded rewards in [0,1]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_eps_mean_linker</span><span class="p">(</span><span class="n">df_like</span><span class="p">,</span> <span class="n">linker</span><span class="p">,</span> <span class="n">Tsteps</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">acts</span> <span class="o">=</span> <span class="n">linker_actions</span><span class="p">(</span><span class="n">df_like</span><span class="p">,</span> <span class="n">linker</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">acts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">avg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">n</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">best</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">acts</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">K</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">acts</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>           <span class="c1"># pulls</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>         <span class="c1"># sum of yields</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">pull</span> <span class="o">=</span> <span class="n">make_pull_yield</span><span class="p">(</span><span class="n">df_like</span><span class="p">,</span> <span class="n">linker</span><span class="p">,</span> <span class="n">acts</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Tsteps</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">K</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">est</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">est</span><span class="o">.</span><span class="n">max</span><span class="p">();</span> <span class="n">ties</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">est</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
            <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">ties</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">pull</span><span class="p">(</span><span class="n">acts</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">rng</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">n</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span><span class="p">;</span> <span class="n">s</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">+=</span><span class="n">r</span><span class="p">;</span> <span class="n">total</span><span class="o">+=</span><span class="n">r</span>
        <span class="n">avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span><span class="o">/</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">avg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">best</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">acts</span><span class="o">=</span><span class="n">acts</span><span class="p">)</span>
    <span class="n">best</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)))</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">avg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">avg</span><span class="p">),</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">best</span><span class="o">=</span><span class="n">best</span><span class="p">,</span> <span class="n">acts</span><span class="o">=</span><span class="n">acts</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_ucb1_mean_linker</span><span class="p">(</span><span class="n">df_like</span><span class="p">,</span> <span class="n">linker</span><span class="p">,</span> <span class="n">Tsteps</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">acts</span> <span class="o">=</span> <span class="n">linker_actions</span><span class="p">(</span><span class="n">df_like</span><span class="p">,</span> <span class="n">linker</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">acts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">avg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">n</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">best</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">acts</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">K</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">acts</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="nb">int</span><span class="p">);</span> <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">pull</span> <span class="o">=</span> <span class="n">make_pull_yield</span><span class="p">(</span><span class="n">df_like</span><span class="p">,</span> <span class="n">linker</span><span class="p">,</span> <span class="n">acts</span><span class="p">)</span>
    <span class="c1"># small warm start to avoid zero-division</span>
    <span class="n">tried</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="mi">10</span><span class="p">)):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">pull</span><span class="p">(</span><span class="n">acts</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">rng</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="k">continue</span>
        <span class="n">n</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span><span class="p">;</span> <span class="n">s</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">+=</span><span class="n">r</span><span class="p">;</span> <span class="n">total</span><span class="o">+=</span><span class="n">r</span><span class="p">;</span> <span class="n">tried</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span><span class="o">/</span><span class="n">tried</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tried</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">Tsteps</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">est</span> <span class="o">=</span> <span class="n">s</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">bonus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">est</span> <span class="o">+</span> <span class="n">bonus</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">pull</span><span class="p">(</span><span class="n">acts</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">rng</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="k">continue</span>
        <span class="n">n</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span><span class="p">;</span> <span class="n">s</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">+=</span><span class="n">r</span><span class="p">;</span> <span class="n">total</span><span class="o">+=</span><span class="n">r</span>
        <span class="n">avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avg</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">avg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">best</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">acts</span><span class="o">=</span><span class="n">acts</span><span class="p">)</span>
    <span class="n">best</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)))</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">avg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">avg</span><span class="p">),</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">best</span><span class="o">=</span><span class="n">best</span><span class="p">,</span> <span class="n">acts</span><span class="o">=</span><span class="n">acts</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_thompson_beta_linker</span><span class="p">(</span><span class="n">df_like</span><span class="p">,</span> <span class="n">linker</span><span class="p">,</span> <span class="n">Tsteps</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Thompson with a Beta posterior heuristic for bounded yields.</span>
<span class="sd">    alpha += yield, beta += 1 - yield.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">acts</span> <span class="o">=</span> <span class="n">linker_actions</span><span class="p">(</span><span class="n">df_like</span><span class="p">,</span> <span class="n">linker</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">acts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">avg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">n</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">best</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">acts</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">K</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">acts</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">K</span><span class="p">);</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="nb">int</span><span class="p">);</span> <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">pull</span> <span class="o">=</span> <span class="n">make_pull_yield</span><span class="p">(</span><span class="n">df_like</span><span class="p">,</span> <span class="n">linker</span><span class="p">,</span> <span class="n">acts</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Tsteps</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">pull</span><span class="p">(</span><span class="n">acts</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">rng</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="k">continue</span>
        <span class="n">n</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span><span class="p">;</span> <span class="n">s</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">+=</span><span class="n">r</span><span class="p">;</span> <span class="n">total</span><span class="o">+=</span><span class="n">r</span>
        <span class="n">alpha</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+=</span> <span class="n">r</span>
        <span class="n">beta</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>  <span class="o">+=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total</span><span class="o">/</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">avg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">best</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">acts</span><span class="o">=</span><span class="n">acts</span><span class="p">)</span>
    <span class="n">best</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)))</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">avg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">avg</span><span class="p">),</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">best</span><span class="o">=</span><span class="n">best</span><span class="p">,</span> <span class="n">acts</span><span class="o">=</span><span class="n">acts</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">summarize_agent</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="n">best</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;best&quot;</span><span class="p">];</span> <span class="n">acts</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;acts&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">acts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">linker</span><span class="o">=</span><span class="n">linker</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">recipe</span><span class="o">=</span><span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="n">pulls</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mean_yield</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">linker</span><span class="o">=</span><span class="n">linker</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">recipe</span><span class="o">=</span><span class="n">fmt_action</span><span class="p">(</span><span class="n">acts</span><span class="p">[</span><span class="n">best</span><span class="p">]),</span>
        <span class="n">pulls</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">best</span><span class="p">]),</span>
        <span class="n">mean_yield</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">best</span><span class="p">]</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">[</span><span class="n">best</span><span class="p">]))</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="running-the-agents-and-building-a-compact-report">
<h3>5.3  Running the agents and building a compact report<a class="headerlink" href="#running-the-agents-and-building-a-compact-report" title="Permalink to this heading">#</a></h3>
<p>We now run <code class="docutils literal notranslate"><span class="pre">ε</span> <span class="pre">greedy</span></code>, <code class="docutils literal notranslate"><span class="pre">UCB1</span></code>, and <code class="docutils literal notranslate"><span class="pre">Thompson</span> <span class="pre">Beta</span></code> for <strong>each of the 10 linkers</strong>. Each agent interacts with a simulator that returns yields for recipes that are actually in the table for that linker.</p>
<p>We then summarize the <strong>best recipe per agent</strong> by its <em>mean</em> yield and also produce one recommended recipe per linker by taking the top mean yield across agents. This gives a short list of general conditions to try first in the lab for each linker.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Section 3: Execute agents and summarize best recipes per linker</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">curves</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">linker</span> <span class="ow">in</span> <span class="n">top_linkers</span><span class="p">:</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">run_eps_mean_linker</span>     <span class="p">(</span><span class="n">df_raw</span><span class="p">,</span> <span class="n">linker</span><span class="p">,</span> <span class="n">Tsteps</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">ucb</span> <span class="o">=</span> <span class="n">run_ucb1_mean_linker</span>    <span class="p">(</span><span class="n">df_raw</span><span class="p">,</span> <span class="n">linker</span><span class="p">,</span> <span class="n">Tsteps</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">ts</span>  <span class="o">=</span> <span class="n">run_thompson_beta_linker</span><span class="p">(</span><span class="n">df_raw</span><span class="p">,</span> <span class="n">linker</span><span class="p">,</span> <span class="n">Tsteps</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

    <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
        <span class="n">summarize_agent</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="s2">&quot;eps_greedy&quot;</span><span class="p">,</span> <span class="n">eps</span><span class="p">),</span>
        <span class="n">summarize_agent</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="s2">&quot;ucb1&quot;</span><span class="p">,</span> <span class="n">ucb</span><span class="p">),</span>
        <span class="n">summarize_agent</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="s2">&quot;thompson_beta&quot;</span><span class="p">,</span> <span class="n">ts</span><span class="p">),</span>
    <span class="p">])</span>
    <span class="n">curves</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">linker</span><span class="p">,</span> <span class="n">eps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;avg&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])),</span> <span class="n">ucb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;avg&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])),</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;avg&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]))))</span>

<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;linker&quot;</span><span class="p">,</span><span class="s2">&quot;mean_yield&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Per-linker best by agent (first 12 rows):&quot;</span><span class="p">)</span>
<span class="n">summary_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_by_linker</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">summary_df</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;linker&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">first</span><span class="p">()[[</span><span class="s2">&quot;linker&quot;</span><span class="p">,</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span><span class="s2">&quot;recipe&quot;</span><span class="p">,</span><span class="s2">&quot;pulls&quot;</span><span class="p">,</span><span class="s2">&quot;mean_yield&quot;</span><span class="p">]]</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">One recommended recipe per linker by highest mean yield across agents:&quot;</span><span class="p">)</span>
<span class="n">best_by_linker</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="interpreting-the-results-and-tracking-learning">
<h3>5.4 Interpreting the results and tracking learning<a class="headerlink" href="#interpreting-the-results-and-tracking-learning" title="Permalink to this heading">#</a></h3>
<p>The table lists a best recipe per agent for each linker together with the number of pulls used to estimate its mean yield. If a best recipe shows very few pulls you can increase the step budget or run another pass to confirm stability. Learning curves help you see whether the agent is still exploring or has stabilized on a high yielding recipe. Consistent upward trends suggest the action set has a clear winner for that linker. Flat or noisy curves suggest multiple near ties or limited coverage in the dataset for that linker.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Section 4: Plot learning curves for a few linkers</span>

<span class="n">show_n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">curves</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">show_n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">show_n</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">if</span> <span class="n">show_n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">linker</span><span class="p">,</span> <span class="n">avg_e</span><span class="p">,</span> <span class="n">avg_u</span><span class="p">,</span> <span class="n">avg_t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">curves</span><span class="p">[:</span><span class="n">show_n</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">avg_e</span><span class="o">.</span><span class="n">size</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">avg_e</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ε greedy&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">avg_u</span><span class="o">.</span><span class="n">size</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">avg_u</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;UCB1&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">avg_t</span><span class="o">.</span><span class="n">size</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">avg_t</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Thompson Beta&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average yield over steps | </span><span class="si">{</span><span class="n">linker</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;avg yield&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the columns </span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;linker&quot;</span><span class="p">,</span> <span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="s2">&quot;recipe&quot;</span><span class="p">,</span> <span class="s2">&quot;pulls&quot;</span><span class="p">,</span> <span class="s2">&quot;mean_yield&quot;</span><span class="p">]</span>




<span class="c1"># Top 3 recipes per linker so you can see near ties</span>
<span class="n">top3</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">summary_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;linker&quot;</span><span class="p">,</span><span class="s2">&quot;mean_yield&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
              <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;linker&quot;</span><span class="p">)</span>
              <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)[</span><span class="n">cols</span><span class="p">]</span>
              <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top 3 per linker&quot;</span><span class="p">)</span>
<span class="n">top3</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="general-synthesis-condition-works-best-across-all-linkers">
<h3>5.5 General synthesis condition works best across all linkers<a class="headerlink" href="#general-synthesis-condition-works-best-across-all-linkers" title="Permalink to this heading">#</a></h3>
<p>Finally, instead of looking at <strong>per-linker optima</strong>, we can also look at if there is a <strong>a single “general” synthesis condition across the 10 linkers</strong>.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find one general synthesis condition that works best across linkers</span>
<span class="c1"># using the true yields in the dataset as ground truth</span>

<span class="c1"># Choose top 10 linkers by frequency</span>
<span class="n">top_linkers</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">top_linkers</span><span class="p">)</span><span class="si">}</span><span class="s2"> linkers&quot;</span><span class="p">)</span>

<span class="c1"># ----------------------------------------------------</span>
<span class="c1"># Step 1: Identify condition combinations (T, time, conc, solvent)</span>
<span class="c1"># that appear in most linkers</span>
<span class="c1"># ----------------------------------------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">actions_for_linker</span><span class="p">(</span><span class="n">df_like</span><span class="p">,</span> <span class="n">linker</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span>
        <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_like</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_like</span><span class="p">[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">linker</span><span class="p">,</span>
            <span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span><span class="s1">&#39;time_h&#39;</span><span class="p">,</span><span class="s1">&#39;concentration_M&#39;</span><span class="p">,</span><span class="s1">&#39;solvent_DMF&#39;</span><span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
<span class="n">cnt</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
<span class="n">acts_per_linker</span> <span class="o">=</span> <span class="p">[</span><span class="n">actions_for_linker</span><span class="p">(</span><span class="n">df_raw</span><span class="p">,</span> <span class="n">lk</span><span class="p">)</span> <span class="k">for</span> <span class="n">lk</span> <span class="ow">in</span> <span class="n">top_linkers</span><span class="p">]</span>
<span class="k">for</span> <span class="n">acts</span> <span class="ow">in</span> <span class="n">acts_per_linker</span><span class="p">:</span> <span class="n">cnt</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acts</span><span class="p">)</span>

<span class="c1"># keep actions that exist in at least 8 of 10 linkers</span>
<span class="n">common_actions</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="n">cnt</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Candidate shared recipes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">common_actions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># ----------------------------------------------------</span>
<span class="c1"># Step 2: compute true mean yield for each linker at each condition</span>
<span class="c1"># and average across linkers</span>
<span class="c1"># ----------------------------------------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fmt_action</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="n">T</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">S</span> <span class="o">=</span> <span class="n">a</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;T=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="si">}</span><span class="s2">°C, t=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">H</span><span class="p">)</span><span class="si">}</span><span class="s2">h, c=</span><span class="si">{</span><span class="n">C</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> M, solvent=</span><span class="si">{</span><span class="s1">&#39;DMF&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;H2O&#39;</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">common_actions</span><span class="p">:</span>
    <span class="n">T</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">S</span> <span class="o">=</span> <span class="n">a</span>
    <span class="n">per_linker_means</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">lk</span> <span class="ow">in</span> <span class="n">top_linkers</span><span class="p">:</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">lk</span><span class="p">)</span><span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">T</span><span class="p">)</span><span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;time_h&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">H</span><span class="p">)</span><span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;concentration_M&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">C</span><span class="p">)</span><span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;solvent_DMF&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">S</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">per_linker_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;yield&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">per_linker_means</span><span class="p">:</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;recipe&quot;</span><span class="p">:</span> <span class="n">fmt_action</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
            <span class="s2">&quot;coverage&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">per_linker_means</span><span class="p">),</span>
            <span class="s2">&quot;mean_yield_all&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">per_linker_means</span><span class="p">),</span>
            <span class="s2">&quot;median_yield&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">per_linker_means</span><span class="p">),</span>
            <span class="s2">&quot;min_yield&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">per_linker_means</span><span class="p">),</span>
            <span class="s2">&quot;max_yield&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">per_linker_means</span><span class="p">),</span>
        <span class="p">})</span>

<span class="n">summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="p">[</span><span class="s2">&quot;coverage&quot;</span><span class="p">,</span><span class="s2">&quot;mean_yield_all&quot;</span><span class="p">,</span><span class="s2">&quot;median_yield&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># ----------------------------------------------------</span>
<span class="c1"># Step 3: show the best general condition with ground truth stats</span>
<span class="c1"># ----------------------------------------------------</span>
<span class="k">if</span> <span class="n">summary</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No overlapping recipe found for most linkers.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">best</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== General synthesis condition (best average yield across linkers) ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">best</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Top 5 general recipes for reference ---&quot;</span><span class="p">)</span>
    <span class="n">summary</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="admonition-note admonition">
<p class="admonition-title">Note</p>
<p>This computes the “general condition” that gives the highest average yield across multiple linkers.
It first finds recipes appearing for most linkers, computes their true mean yield per linker from the dataset, then averages those means. The result lists a single synthesis condition that is empirically best overall,  along with its average, median, and range of yields across linkers.</p>
</div>
<p><strong>Results</strong>:
=== General synthesis condition (best average yield across linkers) ===
<em>recipe            T=130°C, t=60h, c=0.25 M, solvent=DMF</em>
coverage                                             10
mean_yield_all                                     0.73
median_yield                                      0.855
min_yield                                          0.23
max_yield                                          0.99</p>
</section>
</section>
<hr class="docutils" />
<section id="glossary">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">6. Glossary</a><a class="headerlink" href="#glossary" title="Permalink to this heading">#</a></h2>
<dl class="simple glossary">
<dt id="term-Agent">Agent  <a class="headerlink" href="#term-Agent" title="Permalink to this term">#</a></dt><dd><p>The decision maker that picks the next experiment.</p>
</dd>
<dt id="term-Environment">Environment  <a class="headerlink" href="#term-Environment" title="Permalink to this term">#</a></dt><dd><p>The lab or simulator returning outcomes.</p>
</dd>
<dt id="term-Policy">Policy  <a class="headerlink" href="#term-Policy" title="Permalink to this term">#</a></dt><dd><p>Mapping from states to actions.</p>
</dd>
<dt id="term-Q-value">Q value  <a class="headerlink" href="#term-Q-value" title="Permalink to this term">#</a></dt><dd><p>Expected return from a state-action pair.</p>
</dd>
<dt id="term-Return">Return  <a class="headerlink" href="#term-Return" title="Permalink to this term">#</a></dt><dd><p>Discounted sum of future rewards.</p>
</dd>
<dt id="term-Epsilon-greedy">Epsilon greedy  <a class="headerlink" href="#term-Epsilon-greedy" title="Permalink to this term">#</a></dt><dd><p>Random with probability epsilon, else greedy.</p>
</dd>
<dt id="term-UCB1">UCB1  <a class="headerlink" href="#term-UCB1" title="Permalink to this term">#</a></dt><dd><p>Bonus for uncertainty to balance exploration.</p>
</dd>
<dt id="term-Thompson-sampling">Thompson sampling  <a class="headerlink" href="#term-Thompson-sampling" title="Permalink to this term">#</a></dt><dd><p>Posterior sampling strategy.</p>
</dd>
<dt id="term-On-policy">On policy  <a class="headerlink" href="#term-On-policy" title="Permalink to this term">#</a></dt><dd><p>Learn about the policy you execute.</p>
</dd>
</dl>
</section>
<section id="in-class-activity">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">7. In-class activity</a><a class="headerlink" href="#in-class-activity" title="Permalink to this heading">#</a></h2>
<section id="q1">
<h3>Q1<a class="headerlink" href="#q1" title="Permalink to this heading">#</a></h3>
<p>Now it’s time to review the detailed code for the three demo games.
Identify where the reward score is defined, and modify it in the code to observe how the behavior changes.</p>
<p>You can also adjust the design of the games. For example, change <code class="docutils literal notranslate"><span class="pre">0</span></code> and <code class="docutils literal notranslate"><span class="pre">1</span></code> in demo 3 to see how this influences the agent in finding the optimal strategy.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="lecture-15.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Lecture 15 - Multi-objective Bayesian Optimization</p>
      </div>
    </a>
    <a class="right-next"
       href="lecture-17.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Lecture 17 - PU Learning</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">0. Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reinforcement-learning-concepts">1. Reinforcement learning concepts</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#let-s-play-games-to-understand-q-learning">2. Let’s play games to understand Q-Learning!</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interactive-game-1-breakout">2.1 Interactive Game 1 — Breakout</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interactive-game-2-maze">2.2 Interactive Game 2 — Maze</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interactive-game-3-reaction-surface-screening">2.3 Interactive Game 3 — Reaction Surface Screening</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">2.3 Interactive Game 3 — Reaction Surface Screening</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#q-learning-on-a-chemistry-grid">3. Q-learning on a Chemistry Grid</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bridge-to-multi-armed-bandits">4. Bridge to Multi-Armed Bandits</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#case-study-mof-synthesis-as-a-bandit-on-yield">5. Case study: MOF synthesis as a bandit on yield</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-and-process-the-dataset">5.1 Load and process the dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bandit-framing-and-algorithms">5.2 Bandit framing and algorithms</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-agents-and-building-a-compact-report">5.3  Running the agents and building a compact report</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interpreting-the-results-and-tracking-learning">5.4 Interpreting the results and tracking learning</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#general-synthesis-condition-works-best-across-all-linkers">5.5 General synthesis condition works best across all linkers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">6. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-class-activity">7. In-class activity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q1">Q1</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>