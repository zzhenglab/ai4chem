

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Lecture 7 - Decision Trees and Random Forests &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lecture-07a';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to CHEM 5080: AI for Chemistry
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="lecture-01.html">Lecture 1 - Python Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-02.html">Lecture 2 - Pandas and Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-03.html">Lecture 3 - SMILES and RDKit</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-04.html">Lecture 4 - Chemical Structure Identifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-05.html">Lecture 5 - Regression and Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-06.html">Lecture 6 - Cross-Validation</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Flecture-07a.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/lecture-07a.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lecture 7 - Decision Trees and Random Forests</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">0. Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-and-descriptors">1. Data and descriptors</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data">1.1 Load data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-descriptors-from-smiles">1.2 Compute descriptors from SMILES</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decision-trees-what-they-do">2. Decision trees: what they do</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tree-regression-melting-point">3. Tree regression - Melting Point</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-x-and-y">3.1 Prepare <code class="docutils literal notranslate"><span class="pre">X</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#split-into-train-and-test">3.2 Split into train and test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-a-tiny-tree-depth-1-stump">3.3 Fit a tiny tree - depth 1 stump</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#increase-depth-step-by-step">3.4 Increase depth step by step</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#control-leaves-instead-of-depth">3.5 Control leaves instead of depth</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-importance-for-the-chosen-tree">3.6 Feature importance for the chosen tree</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#small-parity-plot-for-the-chosen-tree">3.7 Small parity plot for the chosen tree</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tree-classification-toxicity">4. Tree classification - Toxicity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#encode-the-labels">4.1 Encode the labels</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stratified-split">4.2 Stratified split</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#depth-1-classifier">4.3 Depth 1 classifier</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sweep-max-depth-and-plot-scores">4.4 Sweep <code class="docutils literal notranslate"><span class="pre">max_depth</span></code> and plot scores</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#confusion-matrix-for-the-chosen-depth">4.5 Confusion matrix for the chosen depth</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest-regression">5. Random Forest - regression</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-the-forest-with-oob-score">5.1 Fit the forest with OOB score</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-importance-and-permutation-importance">5.2 Feature importance and permutation importance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-dependence-for-1-feature">5.3 Partial dependence for 1 feature</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#effect-of-n-estimators">5.4 Effect of <code class="docutils literal notranslate"><span class="pre">n_estimators</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest-classification">6. Random Forest - classification</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-and-report-oob-score">6.1 Fit and report OOB score</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#roc-curve">6.2 ROC curve</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#importance-and-top-features">6.3 Importance and top features</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compare-single-tree-vs-forest">7. Compare: single tree vs forest</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hyperparameter-tuning-with-gridsearchcv">8. Hyperparameter tuning with GridSearchCV</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decision-tree-regression">8.1 Decision tree - regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">8.2 Random forest - regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decision-tree-classification">8.3 Decision tree - classification</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">8.4 Random forest - classification</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-one-tree-from-a-forest">9. Inspect one tree from a forest</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#putting-it-together-clean-workflows">10. Putting it together - clean workflows</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#regression-pipeline-random-forest">10.1 Regression pipeline - Random Forest</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#classification-pipeline-random-forest">10.2 Classification pipeline - Random Forest</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-reference">11. Quick reference</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">12. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-class-activities">13. In-class activities</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q1-tree-regression-sweep-min-samples-leaf">Q1. Tree regression - sweep <code class="docutils literal notranslate"><span class="pre">min_samples_leaf</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q2-tree-classification-threshold-tuning">Q2. Tree classification - threshold tuning</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q3-forest-regression-n-estimators-curve">Q3. Forest regression - n_estimators curve</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q4-forest-classification-permutation-importance">Q4. Forest classification - permutation importance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q5-end-to-end-challenge">Q5. End-to-end challenge</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lecture-7-decision-trees-and-random-forests">
<h1>Lecture 7 - Decision Trees and Random Forests<a class="headerlink" href="#lecture-7-decision-trees-and-random-forests" title="Permalink to this heading">#</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#learning-goals" id="id3">Learning goals</a></p></li>
<li><p><a class="reference internal" href="#setup" id="id4">0. Setup</a></p></li>
<li><p><a class="reference internal" href="#data-and-descriptors" id="id5">1. Data and descriptors</a></p></li>
<li><p><a class="reference internal" href="#decision-trees-what-they-do" id="id6">2. Decision trees: what they do</a></p></li>
<li><p><a class="reference internal" href="#tree-regression-melting-point" id="id7">3. Tree regression - Melting Point</a></p></li>
<li><p><a class="reference internal" href="#tree-classification-toxicity" id="id8">4. Tree classification - Toxicity</a></p></li>
<li><p><a class="reference internal" href="#random-forest-regression" id="id9">5. Random Forest - regression</a></p></li>
<li><p><a class="reference internal" href="#random-forest-classification" id="id10">6. Random Forest - classification</a></p></li>
<li><p><a class="reference internal" href="#compare-single-tree-vs-forest" id="id11">7. Compare: single tree vs forest</a></p></li>
<li><p><a class="reference internal" href="#hyperparameter-tuning-with-gridsearchcv" id="id12">8. Hyperparameter tuning with GridSearchCV</a></p></li>
<li><p><a class="reference internal" href="#inspect-one-tree-from-a-forest" id="id13">9. Inspect one tree from a forest</a></p></li>
<li><p><a class="reference internal" href="#putting-it-together-clean-workflows" id="id14">10. Putting it together - clean workflows</a></p></li>
<li><p><a class="reference internal" href="#quick-reference" id="id15">11. Quick reference</a></p></li>
<li><p><a class="reference internal" href="#glossary" id="id16">12. Glossary</a></p></li>
<li><p><a class="reference internal" href="#in-class-activities" id="id17">13. In-class activities</a></p></li>
</ul>
</nav>
<section id="learning-goals">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Learning goals</a><a class="headerlink" href="#learning-goals" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Understand how decision trees split data for <strong>regression</strong> and <strong>classification</strong>.</p></li>
<li><p>Read key hyperparameters: <code class="docutils literal notranslate"><span class="pre">criterion</span></code>, <code class="docutils literal notranslate"><span class="pre">max_depth</span></code>, <code class="docutils literal notranslate"><span class="pre">min_samples_split</span></code>, <code class="docutils literal notranslate"><span class="pre">min_samples_leaf</span></code>, <code class="docutils literal notranslate"><span class="pre">max_features</span></code>.</p></li>
<li><p>Visualize a small tree and interpret splits.</p></li>
<li><p>Diagnose underfitting vs overfitting by sweeping <code class="docutils literal notranslate"><span class="pre">max_depth</span></code>.</p></li>
<li><p>Train a <strong>Random Forest</strong> for regression and classification.</p></li>
<li><p>Use <strong>out-of-bag (OOB)</strong> estimates, <strong>feature importance</strong>, and <strong>permutation importance</strong>.</p></li>
<li><p>Build step-by-step code blocks that show intermediate arrays, DataFrame shapes, and plots - then assemble a clean end-to-end pipeline at the end.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="setup">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">0. Setup</a><a class="headerlink" href="#setup" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 0. Setup</span>
<span class="c1"># If you are on Colab, uncomment the next line.</span>
<span class="c1"># %pip install scikit-learn pandas matplotlib</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;X does not have valid feature names&quot;</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;X has feature names&quot;</span><span class="p">)</span>

<span class="c1"># Optional chemistry bits - we will keep using the same dataset as Lectures 5 and 6</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">Draw</span><span class="p">,</span> <span class="n">Descriptors</span><span class="p">,</span> <span class="n">Crippen</span><span class="p">,</span> <span class="n">rdMolDescriptors</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RDKit not available. Descriptor drawing will be skipped.&quot;</span><span class="p">)</span>
    <span class="n">Chem</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">KFold</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">,</span>
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span>
    <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">roc_curve</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecisionTreeRegressor</span><span class="p">,</span> <span class="n">DecisionTreeClassifier</span><span class="p">,</span> <span class="n">plot_tree</span><span class="p">,</span> <span class="n">export_text</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span><span class="p">,</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.inspection</span><span class="w"> </span><span class="kn">import</span> <span class="n">permutation_importance</span><span class="p">,</span> <span class="n">PartialDependenceDisplay</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<hr class="docutils" />
<section id="data-and-descriptors">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">1. Data and descriptors</a><a class="headerlink" href="#data-and-descriptors" title="Permalink to this heading">#</a></h2>
<p>We will keep using the same CSV from earlier lectures and compute four quick descriptors: <code class="docutils literal notranslate"><span class="pre">MolWt</span></code>, <code class="docutils literal notranslate"><span class="pre">LogP</span></code>, <code class="docutils literal notranslate"><span class="pre">TPSA</span></code>, <code class="docutils literal notranslate"><span class="pre">NumRings</span></code>.</p>
<div class="admonition-tip admonition">
<p class="admonition-title">Tip</p>
<p>A small, stable feature set is perfect when the goal is learning modeling tools, not feature engineering.</p>
</div>
<section id="load-data">
<h3>1.1 Load data<a class="headerlink" href="#load-data" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/zzhenglab/ai4chem/main/book/_data/C_H_oxidation_dataset.csv&quot;</span>
<span class="n">df_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">df_raw</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Compound Name</th>
      <th>CAS</th>
      <th>SMILES</th>
      <th>Solubility_mol_per_L</th>
      <th>pKa</th>
      <th>Toxicity</th>
      <th>Melting Point</th>
      <th>Reactivity</th>
      <th>Oxidation Site</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3,4-dihydro-1H-isochromene</td>
      <td>493-05-0</td>
      <td>c1ccc2c(c1)CCOC2</td>
      <td>0.103906</td>
      <td>5.80</td>
      <td>non_toxic</td>
      <td>65.8</td>
      <td>1</td>
      <td>8,10</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9H-fluorene</td>
      <td>86-73-7</td>
      <td>c1ccc2c(c1)Cc1ccccc1-2</td>
      <td>0.010460</td>
      <td>5.82</td>
      <td>toxic</td>
      <td>90.0</td>
      <td>1</td>
      <td>7</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1,2,3,4-tetrahydronaphthalene</td>
      <td>119-64-2</td>
      <td>c1ccc2c(c1)CCCC2</td>
      <td>0.020589</td>
      <td>5.74</td>
      <td>toxic</td>
      <td>69.4</td>
      <td>1</td>
      <td>7,10</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="compute-descriptors-from-smiles">
<h3>1.2 Compute descriptors from SMILES<a class="headerlink" href="#compute-descriptors-from-smiles" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">calc_desc</span><span class="p">(</span><span class="n">smiles</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">Chem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="s2">&quot;MolWt&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;LogP&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;TPSA&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;NumRings&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">})</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="s2">&quot;MolWt&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;LogP&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;TPSA&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;NumRings&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span>
        <span class="s2">&quot;MolWt&quot;</span><span class="p">:</span> <span class="n">Descriptors</span><span class="o">.</span><span class="n">MolWt</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
        <span class="s2">&quot;LogP&quot;</span><span class="p">:</span> <span class="n">Crippen</span><span class="o">.</span><span class="n">MolLogP</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
        <span class="s2">&quot;TPSA&quot;</span><span class="p">:</span> <span class="n">rdMolDescriptors</span><span class="o">.</span><span class="n">CalcTPSA</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
        <span class="s2">&quot;NumRings&quot;</span><span class="p">:</span> <span class="n">rdMolDescriptors</span><span class="o">.</span><span class="n">CalcNumRings</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="p">})</span>

<span class="n">desc_df</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">calc_desc</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_raw</span><span class="p">,</span> <span class="n">desc_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((575, 13),
 [&#39;Compound Name&#39;,
  &#39;CAS&#39;,
  &#39;SMILES&#39;,
  &#39;Solubility_mol_per_L&#39;,
  &#39;pKa&#39;,
  &#39;Toxicity&#39;,
  &#39;Melting Point&#39;,
  &#39;Reactivity&#39;,
  &#39;Oxidation Site&#39;,
  &#39;MolWt&#39;])
</pre></div>
</div>
</div>
</div>
<div class="admonition-quick-check admonition">
<p class="admonition-title">Quick check</p>
<p>Make sure there are no obvious NaNs in the four descriptors.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span><span class="s2">&quot;LogP&quot;</span><span class="p">,</span><span class="s2">&quot;TPSA&quot;</span><span class="p">,</span><span class="s2">&quot;NumRings&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MolWt       0
LogP        0
TPSA        0
NumRings    0
dtype: int64
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="decision-trees-what-they-do">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">2. Decision trees: what they do</a><a class="headerlink" href="#decision-trees-what-they-do" title="Permalink to this heading">#</a></h2>
<div class="admonition-idea admonition">
<p class="admonition-title">Idea</p>
<p>A tree splits data into groups by asking questions like <code class="docutils literal notranslate"><span class="pre">MolWt</span> <span class="pre">&lt;=</span> <span class="pre">200.5</span></code>. Each split tries to make the target values in the child nodes more pure.</p>
</div>
<ul class="simple">
<li><p><strong>Regression tree</strong>: uses <strong>MSE</strong> reduction to choose splits. Each leaf predicts the <strong>mean</strong> of <code class="docutils literal notranslate"><span class="pre">y</span></code> in that leaf.</p></li>
<li><p><strong>Classification tree</strong>: uses <strong>Gini</strong> or <strong>entropy</strong> to choose splits. Each leaf predicts the <strong>majority class</strong> and provides class probabilities.</p></li>
</ul>
<p>Important knobs:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">max_depth</span></code> - maximum number of split levels.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">min_samples_split</span></code> - minimum samples to consider a split.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">min_samples_leaf</span></code> - minimum samples in a leaf.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_features</span></code> - number of features to consider at each split.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="tree-regression-melting-point">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">3. Tree regression - Melting Point</a><a class="headerlink" href="#tree-regression-melting-point" title="Permalink to this heading">#</a></h2>
<p>We start with <strong>Melting Point</strong> as a regression target using four descriptors as features.</p>
<section id="prepare-x-and-y">
<h3>3.1 Prepare <code class="docutils literal notranslate"><span class="pre">X</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code><a class="headerlink" href="#prepare-x-and-y" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feat</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span> <span class="s2">&quot;LogP&quot;</span><span class="p">,</span> <span class="s2">&quot;TPSA&quot;</span><span class="p">,</span> <span class="s2">&quot;NumRings&quot;</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Melting Point&quot;</span><span class="p">]</span>

<span class="n">X</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">y</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(     MolWt    LogP  TPSA  NumRings
 0  134.178  1.7593  9.23       2.0
 1  166.223  3.2578  0.00       3.0,
 0    65.8
 1    90.0
 2    69.4
 3    65.0
 4    96.4
 Name: Melting Point, dtype: float64)
</pre></div>
</div>
</div>
</div>
</section>
<section id="split-into-train-and-test">
<h3>3.2 Split into train and test<a class="headerlink" href="#split-into-train-and-test" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_tr</span><span class="p">,</span> <span class="n">X_te</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">,</span> <span class="n">y_te</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">X_tr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">X_te</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y_tr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y_te</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((460, 4), (115, 4), (460,), (115,))
</pre></div>
</div>
</div>
</div>
</section>
<section id="fit-a-tiny-tree-depth-1-stump">
<h3>3.3 Fit a tiny tree - depth 1 stump<a class="headerlink" href="#fit-a-tiny-tree-depth-1-stump" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree_stump</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">tree_stump</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train R2:&quot;</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_tr</span><span class="p">,</span> <span class="n">tree_stump</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_tr</span><span class="p">))</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test  R2:&quot;</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">tree_stump</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_te</span><span class="p">))</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Feature importances:&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">tree_stump</span><span class="o">.</span><span class="n">feature_importances_</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train R2: 0.503
Test  R2: 0.398
Feature importances: {&#39;MolWt&#39;: 1.0, &#39;LogP&#39;: 0.0, &#39;TPSA&#39;: 0.0, &#39;NumRings&#39;: 0.0}
</pre></div>
</div>
</div>
</div>
<div class="admonition-look-at-the-structure admonition">
<p class="admonition-title">Look at the structure</p>
<p>A depth-1 tree makes exactly one split. This is easy to visualize and interpret.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plot_tree</span><span class="p">(</span><span class="n">tree_stump</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">feat</span><span class="p">,</span> <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rounded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;DecisionTreeRegressor depth=1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">export_text</span><span class="p">(</span><span class="n">tree_stump</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">feat</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d146d1913b36026110e8216ac00ea413a267e856e0203fe8eb1c94ae89a309f8.png" src="_images/d146d1913b36026110e8216ac00ea413a267e856e0203fe8eb1c94ae89a309f8.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>|--- MolWt &lt;= 245.61
|   |--- value: [107.73]
|--- MolWt &gt;  245.61
|   |--- value: [184.12]
</pre></div>
</div>
</div>
</div>
</section>
<section id="increase-depth-step-by-step">
<h3>3.4 Increase depth step by step<a class="headerlink" href="#increase-depth-step-by-step" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">depths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">r2_tr</span><span class="p">,</span> <span class="n">r2_te</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">depths</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>
    <span class="n">r2_tr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_tr</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_tr</span><span class="p">)))</span>
    <span class="n">r2_te</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_te</span><span class="p">)))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">depths</span><span class="p">,</span> <span class="n">r2_tr</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Train R2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">depths</span><span class="p">,</span> <span class="n">r2_te</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Test R2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;max_depth&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;R2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Tree depth vs R2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b396cd0e772e1a63abf6e9f7b8b1e88a08a019c2238093dc613eaef27e86877b.png" src="_images/b396cd0e772e1a63abf6e9f7b8b1e88a08a019c2238093dc613eaef27e86877b.png" />
</div>
</div>
<div class="admonition-diagnose admonition">
<p class="admonition-title">Diagnose</p>
<ul class="simple">
<li><p>Low depth - high bias.</p></li>
<li><p>Very high depth - fits noise, test R2 falls.
Pick a depth that balances train and test.</p></li>
</ul>
</div>
</section>
<section id="control-leaves-instead-of-depth">
<h3>3.5 Control leaves instead of depth<a class="headerlink" href="#control-leaves-instead-of-depth" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">leaf_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">80</span><span class="p">]</span>
<span class="n">r2_te_leaf</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">leaf</span> <span class="ow">in</span> <span class="n">leaf_sizes</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">min_samples_leaf</span><span class="o">=</span><span class="n">leaf</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>
    <span class="n">r2_te_leaf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_te</span><span class="p">)))</span>

<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;min_samples_leaf&quot;</span><span class="p">:</span> <span class="n">leaf_sizes</span><span class="p">,</span> <span class="s2">&quot;test_R2&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r2_te_leaf</span><span class="p">,</span> <span class="mi">3</span><span class="p">)})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>min_samples_leaf</th>
      <th>test_R2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>0.740</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>0.774</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5</td>
      <td>0.761</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10</td>
      <td>0.761</td>
    </tr>
    <tr>
      <th>4</th>
      <td>20</td>
      <td>0.719</td>
    </tr>
    <tr>
      <th>5</th>
      <td>40</td>
      <td>0.710</td>
    </tr>
    <tr>
      <th>6</th>
      <td>80</td>
      <td>0.500</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="feature-importance-for-the-chosen-tree">
<h3>3.6 Feature importance for the chosen tree<a class="headerlink" href="#feature-importance-for-the-chosen-tree" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_depth</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">tree_best</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">best_depth</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>

<span class="n">imp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">tree_best</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">imp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;barh&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tree feature importance - depth=</span><span class="si">{</span><span class="n">best_depth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">imp</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/086168a2e3454913e6486a641644086ed46b5f60afe41a3a76f2061b94d8ab55.png" src="_images/086168a2e3454913e6486a641644086ed46b5f60afe41a3a76f2061b94d8ab55.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TPSA        0.00
NumRings    0.00
LogP        0.01
MolWt       0.99
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="small-parity-plot-for-the-chosen-tree">
<h3>3.7 Small parity plot for the chosen tree<a class="headerlink" href="#small-parity-plot-for-the-chosen-tree" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_hat</span> <span class="o">=</span> <span class="n">tree_best</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_te</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">lims</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">y_te</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_te</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">max</span><span class="p">())]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span> <span class="n">lims</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;True MP&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Predicted MP&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Parity plot - tree regression&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/47f1ed88e591d44e5d7b9ec1356ba722eb48f0c3a0dc16e8e97c32d3513d5c1d.png" src="_images/47f1ed88e591d44e5d7b9ec1356ba722eb48f0c3a0dc16e8e97c32d3513d5c1d.png" />
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="tree-classification-toxicity">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">4. Tree classification - Toxicity</a><a class="headerlink" href="#tree-classification-toxicity" title="Permalink to this heading">#</a></h2>
<p>We switch to a binary label using the same descriptors.</p>
<section id="encode-the-labels">
<h3>4.1 Encode the labels<a class="headerlink" href="#encode-the-labels" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build a clean binary column</span>
<span class="n">lab_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;toxic&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;non_toxic&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<span class="n">y_cls</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Toxicity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">lab_map</span><span class="p">)</span>

<span class="c1"># Keep rows with defined labels and features</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">y_cls</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">X</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Xc</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">yc</span> <span class="o">=</span> <span class="n">y_cls</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">Xc</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">yc</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((575, 4),
 Toxicity
 1    474
 0    101
 Name: count, dtype: int64)
</pre></div>
</div>
</div>
</div>
</section>
<section id="stratified-split">
<h3>4.2 Stratified split<a class="headerlink" href="#stratified-split" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Xc_tr</span><span class="p">,</span> <span class="n">Xc_te</span><span class="p">,</span> <span class="n">yc_tr</span><span class="p">,</span> <span class="n">yc_te</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">Xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">yc</span>
<span class="p">)</span>
<span class="n">yc_tr</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">yc_te</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(0.824, 0.826)
</pre></div>
</div>
</div>
</div>
</section>
<section id="depth-1-classifier">
<h3>4.3 Depth 1 classifier<a class="headerlink" href="#depth-1-classifier" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clf_stump</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">clf_stump</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xc_tr</span><span class="p">,</span> <span class="n">yc_tr</span><span class="p">)</span>

<span class="n">yc_hat</span> <span class="o">=</span> <span class="n">clf_stump</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xc_te</span><span class="p">)</span>
<span class="n">yc_proba</span> <span class="o">=</span> <span class="n">clf_stump</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">Xc_te</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accuracy:&quot;</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">yc_te</span><span class="p">,</span> <span class="n">yc_hat</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Precision:&quot;</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">yc_te</span><span class="p">,</span> <span class="n">yc_hat</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recall:&quot;</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">yc_te</span><span class="p">,</span> <span class="n">yc_hat</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;F1:&quot;</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">yc_te</span><span class="p">,</span> <span class="n">yc_hat</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AUC:&quot;</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">yc_te</span><span class="p">,</span> <span class="n">yc_proba</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Accuracy: 0.922
Precision: 0.939
Recall: 0.968
F1: 0.953
AUC: 0.834
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mf">3.5</span><span class="p">))</span>
<span class="n">plot_tree</span><span class="p">(</span><span class="n">clf_stump</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">feat</span><span class="p">,</span> <span class="n">class_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;non_toxic&quot;</span><span class="p">,</span><span class="s2">&quot;toxic&quot;</span><span class="p">],</span> <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rounded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;DecisionTreeClassifier depth=1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">export_text</span><span class="p">(</span><span class="n">clf_stump</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">feat</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/11ac4a25ca97c78ed232fb750112bce6d85a8f0a458bff93d65946971009ad2a.png" src="_images/11ac4a25ca97c78ed232fb750112bce6d85a8f0a458bff93d65946971009ad2a.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>|--- MolWt &lt;= 134.20
|   |--- class: 0
|--- MolWt &gt;  134.20
|   |--- class: 1
</pre></div>
</div>
</div>
</div>
</section>
<section id="sweep-max-depth-and-plot-scores">
<h3>4.4 Sweep <code class="docutils literal notranslate"><span class="pre">max_depth</span></code> and plot scores<a class="headerlink" href="#sweep-max-depth-and-plot-scores" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">depths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">accs</span><span class="p">,</span> <span class="n">aucs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">depths</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xc_tr</span><span class="p">,</span> <span class="n">yc_tr</span><span class="p">)</span>
    <span class="n">proba</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">Xc_te</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="p">(</span><span class="n">proba</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">accs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">yc_te</span><span class="p">,</span> <span class="n">pred</span><span class="p">))</span>
    <span class="n">aucs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">yc_te</span><span class="p">,</span> <span class="n">proba</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">depths</span><span class="p">,</span> <span class="n">accs</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;max_depth&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">depths</span><span class="p">,</span> <span class="n">aucs</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;max_depth&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;AUC&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Tree depth vs scores - classification&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/47aa6467c4f5ef044bb946a0be19698a455bfc6715115b4e8d2f1781ba348fe2.png" src="_images/47aa6467c4f5ef044bb946a0be19698a455bfc6715115b4e8d2f1781ba348fe2.png" />
</div>
</div>
<div class="admonition-threshold-reminder admonition">
<p class="admonition-title">Threshold reminder</p>
<p>Tree classifiers can output probabilities. Accuracy here uses threshold 0.5. You may re-run with different thresholds.</p>
</div>
</section>
<section id="confusion-matrix-for-the-chosen-depth">
<h3>4.5 Confusion matrix for the chosen depth<a class="headerlink" href="#confusion-matrix-for-the-chosen-depth" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d_pick</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">clf_d</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">d_pick</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xc_tr</span><span class="p">,</span> <span class="n">yc_tr</span><span class="p">)</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">clf_d</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xc_te</span><span class="p">)</span>

<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">yc_te</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confusion matrix - depth=</span><span class="si">{</span><span class="n">d_pick</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Predicted&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;True&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9bc402d0d1aaeb4fcaf8d9612745015a15d6ca05c512e60e97fce5995291e99d.png" src="_images/9bc402d0d1aaeb4fcaf8d9612745015a15d6ca05c512e60e97fce5995291e99d.png" />
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="random-forest-regression">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">5. Random Forest - regression</a><a class="headerlink" href="#random-forest-regression" title="Permalink to this heading">#</a></h2>
<p>A Random Forest is an <strong>ensemble</strong> of many trees trained on bootstrap samples. Each split considers only a subset of features. Predictions are averaged.</p>
<section id="fit-the-forest-with-oob-score">
<h3>5.1 Fit the forest with OOB score<a class="headerlink" href="#fit-the-forest-with-oob-score" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf_reg</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">oob_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">rf_reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OOB R2:&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rf_reg</span><span class="p">,</span> <span class="s2">&quot;oob_score_&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test R2:&quot;</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">rf_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_te</span><span class="p">))</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>OOB R2: 0.7553165511964571
Test R2: 0.847
</pre></div>
</div>
</div>
</div>
<div class="admonition-oob admonition">
<p class="admonition-title">OOB</p>
<p>Out-of-bag samples are the rows not drawn by bootstrap for a given tree. They provide a built-in validation without a second split.</p>
</div>
</section>
<section id="feature-importance-and-permutation-importance">
<h3>5.2 Feature importance and permutation importance<a class="headerlink" href="#feature-importance-and-permutation-importance" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Gini-based importance (for regression this is based on MSE reduction)</span>
<span class="n">imp_rf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">rf_reg</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">imp_rf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;barh&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Random Forest feature importance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">imp_rf</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f3888d8cd7d2688deef546fa800c79a1effed4cb298178c74dff51f4677e9e83.png" src="_images/f3888d8cd7d2688deef546fa800c79a1effed4cb298178c74dff51f4677e9e83.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NumRings    0.019
TPSA        0.036
LogP        0.071
MolWt       0.875
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">perm</span> <span class="o">=</span> <span class="n">permutation_importance</span><span class="p">(</span><span class="n">rf_reg</span><span class="p">,</span> <span class="n">X_te</span><span class="p">,</span> <span class="n">y_te</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s2">&quot;r2&quot;</span><span class="p">,</span> <span class="n">n_repeats</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">perm_ser</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">perm</span><span class="o">.</span><span class="n">importances_mean</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">perm_ser</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;barh&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Permutation importance - drop in R2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Mean decrease in R2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">perm_ser</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/755779504c353a98370d104650e8f111edaca2f08c72c39c9ce9d9237199c553.png" src="_images/755779504c353a98370d104650e8f111edaca2f08c72c39c9ce9d9237199c553.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NumRings   -0.001
TPSA        0.005
LogP        0.021
MolWt       1.476
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="partial-dependence-for-1-feature">
<h3>5.3 Partial dependence for 1 feature<a class="headerlink" href="#partial-dependence-for-1-feature" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">PartialDependenceDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">rf_reg</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Partial dependence - MolWt&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/44c38e72dfd94892a9bcf29105e9dfa3bb82d28bdd3364b3e64c347fe811e284.png" src="_images/44c38e72dfd94892a9bcf29105e9dfa3bb82d28bdd3364b3e64c347fe811e284.png" />
</div>
</div>
</section>
<section id="effect-of-n-estimators">
<h3>5.4 Effect of <code class="docutils literal notranslate"><span class="pre">n_estimators</span></code><a class="headerlink" href="#effect-of-n-estimators" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ests</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>
<span class="n">r2s</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ests</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>
    <span class="n">r2s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_te</span><span class="p">)))</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;n_estimators&quot;</span><span class="p">:</span> <span class="n">ests</span><span class="p">,</span> <span class="s2">&quot;test_R2&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r2s</span><span class="p">,</span><span class="mi">3</span><span class="p">)})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n_estimators</th>
      <th>test_R2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>20</td>
      <td>0.831</td>
    </tr>
    <tr>
      <th>1</th>
      <td>50</td>
      <td>0.842</td>
    </tr>
    <tr>
      <th>2</th>
      <td>100</td>
      <td>0.847</td>
    </tr>
    <tr>
      <th>3</th>
      <td>200</td>
      <td>0.847</td>
    </tr>
    <tr>
      <th>4</th>
      <td>300</td>
      <td>0.847</td>
    </tr>
    <tr>
      <th>5</th>
      <td>500</td>
      <td>0.847</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="random-forest-classification">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">6. Random Forest - classification</a><a class="headerlink" href="#random-forest-classification" title="Permalink to this heading">#</a></h2>
<section id="fit-and-report-oob-score">
<h3>6.1 Fit and report OOB score<a class="headerlink" href="#fit-and-report-oob-score" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf_clf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">oob_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">rf_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xc_tr</span><span class="p">,</span> <span class="n">yc_tr</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OOB accuracy:&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rf_clf</span><span class="p">,</span> <span class="s2">&quot;oob_score_&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">rf_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xc_te</span><span class="p">)</span>
<span class="n">proba</span> <span class="o">=</span> <span class="n">rf_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">Xc_te</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test accuracy:&quot;</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">yc_te</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test AUC:&quot;</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">yc_te</span><span class="p">,</span> <span class="n">proba</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>OOB accuracy: 0.9173913043478261
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Test accuracy: 0.93
Test AUC: 0.981
</pre></div>
</div>
</div>
</div>
</section>
<section id="roc-curve">
<h3>6.2 ROC curve<a class="headerlink" href="#roc-curve" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thr</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">yc_te</span><span class="p">,</span> <span class="n">proba</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;AUC=</span><span class="si">{</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">yc_te</span><span class="p">,</span><span class="w"> </span><span class="n">proba</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;k--&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;FPR&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;TPR&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;ROC - Random Forest classifier&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5495cfd3cf7d90cd529793fc66f9c9f8bc5d6b379d42c24c7e093c971668aa48.png" src="_images/5495cfd3cf7d90cd529793fc66f9c9f8bc5d6b379d42c24c7e093c971668aa48.png" />
</div>
</div>
</section>
<section id="importance-and-top-features">
<h3>6.3 Importance and top features<a class="headerlink" href="#importance-and-top-features" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imp_rf_cls</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">rf_clf</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">imp_rf_cls</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;barh&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;RF classification - feature importance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">imp_rf_cls</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f2ba2ac02fec65d5b7efad643ebacfaa00667e30f718d9792d63396888c73efe.png" src="_images/f2ba2ac02fec65d5b7efad643ebacfaa00667e30f718d9792d63396888c73efe.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TPSA        0.100
NumRings    0.143
MolWt       0.360
LogP        0.397
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="admonition-note admonition">
<p class="admonition-title">Note</p>
<p>Tree-based importance can favor variables that can split many ways. Use permutation importance on a held-out set to cross-check.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">perm_c</span> <span class="o">=</span> <span class="n">permutation_importance</span><span class="p">(</span><span class="n">rf_clf</span><span class="p">,</span> <span class="n">Xc_te</span><span class="p">,</span> <span class="n">yc_te</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">,</span> <span class="n">n_repeats</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">perm_c</span><span class="o">.</span><span class="n">importances_mean</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LogP        0.137
MolWt       0.031
NumRings    0.014
TPSA        0.011
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="compare-single-tree-vs-forest">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">7. Compare: single tree vs forest</a><a class="headerlink" href="#compare-single-tree-vs-forest" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree_r</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>
<span class="n">rf_r</span>   <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>

<span class="n">r2_tree</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">tree_r</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_te</span><span class="p">))</span>
<span class="n">r2_rf</span>   <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">rf_r</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_te</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tree test R2:   </span><span class="si">{</span><span class="n">r2_tree</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forest test R2: </span><span class="si">{</span><span class="n">r2_rf</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tree test R2:   0.817
Forest test R2: 0.847
</pre></div>
</div>
</div>
</div>
<div class="admonition-why-forests-help admonition">
<p class="admonition-title">Why forests help</p>
<p>A single deep tree can overfit. Averaging many deep but varied trees reduces variance. This often boosts test performance.</p>
</div>
</section>
<hr class="docutils" />
<section id="hyperparameter-tuning-with-gridsearchcv">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">8. Hyperparameter tuning with GridSearchCV</a><a class="headerlink" href="#hyperparameter-tuning-with-gridsearchcv" title="Permalink to this heading">#</a></h2>
<p>We will tune a small grid for each model type. Keep grids compact so the run is quick.</p>
<section id="decision-tree-regression">
<h3>8.1 Decision tree - regression<a class="headerlink" href="#decision-tree-regression" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_grid_dt</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;max_depth&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
    <span class="s2">&quot;min_samples_leaf&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
    <span class="s2">&quot;min_samples_split&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">dt</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">grid_dt</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">param_grid_dt</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s2">&quot;r2&quot;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">grid_dt</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best params:&quot;</span><span class="p">,</span> <span class="n">grid_dt</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CV mean R2:&quot;</span><span class="p">,</span> <span class="n">grid_dt</span><span class="o">.</span><span class="n">best_score_</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="n">best_dt</span> <span class="o">=</span> <span class="n">grid_dt</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test R2:&quot;</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">best_dt</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_te</span><span class="p">))</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best params: {&#39;max_depth&#39;: 4, &#39;min_samples_leaf&#39;: 2, &#39;min_samples_split&#39;: 2}
CV mean R2: 0.775
Test R2: 0.845
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h3>8.2 Random forest - regression<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_grid_rf</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;n_estimators&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">],</span>
    <span class="s2">&quot;max_depth&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
    <span class="s2">&quot;min_samples_leaf&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="s2">&quot;max_features&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;sqrt&quot;</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">grid_rf</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">param_grid_rf</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s2">&quot;r2&quot;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">grid_rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best params:&quot;</span><span class="p">,</span> <span class="n">grid_rf</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CV mean R2:&quot;</span><span class="p">,</span> <span class="n">grid_rf</span><span class="o">.</span><span class="n">best_score_</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="n">best_rf</span> <span class="o">=</span> <span class="n">grid_rf</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test R2:&quot;</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">best_rf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_te</span><span class="p">))</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\model_selection\_validation.py:425: FitFailedWarning: 
72 fits failed out of a total of 144.
The score on these train-test partitions for these parameters will be set to nan.
If these failures are not expected, you can try to debug them by setting error_score=&#39;raise&#39;.

Below are more details about the failures:
--------------------------------------------------------------------------------
36 fits failed with the following error:
Traceback (most recent call last):
  File &quot;c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\model_selection\_validation.py&quot;, line 729, in _fit_and_score
    estimator.fit(X_train, y_train, **fit_params)
  File &quot;c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\base.py&quot;, line 1145, in wrapper
    estimator._validate_params()
  File &quot;c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\base.py&quot;, line 638, in _validate_params
    validate_parameter_constraints(
  File &quot;c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\utils\_param_validation.py&quot;, line 96, in validate_parameter_constraints
    raise InvalidParameterError(
sklearn.utils._param_validation.InvalidParameterError: The &#39;max_features&#39; parameter of RandomForestRegressor must be an int in the range [1, inf), a float in the range (0.0, 1.0], a str among {&#39;sqrt&#39;, &#39;log2&#39;} or None. Got &#39;auto&#39; instead.

--------------------------------------------------------------------------------
36 fits failed with the following error:
Traceback (most recent call last):
  File &quot;c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\model_selection\_validation.py&quot;, line 729, in _fit_and_score
    estimator.fit(X_train, y_train, **fit_params)
  File &quot;c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\base.py&quot;, line 1145, in wrapper
    estimator._validate_params()
  File &quot;c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\base.py&quot;, line 638, in _validate_params
    validate_parameter_constraints(
  File &quot;c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\utils\_param_validation.py&quot;, line 96, in validate_parameter_constraints
    raise InvalidParameterError(
sklearn.utils._param_validation.InvalidParameterError: The &#39;max_features&#39; parameter of RandomForestRegressor must be an int in the range [1, inf), a float in the range (0.0, 1.0], a str among {&#39;log2&#39;, &#39;sqrt&#39;} or None. Got &#39;auto&#39; instead.

  warnings.warn(some_fits_failed_message, FitFailedWarning)
c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\model_selection\_search.py:979: UserWarning: One or more of the test scores are non-finite: [       nan        nan        nan        nan        nan        nan
 0.75460225 0.75316317 0.75772011 0.75914567 0.75814871 0.75981281
        nan        nan        nan        nan        nan        nan
 0.7742139  0.77420515 0.77048087 0.77057529 0.75698161 0.75892408
        nan        nan        nan        nan        nan        nan
 0.75761217 0.7578212  0.76126635 0.76153308 0.75856905 0.75995517]
  warnings.warn(
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best params: {&#39;max_depth&#39;: 6, &#39;max_features&#39;: &#39;sqrt&#39;, &#39;min_samples_leaf&#39;: 1, &#39;n_estimators&#39;: 200}
CV mean R2: 0.774
Test R2: 0.829
</pre></div>
</div>
</div>
</div>
</section>
<section id="decision-tree-classification">
<h3>8.3 Decision tree - classification<a class="headerlink" href="#decision-tree-classification" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_grid_dt_c</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;max_depth&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
    <span class="s2">&quot;min_samples_leaf&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">dtc</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">cv_c</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">grid_dtc</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">dtc</span><span class="p">,</span> <span class="n">param_grid_dt_c</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv_c</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">grid_dtc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xc_tr</span><span class="p">,</span> <span class="n">yc_tr</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best params:&quot;</span><span class="p">,</span> <span class="n">grid_dtc</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CV mean AUC:&quot;</span><span class="p">,</span> <span class="n">grid_dtc</span><span class="o">.</span><span class="n">best_score_</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="n">best_dtc</span> <span class="o">=</span> <span class="n">grid_dtc</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test AUC:&quot;</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">yc_te</span><span class="p">,</span> <span class="n">best_dtc</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">Xc_te</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best params: {&#39;max_depth&#39;: 6, &#39;min_samples_leaf&#39;: 10}
CV mean AUC: 0.933
Test AUC: 0.934
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h3>8.4 Random forest - classification<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_grid_rfc</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;n_estimators&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">],</span>
    <span class="s2">&quot;max_depth&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
    <span class="s2">&quot;min_samples_leaf&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="s2">&quot;max_features&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;sqrt&quot;</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">rfc</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">grid_rfc</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">rfc</span><span class="p">,</span> <span class="n">param_grid_rfc</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv_c</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">grid_rfc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xc_tr</span><span class="p">,</span> <span class="n">yc_tr</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best params:&quot;</span><span class="p">,</span> <span class="n">grid_rfc</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CV mean AUC:&quot;</span><span class="p">,</span> <span class="n">grid_rfc</span><span class="o">.</span><span class="n">best_score_</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="n">best_rfc</span> <span class="o">=</span> <span class="n">grid_rfc</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="n">proba_best</span> <span class="o">=</span> <span class="n">best_rfc</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">Xc_te</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test AUC:&quot;</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">yc_te</span><span class="p">,</span> <span class="n">proba_best</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\model_selection\_validation.py:425: FitFailedWarning: 
72 fits failed out of a total of 144.
The score on these train-test partitions for these parameters will be set to nan.
If these failures are not expected, you can try to debug them by setting error_score=&#39;raise&#39;.

Below are more details about the failures:
--------------------------------------------------------------------------------
50 fits failed with the following error:
Traceback (most recent call last):
  File &quot;c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\model_selection\_validation.py&quot;, line 729, in _fit_and_score
    estimator.fit(X_train, y_train, **fit_params)
  File &quot;c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\base.py&quot;, line 1145, in wrapper
    estimator._validate_params()
  File &quot;c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\base.py&quot;, line 638, in _validate_params
    validate_parameter_constraints(
  File &quot;c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\utils\_param_validation.py&quot;, line 96, in validate_parameter_constraints
    raise InvalidParameterError(
sklearn.utils._param_validation.InvalidParameterError: The &#39;max_features&#39; parameter of RandomForestClassifier must be an int in the range [1, inf), a float in the range (0.0, 1.0], a str among {&#39;sqrt&#39;, &#39;log2&#39;} or None. Got &#39;auto&#39; instead.

--------------------------------------------------------------------------------
22 fits failed with the following error:
Traceback (most recent call last):
  File &quot;c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\model_selection\_validation.py&quot;, line 729, in _fit_and_score
    estimator.fit(X_train, y_train, **fit_params)
  File &quot;c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\base.py&quot;, line 1145, in wrapper
    estimator._validate_params()
  File &quot;c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\base.py&quot;, line 638, in _validate_params
    validate_parameter_constraints(
  File &quot;c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\utils\_param_validation.py&quot;, line 96, in validate_parameter_constraints
    raise InvalidParameterError(
sklearn.utils._param_validation.InvalidParameterError: The &#39;max_features&#39; parameter of RandomForestClassifier must be an int in the range [1, inf), a float in the range (0.0, 1.0], a str among {&#39;log2&#39;, &#39;sqrt&#39;} or None. Got &#39;auto&#39; instead.

  warnings.warn(some_fits_failed_message, FitFailedWarning)
c:\users\52377\appdata\local\programs\python\python38\lib\site-packages\sklearn\model_selection\_search.py:979: UserWarning: One or more of the test scores are non-finite: [       nan        nan        nan        nan        nan        nan
 0.96368161 0.9649752  0.96716272 0.96781568 0.96917093 0.9681331
        nan        nan        nan        nan        nan        nan
 0.96639298 0.9666364  0.96794726 0.96807884 0.96890777 0.96800152
        nan        nan        nan        nan        nan        nan
 0.96426878 0.96536008 0.96716272 0.96768904 0.96917093 0.9681331 ]
  warnings.warn(
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best params: {&#39;max_depth&#39;: None, &#39;max_features&#39;: &#39;sqrt&#39;, &#39;min_samples_leaf&#39;: 5, &#39;n_estimators&#39;: 200}
CV mean AUC: 0.969
Test AUC: 0.986
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="inspect-one-tree-from-a-forest">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">9. Inspect one tree from a forest</a><a class="headerlink" href="#inspect-one-tree-from-a-forest" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">one_tree</span> <span class="o">=</span> <span class="n">best_rf</span><span class="o">.</span><span class="n">estimators_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plot_tree</span><span class="p">(</span><span class="n">one_tree</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">feat</span><span class="p">,</span> <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rounded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;One tree from the Random Forest - top 3 levels&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">export_text</span><span class="p">(</span><span class="n">one_tree</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">feat</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fe4269336ce8a6fe85d30112572f0592c66d53c8e910b285997019873b36db96.png" src="_images/fe4269336ce8a6fe85d30112572f0592c66d53c8e910b285997019873b36db96.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>|--- MolWt &lt;= 226.29
|   |--- LogP &lt;= 3.54
|   |   |--- MolWt &lt;= 144.89
|   |   |   |--- TPSA &lt;= 101.34
|   |   |   |   |--- truncated branch of depth 3
|   |   |   |--- TPSA &gt;  101.34
|   |   |   |   |--- value: [129.90]
|   |   |--- MolWt &gt;  144.89
|   |   |   |--- MolWt &lt;= 186.75
|   |   |   |   |--- truncated branch of depth 3
|   |   |   |--- MolWt &gt;  186.75
|   |   |   |   |--- truncated branch of depth 3
|   |--- LogP &gt;  3.54
|   |   |--- NumRings &lt;= 1.50
|   |   |   |--- MolWt &lt;= 180.68
|   |   |   |   |--- value: [92.40]
|   |   |   |--- MolWt &gt;  180.68
|   |   |   |   |--- value: [94.40]
|   |   |--- NumRings &gt;  1.50
|   |   |   |--- TPSA &lt;= 26.16
|   |   |   |   |--- truncated branch of depth 3
|   |   |   |--- TPSA &gt;  26.16
|   |   |   |   |--- value: [112.10]
|--- MolWt &gt;  226.29
|   |--- NumRings &lt;= 4.50
|   |   |--- LogP &lt;= 4.28
|   |   |   |--- TPSA &lt;= 30.22
|   |   |   |   |--- truncated branch of depth 3
|   |   |   |--- TPSA &gt;  30.22
|   |   |   |   |--- truncated branch of depth 3
|   |   |--- LogP &gt;  4.28
|   |   |   |--- TPSA &lt;= 57.40
|   |   |   |   |--- truncated branch of depth 3
|   |   |   |--- TPSA &gt;  57.40
|   |   |   |   |--- truncated branch of depth 3
|   |--- NumRings &gt;  4.50
|   |   |--- MolWt &lt;= 355.32
|   |   |   |--- LogP &lt;= 4.53
|   |   |   |   |--- value: [216.20]
|   |   |   |--- LogP &gt;  4.53
|   |   |   |   |--- truncated branch of depth 3
|   |   |--- MolWt &gt;  355.32
|   |   |   |--- LogP &lt;= 6.55
|   |   |   |   |--- truncated branch of depth 3
|   |   |   |--- LogP &gt;  6.55
|   |   |   |   |--- truncated branch of depth 3
</pre></div>
</div>
</div>
</div>
<div class="admonition-caution admonition">
<p class="admonition-title">Caution</p>
<p>A forest has many trees. Looking at one tree can help intuition, but the model prediction comes from the ensemble.</p>
</div>
</section>
<hr class="docutils" />
<section id="putting-it-together-clean-workflows">
<h2><a class="toc-backref" href="#id14" role="doc-backlink">10. Putting it together - clean workflows</a><a class="headerlink" href="#putting-it-together-clean-workflows" title="Permalink to this heading">#</a></h2>
<section id="regression-pipeline-random-forest">
<h3>10.1 Regression pipeline - Random Forest<a class="headerlink" href="#regression-pipeline-random-forest" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Melting Point&quot;</span><span class="p">]</span>
<span class="n">X_tr</span><span class="p">,</span> <span class="n">X_te</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">,</span> <span class="n">y_te</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>

<span class="c1"># Fit</span>
<span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">oob_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>

<span class="c1"># Evaluate</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OOB R2:&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="s2">&quot;oob_score_&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test R2:&quot;</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_te</span><span class="p">))</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="c1"># Predict two new points</span>
<span class="n">X_new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="mf">135.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">9.2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">301.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">17.7</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span> <span class="n">columns</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span>
<span class="n">rf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_new</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>OOB R2: 0.793667801488364
Test R2: 0.757
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 73.21767857, 165.87166667])
</pre></div>
</div>
</div>
</div>
</section>
<section id="classification-pipeline-random-forest">
<h3>10.2 Classification pipeline - Random Forest<a class="headerlink" href="#classification-pipeline-random-forest" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare</span>
<span class="n">lab_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;toxic&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;non_toxic&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Toxicity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">lab_map</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Xc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="n">feat</span><span class="p">];</span> <span class="n">yc</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">Xc_tr</span><span class="p">,</span> <span class="n">Xc_te</span><span class="p">,</span> <span class="n">yc_tr</span><span class="p">,</span> <span class="n">yc_te</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">Xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">yc</span><span class="p">)</span>

<span class="c1"># Fit</span>
<span class="n">rfc</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">oob_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">rfc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xc_tr</span><span class="p">,</span> <span class="n">yc_tr</span><span class="p">)</span>

<span class="c1"># Evaluate</span>
<span class="n">proba</span> <span class="o">=</span> <span class="n">rfc</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">Xc_te</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">pred</span> <span class="o">=</span> <span class="p">(</span><span class="n">proba</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OOB accuracy:&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rfc</span><span class="p">,</span> <span class="s2">&quot;oob_score_&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test accuracy:&quot;</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">yc_te</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test AUC:&quot;</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">yc_te</span><span class="p">,</span> <span class="n">proba</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>OOB accuracy: 0.941304347826087
Test accuracy: 0.913
Test AUC: 0.96
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="quick-reference">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">11. Quick reference</a><a class="headerlink" href="#quick-reference" title="Permalink to this heading">#</a></h2>
<div class="admonition-api-snippets admonition">
<p class="admonition-title">API snippets</p>
<ul class="simple">
<li><p>Tree regression: <code class="docutils literal notranslate"><span class="pre">DecisionTreeRegressor(max_depth=...,</span> <span class="pre">min_samples_leaf=...).fit(X_tr,</span> <span class="pre">y_tr)</span></code></p></li>
<li><p>Tree classification: <code class="docutils literal notranslate"><span class="pre">DecisionTreeClassifier(...).fit(Xc_tr,</span> <span class="pre">yc_tr)</span></code></p></li>
<li><p>Forest regression: <code class="docutils literal notranslate"><span class="pre">RandomForestRegressor(n_estimators=...,</span> <span class="pre">oob_score=True)</span></code></p></li>
<li><p>Forest classification: <code class="docutils literal notranslate"><span class="pre">RandomForestClassifier(...,</span> <span class="pre">oob_score=True)</span></code></p></li>
<li><p>Visuals: <code class="docutils literal notranslate"><span class="pre">plot_tree(model,</span> <span class="pre">feature_names=feat)</span></code> and <code class="docutils literal notranslate"><span class="pre">export_text(model,</span> <span class="pre">feature_names=feat)</span></code></p></li>
<li><p>Importance: <code class="docutils literal notranslate"><span class="pre">model.feature_importances_</span></code> and <code class="docutils literal notranslate"><span class="pre">permutation_importance(model,</span> <span class="pre">X_te,</span> <span class="pre">y_te,</span> <span class="pre">...)</span></code></p></li>
</ul>
</div>
<div class="admonition-common-choices admonition">
<p class="admonition-title">Common choices</p>
<ul class="simple">
<li><p>Start small: <code class="docutils literal notranslate"><span class="pre">max_depth=3</span></code> or <code class="docutils literal notranslate"><span class="pre">min_samples_leaf=5</span></code>.</p></li>
<li><p>For forests, try <code class="docutils literal notranslate"><span class="pre">n_estimators</span></code> in <code class="docutils literal notranslate"><span class="pre">[200,</span> <span class="pre">300,</span> <span class="pre">500]</span></code> and <code class="docutils literal notranslate"><span class="pre">max_features=&quot;sqrt&quot;</span></code> for classification.</p></li>
<li><p>Use OOB for a quick check, still keep a proper test split.</p></li>
</ul>
</div>
</section>
<hr class="docutils" />
<section id="glossary">
<h2><a class="toc-backref" href="#id16" role="doc-backlink">12. Glossary</a><a class="headerlink" href="#glossary" title="Permalink to this heading">#</a></h2>
<dl class="simple glossary">
<dt id="term-Decision-tree">Decision tree<a class="headerlink" href="#term-Decision-tree" title="Permalink to this term">#</a></dt><dd><p>A model that recursively splits data by feature thresholds until leaves make simple predictions.</p>
</dd>
<dt id="term-Leaf">Leaf<a class="headerlink" href="#term-Leaf" title="Permalink to this term">#</a></dt><dd><p>Final node of a tree where a prediction is made. Regression leaves predict a mean. Classification leaves predict a class distribution.</p>
</dd>
<dt id="term-Gini">Gini<a class="headerlink" href="#term-Gini" title="Permalink to this term">#</a></dt><dd><p>A measure of impurity for classification. Zero means pure.</p>
</dd>
<dt id="term-Entropy">Entropy<a class="headerlink" href="#term-Entropy" title="Permalink to this term">#</a></dt><dd><p>Another impurity measure. Zero means pure.</p>
</dd>
<dt id="term-Out-of-bag-OOB">Out-of-bag (OOB)<a class="headerlink" href="#term-Out-of-bag-OOB" title="Permalink to this term">#</a></dt><dd><p>Samples left out of a bootstrap draw. A forest can score these to estimate generalization.</p>
</dd>
<dt id="term-Feature-importance">Feature importance<a class="headerlink" href="#term-Feature-importance" title="Permalink to this term">#</a></dt><dd><p>Relative contribution of a feature to improving the split criterion across the tree or forest.</p>
</dd>
<dt id="term-Permutation-importance">Permutation importance<a class="headerlink" href="#term-Permutation-importance" title="Permalink to this term">#</a></dt><dd><p>Drop in a metric when a feature is randomly shuffled on a held-out set.</p>
</dd>
<dt id="term-max_depth">max_depth<a class="headerlink" href="#term-max_depth" title="Permalink to this term">#</a></dt><dd><p>Maximum allowed depth of the tree. Smaller limits reduce variance.</p>
</dd>
<dt id="term-min_samples_leaf">min_samples_leaf<a class="headerlink" href="#term-min_samples_leaf" title="Permalink to this term">#</a></dt><dd><p>Minimum samples allowed in a leaf. Larger values reduce variance.</p>
</dd>
<dt id="term-max_features">max_features<a class="headerlink" href="#term-max_features" title="Permalink to this term">#</a></dt><dd><p>Number of features to consider when looking for the best split. Forests often use a subset.</p>
</dd>
</dl>
</section>
<hr class="docutils" />
<section id="in-class-activities">
<h2><a class="toc-backref" href="#id17" role="doc-backlink">13. In-class activities</a><a class="headerlink" href="#in-class-activities" title="Permalink to this heading">#</a></h2>
<section id="q1-tree-regression-sweep-min-samples-leaf">
<h3>Q1. Tree regression - sweep <code class="docutils literal notranslate"><span class="pre">min_samples_leaf</span></code><a class="headerlink" href="#q1-tree-regression-sweep-min-samples-leaf" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">DecisionTreeRegressor</span></code> on Melting Point with <code class="docutils literal notranslate"><span class="pre">min_samples_leaf</span></code> in <code class="docutils literal notranslate"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">5,</span> <span class="pre">10,</span> <span class="pre">20,</span> <span class="pre">40]</span></code> and <code class="docutils literal notranslate"><span class="pre">max_depth=None</span></code>.</p></li>
<li><p>Plot test R2 vs <code class="docutils literal notranslate"><span class="pre">min_samples_leaf</span></code>. Which value stabilizes test R2 without hurting it too much?</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># TO DO</span>
<span class="c1"># values = [1, 2, 5, 10, 20, 40]</span>
<span class="c1"># scores = []</span>
<span class="c1"># for v in values:</span>
<span class="c1">#     m = DecisionTreeRegressor(min_samples_leaf=v, random_state=0).fit(X_tr, y_tr)</span>
<span class="c1">#     scores.append(r2_score(y_te, m.predict(X_te)))</span>
<span class="c1"># plt.plot(values, scores, &quot;o-&quot;); plt.xscale(&quot;log&quot;)</span>
</pre></div>
</div>
</section>
<section id="q2-tree-classification-threshold-tuning">
<h3>Q2. Tree classification - threshold tuning<a class="headerlink" href="#q2-tree-classification-threshold-tuning" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Train a depth-4 tree on toxicity. Scan thresholds from <code class="docutils literal notranslate"><span class="pre">0.2</span></code> to <code class="docutils literal notranslate"><span class="pre">0.8</span></code> in steps of <code class="docutils literal notranslate"><span class="pre">0.05</span></code>.</p></li>
<li><p>Find the smallest threshold with recall at least <code class="docutils literal notranslate"><span class="pre">0.80</span></code>. Report precision and F1 there.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># TO DO</span>
<span class="c1"># clf = DecisionTreeClassifier(max_depth=4, random_state=0).fit(Xc_tr, yc_tr)</span>
<span class="c1"># proba = clf.predict_proba(Xc_te)[:,1]</span>
<span class="c1"># thresholds = np.arange(0.2, 0.81, 0.05)</span>
<span class="c1"># ...</span>
</pre></div>
</div>
</section>
<section id="q3-forest-regression-n-estimators-curve">
<h3>Q3. Forest regression - n_estimators curve<a class="headerlink" href="#q3-forest-regression-n-estimators-curve" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Train <code class="docutils literal notranslate"><span class="pre">RandomForestRegressor</span></code> with <code class="docutils literal notranslate"><span class="pre">n_estimators</span></code> in <code class="docutils literal notranslate"><span class="pre">[50,</span> <span class="pre">100,</span> <span class="pre">200,</span> <span class="pre">300,</span> <span class="pre">500]</span></code> and record test R2.</p></li>
<li><p>Plot R2 vs <code class="docutils literal notranslate"><span class="pre">n_estimators</span></code>. Where does it level off?</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># TO DO</span>
<span class="c1"># ns = [50, 100, 200, 300, 500]</span>
<span class="c1"># r2s = []</span>
<span class="c1"># for n in ns:</span>
<span class="c1">#     m = RandomForestRegressor(n_estimators=n, random_state=0, n_jobs=-1).fit(X_tr, y_tr)</span>
<span class="c1">#     r2s.append(r2_score(y_te, m.predict(X_te)))</span>
<span class="c1"># plt.plot(ns, r2s, &quot;o-&quot;)</span>
</pre></div>
</div>
</section>
<section id="q4-forest-classification-permutation-importance">
<h3>Q4. Forest classification - permutation importance<a class="headerlink" href="#q4-forest-classification-permutation-importance" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Train <code class="docutils literal notranslate"><span class="pre">RandomForestClassifier</span></code> with <code class="docutils literal notranslate"><span class="pre">n_estimators=300</span></code> on toxicity.</p></li>
<li><p>Compute permutation importance on the test split using <code class="docutils literal notranslate"><span class="pre">roc_auc</span></code> as the scorer.</p></li>
<li><p>Plot the result. Which descriptor helps the most?</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># TO DO</span>
<span class="c1"># rfc = RandomForestClassifier(n_estimators=300, random_state=0, n_jobs=-1).fit(Xc_tr, yc_tr)</span>
<span class="c1"># perm = permutation_importance(rfc, Xc_te, yc_te, scoring=&quot;roc_auc&quot;, n_repeats=20, random_state=0)</span>
<span class="c1"># pd.Series(perm.importances_mean, index=feat).sort_values().plot(kind=&quot;barh&quot;)</span>
</pre></div>
</div>
</section>
<section id="q5-end-to-end-challenge">
<h3>Q5. End-to-end challenge<a class="headerlink" href="#q5-end-to-end-challenge" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Use GridSearchCV to tune a small forest for Melting Point with the grid:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">n_estimators</span></code>: <code class="docutils literal notranslate"><span class="pre">[200,</span> <span class="pre">300]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_depth</span></code>: <code class="docutils literal notranslate"><span class="pre">[None,</span> <span class="pre">6,</span> <span class="pre">10]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">min_samples_leaf</span></code>: <code class="docutils literal notranslate"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">5]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_features</span></code>: <code class="docutils literal notranslate"><span class="pre">[&quot;auto&quot;,</span> <span class="pre">&quot;sqrt&quot;]</span></code></p></li>
</ul>
</li>
<li><p>Report best params, CV mean R2, and test R2.</p></li>
<li><p>Predict for three SMILES of your choice by computing descriptors first.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">0. Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-and-descriptors">1. Data and descriptors</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data">1.1 Load data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-descriptors-from-smiles">1.2 Compute descriptors from SMILES</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decision-trees-what-they-do">2. Decision trees: what they do</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tree-regression-melting-point">3. Tree regression - Melting Point</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-x-and-y">3.1 Prepare <code class="docutils literal notranslate"><span class="pre">X</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#split-into-train-and-test">3.2 Split into train and test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-a-tiny-tree-depth-1-stump">3.3 Fit a tiny tree - depth 1 stump</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#increase-depth-step-by-step">3.4 Increase depth step by step</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#control-leaves-instead-of-depth">3.5 Control leaves instead of depth</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-importance-for-the-chosen-tree">3.6 Feature importance for the chosen tree</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#small-parity-plot-for-the-chosen-tree">3.7 Small parity plot for the chosen tree</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tree-classification-toxicity">4. Tree classification - Toxicity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#encode-the-labels">4.1 Encode the labels</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stratified-split">4.2 Stratified split</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#depth-1-classifier">4.3 Depth 1 classifier</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sweep-max-depth-and-plot-scores">4.4 Sweep <code class="docutils literal notranslate"><span class="pre">max_depth</span></code> and plot scores</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#confusion-matrix-for-the-chosen-depth">4.5 Confusion matrix for the chosen depth</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest-regression">5. Random Forest - regression</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-the-forest-with-oob-score">5.1 Fit the forest with OOB score</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-importance-and-permutation-importance">5.2 Feature importance and permutation importance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-dependence-for-1-feature">5.3 Partial dependence for 1 feature</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#effect-of-n-estimators">5.4 Effect of <code class="docutils literal notranslate"><span class="pre">n_estimators</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest-classification">6. Random Forest - classification</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-and-report-oob-score">6.1 Fit and report OOB score</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#roc-curve">6.2 ROC curve</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#importance-and-top-features">6.3 Importance and top features</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compare-single-tree-vs-forest">7. Compare: single tree vs forest</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hyperparameter-tuning-with-gridsearchcv">8. Hyperparameter tuning with GridSearchCV</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decision-tree-regression">8.1 Decision tree - regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">8.2 Random forest - regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decision-tree-classification">8.3 Decision tree - classification</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">8.4 Random forest - classification</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-one-tree-from-a-forest">9. Inspect one tree from a forest</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#putting-it-together-clean-workflows">10. Putting it together - clean workflows</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#regression-pipeline-random-forest">10.1 Regression pipeline - Random Forest</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#classification-pipeline-random-forest">10.2 Classification pipeline - Random Forest</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-reference">11. Quick reference</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">12. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-class-activities">13. In-class activities</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q1-tree-regression-sweep-min-samples-leaf">Q1. Tree regression - sweep <code class="docutils literal notranslate"><span class="pre">min_samples_leaf</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q2-tree-classification-threshold-tuning">Q2. Tree classification - threshold tuning</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q3-forest-regression-n-estimators-curve">Q3. Forest regression - n_estimators curve</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q4-forest-classification-permutation-importance">Q4. Forest classification - permutation importance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q5-end-to-end-challenge">Q5. End-to-end challenge</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>