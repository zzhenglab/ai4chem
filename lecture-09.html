

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Lecture 9 - Graph Neural Networks &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lecture-09';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to CHEM 5080: AI for Chemistry
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="lecture-01.html">Lecture 1 - Python Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-02.html">Lecture 2 - Pandas and Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-03.html">Lecture 3 - SMILES and RDKit</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-04.html">Lecture 4 - Chemical Structure Identifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-05.html">Lecture 5 - Regression and Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-06.html">Lecture 6 - Cross-Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-07.html">Lecture 7 - Decision Trees and Random Forests</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Flecture-09.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/lecture-09.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lecture 9 - Graph Neural Networks</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">1. Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-mlp-from-scratch">2 Building MLP from scratch</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pytorch-regression-on-melting-point">2.1 PyTorch regression on melting point</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#build-a-tiny-network">2.2 Build a tiny network</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loss-and-optimizer">2.3 Loss and optimizer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#one-training-step-demo">2.4 One training step demo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#training-loop">2.5 Training loop</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-regression">2.6 Evaluate regression</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#baseline-comparison">2.7 Baseline comparison</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pytorch-regressor-with-sklearn-like-interface">2.8 PyTorch Regressor with sklearn-like Interface</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#molecules-as-graphs">3) Molecules as graphs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#minimal-node-and-edge-features">3.1 Minimal node and edge features</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#build-tiny-toy-graphs-by-hand">3.2 Build tiny toy graphs by hand</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#message-passing-the-core-idea">4) Message passing: the core idea</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#your-first-gnn-layer-in-pure-pytorch">5) Your first GNN layer in pure PyTorch</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-neighbor-sum-helper">5.1 A neighbor sum helper</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-one-message-passing-layer">5.2 Define one message passing layer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stack-layers-and-pool-to-a-graph-vector">5.3 Stack layers and pool to a graph vector</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sanity-check-with-toy-graphs">5.4 Sanity check with toy graphs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#train-on-toy-data-regression-on-a-madeup-scalar">5.5 Train on toy data (regression on a made‑up scalar)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#from-smiles-to-graphs-with-rdkit-mini-pipeline">6) From SMILES to graphs with RDKit (mini pipeline)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#featurization-helpers">6.1 Featurization helpers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-a-small-dataset-from-the-csv">6.2 Make a small dataset from the CSV</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tiny-training-loop-for-graphs">6.3 Tiny training loop for graphs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#chemprop-v2-practical-graph-models-for-chemistry">7) Chemprop v2: practical graph models for chemistry</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#install-chemprop">7.1 Install Chemprop</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#melting-point-regression">7.2 Melting point regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reactivity-classification-ch-oxidation-dataset">7.3 Reactivity classification (C–H oxidation dataset)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">8) References</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">9) Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inclass-activity-and-solutions">10) In‑class activity and solutions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q1-mlp-warmup-on-melting-point">Q1. MLP warmup on melting point</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q2-build-and-inspect-the-toy-gnn">Q2. Build and inspect the toy GNN</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q3-rdkit-graph-miniset-optional-if-rdkit-missing">Q3. RDKit graph mini‑set (optional if RDKit missing)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q4-chemprop-regression-on-melting-point">Q4. Chemprop regression on melting point</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q5-chemprop-classification-on-toxicity">Q5. Chemprop classification on toxicity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solutions">Solutions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-q1">Solution Q1</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-q2">Solution Q2</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-q3">Solution Q3</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-q4">Solution Q4</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-q5">Solution Q5</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-cheat-sheet">Quick cheat sheet</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lecture-9-graph-neural-networks">
<h1>Lecture 9 - Graph Neural Networks<a class="headerlink" href="#lecture-9-graph-neural-networks" title="Permalink to this heading">#</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#learning-goals" id="id1">Learning goals</a></p></li>
<li><p><a class="reference internal" href="#setup" id="id2">1. Setup</a></p></li>
<li><p><a class="reference internal" href="#building-mlp-from-scratch" id="id3">2 Building MLP from scratch</a></p></li>
<li><p><a class="reference internal" href="#baseline-comparison" id="id4">2.7 Baseline comparison</a></p></li>
<li><p><a class="reference internal" href="#molecules-as-graphs" id="id5">3) Molecules as graphs</a></p></li>
<li><p><a class="reference internal" href="#message-passing-the-core-idea" id="id6">4) Message passing: the core idea</a></p></li>
<li><p><a class="reference internal" href="#your-first-gnn-layer-in-pure-pytorch" id="id7">5) Your first GNN layer in pure PyTorch</a></p></li>
<li><p><a class="reference internal" href="#from-smiles-to-graphs-with-rdkit-mini-pipeline" id="id8">6) From SMILES to graphs with RDKit (mini pipeline)</a></p></li>
<li><p><a class="reference internal" href="#chemprop-v2-practical-graph-models-for-chemistry" id="id9">7) Chemprop v2: practical graph models for chemistry</a></p></li>
<li><p><a class="reference internal" href="#references" id="id10">8) References</a></p></li>
<li><p><a class="reference internal" href="#glossary" id="id11">9) Glossary</a></p></li>
<li><p><a class="reference internal" href="#inclass-activity-and-solutions" id="id12">10) In‑class activity and solutions</a></p></li>
</ul>
</nav>
<section id="learning-goals">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Learning goals</a><a class="headerlink" href="#learning-goals" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Build basic MLP-style Neural Networks from scratch using <strong>PyTorch</strong>.</p></li>
<li><p>Explain molecules as <strong>graphs</strong>: atoms = nodes, bonds = edges, features at each.</p></li>
<li><p>Write the <strong>message passing</strong> equations and understand neighborhood aggregation.</p></li>
<li><p>Build a tiny GNN in PyTorch on toy molecules.</p></li>
<li><p>Prepare molecular <strong>graphs from SMILES</strong> and run a mini GNN.</p></li>
<li><p>Experience with a MPNN example <strong>Chemprop</strong>.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="setup">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">1. Setup</a><a class="headerlink" href="#setup" title="Permalink to this heading">#</a></h2>
<p>We reuse most of the stack from earlier lectures.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Setup</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span><span class="o">,</span><span class="w"> </span><span class="nn">math</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">json</span><span class="o">,</span><span class="w"> </span><span class="nn">time</span><span class="o">,</span><span class="w"> </span><span class="nn">random</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Sklearn bits for splitting and metrics</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">TransformedTargetRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neural_network</span><span class="w"> </span><span class="kn">import</span> <span class="n">MLPRegressor</span>


<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">,</span>
                             <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span>
                             <span class="n">f1_score</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">)</span>

<span class="c1"># Torch for MLP and GNN</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Installing torch, this may take a minute...&quot;</span><span class="p">)</span>
    <span class="o">%</span><span class="k">pip</span> -q install torch
    <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>

<span class="c1"># RDKit</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">Draw</span><span class="p">,</span> <span class="n">Descriptors</span><span class="p">,</span> <span class="n">Crippen</span><span class="p">,</span> <span class="n">rdMolDescriptors</span><span class="p">,</span> <span class="n">AllChem</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="o">%</span><span class="k">pip</span> install rdkit
        <span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">Draw</span><span class="p">,</span> <span class="n">Descriptors</span><span class="p">,</span> <span class="n">Crippen</span><span class="p">,</span> <span class="n">rdMolDescriptors</span><span class="p">,</span> <span class="n">AllChem</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RDKit is not available in this environment. Drawing and descriptors will be skipped.&quot;</span><span class="p">)</span>
        <span class="n">Chem</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># A small global seed helper</span>
<span class="k">def</span><span class="w"> </span><span class="nf">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">);</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">);</span> <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<hr class="docutils" />
<section id="building-mlp-from-scratch">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">2 Building MLP from scratch</a><a class="headerlink" href="#building-mlp-from-scratch" title="Permalink to this heading">#</a></h2>
<p>In Lecture 8 we built MLPs with <code class="docutils literal notranslate"><span class="pre">scikit‑learn</span></code>. Today we start by doing the same with <strong>PyTorch</strong>. One advantage of using PyTorch is that it lets you write the forward pass directly, control the training loop, and later move to GPUs or custom layers. We start tiny and stay friendly.</p>
<p>We will predict <strong>melting point</strong> from four descriptors: <code class="docutils literal notranslate"><span class="pre">MolWt</span></code>, <code class="docutils literal notranslate"><span class="pre">LogP</span></code>, <code class="docutils literal notranslate"><span class="pre">TPSA</span></code>, <code class="docutils literal notranslate"><span class="pre">NumRings</span></code>, same as before.</p>
<section id="pytorch-regression-on-melting-point">
<h3>2.1 PyTorch regression on melting point<a class="headerlink" href="#pytorch-regression-on-melting-point" title="Permalink to this heading">#</a></h3>
<p>Every PyTorch project has three parts:</p>
<ol class="arabic simple">
<li><p><strong>Model</strong>: stack of layers with weights and activations.</p></li>
<li><p><strong>Loss</strong>: a number telling how far predictions are from the truth.</p></li>
<li><p><strong>Optimizer</strong>: an algorithm that adjusts weights to reduce loss.</p></li>
</ol>
<p>We use descriptors <code class="docutils literal notranslate"><span class="pre">[MolWt,</span> <span class="pre">LogP,</span> <span class="pre">TPSA,</span> <span class="pre">NumRings]</span></code> to predict <code class="docutils literal notranslate"><span class="pre">Melting</span> <span class="pre">Point</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/zzhenglab/ai4chem/main/book/_data/C_H_oxidation_dataset.csv&quot;</span>
<span class="n">df_oxidation_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calc_descriptors</span><span class="p">(</span><span class="n">smiles</span><span class="p">):</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span>
            <span class="s2">&quot;MolWt&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;LogP&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;TPSA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;NumRings&quot;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span>
        <span class="s2">&quot;MolWt&quot;</span><span class="p">:</span> <span class="n">Descriptors</span><span class="o">.</span><span class="n">MolWt</span><span class="p">(</span><span class="n">mol</span><span class="p">),</span>                    <span class="c1"># molecular weight</span>
        <span class="s2">&quot;LogP&quot;</span><span class="p">:</span> <span class="n">Crippen</span><span class="o">.</span><span class="n">MolLogP</span><span class="p">(</span><span class="n">mol</span><span class="p">),</span>                       <span class="c1"># octanol-water logP</span>
        <span class="s2">&quot;TPSA&quot;</span><span class="p">:</span> <span class="n">rdMolDescriptors</span><span class="o">.</span><span class="n">CalcTPSA</span><span class="p">(</span><span class="n">mol</span><span class="p">),</span>             <span class="c1"># topological polar surface area</span>
        <span class="s2">&quot;NumRings&quot;</span><span class="p">:</span> <span class="n">rdMolDescriptors</span><span class="o">.</span><span class="n">CalcNumRings</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>      <span class="c1"># number of rings</span>
    <span class="p">})</span>

<span class="c1"># Apply the function to the SMILES column</span>
<span class="n">desc_df</span> <span class="o">=</span> <span class="n">df_oxidation_raw</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">calc_descriptors</span><span class="p">)</span>

<span class="c1"># Concatenate new descriptor columns to original DataFrame</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_oxidation_raw</span><span class="p">,</span> <span class="n">desc_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Compound Name</th>
      <th>CAS</th>
      <th>SMILES</th>
      <th>Solubility_mol_per_L</th>
      <th>pKa</th>
      <th>Toxicity</th>
      <th>Melting Point</th>
      <th>Reactivity</th>
      <th>Oxidation Site</th>
      <th>MolWt</th>
      <th>LogP</th>
      <th>TPSA</th>
      <th>NumRings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3,4-dihydro-1H-isochromene</td>
      <td>493-05-0</td>
      <td>c1ccc2c(c1)CCOC2</td>
      <td>0.103906</td>
      <td>5.80</td>
      <td>non_toxic</td>
      <td>65.8</td>
      <td>1</td>
      <td>8,10</td>
      <td>134.178</td>
      <td>1.7593</td>
      <td>9.23</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9H-fluorene</td>
      <td>86-73-7</td>
      <td>c1ccc2c(c1)Cc1ccccc1-2</td>
      <td>0.010460</td>
      <td>5.82</td>
      <td>toxic</td>
      <td>90.0</td>
      <td>1</td>
      <td>7</td>
      <td>166.223</td>
      <td>3.2578</td>
      <td>0.00</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1,2,3,4-tetrahydronaphthalene</td>
      <td>119-64-2</td>
      <td>c1ccc2c(c1)CCCC2</td>
      <td>0.020589</td>
      <td>5.74</td>
      <td>toxic</td>
      <td>69.4</td>
      <td>1</td>
      <td>7,10</td>
      <td>132.206</td>
      <td>2.5654</td>
      <td>0.00</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ethylbenzene</td>
      <td>100-41-4</td>
      <td>CCc1ccccc1</td>
      <td>0.048107</td>
      <td>5.87</td>
      <td>non_toxic</td>
      <td>65.0</td>
      <td>1</td>
      <td>1,2</td>
      <td>106.168</td>
      <td>2.2490</td>
      <td>0.00</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cyclohexene</td>
      <td>110-83-8</td>
      <td>C1=CCCCC1</td>
      <td>0.060688</td>
      <td>5.66</td>
      <td>non_toxic</td>
      <td>96.4</td>
      <td>1</td>
      <td>3,6</td>
      <td>82.146</td>
      <td>2.1166</td>
      <td>0.00</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>570</th>
      <td>2-naphthalen-2-ylpropan-2-amine</td>
      <td>90299-04-0</td>
      <td>CC(C)(N)c1ccc2ccccc2c1</td>
      <td>0.018990</td>
      <td>10.04</td>
      <td>toxic</td>
      <td>121.5</td>
      <td>-1</td>
      <td>-1</td>
      <td>185.270</td>
      <td>3.0336</td>
      <td>26.02</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>571</th>
      <td>1-bromo-4-(methylamino)anthracene-9,10-dione</td>
      <td>128-93-8</td>
      <td>CNc1ccc(Br)c2c1C(=O)c1ccccc1C2=O</td>
      <td>0.021590</td>
      <td>7.81</td>
      <td>toxic</td>
      <td>154.0</td>
      <td>-1</td>
      <td>-1</td>
      <td>316.154</td>
      <td>3.2662</td>
      <td>46.17</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>572</th>
      <td>1-[6-(dimethylamino)naphthalen-2-yl]prop-2-en-...</td>
      <td>86636-92-2</td>
      <td>C=CC(=O)c1ccc2cc(N(C)C)ccc2c1</td>
      <td>0.017866</td>
      <td>8.58</td>
      <td>toxic</td>
      <td>128.3</td>
      <td>-1</td>
      <td>-1</td>
      <td>225.291</td>
      <td>3.2745</td>
      <td>20.31</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>573</th>
      <td>1,2-dimethoxy-12-methyl-[1,3]benzodioxolo[5,6-...</td>
      <td>34316-15-9</td>
      <td>COc1ccc2c(c[n+](C)c3c4cc5c(cc4ccc23)OCO5)c1OC</td>
      <td>0.016210</td>
      <td>5.54</td>
      <td>toxic</td>
      <td>215.6</td>
      <td>-1</td>
      <td>-1</td>
      <td>348.378</td>
      <td>3.7166</td>
      <td>40.80</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>574</th>
      <td>dimethyl anthracene-1,8-dicarboxylate</td>
      <td>93655-34-6</td>
      <td>COC(=O)c1cccc2cc3cccc(C(=O)OC)c3cc12</td>
      <td>0.016761</td>
      <td>5.43</td>
      <td>toxic</td>
      <td>175.3</td>
      <td>-1</td>
      <td>-1</td>
      <td>294.306</td>
      <td>3.5662</td>
      <td>52.60</td>
      <td>3.0</td>
    </tr>
  </tbody>
</table>
<p>575 rows × 13 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_reg</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span> <span class="s2">&quot;LogP&quot;</span><span class="p">,</span> <span class="s2">&quot;TPSA&quot;</span><span class="p">,</span> <span class="s2">&quot;NumRings&quot;</span><span class="p">,</span> <span class="s2">&quot;Melting Point&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df_reg</span><span class="p">[[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span> <span class="s2">&quot;LogP&quot;</span><span class="p">,</span> <span class="s2">&quot;TPSA&quot;</span><span class="p">,</span> <span class="s2">&quot;NumRings&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df_reg</span><span class="p">[</span><span class="s2">&quot;Melting Point&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">X_tr</span><span class="p">,</span> <span class="n">X_te</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">,</span> <span class="n">y_te</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr</span><span class="p">)</span>
<span class="n">X_tr_s</span><span class="p">,</span> <span class="n">X_te_s</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_tr</span><span class="p">),</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_te</span><span class="p">)</span>
<span class="n">X_tr</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">X_tr_s</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([[226.703 ,   3.687 ,  26.3   ,   1.    ],
        [282.295 ,   2.5255,  52.6   ,   3.    ],
        [468.722 ,   7.5302,  43.37  ,   5.    ]], dtype=float32),
 array([[ 0.06339765,  0.44967934, -0.24905416, -0.86862624],
        [ 0.6769087 , -0.22752753,  0.58845747,  0.51635844],
        [ 2.7343087 ,  2.6904383 ,  0.2945323 ,  1.9013431 ]],
       dtype=float32))
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="build-a-tiny-network">
<h3>2.2 Build a tiny network<a class="headerlink" href="#build-a-tiny-network" title="Permalink to this heading">#</a></h3>
<p>Now we will start to build a network has one hidden layer of 32 units with ReLU activation.<br />
Output is a single number (regression).</p>
<p>This is equivalent to what we did before with:</p>
<blockquote>
<div><p>MLPRegressor(hidden_layer_sizes=(32,), activation=”relu”)</p>
</div></blockquote>
<p>But the difference is that in scikit-learn the whole pipeline is hidden inside one class.</p>
<p>In PyTorch we build the pieces ourselves: the layers, the activation, and the forward pass.</p>
<p>This way you can see what is happening under the hood.</p>
<p><strong>How PyTorch models work</strong></p>
<ul class="simple">
<li><p>A model is a Python object with <strong>layers</strong>. Each layer has <strong>parameters</strong> (weights and bias).</p></li>
<li><p>You pass an input <strong>tensor</strong> through the model to get predictions. This call is the <strong>forward pass</strong>.</p></li>
<li><p>PyTorch <strong>records</strong> operations during the forward pass. That record lets it compute <strong>gradients</strong> during <code class="docutils literal notranslate"><span class="pre">loss.backward()</span></code>.</p></li>
<li><p>Parameters live in <code class="docutils literal notranslate"><span class="pre">model.parameters()</span></code> and can be saved with <code class="docutils literal notranslate"><span class="pre">model.state_dict()</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.to(device)</span></code> moves the model to GPU if available. Inputs must be on the same device.</p></li>
</ul>
<p><strong>Two common ways to build a model</strong></p>
<ol class="arabic simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">nn.Sequential</span></code></strong>: fast for simple stacks.</p></li>
<li><p><strong>Subclass <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code></strong>: gives you a custom <code class="docutils literal notranslate"><span class="pre">forward</span></code> method and more control.</p></li>
</ol>
<p>Below we show both styles. Pick one. They behave the same here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sequential style: quickest for simple feed-forward nets</span>
<span class="n">in_dim</span> <span class="o">=</span> <span class="n">X_tr_s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">reg_model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_dim</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>  <span class="c1"># weights W: [in_dim, 32], bias b: [32]</span>
    <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
    <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>        <span class="c1"># weights W: [32, 1], bias b: [1]</span>
<span class="p">)</span>
<span class="n">reg_model</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sequential(
  (0): Linear(in_features=4, out_features=32, bias=True)
  (1): ReLU()
  (2): Linear(in_features=32, out_features=1, bias=True)
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Inspect shapes of parameters</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">reg_model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2">  shape=</span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2">  requires_grad=</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.weight              shape=(32, 4)  requires_grad=True
0.bias                shape=(32,)  requires_grad=True
2.weight              shape=(1, 32)  requires_grad=True
2.bias                shape=(1,)  requires_grad=True
</pre></div>
</div>
</div>
</div>
<p>A custom module version looks like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TinyRegressor</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_dim</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_dim</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span>  <span class="c1"># input -&gt; hidden layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">act</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>  <span class="c1"># ReLU activation function in hidden layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># hidden -&gt; output layer</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># x has shape [batch, in_dim]</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>  <span class="c1"># shape [batch, hidden]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>          <span class="c1"># shape [batch, 1]</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="n">reg_model2</span> <span class="o">=</span> <span class="n">TinyRegressor</span><span class="p">(</span><span class="n">in_dim</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">reg_model2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TinyRegressor(
  (fc1): Linear(in_features=4, out_features=32, bias=True)
  (act): ReLU()
  (fc2): Linear(in_features=32, out_features=1, bias=True)
)
</pre></div>
</div>
</div>
</div>
<p><strong>Shapes to keep in mind</strong></p>
<ul class="simple">
<li><p>Input batch <code class="docutils literal notranslate"><span class="pre">x</span></code>: <code class="docutils literal notranslate"><span class="pre">[batch,</span> <span class="pre">in_dim]</span></code></p></li>
<li><p>Hidden layer output: <code class="docutils literal notranslate"><span class="pre">[batch,</span> <span class="pre">32]</span></code></p></li>
<li><p>Final output: <code class="docutils literal notranslate"><span class="pre">[batch,</span> <span class="pre">1]</span></code></p></li>
</ul>
<p><strong>Tip</strong>: you can print a few predictions to sanity check the flow (numbers will be random before training).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_sample</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">X_tr_s</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Raw outputs using first 3 values on X-train:&quot;</span><span class="p">,</span> <span class="n">reg_model</span><span class="p">(</span><span class="n">x_sample</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Raw outputs using first 3 values on X-train: [-0.3615578   0.06239668  0.7558894 ]
</pre></div>
</div>
</div>
</div>
<p>For the rest of this chapter, we will use method 2 (<code class="docutils literal notranslate"><span class="pre">reg_model2</span></code>) to show the rest steps.</p>
</section>
<hr class="docutils" />
<section id="loss-and-optimizer">
<h3>2.3 Loss and optimizer<a class="headerlink" href="#loss-and-optimizer" title="Permalink to this heading">#</a></h3>
<p>For regression we use <strong>MSELoss</strong>.<br />
The optimizer is <strong>Adam</strong>, which updates weights smoothly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">reg_model2</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<span class="n">optimizer</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Adam (
Parameter Group 0
    amsgrad: False
    betas: (0.9, 0.999)
    capturable: False
    differentiable: False
    eps: 1e-08
    foreach: None
    fused: None
    lr: 0.01
    maximize: False
    weight_decay: 0.001
)
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="one-training-step-demo">
<h3>2.4 One training step demo<a class="headerlink" href="#one-training-step-demo" title="Permalink to this heading">#</a></h3>
<p>To see the loop clearly: forward → loss → backward → update.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">X_tr_s</span><span class="p">[:</span><span class="mi">64</span><span class="p">])</span>
<span class="n">yb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y_tr</span><span class="p">[:</span><span class="mi">64</span><span class="p">])</span>

<span class="n">pred</span> <span class="o">=</span> <span class="n">reg_model2</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>      <span class="c1"># forward pass</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span>  <span class="c1"># compute loss</span>

<span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>     <span class="c1"># clear old grads</span>
<span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>           <span class="c1"># compute new grads for each parameter</span>
<span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>          <span class="c1"># apply the update</span>

<span class="nb">float</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>19706.015625
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="training-loop">
<h3>2.5 Training loop<a class="headerlink" href="#training-loop" title="Permalink to this heading">#</a></h3>
<p>We train for 150 epochs. Each epoch goes through the dataset in batches.<br />
We plot the loss to see if the model is learning.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">NumpyDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">NumpyDataset</span><span class="p">(</span><span class="n">X_tr_s</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">),</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">train_losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">reg_model2</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">150</span><span class="p">):</span>
    <span class="n">batch_losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
        <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="o">=</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">reg_model2</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">();</span> <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">();</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">batch_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">train_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">batch_losses</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_losses</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;train MSE&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Training loss - regression&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b605293a623ff66c94b8ad5b0f351ff5f2bacf868feda73b5878f3b4df0134bb.png" src="_images/b605293a623ff66c94b8ad5b0f351ff5f2bacf868feda73b5878f3b4df0134bb.png" />
</div>
</div>
<p>Let’s break down what happened above step by step:</p>
<ol class="arabic simple">
<li><p><strong>Dataset and DataLoader</strong><br />
We wrapped our numpy arrays in <code class="docutils literal notranslate"><span class="pre">NumpyDataset</span></code>, which makes them look like a PyTorch dataset.<br />
Then <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> split the dataset into mini-batches of 64 rows and shuffled them each epoch.<br />
This helps training be faster and more stable.</p></li>
<li><p><strong>Epochs and batches</strong><br />
Each <code class="docutils literal notranslate"><span class="pre">epoch</span></code> means “one full pass over the training data”.<br />
Inside each epoch, we looped over mini-batches. For every batch:</p>
<ul class="simple">
<li><p>We ran the <strong>forward pass</strong>: <code class="docutils literal notranslate"><span class="pre">pred</span> <span class="pre">=</span> <span class="pre">reg_model(xb)</span></code></p></li>
<li><p>We computed the <strong>loss</strong>: <code class="docutils literal notranslate"><span class="pre">loss</span> <span class="pre">=</span> <span class="pre">loss_fn(pred,</span> <span class="pre">yb)</span></code></p></li>
<li><p>We reset old gradients with <code class="docutils literal notranslate"><span class="pre">optimizer.zero_grad()</span></code></p></li>
<li><p>We called <code class="docutils literal notranslate"><span class="pre">loss.backward()</span></code> so PyTorch computes gradients for each weight</p></li>
<li><p>We called <code class="docutils literal notranslate"><span class="pre">optimizer.step()</span></code> to update the weights slightly</p></li>
</ul>
</li>
<li><p><strong>Loss tracking</strong><br />
We stored the average loss per epoch in <code class="docutils literal notranslate"><span class="pre">train_losses</span></code>.<br />
If you plot <code class="docutils literal notranslate"><span class="pre">train_losses</span></code>, you should see it go down.<br />
This means the network predictions are getting closer to the true labels.</p></li>
</ol>
<p>By the end of 150 epochs, the model should be much better than at the start.</p>
</section>
<hr class="docutils" />
<section id="evaluate-regression">
<h3>2.6 Evaluate regression<a class="headerlink" href="#evaluate-regression" title="Permalink to this heading">#</a></h3>
<p>We check mean squared error and plot predicted vs true <code class="docutils literal notranslate"><span class="pre">Meltig</span> <span class="pre">Point</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reg_model2</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">yhat_te</span> <span class="o">=</span> <span class="n">reg_model2</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">X_te_s</span><span class="p">))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MSE:&quot;</span><span class="p">,</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">yhat_te</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R2:&quot;</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">yhat_te</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">4.6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">yhat_te</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">lims</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">y_te</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">yhat_te</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_te</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">yhat_te</span><span class="o">.</span><span class="n">max</span><span class="p">())]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span> <span class="n">lims</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;True logS&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Pred logS&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Parity plot&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MSE: 377.2238
R2: 0.8732098882942341
</pre></div>
</div>
<img alt="_images/c9c6afdc63d6c8c680630e1451c459e03f71a3f48413e8b977887385c3158007.png" src="_images/c9c6afdc63d6c8c680630e1451c459e03f71a3f48413e8b977887385c3158007.png" />
</div>
</div>
<p>This suggests our customized NN achieve a good performance on this task  :D</p>
</section>
</section>
<section id="baseline-comparison">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">2.7 Baseline comparison</a><a class="headerlink" href="#baseline-comparison" title="Permalink to this heading">#</a></h2>
<p>To understand how our PyTorch neural network compares to standard regressors,
we evaluate three baselines:</p>
<ul class="simple">
<li><p><strong>Decision Tree Regressor</strong>: a single non-linear tree.</p></li>
<li><p><strong>Random Forest Regressor</strong>: an ensemble of decision trees.</p></li>
<li><p><strong>MLPRegressor (sklearn)</strong>: configured to closely match our PyTorch NN.</p></li>
</ul>
<p>Our PyTorch model is:</p>
<ul class="simple">
<li><p>Input: 4 features</p></li>
<li><p>Hidden layer: 32 units with ReLU</p></li>
<li><p>Output: 1 unit</p></li>
<li><p>Optimizer: Adam with learning rate 1e-2 and weight decay 1e-3</p></li>
<li><p>Trained for 150 epochs with mini-batches of size 64.</p></li>
</ul>
<p>To mirror this in <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code>, we set:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">hidden_layer_sizes=(32,)</span></code>: one hidden layer of 32 units, just like PyTorch.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">activation=&quot;relu&quot;</span></code>: same nonlinearity.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">solver=&quot;adam&quot;</span></code>: same optimization family.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">learning_rate_init=1e-2</span></code>: match the PyTorch learning rate.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alpha=1e-3</span></code>: equivalent to weight decay 1e-3.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_iter=2000</span></code>: roughly comparable to 150 epochs in Torch.</p></li>
</ul>
<p>We then compare all four models (Decision Tree, Random Forest, sklearn MLP, and PyTorch NN)
on the test set using <strong>MSE</strong> and <strong>R²</strong>.</p>
<div class="admonition-exercises-2-x admonition">
<p class="admonition-title">⏰ Exercises 2.x</p>
<ol class="arabic simple">
<li><p>For our own NN by Pytorch change the hidden size to 64 and rerun. Does R² improve.</p></li>
<li><p>Increase <code class="docutils literal notranslate"><span class="pre">weight_decay</span></code> to <code class="docutils literal notranslate"><span class="pre">1e-2</span></code>. What happens to train vs test scores.</p></li>
</ol>
<blockquote>
<div><p>You need to re-initialize the optimizer and re-run the training loop, as there is no <code class="docutils literal notranslate"><span class="pre">.fit(...)</span></code> function for our customized NN. In next section you will see we can wrap this
logic into a helper function to avoid repetition.</p>
</div></blockquote>
</div>
<section id="pytorch-regressor-with-sklearn-like-interface">
<h3>2.8 PyTorch Regressor with sklearn-like Interface<a class="headerlink" href="#pytorch-regressor-with-sklearn-like-interface" title="Permalink to this heading">#</a></h3>
<p>In earlier sections, we trained our custom PyTorch model by manually writing the
training loop. How can we make our customized NN feel more convenient?</p>
<p>We can introduce a small wrapper called <strong><code class="docutils literal notranslate"><span class="pre">CHEM5080Regressor</span></code></strong> that makes our
PyTorch model behave like a sklearn regressor. The class builds a Sequential
network with two hidden layers (64 units with ReLU, then 32 units with Tanh),
and provides:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.fit(X,</span> <span class="pre">y)</span></code> for training</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.predict(X)</span></code> for inference</p></li>
</ul>
<p>This way, the PyTorch model can be plugged into the same workflow as Decision
Tree, Random Forest, or sklearn’s MLP. You can customize the architecture inside
<code class="docutils literal notranslate"><span class="pre">nn.Sequential</span></code> by changing the hidden sizes or swapping the activation
functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">NumpyDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CHEM5080Regressor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple sklearn-like wrapper around a PyTorch feed-forward regressor.</span>
<span class="sd">    Architecture:</span>
<span class="sd">        Input -&gt; Linear(4, 64) -&gt; ReLU</span>
<span class="sd">              -&gt; Linear(64, 32) -&gt; ReLU</span>
<span class="sd">              -&gt; Linear(32, 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_dim</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
        <span class="c1"># Build Sequential model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_dim</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>         <span class="c1"># Hidden layer 1</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>         <span class="c1"># Hidden layer 2</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># Output</span>
        <span class="p">)</span>
        <span class="c1"># Training settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_decay</span> <span class="o">=</span> <span class="n">weight_decay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">weight_decay</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">NumpyDataset</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">X_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">X_tensor</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="c1"># --- Train and evaluate ---</span>
<span class="n">chem_model</span> <span class="o">=</span> <span class="n">CHEM5080Regressor</span><span class="p">(</span><span class="n">in_dim</span><span class="o">=</span><span class="n">X_tr_s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">chem_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr_s</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">chem_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_te_s</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MSE:&quot;</span><span class="p">,</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R2:&quot;</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MSE: 387.48224
R2: 0.8697618698517982
</pre></div>
</div>
</div>
</div>
<p>It works exactly the same way as we see in previous lectures with <code class="docutils literal notranslate"><span class="pre">sklearn</span></code>, but it was <strong>written by ourselves</strong>!</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- Optional: Parity plot ---</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">lims</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">y_te</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_te</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">max</span><span class="p">())]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span> <span class="n">lims</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;True Melting Point&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Predicted Melting Point&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Parity plot - CHEM5080Regressor&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/11c7018f6c00c0750c22bb745b69b5d8878f9741bec87bd6d363a63a4840082d.png" src="_images/11c7018f6c00c0750c22bb745b69b5d8878f9741bec87bd6d363a63a4840082d.png" />
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="molecules-as-graphs">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">3) Molecules as graphs</a><a class="headerlink" href="#molecules-as-graphs" title="Permalink to this heading">#</a></h2>
<p>A molecule can be seen as a graph:</p>
<ul class="simple">
<li><p><strong>Nodes</strong> are atoms with a feature vector per atom.</p></li>
<li><p><strong>Edges</strong> are bonds that carry types such as single, double, aromatic.</p></li>
<li><p>A molecule level label (melting point, toxicity) requires <strong>pooling</strong> node representations into one vector.</p></li>
</ul>
<section id="minimal-node-and-edge-features">
<h3>3.1 Minimal node and edge features<a class="headerlink" href="#minimal-node-and-edge-features" title="Permalink to this heading">#</a></h3>
<p>Common node features:</p>
<ul class="simple">
<li><p>One‑hot element type, degree, formal charge, aromatic flag.<br />
Common edge features:</p></li>
<li><p>Bond type one‑hot: single, double, triple, aromatic.</p></li>
</ul>
<p>We will assemble a small structure that holds:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">x</span></code>: node feature matrix, shape <code class="docutils literal notranslate"><span class="pre">[n_nodes,</span> <span class="pre">d_node]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">edge_index</span></code>: list of edges as two rows <code class="docutils literal notranslate"><span class="pre">[2,</span> <span class="pre">n_edges]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">edge_attr</span></code>: edge features <code class="docutils literal notranslate"><span class="pre">[n_edges,</span> <span class="pre">d_edge]</span></code> (optional)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">y</span></code>: target for the graph</p></li>
</ul>
</section>
<section id="build-tiny-toy-graphs-by-hand">
<h3>3.2 Build tiny toy graphs by hand<a class="headerlink" href="#build-tiny-toy-graphs-by-hand" title="Permalink to this heading">#</a></h3>
<p>We start with two toy molecules without RDKit: Methane and Ethane.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">toy_methane</span><span class="p">():</span>
    <span class="c1"># C with 4 H; simple graph centered on C</span>
    <span class="c1"># nodes: 0=C, 1..4=H</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># very small features: [atomic_number, degree, is_aromatic, formal_charge]</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
        <span class="n">edges</span> <span class="o">+=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="n">edge_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># shape [2, 8]</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;edge_index&quot;</span><span class="p">:</span> <span class="n">edge_index</span><span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">toy_ethane</span><span class="p">():</span>
    <span class="c1"># C-C with 3 H on each carbon</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># two carbons</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># Hs on C0</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># Hs on C1</span>
    <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span> <span class="n">edges</span> <span class="o">+=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="n">h</span><span class="p">),(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">]:</span> <span class="n">edges</span> <span class="o">+=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="n">h</span><span class="p">),(</span><span class="n">h</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">edge_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;edge_index&quot;</span><span class="p">:</span> <span class="n">edge_index</span><span class="p">}</span>

<span class="n">g1</span><span class="p">,</span> <span class="n">g2</span> <span class="o">=</span> <span class="n">toy_methane</span><span class="p">(),</span> <span class="n">toy_ethane</span><span class="p">()</span>
<span class="p">[</span><span class="n">g1</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">g1</span><span class="p">[</span><span class="s2">&quot;edge_index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">g2</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">g2</span><span class="p">[</span><span class="s2">&quot;edge_index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(5, 4), (2, 8), (8, 4), (2, 14)]
</pre></div>
</div>
</div>
</div>
<p>Peek at arrays to make sure the shapes are what you expect.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Methane x:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">g1</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Methane edges (first 6 cols):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">g1</span><span class="p">[</span><span class="s2">&quot;edge_index&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">6</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Methane x:
 [[6. 4. 0. 0.]
 [1. 1. 0. 0.]
 [1. 1. 0. 0.]
 [1. 1. 0. 0.]
 [1. 1. 0. 0.]]
Methane edges (first 6 cols):
 [[0 1 0 2 0 3]
 [1 0 2 0 3 0]]
</pre></div>
</div>
</div>
</div>
<div class="admonition-tip admonition">
<p class="admonition-title">Tip</p>
<p>Large SMILES → RDKit graphs come later. For now the goal is to <strong>see</strong> the shapes and write a message passing layer on these toy graphs.</p>
</div>
<div class="admonition-exercises-3-x admonition">
<p class="admonition-title">⏰ Exercises 3.x</p>
<p>Add a new toy graph for <strong>propane</strong> with indices <code class="docutils literal notranslate"><span class="pre">[0,1,2]</span></code> as the carbon chain and correct hydrogens. Return the same keys <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">edge_index</span></code>. Print its shapes.</p>
</div>
</section>
</section>
<hr class="docutils" />
<section id="message-passing-the-core-idea">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">4) Message passing: the core idea</a><a class="headerlink" href="#message-passing-the-core-idea" title="Permalink to this heading">#</a></h2>
<p>At each layer <code class="docutils literal notranslate"><span class="pre">t</span></code>, every node gets messages from its neighbors and updates its hidden state.</p>
<p>A simple form:</p>
<div class="math notranslate nohighlight">
\[
h_v^{(t+1)} = \sigma\left(W_\text{self}\, h_v^{(t)} + \sum_{u \in \mathcal{N}(v)} W_\text{nei}\, h_u^{(t)} + b\right)
\]</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">h_v^{(t)}</span></code> is the node vector at layer <code class="docutils literal notranslate"><span class="pre">t</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">W_self</span></code> maps the node to itself.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">W_nei</span></code> maps neighbor messages.</p></li>
<li><p>Sum neighbor messages, then apply a nonlinearity <code class="docutils literal notranslate"><span class="pre">σ</span></code> such as ReLU.</p></li>
</ul>
<p>After <code class="docutils literal notranslate"><span class="pre">T</span></code> layers, pool all node vectors to get a graph vector:</p>
<div class="math notranslate nohighlight">
\[
h_\text{graph} = \text{POOL}\left(\{h_v^{(T)} : v \in \text{nodes}\}\right)
\]</div>
<p>POOL can be <strong>sum</strong>, <strong>mean</strong>, or <strong>max</strong>. For regression we feed <code class="docutils literal notranslate"><span class="pre">h_graph</span></code> to a linear head to predict a scalar.</p>
</section>
<hr class="docutils" />
<section id="your-first-gnn-layer-in-pure-pytorch">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">5) Your first GNN layer in pure PyTorch</a><a class="headerlink" href="#your-first-gnn-layer-in-pure-pytorch" title="Permalink to this heading">#</a></h2>
<p>We implement a very small GNN layer that follows the equation above. No external graph library is needed.</p>
<section id="a-neighbor-sum-helper">
<h3>5.1 A neighbor sum helper<a class="headerlink" href="#a-neighbor-sum-helper" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">neighbor_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    x: [N, d] node features</span>
<span class="sd">    edge_index: [2, E] with rows [src, dst]</span>
<span class="sd">    returns: [N, d] sum of neighbor features for each node (incoming edges)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">edge_index</span>
    <span class="n">out</span><span class="o">.</span><span class="n">index_add_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">src</span><span class="p">])</span>  <span class="c1"># sum x[src] into row dst</span>
    <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="define-one-message-passing-layer">
<h3>5.2 Define one message passing layer<a class="headerlink" href="#define-one-message-passing-layer" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleMP</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_lin</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nei_lin</span>  <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">act</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">):</span>
        <span class="c1"># x: [N, in_dim], edge_index: tensor [2, E]</span>
        <span class="n">nei_agg</span> <span class="o">=</span> <span class="n">neighbor_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">)</span>           <span class="c1"># [N, in_dim]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_lin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nei_lin</span><span class="p">(</span><span class="n">nei_agg</span><span class="p">)</span>  <span class="c1"># [N, out_dim]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="stack-layers-and-pool-to-a-graph-vector">
<h3>5.3 Stack layers and pool to a graph vector<a class="headerlink" href="#stack-layers-and-pool-to-a-graph-vector" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TinyGNN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_dim</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="n">in_dim</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">):</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SimpleMP</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">hidden</span><span class="p">))</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">hidden</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">readout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>  <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>  <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># default mean</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">mp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">mp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">)</span>
        <span class="n">hg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>         <span class="c1"># [1, hidden]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span>            <span class="c1"># [1, out_dim]</span>
        <span class="k">return</span> <span class="n">y</span>  <span class="c1"># graph-level output</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="sanity-check-with-toy-graphs">
<h3>5.4 Sanity check with toy graphs<a class="headerlink" href="#sanity-check-with-toy-graphs" title="Permalink to this heading">#</a></h3>
<p>We will make up fake targets for the toys to see the forward pass shape.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">to_tensor_graph</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
    <span class="n">edge_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;edge_index&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span>

<span class="n">x1</span><span class="p">,</span> <span class="n">e1</span> <span class="o">=</span> <span class="n">to_tensor_graph</span><span class="p">(</span><span class="n">g1</span><span class="p">)</span>
<span class="n">x2</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">to_tensor_graph</span><span class="p">(</span><span class="n">g2</span><span class="p">)</span>

<span class="n">gnn</span> <span class="o">=</span> <span class="n">TinyGNN</span><span class="p">(</span><span class="n">in_dim</span><span class="o">=</span><span class="n">x1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">out_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">gnn</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">e1</span><span class="p">)</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">gnn</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">e2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Toy outputs:&quot;</span><span class="p">,</span> <span class="n">y1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Toy outputs: torch.Size([1, 1]) torch.Size([1, 1])
</pre></div>
</div>
</div>
</div>
</section>
<section id="train-on-toy-data-regression-on-a-madeup-scalar">
<h3>5.5 Train on toy data (regression on a made‑up scalar)<a class="headerlink" href="#train-on-toy-data-regression-on-a-madeup-scalar" title="Permalink to this heading">#</a></h3>
<p>Let us define a toy label such as “number of heavy atoms”. This is only for demonstration.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">heavy_atom_count</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
    <span class="c1"># heavy atoms = atomic_number &gt; 1</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">((</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

<span class="n">train_graphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">toy_methane</span><span class="p">(),</span> <span class="n">toy_ethane</span><span class="p">()]</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="n">heavy_atom_count</span><span class="p">(</span><span class="n">g</span><span class="p">)]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">train_graphs</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">gnn</span> <span class="o">=</span> <span class="n">TinyGNN</span><span class="p">(</span><span class="n">in_dim</span><span class="o">=</span><span class="n">train_graphs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">out_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">gnn</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">5e-3</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>

<span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">epoch_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">ytrue</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">train_graphs</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">ei</span> <span class="o">=</span> <span class="n">to_tensor_graph</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">gnn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ei</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">ytrue</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">();</span> <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">();</span> <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">epoch_loss</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_loss</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">train_graphs</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">losses</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;MSE&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Toy GNN regression loss&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">train_graphs</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">gnn</span><span class="p">(</span><span class="o">*</span><span class="n">to_tensor_graph</span><span class="p">(</span><span class="n">g</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pred&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">heavy_atom_count</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4b5112c41ac42237167d40b59a8e4aea29ea0a84a68a4b71ab54028c32c6c2aa.png" src="_images/4b5112c41ac42237167d40b59a8e4aea29ea0a84a68a4b71ab54028c32c6c2aa.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>pred 1.0 target 1.0
pred 2.0 target 2.0
</pre></div>
</div>
</div>
</div>
<div class="admonition-what-you-saw admonition">
<p class="admonition-title">What you saw</p>
<ul class="simple">
<li><p>Node vectors flowed through two message passing layers.</p></li>
<li><p>A readout pooled node states to a graph vector.</p></li>
<li><p>A tiny head predicted a scalar.</p></li>
</ul>
</div>
<div class="admonition-exercises-5-x admonition">
<p class="admonition-title">⏰ Exercises 5.x</p>
<ol class="arabic simple">
<li><p>Switch pooling from <code class="docutils literal notranslate"><span class="pre">&quot;sum&quot;</span></code> to <code class="docutils literal notranslate"><span class="pre">&quot;mean&quot;</span></code> and retrain. Compare convergence.</p></li>
<li><p>Replace <code class="docutils literal notranslate"><span class="pre">ReLU</span></code> with <code class="docutils literal notranslate"><span class="pre">Tanh</span></code> inside <code class="docutils literal notranslate"><span class="pre">SimpleMP</span></code>. Does the curve change.</p></li>
<li><p>Change the target to “number of hydrogens” and retrain.</p></li>
</ol>
</div>
</section>
</section>
<hr class="docutils" />
<section id="from-smiles-to-graphs-with-rdkit-mini-pipeline">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">6) From SMILES to graphs with RDKit (mini pipeline)</a><a class="headerlink" href="#from-smiles-to-graphs-with-rdkit-mini-pipeline" title="Permalink to this heading">#</a></h2>
<p>Now we prepare graphs from real SMILES. If RDKit is not available in your environment, skip to Section 7 (Chemprop), which does not require RDKit.</p>
<section id="featurization-helpers">
<h3>6.1 Featurization helpers<a class="headerlink" href="#featurization-helpers" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">atom_features</span><span class="p">(</span><span class="n">atom</span><span class="p">):</span>
    <span class="c1"># one short vector per atom; keep it tiny for speed</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">(),</span>                 <span class="c1"># Z</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">GetTotalDegree</span><span class="p">(),</span>               <span class="c1"># degree</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">GetIsAromatic</span><span class="p">()),</span>           <span class="c1"># aromatic</span>
        <span class="n">atom</span><span class="o">.</span><span class="n">GetFormalCharge</span><span class="p">()</span>               <span class="c1"># charge</span>
    <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">bond_pairs</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
    <span class="n">src</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetBonds</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">GetBeginAtomIdx</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">GetEndAtomIdx</span><span class="p">()</span>
        <span class="n">src</span> <span class="o">+=</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
        <span class="n">dst</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">smiles_to_graph</span><span class="p">(</span><span class="n">smi</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">Chem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;RDKit not available. Please skip to Section 7 (Chemprop).&quot;</span><span class="p">)</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">atom_features</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()])</span>  <span class="c1"># [N,d]</span>
    <span class="n">ei</span> <span class="o">=</span> <span class="n">bond_pairs</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>                                       <span class="c1"># [2,E]</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;edge_index&quot;</span><span class="p">:</span> <span class="n">ei</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="make-a-small-dataset-from-the-csv">
<h3>6.2 Make a small dataset from the CSV<a class="headerlink" href="#make-a-small-dataset-from-the-csv" title="Permalink to this heading">#</a></h3>
<p>We will try to regress <strong>melting point</strong> as a quick demo with the tiny GNN. This is only to show the flow; Chemprop will do a stronger job later.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">Chem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">small</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span><span class="s2">&quot;Melting Point&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">graphs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">smi</span><span class="p">,</span> <span class="n">mp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">small</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">],</span> <span class="n">small</span><span class="p">[</span><span class="s2">&quot;Melting Point&quot;</span><span class="p">]):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">smiles_to_graph</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">graphs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">);</span> <span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
    <span class="n">y_all</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">graphs</span><span class="p">),</span> <span class="n">y_all</span><span class="o">.</span><span class="n">shape</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RDKit missing. Skip to Section 7.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">22</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">if</span> <span class="n">Chem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">----&gt; </span><span class="mi">2</span>     <span class="n">small</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span><span class="s2">&quot;Melting Point&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">graphs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="k">for</span> <span class="n">smi</span><span class="p">,</span> <span class="n">mp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">small</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">],</span> <span class="n">small</span><span class="p">[</span><span class="s2">&quot;Melting Point&quot;</span><span class="p">]):</span>

<span class="ne">NameError</span>: name &#39;df_raw&#39; is not defined
</pre></div>
</div>
</div>
</div>
</section>
<section id="tiny-training-loop-for-graphs">
<h3>6.3 Tiny training loop for graphs<a class="headerlink" href="#tiny-training-loop-for-graphs" title="Permalink to this heading">#</a></h3>
<p>We split by index since graphs are already constructed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">Chem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">graphs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">graphs</span><span class="p">))</span>
    <span class="n">tr_idx</span><span class="p">,</span> <span class="n">te_idx</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">gnn</span> <span class="o">=</span> <span class="n">TinyGNN</span><span class="p">(</span><span class="n">in_dim</span><span class="o">=</span><span class="n">graphs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">out_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">gnn</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
    <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>

    <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">):</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">tr_idx</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr_idx</span><span class="p">)),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">epoch_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">graphs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
            <span class="n">ei</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">graphs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;edge_index&quot;</span><span class="p">])</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">gnn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ei</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">y_all</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">();</span> <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">();</span> <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">epoch_loss</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_loss</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">losses</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;MSE&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Tiny GNN on melting point&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Evaluate</span>
    <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">gnn</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">te_idx</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">gnn</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">graphs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;x&quot;</span><span class="p">]),</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">graphs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;edge_index&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">y_true</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">y_all</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">y_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MSE: </span><span class="si">{</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAE: </span><span class="si">{</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R2 : </span><span class="si">{</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="n">lims</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">y_true</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">y_true</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_pred</span><span class="p">))]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span> <span class="n">lims</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;True MP&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Pred MP&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Tiny GNN parity&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition-takeaway admonition">
<p class="admonition-title">Takeaway</p>
<p>This simple GNN is <strong>minimal</strong>. Real molecular GNNs use richer atom and bond features, multiple heads, dropout, and careful training schedules.</p>
</div>
<div class="admonition-exercises-6-x admonition">
<p class="admonition-title">⏰ Exercises 6.x</p>
<ol class="arabic simple">
<li><p>Change <code class="docutils literal notranslate"><span class="pre">num_layers</span></code> from 3 to 2 and 4. Record test R² for each.</p></li>
<li><p>Change pooling from mean to sum. Does performance change.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">nn.Dropout(p=0.1)</span></code> after each <code class="docutils literal notranslate"><span class="pre">SimpleMP</span></code> in <code class="docutils literal notranslate"><span class="pre">TinyGNN</span></code> and test again.</p></li>
</ol>
</div>
</section>
</section>
<hr class="docutils" />
<section id="chemprop-v2-practical-graph-models-for-chemistry">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">7) Chemprop v2: practical graph models for chemistry</a><a class="headerlink" href="#chemprop-v2-practical-graph-models-for-chemistry" title="Permalink to this heading">#</a></h2>
<p>Chemprop implements a directed message passing neural network with strong defaults. We will:</p>
<ol class="arabic simple">
<li><p><strong>Install Chemprop v2</strong></p></li>
<li><p>Run a <strong>melting point</strong> regression</p></li>
<li><p>Run a <strong>reactivity</strong> classification and predict on new SMILES</p></li>
</ol>
<section id="install-chemprop">
<h3>7.1 Install Chemprop<a class="headerlink" href="#install-chemprop" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># You may need a restart after install in some environments</span>
<span class="o">%</span><span class="k">pip</span> -q install chemprop
</pre></div>
</div>
</div>
</div>
</section>
<section id="melting-point-regression">
<h3>7.2 Melting point regression<a class="headerlink" href="#melting-point-regression" title="Permalink to this heading">#</a></h3>
<p>Prepare a minimal CSV: <code class="docutils literal notranslate"><span class="pre">SMILES,Melting</span> <span class="pre">Point</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load data and write a small CSV</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/zzhenglab/ai4chem/main/book/_data/C_H_oxidation_dataset.csv&quot;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">reg_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span> <span class="s2">&quot;Melting Point&quot;</span><span class="p">]</span>
<span class="n">df_reg</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">reg_cols</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_reg</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Save to disk for Chemprop CLI.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_reg</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;mp_data.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">df_reg</span><span class="p">),</span> <span class="n">df_reg</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Train a <strong>small</strong> model so it runs in class. We log common metrics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># A short run. Increase epochs later if you have time/GPU.
!chemprop train \
  --data-path mp_data.csv \
  -t regression \
  -s SMILES \
  --target-columns &quot;Melting Point&quot; \
  -o mp_model \
  --num-replicates 1 \
  --epochs 15 \
  --save-smiles-splits \
  --metrics mae rmse r2 \
  --tracking-metric r2
</pre></div>
</div>
</div>
</div>
<p>Make quick predictions on a few molecules.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>smiles_list = [
    &quot;CCO&quot;,              # ethanol
    &quot;c1ccccc1&quot;,         # benzene
    &quot;CC(=O)O&quot;,          # acetic acid
    &quot;CCN(CC)CC&quot;         # triethylamine
]
pd.DataFrame({&quot;SMILES&quot;: smiles_list}).to_csv(&quot;custom_smiles_reg.csv&quot;, index=False)

!chemprop predict \
  --test-path custom_smiles_reg.csv \
  --model-paths mp_model/replicate_0/model_0/best.pt \
  --preds-path mp_preds.csv

pd.read_csv(&quot;mp_preds.csv&quot;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="reactivity-classification-ch-oxidation-dataset">
<h3>7.3 Reactivity classification (C–H oxidation dataset)<a class="headerlink" href="#reactivity-classification-ch-oxidation-dataset" title="Permalink to this heading">#</a></h3>
<p>We use the <code class="docutils literal notranslate"><span class="pre">Reactivity</span></code> column and convert it to <strong>binary</strong> 0/1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Reactivity_bin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Reactivity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span><span class="s2">&quot;Reactivity&quot;</span><span class="p">,</span><span class="s2">&quot;Reactivity_bin&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Write a minimal file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span> <span class="s2">&quot;Reactivity_bin&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;reactivity_data_bin.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Optional: sanity check the class balance</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Reactivity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Reactivity_bin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>Train a short classification model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!chemprop train \
  --data-path reactivity_data_bin.csv \
  -t classification \
  -s SMILES \
  --target-columns Reactivity_bin \
  -o reactivity_model \
  --num-replicates 1 \
  --epochs 15 \
  --class-balance \
  --metrics roc prc accuracy \
  --tracking-metric roc
</pre></div>
</div>
</div>
</div>
<p>Predict on new SMILES.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>smiles_list = [
    &quot;CCO&quot;,
    &quot;c1ccccc1C(F)&quot;,
    &quot;C1=C([C@@H]2C[C@H](C1)C2(C)C)&quot;,
    &quot;C1=CC=CC=C1C=O&quot;,
    &quot;CCN(CC)CC&quot;,
    &quot;c1cccc(C=CC)c1&quot;
]
pd.DataFrame({&quot;SMILES&quot;: smiles_list}).to_csv(&quot;custom_smiles.csv&quot;, index=False)

!chemprop predict \
  --test-path custom_smiles.csv \
  --model-paths reactivity_model/replicate_0/model_0/best.pt \
  --preds-path custom_preds.csv

pd.read_csv(&quot;custom_preds.csv&quot;)
</pre></div>
</div>
</div>
</div>
<div class="admonition-tips admonition">
<p class="admonition-title">Tips</p>
<ul class="simple">
<li><p>Increase <code class="docutils literal notranslate"><span class="pre">--num-replicates</span></code> to 3 and <code class="docutils literal notranslate"><span class="pre">--epochs</span></code> to 50-100 for stronger baselines.</p></li>
<li><p>For class imbalance, keep <code class="docutils literal notranslate"><span class="pre">--class-balance</span></code>.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">--save-smiles-splits</span></code> to capture exact train/val/test molecules for reproducibility.</p></li>
</ul>
</div>
<div class="admonition-exercises-7-x admonition">
<p class="admonition-title">⏰ Exercises 7.x</p>
<ol class="arabic simple">
<li><p>Add <code class="docutils literal notranslate"><span class="pre">--ensemble-size</span> <span class="pre">5</span></code> during prediction by passing multiple <code class="docutils literal notranslate"><span class="pre">--model-paths</span></code> if you trained replicates. Compare ROC.</p></li>
<li><p>Change tracking metric to <code class="docutils literal notranslate"><span class="pre">prc</span></code> and rerun. Does validation selection change.</p></li>
<li><p>For melting point, add <code class="docutils literal notranslate"><span class="pre">--ffn-hidden-size</span> <span class="pre">800</span></code> to increase the head capacity and try 30 epochs.</p></li>
</ol>
</div>
</section>
</section>
<hr class="docutils" />
<section id="references">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">8) References</a><a class="headerlink" href="#references" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Gilmer, J. et al., <strong>Neural Message Passing for Quantum Chemistry</strong>, ICML 2017.</p></li>
<li><p>Yang, K. et al., <strong>Analyzing Learned Molecular Representations for Property Prediction</strong>, J. Chem. Inf. Model. 2019.</p></li>
<li><p>Chemprop documentation: training flags, metrics, and examples.</p></li>
<li><p>RDKit: molecule objects, atom and bond APIs.</p></li>
<li><p>PyTorch: custom <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code>, autograd, and optimizers.</p></li>
</ul>
<p><em>(If you need links, see your course page where these are listed with URLs.)</em></p>
</section>
<hr class="docutils" />
<section id="glossary">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">9) Glossary</a><a class="headerlink" href="#glossary" title="Permalink to this heading">#</a></h2>
<dl class="simple glossary">
<dt id="term-graph-neural-network">graph neural network<a class="headerlink" href="#term-graph-neural-network" title="Permalink to this term">#</a></dt><dd><p>A neural model that updates node states by aggregating messages from neighbors.</p>
</dd>
<dt id="term-message-passing">message passing<a class="headerlink" href="#term-message-passing" title="Permalink to this term">#</a></dt><dd><p>The update step where a node combines its own vector with aggregated neighbor vectors.</p>
</dd>
<dt id="term-readout-pooling">readout (pooling)<a class="headerlink" href="#term-readout-pooling" title="Permalink to this term">#</a></dt><dd><p>Operation that compresses node states into a single graph vector, often by sum, mean, or max.</p>
</dd>
<dt id="term-edge-index">edge index<a class="headerlink" href="#term-edge-index" title="Permalink to this term">#</a></dt><dd><p>A 2×E tensor listing source and destination of each edge.</p>
</dd>
<dt id="term-Chemprop">Chemprop<a class="headerlink" href="#term-Chemprop" title="Permalink to this term">#</a></dt><dd><p>A practical library that trains message passing networks directly from SMILES.</p>
</dd>
<dt id="term-replicate">replicate<a class="headerlink" href="#term-replicate" title="Permalink to this term">#</a></dt><dd><p>Independent training run with a different random seed. Often ensembled for stability.</p>
</dd>
<dt id="term-tracking-metric">tracking metric<a class="headerlink" href="#term-tracking-metric" title="Permalink to this term">#</a></dt><dd><p>The metric used to pick the best checkpoint during training.</p>
</dd>
<dt id="term-class-balance">class balance<a class="headerlink" href="#term-class-balance" title="Permalink to this term">#</a></dt><dd><p>Loss weighting that compensates for skewed class proportions.</p>
</dd>
</dl>
</section>
<hr class="docutils" />
<section id="inclass-activity-and-solutions">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">10) In‑class activity and solutions</a><a class="headerlink" href="#inclass-activity-and-solutions" title="Permalink to this heading">#</a></h2>
<p>Each question is designed to be solved with what you coded above. Try first, then check the solution blocks.</p>
<section id="q1-mlp-warmup-on-melting-point">
<h3>Q1. MLP warmup on melting point<a class="headerlink" href="#q1-mlp-warmup-on-melting-point" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Use features <code class="docutils literal notranslate"><span class="pre">[MolWt,</span> <span class="pre">LogP,</span> <span class="pre">TPSA,</span> <span class="pre">NumRings]</span></code></p></li>
<li><p>Standardize, then train the PyTorch MLP <code class="docutils literal notranslate"><span class="pre">(32,)</span></code> for 150 epochs</p></li>
<li><p>Report <code class="docutils literal notranslate"><span class="pre">MSE</span></code>, <code class="docutils literal notranslate"><span class="pre">MAE</span></code>, <code class="docutils literal notranslate"><span class="pre">R²</span></code> and draw a parity plot</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># TO DO: write your MLP training in PyTorch as in Section 2</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="q2-build-and-inspect-the-toy-gnn">
<h3>Q2. Build and inspect the toy GNN<a class="headerlink" href="#q2-build-and-inspect-the-toy-gnn" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Train <code class="docutils literal notranslate"><span class="pre">TinyGNN</span></code> with pooling <code class="docutils literal notranslate"><span class="pre">&quot;sum&quot;</span></code> on methane and ethane to predict <strong>heavy atom count</strong></p></li>
<li><p>Plot the loss</p></li>
<li><p>Change pooling to <code class="docutils literal notranslate"><span class="pre">&quot;mean&quot;</span></code> and compare loss and predictions</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># TO DO: reuse the code in Section 5</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="q3-rdkit-graph-miniset-optional-if-rdkit-missing">
<h3>Q3. RDKit graph mini‑set (optional if RDKit missing)<a class="headerlink" href="#q3-rdkit-graph-miniset-optional-if-rdkit-missing" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Sample 200 SMILES with melting points from the CSV</p></li>
<li><p>Convert to graphs and train <code class="docutils literal notranslate"><span class="pre">TinyGNN</span></code> with <code class="docutils literal notranslate"><span class="pre">num_layers=3</span></code>, hidden 32</p></li>
<li><p>Report <code class="docutils literal notranslate"><span class="pre">R²</span></code> on a 80/20 split and draw a parity plot</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># TO DO: follow Section 6</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="q4-chemprop-regression-on-melting-point">
<h3>Q4. Chemprop regression on melting point<a class="headerlink" href="#q4-chemprop-regression-on-melting-point" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Train Chemprop on <code class="docutils literal notranslate"><span class="pre">mp_data.csv</span></code> for <code class="docutils literal notranslate"><span class="pre">--epochs</span> <span class="pre">20</span></code></p></li>
<li><p>Predict on at least 5 new SMILES of your choice and list the predictions</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># TO DO: run the chemprop CLI as in Section 7.2</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="q5-chemprop-classification-on-toxicity">
<h3>Q5. Chemprop classification on toxicity<a class="headerlink" href="#q5-chemprop-classification-on-toxicity" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Convert <code class="docutils literal notranslate"><span class="pre">Toxicity</span></code> to <code class="docutils literal notranslate"><span class="pre">1/0</span></code> using the mapping <code class="docutils literal notranslate"><span class="pre">{toxic:1,</span> <span class="pre">non_toxic:0}</span></code></p></li>
<li><p>Save <code class="docutils literal notranslate"><span class="pre">[&quot;SMILES&quot;,&quot;Toxicity_bin&quot;]</span></code> to <code class="docutils literal notranslate"><span class="pre">tox_data.csv</span></code></p></li>
<li><p>Train with <code class="docutils literal notranslate"><span class="pre">--class-balance</span> <span class="pre">--epochs</span> <span class="pre">20</span></code> and metrics <code class="docutils literal notranslate"><span class="pre">roc</span> <span class="pre">prc</span> <span class="pre">accuracy</span></code></p></li>
<li><p>Predict on a small set of SMILES; show the class probability</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># TO DO: similar to Section 7.3, but target is Toxicity_bin</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="solutions">
<h3>Solutions<a class="headerlink" href="#solutions" title="Permalink to this heading">#</a></h3>
<section id="solution-q1">
<h4>Solution Q1<a class="headerlink" href="#solution-q1" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Q1 solution</span>
<span class="n">set_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df_reg</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span> <span class="s2">&quot;LogP&quot;</span><span class="p">,</span> <span class="s2">&quot;TPSA&quot;</span><span class="p">,</span> <span class="s2">&quot;NumRings&quot;</span><span class="p">,</span> <span class="s2">&quot;Melting Point&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df_reg</span><span class="p">[[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span><span class="s2">&quot;LogP&quot;</span><span class="p">,</span><span class="s2">&quot;TPSA&quot;</span><span class="p">,</span><span class="s2">&quot;NumRings&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df_reg</span><span class="p">[</span><span class="s2">&quot;Melting Point&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Xtr</span><span class="p">,</span> <span class="n">Xte</span><span class="p">,</span> <span class="n">ytr</span><span class="p">,</span> <span class="n">yte</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xtr</span><span class="p">)</span>
<span class="n">Xtr_s</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Xtr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">Xte_s</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Xte</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">mlp</span> <span class="o">=</span> <span class="n">TinyMLP</span><span class="p">(</span><span class="n">in_dim</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">out_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">mlp</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">NumpyDataset</span><span class="p">(</span><span class="n">Xtr_s</span><span class="p">,</span> <span class="n">ytr</span><span class="p">),</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">150</span><span class="p">):</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">mlp</span><span class="p">(</span><span class="n">xb</span><span class="p">);</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">();</span> <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">();</span> <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">bs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bs</span><span class="p">))</span>

<span class="n">mlp</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">yhat</span> <span class="o">=</span> <span class="n">mlp</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">Xte_s</span><span class="p">))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MSE=</span><span class="si">{</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">yte</span><span class="p">,</span><span class="w"> </span><span class="n">yhat</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">  MAE=</span><span class="si">{</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">yte</span><span class="p">,</span><span class="w"> </span><span class="n">yhat</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">  R2=</span><span class="si">{</span><span class="n">r2_score</span><span class="p">(</span><span class="n">yte</span><span class="p">,</span><span class="w"> </span><span class="n">yhat</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">losses</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;MSE&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Q1 MLP loss&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">yte</span><span class="p">,</span> <span class="n">yhat</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">lims</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">yte</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">yhat</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">max</span><span class="p">(</span><span class="n">yte</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">yhat</span><span class="o">.</span><span class="n">max</span><span class="p">())]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span> <span class="n">lims</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;True MP&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Pred MP&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Q1 parity&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="solution-q2">
<h4>Solution Q2<a class="headerlink" href="#solution-q2" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Q2 solution</span>
<span class="n">train_graphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">toy_methane</span><span class="p">(),</span> <span class="n">toy_ethane</span><span class="p">()]</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="n">heavy_atom_count</span><span class="p">(</span><span class="n">g</span><span class="p">)]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">train_graphs</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="n">pool</span><span class="p">):</span>
    <span class="n">gnn</span> <span class="o">=</span> <span class="n">TinyGNN</span><span class="p">(</span><span class="n">in_dim</span><span class="o">=</span><span class="n">train_graphs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">out_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">gnn</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">5e-3</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
    <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">ytrue</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">train_graphs</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]);</span> <span class="n">ei</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;edge_index&quot;</span><span class="p">])</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">gnn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ei</span><span class="p">);</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">ytrue</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">();</span> <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">();</span> <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">();</span> <span class="n">s</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">train_graphs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gnn</span><span class="p">,</span> <span class="n">losses</span>

<span class="n">g_sum</span><span class="p">,</span> <span class="n">L_sum</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span>
<span class="n">g_mean</span><span class="p">,</span> <span class="n">L_mean</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">L_sum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">L_mean</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;MSE&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Q2 loss&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">gnn</span> <span class="ow">in</span> <span class="p">[(</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">g_sum</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="n">g_mean</span><span class="p">)]:</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">train_graphs</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">gnn</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]),</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;edge_index&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="s2">&quot;pred&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">heavy_atom_count</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="solution-q3">
<h4>Solution Q3<a class="headerlink" href="#solution-q3" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Q3 solution (skip if RDKit missing)</span>
<span class="k">if</span> <span class="n">Chem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">small</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span><span class="s2">&quot;Melting Point&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">graphs</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">smi</span><span class="p">,</span> <span class="n">mp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">small</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">],</span> <span class="n">small</span><span class="p">[</span><span class="s2">&quot;Melting Point&quot;</span><span class="p">]):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">smiles_to_graph</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">graphs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">);</span> <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">graphs</span><span class="p">))</span>
    <span class="n">tr</span><span class="p">,</span> <span class="n">te</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">gnn</span> <span class="o">=</span> <span class="n">TinyGNN</span><span class="p">(</span><span class="n">in_dim</span><span class="o">=</span><span class="n">graphs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hidden</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">out_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">gnn</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
    <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">):</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr</span><span class="p">)),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">graphs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
            <span class="n">ei</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">graphs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;edge_index&quot;</span><span class="p">])</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">gnn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ei</span><span class="p">);</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">();</span> <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="n">yt</span><span class="p">,</span> <span class="n">yp</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">gnn</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">te</span><span class="p">:</span>
            <span class="n">yp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gnn</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">graphs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;x&quot;</span><span class="p">]),</span>
                          <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">graphs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;edge_index&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="n">yt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">r2_score</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R2: </span><span class="si">{</span><span class="n">r2_score</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="w"> </span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">  MAE: </span><span class="si">{</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">yt</span><span class="p">,</span><span class="w"> </span><span class="n">yp</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RDKit missing; skip Q3.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="solution-q4">
<h4>Solution Q4<a class="headerlink" href="#solution-q4" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Q4 solution
df_reg = df[[&quot;SMILES&quot;,&quot;Melting Point&quot;]].dropna().copy()
df_reg.to_csv(&quot;mp_data.csv&quot;, index=False)

!chemprop train \
  --data-path mp_data.csv \
  -t regression \
  -s SMILES \
  --target-columns &quot;Melting Point&quot; \
  -o mp_model_q4 \
  --num-replicates 1 \
  --epochs 20 \
  --metrics mae rmse r2 \
  --tracking-metric r2

pd.DataFrame({&quot;SMILES&quot;: [&quot;CCO&quot;,&quot;c1ccccc1&quot;,&quot;CC(=O)O&quot;,&quot;CCN(CC)CC&quot;,&quot;O=C(O)C(O)C&quot;]}).to_csv(&quot;q4_smiles.csv&quot;, index=False)

!chemprop predict \
  --test-path q4_smiles.csv \
  --model-paths mp_model_q4/replicate_0/model_0/best.pt \
  --preds-path q4_preds.csv

pd.read_csv(&quot;q4_preds.csv&quot;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="solution-q5">
<h4>Solution Q5<a class="headerlink" href="#solution-q5" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Q5 solution
df = pd.read_csv(url)
df = df[[&quot;SMILES&quot;,&quot;Toxicity&quot;]].dropna().copy()
df[&quot;Toxicity_bin&quot;] = df[&quot;Toxicity&quot;].str.lower().map({&quot;toxic&quot;:1, &quot;non_toxic&quot;:0}).astype(int)
df[[&quot;SMILES&quot;,&quot;Toxicity_bin&quot;]].to_csv(&quot;tox_data.csv&quot;, index=False)

!chemprop train \
  --data-path tox_data.csv \
  -t classification \
  -s SMILES \
  --target-columns Toxicity_bin \
  -o tox_model \
  --num-replicates 1 \
  --epochs 20 \
  --class-balance \
  --metrics roc prc accuracy \
  --tracking-metric roc

pd.DataFrame({&quot;SMILES&quot;: [&quot;CCO&quot;,&quot;c1ccccc1&quot;,&quot;O=[N+](=O)[O-]&quot;,&quot;ClCCl&quot;,&quot;CC(=O)Cl&quot;]}).to_csv(&quot;q5_smiles.csv&quot;, index=False)

!chemprop predict \
  --test-path q5_smiles.csv \
  --model-paths tox_model/replicate_0/model_0/best.pt \
  --preds-path q5_preds.csv

pd.read_csv(&quot;q5_preds.csv&quot;)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="quick-cheat-sheet">
<h3>Quick cheat sheet<a class="headerlink" href="#quick-cheat-sheet" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Message passing layer shape checks help catch indexing mistakes early.</p></li>
<li><p>Pooling choice can change gradients a lot on small graphs.</p></li>
<li><p>Chemprop is fast to try. Start with 15–30 epochs and 1–3 replicates during class. Increase later.</p></li>
<li><p>For classification targets, always look at <code class="docutils literal notranslate"><span class="pre">roc</span></code> and <code class="docutils literal notranslate"><span class="pre">prc</span></code>, not only accuracy.</p></li>
</ul>
<hr class="docutils" />
<div class="admonition-what-to-remember admonition">
<p class="admonition-title">What to remember</p>
<ul class="simple">
<li><p>An MLP ignores graph structure. A GNN uses edges to mix neighbor information.</p></li>
<li><p>The core update is neighbor aggregation followed by a learnable transformation.</p></li>
<li><p>Chemprop encodes many best practices so you can focus on data and targets.</p></li>
</ul>
</div>
<div class="admonition-where-this-connects admonition">
<p class="admonition-title">Where this connects</p>
<p>Back to Lecture 8: you built MLPs and read loss curves. The same training loop ideas apply to GNNs. The difference is the <strong>forward</strong> pass uses a graph structure to route information.</p>
</div>
<div class="admonition-try-at-home admonition">
<p class="admonition-title">Try at home</p>
<ul class="simple">
<li><p>Compare <code class="docutils literal notranslate"><span class="pre">sum</span></code> vs <code class="docutils literal notranslate"><span class="pre">mean</span></code> pooling on size‑varying molecules.</p></li>
<li><p>Add bond type one‑hot to the neighbor message with a small MLP inside <code class="docutils literal notranslate"><span class="pre">SimpleMP</span></code>.</p></li>
<li><p>Use Chemprop for <strong>logS</strong> regression and compare to your MLP from Lecture 8.</p></li>
</ul>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">1. Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-mlp-from-scratch">2 Building MLP from scratch</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pytorch-regression-on-melting-point">2.1 PyTorch regression on melting point</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#build-a-tiny-network">2.2 Build a tiny network</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loss-and-optimizer">2.3 Loss and optimizer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#one-training-step-demo">2.4 One training step demo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#training-loop">2.5 Training loop</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-regression">2.6 Evaluate regression</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#baseline-comparison">2.7 Baseline comparison</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pytorch-regressor-with-sklearn-like-interface">2.8 PyTorch Regressor with sklearn-like Interface</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#molecules-as-graphs">3) Molecules as graphs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#minimal-node-and-edge-features">3.1 Minimal node and edge features</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#build-tiny-toy-graphs-by-hand">3.2 Build tiny toy graphs by hand</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#message-passing-the-core-idea">4) Message passing: the core idea</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#your-first-gnn-layer-in-pure-pytorch">5) Your first GNN layer in pure PyTorch</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-neighbor-sum-helper">5.1 A neighbor sum helper</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-one-message-passing-layer">5.2 Define one message passing layer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stack-layers-and-pool-to-a-graph-vector">5.3 Stack layers and pool to a graph vector</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sanity-check-with-toy-graphs">5.4 Sanity check with toy graphs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#train-on-toy-data-regression-on-a-madeup-scalar">5.5 Train on toy data (regression on a made‑up scalar)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#from-smiles-to-graphs-with-rdkit-mini-pipeline">6) From SMILES to graphs with RDKit (mini pipeline)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#featurization-helpers">6.1 Featurization helpers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-a-small-dataset-from-the-csv">6.2 Make a small dataset from the CSV</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tiny-training-loop-for-graphs">6.3 Tiny training loop for graphs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#chemprop-v2-practical-graph-models-for-chemistry">7) Chemprop v2: practical graph models for chemistry</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#install-chemprop">7.1 Install Chemprop</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#melting-point-regression">7.2 Melting point regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reactivity-classification-ch-oxidation-dataset">7.3 Reactivity classification (C–H oxidation dataset)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">8) References</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">9) Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inclass-activity-and-solutions">10) In‑class activity and solutions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q1-mlp-warmup-on-melting-point">Q1. MLP warmup on melting point</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q2-build-and-inspect-the-toy-gnn">Q2. Build and inspect the toy GNN</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q3-rdkit-graph-miniset-optional-if-rdkit-missing">Q3. RDKit graph mini‑set (optional if RDKit missing)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q4-chemprop-regression-on-melting-point">Q4. Chemprop regression on melting point</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q5-chemprop-classification-on-toxicity">Q5. Chemprop classification on toxicity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solutions">Solutions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-q1">Solution Q1</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-q2">Solution Q2</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-q3">Solution Q3</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-q4">Solution Q4</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-q5">Solution Q5</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-cheat-sheet">Quick cheat sheet</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>