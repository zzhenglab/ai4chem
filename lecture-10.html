
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lecture 10 - Property &amp; Reaction Prediction &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lecture-10';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Lecture 11 - Dimension Reduction for Data Visualization" href="lecture-11.html" />
    <link rel="prev" title="Lecture 9 - Graph Neural Networks" href="lecture-09.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to CHEM 5080: AI for Experimental Chemistry
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="lecture-01.html">Lecture 1 - Python Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-02.html">Lecture 2 - Pandas and Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-03.html">Lecture 3 - SMILES and RDKit</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-04.html">Lecture 4 - Chemical Structure Identifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-05.html">Lecture 5 - Regression and Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-06.html">Lecture 6 - Cross-Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-07.html">Lecture 7 - Decision Trees and Random Forests</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-08.html">Lecture 8 - Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-09.html">Lecture 9 - Graph Neural Networks</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Lecture 10 - Property &amp; Reaction Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-11.html">Lecture 11 - Dimension Reduction for Data Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-12.html">Lecture 12 - Self-Supervised Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-13.html">Lecture 13 - De Novo Molecule Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-14.html">Lecture 14 - Bayesian Optimization for Synthesis Conditions</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-15.html">Lecture 15 - Multi-objective Bayesian Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-16.html">Lecture 16 - Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-17.html">Lecture 17 - PU Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-18.html">Lecture 18 - Contrastive Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-19.html">Lecture 19 - Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-20.html">Lecture 20 - Large Language Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-21.html">Lecture 21 - Computer Vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-22.html">Lecture 22 - Vision Languge Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-23.html">Lecture 23 - Prompt Engineering and Function Calling</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Flecture-10.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/lecture-10.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lecture 10 - Property & Reaction Prediction</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#directed-message-passing-neural-network-d-mpnn">1. Directed message-passing neural network (D-MPNN)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preparation">2. Data preparation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#property-prediction-regression">3. Property prediction (regression)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pick-blocks">3.1 Pick blocks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#build-model-and-trainer">3.2 Build model and trainer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#train">3.3 Train</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#test-and-parity-plot">3.4 Test and parity plot</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#property-prediction-classification">4. Property prediction (classification)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#build-classification-dataset">4.1 Build classification dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-and-training">4.2 Model and training</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#roc-curve">4.3 ROC curve</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reactivity-and-selectivity">5. Reactivity and selectivity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reactivity-classifier">5.1 Reactivity classifier</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rationale">6. Rationale</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solubility-prediction-rationale">6.1 Solubility prediction rationale</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reactivity-prediction-rationale">6.2 Reactivity prediction rationale</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#chemprop-cli-command-line-interface">7. Chemprop CLI (Command-Line Interface)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reactivity-classification-ch-oxidation-dataset">7.3 Reactivity classification (C–H oxidation dataset)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-reference">7. Quick Reference</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">8. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inclass-activity">10. In‑class activity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q1-chemprop-regression-on-melting-point">Q1. Chemprop regression on melting point</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q2-chemprop-classification-on-toxicity-student-challenge">Q2. Chemprop classification on toxicity (student challenge)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-q1">Solution Q1:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-q2">Solution Q2</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lecture-10-property-reaction-prediction">
<h1>Lecture 10 - Property &amp; Reaction Prediction<a class="headerlink" href="#lecture-10-property-reaction-prediction" title="Link to this heading">#</a></h1>
<section id="learning-goals">
<h2>Learning goals<a class="headerlink" href="#learning-goals" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Set up <strong>Chemprop v2</strong> for regression and classification on our C-H oxidation dataset.</p></li>
<li><p>Train four <strong>single task</strong> models for: Solubility, pKa, Melting Point, Toxicity.</p></li>
<li><p>Train a <strong>reactivity</strong> classifier and an <strong>atom-level selectivity</strong> predictor.</p></li>
<li><p>Interpret a trained model with <strong>Shapley values (SHAP)</strong> at the feature and node levels.</p></li>
</ul>
<p><a class="reference external" href="https://colab.research.google.com/drive/12KCDkXb9IHCs9TO9zGK4zMONmbqheplK?usp=sharing"><img alt="Colab" src="https://img.shields.io/badge/Open-Colab-orange" /></a></p>
<p>For this lecture 10, it is recommended to run everything in Colab.
On this HTML page, some outputs are disabled due to execution limits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Intentional stop: ending execution here.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">RuntimeError</span><span class="g g-Whitespace">                              </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Intentional stop: ending execution here.&quot;</span><span class="p">)</span>

<span class="ne">RuntimeError</span>: Intentional stop: ending execution here.
</pre></div>
</div>
</div>
</div>
</section>
<section id="directed-message-passing-neural-network-d-mpnn">
<h2>1. Directed message-passing neural network (D-MPNN)<a class="headerlink" href="#directed-message-passing-neural-network-d-mpnn" title="Link to this heading">#</a></h2>
<p>We will train models for four molecular properties and reaction-related labels using Chemprop.</p>
<p>Briefly speaking, Chemprop builds neural models for molecules using a <em>directed</em> message passing neural network (D-MPNN).</p>
<p>As you recall from previous lecture, a message passing neural network (MPNN) updates hidden vectors on nodes and edges with local neighbor information, then an aggregation step creates a graph-level vector for prediction.</p>
<p>Chemprop’s directed variant changes the way messages flow: instead of passing information back and forth between atoms, it assigns a hidden state to each directed bond (atom <code class="docutils literal notranslate"><span class="pre">i</span></code> → atom <code class="docutils literal notranslate"><span class="pre">j</span></code>). This prevents immediate backtracking (“tottering”) where messages would simply bounce between two atoms without capturing new context. By using directed bonds, the model distinguishes subtle chemical environments. For example, the information carried from a carbon toward a nitrogen can be different than the reverse direction, which matters for reactivity and selectivity.</p>
<p>As a GNN, Chemprop also featurizes a molecule as a <strong>graph</strong>:</p>
<ul class="simple">
<li><p><strong>Nodes</strong> are atoms with features like atomic number, degree, aromaticity.</p></li>
<li><p><strong>Edges</strong> are bonds with features like bond order and stereo.</p></li>
</ul>
<p>Initial directed bond state <span class="math notranslate nohighlight">\(h_{i→j}^{(0)}\)</span> is a learned function of the source atom features and the bond features. For <code class="docutils literal notranslate"><span class="pre">t</span> <span class="pre">=</span> <span class="pre">1..T</span></code>, update
<span class="math notranslate nohighlight">\(
h_{i \to j}^{(t)} = \sigma \Big( W \cdot \big( h_{i \to j}^{(t-1)} + \sum_{k \in \mathcal{N}(i) \setminus \{j\}} h_{k \to i}^{(t-1)} \big) + b \Big)
\)</span>,
where <code class="docutils literal notranslate"><span class="pre">σ</span></code> is an activation such as <code class="docutils literal notranslate"><span class="pre">ReLU</span></code>, <code class="docutils literal notranslate"><span class="pre">W</span></code> is a learned weight, <span class="math notranslate nohighlight">\(x_{i→j}\)</span> are featurized inputs, <span class="math notranslate nohighlight">\(⊕\)</span> is concatenation. After T steps, Chemprop aggregates per directed bond states to atom states, then pools to a molecule vector <span class="math notranslate nohighlight">\(h_mol\)</span> using sum or mean or attention pooling. <span class="math notranslate nohighlight">\(h_mol\)</span> feeds a multitask feedforward head.</p>
<p>We have been working with the following quite many times:</p>
<ul class="simple">
<li><p><strong>Solubility_mol_per_L</strong>: continuous. Regression with loss like MSE or MAE.</p></li>
<li><p><strong>pKa</strong>: continuous. Regression.</p></li>
<li><p><strong>Melting Point</strong>: continuous. Regression.</p></li>
<li><p><strong>Toxicity</strong>: categorical with values like <code class="docutils literal notranslate"><span class="pre">toxic</span></code> or <code class="docutils literal notranslate"><span class="pre">non_toxic</span></code>. Binary classification.</p></li>
</ul>
<p>While these two we never try before:</p>
<ul class="simple">
<li><p><strong>Reactivity</strong>: binary label <code class="docutils literal notranslate"><span class="pre">1</span></code> vs <code class="docutils literal notranslate"><span class="pre">-1</span></code>. Binary classification. In our C-H oxidation dataset, this means whether the substrate will undergo oxidation.</p></li>
<li><p><strong>Site Selectivity</strong>: a set of atom indices. Atom-level classification inside a molecule. In our C-H oxidation dataset, this means which atom(s) are most likely to oxidize under certain electrochemical reaction condition, expressed as atom indices in the SMILES.</p></li>
</ul>
<p>As a reminder, below are some reference formulas:</p>
<ul class="simple">
<li><p>Regression losses<br />
$<span class="math notranslate nohighlight">\(
\text{MSE} = \frac{1}{n}\sum_i (y_i - \hat y_i)^2,\qquad
\text{MAE} = \frac{1}{n}\sum_i |y_i - \hat y_i|
\)</span>$</p></li>
<li><p>Binary cross entropy<br />
$<span class="math notranslate nohighlight">\(
\mathcal{L} = -\frac{1}{n}\sum_i \big(y_i\log \hat p_i + (1-y_i)\log(1-\hat p_i)\big)
\)</span>$</p></li>
</ul>
<blockquote>
<div><p>You saw this idea in earlier lectures. The new part is that Chemprop builds the graph from SMILES and offers modules for molecule, reaction and atom/bond tasks.</p>
</div></blockquote>
<p>We begin with load and inspect the C-H oxidation dataset.</p>
</section>
<section id="data-preparation">
<h2>2. Data preparation<a class="headerlink" href="#data-preparation" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/zzhenglab/ai4chem/main/book/_data/C_H_oxidation_dataset.csv&quot;</span>
<span class="n">df_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">df_raw</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-5a6c65ea-d883-4b98-93ba-042028abf7de" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Compound Name</th>
      <th>CAS</th>
      <th>SMILES</th>
      <th>Solubility_mol_per_L</th>
      <th>pKa</th>
      <th>Toxicity</th>
      <th>Melting Point</th>
      <th>Reactivity</th>
      <th>Oxidation Site</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3,4-dihydro-1H-isochromene</td>
      <td>493-05-0</td>
      <td>c1ccc2c(c1)CCOC2</td>
      <td>0.103906</td>
      <td>5.80</td>
      <td>non_toxic</td>
      <td>65.8</td>
      <td>1</td>
      <td>8,10</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9H-fluorene</td>
      <td>86-73-7</td>
      <td>c1ccc2c(c1)Cc1ccccc1-2</td>
      <td>0.010460</td>
      <td>5.82</td>
      <td>toxic</td>
      <td>90.0</td>
      <td>1</td>
      <td>7</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1,2,3,4-tetrahydronaphthalene</td>
      <td>119-64-2</td>
      <td>c1ccc2c(c1)CCCC2</td>
      <td>0.020589</td>
      <td>5.74</td>
      <td>toxic</td>
      <td>69.4</td>
      <td>1</td>
      <td>7,10</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ethylbenzene</td>
      <td>100-41-4</td>
      <td>CCc1ccccc1</td>
      <td>0.048107</td>
      <td>5.87</td>
      <td>non_toxic</td>
      <td>65.0</td>
      <td>1</td>
      <td>1,2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cyclohexene</td>
      <td>110-83-8</td>
      <td>C1=CCCCC1</td>
      <td>0.060688</td>
      <td>5.66</td>
      <td>non_toxic</td>
      <td>96.4</td>
      <td>1</td>
      <td>3,6</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-5a6c65ea-d883-4b98-93ba-042028abf7de')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-5a6c65ea-d883-4b98-93ba-042028abf7de button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-5a6c65ea-d883-4b98-93ba-042028abf7de');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-7ff29eda-9fcb-4eab-9831-586608e1cc24">
      <button class="colab-df-quickchart" onclick="quickchart('df-7ff29eda-9fcb-4eab-9831-586608e1cc24')"
                title="Suggest charts"
                style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-7ff29eda-9fcb-4eab-9831-586608e1cc24 button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

    </div>
  </div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Clean a copy and normalize a few columns</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df_raw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Toxicity -&gt; binary string &#39;toxic&#39;/&#39;non_toxic&#39; to 1/0 if present</span>
<span class="n">tox_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;toxic&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;non_toxic&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<span class="k">if</span> <span class="s2">&quot;Toxicity&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tox_bin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Toxicity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">tox_map</span><span class="p">)</span>

<span class="c1"># Reactivity -&gt; 1/-1 to 1/0</span>
<span class="k">if</span> <span class="s2">&quot;Reactivity&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;react_bin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Reactivity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Oxidation Site -&gt; list of ints</span>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_sites</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">[]</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;site_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Oxidation Site&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_sites</span><span class="p">)</span>

<span class="c1"># Take log of solubility (keep same column name)</span>
<span class="k">if</span> <span class="s2">&quot;Solubility_mol_per_L&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;logS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Solubility_mol_per_L&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>

<span class="n">df</span><span class="p">[[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span><span class="s2">&quot;logS&quot;</span><span class="p">,</span><span class="s2">&quot;pKa&quot;</span><span class="p">,</span><span class="s2">&quot;Toxicity&quot;</span><span class="p">,</span><span class="s2">&quot;Melting Point&quot;</span><span class="p">,</span><span class="s2">&quot;react_bin&quot;</span><span class="p">,</span><span class="s2">&quot;site_list&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-c30af436-aafb-445f-89b8-5e60454405d2" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SMILES</th>
      <th>logS</th>
      <th>pKa</th>
      <th>Toxicity</th>
      <th>Melting Point</th>
      <th>react_bin</th>
      <th>site_list</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>c1ccc2c(c1)CCOC2</td>
      <td>-0.983356</td>
      <td>5.80</td>
      <td>non_toxic</td>
      <td>65.8</td>
      <td>1</td>
      <td>[8, 10]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>c1ccc2c(c1)Cc1ccccc1-2</td>
      <td>-1.980414</td>
      <td>5.82</td>
      <td>toxic</td>
      <td>90.0</td>
      <td>1</td>
      <td>[7]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>c1ccc2c(c1)CCCC2</td>
      <td>-1.686343</td>
      <td>5.74</td>
      <td>toxic</td>
      <td>69.4</td>
      <td>1</td>
      <td>[7, 10]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>CCc1ccccc1</td>
      <td>-1.317782</td>
      <td>5.87</td>
      <td>non_toxic</td>
      <td>65.0</td>
      <td>1</td>
      <td>[1, 2]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>C1=CCCCC1</td>
      <td>-1.216890</td>
      <td>5.66</td>
      <td>non_toxic</td>
      <td>96.4</td>
      <td>1</td>
      <td>[3, 6]</td>
    </tr>
    <tr>
      <th>5</th>
      <td>C1CCSC1</td>
      <td>-0.917634</td>
      <td>5.97</td>
      <td>non_toxic</td>
      <td>15.8</td>
      <td>1</td>
      <td>[3, 5]</td>
    </tr>
    <tr>
      <th>6</th>
      <td>CN1CCCC1=O</td>
      <td>-0.499442</td>
      <td>5.91</td>
      <td>non_toxic</td>
      <td>71.1</td>
      <td>1</td>
      <td>[3]</td>
    </tr>
    <tr>
      <th>7</th>
      <td>COCc1ccccc1</td>
      <td>-1.070756</td>
      <td>5.61</td>
      <td>non_toxic</td>
      <td>108.5</td>
      <td>1</td>
      <td>[3]</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-c30af436-aafb-445f-89b8-5e60454405d2')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-c30af436-aafb-445f-89b8-5e60454405d2 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-c30af436-aafb-445f-89b8-5e60454405d2');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-932aa12a-7114-4bff-a1e7-335db53d6863">
      <button class="colab-df-quickchart" onclick="quickchart('df-932aa12a-7114-4bff-a1e7-335db53d6863')"
                title="Suggest charts"
                style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-932aa12a-7114-4bff-a1e7-335db53d6863 button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

    </div>
  </div>
</div></div>
</div>
<p>⏰ <strong>Exercise 1</strong></p>
<p>Count number of postive and negative reaction outcomes in <code class="docutils literal notranslate"><span class="pre">react_bin</span></code>.</p>
<p>We will create <strong>MoleculeDatapoint</strong> objects from SMILES and targets, split the data, and build loaders.
Our first target will be <code class="docutils literal notranslate"><span class="pre">solubility</span></code>.</p>
<blockquote>
<div><p>Step 1. Build datapoints.</p>
</div></blockquote>
<p>Each row of the dataframe is now represented as a <code class="docutils literal notranslate"><span class="pre">MoleculeDatapoint</span></code>. It stores the SMILES, the numeric target (solubility here), plus metadata like optional weights.<br />
This is the <em>atomic unit</em> Chemprop will pass to the featurizer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Keep rows that have both SMILES and solubility</span>
<span class="n">df_sol</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span><span class="s2">&quot;logS&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">smis</span> <span class="o">=</span> <span class="n">df_sol</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">ys</span>   <span class="o">=</span> <span class="n">df_sol</span><span class="p">[</span><span class="s2">&quot;logS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="n">sol_datapoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">MoleculeDatapoint</span><span class="o">.</span><span class="n">from_smi</span><span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">smi</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">smis</span><span class="p">,</span> <span class="n">ys</span><span class="p">)]</span>
<span class="nb">len</span><span class="p">(</span><span class="n">sol_datapoints</span><span class="p">),</span> <span class="n">sol_datapoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(575, (1,))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sol_datapoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MoleculeDatapoint(mol=&lt;rdkit.Chem.rdchem.Mol object at 0x797c8982cdd0&gt;, y=array([-0.9833561]), weight=1.0, gt_mask=None, lt_mask=None, x_d=None, x_phase=None, name=&#39;c1ccc2c(c1)CCOC2&#39;, V_f=None, E_f=None, V_d=None)
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>Step 2. Split to train, val, test.</p>
</div></blockquote>
<p>We divided the list of datapoints into three folds.</p>
<ul class="simple">
<li><p>Training: used to fit model weights.</p></li>
<li><p>Validation: used to monitor progress and stop early.</p></li>
<li><p>Test: kept blind until the end.<br />
Even though we used a random split here, Chemprop also supports scaffold-based splits which are often better for chemistry.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">mol</span> <span class="k">for</span> <span class="n">dp</span> <span class="ow">in</span> <span class="n">sol_datapoints</span><span class="p">]</span>

<span class="n">train_lists</span><span class="p">,</span> <span class="n">val_lists</span><span class="p">,</span> <span class="n">test_lists</span> <span class="o">=</span> <span class="n">make_split_indices</span><span class="p">(</span>
    <span class="n">mols</span><span class="o">=</span><span class="n">mols</span><span class="p">,</span>
    <span class="n">split</span><span class="o">=</span><span class="s2">&quot;random&quot;</span><span class="p">,</span>
    <span class="n">sizes</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">num_replicates</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">train_dpss</span><span class="p">,</span> <span class="n">val_dpss</span><span class="p">,</span> <span class="n">test_dpss</span> <span class="o">=</span> <span class="n">split_data_by_indices</span><span class="p">(</span>
    <span class="n">sol_datapoints</span><span class="p">,</span> <span class="n">train_lists</span><span class="p">,</span> <span class="n">val_lists</span><span class="p">,</span> <span class="n">test_lists</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dpss</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_dpss</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_dpss</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>460 57 58
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>Step 3. Build dataset objects and scale targets.</p>
</div></blockquote>
<p>A <code class="docutils literal notranslate"><span class="pre">MoleculeDataset</span></code> wraps the datapoints and applies the chosen featurizer.</p>
<ul class="simple">
<li><p>Here we used <code class="docutils literal notranslate"><span class="pre">SimpleMoleculeMolGraphFeaturizer</span></code>, which turns atoms and bonds into numeric arrays.</p></li>
<li><p>We also normalized the target values (subtract mean, divide by std) so the model trains smoothly. The stored <code class="docutils literal notranslate"><span class="pre">scaler</span></code> allows us to unscale predictions back.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feat</span> <span class="o">=</span> <span class="n">featurizers</span><span class="o">.</span><span class="n">SimpleMoleculeMolGraphFeaturizer</span><span class="p">()</span>
<span class="n">train_set</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">MoleculeDataset</span><span class="p">(</span><span class="n">train_dpss</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">featurizer</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">train_set</span><span class="o">.</span><span class="n">normalize_targets</span><span class="p">()</span>  <span class="c1"># store mean/var</span>

<span class="n">val_set</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">MoleculeDataset</span><span class="p">(</span><span class="n">val_dpss</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">featurizer</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span>
<span class="n">val_set</span><span class="o">.</span><span class="n">normalize_targets</span><span class="p">(</span><span class="n">scaler</span><span class="p">)</span>

<span class="n">test_set</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">MoleculeDataset</span><span class="p">(</span><span class="n">test_dpss</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">featurizer</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span>

<span class="c1"># Peek at one item structure</span>
<span class="n">item0</span> <span class="o">=</span> <span class="n">train_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">type</span><span class="p">(</span><span class="n">item0</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">item0</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">item0</span><span class="o">.</span><span class="n">mg</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">item0</span><span class="o">.</span><span class="n">mg</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;Datum&#39;, array([0.42734608]), (11, 72), (24, 14))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#uncomment below and take a look!</span>
<span class="c1">#val_set [0]</span>
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>Step 4. Dataloaders.</p>
</div></blockquote>
<p>Finally, we wrapped datasets in PyTorch-style <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code>s.</p>
<ul class="simple">
<li><p>Training loader will shuffle each epoch.</p></li>
<li><p>Validation and test loaders do not shuffle, to keep evaluation consistent.<br />
Batching is automatic: molecules of different sizes are packed together and masks are used internally.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_loader</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">val_loader</span>   <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span><span class="n">val_set</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">test_loader</span>  <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span><span class="n">test_set</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">train_loader</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;torch.utils.data.dataloader.DataLoader at 0x797c8a4251f0&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="property-prediction-regression">
<h2>3. Property prediction (regression)<a class="headerlink" href="#property-prediction-regression" title="Link to this heading">#</a></h2>
<p>We will configure a small MPNN for regression.</p>
<p>In particular, we will:</p>
<ol class="arabic simple">
<li><p>Choose the neural blocks that define how messages are passed, pooled, and transformed into outputs.</p></li>
<li><p>Assemble them into a complete model object.</p></li>
<li><p>Set up a training loop with early stopping and checkpoints.</p></li>
<li><p>Evaluate predictions on a held-out test set and visualize the quality using a parity plot.</p></li>
</ol>
<section id="pick-blocks">
<h3>3.1 Pick blocks<a class="headerlink" href="#pick-blocks" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mp</span>  <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BondMessagePassing</span><span class="p">()</span>        <span class="c1"># node/edge update</span>
<span class="n">agg</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MeanAggregation</span><span class="p">()</span>           <span class="c1"># pool node vectors</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">RegressionFFN</span><span class="p">(</span>              <span class="c1"># simple FFN head</span>
    <span class="n">output_transform</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">UnscaleTransform</span><span class="o">.</span><span class="n">from_standard_scaler</span><span class="p">(</span><span class="n">scaler</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">batch_norm</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">RMSE</span><span class="p">(),</span> <span class="n">nn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">MAE</span><span class="p">()]</span>  <span class="c1"># first metric used for early stopping</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p><strong>BondMessagePassing()</strong> updates hidden states on each directed bond by passing information across neighbors.</p></li>
<li><p><strong>MeanAggregation()</strong> pools hidden vectors to form atom or molecule-level representations. Other options like sum or attention pooling are possible.</p></li>
<li><p><strong>RegressionFFN()</strong> is a feed-forward head. Here we attach an <code class="docutils literal notranslate"><span class="pre">UnscaleTransform</span></code> so predictions can be mapped back to the original solubility scale.</p></li>
<li><p><strong>Batch normalization</strong> improves stability by normalizing hidden states during training.</p></li>
<li><p><strong>Metrics</strong> let us monitor training. RMSE (root mean squared error) and MAE (mean absolute error) are both useful, but RMSE is often more sensitive to large errors and is used for early stopping.</p></li>
</ul>
</section>
<section id="build-model-and-trainer">
<h3>3.2 Build model and trainer<a class="headerlink" href="#build-model-and-trainer" title="Link to this heading">#</a></h3>
<p>Once the blocks are chosen, we wrap them into a full MPNN model. Chemprop uses PyTorch Lightning under the hood, so we also set up a Trainer:</p>
<ul class="simple">
<li><p>The ModelCheckpoint callback saves the best version of the model during training, based on validation loss.</p></li>
<li><p>The trainer can run on CPU or GPU (<code class="docutils literal notranslate"><span class="pre">accelerator=&quot;auto&quot;</span></code>).</p></li>
</ul>
<p>We set epoch number at the beginning of this notebook, you can go all the way up and change this number if you feel it takes too long. You can use 15 here for demonstration, but in practice you might extend this depending on dataset size and convergence.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mpnn_sol</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">MPNN</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">agg</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">batch_norm</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>

<span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;checkpoints_sol&quot;</span><span class="p">)</span>
<span class="n">checkpoint_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ckpt</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ModelCheckpoint</span><span class="p">(</span>
    <span class="n">dirpath</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">),</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;best-</span><span class="si">{epoch}</span><span class="s2">-</span><span class="si">{val_loss:.3f}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="n">save_last</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
    <span class="n">logger</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enable_checkpointing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">accelerator</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">devices</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="n">EPOCHS</span><span class="p">,</span> <span class="c1"># you can mannually put  = 15 here to make it faster</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ckpt</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">mpnn_sol</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:pytorch_lightning.utilities.rank_zero:GPU available: False, used: False
INFO:pytorch_lightning.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO:pytorch_lightning.utilities.rank_zero:HPU available: False, using: 0 HPUs
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MPNN(
  (message_passing): BondMessagePassing(
    (W_i): Linear(in_features=86, out_features=300, bias=False)
    (W_h): Linear(in_features=300, out_features=300, bias=False)
    (W_o): Linear(in_features=372, out_features=300, bias=True)
    (dropout): Dropout(p=0.0, inplace=False)
    (tau): ReLU()
    (V_d_transform): Identity()
    (graph_transform): Identity()
  )
  (agg): MeanAggregation()
  (bn): BatchNorm1d(300, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (predictor): RegressionFFN(
    (ffn): MLP(
      (0): Sequential(
        (0): Linear(in_features=300, out_features=300, bias=True)
      )
      (1): Sequential(
        (0): ReLU()
        (1): Dropout(p=0.0, inplace=False)
        (2): Linear(in_features=300, out_features=1, bias=True)
      )
    )
    (criterion): MSE(task_weights=[[1.0]])
    (output_transform): UnscaleTransform()
  )
  (X_d_transform): Identity()
  (metrics): ModuleList(
    (0): RMSE(task_weights=[[1.0]])
    (1): MAE(task_weights=[[1.0]])
    (2): MSE(task_weights=[[1.0]])
  )
)
</pre></div>
</div>
</div>
</div>
<p>At this stage, we have a complete pipeline: dataset loaders, model blocks, and a trainer that knows when to save progress.</p>
</section>
<section id="train">
<h3>3.3 Train<a class="headerlink" href="#train" title="Link to this heading">#</a></h3>
<p>Since we implement everything earlier, now training is as simple as calling <code class="docutils literal notranslate"><span class="pre">fit()</span></code>. The trainer will:</p>
<ol class="arabic simple">
<li><p>Iterate over the training loader each epoch.</p></li>
<li><p>Evaluate on the validation loader.</p></li>
<li><p>Save checkpoints when the validation RMSE improves.</p></li>
</ol>
<p>During training, you can monitor validation loss to see whether the model is underfitting, overfitting, or converging as expected.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">mpnn_sol</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:pytorch_lightning.utilities.rank_zero:Loading `train_dataloader` to estimate number of stepping batches.
INFO: 
  | Name            | Type               | Params | Mode 
---------------------------------------------------------------
0 | message_passing | BondMessagePassing | 227 K  | train
1 | agg             | MeanAggregation    | 0      | train
2 | bn              | BatchNorm1d        | 600    | train
3 | predictor       | RegressionFFN      | 90.6 K | train
4 | X_d_transform   | Identity           | 0      | train
5 | metrics         | ModuleList         | 0      | train
---------------------------------------------------------------
318 K     Trainable params
0         Non-trainable params
318 K     Total params
1.276     Total estimated model params size (MB)
25        Modules in train mode
0         Modules in eval mode
INFO:lightning.pytorch.callbacks.model_summary:
  | Name            | Type               | Params | Mode 
---------------------------------------------------------------
0 | message_passing | BondMessagePassing | 227 K  | train
1 | agg             | MeanAggregation    | 0      | train
2 | bn              | BatchNorm1d        | 600    | train
3 | predictor       | RegressionFFN      | 90.6 K | train
4 | X_d_transform   | Identity           | 0      | train
5 | metrics         | ModuleList         | 0      | train
---------------------------------------------------------------
318 K     Trainable params
0         Non-trainable params
318 K     Total params
1.276     Total estimated model params size (MB)
25        Modules in train mode
0         Modules in eval mode
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d84436e8b0a5414f98087a86ee1b5642", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "2b875f8a0581461a9d14649d1442f155", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "cad6421967c949ba8679e4e8208d6cb6", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "cb83323b27154cbb973b855da755dbb5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6b7e069aa9ee4c98aacaba123432a9aa", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "78c6404f874a4b4588331e650b78cdfb", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e567ba54e1544bf6866d12ddca61a748", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "80474c3a478a48828ff988b8a1bbace8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7e4f8ee22eea468b9096b6ffdd3a58b2", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d88c39b8ef064186b522f781c9a1b4f5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e77584fa64bf49f29f9b2adde41c41b9", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8f8f590b5b674752a236643896e00e5f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8ade66edbc8543c9876e4b2814b2328e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7f7aea883bf64e32a42271f276cc2d76", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9609eb76319443b1a0e3c63856735095", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f132b1c1848b4d20b1e983de2cc59874", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8ba4d06e442749b9b781b2085d4688de", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9de652d41c1246579e86fd651e1a39d7", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7178d870d6fc4232bd9f27b1075e1244", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "84d4f2349d614595b7c270309c7431f2", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "93adb1aaf703498f838854b375a08b86", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "260a342f01fc456b8558cc04012acafe", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a7710d92b03d49bea5258fa67ebf5840", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "0ddbe461ed6a4acc9e1fa46573a273c3", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "601ecd5ead04416e8a4c09665da86869", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f73431dfdd8c484eb9ee736100cdcb20", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "5c7eb70f76664e7cae9e9205c50f6180", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "2fc32f66aaa4443ea24ee758ca324c09", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d3c75ec7413d4300af739772291c68d8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f02860d0ec004fa2a18eee87ca1bc2ba", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8d7703ca11464d40a6cd648c3f6b317b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8dfc3b968bc5458a9c50dfc29c95816b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "ee7ae907254246febe8f333e6fd47d9c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "91c8f3ff89a94f02b462da532b4415d9", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "657445ebaa5f499c8d07fa8b4e3969ef", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c4fccbeb4d844962a7a274a3f47990c0", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "69f7447c856243a5be0c702154960510", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "509b112b5e1e45bebf8a7af18198acc8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "24ecadab530e40bab59b152c87bd4a36", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "b8e71a8391774b9c80e7040aa6912bfb", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4cd32fc9183a497f9b5402ec4ce6a901", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "99290f041fa341f2a8a082b14d401a63", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "86d5f2a13c8c4edd9b3fc9a918bf667e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "ee6c762e92bb4c39bc779815c5cbe0c4", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "bc3067ea9a2d4197a1a6f85d21183062", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "42b2451edb06422aaaf0b8c6c6f25415", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "3fdc1c50607c4ba29d5c324ca128b2ca", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "0018b4ca25b5406fa5be4621f3aa3ce0", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "02f36295d3094029a65ee7d762f6d8ca", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4bcef07aefdf46a995029eff1d880ff3", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f5f4da1d627e4e7da0357a5768db72b4", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "b01e359a783a4ed88f08d175896565a1", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:pytorch_lightning.utilities.rank_zero:`Trainer.fit` stopped: `max_epochs=50` reached.
</pre></div>
</div>
</div>
</div>
</section>
<section id="test-and-parity-plot">
<h3>3.4 Test and parity plot<a class="headerlink" href="#test-and-parity-plot" title="Link to this heading">#</a></h3>
<p>After training, we hold back the test set for final evaluation. We then visualize predicted vs. true values with a parity plot. We have practiced doing so many times so far.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">mpnn_sol</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>

<span class="c1"># Gather predictions for parity</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">mpnn_sol</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">y_true</span> <span class="o">=</span> <span class="n">test_set</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test size:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_true</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="c1"># Set both axes to the same range</span>
<span class="n">lims</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span> <span class="n">lims</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;True solubility (mol/L)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Predicted&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Parity plot: Solubility&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "137b1c6574ab40fe9b9e4c9d1481e857", "version_major": 2, "version_minor": 0}</script><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold">        Test metric        </span>┃<span style="font-weight: bold">       DataLoader 0        </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│<span style="color: #008080; text-decoration-color: #008080">         test/mae          </span>│<span style="color: #800080; text-decoration-color: #800080">    0.28014591336250305    </span>│
│<span style="color: #008080; text-decoration-color: #008080">         test/rmse         </span>│<span style="color: #800080; text-decoration-color: #800080">    0.4139021337032318     </span>│
└───────────────────────────┴───────────────────────────┘
</pre>
</div><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7e555361d80a4033b40684f6203f05ae", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Test size: 58
</pre></div>
</div>
<img alt="_images/7e94ebaab31af2c1ce07a19995fb4b3c7cef9346bf68e04aa4cf2106450e856e.png" src="_images/7e94ebaab31af2c1ce07a19995fb4b3c7cef9346bf68e04aa4cf2106450e856e.png" />
</div>
</div>
<p>⏰ Exercise</p>
<p>Build a new model call <code class="docutils literal notranslate"><span class="pre">mpnn_sol_2</span></code>.
Change the aggregation from <code class="docutils literal notranslate"><span class="pre">MeanAggregation()</span></code> to <code class="docutils literal notranslate"><span class="pre">SumAggregation()</span></code> and retrain for 10 epochs. Compare RMSE and the parity plot. What changed?</p>
</section>
</section>
<section id="property-prediction-classification">
<h2>4. Property prediction (classification)<a class="headerlink" href="#property-prediction-classification" title="Link to this heading">#</a></h2>
<p>Here we predict <code class="docutils literal notranslate"><span class="pre">toxic</span></code> vs <code class="docutils literal notranslate"><span class="pre">non_toxic</span></code>.</p>
<section id="build-classification-dataset">
<h3>4.1 Build classification dataset<a class="headerlink" href="#build-classification-dataset" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_tox</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span><span class="s2">&quot;tox_bin&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">smis</span> <span class="o">=</span> <span class="n">df_tox</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">ys</span>   <span class="o">=</span> <span class="n">df_tox</span><span class="p">[</span><span class="s2">&quot;tox_bin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="n">tox_dps</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">MoleculeDatapoint</span><span class="o">.</span><span class="n">from_smi</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">smis</span><span class="p">,</span><span class="n">ys</span><span class="p">)]</span>
<span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">mol</span> <span class="k">for</span> <span class="n">dp</span> <span class="ow">in</span> <span class="n">tox_dps</span><span class="p">]</span>
<span class="n">tr_idx</span><span class="p">,</span> <span class="n">va_idx</span><span class="p">,</span> <span class="n">te_idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">make_split_indices</span><span class="p">(</span><span class="n">mols</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">))</span>
<span class="n">tr</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">te</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split_data_by_indices</span><span class="p">(</span><span class="n">tox_dps</span><span class="p">,</span> <span class="n">tr_idx</span><span class="p">,</span> <span class="n">va_idx</span><span class="p">,</span> <span class="n">te_idx</span><span class="p">)</span>

<span class="n">feat</span> <span class="o">=</span> <span class="n">featurizers</span><span class="o">.</span><span class="n">SimpleMoleculeMolGraphFeaturizer</span><span class="p">()</span>
<span class="n">tox_tr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">MoleculeDataset</span><span class="p">(</span><span class="n">tr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">featurizer</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span>
<span class="n">tox_va</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">MoleculeDataset</span><span class="p">(</span><span class="n">va</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">featurizer</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span>
<span class="n">tox_te</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">MoleculeDataset</span><span class="p">(</span><span class="n">te</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">featurizer</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="model-and-training">
<h3>4.2 Model and training<a class="headerlink" href="#model-and-training" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mp</span>  <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BondMessagePassing</span><span class="p">()</span>
<span class="n">agg</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MeanAggregation</span><span class="p">()</span>
<span class="n">ffn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BinaryClassificationFFN</span><span class="p">(</span><span class="n">n_tasks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mpnn_tox</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">MPNN</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">agg</span><span class="p">,</span> <span class="n">ffn</span><span class="p">,</span> <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">tr_loader</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span><span class="n">tox_tr</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">va_loader</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span><span class="n">tox_va</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">te_loader</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span><span class="n">tox_te</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">trainer_tox</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enable_checkpointing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">accelerator</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                         <span class="n">devices</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">trainer_tox</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">mpnn_tox</span><span class="p">,</span> <span class="n">tr_loader</span><span class="p">,</span> <span class="n">va_loader</span><span class="p">)</span>
<span class="n">trainer_tox</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">mpnn_tox</span><span class="p">,</span> <span class="n">te_loader</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:pytorch_lightning.utilities.rank_zero:💡 Tip: For seamless cloud uploads and versioning, try installing [litmodels](https://pypi.org/project/litmodels/) to enable LitModelCheckpoint, which syncs automatically with the Lightning model registry.
INFO:pytorch_lightning.utilities.rank_zero:GPU available: False, used: False
INFO:pytorch_lightning.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO:pytorch_lightning.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO:pytorch_lightning.utilities.rank_zero:Loading `train_dataloader` to estimate number of stepping batches.
INFO: 
  | Name            | Type                    | Params | Mode 
--------------------------------------------------------------------
0 | message_passing | BondMessagePassing      | 227 K  | train
1 | agg             | MeanAggregation         | 0      | train
2 | bn              | Identity                | 0      | train
3 | predictor       | BinaryClassificationFFN | 90.6 K | train
4 | X_d_transform   | Identity                | 0      | train
5 | metrics         | ModuleList              | 0      | train
--------------------------------------------------------------------
318 K     Trainable params
0         Non-trainable params
318 K     Total params
1.273     Total estimated model params size (MB)
24        Modules in train mode
0         Modules in eval mode
INFO:lightning.pytorch.callbacks.model_summary:
  | Name            | Type                    | Params | Mode 
--------------------------------------------------------------------
0 | message_passing | BondMessagePassing      | 227 K  | train
1 | agg             | MeanAggregation         | 0      | train
2 | bn              | Identity                | 0      | train
3 | predictor       | BinaryClassificationFFN | 90.6 K | train
4 | X_d_transform   | Identity                | 0      | train
5 | metrics         | ModuleList              | 0      | train
--------------------------------------------------------------------
318 K     Trainable params
0         Non-trainable params
318 K     Total params
1.273     Total estimated model params size (MB)
24        Modules in train mode
0         Modules in eval mode
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "b73e59fdebe54cd1832e4b61f8f9a0bd", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "bc0edd54fa03437985e34631ea164ea6", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "bd6b9bf774a040529589ff6ca27c054d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "902ab547a7cc46fd99ae96d24a51493e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4e8035f697a942e8af378ac981327203", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f4331ca5e8aa4fa5894682a3c275197b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9e87990920fb4be7ac2850fdbf00b4f6", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "81585084d9864e6d957b062b9e2c9c28", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f6700dbc9092473588e0bf16e627f7ad", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "181c5d7cffda4a768efd4c1753b375ae", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "3c0bbd6ae1b84c4b968a47f53975a07e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "ee8246a0d1f54af486caef4964f13ff6", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "0ff126baab46422db0c35ac76e4865e8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "2cdfae031cd646ae9a08b47838f3f7c9", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c8488195d5cf447aae43058a52ac41e8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a85b419c9c15464da981ea97a95743f0", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9337e372c4be4d37a9f6bb6e0740235f", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:pytorch_lightning.utilities.rank_zero:`Trainer.fit` stopped: `max_epochs=15` reached.
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "12e1147d750a476f8521f998086b9abd", "version_major": 2, "version_minor": 0}</script><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold">        Test metric        </span>┃<span style="font-weight: bold">       DataLoader 0        </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│<span style="color: #008080; text-decoration-color: #008080">         test/roc          </span>│<span style="color: #800080; text-decoration-color: #800080">    0.8639456033706665     </span>│
└───────────────────────────┴───────────────────────────┘
</pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;test/roc&#39;: 0.8639456033706665}]
</pre></div>
</div>
</div>
</div>
</section>
<section id="roc-curve">
<h3>4.3 ROC curve<a class="headerlink" href="#roc-curve" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Gather probabilities</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
    <span class="n">pred_chunks</span> <span class="o">=</span> <span class="n">trainer_tox</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">mpnn_tox</span><span class="p">,</span> <span class="n">te_loader</span><span class="p">)</span>
<span class="n">proba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">pred_chunks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">y_true</span> <span class="o">=</span> <span class="n">tox_te</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">proba</span><span class="p">)</span>
<span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="p">(</span><span class="n">proba</span><span class="o">&gt;=</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test AUC: </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">  Accuracy: </span><span class="si">{</span><span class="n">acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thr</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">proba</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s2">&quot;k--&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;FPR&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;TPR&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;ROC: Toxicity&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "4f3885298d1b4727b00bd00dc3fecd89", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Test AUC: 0.864  Accuracy: 0.862
</pre></div>
</div>
<img alt="_images/0575fc92a9c75403b209a162cae7a0007a1bda003d227be1756e3bb60e70801d.png" src="_images/0575fc92a9c75403b209a162cae7a0007a1bda003d227be1756e3bb60e70801d.png" />
</div>
</div>
</section>
</section>
<section id="reactivity-and-selectivity">
<h2>5. Reactivity and selectivity<a class="headerlink" href="#reactivity-and-selectivity" title="Link to this heading">#</a></h2>
<p>Two targets in this dataset relate to reactions.</p>
<ul class="simple">
<li><p><strong>Reactivity</strong>: binary at the molecule level.</p></li>
<li><p><strong>Selectivity</strong>: oxidation site indices at the atom level.</p></li>
</ul>
<p>Before we train models, let’s <strong>look at the labels</strong>. Let’s pick three representative molecules from the C-H oxidation dataset and see their reactivity and selectivity label.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Helper selection: one negative (no reaction), one positive with a single site, one positive with multiple sites</span>
<span class="k">def</span><span class="w"> </span><span class="nf">pick_representatives</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df_pos</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;react_bin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;site_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_pos_multi</span> <span class="o">=</span> <span class="n">df_pos</span><span class="p">[</span><span class="n">df_pos</span><span class="p">[</span><span class="s2">&quot;site_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_neg</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;react_bin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">reps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_neg</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">reps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Negative (react_bin=0)&quot;</span><span class="p">,</span> <span class="n">df_neg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_pos</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">reps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Positive (react_bin=1; 1 site)&quot;</span><span class="p">,</span> <span class="n">df_pos</span><span class="p">[</span><span class="n">df_pos</span><span class="p">[</span><span class="s2">&quot;site_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                     <span class="k">if</span> <span class="p">(</span><span class="n">df_pos</span><span class="p">[</span><span class="s2">&quot;site_list&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="n">df_pos</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_pos_multi</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">reps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Positive (react_bin=1; multi-site)&quot;</span><span class="p">,</span> <span class="n">df_pos_multi</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># If fewer than 3 examples exist, just return what we have</span>
    <span class="k">return</span> <span class="n">reps</span>

<span class="n">reps</span> <span class="o">=</span> <span class="n">pick_representatives</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">reps</span><span class="p">),</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">reps</span><span class="p">]</span>
<span class="c1"># Show the chosen rows so readers see SMILES and labels</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="k">def</span><span class="w"> </span><span class="nf">row_view</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;SMILES&quot;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">],</span>
        <span class="s2">&quot;react_bin&quot;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;react_bin&quot;</span><span class="p">],</span>
        <span class="s2">&quot;site_list (1-based)&quot;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;site_list&quot;</span><span class="p">]</span>
    <span class="p">}</span>

<span class="n">rep_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">row_view</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reps</span><span class="p">])</span>
<span class="n">rep_table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-18f4993b-99ca-4c74-b65a-be5578e50fdc" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SMILES</th>
      <th>react_bin</th>
      <th>site_list (1-based)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Nc1c(Oc2ccccc2)cc(O)c2c1C(=O)c1ccccc1C2=O</td>
      <td>0</td>
      <td>[-1]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>c1ccc2c(c1)Cc1ccccc1-2</td>
      <td>1</td>
      <td>[7]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>c1ccc2c(c1)CCOC2</td>
      <td>1</td>
      <td>[8, 10]</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-18f4993b-99ca-4c74-b65a-be5578e50fdc')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-18f4993b-99ca-4c74-b65a-be5578e50fdc button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-18f4993b-99ca-4c74-b65a-be5578e50fdc');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-7b74ae9f-250a-4dc6-9a4c-d708d1631e9a">
      <button class="colab-df-quickchart" onclick="quickchart('df-7b74ae9f-250a-4dc6-9a4c-d708d1631e9a')"
                title="Suggest charts"
                style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-7b74ae9f-250a-4dc6-9a4c-d708d1631e9a button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

  <div id="id_d9f4f3f4-b5ba-48b3-866f-002600fc281e">
    <style>
      .colab-df-generate {
        background-color: #E8F0FE;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        fill: #1967D2;
        height: 32px;
        padding: 0 0 0 0;
        width: 32px;
      }

      .colab-df-generate:hover {
        background-color: #E2EBFA;
        box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
        fill: #174EA6;
      }

      [theme=dark] .colab-df-generate {
        background-color: #3B4455;
        fill: #D2E3FC;
      }

      [theme=dark] .colab-df-generate:hover {
        background-color: #434B5C;
        box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
        fill: #FFFFFF;
      }
    </style>
    <button class="colab-df-generate" onclick="generateWithVariable('rep_table')"
            title="Generate code using this dataframe."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M7,19H8.4L18.45,9,17,7.55,7,17.6ZM5,21V16.75L18.45,3.32a2,2,0,0,1,2.83,0l1.4,1.43a1.91,1.91,0,0,1,.58,1.4,1.91,1.91,0,0,1-.58,1.4L9.25,21ZM18.45,9,17,7.55Zm-12,3A5.31,5.31,0,0,0,4.9,8.1,5.31,5.31,0,0,0,1,6.5,5.31,5.31,0,0,0,4.9,4.9,5.31,5.31,0,0,0,6.5,1,5.31,5.31,0,0,0,8.1,4.9,5.31,5.31,0,0,0,12,6.5,5.46,5.46,0,0,0,6.5,12Z"/>
  </svg>
    </button>
    <script>
      (() => {
      const buttonEl =
        document.querySelector('#id_d9f4f3f4-b5ba-48b3-866f-002600fc281e button.colab-df-generate');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      buttonEl.onclick = () => {
        google.colab.notebook.generateWithVariable('rep_table');
      }
      })();
    </script>
  </div>

    </div>
  </div>
</div></div>
</div>
<p>Let’s draw them:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem.Draw</span><span class="w"> </span><span class="kn">import</span> <span class="n">rdMolDraw2D</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_annotated_copy</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">site_list_1based</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tag_c123</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>  <span class="c1"># copy</span>
    <span class="n">Chem</span><span class="o">.</span><span class="n">AssignAtomChiralTagsFromStructure</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">Chem</span><span class="o">.</span><span class="n">Kekulize</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">clearAromaticFlags</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()</span>
    <span class="c1"># Highlight oxidation sites (convert to 0-based safely)</span>
    <span class="n">hi_atoms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">site_list_1based</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">idx1</span> <span class="ow">in</span> <span class="n">site_list_1based</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">idx1</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">hi_atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

    <span class="c1"># Always annotate the atom index so readers see 1-based indexing used in labels</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">idx1</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">old</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">GetProp</span><span class="p">(</span><span class="s2">&quot;atomNote&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">HasProp</span><span class="p">(</span><span class="s2">&quot;atomNote&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># If this atom is an oxidation site, add a star</span>
        <span class="n">star</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="ow">in</span> <span class="n">hi_atoms</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">a</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="s2">&quot;atomNote&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">old</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">idx1</span><span class="si">}{</span><span class="n">star</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">hi_atoms</span>

<span class="k">def</span><span class="w"> </span><span class="nf">draw_examples</span><span class="p">(</span><span class="n">reps</span><span class="p">,</span> <span class="n">mol_size</span><span class="o">=</span><span class="p">(</span><span class="mi">320</span><span class="p">,</span> <span class="mi">280</span><span class="p">)):</span>
    <span class="n">ms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">legends</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">highlights</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reps</span><span class="p">:</span>
        <span class="n">smi</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">m_annot</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">make_annotated_copy</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">site_list_1based</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;site_list&quot;</span><span class="p">],</span> <span class="n">tag_c123</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m_annot</span><span class="p">)</span>
        <span class="n">lbl</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Reactivity=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;react_bin&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Sites=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;site_list&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">legends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lbl</span><span class="p">)</span>
        <span class="n">highlights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hi</span><span class="p">)</span>

    <span class="n">imgs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">highlights</span><span class="p">,</span> <span class="n">legends</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Draw</span><span class="o">.</span><span class="n">MolToImage</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">mol_size</span><span class="p">,</span> <span class="n">highlightAtoms</span><span class="o">=</span><span class="n">hi</span><span class="p">)</span>
        <span class="n">img</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lg</span>
        <span class="n">imgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="c1"># Create a grid image manually by re-drawing with legends</span>
    <span class="k">return</span> <span class="n">Draw</span><span class="o">.</span><span class="n">MolsToGridImage</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">molsPerRow</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ms</span><span class="p">),</span> <span class="n">subImgSize</span><span class="o">=</span><span class="n">mol_size</span><span class="p">,</span>
                                <span class="n">legends</span><span class="o">=</span><span class="n">legends</span><span class="p">,</span>
                                <span class="n">highlightAtomLists</span><span class="o">=</span><span class="n">highlights</span><span class="p">)</span>

<span class="n">grid_img</span> <span class="o">=</span> <span class="n">draw_examples</span><span class="p">(</span><span class="n">reps</span><span class="p">)</span>
<span class="n">grid_img</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0b4dafaad8a4b0f25f3d75d33ecb9fbd00b6662b81b8435b92db724165bd69bc.png" src="_images/0b4dafaad8a4b0f25f3d75d33ecb9fbd00b6662b81b8435b92db724165bd69bc.png" />
</div>
</div>
<section id="reactivity-classifier">
<h3>5.1 Reactivity classifier<a class="headerlink" href="#reactivity-classifier" title="Link to this heading">#</a></h3>
<p>This mirrors the toxicity classification workflow we saw before.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_rxn</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span><span class="s2">&quot;react_bin&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">smis</span> <span class="o">=</span> <span class="n">df_rxn</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">ys</span>   <span class="o">=</span> <span class="n">df_rxn</span><span class="p">[</span><span class="s2">&quot;react_bin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="n">rxn_dps</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">MoleculeDatapoint</span><span class="o">.</span><span class="n">from_smi</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">smis</span><span class="p">,</span> <span class="n">ys</span><span class="p">)]</span>
<span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">mol</span> <span class="k">for</span> <span class="n">dp</span> <span class="ow">in</span> <span class="n">rxn_dps</span><span class="p">]</span>
<span class="n">tr_idx</span><span class="p">,</span> <span class="n">va_idx</span><span class="p">,</span> <span class="n">te_idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">make_split_indices</span><span class="p">(</span><span class="n">mols</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">))</span>
<span class="n">tr</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">te</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split_data_by_indices</span><span class="p">(</span><span class="n">rxn_dps</span><span class="p">,</span> <span class="n">tr_idx</span><span class="p">,</span> <span class="n">va_idx</span><span class="p">,</span> <span class="n">te_idx</span><span class="p">)</span>

<span class="n">feat</span> <span class="o">=</span> <span class="n">featurizers</span><span class="o">.</span><span class="n">SimpleMoleculeMolGraphFeaturizer</span><span class="p">()</span>
<span class="n">rxn_tr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">MoleculeDataset</span><span class="p">(</span><span class="n">tr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">featurizer</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span>
<span class="n">rxn_va</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">MoleculeDataset</span><span class="p">(</span><span class="n">va</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">featurizer</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span>
<span class="n">rxn_te</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">MoleculeDataset</span><span class="p">(</span><span class="n">te</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">featurizer</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span>

<span class="n">mp</span>  <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BondMessagePassing</span><span class="p">()</span>
<span class="n">agg</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MeanAggregation</span><span class="p">()</span>
<span class="n">ffn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BinaryClassificationFFN</span><span class="p">(</span><span class="n">n_tasks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mpnn_rxn</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">MPNN</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">agg</span><span class="p">,</span> <span class="n">ffn</span><span class="p">,</span> <span class="n">batch_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">tr_loader</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span><span class="n">rxn_tr</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">va_loader</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span><span class="n">rxn_va</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">te_loader</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span><span class="n">rxn_te</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">trainer_rxn</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enable_checkpointing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">accelerator</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                         <span class="n">devices</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">trainer_rxn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">mpnn_rxn</span><span class="p">,</span> <span class="n">tr_loader</span><span class="p">,</span> <span class="n">va_loader</span><span class="p">)</span>
<span class="n">trainer_rxn</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">mpnn_rxn</span><span class="p">,</span> <span class="n">te_loader</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:pytorch_lightning.utilities.rank_zero:💡 Tip: For seamless cloud uploads and versioning, try installing [litmodels](https://pypi.org/project/litmodels/) to enable LitModelCheckpoint, which syncs automatically with the Lightning model registry.
INFO:pytorch_lightning.utilities.rank_zero:GPU available: False, used: False
INFO:pytorch_lightning.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO:pytorch_lightning.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO:pytorch_lightning.utilities.rank_zero:Loading `train_dataloader` to estimate number of stepping batches.
INFO: 
  | Name            | Type                    | Params | Mode 
--------------------------------------------------------------------
0 | message_passing | BondMessagePassing      | 227 K  | train
1 | agg             | MeanAggregation         | 0      | train
2 | bn              | Identity                | 0      | train
3 | predictor       | BinaryClassificationFFN | 90.6 K | train
4 | X_d_transform   | Identity                | 0      | train
5 | metrics         | ModuleList              | 0      | train
--------------------------------------------------------------------
318 K     Trainable params
0         Non-trainable params
318 K     Total params
1.273     Total estimated model params size (MB)
24        Modules in train mode
0         Modules in eval mode
INFO:lightning.pytorch.callbacks.model_summary:
  | Name            | Type                    | Params | Mode 
--------------------------------------------------------------------
0 | message_passing | BondMessagePassing      | 227 K  | train
1 | agg             | MeanAggregation         | 0      | train
2 | bn              | Identity                | 0      | train
3 | predictor       | BinaryClassificationFFN | 90.6 K | train
4 | X_d_transform   | Identity                | 0      | train
5 | metrics         | ModuleList              | 0      | train
--------------------------------------------------------------------
318 K     Trainable params
0         Non-trainable params
318 K     Total params
1.273     Total estimated model params size (MB)
24        Modules in train mode
0         Modules in eval mode
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "038307909d544f14b91755d847985baf", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8d4ec378de514c3d86def1b9669d0155", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6e7c550ec8d34d579075cf2ded576d4d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "386774703a814ad59d85b3e77231b89b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "1d68c5fe0aff46d8bad01846ba58949e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e6b2fc77896244fbb05c338f6bb4fda6", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "0da5dea9c1c640a39142601913e7f1ac", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "473a932f651e49f6a70b4a54216f724e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a3bf0cb306ad4e009e4d9bca290dd765", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "610c3b27d0ba4f1baf8a05dc487f1865", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "3dc5f129acef4f19bdaaa146d19dc13e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f176b6556278439f9db731d4ef7689ea", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "18b3fef1689d4055a54e46c75ec3fee7", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "32f0b3050d3e444b94bfc20e8eef8b98", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8496beab40344a15ab41760d0e85db87", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "b805d7751e2b4f24bb66e5080d1f1d6a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "93a93250b0954b41bf60c213d3f3ffa5", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:pytorch_lightning.utilities.rank_zero:`Trainer.fit` stopped: `max_epochs=15` reached.
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "7351f27db14845d5bf2e7786a8dcb1c0", "version_major": 2, "version_minor": 0}</script><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold">        Test metric        </span>┃<span style="font-weight: bold">       DataLoader 0        </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│<span style="color: #008080; text-decoration-color: #008080">         test/roc          </span>│<span style="color: #800080; text-decoration-color: #800080">     0.958184003829956     </span>│
└───────────────────────────┴───────────────────────────┘
</pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;test/roc&#39;: 0.958184003829956}]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>

<span class="k">def</span><span class="w"> </span><span class="nf">atoms_labels_from_smiles</span><span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">positive_idxs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">Chem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">positive_idxs</span><span class="p">:</span>
        <span class="c1"># dataset uses 1-based indexing in the text, RDKit uses 0-based</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">idx</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">y</span>

<span class="c1"># Build list of MolAtomBondDatapoint for selectivity</span>
<span class="n">sel_rows</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span><span class="s2">&quot;site_list&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">sel_dps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">smi</span><span class="p">,</span> <span class="n">sites</span> <span class="ow">in</span> <span class="n">sel_rows</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">atom_y</span> <span class="o">=</span> <span class="n">atoms_labels_from_smiles</span><span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">sites</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">atom_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="c1"># We provide atom_y, molecule-level y is optional here</span>
    <span class="n">dp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">MolAtomBondDatapoint</span><span class="o">.</span><span class="n">from_smi</span><span class="p">(</span>
        <span class="n">smi</span><span class="p">,</span> <span class="n">atom_y</span><span class="o">=</span><span class="n">atom_y</span><span class="p">,</span> <span class="n">reorder_atoms</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">sel_dps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>

<span class="nb">len</span><span class="p">(</span><span class="n">sel_dps</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">sel_dps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="vm">__name__</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(575, &#39;MolAtomBondDatapoint&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">dp</span> <span class="ow">in</span> <span class="n">sel_dps</span><span class="p">]</span>
<span class="c1"># For structure-based split we need RDKit Mol. Build directly from SMILES fallback:</span>
<span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">dp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;SMILES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">Chem</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">dp</span> <span class="ow">in</span> <span class="n">sel_dps</span><span class="p">]</span>

<span class="n">tr_idx</span><span class="p">,</span> <span class="n">va_idx</span><span class="p">,</span> <span class="n">te_idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">make_split_indices</span><span class="p">(</span><span class="n">mols</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
<span class="n">tr</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">te</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split_data_by_indices</span><span class="p">(</span><span class="n">sel_dps</span><span class="p">,</span> <span class="n">tr_idx</span><span class="p">,</span> <span class="n">va_idx</span><span class="p">,</span> <span class="n">te_idx</span><span class="p">)</span>

<span class="n">feat</span> <span class="o">=</span> <span class="n">featurizers</span><span class="o">.</span><span class="n">SimpleMoleculeMolGraphFeaturizer</span><span class="p">()</span>
<span class="n">tr_set</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">MolAtomBondDataset</span><span class="p">(</span><span class="n">tr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">featurizer</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span>
<span class="n">va_set</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">MolAtomBondDataset</span><span class="p">(</span><span class="n">va</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">featurizer</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span>
<span class="n">te_set</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">MolAtomBondDataset</span><span class="p">(</span><span class="n">te</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">featurizer</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span>

<span class="n">tr_loader</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span><span class="n">tr_set</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">va_loader</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span><span class="n">va_set</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">te_loader</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span><span class="n">te_set</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:chemprop.data.dataloader:Dropping last batch of size 1 to avoid issues with batch normalization (dataset size = 57, batch_size = 8)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mp</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MABBondMessagePassing</span><span class="p">(</span>
    <span class="n">d_v</span><span class="o">=</span><span class="n">feat</span><span class="o">.</span><span class="n">atom_fdim</span><span class="p">,</span> <span class="n">d_e</span><span class="o">=</span><span class="n">feat</span><span class="o">.</span><span class="n">bond_fdim</span><span class="p">,</span> <span class="n">d_h</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span>
<span class="p">)</span>
<span class="n">agg</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MeanAggregation</span><span class="p">()</span>

<span class="n">atom_predictor</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BinaryClassificationFFN</span><span class="p">(</span><span class="n">n_tasks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># atom-level 0/1</span>

<span class="n">model_sel</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">MolAtomBondMPNN</span><span class="p">(</span>
    <span class="n">message_passing</span><span class="o">=</span><span class="n">mp</span><span class="p">,</span>
    <span class="n">agg</span><span class="o">=</span><span class="n">agg</span><span class="p">,</span>
    <span class="n">mol_predictor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">atom_predictor</span><span class="o">=</span><span class="n">atom_predictor</span><span class="p">,</span>
    <span class="n">bond_predictor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">BinaryAUROC</span><span class="p">()],</span>
<span class="p">)</span>

<span class="n">trainer_sel</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enable_checkpointing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">accelerator</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                         <span class="n">devices</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span> <span class="n">EPOCHS</span><span class="p">)</span> <span class="c1">#You can change this number at the begining of this notebook</span>
<span class="n">trainer_sel</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model_sel</span><span class="p">,</span> <span class="n">tr_loader</span><span class="p">,</span> <span class="n">va_loader</span><span class="p">)</span>
<span class="n">trainer_sel</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">model_sel</span><span class="p">,</span> <span class="n">te_loader</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:pytorch_lightning.utilities.rank_zero:💡 Tip: For seamless cloud uploads and versioning, try installing [litmodels](https://pypi.org/project/litmodels/) to enable LitModelCheckpoint, which syncs automatically with the Lightning model registry.
INFO:pytorch_lightning.utilities.rank_zero:GPU available: False, used: False
INFO:pytorch_lightning.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO:pytorch_lightning.utilities.rank_zero:HPU available: False, using: 0 HPUs
INFO:pytorch_lightning.utilities.rank_zero:Loading `train_dataloader` to estimate number of stepping batches.
INFO: 
  | Name            | Type                    | Params | Mode 
--------------------------------------------------------------------
0 | message_passing | MABBondMessagePassing   | 322 K  | train
1 | agg             | MeanAggregation         | 0      | train
2 | atom_predictor  | BinaryClassificationFFN | 90.6 K | train
3 | bns             | ModuleList              | 600    | train
4 | X_d_transform   | Identity                | 0      | train
5 | metricss        | ModuleList              | 0      | train
--------------------------------------------------------------------
413 K     Trainable params
0         Non-trainable params
413 K     Total params
1.654     Total estimated model params size (MB)
30        Modules in train mode
0         Modules in eval mode
INFO:lightning.pytorch.callbacks.model_summary:
  | Name            | Type                    | Params | Mode 
--------------------------------------------------------------------
0 | message_passing | MABBondMessagePassing   | 322 K  | train
1 | agg             | MeanAggregation         | 0      | train
2 | atom_predictor  | BinaryClassificationFFN | 90.6 K | train
3 | bns             | ModuleList              | 600    | train
4 | X_d_transform   | Identity                | 0      | train
5 | metricss        | ModuleList              | 0      | train
--------------------------------------------------------------------
413 K     Trainable params
0         Non-trainable params
413 K     Total params
1.654     Total estimated model params size (MB)
30        Modules in train mode
0         Modules in eval mode
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "24eabe7986e7464a8f9860b9488b0028", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d1dbb8d8c7d5417b9d9742667d48c329", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "205cf52f535e471fa35793bcdb19e9b3", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "60e6a2d32c394b31838862b9271f6e0e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "acbf6d4853ea4c9bb8fe029cae47e208", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "b46881676d8345cd905f4a1c6359e61b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "66a1884ccd674dc697e049858ba51717", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d6335b964d384ae287f3f28476016058", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "75869c1324d44ef8a159e1fe5b30150d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c8f854fbe4c54f4ea62f7cd89949e875", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d4b6895f2ae548939491114fc0c55d8d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "1bf2c1e140e142b78c4f9e8428e96a32", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4facd0edb1634b969f87fe6a1d59d577", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7932e7ed7fee4259a0712d121a2159c7", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "550df14925a346088a99b84e8fc67738", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "66a93952175843e59ebca36c558dc116", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "73d769f3c1874a8fb24791517a3146bc", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8fa46194a6d24232baa28f19c510de84", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d645d9b8638f476bab6d4c4f92f7206c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "3d9be003d2e34bbcbbaad66325f4f0bd", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "51d1ee5d4e8a415facab112a2353f223", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9d3251d58fb24add890de91a3d22d3b0", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f4119f78f2e14ad08f163f45e318adeb", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "20cf97a63a7c4e4a86f42a88bbdc5b77", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "3b61c94ab29248dea9984bedb9d5a03d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d0ceeacfeebb44eab540e795f0b48362", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9a93c60ac7d348258476f920b68d0b4c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7b191bf7ba6747348a195573ad7e3c6c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "02ebc1f4222e4a5f93cc5c891cbdcf5d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9a200022c5ba45ec9fe2366bd55a31be", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "84a52ca26ee14f19b969ccdc1696d57e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "fc3e3d58697d49f5839886e0c1bbcacb", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c7dcf96c2e7f437890ebc0a91bed22a0", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "56138d808fbb4804afc08850789b660a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "00a6d6f1d9bd473c9696494dac224130", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "590310fc5e234d59aa6705d84aa7f24b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a97ba56c20334d25b9192260277348b3", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a8c6ab0f80624b3ca98635db52b6ba9d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a945d5e8db904f08a135fa3611a8f450", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e75d65258f3b42afab9869ca79e5bdbc", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c3108cd140fb44f2a3f3d0a4b68f04ab", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e13ac24467eb4a6bb57377ae0c97955d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a5b2fe0805e3483b9d428a6048d91377", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a4c3f119bb034fed8d8257064ed45354", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "cdabdc1e130447dfa074702b631d8be8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "47202c5c900b4c6a8ea357332c9ae94b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "5f63449e740048e295373f67f4c78866", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "08097470a88b4c07a097aa8212aafc63", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "54b21b047ec543d8aa203809cd7db167", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "805fe78b1f8e41388efe06fbaa0e0c8e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "cb8d867b2bb14ecba99eb8248817129a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9a14239351154e3fa85aaf78fa34f10e", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:pytorch_lightning.utilities.rank_zero:`Trainer.fit` stopped: `max_epochs=50` reached.
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2ba995025d174af3924bed2b24a1aa43", "version_major": 2, "version_minor": 0}</script><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold">        Test metric        </span>┃<span style="font-weight: bold">       DataLoader 0        </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│<span style="color: #008080; text-decoration-color: #008080">       atom_test/roc       </span>│<span style="color: #800080; text-decoration-color: #800080">    0.8670018315315247     </span>│
└───────────────────────────┴───────────────────────────┘
</pre>
</div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;atom_test/roc&#39;: 0.8670018315315247}]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1) Pick which test item to visualize</span>
<span class="n">idx</span> <span class="o">=</span> <span class="mi">11</span>  <span class="c1"># change as you like</span>

<span class="c1"># 2) Grab the original datapoint (not the already-featurized datum)</span>
<span class="n">dp</span> <span class="o">=</span> <span class="n">te_set</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>   <span class="c1"># IMPORTANT: .data gives you the raw MolAtomBondDatapoint</span>

<span class="c1"># 3) Make a one-item MolAtomBondDataset with the SAME featurizer you used before</span>
<span class="n">single_ds</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">MolAtomBondDataset</span><span class="p">([</span><span class="n">dp</span><span class="p">],</span> <span class="n">featurizer</span><span class="o">=</span><span class="n">feat</span><span class="p">)</span>

<span class="c1"># 4) Build a loader and get its batch</span>
<span class="n">single_loader</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span><span class="n">single_ds</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">single_loader</span><span class="p">))</span>  <span class="c1"># this now matches collate expectations</span>

<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">model_sel</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>   <span class="c1"># batch[0] is the MolGraphBatch</span>

<span class="c1"># 6) Unpack outputs and get per-atom probabilities</span>
<span class="n">_</span><span class="p">,</span> <span class="n">atom_logits</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">out</span>
<span class="n">atom_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">atom_logits</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Atom count:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom_probs</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;First 10 probabilities:&quot;</span><span class="p">,</span> <span class="n">atom_probs</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>

<span class="c1"># 7) Draw the SAME molecule with aligned probabilities</span>
<span class="n">smi</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># MolAtomBondDatapoint stores SMILES in .name</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
<span class="n">m2</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()):</span>
    <span class="n">a</span><span class="o">.</span><span class="n">SetProp</span><span class="p">(</span><span class="s2">&quot;atomNote&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atom_probs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">Draw</span><span class="o">.</span><span class="n">MolToImage</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Atom count: 10
First 10 probabilities: [0.5        0.5000001  0.5        0.5        0.5000006  0.5000006
 0.503788   0.5000002  0.7055641  0.50000006]
</pre></div>
</div>
<img alt="_images/db1efe5d98e19e0c0fff52879adbd0d5e3fdfeccbbb6afce89d93bb2e0c4a248.png" src="_images/db1efe5d98e19e0c0fff52879adbd0d5e3fdfeccbbb6afce89d93bb2e0c4a248.png" />
</div>
</div>
<p>⏰ <strong>Exercise</strong></p>
<p>Change <code class="docutils literal notranslate"><span class="pre">idx</span></code> above to take a look at other molecules in test set.</p>
</section>
</section>
<section id="rationale">
<h2>6. Rationale<a class="headerlink" href="#rationale" title="Link to this heading">#</a></h2>
<p>In this section we ask <strong>why</strong> the model makes its predictions. Instead of just reporting a number for solubility or reactivity, we try to find the <em>substructures</em> of a molecule that drive the prediction.</p>
<p>The method we use is a simplified form of <strong>Monte Carlo Tree Search (MCTS) rationale extraction</strong> from the Chemprop:</p>
<ol class="arabic simple">
<li><p><strong>Start with the whole molecule</strong> and its predicted property.</p></li>
<li><p><strong>Systematically remove small fragments</strong> (like a bond or a ring) and check how the model’s prediction changes for the remaining subgraph.</p></li>
<li><p>Build a search tree of candidate subgraphs and keep the ones that still predict strongly for the property of interest.</p></li>
<li><p>From this set, report the <strong>smallest and most predictive subgraph</strong> as the <em>rationale</em>.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===== Shared helpers for both tasks (Chemprop v2.2.1) =====</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span><span class="o">,</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning</span><span class="w"> </span><span class="kn">import</span> <span class="n">pytorch</span> <span class="k">as</span> <span class="n">pl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem.Draw</span><span class="w"> </span><span class="kn">import</span> <span class="n">rdMolDraw2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">Image</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">chemprop</span><span class="w"> </span><span class="kn">import</span> <span class="n">data</span><span class="p">,</span> <span class="n">models</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">chemprop.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">MPNN</span>

<span class="c1"># Predict a list of SMILES with a single-task model. Returns array shape (n, 1).</span>
<span class="k">def</span><span class="w"> </span><span class="nf">make_prediction</span><span class="p">(</span><span class="n">models_in</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MPNN</span><span class="p">],</span> <span class="n">trainer_in</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">,</span> <span class="n">smiles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">MoleculeDatapoint</span><span class="o">.</span><span class="n">from_smi</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">smiles</span><span class="p">]</span>
    <span class="n">test_dset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">MoleculeDataset</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
    <span class="n">test_loader</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span><span class="n">test_dset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
        <span class="n">agg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models_in</span><span class="p">:</span>
            <span class="n">pred_batches</span> <span class="o">=</span> <span class="n">trainer_in</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>  <span class="c1"># list of tensors/arrays</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span> <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="n">pred_batches</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">agg</span> <span class="o">=</span> <span class="n">preds</span> <span class="k">if</span> <span class="n">agg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">agg</span> <span class="o">+</span> <span class="n">preds</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">agg</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">models_in</span><span class="p">)</span>

<span class="c1"># ---- MCTS components (as in tutorial, with safer kekulize handling) ----</span>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MCTSNode</span><span class="p">:</span>
    <span class="n">smiles</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">atoms</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">W</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">N</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">P</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">children</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Q</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">U</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">c_puct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span> <span class="k">return</span> <span class="n">c_puct</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">find_clusters</span><span class="p">(</span><span class="n">mol</span><span class="p">:</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="o">...</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,)],</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetBonds</span><span class="p">():</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">GetBeginAtomIdx</span><span class="p">(),</span> <span class="n">b</span><span class="o">.</span><span class="n">GetEndAtomIdx</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="o">.</span><span class="n">IsInRing</span><span class="p">():</span>
            <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
    <span class="n">ssr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Chem</span><span class="o">.</span><span class="n">GetSymmSSSR</span><span class="p">(</span><span class="n">mol</span><span class="p">)]</span>
    <span class="n">clusters</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ssr</span><span class="p">)</span>
    <span class="n">atom_cls</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusters</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cl</span><span class="p">:</span> <span class="n">atom_cls</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">atom_cls</span>

<span class="k">def</span><span class="w"> </span><span class="nf">extract_subgraph_from_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">:</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="n">selected_atoms</span><span class="p">:</span> <span class="nb">set</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">selected_atoms</span><span class="p">)</span>
    <span class="n">roots</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">:</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">nei</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sel</span> <span class="k">for</span> <span class="n">nei</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">GetNeighbors</span><span class="p">()):</span>
            <span class="n">roots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">rw</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">RWMol</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">rw</span><span class="o">.</span><span class="n">GetAtomWithIdx</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">SetAtomMapNum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">aroma</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">GetBonds</span><span class="p">()</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">GetBondType</span><span class="p">()</span> <span class="o">==</span> <span class="n">Chem</span><span class="o">.</span><span class="n">rdchem</span><span class="o">.</span><span class="n">BondType</span><span class="o">.</span><span class="n">AROMATIC</span><span class="p">]</span>
        <span class="n">aroma</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">aroma</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">GetBeginAtom</span><span class="p">()</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="ow">in</span> <span class="n">sel</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">GetEndAtom</span><span class="p">()</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aroma</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">SetIsAromatic</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rw</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">GetIdx</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">rw</span><span class="o">.</span><span class="n">RemoveAtom</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rw</span><span class="o">.</span><span class="n">GetMol</span><span class="p">(),</span> <span class="n">roots</span>

<span class="k">def</span><span class="w"> </span><span class="nf">extract_subgraph</span><span class="p">(</span><span class="n">smiles</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">selected_atoms</span><span class="p">:</span> <span class="nb">set</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span><span class="kc">None</span><span class="p">]]:</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="c1"># try kekulized</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mk</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">mol</span><span class="p">);</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Kekulize</span><span class="p">(</span><span class="n">mk</span><span class="p">)</span>
        <span class="n">sub</span><span class="p">,</span> <span class="n">roots</span> <span class="o">=</span> <span class="n">extract_subgraph_from_mol</span><span class="p">(</span><span class="n">mk</span><span class="p">,</span> <span class="n">selected_atoms</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">smi</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">kekuleSmiles</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="n">sub</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">sub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mol</span><span class="o">.</span><span class="n">HasSubstructMatch</span><span class="p">(</span><span class="n">sub</span><span class="p">):</span> <span class="k">return</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">sub</span><span class="p">),</span> <span class="n">roots</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="c1"># fallback without kekulize</span>
    <span class="n">sub</span><span class="p">,</span> <span class="n">roots</span> <span class="o">=</span> <span class="n">extract_subgraph_from_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">selected_atoms</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">smi</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="n">sub</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">sub</span><span class="p">),</span> <span class="n">roots</span><span class="p">)</span> <span class="k">if</span> <span class="n">sub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">mcts_rollout</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">MCTSNode</span><span class="p">,</span> <span class="n">state_map</span><span class="p">,</span> <span class="n">orig_smiles</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">atom_cls</span><span class="p">,</span> <span class="n">nei_cls</span><span class="p">,</span>
                 <span class="n">scoring_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">min_atoms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">c_puct</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">atoms</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">min_atoms</span><span class="p">:</span> <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">P</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cur_cls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">cur</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cur_cls</span><span class="p">:</span>
            <span class="n">leaf_atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom_cls</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">cur_cls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nei_cls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">cur_cls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">leaf_atoms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">new_atoms</span> <span class="o">=</span> <span class="n">cur</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">leaf_atoms</span><span class="p">)</span>
                <span class="n">new_smi</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">extract_subgraph</span><span class="p">(</span><span class="n">orig_smiles</span><span class="p">,</span> <span class="n">new_atoms</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">new_smi</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">new_smi</span><span class="p">,</span> <span class="n">MCTSNode</span><span class="p">(</span><span class="n">new_smi</span><span class="p">,</span> <span class="n">new_atoms</span><span class="p">)))</span>
        <span class="n">state_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">smiles</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">P</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scoring_fn</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">smiles</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">child</span><span class="p">,</span> <span class="n">sc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">scores</span><span class="p">):</span> <span class="n">child</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
    <span class="n">totalN</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">N</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
    <span class="n">nxt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Q</span><span class="p">()</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">U</span><span class="p">(</span><span class="n">totalN</span><span class="p">,</span> <span class="n">c_puct</span><span class="o">=</span><span class="n">c_puct</span><span class="p">))</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">mcts_rollout</span><span class="p">(</span><span class="n">nxt</span><span class="p">,</span> <span class="n">state_map</span><span class="p">,</span> <span class="n">orig_smiles</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">atom_cls</span><span class="p">,</span> <span class="n">nei_cls</span><span class="p">,</span> <span class="n">scoring_fn</span><span class="p">,</span> <span class="n">min_atoms</span><span class="o">=</span><span class="n">min_atoms</span><span class="p">,</span> <span class="n">c_puct</span><span class="o">=</span><span class="n">c_puct</span><span class="p">)</span>
    <span class="n">nxt</span><span class="o">.</span><span class="n">W</span> <span class="o">+=</span> <span class="n">v</span><span class="p">;</span> <span class="n">nxt</span><span class="o">.</span><span class="n">N</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_mcts_for_smiles</span><span class="p">(</span><span class="n">smi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scoring_fn</span><span class="p">,</span> <span class="n">rollout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">c_puct</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                        <span class="n">min_atoms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">max_atoms</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">MCTSNode</span><span class="p">]:</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>
    <span class="n">clusters_raw</span><span class="p">,</span> <span class="n">atom_cls_raw</span> <span class="o">=</span> <span class="n">find_clusters</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">clusters_raw</span><span class="p">]</span>
    <span class="n">atom_cls</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atom_cls_raw</span><span class="p">]</span>
    <span class="n">nei_cls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusters</span><span class="p">):</span>
        <span class="n">neigh</span> <span class="o">=</span> <span class="p">[</span><span class="n">nei</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cl</span> <span class="k">for</span> <span class="n">nei</span> <span class="ow">in</span> <span class="n">atom_cls_raw</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
        <span class="n">nei_cls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">neigh</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="n">i</span><span class="p">})</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">MCTSNode</span><span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">())))</span>
    <span class="n">state_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">smi</span><span class="p">:</span> <span class="n">root</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rollout</span><span class="p">):</span>
        <span class="n">mcts_rollout</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">state_map</span><span class="p">,</span> <span class="n">smi</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">atom_cls</span><span class="p">,</span> <span class="n">nei_cls</span><span class="p">,</span> <span class="n">scoring_fn</span><span class="p">,</span> <span class="n">min_atoms</span><span class="o">=</span><span class="n">min_atoms</span><span class="p">,</span> <span class="n">c_puct</span><span class="o">=</span><span class="n">c_puct</span><span class="p">)</span>
    <span class="n">rats</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">state_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">smiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_atoms</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">rats</span>

<span class="c1"># Simple fragment fallback if MCTS cannot find anything</span>
<span class="k">def</span><span class="w"> </span><span class="nf">find_fragments</span><span class="p">(</span><span class="n">mol</span><span class="p">:</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">):</span>
    <span class="n">frags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetBonds</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b</span><span class="o">.</span><span class="n">IsInRing</span><span class="p">():</span>
            <span class="n">frags</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">b</span><span class="o">.</span><span class="n">GetBeginAtomIdx</span><span class="p">(),</span> <span class="n">b</span><span class="o">.</span><span class="n">GetEndAtomIdx</span><span class="p">()})</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">Chem</span><span class="o">.</span><span class="n">GetSymmSSSR</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
            <span class="n">frags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ring</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">frags</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fragment_top1</span><span class="p">(</span><span class="n">smi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scoring_fn</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>
    <span class="n">cands</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">aset</span> <span class="ow">in</span> <span class="n">find_fragments</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
        <span class="n">sub_smi</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">extract_subgraph</span><span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">aset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sub_smi</span><span class="p">:</span> <span class="n">cands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_smi</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cands</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>
    <span class="n">cands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">cands</span><span class="p">))</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">scoring_fn</span><span class="p">(</span><span class="n">cands</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">cands</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">idx</span><span class="p">]))]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">visualize_rationale_on_parent</span><span class="p">(</span><span class="n">parent_smi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rationale_smi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">520</span><span class="p">,</span> <span class="mi">420</span><span class="p">)):</span>
    <span class="n">pm</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">parent_smi</span><span class="p">)</span>
    <span class="n">rm</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">rationale_smi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cannot draw: invalid SMILES.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">GetSubstructMatch</span><span class="p">(</span><span class="n">rm</span><span class="p">)</span>
    <span class="n">hi_atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="k">if</span> <span class="n">match</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">drawer</span> <span class="o">=</span> <span class="n">rdMolDraw2D</span><span class="o">.</span><span class="n">MolDraw2DCairo</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="n">drawer</span><span class="o">.</span><span class="n">drawOptions</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;atomLabelFontSize&quot;</span><span class="p">,</span> <span class="s2">&quot;fontSize&quot;</span><span class="p">,</span> <span class="s2">&quot;scalingFactor&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="n">rdMolDraw2D</span><span class="o">.</span><span class="n">PrepareAndDrawMolecule</span><span class="p">(</span><span class="n">drawer</span><span class="p">,</span> <span class="n">pm</span><span class="p">,</span>
                                       <span class="n">highlightAtoms</span><span class="o">=</span><span class="n">hi_atoms</span> <span class="k">if</span> <span class="n">hi_atoms</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">drawer</span><span class="o">.</span><span class="n">FinishDrawing</span><span class="p">()</span>
    <span class="n">png</span> <span class="o">=</span> <span class="n">drawer</span><span class="o">.</span><span class="n">GetDrawingText</span><span class="p">()</span>
    <span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">png</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Because scoring is done by predicting each subgraph as if it were a standalone molecule, the absolute values (like negative <code class="docutils literal notranslate"><span class="pre">logS</span></code>) may not be directly comparable to the parent’s score. What matters is the <strong>difference (Δ)</strong>: how much the rationale’s score differs from the parent. A positive Δ means the subgraph supports the property; a negative Δ means removing that part lowers the property.</p>
<p>We generate a <strong>summary table</strong> with one rationale (<code class="docutils literal notranslate"><span class="pre">rationale_0</span></code>) for each molecule:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">smiles</span></code>: the original molecule</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logS</span></code> or <code class="docutils literal notranslate"><span class="pre">react_prob</span></code>: the model’s prediction on the full molecule</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rationale_0</span></code>: the SMILES string of the key substructure</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rationale_0_score</span></code>: the model’s prediction on that substructure</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rationale_0_delta</span></code>: the difference between rationale and parent</p></li>
</ul>
<p>Finally, we <strong>visualize the rationale</strong> by highlighting the matching atoms in the parent molecule. This lets us</p>
<section id="solubility-prediction-rationale">
<h3>6.1 Solubility prediction rationale<a class="headerlink" href="#solubility-prediction-rationale" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===== Solubility summary table with top-1 rationale =====</span>
<span class="c1"># Uses your trained mpnn_sol and trainer, and df_sol[&quot;SMILES&quot;]</span>

<span class="n">models_sol</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpnn_sol</span><span class="p">]</span>  <span class="c1"># must be single-task regression</span>
<span class="n">prop_name</span> <span class="o">=</span> <span class="s2">&quot;logS&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">scoring_fn_sol</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">make_prediction</span><span class="p">(</span><span class="n">models_sol</span><span class="p">,</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">smiles_list</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>

<span class="c1"># Build table</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">15</span>  <span class="c1"># how many molecules to summarize</span>
<span class="n">sample_smis</span> <span class="o">=</span> <span class="n">df_sol</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="n">N</span><span class="p">]</span>

<span class="n">rows</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;smiles&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="n">prop_name</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;rationale_0&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;rationale_0_score&quot;</span><span class="p">:</span> <span class="p">[]}</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">sample_smis</span><span class="p">:</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">scoring_fn_sol</span><span class="p">([</span><span class="n">smi</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">rows</span><span class="p">[</span><span class="s2">&quot;smiles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
    <span class="n">rows</span><span class="p">[</span><span class="n">prop_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

    <span class="c1"># size-aware MCTS settings</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()</span> <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">20</span>
    <span class="n">min_atoms</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.30</span> <span class="o">*</span> <span class="n">n</span><span class="p">))</span>
    <span class="n">max_atoms</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_atoms</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.60</span> <span class="o">*</span> <span class="n">n</span><span class="p">))</span>

    <span class="n">rats</span> <span class="o">=</span> <span class="n">run_mcts_for_smiles</span><span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">scoring_fn_sol</span><span class="p">,</span> <span class="n">rollout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">c_puct</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                               <span class="n">min_atoms</span><span class="o">=</span><span class="n">min_atoms</span><span class="p">,</span> <span class="n">max_atoms</span><span class="o">=</span><span class="n">max_atoms</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rats</span><span class="p">:</span>
        <span class="c1"># choose smallest subgraphs, then highest score</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rats</span><span class="p">)</span>
        <span class="n">kept</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rats</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">==</span> <span class="n">ms</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">smiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">kept</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">kept</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">smiles</span>
        <span class="n">r0s</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">kept</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">P</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># fallback to fragment top1</span>
        <span class="n">top1</span> <span class="o">=</span> <span class="n">fragment_top1</span><span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">scoring_fn_sol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">top1</span><span class="p">:</span>
            <span class="n">r0</span><span class="p">,</span> <span class="n">r0s</span> <span class="o">=</span> <span class="n">top1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r0</span><span class="p">,</span> <span class="n">r0s</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">rows</span><span class="p">[</span><span class="s2">&quot;rationale_0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span>
    <span class="n">rows</span><span class="p">[</span><span class="s2">&quot;rationale_0_score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r0s</span><span class="p">)</span>

<span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solubility: built table for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_smis</span><span class="p">)</span><span class="si">}</span><span class="s2"> molecules in </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>



<span class="n">solubility_rationales</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<span class="n">solubility_rationales</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "cd39a9848360459abb0bc30fd40a87e0", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "efec5fcfdb3c4783bb4b88462d89e1e6", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4e41717c076749d69bad393a395a991b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "cab25a78693348c89eab03535498c658", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "75f4a527e5bd4ed4a9a18e28cac90e14", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7a518631b33748a99bee8a4cc0d0ae63", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "bfe08398047e4ff8a7bd9f89a1595861", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "00b9b57fb62643c9a5e9d2d80ad59f41", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f10727b2514542b4b187905374e7f4e1", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "86456643399b430cbd35ca24194a867d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d81285a0cf9f41c0be26bdfc25e21b2c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "92253425b27e4c0bb009cb52d0f1ca02", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "df3942c3611f4f4da3c123bf21a4f92c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c390bec6d4744245b50c0da6608190ad", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "0a1a1e7e524f4849a2e652c09b460097", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9e571274ff164dd5a5b884d0044b55e9", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "0dcc240a0bb84fd1b6a41b0cfe8464b2", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "aa4e06b0df5d4bb5816cac124e39525e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "437438849046481b905920049db04838", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8657d2a9e10a4da8bcb47555d4990993", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "5d9aac0f97ef44e4b9f14f4952da7608", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9392141afbfb4b9f8e44d5fd73351ecf", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4b0e4f056d674dfca0fa128893e8756e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "98b543ec1ac543a6a3f40eaf93dbb7cf", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "bc0254fd67304ea68c738b86c02a48e5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8c01302846424e0094928a6aac9a36de", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "016d590f3c404fadbed2e1184233461d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "2632dd3d1e6b4db2b54c66ba8e67e5b2", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d2369998688a40ca99c220be8dc3cc1f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4170862fa80549daa1915a544a278486", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "aea7217e37db4e22938229b0cc0f6cf8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "941dc9ba1e3e497b8230ceb571aaca60", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "52727726508b402cae8a3f6ab3ac063b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4dec566f97524befa17dec83674ce387", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "2021c14d93f548cbb600c14bec88e40c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "371bec4c2e69409bb90b29d975d80b88", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "fc75527a48dc4a06b31350b96e0caf39", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "1921ed9ab7ff487ebe0004fb982b132d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "fbdb7d37f34f4279bef3977559fdb9d1", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "296a6facc572425ea5a3cd493efefe31", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6eecefb6f76f4f45ae24b9ec6747a948", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "2d53f98fc9a24c629e56f27d14b1f2ed", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "83082d78d9f348feb82c8ec8141b5b9a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4860403312f0440db182b81d8038854a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "808ee37441e44d13b2cb7d5a19a0d69b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "0b5bf0711cfa477cadf0f6392d86ddc5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "47367b872ede4d2b9964b50e4e18c59b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "cefc0fdd6cdf4b04b886f7fc38f44d14", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "abeed990121b473e9c99f1a72db3bad8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a6ef7ac8fda440ebb5f1ac54639cc7e5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d39f8204aad8462093a947bc06d5d3a1", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f940bf9c39be42d3bde34aaff41da122", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "ca9986c4d7ac4da2b4dd79a89c74b037", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "65ef01de03dd4fcc88f1ee9d77d0fe61", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "17223544953f4e3883ee61b5bfcf0da9", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "16322e2075544242b5cc272b6a2330a7", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d7b41bc315b34b59b9621832344825b3", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8006ba072de343119693737d855e38e8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "aa23ef71ae99455a8cef875c1e197113", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "44083eeb95df4f4cb6c7c2df5e36481a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "268eb04302b441628ecc944f27454ecf", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "1812994579f74da5bd0c412f805d7183", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "137b0ff34bc14747a321e745eff06c3d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "704052b4f30043eb82fd3ebee35aa876", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "fb27e91b149b4c24baa453b99b9c1d43", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6c3d9441da474b52b1e1b3da16a7e4e4", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "99761f844a914eed8e9b657ec2058a9c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f85884fa3a7b4cd280ef97287494baf9", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Solubility: built table for 15 molecules in 3.48s
</pre></div>
</div>
<div class="output text_html">
  <div id="df-3c925b9e-6a53-4457-b485-5cce93f299f1" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>smiles</th>
      <th>logS</th>
      <th>rationale_0</th>
      <th>rationale_0_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>c1ccc2c(c1)CCOC2</td>
      <td>-1.195756</td>
      <td>C1C[CH:1]=[CH:1]CO1</td>
      <td>-0.505139</td>
    </tr>
    <tr>
      <th>1</th>
      <td>c1ccc2c(c1)Cc1ccccc1-2</td>
      <td>-1.719822</td>
      <td>c1cc[cH:1][cH:1]c1</td>
      <td>-0.771889</td>
    </tr>
    <tr>
      <th>2</th>
      <td>c1ccc2c(c1)CCCC2</td>
      <td>-1.534268</td>
      <td>C1CC[CH:1]=[CH:1]C1</td>
      <td>-1.092782</td>
    </tr>
    <tr>
      <th>3</th>
      <td>CCc1ccccc1</td>
      <td>-1.301932</td>
      <td>C[CH3:1]</td>
      <td>-0.297537</td>
    </tr>
    <tr>
      <th>4</th>
      <td>C1=CCCCC1</td>
      <td>-1.092782</td>
      <td>C1=CCCCC1</td>
      <td>-1.092782</td>
    </tr>
    <tr>
      <th>5</th>
      <td>C1CCSC1</td>
      <td>-0.878732</td>
      <td>C1CCSC1</td>
      <td>-0.878732</td>
    </tr>
    <tr>
      <th>6</th>
      <td>CN1CCCC1=O</td>
      <td>-0.318836</td>
      <td>O=[CH2:1]</td>
      <td>1.264910</td>
    </tr>
    <tr>
      <th>7</th>
      <td>COCc1ccccc1</td>
      <td>-1.092736</td>
      <td>COC[CH3:1]</td>
      <td>-0.250766</td>
    </tr>
    <tr>
      <th>8</th>
      <td>CCCCN1Cc2ccccc2C1</td>
      <td>-1.399117</td>
      <td>C1[CH:1]=[CH:1]C[NH:1]1</td>
      <td>0.487650</td>
    </tr>
    <tr>
      <th>9</th>
      <td>CCCc1ccccc1</td>
      <td>-1.500662</td>
      <td>C[CH3:1]</td>
      <td>-0.297537</td>
    </tr>
    <tr>
      <th>10</th>
      <td>CCCCCCCCOCc1ccc(OC)cc1</td>
      <td>-2.007931</td>
      <td>c1c[cH:1]cc[cH:1]1</td>
      <td>-0.771889</td>
    </tr>
    <tr>
      <th>11</th>
      <td>CC(C)CCOCc1ccccc1</td>
      <td>-1.739935</td>
      <td>C(O[CH3:1])[CH3:1]</td>
      <td>-0.250766</td>
    </tr>
    <tr>
      <th>12</th>
      <td>CC1=CCCCC1</td>
      <td>-1.427984</td>
      <td>C[CH3:1]</td>
      <td>-0.297537</td>
    </tr>
    <tr>
      <th>13</th>
      <td>CC1=C(C)CCCC1</td>
      <td>-1.500649</td>
      <td>C[CH3:1]</td>
      <td>-0.297537</td>
    </tr>
    <tr>
      <th>14</th>
      <td>C1=CCCC1</td>
      <td>-1.037244</td>
      <td>C1=CCCC1</td>
      <td>-1.037244</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-3c925b9e-6a53-4457-b485-5cce93f299f1')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-3c925b9e-6a53-4457-b485-5cce93f299f1 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-3c925b9e-6a53-4457-b485-5cce93f299f1');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-552c932b-c1a2-4d90-850b-631224f0f6b7">
      <button class="colab-df-quickchart" onclick="quickchart('df-552c932b-c1a2-4d90-850b-631224f0f6b7')"
                title="Suggest charts"
                style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-552c932b-c1a2-4d90-850b-631224f0f6b7 button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

  <div id="id_6d6d7f84-7eba-4086-9750-f97d129e7cfc">
    <style>
      .colab-df-generate {
        background-color: #E8F0FE;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        fill: #1967D2;
        height: 32px;
        padding: 0 0 0 0;
        width: 32px;
      }

      .colab-df-generate:hover {
        background-color: #E2EBFA;
        box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
        fill: #174EA6;
      }

      [theme=dark] .colab-df-generate {
        background-color: #3B4455;
        fill: #D2E3FC;
      }

      [theme=dark] .colab-df-generate:hover {
        background-color: #434B5C;
        box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
        fill: #FFFFFF;
      }
    </style>
    <button class="colab-df-generate" onclick="generateWithVariable('solubility_rationales')"
            title="Generate code using this dataframe."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M7,19H8.4L18.45,9,17,7.55,7,17.6ZM5,21V16.75L18.45,3.32a2,2,0,0,1,2.83,0l1.4,1.43a1.91,1.91,0,0,1,.58,1.4,1.91,1.91,0,0,1-.58,1.4L9.25,21ZM18.45,9,17,7.55Zm-12,3A5.31,5.31,0,0,0,4.9,8.1,5.31,5.31,0,0,0,1,6.5,5.31,5.31,0,0,0,4.9,4.9,5.31,5.31,0,0,0,6.5,1,5.31,5.31,0,0,0,8.1,4.9,5.31,5.31,0,0,0,12,6.5,5.46,5.46,0,0,0,6.5,12Z"/>
  </svg>
    </button>
    <script>
      (() => {
      const buttonEl =
        document.querySelector('#id_6d6d7f84-7eba-4086-9750-f97d129e7cfc button.colab-df-generate');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      buttonEl.onclick = () => {
        google.colab.notebook.generateWithVariable('solubility_rationales');
      }
      })();
    </script>
  </div>

    </div>
  </div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">solubility_rationales</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;rationale_0&quot;</span><span class="p">]):</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">solubility_rationales</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;smiles&quot;</span><span class="p">]</span>
    <span class="n">rat</span>    <span class="o">=</span> <span class="n">solubility_rationales</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;rationale_0&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parent:&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rationale 0:&quot;</span><span class="p">,</span> <span class="n">rat</span><span class="p">,</span> <span class="s2">&quot; score=&quot;</span><span class="p">,</span> <span class="n">solubility_rationales</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;rationale_0_score&quot;</span><span class="p">])</span>
    <span class="n">visualize_rationale_on_parent</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">rat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Parent: c1ccc2c(c1)CCOC2
Rationale 0: C1C[CH:1]=[CH:1]CO1  score= -0.5051385164260864
</pre></div>
</div>
<img alt="_images/820dbc5ef09862386a654df82e550f867676f93fb005d6d74033b2bbcac13254.png" src="_images/820dbc5ef09862386a654df82e550f867676f93fb005d6d74033b2bbcac13254.png" />
</div>
</div>
</section>
<section id="reactivity-prediction-rationale">
<h3>6.2 Reactivity prediction rationale<a class="headerlink" href="#reactivity-prediction-rationale" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===== Reactivity summary table with top-1 rationale =====</span>
<span class="c1"># Uses your trained mpnn_rxn and trainer_rxn, and df_rxn[&quot;SMILES&quot;]</span>

<span class="n">models_rxn</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpnn_rxn</span><span class="p">]</span>     <span class="c1"># single-task binary classification head</span>
<span class="n">trainer_cls</span> <span class="o">=</span> <span class="n">trainer_rxn</span>   <span class="c1"># your classification trainer</span>

<span class="k">def</span><span class="w"> </span><span class="nf">scoring_fn_rxn</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="c1"># predict logits, convert to probabilities with sigmoid</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">make_prediction</span><span class="p">(</span><span class="n">models_rxn</span><span class="p">,</span> <span class="n">trainer_cls</span><span class="p">,</span> <span class="n">smiles_list</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Some builds return probs already; to be safe, apply sigmoid if outside [0,1]</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">preds</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">preds</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">preds</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">preds</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span>

<span class="c1"># Build table</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">sample_smis_rxn</span> <span class="o">=</span> <span class="n">df_rxn</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="n">N</span><span class="p">]</span>

<span class="n">rows_rxn</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;smiles&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;react_prob&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;rationale_0&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;rationale_0_score&quot;</span><span class="p">:</span> <span class="p">[]}</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">sample_smis_rxn</span><span class="p">:</span>
    <span class="n">base_p</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">scoring_fn_rxn</span><span class="p">([</span><span class="n">smi</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">rows_rxn</span><span class="p">[</span><span class="s2">&quot;smiles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
    <span class="n">rows_rxn</span><span class="p">[</span><span class="s2">&quot;react_prob&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_p</span><span class="p">)</span>

    <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()</span> <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">20</span>
    <span class="n">min_atoms</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.30</span> <span class="o">*</span> <span class="n">n</span><span class="p">))</span>
    <span class="n">max_atoms</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_atoms</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.60</span> <span class="o">*</span> <span class="n">n</span><span class="p">))</span>

    <span class="n">rats</span> <span class="o">=</span> <span class="n">run_mcts_for_smiles</span><span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">scoring_fn_rxn</span><span class="p">,</span> <span class="n">rollout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">c_puct</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                               <span class="n">min_atoms</span><span class="o">=</span><span class="n">min_atoms</span><span class="p">,</span> <span class="n">max_atoms</span><span class="o">=</span><span class="n">max_atoms</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rats</span><span class="p">:</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rats</span><span class="p">)</span>
        <span class="n">kept</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rats</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">==</span> <span class="n">ms</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">smiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">kept</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">kept</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">smiles</span>
        <span class="n">r0s</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">kept</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">P</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">top1</span> <span class="o">=</span> <span class="n">fragment_top1</span><span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">scoring_fn_rxn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">top1</span><span class="p">:</span>
            <span class="n">r0</span><span class="p">,</span> <span class="n">r0s</span> <span class="o">=</span> <span class="n">top1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r0</span><span class="p">,</span> <span class="n">r0s</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">rows_rxn</span><span class="p">[</span><span class="s2">&quot;rationale_0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span>
    <span class="n">rows_rxn</span><span class="p">[</span><span class="s2">&quot;rationale_0_score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r0s</span><span class="p">)</span>

<span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reactivity: built table for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_smis_rxn</span><span class="p">)</span><span class="si">}</span><span class="s2"> molecules in </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="n">reactivity_rationales</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows_rxn</span><span class="p">)</span>
<span class="n">reactivity_rationales</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "353a59f6af4a4bdca43f866abda7645b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a867efed77d14ccca46a102cc5ad4d81", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "71a992156fb2485e9f08bdaac86b05dc", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "00c5a74b9cbd49fc82f90380268debc8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "36edc1586a6a451cbfbfe95145c51da6", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "669a4abcc4904f7dae541a8a388d5bd4", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "30f13cac96304fca8656780bc70263c5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7d9dca023d774054ba5158436a97a184", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "740efc4c32ed449ea0e2fc179084375b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "75a5591f0c5142c9b56b3a6f1103b5a0", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6a70e5a07a2e4bc3b539dfe96dcb1f2a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "3aeee6ece8c940bd99e461fe570cecbc", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9b3fa09723294d47998d3f247aed1ead", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "83c59f48f0454c3fba845f1d3fdda6c3", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "b3aaf069aab64e20a1779e77b101935d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8c21db627b714e00bd292be89019cd79", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "bda0bf8fbeb7409e9100027367aba1cc", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "1b83beb98a12422cae55ceb446ae468e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "db4264189de34ebfba16996cc354c7d6", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "709ad35d1a0b460584299b739206ad73", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "92c792f67cb240ef80e1072457200512", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "93f1d36c183a494fb2935d4429bbec14", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "2b3a17045a174b32b1d3d33f2944a49f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "19ea86b3119d451d9a9da6905d5fd2e6", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "b34ed067dc094730b73455d0a08786d7", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "bb6da5ca7bab4e4693cbcc5abd2a1d29", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f332bb103d3b43ab8f6a35be3e2421a5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "88a9b26130584825b0d2eb42f8696cb8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e69af127e9374c97acf225f4f553461e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d037f85993ac495487ed97ddc49d60c5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "889a12bd47754c6ea655bcd5305555e3", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "ff74298b07b04ff69473dfd98449c787", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "97b346717642435085a5eaa30074d09a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d41723ba44f7411b868820b80c2b8d88", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a3d81fa591534d9a9084b8ccba121042", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "571f964e32d74e8fba236f47c6820eb8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c9bb7ce7e3db44f8ade2d23a7e356e29", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "aa61b9be17c14da29ace77ba9c586171", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4f5dc2eece6343399a28dbd23d04cc75", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c4a18ef1567f4e77a21da1dc01a6bb70", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "34d51f821fe24b6b8aba9ae1fd4e4760", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "02c4c9fe948942788b5a894f3d8bb4b5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "0339352674c245c995ee635dbf3e617e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "79c6b231ee894481b9a657b8a1e50844", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f8c6dc41e8644ebbb687cc10fe32b103", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f9acc58c9b8d4b9f8c96a5635003f618", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "841934827d1345478cdae8913a04cf8a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6f40d5eb99534d78848bedd899e16c8c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "63d3a10cd02649e594711e96cc3743df", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7fccf81f744047b3a80d25b29fc4b5ed", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7d3a7c29fa574e71a2c8773c98e5104a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f9863f81374e4f53a661d6643452ef0e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8d6e83dc360f4887a52f0f2c8120c5de", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "881b4f26064f4f1ba3864563c7b87184", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9ecfcd9613e448489dca0d480b6a59c5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "fda7f030a5e14393a5d3542926b21380", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "343bc20c706e4da197a21356e18bf523", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4bad2030860f4d36882aff59ead0fa74", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "3eddf6e1e2aa4242a36500bbaa54e4db", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4a2fc67edd9e48e2b5a571611e9a7fc4", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7fe3da248ac64458bad67836147cad9d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c7dbf436f5a848ed99b9e6f90a732dd1", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "99e523de06074024b5514b1c789ecb0b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8d160ea0d0504fd6a799801690edd954", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "143e57d6f2d647c8848ce472ffaeb81e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "71dec17fa2e745c2ac049742a01a85b5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "123928601a51465db3712708d6643e63", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f6e9406c6b01438fbbdc1b09f2d385d5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "17bd15a9d92b4c669904229adf2f4057", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "0d3afb216daa414698804fd11afcc1b9", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9f94c2c1bc804d50aa7e0fc7838f1fae", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "3cccd238a15a485e96a069e15f38f4d5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4741ef0fde3c4f879c6271c99c2f1656", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c812c02c14be45f5b52527b4adf6495f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "ab46a715962e4f07a1ec4cd866b48dd5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e80f176aa6794fca8feddf48aa75bb50", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c8fc1636af3c4685b752ddee9e6dd879", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "be60b72f22ab49e1a5db8911997826f3", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "540af5c4169f40a193962f9a4f50d702", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8171d245da7946419c42c9a712ac6d84", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "38254c88db4e4f588751c51b50b86b3b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "150265615d20458ea1456d29eb7736eb", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "51d002e0ed034d62abe564c7485eecd0", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6faad918486f4e4fa8ad5f7fb746b654", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "aeab7faaa83d4160a205564e6b625af8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "0c3c0453a54e4ebb8f969ac042a0b5bc", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "02fd8b4ec06d4ab3a08a5556bb4fd3ef", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "750b881311254a0b88c4177f5bc48415", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6cc8a382933d4f7498accf58428f0124", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6abcd065b2fb400da1cb30ae1808ccbe", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "638eee206f4b42e6b11a3ae937df4564", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f2f69267c8f1490ea5546570dfe4ecf2", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "92917be049e54431986c2543429ecf23", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "495c6c9313be435a93b11e408de021bf", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "90a32904176f453d987cce4c99f84e4b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "b8d8ae1da3ec477a86082934cf5eed1e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6ce0d38d7b624b72990fe9e560bf39de", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "4fcc3184bdd04286b3604bea957362de", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "00a619c973b84351997122ed2a431ed5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "09f31af5f2084af3ac18f976bf5baf7e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "29376828858a4274b1787267dc0249f8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "2b100b0693e148bcb3aa1dac6acd33bc", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6854ad72099d4baa837337c5ba91bff3", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "24d25716071d4b2cbd80e52a3d16b90b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "22be3c9ec08c457cab514d98d70aa58a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "dabded64ba0941eeb8fa98aab4e4eac0", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "fb4457a6b82e469e873171c5736baa21", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "ea17ee33e5e34f268d5e873c71f047aa", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "b12873672e9d43acb411e2cffbe2e68d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "bd6f32419f4c4466af73508cce16e208", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "b84816eaa2694d88b18a28d72f99ad09", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "2447ba67c97d4b199200602cc97cc30c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "896f4d4159e7440bacc0cd171e96b0ed", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "0fbd36374aff4029a0b3f354e61b4aa5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e00d2097abdb49a28447f4882cb38538", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "834dea6fadd349ff9ae608d8fd3c5c6b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "1c949f8af7a54742bbc64354695fd285", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "11adca9a9b1a4231b601d0613c4b247e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "e3e1445cad6c49a586cf92f74ad2210c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "2c3d5223f62e4d7aa60a6a277b5abdc8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "b65669a3655d436db21597c705965b94", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "983b3d882b3c4f00b985b2f329b1c87b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "64490c7e974c429f971d10baef930f13", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "0e5632478ded413f843c82e66a7e531e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c99730b829fb421f9eb08419d566831b", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "6b8dba5db3fd4738a34ebe18aa10e64d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7a9de9731545467ba3d10639845e3b79", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "74f8d0b1991a4fb889edd5355948db0d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "715072687b574f1c95fbf2b8144b6ccc", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "ef3849316886488a8c2b0b3a1331d860", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7c7a2d7c17d247ed83d0051773a32b11", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "81931bc946f5461a8c7b8fbb7ac5b42a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "c54c4d41d2bc49c08018426399bacd29", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a142416ff3c3465a9713da5a18d1ac11", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "5424eccc1d8b4c0d86b6179d486d014c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9c96dd0f58644131b136440a37d368b9", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "74b11ec419384853a1bf77dc61fd3025", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "8155124b7f8847f3b42b91180737cb97", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "80836b7ca12d4edd8395f040ca471734", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "7dd629ee08844266acf72d97d6447349", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f4c35c490bd54dfdb8406b8af2a8fc65", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "f7ccdc5192ce49d7986ff3bfc9c2baec", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "92e1a70387d8484ca8708565cd0fa304", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "76fc3216540e49a489401115e79dfae3", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "01aa6df81b504f2bb63ef8e2fec49a0f", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Reactivity: built table for 15 molecules in 6.96s
</pre></div>
</div>
<div class="output text_html">
  <div id="df-74a097f9-5205-4f3a-bb53-ceec6bad0f2c" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>smiles</th>
      <th>react_prob</th>
      <th>rationale_0</th>
      <th>rationale_0_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>c1ccc2c(c1)CCOC2</td>
      <td>0.944441</td>
      <td>C1C[CH:1]=[CH:1]CO1</td>
      <td>0.916721</td>
    </tr>
    <tr>
      <th>1</th>
      <td>c1ccc2c(c1)Cc1ccccc1-2</td>
      <td>0.867228</td>
      <td>C1[CH:1]=[CH:1][CH:1]=[CH:1]1</td>
      <td>0.841032</td>
    </tr>
    <tr>
      <th>2</th>
      <td>c1ccc2c(c1)CCCC2</td>
      <td>0.966502</td>
      <td>C1CC[CH:1]=[CH:1]C1</td>
      <td>0.960123</td>
    </tr>
    <tr>
      <th>3</th>
      <td>CCc1ccccc1</td>
      <td>0.908582</td>
      <td>c1cc[cH:1]cc1</td>
      <td>0.825776</td>
    </tr>
    <tr>
      <th>4</th>
      <td>C1=CCCCC1</td>
      <td>0.960123</td>
      <td>C1=CCCCC1</td>
      <td>0.960123</td>
    </tr>
    <tr>
      <th>5</th>
      <td>C1CCSC1</td>
      <td>0.963128</td>
      <td>C1CCSC1</td>
      <td>0.963128</td>
    </tr>
    <tr>
      <th>6</th>
      <td>CN1CCCC1=O</td>
      <td>0.877834</td>
      <td>C1C[CH2:1][NH:1]C1</td>
      <td>0.958719</td>
    </tr>
    <tr>
      <th>7</th>
      <td>COCc1ccccc1</td>
      <td>0.876020</td>
      <td>COC[CH3:1]</td>
      <td>0.841456</td>
    </tr>
    <tr>
      <th>8</th>
      <td>CCCCN1Cc2ccccc2C1</td>
      <td>0.945808</td>
      <td>CCC[CH3:1]</td>
      <td>0.916729</td>
    </tr>
    <tr>
      <th>9</th>
      <td>CCCc1ccccc1</td>
      <td>0.923266</td>
      <td>CCC[CH3:1]</td>
      <td>0.916729</td>
    </tr>
    <tr>
      <th>10</th>
      <td>CCCCCCCCOCc1ccc(OC)cc1</td>
      <td>0.920641</td>
      <td>C(CC[CH3:1])C[CH3:1]</td>
      <td>0.949148</td>
    </tr>
    <tr>
      <th>11</th>
      <td>CC(C)CCOCc1ccccc1</td>
      <td>0.906913</td>
      <td>C[CH2:1]C[CH3:1]</td>
      <td>0.916729</td>
    </tr>
    <tr>
      <th>12</th>
      <td>CC1=CCCCC1</td>
      <td>0.958145</td>
      <td>C1=[CH:1]CCCC1</td>
      <td>0.960123</td>
    </tr>
    <tr>
      <th>13</th>
      <td>CC1=C(C)CCCC1</td>
      <td>0.955647</td>
      <td>C1CC[CH:1]=[CH:1]C1</td>
      <td>0.960123</td>
    </tr>
    <tr>
      <th>14</th>
      <td>C1=CCCC1</td>
      <td>0.952870</td>
      <td>C1=CCCC1</td>
      <td>0.952870</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-74a097f9-5205-4f3a-bb53-ceec6bad0f2c')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-74a097f9-5205-4f3a-bb53-ceec6bad0f2c button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-74a097f9-5205-4f3a-bb53-ceec6bad0f2c');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-20245df4-fa4a-43da-ada4-52cec9c5bff4">
      <button class="colab-df-quickchart" onclick="quickchart('df-20245df4-fa4a-43da-ada4-52cec9c5bff4')"
                title="Suggest charts"
                style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-20245df4-fa4a-43da-ada4-52cec9c5bff4 button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

  <div id="id_942c119d-e3b0-4c84-8dc3-df36fa23cb61">
    <style>
      .colab-df-generate {
        background-color: #E8F0FE;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        fill: #1967D2;
        height: 32px;
        padding: 0 0 0 0;
        width: 32px;
      }

      .colab-df-generate:hover {
        background-color: #E2EBFA;
        box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
        fill: #174EA6;
      }

      [theme=dark] .colab-df-generate {
        background-color: #3B4455;
        fill: #D2E3FC;
      }

      [theme=dark] .colab-df-generate:hover {
        background-color: #434B5C;
        box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
        fill: #FFFFFF;
      }
    </style>
    <button class="colab-df-generate" onclick="generateWithVariable('reactivity_rationales')"
            title="Generate code using this dataframe."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M7,19H8.4L18.45,9,17,7.55,7,17.6ZM5,21V16.75L18.45,3.32a2,2,0,0,1,2.83,0l1.4,1.43a1.91,1.91,0,0,1,.58,1.4,1.91,1.91,0,0,1-.58,1.4L9.25,21ZM18.45,9,17,7.55Zm-12,3A5.31,5.31,0,0,0,4.9,8.1,5.31,5.31,0,0,0,1,6.5,5.31,5.31,0,0,0,4.9,4.9,5.31,5.31,0,0,0,6.5,1,5.31,5.31,0,0,0,8.1,4.9,5.31,5.31,0,0,0,12,6.5,5.46,5.46,0,0,0,6.5,12Z"/>
  </svg>
    </button>
    <script>
      (() => {
      const buttonEl =
        document.querySelector('#id_942c119d-e3b0-4c84-8dc3-df36fa23cb61 button.colab-df-generate');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      buttonEl.onclick = () => {
        google.colab.notebook.generateWithVariable('reactivity_rationales');
      }
      })();
    </script>
  </div>

    </div>
  </div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">reactivity_rationales</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;rationale_0&quot;</span><span class="p">]):</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">reactivity_rationales</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;smiles&quot;</span><span class="p">]</span>
    <span class="n">rat</span>    <span class="o">=</span> <span class="n">reactivity_rationales</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;rationale_0&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parent:&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rationale 0:&quot;</span><span class="p">,</span> <span class="n">rat</span><span class="p">,</span> <span class="s2">&quot; score=&quot;</span><span class="p">,</span> <span class="n">reactivity_rationales</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;rationale_0_score&quot;</span><span class="p">])</span>
    <span class="n">visualize_rationale_on_parent</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">rat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Parent: c1ccc2c(c1)CCOC2
Rationale 0: C1C[CH:1]=[CH:1]CO1  score= 0.9167211055755615
</pre></div>
</div>
<img alt="_images/820dbc5ef09862386a654df82e550f867676f93fb005d6d74033b2bbcac13254.png" src="_images/820dbc5ef09862386a654df82e550f867676f93fb005d6d74033b2bbcac13254.png" />
</div>
</div>
</section>
</section>
<section id="chemprop-cli-command-line-interface">
<h2>7. Chemprop CLI (Command-Line Interface)<a class="headerlink" href="#chemprop-cli-command-line-interface" title="Link to this heading">#</a></h2>
<p>Prepare a minimal CSV: <code class="docutils literal notranslate"><span class="pre">SMILES,Melting</span> <span class="pre">Point</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load data and write a small CSV</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/zzhenglab/ai4chem/main/book/_data/C_H_oxidation_dataset.csv&quot;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">reg_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span> <span class="s2">&quot;Melting Point&quot;</span><span class="p">]</span>
<span class="n">df_reg</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">reg_cols</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_reg</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-667dd665-7d1a-4757-8741-8073f327cbff" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SMILES</th>
      <th>Melting Point</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>c1ccc2c(c1)CCOC2</td>
      <td>65.8</td>
    </tr>
    <tr>
      <th>1</th>
      <td>c1ccc2c(c1)Cc1ccccc1-2</td>
      <td>90.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>c1ccc2c(c1)CCCC2</td>
      <td>69.4</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-667dd665-7d1a-4757-8741-8073f327cbff')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-667dd665-7d1a-4757-8741-8073f327cbff button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-667dd665-7d1a-4757-8741-8073f327cbff');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-e1771908-9b0f-4304-ba13-b92b34fe009a">
      <button class="colab-df-quickchart" onclick="quickchart('df-e1771908-9b0f-4304-ba13-b92b34fe009a')"
                title="Suggest charts"
                style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-e1771908-9b0f-4304-ba13-b92b34fe009a button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

    </div>
  </div>
</div></div>
</div>
<p>Save to disk for Chemprop CLI.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_reg</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;mp_data.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">df_reg</span><span class="p">),</span> <span class="n">df_reg</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(575,
                    SMILES  Melting Point
 0        c1ccc2c(c1)CCOC2           65.8
 1  c1ccc2c(c1)Cc1ccccc1-2           90.0)
</pre></div>
</div>
</div>
</div>
<p>Train a <strong>small</strong> model so it runs in class. We log common metrics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>chemprop<span class="w"> </span>train<span class="w"> </span><span class="err">\</span>
  <span class="o">--</span><span class="n">data</span><span class="o">-</span><span class="n">path</span> <span class="n">mp_data</span><span class="o">.</span><span class="n">csv</span> \
  <span class="o">-</span><span class="n">t</span> <span class="n">regression</span> \
  <span class="o">-</span><span class="n">s</span> <span class="n">SMILES</span> \
  <span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">columns</span> <span class="s2">&quot;Melting Point&quot;</span> \
  <span class="o">-</span><span class="n">o</span> <span class="n">mp_model</span> \
  <span class="o">--</span><span class="n">num</span><span class="o">-</span><span class="n">replicates</span> <span class="mi">1</span> \
  <span class="o">--</span><span class="n">epochs</span> <span class="mi">100</span> \
  <span class="o">--</span><span class="n">save</span><span class="o">-</span><span class="n">smiles</span><span class="o">-</span><span class="n">splits</span> \
  <span class="o">--</span><span class="n">metrics</span> <span class="n">mae</span> <span class="n">rmse</span> <span class="n">r2</span> \
  <span class="o">--</span><span class="n">tracking</span><span class="o">-</span><span class="n">metric</span> <span class="n">r2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-09-21T02:36:17 - INFO:chemprop.cli.main - Running in mode &#39;train&#39; with args: {&#39;smiles_columns&#39;: [&#39;SMILES&#39;], &#39;reaction_columns&#39;: None, &#39;no_header_row&#39;: False, &#39;num_workers&#39;: 0, &#39;batch_size&#39;: 64, &#39;accelerator&#39;: &#39;auto&#39;, &#39;devices&#39;: &#39;auto&#39;, &#39;rxn_mode&#39;: &#39;REAC_DIFF&#39;, &#39;multi_hot_atom_featurizer_mode&#39;: &#39;V2&#39;, &#39;keep_h&#39;: False, &#39;add_h&#39;: False, &#39;ignore_stereo&#39;: False, &#39;reorder_atoms&#39;: False, &#39;molecule_featurizers&#39;: None, &#39;descriptors_path&#39;: None, &#39;descriptors_columns&#39;: None, &#39;no_descriptor_scaling&#39;: False, &#39;no_atom_feature_scaling&#39;: False, &#39;no_atom_descriptor_scaling&#39;: False, &#39;no_bond_feature_scaling&#39;: False, &#39;no_bond_descriptor_scaling&#39;: False, &#39;atom_features_path&#39;: None, &#39;atom_descriptors_path&#39;: None, &#39;bond_features_path&#39;: None, &#39;bond_descriptors_path&#39;: None, &#39;constraints_path&#39;: None, &#39;constraints_to_targets&#39;: None, &#39;use_cuikmolmaker_featurization&#39;: False, &#39;config_path&#39;: None, &#39;data_path&#39;: PosixPath(&#39;mp_data.csv&#39;), &#39;output_dir&#39;: PosixPath(&#39;mp_model&#39;), &#39;remove_checkpoints&#39;: False, &#39;checkpoint&#39;: None, &#39;freeze_encoder&#39;: False, &#39;model_frzn&#39;: None, &#39;frzn_ffn_layers&#39;: 0, &#39;from_foundation&#39;: None, &#39;ensemble_size&#39;: 1, &#39;message_hidden_dim&#39;: 300, &#39;message_bias&#39;: False, &#39;depth&#39;: 3, &#39;undirected&#39;: False, &#39;dropout&#39;: 0.0, &#39;mpn_shared&#39;: False, &#39;aggregation&#39;: &#39;norm&#39;, &#39;aggregation_norm&#39;: 100, &#39;atom_messages&#39;: False, &#39;activation&#39;: &#39;RELU&#39;, &#39;activation_args&#39;: None, &#39;ffn_hidden_dim&#39;: 300, &#39;ffn_num_layers&#39;: 1, &#39;batch_norm&#39;: False, &#39;multiclass_num_classes&#39;: 3, &#39;atom_task_weights&#39;: None, &#39;atom_ffn_hidden_dim&#39;: 300, &#39;atom_ffn_num_layers&#39;: 1, &#39;atom_multiclass_num_classes&#39;: 3, &#39;bond_task_weights&#39;: None, &#39;bond_ffn_hidden_dim&#39;: 300, &#39;bond_ffn_num_layers&#39;: 1, &#39;bond_multiclass_num_classes&#39;: 3, &#39;atom_constrainer_ffn_hidden_dim&#39;: 300, &#39;atom_constrainer_ffn_num_layers&#39;: 1, &#39;bond_constrainer_ffn_hidden_dim&#39;: 300, &#39;bond_constrainer_ffn_num_layers&#39;: 1, &#39;weight_column&#39;: None, &#39;target_columns&#39;: [&#39;Melting Point&#39;], &#39;mol_target_columns&#39;: None, &#39;atom_target_columns&#39;: None, &#39;bond_target_columns&#39;: None, &#39;ignore_columns&#39;: None, &#39;no_cache&#39;: False, &#39;splits_column&#39;: None, &#39;task_type&#39;: &#39;regression&#39;, &#39;loss_function&#39;: None, &#39;v_kl&#39;: 0.0, &#39;eps&#39;: 1e-08, &#39;alpha&#39;: 0.1, &#39;metrics&#39;: [&#39;mae&#39;, &#39;rmse&#39;, &#39;r2&#39;], &#39;tracking_metric&#39;: &#39;r2&#39;, &#39;show_individual_scores&#39;: False, &#39;task_weights&#39;: None, &#39;warmup_epochs&#39;: 2, &#39;init_lr&#39;: 0.0001, &#39;max_lr&#39;: 0.001, &#39;final_lr&#39;: 0.0001, &#39;epochs&#39;: 100, &#39;patience&#39;: None, &#39;grad_clip&#39;: None, &#39;class_balance&#39;: False, &#39;split&#39;: &#39;RANDOM&#39;, &#39;split_sizes&#39;: [0.8, 0.1, 0.1], &#39;split_key_molecule&#39;: 0, &#39;num_replicates&#39;: 1, &#39;num_folds&#39;: None, &#39;save_smiles_splits&#39;: True, &#39;splits_file&#39;: None, &#39;data_seed&#39;: 0, &#39;pytorch_seed&#39;: None}
Wrote config file to mp_model/config.toml
2025-09-21T02:36:17 - INFO:chemprop.cli.train - Pulling data from file: mp_data.csv
2025-09-21T02:36:17 - WARNING:chemprop.data.splitting - The return type of make_split_indices has changed in v2.1 - see help(make_split_indices)
2025-09-21T02:36:17 - INFO:chemprop.cli.train - train/val/test split_0 sizes: [460, 57, 58]
2025-09-21T02:36:17 - INFO:chemprop.cli.train - 
         Summary of Training Data          
┏━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━┓
┃       Statistic ┃ Value (Melting Point) ┃
┡━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━┩
│     Num. smiles │                   460 │
│    Num. targets │                   460 │
│        Num. NaN │                     0 │
│            Mean │                   133 │
│       Std. dev. │                  51.2 │
│          Median │                   129 │
│ % within 1 s.d. │                   75% │
│ % within 2 s.d. │                   96% │
└─────────────────┴───────────────────────┘

2025-09-21T02:36:17 - INFO:chemprop.cli.train - 
        Summary of Validation Data         
┏━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━┓
┃       Statistic ┃ Value (Melting Point) ┃
┡━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━┩
│     Num. smiles │                    57 │
│    Num. targets │                    57 │
│        Num. NaN │                     0 │
│            Mean │                   123 │
│       Std. dev. │                  43.9 │
│          Median │                   124 │
│ % within 1 s.d. │                   67% │
│ % within 2 s.d. │                   96% │
└─────────────────┴───────────────────────┘

2025-09-21T02:36:17 - INFO:chemprop.cli.train - 
           Summary of Test Data            
┏━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━┓
┃       Statistic ┃ Value (Melting Point) ┃
┡━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━┩
│     Num. smiles │                    58 │
│    Num. targets │                    58 │
│        Num. NaN │                     0 │
│            Mean │                   130 │
│       Std. dev. │                  50.1 │
│          Median │                   117 │
│ % within 1 s.d. │                   79% │
│ % within 2 s.d. │                   93% │
└─────────────────┴───────────────────────┘

2025-09-21T02:36:17 - INFO:chemprop.cli.train - Train data: mean = [133.13913042] | std = [51.15911504]
2025-09-21T02:36:17 - INFO:chemprop.cli.train - Caching training and validation datasets...
2025-09-21T02:36:18 - INFO:chemprop.cli.train - No loss function was specified! Using class default: &lt;class &#39;chemprop.nn.metrics.MSE&#39;&gt;
2025-09-21T02:36:18 - INFO:chemprop.cli.train - MPNN(
  (message_passing): BondMessagePassing(
    (W_i): Linear(in_features=86, out_features=300, bias=False)
    (W_h): Linear(in_features=300, out_features=300, bias=False)
    (W_o): Linear(in_features=372, out_features=300, bias=True)
    (dropout): Dropout(p=0.0, inplace=False)
    (tau): ReLU()
    (V_d_transform): Identity()
    (graph_transform): GraphTransform(
      (V_transform): Identity()
      (E_transform): Identity()
    )
  )
  (agg): NormAggregation()
  (bn): Identity()
  (predictor): RegressionFFN(
    (ffn): MLP(
      (0): Sequential(
        (0): Linear(in_features=300, out_features=300, bias=True)
      )
      (1): Sequential(
        (0): ReLU()
        (1): Dropout(p=0.0, inplace=False)
        (2): Linear(in_features=300, out_features=1, bias=True)
      )
    )
    (criterion): MSE(task_weights=[[1.0]])
    (output_transform): UnscaleTransform()
  )
  (X_d_transform): Identity()
  (metrics): ModuleList(
    (0): MAE(task_weights=[[1.0]])
    (1): RMSE(task_weights=[[1.0]])
    (2): R2Score()
    (3): MSE(task_weights=[[1.0]])
  )
)
GPU available: False, used: False
TPU available: False, using: 0 TPU cores
HPU available: False, using: 0 HPUs
2025-09-21 02:36:19.170674: E external/local_xla/xla/stream_executor/cuda/cuda_fft.cc:467] Unable to register cuFFT factory: Attempting to register factory for plugin cuFFT when one has already been registered
WARNING: All log messages before absl::InitializeLog() is called are written to STDERR
E0000 00:00:1758422179.210367   58576 cuda_dnn.cc:8579] Unable to register cuDNN factory: Attempting to register factory for plugin cuDNN when one has already been registered
E0000 00:00:1758422179.222474   58576 cuda_blas.cc:1407] Unable to register cuBLAS factory: Attempting to register factory for plugin cuBLAS when one has already been registered
W0000 00:00:1758422179.251528   58576 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
W0000 00:00:1758422179.251595   58576 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
W0000 00:00:1758422179.251605   58576 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
W0000 00:00:1758422179.251613   58576 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
2025-09-21 02:36:19.259832: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
/usr/local/lib/python3.12/dist-packages/lightning/pytorch/callbacks/model_checkpoint.py:751: Checkpoint directory /content/mp_model/model_0/checkpoints exists and is not empty.
Loading `train_dataloader` to estimate number of stepping batches.
/usr/local/lib/python3.12/dist-packages/lightning/pytorch/loops/fit_loop.py:310: The number of training batches (8) is smaller than the logging interval Trainer(log_every_n_steps=50). Set a lower value for log_every_n_steps if you want to see logs for the training epoch.

  | Name            | Type               | Params | Mode 
---------------------------------------------------------------
0 | message_passing | BondMessagePassing | 227 K  | train
1 | agg             | NormAggregation    | 0      | train
2 | bn              | Identity           | 0      | train
3 | predictor       | RegressionFFN      | 90.6 K | train
4 | X_d_transform   | Identity           | 0      | train
5 | metrics         | ModuleList         | 0      | train
---------------------------------------------------------------
318 K     Trainable params
0         Non-trainable params
318 K     Total params
1.273     Total estimated model params size (MB)
27        Modules in train mode
0         Modules in eval mode
/usr/local/lib/python3.12/dist-packages/lightning/pytorch/core/saving.py:363: Skipping &#39;metrics&#39; parameter because it is not possible to safely dump to YAML.
Epoch 0: 100% 8/8 [00:01&lt;00:00,  7.54it/s, v_num=3, train_loss_step=0.551]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.31it/s]
Epoch 1: 100% 8/8 [00:01&lt;00:00,  7.80it/s, v_num=3, train_loss_step=1.150, val_loss=0.797, train_loss_epoch=0.986]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.24it/s]
Epoch 2: 100% 8/8 [00:01&lt;00:00,  7.85it/s, v_num=3, train_loss_step=0.346, val_loss=0.800, train_loss_epoch=0.898]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.55it/s]
Epoch 3: 100% 8/8 [00:01&lt;00:00,  7.86it/s, v_num=3, train_loss_step=0.496, val_loss=0.766, train_loss_epoch=0.821]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.17it/s]
Epoch 4: 100% 8/8 [00:01&lt;00:00,  7.86it/s, v_num=3, train_loss_step=0.481, val_loss=0.651, train_loss_epoch=0.757]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.50it/s]
Epoch 5: 100% 8/8 [00:01&lt;00:00,  7.83it/s, v_num=3, train_loss_step=0.368, val_loss=0.709, train_loss_epoch=0.718]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.00it/s]
Epoch 6: 100% 8/8 [00:01&lt;00:00,  7.88it/s, v_num=3, train_loss_step=0.544, val_loss=0.540, train_loss_epoch=0.605]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.23it/s]
Epoch 7: 100% 8/8 [00:01&lt;00:00,  5.59it/s, v_num=3, train_loss_step=0.953, val_loss=0.487, train_loss_epoch=0.582]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.82it/s]
Epoch 8: 100% 8/8 [00:01&lt;00:00,  5.23it/s, v_num=3, train_loss_step=1.650, val_loss=0.631, train_loss_epoch=0.564]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.69it/s]
Epoch 9: 100% 8/8 [00:01&lt;00:00,  7.39it/s, v_num=3, train_loss_step=1.360, val_loss=0.472, train_loss_epoch=0.494]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.47it/s]
Epoch 10: 100% 8/8 [00:01&lt;00:00,  7.92it/s, v_num=3, train_loss_step=0.110, val_loss=0.411, train_loss_epoch=0.527]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  9.37it/s]
Epoch 11: 100% 8/8 [00:01&lt;00:00,  7.77it/s, v_num=3, train_loss_step=0.214, val_loss=0.422, train_loss_epoch=0.424]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.64it/s]
Epoch 12: 100% 8/8 [00:01&lt;00:00,  7.87it/s, v_num=3, train_loss_step=0.253, val_loss=0.436, train_loss_epoch=0.385]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.50it/s]
Epoch 13: 100% 8/8 [00:01&lt;00:00,  7.80it/s, v_num=3, train_loss_step=0.470, val_loss=0.372, train_loss_epoch=0.371]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.56it/s]
Epoch 14: 100% 8/8 [00:01&lt;00:00,  7.82it/s, v_num=3, train_loss_step=0.608, val_loss=0.323, train_loss_epoch=0.338]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.19it/s]
Epoch 15: 100% 8/8 [00:00&lt;00:00,  8.01it/s, v_num=3, train_loss_step=0.187, val_loss=0.376, train_loss_epoch=0.326]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.43it/s]
Epoch 16: 100% 8/8 [00:01&lt;00:00,  7.98it/s, v_num=3, train_loss_step=0.254, val_loss=0.310, train_loss_epoch=0.301]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.69it/s]
Epoch 17: 100% 8/8 [00:01&lt;00:00,  6.99it/s, v_num=3, train_loss_step=0.292, val_loss=0.325, train_loss_epoch=0.288]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.84it/s]
Epoch 18: 100% 8/8 [00:01&lt;00:00,  5.05it/s, v_num=3, train_loss_step=0.365, val_loss=0.292, train_loss_epoch=0.267]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.69it/s]
Epoch 19: 100% 8/8 [00:01&lt;00:00,  6.34it/s, v_num=3, train_loss_step=0.197, val_loss=0.279, train_loss_epoch=0.246]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  9.83it/s]
Epoch 20: 100% 8/8 [00:01&lt;00:00,  7.73it/s, v_num=3, train_loss_step=0.189, val_loss=0.255, train_loss_epoch=0.249]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  8.63it/s]
Epoch 21: 100% 8/8 [00:01&lt;00:00,  7.54it/s, v_num=3, train_loss_step=0.263, val_loss=0.268, train_loss_epoch=0.249]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  9.76it/s]
Epoch 22: 100% 8/8 [00:01&lt;00:00,  7.68it/s, v_num=3, train_loss_step=0.206, val_loss=0.375, train_loss_epoch=0.216]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.12it/s]
Epoch 23: 100% 8/8 [00:01&lt;00:00,  7.78it/s, v_num=3, train_loss_step=0.177, val_loss=0.242, train_loss_epoch=0.235]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  9.89it/s]
Epoch 24: 100% 8/8 [00:01&lt;00:00,  7.77it/s, v_num=3, train_loss_step=0.287, val_loss=0.232, train_loss_epoch=0.215]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.54it/s]
Epoch 25: 100% 8/8 [00:01&lt;00:00,  7.97it/s, v_num=3, train_loss_step=0.0736, val_loss=0.227, train_loss_epoch=0.207]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.53it/s]
Epoch 26: 100% 8/8 [00:01&lt;00:00,  7.84it/s, v_num=3, train_loss_step=0.166, val_loss=0.309, train_loss_epoch=0.226]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.26it/s]
Epoch 27: 100% 8/8 [00:00&lt;00:00,  8.03it/s, v_num=3, train_loss_step=0.0895, val_loss=0.278, train_loss_epoch=0.197]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.52it/s]
Epoch 28: 100% 8/8 [00:01&lt;00:00,  5.37it/s, v_num=3, train_loss_step=0.0522, val_loss=0.233, train_loss_epoch=0.194]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.79it/s]
Epoch 29: 100% 8/8 [00:01&lt;00:00,  5.36it/s, v_num=3, train_loss_step=0.290, val_loss=0.224, train_loss_epoch=0.178]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.01it/s]
Epoch 30: 100% 8/8 [00:01&lt;00:00,  7.82it/s, v_num=3, train_loss_step=0.250, val_loss=0.219, train_loss_epoch=0.173]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.35it/s]
Epoch 31: 100% 8/8 [00:01&lt;00:00,  7.94it/s, v_num=3, train_loss_step=0.137, val_loss=0.240, train_loss_epoch=0.198]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  8.97it/s]
Epoch 32: 100% 8/8 [00:01&lt;00:00,  7.92it/s, v_num=3, train_loss_step=0.247, val_loss=0.279, train_loss_epoch=0.186]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.40it/s]
Epoch 33: 100% 8/8 [00:01&lt;00:00,  7.54it/s, v_num=3, train_loss_step=0.232, val_loss=0.240, train_loss_epoch=0.180]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.43it/s]
Epoch 34: 100% 8/8 [00:01&lt;00:00,  7.82it/s, v_num=3, train_loss_step=0.217, val_loss=0.224, train_loss_epoch=0.166]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.15it/s]
Epoch 35: 100% 8/8 [00:00&lt;00:00,  8.02it/s, v_num=3, train_loss_step=0.311, val_loss=0.256, train_loss_epoch=0.159]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.68it/s]
Epoch 36: 100% 8/8 [00:01&lt;00:00,  7.78it/s, v_num=3, train_loss_step=0.201, val_loss=0.222, train_loss_epoch=0.160]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.57it/s]
Epoch 37: 100% 8/8 [00:01&lt;00:00,  7.84it/s, v_num=3, train_loss_step=0.0628, val_loss=0.221, train_loss_epoch=0.163]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  9.96it/s]
Epoch 38: 100% 8/8 [00:01&lt;00:00,  6.80it/s, v_num=3, train_loss_step=0.153, val_loss=0.237, train_loss_epoch=0.159]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.94it/s]
Epoch 39: 100% 8/8 [00:01&lt;00:00,  5.27it/s, v_num=3, train_loss_step=0.191, val_loss=0.243, train_loss_epoch=0.164]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.81it/s]
Epoch 40: 100% 8/8 [00:01&lt;00:00,  6.54it/s, v_num=3, train_loss_step=0.399, val_loss=0.248, train_loss_epoch=0.155]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.16it/s]
Epoch 41: 100% 8/8 [00:01&lt;00:00,  7.94it/s, v_num=3, train_loss_step=0.155, val_loss=0.217, train_loss_epoch=0.165]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.60it/s]
Epoch 42: 100% 8/8 [00:01&lt;00:00,  7.94it/s, v_num=3, train_loss_step=0.154, val_loss=0.218, train_loss_epoch=0.156]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.19it/s]
Epoch 43: 100% 8/8 [00:01&lt;00:00,  7.97it/s, v_num=3, train_loss_step=0.226, val_loss=0.286, train_loss_epoch=0.156]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.61it/s]
Epoch 44: 100% 8/8 [00:01&lt;00:00,  7.83it/s, v_num=3, train_loss_step=0.0866, val_loss=0.231, train_loss_epoch=0.165]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.02it/s]
Epoch 45: 100% 8/8 [00:01&lt;00:00,  4.67it/s, v_num=3, train_loss_step=0.265, val_loss=0.221, train_loss_epoch=0.152]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.53it/s]
Epoch 46: 100% 8/8 [00:01&lt;00:00,  7.95it/s, v_num=3, train_loss_step=0.0487, val_loss=0.243, train_loss_epoch=0.152]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  9.81it/s]
Epoch 47: 100% 8/8 [00:01&lt;00:00,  7.97it/s, v_num=3, train_loss_step=0.170, val_loss=0.243, train_loss_epoch=0.149]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.81it/s]
Epoch 48: 100% 8/8 [00:01&lt;00:00,  6.57it/s, v_num=3, train_loss_step=0.148, val_loss=0.234, train_loss_epoch=0.149]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.53it/s]
Epoch 49: 100% 8/8 [00:01&lt;00:00,  5.32it/s, v_num=3, train_loss_step=0.117, val_loss=0.226, train_loss_epoch=0.143]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.84it/s]
Epoch 50: 100% 8/8 [00:01&lt;00:00,  6.45it/s, v_num=3, train_loss_step=0.102, val_loss=0.258, train_loss_epoch=0.142]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  8.89it/s]
Epoch 51: 100% 8/8 [00:01&lt;00:00,  7.94it/s, v_num=3, train_loss_step=0.132, val_loss=0.216, train_loss_epoch=0.150]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.65it/s]
Epoch 52: 100% 8/8 [00:01&lt;00:00,  7.90it/s, v_num=3, train_loss_step=0.114, val_loss=0.220, train_loss_epoch=0.152]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.12it/s]
Epoch 53: 100% 8/8 [00:00&lt;00:00,  8.01it/s, v_num=3, train_loss_step=0.115, val_loss=0.223, train_loss_epoch=0.144]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.47it/s]
Epoch 54: 100% 8/8 [00:01&lt;00:00,  7.97it/s, v_num=3, train_loss_step=0.0449, val_loss=0.235, train_loss_epoch=0.143]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.75it/s]
Epoch 55: 100% 8/8 [00:01&lt;00:00,  7.96it/s, v_num=3, train_loss_step=0.119, val_loss=0.230, train_loss_epoch=0.141]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.52it/s]
Epoch 56: 100% 8/8 [00:01&lt;00:00,  7.80it/s, v_num=3, train_loss_step=0.156, val_loss=0.223, train_loss_epoch=0.140]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.10it/s]
Epoch 57: 100% 8/8 [00:01&lt;00:00,  7.60it/s, v_num=3, train_loss_step=0.207, val_loss=0.226, train_loss_epoch=0.139]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.67it/s]
Epoch 58: 100% 8/8 [00:01&lt;00:00,  7.96it/s, v_num=3, train_loss_step=0.154, val_loss=0.240, train_loss_epoch=0.140]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.65it/s]
Epoch 59: 100% 8/8 [00:01&lt;00:00,  5.81it/s, v_num=3, train_loss_step=0.174, val_loss=0.216, train_loss_epoch=0.141]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.80it/s]
Epoch 60: 100% 8/8 [00:01&lt;00:00,  5.44it/s, v_num=3, train_loss_step=0.168, val_loss=0.227, train_loss_epoch=0.138]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.79it/s]
Epoch 61: 100% 8/8 [00:01&lt;00:00,  7.55it/s, v_num=3, train_loss_step=0.0818, val_loss=0.231, train_loss_epoch=0.138]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.01it/s]
Epoch 62: 100% 8/8 [00:01&lt;00:00,  7.87it/s, v_num=3, train_loss_step=0.162, val_loss=0.229, train_loss_epoch=0.135]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.36it/s]
Epoch 63: 100% 8/8 [00:01&lt;00:00,  7.87it/s, v_num=3, train_loss_step=0.0715, val_loss=0.218, train_loss_epoch=0.134]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  8.99it/s]
Epoch 64: 100% 8/8 [00:01&lt;00:00,  7.79it/s, v_num=3, train_loss_step=0.128, val_loss=0.230, train_loss_epoch=0.136]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.58it/s]
Epoch 65: 100% 8/8 [00:01&lt;00:00,  7.86it/s, v_num=3, train_loss_step=0.216, val_loss=0.225, train_loss_epoch=0.133]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.50it/s]
Epoch 66: 100% 8/8 [00:01&lt;00:00,  7.93it/s, v_num=3, train_loss_step=0.118, val_loss=0.221, train_loss_epoch=0.134]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.64it/s]
Epoch 67: 100% 8/8 [00:00&lt;00:00,  8.10it/s, v_num=3, train_loss_step=0.189, val_loss=0.237, train_loss_epoch=0.131] 
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.67it/s]
Epoch 68: 100% 8/8 [00:01&lt;00:00,  7.99it/s, v_num=3, train_loss_step=0.161, val_loss=0.219, train_loss_epoch=0.132]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.46it/s]
Epoch 69: 100% 8/8 [00:01&lt;00:00,  7.85it/s, v_num=3, train_loss_step=0.208, val_loss=0.241, train_loss_epoch=0.134]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.95it/s]
Epoch 70: 100% 8/8 [00:01&lt;00:00,  5.36it/s, v_num=3, train_loss_step=0.119, val_loss=0.229, train_loss_epoch=0.131]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.54it/s]
Epoch 71: 100% 8/8 [00:01&lt;00:00,  5.64it/s, v_num=3, train_loss_step=0.198, val_loss=0.222, train_loss_epoch=0.133]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.29it/s]
Epoch 72: 100% 8/8 [00:01&lt;00:00,  7.83it/s, v_num=3, train_loss_step=0.117, val_loss=0.223, train_loss_epoch=0.132]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.26it/s]
Epoch 73: 100% 8/8 [00:01&lt;00:00,  7.66it/s, v_num=3, train_loss_step=0.0715, val_loss=0.239, train_loss_epoch=0.133]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.25it/s]
Epoch 74: 100% 8/8 [00:01&lt;00:00,  7.73it/s, v_num=3, train_loss_step=0.284, val_loss=0.219, train_loss_epoch=0.134]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.59it/s]
Epoch 75: 100% 8/8 [00:01&lt;00:00,  7.69it/s, v_num=3, train_loss_step=0.135, val_loss=0.247, train_loss_epoch=0.130]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.28it/s]
Epoch 76: 100% 8/8 [00:01&lt;00:00,  7.94it/s, v_num=3, train_loss_step=0.0589, val_loss=0.221, train_loss_epoch=0.133]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  8.96it/s]
Epoch 77: 100% 8/8 [00:01&lt;00:00,  7.81it/s, v_num=3, train_loss_step=0.099, val_loss=0.235, train_loss_epoch=0.130]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.60it/s]
Epoch 78: 100% 8/8 [00:01&lt;00:00,  7.97it/s, v_num=3, train_loss_step=0.0862, val_loss=0.223, train_loss_epoch=0.129]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.24it/s]
Epoch 79: 100% 8/8 [00:01&lt;00:00,  7.99it/s, v_num=3, train_loss_step=0.116, val_loss=0.238, train_loss_epoch=0.127]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.19it/s]
Epoch 80: 100% 8/8 [00:01&lt;00:00,  6.47it/s, v_num=3, train_loss_step=0.226, val_loss=0.222, train_loss_epoch=0.131]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.86it/s]
Epoch 81: 100% 8/8 [00:01&lt;00:00,  5.25it/s, v_num=3, train_loss_step=0.135, val_loss=0.228, train_loss_epoch=0.128]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.87it/s]
Epoch 82: 100% 8/8 [00:01&lt;00:00,  6.01it/s, v_num=3, train_loss_step=0.110, val_loss=0.240, train_loss_epoch=0.130]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.07it/s]
Epoch 83: 100% 8/8 [00:01&lt;00:00,  7.58it/s, v_num=3, train_loss_step=0.0917, val_loss=0.221, train_loss_epoch=0.129]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.35it/s]
Epoch 84: 100% 8/8 [00:01&lt;00:00,  7.70it/s, v_num=3, train_loss_step=0.114, val_loss=0.227, train_loss_epoch=0.127]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.20it/s]
Epoch 85: 100% 8/8 [00:01&lt;00:00,  7.61it/s, v_num=3, train_loss_step=0.134, val_loss=0.223, train_loss_epoch=0.126]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.63it/s]
Epoch 86: 100% 8/8 [00:01&lt;00:00,  7.65it/s, v_num=3, train_loss_step=0.156, val_loss=0.232, train_loss_epoch=0.127]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.30it/s]
Epoch 87: 100% 8/8 [00:01&lt;00:00,  7.77it/s, v_num=3, train_loss_step=0.125, val_loss=0.222, train_loss_epoch=0.127]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  9.05it/s]
Epoch 88: 100% 8/8 [00:01&lt;00:00,  7.73it/s, v_num=3, train_loss_step=0.142, val_loss=0.233, train_loss_epoch=0.126]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.49it/s]
Epoch 89: 100% 8/8 [00:01&lt;00:00,  7.74it/s, v_num=3, train_loss_step=0.0796, val_loss=0.219, train_loss_epoch=0.128]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.05it/s]
Epoch 90: 100% 8/8 [00:01&lt;00:00,  7.66it/s, v_num=3, train_loss_step=0.0883, val_loss=0.227, train_loss_epoch=0.127]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  9.95it/s]
Epoch 91: 100% 8/8 [00:01&lt;00:00,  5.46it/s, v_num=3, train_loss_step=0.150, val_loss=0.226, train_loss_epoch=0.126]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.83it/s]
Epoch 92: 100% 8/8 [00:01&lt;00:00,  5.16it/s, v_num=3, train_loss_step=0.133, val_loss=0.220, train_loss_epoch=0.127]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.57it/s]
Epoch 93: 100% 8/8 [00:01&lt;00:00,  7.77it/s, v_num=3, train_loss_step=0.110, val_loss=0.230, train_loss_epoch=0.130]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.47it/s]
Epoch 94: 100% 8/8 [00:01&lt;00:00,  7.67it/s, v_num=3, train_loss_step=0.0656, val_loss=0.227, train_loss_epoch=0.125]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.26it/s]
Epoch 95: 100% 8/8 [00:01&lt;00:00,  7.66it/s, v_num=3, train_loss_step=0.134, val_loss=0.224, train_loss_epoch=0.125]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.46it/s]
Epoch 96: 100% 8/8 [00:01&lt;00:00,  6.60it/s, v_num=3, train_loss_step=0.106, val_loss=0.231, train_loss_epoch=0.124]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  9.54it/s]
Epoch 97: 100% 8/8 [00:01&lt;00:00,  7.69it/s, v_num=3, train_loss_step=0.123, val_loss=0.225, train_loss_epoch=0.127]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.87it/s]
Epoch 98: 100% 8/8 [00:01&lt;00:00,  7.61it/s, v_num=3, train_loss_step=0.141, val_loss=0.228, train_loss_epoch=0.126]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.18it/s]
Epoch 99: 100% 8/8 [00:01&lt;00:00,  7.69it/s, v_num=3, train_loss_step=0.170, val_loss=0.226, train_loss_epoch=0.126]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.26it/s]
Epoch 99: 100% 8/8 [00:01&lt;00:00,  6.98it/s, v_num=3, train_loss_step=0.170, val_loss=0.228, train_loss_epoch=0.130]`Trainer.fit` stopped: `max_epochs=100` reached.
Epoch 99: 100% 8/8 [00:01&lt;00:00,  6.88it/s, v_num=3, train_loss_step=0.170, val_loss=0.228, train_loss_epoch=0.130]
/usr/local/lib/python3.12/dist-packages/lightning/pytorch/trainer/connectors/checkpoint_connector.py:149: `.predict(ckpt_path=None)` was called without a model. The best model of the previous `fit` call will be used. You can pass `.predict(ckpt_path=&#39;best&#39;)` to use the best model or `.predict(ckpt_path=&#39;last&#39;)` to use the last model. If you pass a value, this warning will be silenced.
Restoring states from the checkpoint path at /content/mp_model/model_0/checkpoints/best-epoch=50-val_r2=0.71.ckpt
Loaded model weights from the checkpoint at /content/mp_model/model_0/checkpoints/best-epoch=50-val_r2=0.71.ckpt
Predicting DataLoader 0: 100% 1/1 [00:00&lt;00:00, 19.21it/s]
2025-09-21T02:38:28 - INFO:chemprop.cli.train - Test Set results:
2025-09-21T02:38:28 - INFO:chemprop.cli.train - test/mae: 16.6578369140625
2025-09-21T02:38:28 - INFO:chemprop.cli.train - test/rmse: 20.868921279907227
2025-09-21T02:38:28 - INFO:chemprop.cli.train - test/r2: 0.826757027488992
2025-09-21T02:38:28 - INFO:chemprop.cli.train - Best model saved to &#39;mp_model/model_0/best.pt&#39;
</pre></div>
</div>
</div>
</div>
<p>Make quick predictions on a few molecules.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smiles_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;CO&quot;</span><span class="p">,</span>
    <span class="s2">&quot;c1ccc2c(c1)CCCC2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CCCCCCCCC(=O)O&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CCN(CC)CC&quot;</span>
<span class="p">]</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;SMILES&quot;</span><span class="p">:</span> <span class="n">smiles_list</span><span class="p">})</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;custom_smiles_reg.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="o">!</span>chemprop<span class="w"> </span>predict<span class="w"> </span><span class="err">\</span>
  <span class="o">--</span><span class="n">test</span><span class="o">-</span><span class="n">path</span> <span class="n">custom_smiles_reg</span><span class="o">.</span><span class="n">csv</span> \
    <span class="o">--</span><span class="n">model</span><span class="o">-</span><span class="n">paths</span> <span class="n">mp_model</span><span class="o">/</span><span class="n">model_0</span><span class="o">/</span><span class="n">best</span><span class="o">.</span><span class="n">pt</span> \
  <span class="o">--</span><span class="n">preds</span><span class="o">-</span><span class="n">path</span> <span class="n">mp_preds</span><span class="o">.</span><span class="n">csv</span>

<span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;mp_preds.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-09-21T02:38:41 - INFO:chemprop.cli.main - Running in mode &#39;predict&#39; with args: {&#39;smiles_columns&#39;: None, &#39;reaction_columns&#39;: None, &#39;no_header_row&#39;: False, &#39;num_workers&#39;: 0, &#39;batch_size&#39;: 64, &#39;accelerator&#39;: &#39;auto&#39;, &#39;devices&#39;: &#39;auto&#39;, &#39;rxn_mode&#39;: &#39;REAC_DIFF&#39;, &#39;multi_hot_atom_featurizer_mode&#39;: &#39;V2&#39;, &#39;keep_h&#39;: False, &#39;add_h&#39;: False, &#39;ignore_stereo&#39;: False, &#39;reorder_atoms&#39;: False, &#39;molecule_featurizers&#39;: None, &#39;descriptors_path&#39;: None, &#39;descriptors_columns&#39;: None, &#39;no_descriptor_scaling&#39;: False, &#39;no_atom_feature_scaling&#39;: False, &#39;no_atom_descriptor_scaling&#39;: False, &#39;no_bond_feature_scaling&#39;: False, &#39;no_bond_descriptor_scaling&#39;: False, &#39;atom_features_path&#39;: None, &#39;atom_descriptors_path&#39;: None, &#39;bond_features_path&#39;: None, &#39;bond_descriptors_path&#39;: None, &#39;constraints_path&#39;: None, &#39;constraints_to_targets&#39;: None, &#39;use_cuikmolmaker_featurization&#39;: False, &#39;test_path&#39;: PosixPath(&#39;custom_smiles_reg.csv&#39;), &#39;output&#39;: PosixPath(&#39;mp_preds.csv&#39;), &#39;drop_extra_columns&#39;: False, &#39;model_paths&#39;: [PosixPath(&#39;mp_model/model_0/best.pt&#39;)], &#39;cal_path&#39;: None, &#39;uncertainty_method&#39;: &#39;none&#39;, &#39;calibration_method&#39;: None, &#39;evaluation_methods&#39;: None, &#39;uncertainty_dropout_p&#39;: 0.1, &#39;dropout_sampling_size&#39;: 10, &#39;calibration_interval_percentile&#39;: 95, &#39;conformal_alpha&#39;: 0.1, &#39;cal_descriptors_path&#39;: None, &#39;cal_atom_features_path&#39;: None, &#39;cal_atom_descriptors_path&#39;: None, &#39;cal_bond_features_path&#39;: None, &#39;cal_bond_descriptors_path&#39;: None, &#39;cal_constraints_path&#39;: None}
2025-09-21T02:38:41 - INFO:chemprop.cli.predict - test size: 4
💡 Tip: For seamless cloud uploads and versioning, try installing [litmodels](https://pypi.org/project/litmodels/) to enable LitModelCheckpoint, which syncs automatically with the Lightning model registry.
GPU available: False, used: False
TPU available: False, using: 0 TPU cores
HPU available: False, using: 0 HPUs

Predicting: |          | 0/? [00:00&lt;?, ?it/s]
Predicting: |          | 0/? [00:00&lt;?, ?it/s]
Predicting DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Predicting DataLoader 0: 100% 1/1 [00:00&lt;00:00, 239.83it/s]
Predicting DataLoader 0: 100% 1/1 [00:00&lt;00:00, 219.64it/s]
2025-09-21T02:38:41 - INFO:chemprop.cli.predict - Predictions saved to &#39;mp_preds.csv&#39;
</pre></div>
</div>
<div class="output text_html">
  <div id="df-5438f17b-b95f-407f-aba7-1f3df8e4eb6c" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SMILES</th>
      <th>Melting Point</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>CO</td>
      <td>76.238464</td>
    </tr>
    <tr>
      <th>1</th>
      <td>c1ccc2c(c1)CCCC2</td>
      <td>76.600280</td>
    </tr>
    <tr>
      <th>2</th>
      <td>CCCCCCCCC(=O)O</td>
      <td>91.757965</td>
    </tr>
    <tr>
      <th>3</th>
      <td>CCN(CC)CC</td>
      <td>80.074980</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-5438f17b-b95f-407f-aba7-1f3df8e4eb6c')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-5438f17b-b95f-407f-aba7-1f3df8e4eb6c button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-5438f17b-b95f-407f-aba7-1f3df8e4eb6c');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-dfa5f841-44a5-46b0-aebe-bb6733c36b21">
      <button class="colab-df-quickchart" onclick="quickchart('df-dfa5f841-44a5-46b0-aebe-bb6733c36b21')"
                title="Suggest charts"
                style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-dfa5f841-44a5-46b0-aebe-bb6733c36b21 button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

    </div>
  </div>
</div></div>
</div>
<section id="reactivity-classification-ch-oxidation-dataset">
<h3>7.3 Reactivity classification (C–H oxidation dataset)<a class="headerlink" href="#reactivity-classification-ch-oxidation-dataset" title="Link to this heading">#</a></h3>
<p>We use the <code class="docutils literal notranslate"><span class="pre">Reactivity</span></code> column and convert it to <strong>binary</strong> 0/1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Reactivity_bin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Reactivity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span><span class="s2">&quot;Reactivity&quot;</span><span class="p">,</span><span class="s2">&quot;Reactivity_bin&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-9774aaa2-598f-429b-9d5a-30f4ad9e24a8" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SMILES</th>
      <th>Reactivity</th>
      <th>Reactivity_bin</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>c1ccc2c(c1)CCOC2</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>c1ccc2c(c1)Cc1ccccc1-2</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>c1ccc2c(c1)CCCC2</td>
      <td>1</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-9774aaa2-598f-429b-9d5a-30f4ad9e24a8')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-9774aaa2-598f-429b-9d5a-30f4ad9e24a8 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-9774aaa2-598f-429b-9d5a-30f4ad9e24a8');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-3e58a59d-2944-45dd-97e7-91dd3f4686c7">
      <button class="colab-df-quickchart" onclick="quickchart('df-3e58a59d-2944-45dd-97e7-91dd3f4686c7')"
                title="Suggest charts"
                style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-3e58a59d-2944-45dd-97e7-91dd3f4686c7 button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

    </div>
  </div>
</div></div>
</div>
<p>Write a minimal file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span> <span class="s2">&quot;Reactivity_bin&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;reactivity_data_bin.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Optional: sanity check the class balance</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Reactivity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Reactivity_bin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{-1: 311, 1: 264}
{0: 311, 1: 264}
</pre></div>
</div>
</div>
</div>
<p>Train a short classification model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>chemprop<span class="w"> </span>train<span class="w"> </span><span class="err">\</span>
  <span class="o">--</span><span class="n">data</span><span class="o">-</span><span class="n">path</span> <span class="n">reactivity_data_bin</span><span class="o">.</span><span class="n">csv</span> \
  <span class="o">-</span><span class="n">t</span> <span class="n">classification</span> \
  <span class="o">-</span><span class="n">s</span> <span class="n">SMILES</span> \
  <span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">columns</span> <span class="n">Reactivity_bin</span> \
  <span class="o">-</span><span class="n">o</span> <span class="n">reactivity_model</span> \
  <span class="o">--</span><span class="n">num</span><span class="o">-</span><span class="n">replicates</span> <span class="mi">1</span> \
  <span class="o">--</span><span class="n">epochs</span> <span class="mi">15</span> \
  <span class="o">--</span><span class="n">class</span><span class="o">-</span><span class="n">balance</span> \
  <span class="o">--</span><span class="n">metrics</span> <span class="n">roc</span> <span class="n">prc</span> <span class="n">accuracy</span> \
  <span class="o">--</span><span class="n">tracking</span><span class="o">-</span><span class="n">metric</span> <span class="n">roc</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-09-21T02:30:14 - INFO:chemprop.cli.main - Running in mode &#39;train&#39; with args: {&#39;smiles_columns&#39;: [&#39;SMILES&#39;], &#39;reaction_columns&#39;: None, &#39;no_header_row&#39;: False, &#39;num_workers&#39;: 0, &#39;batch_size&#39;: 64, &#39;accelerator&#39;: &#39;auto&#39;, &#39;devices&#39;: &#39;auto&#39;, &#39;rxn_mode&#39;: &#39;REAC_DIFF&#39;, &#39;multi_hot_atom_featurizer_mode&#39;: &#39;V2&#39;, &#39;keep_h&#39;: False, &#39;add_h&#39;: False, &#39;ignore_stereo&#39;: False, &#39;reorder_atoms&#39;: False, &#39;molecule_featurizers&#39;: None, &#39;descriptors_path&#39;: None, &#39;descriptors_columns&#39;: None, &#39;no_descriptor_scaling&#39;: False, &#39;no_atom_feature_scaling&#39;: False, &#39;no_atom_descriptor_scaling&#39;: False, &#39;no_bond_feature_scaling&#39;: False, &#39;no_bond_descriptor_scaling&#39;: False, &#39;atom_features_path&#39;: None, &#39;atom_descriptors_path&#39;: None, &#39;bond_features_path&#39;: None, &#39;bond_descriptors_path&#39;: None, &#39;constraints_path&#39;: None, &#39;constraints_to_targets&#39;: None, &#39;use_cuikmolmaker_featurization&#39;: False, &#39;config_path&#39;: None, &#39;data_path&#39;: PosixPath(&#39;reactivity_data_bin.csv&#39;), &#39;output_dir&#39;: PosixPath(&#39;reactivity_model&#39;), &#39;remove_checkpoints&#39;: False, &#39;checkpoint&#39;: None, &#39;freeze_encoder&#39;: False, &#39;model_frzn&#39;: None, &#39;frzn_ffn_layers&#39;: 0, &#39;from_foundation&#39;: None, &#39;ensemble_size&#39;: 1, &#39;message_hidden_dim&#39;: 300, &#39;message_bias&#39;: False, &#39;depth&#39;: 3, &#39;undirected&#39;: False, &#39;dropout&#39;: 0.0, &#39;mpn_shared&#39;: False, &#39;aggregation&#39;: &#39;norm&#39;, &#39;aggregation_norm&#39;: 100, &#39;atom_messages&#39;: False, &#39;activation&#39;: &#39;RELU&#39;, &#39;activation_args&#39;: None, &#39;ffn_hidden_dim&#39;: 300, &#39;ffn_num_layers&#39;: 1, &#39;batch_norm&#39;: False, &#39;multiclass_num_classes&#39;: 3, &#39;atom_task_weights&#39;: None, &#39;atom_ffn_hidden_dim&#39;: 300, &#39;atom_ffn_num_layers&#39;: 1, &#39;atom_multiclass_num_classes&#39;: 3, &#39;bond_task_weights&#39;: None, &#39;bond_ffn_hidden_dim&#39;: 300, &#39;bond_ffn_num_layers&#39;: 1, &#39;bond_multiclass_num_classes&#39;: 3, &#39;atom_constrainer_ffn_hidden_dim&#39;: 300, &#39;atom_constrainer_ffn_num_layers&#39;: 1, &#39;bond_constrainer_ffn_hidden_dim&#39;: 300, &#39;bond_constrainer_ffn_num_layers&#39;: 1, &#39;weight_column&#39;: None, &#39;target_columns&#39;: [&#39;Reactivity_bin&#39;], &#39;mol_target_columns&#39;: None, &#39;atom_target_columns&#39;: None, &#39;bond_target_columns&#39;: None, &#39;ignore_columns&#39;: None, &#39;no_cache&#39;: False, &#39;splits_column&#39;: None, &#39;task_type&#39;: &#39;classification&#39;, &#39;loss_function&#39;: None, &#39;v_kl&#39;: 0.0, &#39;eps&#39;: 1e-08, &#39;alpha&#39;: 0.1, &#39;metrics&#39;: [&#39;roc&#39;, &#39;prc&#39;, &#39;accuracy&#39;], &#39;tracking_metric&#39;: &#39;roc&#39;, &#39;show_individual_scores&#39;: False, &#39;task_weights&#39;: None, &#39;warmup_epochs&#39;: 2, &#39;init_lr&#39;: 0.0001, &#39;max_lr&#39;: 0.001, &#39;final_lr&#39;: 0.0001, &#39;epochs&#39;: 15, &#39;patience&#39;: None, &#39;grad_clip&#39;: None, &#39;class_balance&#39;: True, &#39;split&#39;: &#39;RANDOM&#39;, &#39;split_sizes&#39;: [0.8, 0.1, 0.1], &#39;split_key_molecule&#39;: 0, &#39;num_replicates&#39;: 1, &#39;num_folds&#39;: None, &#39;save_smiles_splits&#39;: False, &#39;splits_file&#39;: None, &#39;data_seed&#39;: 0, &#39;pytorch_seed&#39;: None}
Wrote config file to reactivity_model/config.toml
2025-09-21T02:30:14 - INFO:chemprop.cli.train - Pulling data from file: reactivity_data_bin.csv
2025-09-21T02:30:15 - WARNING:chemprop.data.splitting - The return type of make_split_indices has changed in v2.1 - see help(make_split_indices)
2025-09-21T02:30:15 - INFO:chemprop.cli.train - train/val/test split_0 sizes: [460, 57, 58]
2025-09-21T02:30:15 - INFO:chemprop.cli.train - 
        Summary of Training Data        
┏━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Class ┃ Count/Percent Reactivity_bin ┃
┡━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│   0.0 │                      255/55% │
│   1.0 │                      205/45% │
│   NaN │                         0/0% │
│ Total │                   460/100.0% │
└───────┴──────────────────────────────┘

2025-09-21T02:30:15 - INFO:chemprop.cli.train - 
       Summary of Validation Data       
┏━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Class ┃ Count/Percent Reactivity_bin ┃
┡━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│   0.0 │                       29/51% │
│   1.0 │                       28/49% │
│   NaN │                         0/0% │
│ Total │                    57/100.0% │
└───────┴──────────────────────────────┘

2025-09-21T02:30:15 - INFO:chemprop.cli.train - 
          Summary of Test Data          
┏━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Class ┃ Count/Percent Reactivity_bin ┃
┡━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│   0.0 │                       27/47% │
│   1.0 │                       31/53% │
│   NaN │                         0/0% │
│ Total │                    58/100.0% │
└───────┴──────────────────────────────┘

2025-09-21T02:30:15 - INFO:chemprop.cli.train - Caching training and validation datasets...
2025-09-21T02:30:15 - INFO:chemprop.cli.train - No loss function was specified! Using class default: &lt;class &#39;chemprop.nn.metrics.BCELoss&#39;&gt;
2025-09-21T02:30:15 - INFO:chemprop.cli.train - MPNN(
  (message_passing): BondMessagePassing(
    (W_i): Linear(in_features=86, out_features=300, bias=False)
    (W_h): Linear(in_features=300, out_features=300, bias=False)
    (W_o): Linear(in_features=372, out_features=300, bias=True)
    (dropout): Dropout(p=0.0, inplace=False)
    (tau): ReLU()
    (V_d_transform): Identity()
    (graph_transform): GraphTransform(
      (V_transform): Identity()
      (E_transform): Identity()
    )
  )
  (agg): NormAggregation()
  (bn): Identity()
  (predictor): BinaryClassificationFFN(
    (ffn): MLP(
      (0): Sequential(
        (0): Linear(in_features=300, out_features=300, bias=True)
      )
      (1): Sequential(
        (0): ReLU()
        (1): Dropout(p=0.0, inplace=False)
        (2): Linear(in_features=300, out_features=1, bias=True)
      )
    )
    (criterion): BCELoss(task_weights=[[1.0]])
    (output_transform): Identity()
  )
  (X_d_transform): Identity()
  (metrics): ModuleList(
    (0): BinaryAUROC()
    (1): BinaryAUPRC()
    (2): BinaryAccuracy()
    (3): BCELoss(task_weights=[[1.0]])
  )
)
GPU available: False, used: False
TPU available: False, using: 0 TPU cores
HPU available: False, using: 0 HPUs
2025-09-21 02:30:15.974383: E external/local_xla/xla/stream_executor/cuda/cuda_fft.cc:467] Unable to register cuFFT factory: Attempting to register factory for plugin cuFFT when one has already been registered
WARNING: All log messages before absl::InitializeLog() is called are written to STDERR
E0000 00:00:1758421816.001418   57061 cuda_dnn.cc:8579] Unable to register cuDNN factory: Attempting to register factory for plugin cuDNN when one has already been registered
E0000 00:00:1758421816.009690   57061 cuda_blas.cc:1407] Unable to register cuBLAS factory: Attempting to register factory for plugin cuBLAS when one has already been registered
W0000 00:00:1758421816.031522   57061 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
W0000 00:00:1758421816.031593   57061 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
W0000 00:00:1758421816.031602   57061 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
W0000 00:00:1758421816.031610   57061 computation_placer.cc:177] computation placer already registered. Please check linkage and avoid linking the same target more than once.
2025-09-21 02:30:16.037344: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
Loading `train_dataloader` to estimate number of stepping batches.
/usr/local/lib/python3.12/dist-packages/lightning/pytorch/loops/fit_loop.py:310: The number of training batches (7) is smaller than the logging interval Trainer(log_every_n_steps=50). Set a lower value for log_every_n_steps if you want to see logs for the training epoch.

  | Name            | Type                    | Params | Mode 
--------------------------------------------------------------------
0 | message_passing | BondMessagePassing      | 227 K  | train
1 | agg             | NormAggregation         | 0      | train
2 | bn              | Identity                | 0      | train
3 | predictor       | BinaryClassificationFFN | 90.6 K | train
4 | X_d_transform   | Identity                | 0      | train
5 | metrics         | ModuleList              | 0      | train
--------------------------------------------------------------------
318 K     Trainable params
0         Non-trainable params
318 K     Total params
1.273     Total estimated model params size (MB)
27        Modules in train mode
0         Modules in eval mode
/usr/local/lib/python3.12/dist-packages/lightning/pytorch/core/saving.py:363: Skipping &#39;metrics&#39; parameter because it is not possible to safely dump to YAML.
Epoch 0: 100% 7/7 [00:00&lt;00:00,  7.31it/s, v_num=0, train_loss_step=0.687]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00, 10.21it/s]
Epoch 1: 100% 7/7 [00:00&lt;00:00,  7.63it/s, v_num=0, train_loss_step=0.595, val_loss=0.685, train_loss_epoch=0.689]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  9.91it/s]
Epoch 2: 100% 7/7 [00:01&lt;00:00,  5.31it/s, v_num=0, train_loss_step=0.512, val_loss=0.631, train_loss_epoch=0.656]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.38it/s]
Epoch 3: 100% 7/7 [00:01&lt;00:00,  4.93it/s, v_num=0, train_loss_step=0.473, val_loss=0.595, train_loss_epoch=0.536]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  7.90it/s]
Epoch 4: 100% 7/7 [00:01&lt;00:00,  5.34it/s, v_num=0, train_loss_step=0.433, val_loss=0.603, train_loss_epoch=0.504]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.65it/s]
Epoch 5: 100% 7/7 [00:01&lt;00:00,  4.29it/s, v_num=0, train_loss_step=0.266, val_loss=0.573, train_loss_epoch=0.443]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  4.32it/s]
Epoch 6: 100% 7/7 [00:01&lt;00:00,  4.99it/s, v_num=0, train_loss_step=0.408, val_loss=0.532, train_loss_epoch=0.434]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  5.97it/s]
Epoch 7: 100% 7/7 [00:01&lt;00:00,  5.55it/s, v_num=0, train_loss_step=0.652, val_loss=0.526, train_loss_epoch=0.405]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.96it/s]
Epoch 8: 100% 7/7 [00:01&lt;00:00,  5.01it/s, v_num=0, train_loss_step=0.306, val_loss=0.515, train_loss_epoch=0.387]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.13it/s]
Epoch 9: 100% 7/7 [00:01&lt;00:00,  6.60it/s, v_num=0, train_loss_step=0.436, val_loss=0.496, train_loss_epoch=0.373]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  9.06it/s]
Epoch 10: 100% 7/7 [00:00&lt;00:00,  7.78it/s, v_num=0, train_loss_step=0.247, val_loss=0.479, train_loss_epoch=0.367]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  8.93it/s]
Epoch 11: 100% 7/7 [00:00&lt;00:00,  7.81it/s, v_num=0, train_loss_step=0.436, val_loss=0.472, train_loss_epoch=0.358]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  9.07it/s]
Epoch 12: 100% 7/7 [00:00&lt;00:00,  7.78it/s, v_num=0, train_loss_step=0.291, val_loss=0.461, train_loss_epoch=0.349]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  8.84it/s]
Epoch 13: 100% 7/7 [00:00&lt;00:00,  7.48it/s, v_num=0, train_loss_step=0.295, val_loss=0.454, train_loss_epoch=0.343]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  6.81it/s]
Epoch 14: 100% 7/7 [00:01&lt;00:00,  4.44it/s, v_num=0, train_loss_step=0.367, val_loss=0.448, train_loss_epoch=0.339]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation: |          | 0/? [00:00&lt;?, ?it/s]
Validation DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Validation DataLoader 0: 100% 1/1 [00:00&lt;00:00,  5.01it/s]
Epoch 14: 100% 7/7 [00:01&lt;00:00,  3.89it/s, v_num=0, train_loss_step=0.367, val_loss=0.439, train_loss_epoch=0.329]`Trainer.fit` stopped: `max_epochs=15` reached.
Epoch 14: 100% 7/7 [00:01&lt;00:00,  3.79it/s, v_num=0, train_loss_step=0.367, val_loss=0.439, train_loss_epoch=0.329]
/usr/local/lib/python3.12/dist-packages/lightning/pytorch/trainer/connectors/checkpoint_connector.py:149: `.predict(ckpt_path=None)` was called without a model. The best model of the previous `fit` call will be used. You can pass `.predict(ckpt_path=&#39;best&#39;)` to use the best model or `.predict(ckpt_path=&#39;last&#39;)` to use the last model. If you pass a value, this warning will be silenced.
Restoring states from the checkpoint path at /content/reactivity_model/model_0/checkpoints/best-epoch=14-val_roc=0.86.ckpt
Loaded model weights from the checkpoint at /content/reactivity_model/model_0/checkpoints/best-epoch=14-val_roc=0.86.ckpt
Predicting DataLoader 0: 100% 1/1 [00:00&lt;00:00,  7.23it/s]
2025-09-21T02:30:40 - INFO:chemprop.cli.train - Test Set results:
2025-09-21T02:30:40 - INFO:chemprop.cli.train - test/roc: 0.9510154724121094
2025-09-21T02:30:40 - INFO:chemprop.cli.train - test/prc: 0.9459617137908936
2025-09-21T02:30:40 - INFO:chemprop.cli.train - test/accuracy: 0.8793103694915771
2025-09-21T02:30:41 - INFO:chemprop.cli.train - Best model saved to &#39;reactivity_model/model_0/best.pt&#39;
</pre></div>
</div>
</div>
</div>
<p>Predict on new SMILES.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smiles_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;CCO&quot;</span><span class="p">,</span>
    <span class="s2">&quot;c1ccccc1C(F)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C1=C([C@@H]2C[C@H](C1)C2(C)C)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C1=CC=CC=C1C=O&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CCN(CC)CC&quot;</span><span class="p">,</span>
    <span class="s2">&quot;c1cccc(C=CC)c1&quot;</span>
<span class="p">]</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;SMILES&quot;</span><span class="p">:</span> <span class="n">smiles_list</span><span class="p">})</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;custom_smiles.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="o">!</span>chemprop<span class="w"> </span>predict<span class="w"> </span><span class="err">\</span>
  <span class="o">--</span><span class="n">test</span><span class="o">-</span><span class="n">path</span> <span class="n">custom_smiles</span><span class="o">.</span><span class="n">csv</span> \
  <span class="o">--</span><span class="n">model</span><span class="o">-</span><span class="n">paths</span> <span class="n">reactivity_model</span><span class="o">/</span><span class="n">model_0</span><span class="o">/</span><span class="n">best</span><span class="o">.</span><span class="n">pt</span> \
  <span class="o">--</span><span class="n">preds</span><span class="o">-</span><span class="n">path</span> <span class="n">custom_preds</span><span class="o">.</span><span class="n">csv</span>

<span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;custom_preds.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025-09-21T02:32:16 - INFO:chemprop.cli.main - Running in mode &#39;predict&#39; with args: {&#39;smiles_columns&#39;: None, &#39;reaction_columns&#39;: None, &#39;no_header_row&#39;: False, &#39;num_workers&#39;: 0, &#39;batch_size&#39;: 64, &#39;accelerator&#39;: &#39;auto&#39;, &#39;devices&#39;: &#39;auto&#39;, &#39;rxn_mode&#39;: &#39;REAC_DIFF&#39;, &#39;multi_hot_atom_featurizer_mode&#39;: &#39;V2&#39;, &#39;keep_h&#39;: False, &#39;add_h&#39;: False, &#39;ignore_stereo&#39;: False, &#39;reorder_atoms&#39;: False, &#39;molecule_featurizers&#39;: None, &#39;descriptors_path&#39;: None, &#39;descriptors_columns&#39;: None, &#39;no_descriptor_scaling&#39;: False, &#39;no_atom_feature_scaling&#39;: False, &#39;no_atom_descriptor_scaling&#39;: False, &#39;no_bond_feature_scaling&#39;: False, &#39;no_bond_descriptor_scaling&#39;: False, &#39;atom_features_path&#39;: None, &#39;atom_descriptors_path&#39;: None, &#39;bond_features_path&#39;: None, &#39;bond_descriptors_path&#39;: None, &#39;constraints_path&#39;: None, &#39;constraints_to_targets&#39;: None, &#39;use_cuikmolmaker_featurization&#39;: False, &#39;test_path&#39;: PosixPath(&#39;custom_smiles.csv&#39;), &#39;output&#39;: PosixPath(&#39;custom_preds.csv&#39;), &#39;drop_extra_columns&#39;: False, &#39;model_paths&#39;: [PosixPath(&#39;reactivity_model/model_0/best.pt&#39;)], &#39;cal_path&#39;: None, &#39;uncertainty_method&#39;: &#39;none&#39;, &#39;calibration_method&#39;: None, &#39;evaluation_methods&#39;: None, &#39;uncertainty_dropout_p&#39;: 0.1, &#39;dropout_sampling_size&#39;: 10, &#39;calibration_interval_percentile&#39;: 95, &#39;conformal_alpha&#39;: 0.1, &#39;cal_descriptors_path&#39;: None, &#39;cal_atom_features_path&#39;: None, &#39;cal_atom_descriptors_path&#39;: None, &#39;cal_bond_features_path&#39;: None, &#39;cal_bond_descriptors_path&#39;: None, &#39;cal_constraints_path&#39;: None}
2025-09-21T02:32:16 - INFO:chemprop.cli.predict - test size: 6
💡 Tip: For seamless cloud uploads and versioning, try installing [litmodels](https://pypi.org/project/litmodels/) to enable LitModelCheckpoint, which syncs automatically with the Lightning model registry.
GPU available: False, used: False
TPU available: False, using: 0 TPU cores
HPU available: False, using: 0 HPUs

Predicting: |          | 0/? [00:00&lt;?, ?it/s]
Predicting: |          | 0/? [00:00&lt;?, ?it/s]
Predicting DataLoader 0:   0% 0/1 [00:00&lt;?, ?it/s]
Predicting DataLoader 0: 100% 1/1 [00:00&lt;00:00, 206.79it/s]
Predicting DataLoader 0: 100% 1/1 [00:00&lt;00:00, 192.29it/s]
2025-09-21T02:32:16 - INFO:chemprop.cli.predict - Predictions saved to &#39;custom_preds.csv&#39;
</pre></div>
</div>
<div class="output text_html">
  <div id="df-10b9a409-1c75-4d54-a3fa-cca7d9c2d908" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SMILES</th>
      <th>Reactivity_bin</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>CCO</td>
      <td>0.588819</td>
    </tr>
    <tr>
      <th>1</th>
      <td>c1ccccc1C(F)</td>
      <td>0.690307</td>
    </tr>
    <tr>
      <th>2</th>
      <td>C1=C([C@@H]2C[C@H](C1)C2(C)C)</td>
      <td>0.899083</td>
    </tr>
    <tr>
      <th>3</th>
      <td>C1=CC=CC=C1C=O</td>
      <td>0.461047</td>
    </tr>
    <tr>
      <th>4</th>
      <td>CCN(CC)CC</td>
      <td>0.745579</td>
    </tr>
    <tr>
      <th>5</th>
      <td>c1cccc(C=CC)c1</td>
      <td>0.628841</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-10b9a409-1c75-4d54-a3fa-cca7d9c2d908')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-10b9a409-1c75-4d54-a3fa-cca7d9c2d908 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-10b9a409-1c75-4d54-a3fa-cca7d9c2d908');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-273cdca8-efce-4b6f-bf6f-b031bbe8eaf7">
      <button class="colab-df-quickchart" onclick="quickchart('df-273cdca8-efce-4b6f-bf6f-b031bbe8eaf7')"
                title="Suggest charts"
                style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-273cdca8-efce-4b6f-bf6f-b031bbe8eaf7 button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

    </div>
  </div>
</div></div>
</div>
</section>
</section>
<section id="quick-reference">
<h2>7. Quick Reference<a class="headerlink" href="#quick-reference" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>An MLP ignores graph structure. A GNN uses edges to mix neighbor information.</p></li>
<li><p>The core update is neighbor aggregation followed by a learnable transformation.</p></li>
<li><p>Chemprop encodes many best practices so you can focus on data and targets.</p></li>
</ul>
</section>
<section id="glossary">
<h2>8. Glossary<a class="headerlink" href="#glossary" title="Link to this heading">#</a></h2>
<p>graph neural network</p>
<blockquote>
<div><p>A neural model that updates node states by aggregating messages from neighbors.</p>
</div></blockquote>
<p>message passing</p>
<blockquote>
<div><p>The update step where a node combines its own vector with aggregated neighbor vectors.</p>
</div></blockquote>
<p>readout (pooling)</p>
<blockquote>
<div><p>Operation that compresses node states into a single graph vector, often by sum, mean, or max.</p>
</div></blockquote>
<p>edge index</p>
<blockquote>
<div><p>A 2×E tensor listing source and destination of each edge.</p>
</div></blockquote>
<p>Chemprop</p>
<blockquote>
<div><p>A practical library that trains message passing networks directly from SMILES.</p>
</div></blockquote>
<p>replicate</p>
<blockquote>
<div><p>Independent training run with a different random seed. Often ensembled for stability.</p>
</div></blockquote>
<p>tracking metric</p>
<blockquote>
<div><p>The metric used to pick the best checkpoint during training.</p>
</div></blockquote>
<p>class balance</p>
<blockquote>
<div><p>Loss weighting that compensates for skewed class proportions.</p>
</div></blockquote>
</section>
<section id="inclass-activity">
<h2>10. In‑class activity<a class="headerlink" href="#inclass-activity" title="Link to this heading">#</a></h2>
<hr class="docutils" />
<section id="q1-chemprop-regression-on-melting-point">
<h3>Q1. Chemprop regression on melting point<a class="headerlink" href="#q1-chemprop-regression-on-melting-point" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Train Chemprop on <code class="docutils literal notranslate"><span class="pre">mp_data.csv</span></code> for <code class="docutils literal notranslate"><span class="pre">--epochs</span> <span class="pre">20</span></code></p></li>
<li><p>Predict on at least 5 new SMILES of your choice and list the predictions</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TO DO</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="q2-chemprop-classification-on-toxicity-student-challenge">
<h3>Q2. Chemprop classification on toxicity (student challenge)<a class="headerlink" href="#q2-chemprop-classification-on-toxicity-student-challenge" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Convert <code class="docutils literal notranslate"><span class="pre">Toxicity</span></code> to <code class="docutils literal notranslate"><span class="pre">1/0</span></code> using the mapping <code class="docutils literal notranslate"><span class="pre">{toxic:1,</span> <span class="pre">non_toxic:0}</span></code></p></li>
<li><p>Save <code class="docutils literal notranslate"><span class="pre">[&quot;SMILES&quot;,&quot;Toxicity_bin&quot;]</span></code> to <code class="docutils literal notranslate"><span class="pre">tox_data.csv</span></code></p></li>
<li><p>Train with <code class="docutils literal notranslate"><span class="pre">--class-balance</span> <span class="pre">--epochs</span> <span class="pre">20</span></code> and metrics <code class="docutils literal notranslate"><span class="pre">roc</span> <span class="pre">prc</span> <span class="pre">accuracy</span></code></p></li>
<li><p>Predict on a small set of SMILES;</p></li>
<li><p>Optional: show the class probability</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TO DO</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="solution-q1">
<h3>Solution Q1:<a class="headerlink" href="#solution-q1" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_reg</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span><span class="s2">&quot;Melting Point&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_reg</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;mp_data.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="o">!</span>chemprop<span class="w"> </span>train<span class="w"> </span><span class="err">\</span>
  <span class="o">--</span><span class="n">data</span><span class="o">-</span><span class="n">path</span> <span class="n">mp_data</span><span class="o">.</span><span class="n">csv</span> \
  <span class="o">-</span><span class="n">t</span> <span class="n">regression</span> \
  <span class="o">-</span><span class="n">s</span> <span class="n">SMILES</span> \
  <span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">columns</span> <span class="s2">&quot;Melting Point&quot;</span> \
  <span class="o">-</span><span class="n">o</span> <span class="n">mp_model_q4</span> \
  <span class="o">--</span><span class="n">num</span><span class="o">-</span><span class="n">replicates</span> <span class="mi">1</span> \
  <span class="o">--</span><span class="n">epochs</span> <span class="mi">20</span> \
  <span class="o">--</span><span class="n">metrics</span> <span class="n">mae</span> <span class="n">rmse</span> <span class="n">r2</span> \
  <span class="o">--</span><span class="n">tracking</span><span class="o">-</span><span class="n">metric</span> <span class="n">r2</span>

<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;SMILES&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;CCO&quot;</span><span class="p">,</span><span class="s2">&quot;c1ccccc1&quot;</span><span class="p">,</span><span class="s2">&quot;CC(=O)O&quot;</span><span class="p">,</span><span class="s2">&quot;CCN(CC)CC&quot;</span><span class="p">,</span><span class="s2">&quot;O=C(O)C(O)C&quot;</span><span class="p">]})</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;q4_smiles.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="o">!</span>chemprop<span class="w"> </span>predict<span class="w"> </span><span class="err">\</span>
  <span class="o">--</span><span class="n">test</span><span class="o">-</span><span class="n">path</span> <span class="n">q4_smiles</span><span class="o">.</span><span class="n">csv</span> \
  <span class="o">--</span><span class="n">model</span><span class="o">-</span><span class="n">paths</span> <span class="n">mp_model_q4</span><span class="o">/</span><span class="n">replicate_0</span><span class="o">/</span><span class="n">model_0</span><span class="o">/</span><span class="n">best</span><span class="o">.</span><span class="n">pt</span> \
  <span class="o">--</span><span class="n">preds</span><span class="o">-</span><span class="n">path</span> <span class="n">q4_preds</span><span class="o">.</span><span class="n">csv</span>

<span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;q4_preds.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="solution-q2">
<h3>Solution Q2<a class="headerlink" href="#solution-q2" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span><span class="s2">&quot;Toxicity&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Toxicity_bin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Toxicity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="s2">&quot;toxic&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;non_toxic&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span><span class="s2">&quot;Toxicity_bin&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;tox_data.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="o">!</span>chemprop<span class="w"> </span>train<span class="w"> </span><span class="err">\</span>
  <span class="o">--</span><span class="n">data</span><span class="o">-</span><span class="n">path</span> <span class="n">tox_data</span><span class="o">.</span><span class="n">csv</span> \
  <span class="o">-</span><span class="n">t</span> <span class="n">classification</span> \
  <span class="o">-</span><span class="n">s</span> <span class="n">SMILES</span> \
  <span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">columns</span> <span class="n">Toxicity_bin</span> \
  <span class="o">-</span><span class="n">o</span> <span class="n">tox_model</span> \
  <span class="o">--</span><span class="n">num</span><span class="o">-</span><span class="n">replicates</span> <span class="mi">1</span> \
  <span class="o">--</span><span class="n">epochs</span> <span class="mi">20</span> \
  <span class="o">--</span><span class="n">class</span><span class="o">-</span><span class="n">balance</span> \
  <span class="o">--</span><span class="n">metrics</span> <span class="n">roc</span> <span class="n">prc</span> <span class="n">accuracy</span> \
  <span class="o">--</span><span class="n">tracking</span><span class="o">-</span><span class="n">metric</span> <span class="n">roc</span>

<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;SMILES&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;CCO&quot;</span><span class="p">,</span><span class="s2">&quot;c1ccccc1&quot;</span><span class="p">,</span><span class="s2">&quot;O=[N+](=O)[O-]&quot;</span><span class="p">,</span><span class="s2">&quot;ClCCl&quot;</span><span class="p">,</span><span class="s2">&quot;CC(=O)Cl&quot;</span><span class="p">]})</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;q5_smiles.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="o">!</span>chemprop<span class="w"> </span>predict<span class="w"> </span><span class="err">\</span>
  <span class="o">--</span><span class="n">test</span><span class="o">-</span><span class="n">path</span> <span class="n">q5_smiles</span><span class="o">.</span><span class="n">csv</span> \
  <span class="o">--</span><span class="n">model</span><span class="o">-</span><span class="n">paths</span> <span class="n">tox_model</span><span class="o">/</span><span class="n">replicate_0</span><span class="o">/</span><span class="n">model_0</span><span class="o">/</span><span class="n">best</span><span class="o">.</span><span class="n">pt</span> \
  <span class="o">--</span><span class="n">preds</span><span class="o">-</span><span class="n">path</span> <span class="n">q5_preds</span><span class="o">.</span><span class="n">csv</span>

<span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;q5_preds.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="lecture-09.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Lecture 9 - Graph Neural Networks</p>
      </div>
    </a>
    <a class="right-next"
       href="lecture-11.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Lecture 11 - Dimension Reduction for Data Visualization</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#directed-message-passing-neural-network-d-mpnn">1. Directed message-passing neural network (D-MPNN)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preparation">2. Data preparation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#property-prediction-regression">3. Property prediction (regression)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pick-blocks">3.1 Pick blocks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#build-model-and-trainer">3.2 Build model and trainer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#train">3.3 Train</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#test-and-parity-plot">3.4 Test and parity plot</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#property-prediction-classification">4. Property prediction (classification)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#build-classification-dataset">4.1 Build classification dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-and-training">4.2 Model and training</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#roc-curve">4.3 ROC curve</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reactivity-and-selectivity">5. Reactivity and selectivity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reactivity-classifier">5.1 Reactivity classifier</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rationale">6. Rationale</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solubility-prediction-rationale">6.1 Solubility prediction rationale</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reactivity-prediction-rationale">6.2 Reactivity prediction rationale</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#chemprop-cli-command-line-interface">7. Chemprop CLI (Command-Line Interface)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reactivity-classification-ch-oxidation-dataset">7.3 Reactivity classification (C–H oxidation dataset)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-reference">7. Quick Reference</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">8. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inclass-activity">10. In‑class activity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q1-chemprop-regression-on-melting-point">Q1. Chemprop regression on melting point</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q2-chemprop-classification-on-toxicity-student-challenge">Q2. Chemprop classification on toxicity (student challenge)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-q1">Solution Q1:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-q2">Solution Q2</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>