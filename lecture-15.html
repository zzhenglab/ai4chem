
<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lecture 15 - Multi-objective Bayesian Optimization &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css?v=6ad1a40c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js?v=2b91c5f0"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js?v=afe5de03"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="application/vnd.jupyter.widget-state+json">{"state": {"62c2927c60e14a00b275bfe97a9efd4a": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "4971220edc7b4300ad257ec66cc5b500": {"model_name": "VBoxModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "VBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "VBoxView", "box_style": "", "children": ["IPY_MODEL_f1daef861f954da0b7b6d6320c858718"], "layout": "IPY_MODEL_62c2927c60e14a00b275bfe97a9efd4a", "tabbable": null, "tooltip": null}}, "94d2c617e1b641b4b8d0e30428efb30f": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "f4d507633b934428a91f30d1d15f7d22": {"model_name": "HTMLStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HTMLStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "background": null, "description_width": "", "font_size": null, "text_color": null}}, "601c46cd02374581b3af7be9e05acf43": {"model_name": "HTMLModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "HTMLView", "description": "", "description_allow_html": false, "layout": "IPY_MODEL_94d2c617e1b641b4b8d0e30428efb30f", "placeholder": "\u200b", "style": "IPY_MODEL_f4d507633b934428a91f30d1d15f7d22", "tabbable": null, "tooltip": null, "value": "<h2>Multi-objective Bayesian Optimization</h2>"}}, "e571eef1ebc047b0aba5e8b3a555a7be": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "4d3396f839b143eaa49b7492bed40511": {"model_name": "HTMLStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HTMLStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "background": null, "description_width": "", "font_size": null, "text_color": null}}, "2f984f058b83420bb2ac9b83b5b7fe00": {"model_name": "HTMLModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "HTMLView", "description": "", "description_allow_html": false, "layout": "IPY_MODEL_e571eef1ebc047b0aba5e8b3a555a7be", "placeholder": "\u200b", "style": "IPY_MODEL_4d3396f839b143eaa49b7492bed40511", "tabbable": null, "tooltip": null, "value": "Choose a mode to begin"}}, "e303057b5bbe416c8db19d2f82c8b405": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "8e671663d1d04181ab491b29afc2e33d": {"model_name": "ButtonStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "button_color": null, "font_family": null, "font_size": null, "font_style": null, "font_variant": null, "font_weight": null, "text_color": null, "text_decoration": null}}, "2ab534c457394045a5c122f6a42bb282": {"model_name": "ButtonModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "ButtonView", "button_style": "primary", "description": "Establish New Experiment", "disabled": false, "icon": "plus", "layout": "IPY_MODEL_e303057b5bbe416c8db19d2f82c8b405", "style": "IPY_MODEL_8e671663d1d04181ab491b29afc2e33d", "tabbable": null, "tooltip": null}}, "38ba07784f0e44118e11b6eb1f132b5e": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "dd4ab095b6c141698943909a31a2bc50": {"model_name": "ButtonStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "button_color": null, "font_family": null, "font_size": null, "font_style": null, "font_variant": null, "font_weight": null, "text_color": null, "text_decoration": null}}, "096d297d14d148da8065cb3a3bb4778e": {"model_name": "ButtonModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "ButtonView", "button_style": "", "description": "Start from Existing Experiment", "disabled": false, "icon": "upload", "layout": "IPY_MODEL_38ba07784f0e44118e11b6eb1f132b5e", "style": "IPY_MODEL_dd4ab095b6c141698943909a31a2bc50", "tabbable": null, "tooltip": null}}, "ed9460f0388f49098d65ae11a89c4e35": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "8fef22c5f9d14db0beaeaa55e544cf7f": {"model_name": "HBoxModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_2ab534c457394045a5c122f6a42bb282", "IPY_MODEL_096d297d14d148da8065cb3a3bb4778e"], "layout": "IPY_MODEL_ed9460f0388f49098d65ae11a89c4e35", "tabbable": null, "tooltip": null}}, "51621d5bcda14150b5a6ade28d677722": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "f1daef861f954da0b7b6d6320c858718": {"model_name": "VBoxModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "VBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "VBoxView", "box_style": "", "children": ["IPY_MODEL_601c46cd02374581b3af7be9e05acf43", "IPY_MODEL_2f984f058b83420bb2ac9b83b5b7fe00", "IPY_MODEL_8fef22c5f9d14db0beaeaa55e544cf7f"], "layout": "IPY_MODEL_51621d5bcda14150b5a6ade28d677722", "tabbable": null, "tooltip": null}}}, "version_major": 2, "version_minor": 0}</script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script crossorigin="anonymous" data-jupyter-widgets-cdn="https://cdn.jsdelivr.net/npm/" src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@1.0.6/dist/embed-amd.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lecture-15';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Lecture 16 - Reinforcement Learning" href="lecture-16.html" />
    <link rel="prev" title="Lecture 14 - Bayesian Optimization for Synthesis Conditions" href="lecture-14.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to CHEM 5080: AI for Chemistry
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="lecture-01.html">Lecture 1 - Python Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-02.html">Lecture 2 - Pandas and Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-03.html">Lecture 3 - SMILES and RDKit</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-04.html">Lecture 4 - Chemical Structure Identifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-05.html">Lecture 5 - Regression and Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-06.html">Lecture 6 - Cross-Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-07.html">Lecture 7 - Decision Trees and Random Forests</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-08.html">Lecture 8 - Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-09.html">Lecture 9 - Graph Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-10.html">Lecture 10 - Property &amp; Reaction Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-11.html">Lecture 11 - Dimension Reduction for Data Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-12.html">Lecture 12 - Self-Supervised Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-13.html">Lecture 13 - De Novo Molecule Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-14.html">Lecture 14 - Bayesian Optimization for Synthesis Conditions</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Lecture 15 - Multi-objective Bayesian Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-16.html">Lecture 16 - Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-17.html">Lecture 17 - PU Learning</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Flecture-15.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/lecture-15.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lecture 15 - Multi-objective Bayesian Optimization</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">0. Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-multiobjective-optimization">1. What is multiobjective optimization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-mof-toy-dataset">2. Load the MOF toy dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-engineering-for-multiobjective-modeling">3. Feature engineering for multiobjective modeling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#minimal-numeric-features">3.1 Minimal numeric features</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#one-hot-encoding-for-smiles">3.2 One-hot encoding for SMILES</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#targets-for-multiobjective-learning">3.3 Targets for multiobjective learning</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pareto-utilities-and-hypervolume-in-2d">4. Pareto utilities and hypervolume in 2D</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#scalarization-and-surrogate-models-for-each-objective">5. Scalarization and surrogate models for each objective</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#train-test-split-and-scaling">5.1 Train test split and scaling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#three-gps-with-matern-on-the-50-point-split">5.2 Three GPs with Matern on the 50 point split</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rf-trio-trained-only-on-the-50-point-split">5.3 RF trio trained only on the 50 point split</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#acquisition-for-multiobjective-bo">6. Acquisition for multiobjective BO</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#end-to-end-mobo-loop-on-the-mof-dataset">7. End to end MOBO loop on the MOF dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">8. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-class-activity">9. In-class activity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q1-build-a-tiny-bo-coach-with-an-llm">Q1. Build a tiny BO “coach” with an LLM</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lecture-15-multi-objective-bayesian-optimization">
<h1>Lecture 15 - Multi-objective Bayesian Optimization<a class="headerlink" href="#lecture-15-multi-objective-bayesian-optimization" title="Permalink to this heading">#</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#learning-goals" id="id1">Learning goals</a></p></li>
<li><p><a class="reference internal" href="#setup" id="id2">0. Setup</a></p></li>
<li><p><a class="reference internal" href="#what-is-multiobjective-optimization" id="id3">1. What is multiobjective optimization</a></p></li>
<li><p><a class="reference internal" href="#load-the-mof-toy-dataset" id="id4">2. Load the MOF toy dataset</a></p></li>
<li><p><a class="reference internal" href="#feature-engineering-for-multiobjective-modeling" id="id5">3. Feature engineering for multiobjective modeling</a></p></li>
<li><p><a class="reference internal" href="#pareto-utilities-and-hypervolume-in-2d" id="id6">4. Pareto utilities and hypervolume in 2D</a></p></li>
<li><p><a class="reference internal" href="#scalarization-and-surrogate-models-for-each-objective" id="id7">5. Scalarization and surrogate models for each objective</a></p></li>
<li><p><a class="reference internal" href="#acquisition-for-multiobjective-bo" id="id8">6. Acquisition for multiobjective BO</a></p></li>
<li><p><a class="reference internal" href="#end-to-end-mobo-loop-on-the-mof-dataset" id="id9">7. End to end MOBO loop on the MOF dataset</a></p></li>
<li><p><a class="reference internal" href="#glossary" id="id10">8. Glossary</a></p></li>
<li><p><a class="reference internal" href="#in-class-activity" id="id11">9. In-class activity</a></p></li>
</ul>
</nav>
<section id="learning-goals">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Learning goals</a><a class="headerlink" href="#learning-goals" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Connect single objective Bayesian Optimization to multiobjective problems.</p></li>
<li><p>Define Pareto dominance, Pareto front, scalarization, hypervolume, and expected hypervolume improvement.</p></li>
<li><p>Build a simple <strong>multiobjective active learning</strong> loop on a materials.</p></li>
</ul>
<p><a class="reference external" href="https://colab.research.google.com/drive/1QvnxeGN3JpZl1viIaQ9WxQrNJ6gYFkya?usp=sharing"><img alt="Colab" src="https://img.shields.io/badge/Open-Colab-orange" /></a></p>
</section>
<section id="setup">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">0. Setup</a><a class="headerlink" href="#setup" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 0.1 Imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">KFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.gaussian_process</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.gaussian_process.kernels</span><span class="w"> </span><span class="kn">import</span> <span class="n">Matern</span><span class="p">,</span> <span class="n">RBF</span><span class="p">,</span> <span class="n">WhiteKernel</span><span class="p">,</span> <span class="n">ConstantKernel</span> <span class="k">as</span> <span class="n">C</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">MinMaxScaler</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">r2_score</span><span class="p">,</span> <span class="n">mean_absolute_error</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">5.4</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span><span class="p">,</span> <span class="n">RDLogger</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">Descriptors</span><span class="p">,</span> <span class="n">Crippen</span><span class="p">,</span> <span class="n">rdMolDescriptors</span><span class="p">,</span> <span class="n">QED</span><span class="p">,</span> <span class="n">Draw</span>
    <span class="n">RD</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="o">%</span><span class="k">pip</span> install rdkit
      <span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span><span class="p">,</span> <span class="n">RDLogger</span>
      <span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">Descriptors</span><span class="p">,</span> <span class="n">Crippen</span><span class="p">,</span> <span class="n">rdMolDescriptors</span><span class="p">,</span> <span class="n">QED</span><span class="p">,</span> <span class="n">Draw</span>
      <span class="n">RD</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RDKit not installed&quot;</span><span class="p">)</span>
      <span class="n">RD</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">Chem</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="what-is-multiobjective-optimization">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">1. What is multiobjective optimization</a><a class="headerlink" href="#what-is-multiobjective-optimization" title="Permalink to this heading">#</a></h2>
<p>In previous lecture, we used a <strong>surrogate model</strong> to represent an expensive experiment, then selected the next experiment using an <strong>acquisition function</strong> like Expected Improvement to iteratively find the optimized yield by tuning reaction parameter such as temperature.</p>
<p>We learned that we can:</p>
<ol class="arabic simple">
<li><p>Fit a surrogate on <span class="math notranslate nohighlight">\((X, y)\)</span>.</p></li>
<li><p>Predict <span class="math notranslate nohighlight">\(\mu(x)\)</span> and <span class="math notranslate nohighlight">\(\sigma(x)\)</span> on candidates.</p></li>
<li><p>Score an acquisition <span class="math notranslate nohighlight">\(a(x)\)</span> (EI, UCB, PI).</p></li>
<li><p>Pick <span class="math notranslate nohighlight">\(x_{next} = \arg\max a(x)\)</span> and run the experiment.</p></li>
<li><p>Update data and repeat.</p></li>
</ol>
<p>Today we extend that idea to <em>multiple</em> goals at once, for example high yield and high purity with decent reproducibility.</p>
<p>In multiobjective optimization we consider a vector objective
$<span class="math notranslate nohighlight">\({\bf f}(x) = \big(f_1(x), f_2(x), \ldots, f_M(x)\big).\)</span>$</p>
<p>For chemical synthesis you might set</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(f_1\)</span> as yield to maximize,</p></li>
<li><p><span class="math notranslate nohighlight">\(f_2\)</span> as purity or selectivity to maximize,</p></li>
<li><p><span class="math notranslate nohighlight">\(f_3\)</span> as cost to minimize or reproducibility score to maximize.</p></li>
</ul>
<p>There is usually no single <span class="math notranslate nohighlight">\(x\)</span> that maximizes all objectives together. Instead we aim to approximate the <strong>Pareto front</strong>.</p>
<p>Below are a few definitions associated with this idea:</p>
<ul class="simple">
<li><p><strong>Dominance</strong>: a point <span class="math notranslate nohighlight">\(a\)</span> dominates <span class="math notranslate nohighlight">\(b\)</span> if it is at least as good on all objectives and strictly better on at least one.</p></li>
<li><p><strong>Pareto set</strong>: the set of nondominated decision points.</p></li>
<li><p><strong>Pareto front</strong>: the image of the Pareto set in objective space.</p></li>
<li><p><strong>Hypervolume</strong>: the volume of objective space dominated by the current front relative to a reference point.</p></li>
</ul>
<p>Below is a tiny 2D example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1.1 Simple dominance and Pareto front in 2D</span>
<span class="k">def</span><span class="w"> </span><span class="nf">pareto_mask</span><span class="p">(</span><span class="n">Y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a boolean mask for nondominated rows of Y to maximize both columns.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="n">dominates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">Y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">keep</span><span class="p">[</span><span class="n">dominates</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">keep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">keep</span>

<span class="n">Y_demo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>

<span class="p">])</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">pareto_mask</span><span class="p">(</span><span class="n">Y_demo</span><span class="p">)</span>
<span class="n">Y_nd</span> <span class="o">=</span> <span class="n">Y_demo</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

<span class="c1"># Visualize</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_demo</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Y_demo</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">Y_demo</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;All&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_nd</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Y_nd</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pareto&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Yield&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Selectivity&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Pareto front in objective space&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f7e3fdd716d66fd683287a4958a3f5b697cc0ec651538d217df1134c37507c78.png" src="_images/f7e3fdd716d66fd683287a4958a3f5b697cc0ec651538d217df1134c37507c78.png" />
</div>
</div>
<div class="admonition-exercise admonition">
<p class="admonition-title">⏰ <strong>Exercise</strong></p>
<p>Add a new point <code class="docutils literal notranslate"><span class="pre">[0.7,</span> <span class="pre">0.6]</span></code> to <code class="docutils literal notranslate"><span class="pre">Y_demo</span></code>, recompute the mask, and plot again. Which earlier nondominated points become dominated now?</p>
</div>
</section>
<hr class="docutils" />
<section id="load-the-mof-toy-dataset">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">2. Load the MOF toy dataset</a><a class="headerlink" href="#load-the-mof-toy-dataset" title="Permalink to this heading">#</a></h2>
<p>We will use the provided full factorial style synthetic dataset that mimics MOF synthesis outcomes across temperature, time, concentration, solvent, and linker choice. The file includes yield, purity, and reproducibility.</p>
<p>We will use a synthetic MOF dataset that records MOF synthesis outcomes across temperature, time, concentration, solvent, and linker choice. The file includes yield, purity, and reproducibility:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">yield</span></code> in <span class="math notranslate nohighlight">\([0, 0.99]\)</span> with noise, boosts, and failures.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">purity</span></code> in <span class="math notranslate nohighlight">\([0, 1]\)</span> with discontinuities.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reproducibility</span></code> in <span class="math notranslate nohighlight">\(\{0.25, 0.5, 0.75, 1.0\}\)</span>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 2.1 Load the dataset</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/zzhenglab/ai4chem/main/book/_data/mof_yield_dataset.csv&quot;</span>
<span class="n">df_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">df_raw</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>smiles</th>
      <th>temperature</th>
      <th>time_h</th>
      <th>concentration_M</th>
      <th>solvent_DMF</th>
      <th>yield</th>
      <th>purity</th>
      <th>reproducibility</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>O=C(O)c1ccc(cc1)C(=O)O</td>
      <td>25</td>
      <td>12</td>
      <td>0.05</td>
      <td>0</td>
      <td>0.29</td>
      <td>0.55</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>1</th>
      <td>O=C(O)/C=C/C(=O)O</td>
      <td>25</td>
      <td>12</td>
      <td>0.05</td>
      <td>0</td>
      <td>0.42</td>
      <td>0.45</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Cc1ncc[nH]1</td>
      <td>25</td>
      <td>12</td>
      <td>0.05</td>
      <td>0</td>
      <td>0.66</td>
      <td>0.74</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>3</th>
      <td>O=C(O)c1cc(C(=O)O)cc(C(=O)O)c1</td>
      <td>25</td>
      <td>12</td>
      <td>0.05</td>
      <td>0</td>
      <td>0.21</td>
      <td>0.52</td>
      <td>0.75</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Nc1cc(C(=O)O)ccc1C(=O)O</td>
      <td>25</td>
      <td>12</td>
      <td>0.05</td>
      <td>0</td>
      <td>0.23</td>
      <td>0.48</td>
      <td>0.25</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>19995</th>
      <td>O=C(O)c1cc(F)ccc1C(=O)O</td>
      <td>160</td>
      <td>120</td>
      <td>0.50</td>
      <td>1</td>
      <td>0.29</td>
      <td>0.46</td>
      <td>0.50</td>
    </tr>
    <tr>
      <th>19996</th>
      <td>O=C(O)c1ccc2cccc(C(=O)O)c2c1</td>
      <td>160</td>
      <td>120</td>
      <td>0.50</td>
      <td>1</td>
      <td>0.51</td>
      <td>0.40</td>
      <td>0.50</td>
    </tr>
    <tr>
      <th>19997</th>
      <td>O=C(O)c1cccc2c1ccc(C(=O)O)c2</td>
      <td>160</td>
      <td>120</td>
      <td>0.50</td>
      <td>1</td>
      <td>0.52</td>
      <td>0.32</td>
      <td>0.50</td>
    </tr>
    <tr>
      <th>19998</th>
      <td>O=C(O)c1ccc(cc1)-c2ccc(cc2)C(=O)O</td>
      <td>160</td>
      <td>120</td>
      <td>0.50</td>
      <td>1</td>
      <td>0.58</td>
      <td>0.18</td>
      <td>0.50</td>
    </tr>
    <tr>
      <th>19999</th>
      <td>c1ccc2[nH]cnc2c1</td>
      <td>160</td>
      <td>120</td>
      <td>0.50</td>
      <td>1</td>
      <td>0.12</td>
      <td>0.27</td>
      <td>0.75</td>
    </tr>
  </tbody>
</table>
<p>20000 rows × 8 columns</p>
</div></div></div>
</div>
<p>The reaction parameters include:</p>
<ol class="arabic simple">
<li><p>temperature (°C): 10 levels -&gt; <code class="docutils literal notranslate"><span class="pre">[25,</span> <span class="pre">40,</span> <span class="pre">55,</span> <span class="pre">70,</span> <span class="pre">85,</span> <span class="pre">100,</span> <span class="pre">115,</span> <span class="pre">130,</span> <span class="pre">155,</span> <span class="pre">160]</span></code></p></li>
<li><p>time_h (hours): 10 levels -&gt; <code class="docutils literal notranslate"><span class="pre">[12,</span> <span class="pre">24,</span> <span class="pre">...,</span> <span class="pre">120]</span></code></p></li>
<li><p>concentration_M (M): 10 levels -&gt; <code class="docutils literal notranslate"><span class="pre">[0.05,</span> <span class="pre">0.10,</span> <span class="pre">...,</span> <span class="pre">0.50]</span></code></p></li>
<li><p>solvent_DMF: one-hot binary {<code class="docutils literal notranslate"><span class="pre">0</span></code>=H2O, <code class="docutils literal notranslate"><span class="pre">1</span></code>=dimethyl foramide}</p></li>
<li><p>organic linker (10 choices), such as <code class="docutils literal notranslate"><span class="pre">Fumaric</span> <span class="pre">acid</span></code>, <code class="docutils literal notranslate"><span class="pre">Trimesic</span> <span class="pre">acid</span></code>, and <code class="docutils literal notranslate"><span class="pre">Benzimidazole</span></code>.</p></li>
</ol>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_raw</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">20000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># we use full set for now</span>

<span class="n">cols_with_few_values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;time_h&#39;</span><span class="p">,</span> <span class="s1">&#39;concentration_M&#39;</span><span class="p">,</span> <span class="s1">&#39;solvent_DMF&#39;</span><span class="p">]</span>

<span class="n">desc_catlike</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_raw</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">df_raw</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols_with_few_values</span><span class="p">})</span>
    <span class="p">[</span> <span class="p">[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols_with_few_values</span> <span class="p">]</span>
    <span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[[</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="s1">&#39;unique&#39;</span><span class="p">,</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="s1">&#39;freq&#39;</span><span class="p">]]</span>
<span class="p">)</span>

<span class="n">desc_catlike</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>unique</th>
      <th>top</th>
      <th>freq</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>smiles</th>
      <td>20000</td>
      <td>10</td>
      <td>O=C(O)c1ccc(cc1)C(=O)O</td>
      <td>2000</td>
    </tr>
    <tr>
      <th>temperature</th>
      <td>20000</td>
      <td>10</td>
      <td>25</td>
      <td>2000</td>
    </tr>
    <tr>
      <th>time_h</th>
      <td>20000</td>
      <td>10</td>
      <td>12</td>
      <td>2000</td>
    </tr>
    <tr>
      <th>concentration_M</th>
      <td>20000.0</td>
      <td>10.0</td>
      <td>0.05</td>
      <td>2000.0</td>
    </tr>
    <tr>
      <th>solvent_DMF</th>
      <td>20000</td>
      <td>2</td>
      <td>0</td>
      <td>10000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># How many linkers and a quick count</span>
<span class="n">linker_counts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;smiles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">linker_counts</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="s2">&quot;n_linkers:&quot;</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;smiles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(smiles
 Nc1cc(C(=O)O)ccc1C(=O)O              2000
 O=C(O)/C=C/C(=O)O                    2000
 O=C(O)c1cc(C(=O)O)cc(C(=O)O)c1       2000
 O=C(O)c1cccc2c1ccc(C(=O)O)c2         2000
 O=C(O)c1ccc2cccc(C(=O)O)c2c1         2000
 O=C(O)c1ccc(cc1)C(=O)O               2000
 O=C(O)c1ccc(cc1)-c2ccc(cc2)C(=O)O    2000
 O=C(O)c1cc(F)ccc1C(=O)O              2000
 Cc1ncc[nH]1                          2000
 c1ccc2[nH]cnc2c1                     2000
 Name: count, dtype: int64,
 &#39;n_linkers:&#39;,
 10)
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="feature-engineering-for-multiobjective-modeling">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">3. Feature engineering for multiobjective modeling</a><a class="headerlink" href="#feature-engineering-for-multiobjective-modeling" title="Permalink to this heading">#</a></h2>
<p>We will build a light feature set using both synthesis conditions and molecular structure information. This compact design provides chemical and process context without relying on heavy cheminformatics toolkits.</p>
<section id="minimal-numeric-features">
<h3>3.1 Minimal numeric features<a class="headerlink" href="#minimal-numeric-features" title="Permalink to this heading">#</a></h3>
<p>We begin with numeric synthesis parameters that directly influence material outcomes:
<code class="docutils literal notranslate"><span class="pre">temperature</span></code>, <code class="docutils literal notranslate"><span class="pre">time_h</span></code>, <code class="docutils literal notranslate"><span class="pre">concentration_M</span></code>, and <code class="docutils literal notranslate"><span class="pre">solvent_DMF</span></code>.
These are copied into a numeric feature frame:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;time_h&quot;</span><span class="p">,</span> <span class="s2">&quot;concentration_M&quot;</span><span class="p">,</span> <span class="s2">&quot;solvent_DMF&quot;</span><span class="p">]</span>
<span class="n">X_num</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">num_cols</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X_num</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>temperature</th>
      <th>time_h</th>
      <th>concentration_M</th>
      <th>solvent_DMF</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>160.0</td>
      <td>72.0</td>
      <td>0.35</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>55.0</td>
      <td>60.0</td>
      <td>0.50</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>155.0</td>
      <td>48.0</td>
      <td>0.15</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>160.0</td>
      <td>72.0</td>
      <td>0.30</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>55.0</td>
      <td>84.0</td>
      <td>0.30</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>19995</th>
      <td>115.0</td>
      <td>72.0</td>
      <td>0.35</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>19996</th>
      <td>160.0</td>
      <td>108.0</td>
      <td>0.15</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>19997</th>
      <td>85.0</td>
      <td>120.0</td>
      <td>0.15</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>19998</th>
      <td>100.0</td>
      <td>48.0</td>
      <td>0.50</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>19999</th>
      <td>40.0</td>
      <td>48.0</td>
      <td>0.35</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>20000 rows × 4 columns</p>
</div></div></div>
</div>
</section>
<section id="one-hot-encoding-for-smiles">
<h3>3.2 One-hot encoding for SMILES<a class="headerlink" href="#one-hot-encoding-for-smiles" title="Permalink to this heading">#</a></h3>
<p>The SMILES column lists discrete molecular structures.
To make this information usable by machine learning models, we convert it into a numeric form through <strong>one-hot encoding</strong>.</p>
<p>One-hot encoding creates a binary vector for each category:</p>
<ul class="simple">
<li><p>Each unique SMILES gets its own column.</p></li>
<li><p>A value of <code class="docutils literal notranslate"><span class="pre">1</span></code> marks the presence of that molecule in a given row, and <code class="docutils literal notranslate"><span class="pre">0</span></code> otherwise.</p></li>
</ul>
<p>This prevents the model from interpreting SMILES identifiers as ordinal numbers while preserving molecular identity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneHotEncoder</span>

<span class="c1"># Define encoder</span>
<span class="n">enc</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Fit and transform SMILES into binary vectors</span>
<span class="n">smiles_encoded</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;smiles&#39;</span><span class="p">]])</span>

<span class="c1"># Retrieve encoded column names</span>
<span class="n">smiles_feature_names</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">([</span><span class="s1">&#39;smiles&#39;</span><span class="p">])</span>

<span class="c1"># Build DataFrame for encoded SMILES</span>
<span class="n">X_smiles</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">smiles_encoded</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">smiles_feature_names</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="c1"># Combine numeric and encoded features</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_num</span><span class="p">,</span> <span class="n">X_smiles</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">X</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(20000, 14) [&#39;temperature&#39;, &#39;time_h&#39;, &#39;concentration_M&#39;, &#39;solvent_DMF&#39;, &#39;smiles_Cc1ncc[nH]1&#39;, &#39;smiles_Nc1cc(C(=O)O)ccc1C(=O)O&#39;, &#39;smiles_O=C(O)/C=C/C(=O)O&#39;, &#39;smiles_O=C(O)c1cc(C(=O)O)cc(C(=O)O)c1&#39;, &#39;smiles_O=C(O)c1cc(F)ccc1C(=O)O&#39;, &#39;smiles_O=C(O)c1ccc(cc1)-c2ccc(cc2)C(=O)O&#39;]
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>temperature</th>
      <th>time_h</th>
      <th>concentration_M</th>
      <th>solvent_DMF</th>
      <th>smiles_Cc1ncc[nH]1</th>
      <th>smiles_Nc1cc(C(=O)O)ccc1C(=O)O</th>
      <th>smiles_O=C(O)/C=C/C(=O)O</th>
      <th>smiles_O=C(O)c1cc(C(=O)O)cc(C(=O)O)c1</th>
      <th>smiles_O=C(O)c1cc(F)ccc1C(=O)O</th>
      <th>smiles_O=C(O)c1ccc(cc1)-c2ccc(cc2)C(=O)O</th>
      <th>smiles_O=C(O)c1ccc(cc1)C(=O)O</th>
      <th>smiles_O=C(O)c1ccc2cccc(C(=O)O)c2c1</th>
      <th>smiles_O=C(O)c1cccc2c1ccc(C(=O)O)c2</th>
      <th>smiles_c1ccc2[nH]cnc2c1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>160.0</td>
      <td>72.0</td>
      <td>0.35</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>55.0</td>
      <td>60.0</td>
      <td>0.50</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>155.0</td>
      <td>48.0</td>
      <td>0.15</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="targets-for-multiobjective-learning">
<h3>3.3 Targets for multiobjective learning<a class="headerlink" href="#targets-for-multiobjective-learning" title="Permalink to this heading">#</a></h3>
<p>We will form a 3 objective vector:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(f_1\)</span>: <code class="docutils literal notranslate"><span class="pre">yield</span></code> to maximize.</p></li>
<li><p><span class="math notranslate nohighlight">\(f_2\)</span>: <code class="docutils literal notranslate"><span class="pre">purity</span></code> to maximize.</p></li>
<li><p><span class="math notranslate nohighlight">\(f_3\)</span>: numeric reproducibility where higher is better.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 3.4 Target matrix</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;yield&quot;</span><span class="p">,</span><span class="s2">&quot;purity&quot;</span><span class="p">,</span><span class="s2">&quot;reproducibility&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">Y</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">Y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.   0.08 0.25] [0.99 0.94 1.  ]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0.  , 0.17, 0.25],
       [0.49, 0.41, 0.5 ],
       [0.43, 0.26, 0.5 ],
       ...,
       [0.19, 0.75, 0.25],
       [0.33, 0.68, 1.  ],
       [0.28, 0.48, 0.5 ]])
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="pareto-utilities-and-hypervolume-in-2d">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">4. Pareto utilities and hypervolume in 2D</a><a class="headerlink" href="#pareto-utilities-and-hypervolume-in-2d" title="Permalink to this heading">#</a></h2>
<p>This section builds intuition for multiobjective comparison using two outcomes at a time before returning to three.</p>
<p>We use <span class="math notranslate nohighlight">\(f_1=\)</span> = yield and <span class="math notranslate nohighlight">\(f_2=\)</span>  = purity. The goal is to identify the subset of experiments that are not outperformed by any other experiment across both objectives. These are the candidates on the Pareto front. Working in 2D makes it easy to see which points survive and how much area of the objective space they dominate relative to a chosen reference.</p>
<div class="admonition-note admonition">
<p class="admonition-title">Note</p>
<p>Note that in reality, we usually start with only a couple of experiments. So we will show the case for both <strong>50</strong> experiment and the full dataset (<strong>20000</strong> experiments).</p>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">nondominated_mask</span><span class="p">(</span><span class="n">F</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Non dominated set for maximization.</span>
<span class="sd">    F: shape (n_points, n_obj)</span>
<span class="sd">    Returns boolean mask where True means non dominated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="n">dominates_i</span> <span class="o">=</span> <span class="p">((</span><span class="n">F</span> <span class="o">&gt;=</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">F</span> <span class="o">&gt;</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">dominates_i</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">dominates_i</span><span class="p">):</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">mask</span>


<span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">,</span> <span class="s2">&quot;purity&quot;</span><span class="p">,</span> <span class="s2">&quot;reproducibility&quot;</span><span class="p">]</span>


 <span class="c1"># 50 experiment sample: pairwise plots</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">idx_50</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">Y50</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">idx_50</span><span class="p">]</span>

<span class="n">mask_50</span> <span class="o">=</span> <span class="n">nondominated_mask</span><span class="p">(</span><span class="n">Y50</span><span class="p">)</span>
<span class="n">front_50</span> <span class="o">=</span> <span class="n">Y50</span><span class="p">[</span><span class="n">mask_50</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y50</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">Y50</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;all 50&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">front_50</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">front_50</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pareto 50&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2">  |  50 sample&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/7ef0384f99728faf6f2ddab0e2e608c6e2bce11f879fe5ae4e08c54b16aa626a.png" src="_images/7ef0384f99728faf6f2ddab0e2e608c6e2bce11f879fe5ae4e08c54b16aa626a.png" />
<img alt="_images/d5751662257aa36d88ad8486c7755e62b29b47ab2bf95b21c017ace098198ba1.png" src="_images/d5751662257aa36d88ad8486c7755e62b29b47ab2bf95b21c017ace098198ba1.png" />
<img alt="_images/e5ab18456ec85b98186d25babf84e73c54b8b2a22ddcbdabe8673e23630640f0.png" src="_images/e5ab18456ec85b98186d25babf84e73c54b8b2a22ddcbdabe8673e23630640f0.png" />
</div>
</div>
<p>Now let’s look at the full dataset. Again, note that in reality you will not be able to see this “final answer.”</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Full set: pairwise plots</span>
<span class="n">mask_full</span> <span class="o">=</span> <span class="n">nondominated_mask</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
<span class="n">front_full</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">mask_full</span><span class="p">]</span>


<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">Y</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">front_full</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">front_full</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pareto&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2">  |  full set&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>       
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/6efda840a40ffac172eb4d48f8c82aa611a7e530e80d03cebf935da45799c711.png" src="_images/6efda840a40ffac172eb4d48f8c82aa611a7e530e80d03cebf935da45799c711.png" />
<img alt="_images/c1acafd0e2cf797ec9ce2265eaeb8f5c77c2428aa2ccd741f01c7030f89204ac.png" src="_images/c1acafd0e2cf797ec9ce2265eaeb8f5c77c2428aa2ccd741f01c7030f89204ac.png" />
<img alt="_images/af59906c356ee1c573ec58d7a29f7759772ce274198bdbba8963965f7dbf5eef.png" src="_images/af59906c356ee1c573ec58d7a29f7759772ce274198bdbba8963965f7dbf5eef.png" />
</div>
</div>
<p>Next, we talk about an important idea, <strong>hypervolume (HV)</strong> which is the volume of the dominated region bounded by a reference point <span class="math notranslate nohighlight">\(r\)</span>. It is a way to measure how much of the “good” region of objective space is covered by your Pareto front. In two objectives (for example, <code class="docutils literal notranslate"><span class="pre">yield</span></code> and <code class="docutils literal notranslate"><span class="pre">purity</span></code>), each experiment corresponds to a point. The Pareto front marks those points that are not outperformed by any other in both metrics. The hypervolume is then the total area (or volume in higher dimensions) between that front and a chosen <strong>reference point</strong>.</p>
<div class="admonition-note admonition">
<p class="admonition-title">Note</p>
<p>You can think of it as the portion of the map where the model or experiments are doing well. If your Pareto front moves outward toward higher yield and purity, the dominated region expands, and the hypervolume increases. A larger hypervolume means better overall trade offs across objectives.</p>
</div>
<p>The reference point defines the lower bound of the region you measure against. It must be <strong>worse than all observed points</strong> in every objective because hypervolume represents improvement relative to that point. For yield and purity, which are maximized, this means picking a reference near the bottom left corner of the plot.</p>
<p>If all your data are normalized between 0 and 1, the natural choice is <code class="docutils literal notranslate"><span class="pre">(0,</span> <span class="pre">0)</span></code> — representing the absolute worst case (zero yield, zero purity). You can also use <code class="docutils literal notranslate"><span class="pre">(0.2,</span> <span class="pre">0.2)</span></code> or another slightly higher reference if you want to focus only on improvements beyond a minimum acceptable performance threshold. That reference would mean: “We only care about the area above 20% yield and 20% purity.”</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">staircase_polygon_2d</span><span class="p">(</span><span class="n">front_2d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build polygon that represents the dominated region up to ref for maximization in 2D.</span>
<span class="sd">    Returns xs, ys ready for plt.fill.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">front_2d</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">front_2d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])]</span>   <span class="c1"># sort by x (f1) descending</span>
    <span class="n">y_env</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">F</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>       <span class="c1"># envelope in y (f2)</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">F</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">y_env</span><span class="p">,</span>    <span class="p">[</span><span class="n">y_env</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]])</span>
    <span class="k">return</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span>

<span class="k">def</span><span class="w"> </span><span class="nf">hypervolume_2d</span><span class="p">(</span><span class="n">front_2d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hypervolume in 2D for maximization.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">front_2d</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">front_2d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])]</span>
    <span class="n">y_env</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">F</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">F</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y_env</span><span class="p">,</span>   <span class="p">[</span><span class="n">y_env</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]])</span>
    <span class="n">widths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">heights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">ys</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">widths</span> <span class="o">*</span> <span class="n">heights</span><span class="p">))</span>

<span class="c1"># Pareto front for the 50 set</span>
<span class="n">mask50</span> <span class="o">=</span> <span class="n">nondominated_mask</span><span class="p">(</span><span class="n">Y50</span><span class="p">)</span>
<span class="n">front50</span> <span class="o">=</span> <span class="n">Y50</span><span class="p">[</span><span class="n">mask50</span><span class="p">]</span>

<span class="n">front50</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">mask50</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


<span class="c1"># 2D plot for the 50 experiment set</span>
<span class="n">ref</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># adjust if your outcomes are not in [0, 1]</span>

<span class="n">F2_50</span> <span class="o">=</span> <span class="n">front50</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="n">hv_50</span> <span class="o">=</span> <span class="n">hypervolume_2d</span><span class="p">(</span><span class="n">F2_50</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y50</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Y50</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>  <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;all 50&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">front50</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">front50</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pareto 50&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>

<span class="n">xs50</span><span class="p">,</span> <span class="n">ys50</span> <span class="o">=</span> <span class="n">staircase_polygon_2d</span><span class="p">(</span><span class="n">F2_50</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">xs50</span><span class="p">,</span> <span class="n">ys50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;HV 50 = </span><span class="si">{</span><span class="n">hv_50</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;reference&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;yield&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;purity&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Yield vs Purity for 50 experiments&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 3D plot for the 50 experiment set</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.mplot3d</span><span class="w"> </span><span class="kn">import</span> <span class="n">Axes3D</span>  <span class="c1"># noqa: F401</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y50</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Y50</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">Y50</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;all 50&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">front50</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">front50</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">front50</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pareto 50&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;yield&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;purity&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;reproducibility&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;3D Pareto view for 50 experiments&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/578c059c5f3c2888dc0209694ef08b7e875e2b55b1e3ef41c4973b46a315c64d.png" src="_images/578c059c5f3c2888dc0209694ef08b7e875e2b55b1e3ef41c4973b46a315c64d.png" />
<img alt="_images/19ad0b6ce633461cd20e954f47aeefea56b7c1dfc71c29a8d69b110acf52555c.png" src="_images/19ad0b6ce633461cd20e954f47aeefea56b7c1dfc71c29a8d69b110acf52555c.png" />
</div>
</div>
<p>Let’s assume we run 3 additional experiments and we are so lucky that they achieve strong outcomes around high yield and purity (<code class="docutils literal notranslate"><span class="pre">[0.90,</span> <span class="pre">0.80,</span> <span class="pre">0.70]</span></code>, <code class="docutils literal notranslate"><span class="pre">[0.92,</span> <span class="pre">0.78,</span> <span class="pre">0.75]</span></code>, and <code class="docutils literal notranslate"> <span class="pre">[0.88,</span> <span class="pre">0.82,</span> <span class="pre">0.65]</span></code>).</p>
<p>We can take a look at the change to the hypervolume:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1) Simulate three new high-performing experiments and append to the 50-set</span>
<span class="c1">#    We keep reproducibility reasonable; adjust as needed based on your context.</span>
<span class="n">new_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mf">0.90</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.92</span><span class="p">,</span> <span class="mf">0.78</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.88</span><span class="p">,</span> <span class="mf">0.82</span><span class="p">,</span> <span class="mf">0.65</span><span class="p">],</span>
<span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="n">Y50_updated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">Y50</span><span class="p">,</span> <span class="n">new_points</span><span class="p">])</span>

<span class="c1"># Recompute Pareto front for the updated 50+3 set</span>
<span class="n">mask50_new</span> <span class="o">=</span> <span class="n">nondominated_mask</span><span class="p">(</span><span class="n">Y50_updated</span><span class="p">)</span>
<span class="n">front50_new</span> <span class="o">=</span> <span class="n">Y50_updated</span><span class="p">[</span><span class="n">mask50_new</span><span class="p">]</span>

<span class="n">front50</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">front50_new</span><span class="o">.</span><span class="n">shape</span>
<span class="c1"># 2) Hypervolume before vs after on yield-purity (2D)</span>
<span class="n">ref</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># same reference as before</span>

<span class="n">F2_old</span> <span class="o">=</span> <span class="n">front50</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="n">F2_new</span> <span class="o">=</span> <span class="n">front50_new</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>

<span class="n">hv_old</span> <span class="o">=</span> <span class="n">hypervolume_2d</span><span class="p">(</span><span class="n">F2_old</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>
<span class="n">hv_new</span> <span class="o">=</span> <span class="n">hypervolume_2d</span><span class="p">(</span><span class="n">F2_new</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>
<span class="n">delta_hv</span> <span class="o">=</span> <span class="n">hv_new</span> <span class="o">-</span> <span class="n">hv_old</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HV (old 50) = </span><span class="si">{</span><span class="n">hv_old</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> | HV (updated 53) = </span><span class="si">{</span><span class="n">hv_new</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> | ΔHV = </span><span class="si">{</span><span class="n">delta_hv</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># 3) 2D visualization: overlay old HV region, new HV region, and highlight new points</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y50</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Y50</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;all 50&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">front50</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">front50</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;old Pareto 50&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>

<span class="c1"># Updated points and front</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y50_updated</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Y50_updated</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;all 53&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">front50_new</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">front50_new</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;new Pareto 53&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>

<span class="c1"># Highlight just the three new experiments</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">new_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">new_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;new experiments&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>

<span class="c1"># Fill old HV region</span>
<span class="n">xs_old</span><span class="p">,</span> <span class="n">ys_old</span> <span class="o">=</span> <span class="n">staircase_polygon_2d</span><span class="p">(</span><span class="n">F2_old</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">xs_old</span><span class="p">,</span> <span class="n">ys_old</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;HV old = </span><span class="si">{</span><span class="n">hv_old</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Fill new HV region</span>
<span class="n">xs_new</span><span class="p">,</span> <span class="n">ys_new</span> <span class="o">=</span> <span class="n">staircase_polygon_2d</span><span class="p">(</span><span class="n">F2_new</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">xs_new</span><span class="p">,</span> <span class="n">ys_new</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;HV new = </span><span class="si">{</span><span class="n">hv_new</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;reference&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;yield&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;purity&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Yield vs Purity: HV increase Δ = </span><span class="si">{</span><span class="n">delta_hv</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HV (old 50) = 0.704700 | HV (updated 53) = 0.793700 | ΔHV = 0.089000
</pre></div>
</div>
<img alt="_images/d754324665f53d02d2d5a91c2146b5a453736a03f3337fef908ebb654700073e.png" src="_images/d754324665f53d02d2d5a91c2146b5a453736a03f3337fef908ebb654700073e.png" />
</div>
</div>
<p>From above plot, we see that the <strong>hypervolume increase</strong> equals the additional “good” region covered by the improved front. Using the same reference point keeps comparisons fair. In synthesis terms, this reflects the <em>net expansion of acceptable performance space when higher yield and purity conditions are discovered</em>.</p>
<p>We can compare with the full dataset, and this give you an idea of the maxiumn hypervolume you can achieve. But, again, keep in mind that the entire space / synthesis-yield relationship is usually a blackbox function and you won’t know the max hypervolume.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Full set Pareto front and 2D plot</span>
<span class="n">mask_full</span> <span class="o">=</span> <span class="n">nondominated_mask</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
<span class="n">front_full</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">mask_full</span><span class="p">]</span>

<span class="n">F2_full</span> <span class="o">=</span> <span class="n">front_full</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="n">hv_full</span> <span class="o">=</span> <span class="n">hypervolume_2d</span><span class="p">(</span><span class="n">F2_full</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Y</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;all 20k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">front_full</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">front_full</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pareto full&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>

<span class="n">xs_full</span><span class="p">,</span> <span class="n">ys_full</span> <span class="o">=</span> <span class="n">staircase_polygon_2d</span><span class="p">(</span><span class="n">F2_full</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">xs_full</span><span class="p">,</span> <span class="n">ys_full</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;HV full = </span><span class="si">{</span><span class="n">hv_full</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;reference&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;yield&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;purity&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Yield vs Purity for full 20k experiments&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>



<span class="c1"># 3D plot for the full set</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Y</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">Y</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;all 20k&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">front_full</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">front_full</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">front_full</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pareto full&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;yield&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;purity&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;reproducibility&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;3D Pareto view for full 20k experiments&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hypervolume wrt ref </span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2">: 50 = </span><span class="si">{</span><span class="n">hv_50</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">  |  full = </span><span class="si">{</span><span class="n">hv_full</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/fae949979d834f3e52db434b1d0b32db6086fdf60b0c5a0c6ebd67f5fdaa5eb0.png" src="_images/fae949979d834f3e52db434b1d0b32db6086fdf60b0c5a0c6ebd67f5fdaa5eb0.png" />
<img alt="_images/832d261b368646fa4fc8ad61c49d8060cc8d5e4034b6a8cf9dabc860491b517e.png" src="_images/832d261b368646fa4fc8ad61c49d8060cc8d5e4034b6a8cf9dabc860491b517e.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Hypervolume wrt ref (0.0, 0.0): 50 = 0.704700  |  full = 0.927000
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="scalarization-and-surrogate-models-for-each-objective">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">5. Scalarization and surrogate models for each objective</a><a class="headerlink" href="#scalarization-and-surrogate-models-for-each-objective" title="Permalink to this heading">#</a></h2>
<p>A common way to turn multiple objectives into one is <strong>weighted sum</strong>:
$<span class="math notranslate nohighlight">\(
s_w(x) = \sum_{j=1}^m w_j \,\tilde f_j(x)
\)</span><span class="math notranslate nohighlight">\(
with \)</span>w_j \ge 0<span class="math notranslate nohighlight">\( and \)</span>\sum_j w_j = 1<span class="math notranslate nohighlight">\(, where \)</span>\tilde f_j$ are normalized objectives. This is fast and easy to implement.</p>
<blockquote>
<div><p>Caution: linear scalarization can miss non-convex parts of the Pareto front. Still, it is a practical baseline and pairs well with BO.</p>
</div></blockquote>
<p>We now assume we only have a 50 point subset in hand. All modeling, selection, and validation in this section uses only <code class="docutils literal notranslate"><span class="pre">X50</span></code> and <code class="docutils literal notranslate"><span class="pre">Y50</span></code>. The idea is simple: fit one surrogate per objective on the training split of these 50 points, evaluate on the held out split, and then use a scalarized acquisition to propose new experiments from the same 50 point design space.</p>
<section id="train-test-split-and-scaling">
<h3>5.1 Train test split and scaling<a class="headerlink" href="#train-test-split-and-scaling" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Y50</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">idx_50</span><span class="p">]</span>
<span class="n">X50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="n">idx_50</span><span class="p">]</span>  
<span class="c1"># Train test split within the 50 points</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X50</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Y50</span><span class="p">),</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>

<span class="c1"># Standardize features using only training data</span>
<span class="n">scaler_X</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">Xtr</span> <span class="o">=</span> <span class="n">scaler_X</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">Xte</span> <span class="o">=</span> <span class="n">scaler_X</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">Ytr</span> <span class="o">=</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">Yte</span> <span class="o">=</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">Xtr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">Ytr</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((40, 14), (40, 3))
</pre></div>
</div>
</div>
</div>
</section>
<section id="three-gps-with-matern-on-the-50-point-split">
<h3>5.2 Three GPs with Matern on the 50 point split<a class="headerlink" href="#three-gps-with-matern-on-the-50-point-split" title="Permalink to this heading">#</a></h3>
<p>Here we fit one GP per objective on <code class="docutils literal notranslate"><span class="pre">Xtr,</span> <span class="pre">Ytr</span></code>. We use a Matern kernel with a small white noise term for numerical stability. Scores are printed on <code class="docutils literal notranslate"><span class="pre">Xte,</span> <span class="pre">Yte</span></code>. GPs are flexible and give calibrated uncertainties for acquisition functions. On larger feature sets they can be slow, which is why we also show Random Forests.</p>
<div class="admonition-note admonition">
<p class="admonition-title">Note</p>
<p>Recall, the kernel is a function that defines the covariance or similarity between data points, determining how the Gaussian Process generalizes from the training data.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.gaussian_process</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.gaussian_process.kernels</span><span class="w"> </span><span class="kn">import</span> <span class="n">Matern</span><span class="p">,</span> <span class="n">ConstantKernel</span> <span class="k">as</span> <span class="n">C</span><span class="p">,</span> <span class="n">WhiteKernel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">r2_score</span><span class="p">,</span> <span class="n">mean_absolute_error</span>

<span class="n">kernel</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">Matern</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span> <span class="o">+</span> <span class="n">WhiteKernel</span><span class="p">(</span><span class="n">noise_level</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>

<span class="n">gps</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ytr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">gpr</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">normalize_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_restarts_optimizer</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
    <span class="n">gpr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xtr</span><span class="p">,</span> <span class="n">Ytr</span><span class="p">[:,</span> <span class="n">m</span><span class="p">])</span>
    <span class="n">gps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gpr</span><span class="p">)</span>

<span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;yield&quot;</span><span class="p">,</span> <span class="s2">&quot;purity&quot;</span><span class="p">,</span> <span class="s2">&quot;reproducibility&quot;</span><span class="p">]):</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">gps</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xte</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;R2:&quot;</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Yte</span><span class="p">[:,</span> <span class="n">m</span><span class="p">],</span> <span class="n">pred</span><span class="p">),</span> <span class="s2">&quot;MAE:&quot;</span><span class="p">,</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">Yte</span><span class="p">[:,</span> <span class="n">m</span><span class="p">],</span> <span class="n">pred</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>yield R2: -0.8404770597465008 MAE: 0.18228080760227366
purity R2: 0.32667925593801894 MAE: 0.08269840210875393
reproducibility R2: 0.02093233007473716 MAE: 0.13847277467947322
</pre></div>
</div>
</div>
</div>
</section>
<section id="rf-trio-trained-only-on-the-50-point-split">
<h3>5.3 RF trio trained only on the 50 point split<a class="headerlink" href="#rf-trio-trained-only-on-the-50-point-split" title="Permalink to this heading">#</a></h3>
<p>Here we train three RF models on <code class="docutils literal notranslate"><span class="pre">Xtr,</span> <span class="pre">Ytr</span></code> and score on <code class="docutils literal notranslate"><span class="pre">Xte,</span> <span class="pre">Yte</span></code>. RFs scale well and give a simple uncertainty proxy from the spread across trees, which we will use for acquisition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">r2_score</span><span class="p">,</span> <span class="n">mean_absolute_error</span>

<span class="n">rfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ytr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span>
        <span class="n">n_estimators</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
        <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xtr</span><span class="p">,</span> <span class="n">Ytr</span><span class="p">[:,</span> <span class="n">m</span><span class="p">])</span>
    <span class="n">rfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span>

<span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;yield&quot;</span><span class="p">,</span> <span class="s2">&quot;purity&quot;</span><span class="p">,</span> <span class="s2">&quot;reproducibility&quot;</span><span class="p">]):</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">rfs</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xte</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;R2:&quot;</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Yte</span><span class="p">[:,</span> <span class="n">m</span><span class="p">],</span> <span class="n">pred</span><span class="p">),</span> <span class="s2">&quot;MAE:&quot;</span><span class="p">,</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">Yte</span><span class="p">[:,</span> <span class="n">m</span><span class="p">],</span> <span class="n">pred</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>yield R2: -0.2274340192709181 MAE: 0.18593635837502023
purity R2: 0.43811753253133345 MAE: 0.07596276151139307
reproducibility R2: -0.10448172092762853 MAE: 0.13657568665961645
</pre></div>
</div>
</div>
</div>
<p>We see that due to limited data size, both GP and RF surrogate models have a poor R2 value.</p>
<div class="admonition-note admonition">
<p class="admonition-title">Note</p>
<p>Use RF surrogates when the dataset is larger or when GP training is slow. RF also gives a simple uncertainty proxy from the spread across trees, which we will use later for bandit style decisions.</p>
</div>
</section>
</section>
<hr class="docutils" />
<section id="acquisition-for-multiobjective-bo">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">6. Acquisition for multiobjective BO</a><a class="headerlink" href="#acquisition-for-multiobjective-bo" title="Permalink to this heading">#</a></h2>
<p>We now simulate planning within the 50 point space. Think of each of the 50 rows as a candidate experiment. At each iteration we will:</p>
<ol class="arabic simple">
<li><p>fit the three RF surrogates on the experiments already “run” (a small seed set from the 50),</p></li>
<li><p>evaluate a scalarized acquisition on a candidate cloud sampled from <code class="docutils literal notranslate"><span class="pre">Xtr</span></code>,</p></li>
<li><p>propose the single best next point, and</p></li>
<li><p>emulate an outcome by nearest neighbor lookup inside the same 50 point training pool.</p></li>
</ol>
<p>This is a pool based simulation that stays within the 50 points you actually have. We also track an approximate 3D hypervolume of the observed set, using a crude Monte Carlo estimate in the unit cube for quick feedback.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Utilities for candidate cloud and scalarized EI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>

<span class="k">def</span><span class="w"> </span><span class="nf">candidate_cloud</span><span class="p">(</span><span class="n">Xbase</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">Xbase</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Xbase</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Xbase</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rf_mu_sigma</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">RandomForestRegressor</span><span class="p">,</span> <span class="n">Xc</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xc</span><span class="p">)</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">estimators_</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">preds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">preds</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ei_from_mu_sigma</span><span class="p">(</span><span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sd</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">best</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">xi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">best</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">/</span> <span class="n">sd</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">best</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">sd</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">sample_simplex</span><span class="p">(</span><span class="n">M</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">dirichlet</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">M</span><span class="p">))</span>
    
<span class="k">def</span><span class="w"> </span><span class="nf">hv_approx_3d</span><span class="p">(</span><span class="n">Ym</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n_ref</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="c1"># crude Monte Carlo hypervolume estimate over [ref, 1]^3 for maximization</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_ref</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_ref</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">Ym</span><span class="p">[</span><span class="n">nondominated_mask</span><span class="p">(</span><span class="n">Ym</span><span class="p">)]:</span>
        <span class="n">mask</span> <span class="o">|=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">U</span> <span class="o">&lt;=</span> <span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mask</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ref</span><span class="p">)</span>

<span class="c1"># Run a few scalarized BO steps on the 50 point pool</span>

<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>

<span class="c1"># Candidate cloud drawn from the 50 point training pool</span>
<span class="n">Xc</span> <span class="o">=</span> <span class="n">candidate_cloud</span><span class="p">(</span><span class="n">Xtr</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Start with 8 random seed experiments from the 50 training rows</span>
<span class="n">seed_idx</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">Xtr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">D_X</span> <span class="o">=</span> <span class="n">Xtr</span><span class="p">[</span><span class="n">seed_idx</span><span class="p">]</span>
<span class="n">D_Y</span> <span class="o">=</span> <span class="n">Ytr</span><span class="p">[</span><span class="n">seed_idx</span><span class="p">]</span>

<span class="n">history_hv</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ref_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>

<span class="c1"># Track initial HV</span>
<span class="n">history_hv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hv_approx_3d</span><span class="p">(</span><span class="n">D_Y</span><span class="p">,</span> <span class="n">ref_point</span><span class="p">,</span> <span class="n">n_ref</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="n">n_rounds</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># you can change it to 15, for html purpose we use 3</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_rounds</span><span class="p">):</span>
    <span class="c1"># Refit RF surrogates on the current observed subset</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">rfs</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">D_X</span><span class="p">,</span> <span class="n">D_Y</span><span class="p">[:,</span> <span class="n">m</span><span class="p">])</span>

    <span class="c1"># Predict mean and uncertainty on the candidate cloud</span>
    <span class="n">mu_list</span><span class="p">,</span> <span class="n">sd_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">mu_m</span><span class="p">,</span> <span class="n">sd_m</span> <span class="o">=</span> <span class="n">rf_mu_sigma</span><span class="p">(</span><span class="n">rfs</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">Xc</span><span class="p">)</span>
        <span class="n">mu_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mu_m</span><span class="p">);</span> <span class="n">sd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sd_m</span><span class="p">)</span>
    <span class="n">MU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">mu_list</span><span class="p">)</span>
    <span class="n">SD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">sd_list</span><span class="p">)</span>

    <span class="c1"># Random scalarization weights on the simplex</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">sample_simplex</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Scalarized mean and scalarized EI baseline</span>
    <span class="n">g_mu</span> <span class="o">=</span> <span class="n">MU</span> <span class="o">@</span> <span class="n">w</span>
    <span class="n">mu_D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">rfs</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">D_X</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">best_g</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">mu_D</span> <span class="o">@</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="c1"># Scalarized uncertainty under independence approximation</span>
    <span class="n">g_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">SD</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>

    <span class="c1"># EI on scalarized surrogate</span>
    <span class="n">acq</span> <span class="o">=</span> <span class="n">ei_from_mu_sigma</span><span class="p">(</span><span class="n">g_mu</span><span class="p">,</span> <span class="n">g_sd</span><span class="p">,</span> <span class="n">best</span><span class="o">=</span><span class="n">best_g</span><span class="p">,</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="c1"># Pick next candidate</span>
    <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">acq</span><span class="p">))</span>
    <span class="n">x_next</span> <span class="o">=</span> <span class="n">Xc</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Emulate measurement by nearest neighbor in the 50 training pool</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Xtr</span> <span class="o">-</span> <span class="n">x_next</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">y_next</span> <span class="o">=</span> <span class="n">Ytr</span><span class="p">[</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Update observed set</span>
    <span class="n">D_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">D_X</span><span class="p">,</span> <span class="n">x_next</span><span class="p">])</span>
    <span class="n">D_Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">D_Y</span><span class="p">,</span> <span class="n">y_next</span><span class="p">])</span>

    <span class="c1"># Track 3D HV</span>
    <span class="n">hv_now</span> <span class="o">=</span> <span class="n">hv_approx_3d</span><span class="p">(</span><span class="n">D_Y</span><span class="p">,</span> <span class="n">ref_point</span><span class="p">,</span> <span class="n">n_ref</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">100</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span>
    <span class="n">history_hv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hv_now</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Observed points:&quot;</span><span class="p">,</span> <span class="n">D_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Final approx HV:&quot;</span><span class="p">,</span> <span class="n">history_hv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Observed points: 11 Final approx HV: 0.31266666666666665
</pre></div>
</div>
</div>
</div>
<p>We seed with a handful of points from <code class="docutils literal notranslate"><span class="pre">Xtr,</span> <span class="pre">Ytr</span></code>. Each round we refit the RF trio on the current observed set, score a candidate cloud from <code class="docutils literal notranslate"><span class="pre">Xtr</span></code> using random scalarization with EI, pick the best candidate, and emulate the measurement by nearest neighbor lookup inside <code class="docutils literal notranslate"><span class="pre">Xtr</span></code> to fetch its <code class="docutils literal notranslate"><span class="pre">Ytr</span></code>. Hypervolume in 3D is tracked after each addition.</p>
<p>The curve below shows how the approximate 3D hypervolume grows as the loop adds points selected by random scalarization with EI. This is a quick way to judge whether the front is expanding within the 50 point design space.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_hv</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;iteration&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;approx hypervolume (3D)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Scalarization based BO progress on the 50 point pool&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/fb846b8a527f769b4ac654e6bc8361253531a4500dde99a3c08d40eafc48e6b6.png" src="_images/fb846b8a527f769b4ac654e6bc8361253531a4500dde99a3c08d40eafc48e6b6.png" />
</div>
</div>
<hr class="docutils" />
</section>
<hr class="docutils" />
<section id="end-to-end-mobo-loop-on-the-mof-dataset">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">7. End to end MOBO loop on the MOF dataset</a><a class="headerlink" href="#end-to-end-mobo-loop-on-the-mof-dataset" title="Permalink to this heading">#</a></h2>
<p>We now put everything together as a small, complete multiobjective active learning loop that starts from 50 points and grows by proposing 10 new points per round for 15 rounds. The goal is to expand the Pareto set over yield, purity, and reproducibility while tracking a clear 2D hypervolume on yield and purity.</p>
<p>Choices in this section:</p>
<ul class="simple">
<li><p>Surrogate: one Gaussian Process per objective</p></li>
<li><p>Acquisition: random candidate cloud, scalarization with fixed equal weights, and Expected Improvement on the scalarized objective</p></li>
<li><p>Weights: fixed at <code class="docutils literal notranslate"><span class="pre">[0.33,</span> <span class="pre">0.33,</span> <span class="pre">0.33]</span></code> for the entire run to keep behavior easy to interpret</p></li>
<li><p>Evaluation: adding the selected pool rows directly, which emulates running the real experiments</p></li>
</ul>
<p>We will show the following results:</p>
<ul class="simple">
<li><p>Iteration prints with the scalarized EI top scores</p></li>
<li><p>The three best proposed conditions per round</p></li>
<li><p>A four panel figure with hypervolume trace and per objective best so far curves</p></li>
<li><p>A separate plot comparing the yield vs purity Pareto front at the start and at the end</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># === 7. End to end MOBO with a strict oracle and discrete search space ===</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.gaussian_process</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.gaussian_process.kernels</span><span class="w"> </span><span class="kn">import</span> <span class="n">Matern</span><span class="p">,</span> <span class="n">ConstantKernel</span> <span class="k">as</span> <span class="n">C</span><span class="p">,</span> <span class="n">WhiteKernel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># 0) Define the discrete reaction space and ligand catalog</span>
<span class="c1"># ---------------------------</span>

<span class="c1"># Knob grids (exact discrete levels)</span>
<span class="n">TEMP_GRID</span> <span class="o">=</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="mi">160</span><span class="p">]</span>                    <span class="c1"># 10 levels</span>
<span class="n">TIME_GRID</span> <span class="o">=</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">120</span><span class="p">]</span>                        <span class="c1"># 10 levels</span>
<span class="n">CONC_GRID</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">]</span>      <span class="c1"># 10 levels</span>
<span class="n">DMF_GRID</span>  <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>                                                             <span class="c1"># H2O or DMF</span>

<span class="c1"># Ligand catalog: (name, smiles, MW, logP, TPSA, n_rings, family)</span>
<span class="n">LIGANDS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;H2BDC&quot;</span><span class="p">,</span> <span class="s2">&quot;O=C(O)c1ccc(cc1)C(=O)O&quot;</span><span class="p">,</span> <span class="mf">166.13</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">75.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;BDC&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Fumaric acid&quot;</span><span class="p">,</span> <span class="s2">&quot;O=C(O)/C=C/C(=O)O&quot;</span><span class="p">,</span> <span class="mf">116.07</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">75.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Aliphatic diacid&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;2-methylimidazole&quot;</span><span class="p">,</span> <span class="s2">&quot;Cc1ncc[nH]1&quot;</span><span class="p">,</span> <span class="mf">82.10</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">29.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Azole&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Trimesic acid&quot;</span><span class="p">,</span> <span class="s2">&quot;O=C(O)c1cc(C(=O)O)cc(C(=O)O)c1&quot;</span><span class="p">,</span> <span class="mf">210.14</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mf">112.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Triacid&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;H2BDC-NH2&quot;</span><span class="p">,</span> <span class="s2">&quot;Nc1cc(C(=O)O)ccc1C(=O)O&quot;</span><span class="p">,</span> <span class="mf">181.15</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">101.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;BDC&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;H2BDC-F&quot;</span><span class="p">,</span> <span class="s2">&quot;O=C(O)c1cc(F)ccc1C(=O)O&quot;</span><span class="p">,</span> <span class="mf">184.13</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mf">75.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;BDC&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;1,4-NDC&quot;</span><span class="p">,</span> <span class="s2">&quot;O=C(O)c1ccc2cccc(C(=O)O)c2c1&quot;</span><span class="p">,</span> <span class="mf">216.19</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">75.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Naphthalene diacid&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;2,6-NDC&quot;</span><span class="p">,</span> <span class="s2">&quot;O=C(O)c1cccc2c1ccc(C(=O)O)c2&quot;</span><span class="p">,</span> <span class="mf">216.19</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">75.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Naphthalene diacid&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;4,4&#39;-BPDC&quot;</span><span class="p">,</span> <span class="s2">&quot;O=C(O)c1ccc(cc1)-c2ccc(cc2)C(=O)O&quot;</span><span class="p">,</span> <span class="mf">242.23</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">75.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Biphenyl diacid&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Benzimidazole&quot;</span><span class="p">,</span> <span class="s2">&quot;c1ccc2[nH]cnc2c1&quot;</span><span class="p">,</span> <span class="mf">118.14</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Azole&quot;</span><span class="p">),</span>
<span class="p">]</span>
<span class="n">SMILES_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">_rest</span><span class="p">)</span> <span class="ow">in</span> <span class="n">LIGANDS</span><span class="p">]</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># 1) Validate df matches the discrete space exactly (assertions)</span>
<span class="c1"># ---------------------------</span>

<span class="c1"># Ensure df has required columns</span>
<span class="n">req_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span><span class="s2">&quot;time_h&quot;</span><span class="p">,</span><span class="s2">&quot;concentration_M&quot;</span><span class="p">,</span><span class="s2">&quot;solvent_DMF&quot;</span><span class="p">,</span><span class="s2">&quot;smiles&quot;</span><span class="p">,</span><span class="s2">&quot;yield&quot;</span><span class="p">,</span><span class="s2">&quot;purity&quot;</span><span class="p">,</span><span class="s2">&quot;reproducibility&quot;</span><span class="p">]</span>
<span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">req_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df missing columns: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Assert discrete levels match</span>
<span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>      <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">TEMP_GRID</span><span class="p">),</span> <span class="s2">&quot;df temperature outside allowed grid&quot;</span>
<span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;time_h&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>           <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">TIME_GRID</span><span class="p">),</span> <span class="s2">&quot;df time_h outside allowed grid&quot;</span>
<span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;concentration_M&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>  <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">CONC_GRID</span><span class="p">),</span> <span class="s2">&quot;df concentration_M outside allowed grid&quot;</span>
<span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;solvent_DMF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>      <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">DMF_GRID</span><span class="p">),</span>  <span class="s2">&quot;df solvent_DMF outside allowed grid&quot;</span>
<span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;smiles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>           <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">SMILES_LIST</span><span class="p">),</span> <span class="s2">&quot;df smiles not in ligand list&quot;</span>

<span class="c1"># check full cross count</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">20000</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># 2) Build search_space and the oracle from df</span>
<span class="c1">#    search_space: list of valid tuples (T, time, conc, dmf, smiles)</span>
<span class="c1">#    run_experiment(choice): returns (yield, purity, reproducibility)</span>
<span class="c1"># ---------------------------</span>

<span class="c1"># Build mapping from key -&gt; outcomes using df (ground truth)</span>
<span class="n">key_to_y</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span><span class="s2">&quot;time_h&quot;</span><span class="p">,</span><span class="s2">&quot;concentration_M&quot;</span><span class="p">,</span><span class="s2">&quot;solvent_DMF&quot;</span><span class="p">,</span><span class="s2">&quot;smiles&quot;</span><span class="p">,</span><span class="s2">&quot;yield&quot;</span><span class="p">,</span><span class="s2">&quot;purity&quot;</span><span class="p">,</span><span class="s2">&quot;reproducibility&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">T</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">smi</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y3</span> <span class="o">=</span> <span class="n">r</span>
    <span class="n">key_to_y</span><span class="p">[(</span><span class="n">T</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">smi</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">y1</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y2</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y3</span><span class="p">))</span>

<span class="c1"># Build search_space strictly from the CARTESIAN PRODUCT of allowed levels and ligands</span>
<span class="c1"># and filter to keys that actually exist in df (robust to any missing combos)</span>
<span class="n">search_space</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">T</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">TEMP_GRID</span><span class="p">,</span> <span class="n">TIME_GRID</span><span class="p">,</span> <span class="n">CONC_GRID</span><span class="p">,</span> <span class="n">DMF_GRID</span><span class="p">,</span> <span class="n">SMILES_LIST</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">smi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_to_y</span><span class="p">:</span>
        <span class="n">search_space</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="c1"># Oracle the BO will call. No direct df reads elsewhere.</span>
<span class="k">def</span><span class="w"> </span><span class="nf">run_experiment</span><span class="p">(</span><span class="n">choice</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Accepts only a 5-tuple:</span>
<span class="sd">      (temperature, time_h, concentration_M, solvent_DMF, smiles)</span>
<span class="sd">    Returns the true outcomes (yield, purity, reproducibility).</span>
<span class="sd">    Raises KeyError if choice is not in the dataset-backed search space.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">key_to_y</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span>

<span class="c1"># Build a map from choice -&gt; position in search_space (for indexing)</span>
<span class="n">key_to_pos</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">search_space</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Map your df row indices in idx_50 to positions in search_space</span>
<span class="n">initial_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="n">key_to_pos</span><span class="p">[</span>
        <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;temperature&quot;</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;time_h&quot;</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;concentration_M&quot;</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;solvent_DMF&quot;</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;smiles&quot;</span><span class="p">])</span>
    <span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx_50</span>
<span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># 3) Featurization of choices (no class)</span>
<span class="c1"># ---------------------------</span>

<span class="c1"># Fit OneHot on smiles across the whole search_space</span>
<span class="n">smiles_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">search_space</span><span class="p">])</span>  <span class="c1"># shape (N, 1)</span>
<span class="n">ohe</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="n">ohe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">smiles_col</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">choice_to_vector</span><span class="p">(</span><span class="n">choice</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">T</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">smi</span> <span class="o">=</span> <span class="n">choice</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">tt</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">cc</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">smi_vec</span> <span class="o">=</span> <span class="n">ohe</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">smi</span><span class="p">]]))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">num</span><span class="p">,</span> <span class="n">smi_vec</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">choices_to_matrix</span><span class="p">(</span><span class="n">choices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">num_block</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">smi_block</span> <span class="o">=</span> <span class="n">ohe</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">num_block</span><span class="p">,</span> <span class="n">smi_block</span><span class="p">])</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># 4) Pareto + hypervolume helpers on (yield, purity)</span>
<span class="c1"># ---------------------------</span>

<span class="k">def</span><span class="w"> </span><span class="nf">nondominated_mask</span><span class="p">(</span><span class="n">F</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="n">dom</span> <span class="o">=</span> <span class="p">((</span><span class="n">F</span> <span class="o">&gt;=</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">F</span> <span class="o">&gt;</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">dom</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">dom</span><span class="p">):</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">mask</span>

<span class="k">def</span><span class="w"> </span><span class="nf">hypervolume_2d</span><span class="p">(</span><span class="n">front_2d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">front_2d</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">front_2d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])]</span>
    <span class="n">y_env</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">F</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">F</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y_env</span><span class="p">,</span>   <span class="p">[</span><span class="n">y_env</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]])</span>
    <span class="n">widths</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">heights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">ys</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">widths</span> <span class="o">*</span> <span class="n">heights</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">hv_obs_2d</span><span class="p">(</span><span class="n">Y_obs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="n">Y2</span> <span class="o">=</span> <span class="n">Y_obs</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="n">front</span> <span class="o">=</span> <span class="n">Y2</span><span class="p">[</span><span class="n">nondominated_mask</span><span class="p">(</span><span class="n">Y2</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">hypervolume_2d</span><span class="p">(</span><span class="n">front</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># 5) Scalarized EI and candidate sampling</span>
<span class="c1"># ---------------------------</span>

<span class="k">def</span><span class="w"> </span><span class="nf">scalarized_ei</span><span class="p">(</span><span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sd</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_best</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">xi</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">mu_g</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span> <span class="o">*</span> <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">var_g</span> <span class="o">=</span> <span class="p">((</span><span class="n">sd</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sd_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">var_g</span><span class="p">))</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu_g</span> <span class="o">-</span> <span class="n">y_best</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">/</span> <span class="n">sd_g</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">mu_g</span> <span class="o">-</span> <span class="n">y_best</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">sd_g</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">sample_cloud</span><span class="p">(</span><span class="n">pool_idx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">rng</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">pool_idx</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pool_idx</span>
    <span class="n">rel</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">pool_idx</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pool_idx</span><span class="p">[</span><span class="n">rel</span><span class="p">]</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># 6) MOBO runner using only run_experiment(choice)</span>
<span class="c1"># ---------------------------</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_mobo_with_oracle</span><span class="p">(</span>
    <span class="n">search_space</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">]],</span>
    <span class="n">run_experiment</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">]],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">]],</span>
    <span class="n">initial_idx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.33</span><span class="p">,</span><span class="mf">0.33</span><span class="p">,</span><span class="mf">0.33</span><span class="p">]),</span>
    <span class="n">rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
    <span class="n">batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">cloud</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6000</span><span class="p">,</span>
    <span class="n">ref_2d</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="n">rng_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">rng_seed</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Observed and pool tracked as positions in search_space</span>
    <span class="n">obs_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">initial_idx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">pool_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">search_space</span><span class="p">)),</span> <span class="n">obs_idx</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Evaluate oracle for initial 50</span>
    <span class="n">X_obs</span> <span class="o">=</span> <span class="n">choices_to_matrix</span><span class="p">([</span><span class="n">search_space</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">obs_idx</span><span class="p">])</span>
    <span class="n">Y_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">run_experiment</span><span class="p">(</span><span class="n">search_space</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">obs_idx</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">Y_start</span> <span class="o">=</span> <span class="n">Y_obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">hv_trace</span> <span class="o">=</span> <span class="p">[</span><span class="n">hv_obs_2d</span><span class="p">(</span><span class="n">Y_obs</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref_2d</span><span class="p">)]</span>
    <span class="n">best3_log</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Y_hist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Y_obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">rounds</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Fit GPs on observed</span>
        <span class="n">scX</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_obs</span><span class="p">)</span>
        <span class="n">Xtr</span> <span class="o">=</span> <span class="n">scX</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_obs</span><span class="p">)</span>

        <span class="n">kernel</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">Matern</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span> <span class="o">+</span> <span class="n">WhiteKernel</span><span class="p">(</span><span class="n">noise_level</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
        <span class="n">gps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">gp</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span>
                <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">normalize_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_restarts_optimizer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">100</span> <span class="o">+</span> <span class="n">j</span>
            <span class="p">)</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xtr</span><span class="p">,</span> <span class="n">Y_obs</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span>
            <span class="n">gps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span>

        <span class="c1"># Candidate cloud from pool indices</span>
        <span class="k">if</span> <span class="n">pool_idx</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iter </span><span class="si">{</span><span class="n">t</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2"> | pool empty, stopping.&quot;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="n">cand_abs</span> <span class="o">=</span> <span class="n">sample_cloud</span><span class="p">(</span><span class="n">pool_idx</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">pool_idx</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
        <span class="n">Xc</span> <span class="o">=</span> <span class="n">scX</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">choices_to_matrix</span><span class="p">([</span><span class="n">search_space</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cand_abs</span><span class="p">]))</span>

        <span class="c1"># Predict mean and std for each objective</span>
        <span class="n">MU</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">SD</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">mu_j</span><span class="p">,</span> <span class="n">sd_j</span> <span class="o">=</span> <span class="n">gps</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xc</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">MU</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mu_j</span><span class="p">);</span> <span class="n">SD</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sd_j</span><span class="p">)</span>
        <span class="n">MU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">MU</span><span class="p">)</span>
        <span class="n">SD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">SD</span><span class="p">)</span>

        <span class="c1"># EI baseline from observed</span>
        <span class="n">mu_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">gps</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">scX</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_obs</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
        <span class="n">best_scalar</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">mu_obs</span> <span class="o">@</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="c1"># Scalarized EI with fixed weights</span>
        <span class="n">acq</span> <span class="o">=</span> <span class="n">scalarized_ei</span><span class="p">(</span><span class="n">MU</span><span class="p">,</span> <span class="n">SD</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">y_best</span><span class="o">=</span><span class="n">best_scalar</span><span class="p">,</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

        <span class="c1"># Pick top-k</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">cand_abs</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">pick_rel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">acq</span><span class="p">)[:</span><span class="n">k</span><span class="p">]</span>
        <span class="n">new_abs</span> <span class="o">=</span> <span class="n">cand_abs</span><span class="p">[</span><span class="n">pick_rel</span><span class="p">]</span>

        <span class="c1"># Log top-3 choices and outcomes via oracle</span>
        <span class="n">top3_abs</span> <span class="o">=</span> <span class="n">new_abs</span><span class="p">[:</span> <span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">new_abs</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
        <span class="n">top3_choices</span> <span class="o">=</span> <span class="p">[</span><span class="n">search_space</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">top3_abs</span><span class="p">]</span>
        <span class="n">top3_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">run_experiment</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">top3_choices</span><span class="p">])</span>
        <span class="n">top3_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">top3_choices</span><span class="p">,</span> <span class="n">top3_out</span><span class="p">]),</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span><span class="s2">&quot;time_h&quot;</span><span class="p">,</span><span class="s2">&quot;concentration_M&quot;</span><span class="p">,</span><span class="s2">&quot;solvent_DMF&quot;</span><span class="p">,</span><span class="s2">&quot;smiles&quot;</span><span class="p">,</span><span class="s2">&quot;yield&quot;</span><span class="p">,</span><span class="s2">&quot;purity&quot;</span><span class="p">,</span><span class="s2">&quot;reproducibility&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">best3_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top3_df</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iter </span><span class="si">{</span><span class="n">t</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2"> | HV=</span><span class="si">{</span><span class="n">hv_trace</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | selected </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">top3_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">top3_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">r_i</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  #</span><span class="si">{</span><span class="n">r_i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: temp=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, time_h=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;time_h&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;conc=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;concentration_M&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, DMF=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;solvent_DMF&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;yield=</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;yield&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, purity=</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;purity&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;repro=</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;reproducibility&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Feedback: call oracle for all selected</span>
        <span class="n">X_new</span> <span class="o">=</span> <span class="n">choices_to_matrix</span><span class="p">([</span><span class="n">search_space</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">new_abs</span><span class="p">])</span>
        <span class="n">Y_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">run_experiment</span><span class="p">(</span><span class="n">search_space</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">new_abs</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">X_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X_obs</span><span class="p">,</span> <span class="n">X_new</span><span class="p">])</span>
        <span class="n">Y_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">Y_obs</span><span class="p">,</span> <span class="n">Y_new</span><span class="p">])</span>

        <span class="c1"># Remove selected from pool</span>
        <span class="n">mask_keep</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pool_idx</span><span class="p">,</span> <span class="n">new_abs</span><span class="p">)</span>
        <span class="n">pool_idx</span> <span class="o">=</span> <span class="n">pool_idx</span><span class="p">[</span><span class="n">mask_keep</span><span class="p">]</span>

        <span class="c1"># Track</span>
        <span class="n">hv_trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hv_obs_2d</span><span class="p">(</span><span class="n">Y_obs</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref_2d</span><span class="p">))</span>
        <span class="n">Y_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y_obs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;hv_trace&quot;</span><span class="p">:</span> <span class="n">hv_trace</span><span class="p">,</span>
        <span class="s2">&quot;best3_log&quot;</span><span class="p">:</span> <span class="n">best3_log</span><span class="p">,</span>
        <span class="s2">&quot;Y_obs_start&quot;</span><span class="p">:</span> <span class="n">Y_start</span><span class="p">,</span>
        <span class="s2">&quot;Y_obs_final&quot;</span><span class="p">:</span> <span class="n">Y_obs</span><span class="p">,</span>
        <span class="s2">&quot;Y_hist&quot;</span><span class="p">:</span> <span class="n">Y_hist</span><span class="p">,</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>Above we define the function (click to see more details) and below we run everything togther with fixed weights, 15 rounds, 10 picks/round:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">run_mobo_with_oracle</span><span class="p">(</span>
    <span class="n">search_space</span><span class="o">=</span><span class="n">search_space</span><span class="p">,</span>
    <span class="n">run_experiment</span><span class="o">=</span><span class="n">run_experiment</span><span class="p">,</span>
    <span class="n">initial_idx</span><span class="o">=</span><span class="n">initial_idx</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">]),</span>
    <span class="n">rounds</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">batch</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">cloud</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
    <span class="n">ref_2d</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="n">rng_seed</span><span class="o">=</span><span class="mi">17</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 01 | HV=0.7047 | selected 10
  #1: temp=85, time_h=12, conc=0.05, DMF=1, yield=0.530, purity=0.710, repro=0.500
  #2: temp=70, time_h=12, conc=0.1, DMF=1, yield=0.640, purity=0.740, repro=0.750
  #3: temp=70, time_h=12, conc=0.05, DMF=1, yield=0.570, purity=0.740, repro=0.750
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 02 | HV=0.7047 | selected 10
  #1: temp=100, time_h=36, conc=0.15, DMF=1, yield=0.480, purity=0.640, repro=0.750
  #2: temp=115, time_h=36, conc=0.15, DMF=1, yield=0.420, purity=0.710, repro=1.000
  #3: temp=25, time_h=12, conc=0.15, DMF=1, yield=0.410, purity=0.660, repro=0.250
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 03 | HV=0.7047 | selected 10
  #1: temp=115, time_h=36, conc=0.1, DMF=1, yield=0.410, purity=0.710, repro=0.500
  #2: temp=115, time_h=24, conc=0.1, DMF=1, yield=0.330, purity=0.700, repro=0.500
  #3: temp=40, time_h=24, conc=0.05, DMF=0, yield=0.670, purity=0.740, repro=0.750
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 04 | HV=0.7287 | selected 10
  #1: temp=40, time_h=36, conc=0.1, DMF=0, yield=0.660, purity=0.760, repro=1.000
  #2: temp=25, time_h=36, conc=0.15, DMF=0, yield=0.000, purity=0.720, repro=1.000
  #3: temp=40, time_h=24, conc=0.1, DMF=0, yield=0.710, purity=0.890, repro=1.000
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 05 | HV=0.8190 | selected 10
  #1: temp=55, time_h=36, conc=0.1, DMF=0, yield=0.790, purity=0.460, repro=0.750
  #2: temp=55, time_h=36, conc=0.15, DMF=0, yield=0.730, purity=0.790, repro=0.750
  #3: temp=130, time_h=36, conc=0.15, DMF=1, yield=0.470, purity=0.470, repro=0.750
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 06 | HV=0.8190 | selected 10
  #1: temp=160, time_h=36, conc=0.15, DMF=0, yield=0.370, purity=0.400, repro=0.500
  #2: temp=155, time_h=24, conc=0.15, DMF=0, yield=0.670, purity=0.360, repro=1.000
  #3: temp=25, time_h=36, conc=0.1, DMF=0, yield=0.000, purity=0.630, repro=0.750
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 07 | HV=0.8190 | selected 10
  #1: temp=85, time_h=12, conc=0.1, DMF=0, yield=0.550, purity=0.730, repro=0.500
  #2: temp=40, time_h=48, conc=0.1, DMF=0, yield=0.620, purity=0.750, repro=1.000
  #3: temp=25, time_h=12, conc=0.2, DMF=0, yield=0.000, purity=0.710, repro=0.250
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 08 | HV=0.8654 | selected 10
  #1: temp=55, time_h=24, conc=0.1, DMF=0, yield=0.000, purity=0.630, repro=0.750
  #2: temp=70, time_h=24, conc=0.1, DMF=0, yield=0.970, purity=0.460, repro=1.000
  #3: temp=160, time_h=36, conc=0.35, DMF=0, yield=0.000, purity=0.190, repro=1.000
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 09 | HV=0.8654 | selected 10
  #1: temp=160, time_h=24, conc=0.45, DMF=0, yield=0.340, purity=0.250, repro=1.000
  #2: temp=160, time_h=48, conc=0.5, DMF=0, yield=0.540, purity=0.240, repro=1.000
  #3: temp=155, time_h=12, conc=0.35, DMF=1, yield=0.560, purity=0.470, repro=1.000
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 10 | HV=0.8654 | selected 10
  #1: temp=85, time_h=24, conc=0.1, DMF=1, yield=0.660, purity=0.730, repro=1.000
  #2: temp=70, time_h=36, conc=0.1, DMF=1, yield=0.740, purity=0.540, repro=0.750
  #3: temp=40, time_h=36, conc=0.2, DMF=0, yield=0.700, purity=0.680, repro=0.500
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 11 | HV=0.8654 | selected 10
  #1: temp=155, time_h=108, conc=0.35, DMF=0, yield=0.220, purity=0.240, repro=0.750
  #2: temp=155, time_h=108, conc=0.25, DMF=0, yield=0.370, purity=0.310, repro=1.000
  #3: temp=155, time_h=36, conc=0.3, DMF=1, yield=0.490, purity=0.280, repro=1.000
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 12 | HV=0.8654 | selected 10
  #1: temp=25, time_h=120, conc=0.05, DMF=1, yield=0.310, purity=0.710, repro=0.250
  #2: temp=40, time_h=120, conc=0.05, DMF=1, yield=0.320, purity=0.680, repro=0.250
  #3: temp=25, time_h=84, conc=0.05, DMF=1, yield=0.400, purity=0.710, repro=0.250
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 13 | HV=0.8654 | selected 10
  #1: temp=25, time_h=24, conc=0.05, DMF=1, yield=0.540, purity=0.630, repro=0.750
  #2: temp=25, time_h=12, conc=0.1, DMF=1, yield=0.000, purity=0.610, repro=1.000
  #3: temp=25, time_h=24, conc=0.1, DMF=1, yield=0.470, purity=0.650, repro=1.000
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 14 | HV=0.8654 | selected 10
  #1: temp=25, time_h=12, conc=0.05, DMF=1, yield=0.490, purity=0.630, repro=0.750
  #2: temp=40, time_h=24, conc=0.05, DMF=1, yield=0.000, purity=0.700, repro=0.750
  #3: temp=70, time_h=12, conc=0.05, DMF=1, yield=0.360, purity=0.700, repro=1.000
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 15 | HV=0.8654 | selected 10
  #1: temp=25, time_h=36, conc=0.1, DMF=1, yield=0.540, purity=0.660, repro=1.000
  #2: temp=40, time_h=36, conc=0.15, DMF=1, yield=0.590, purity=0.620, repro=1.000
  #3: temp=25, time_h=36, conc=0.05, DMF=1, yield=0.450, purity=0.620, repro=0.750
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 16 | HV=0.8654 | selected 10
  #1: temp=25, time_h=24, conc=0.15, DMF=1, yield=0.590, purity=0.720, repro=0.750
  #2: temp=40, time_h=12, conc=0.2, DMF=1, yield=0.490, purity=0.610, repro=1.000
  #3: temp=25, time_h=48, conc=0.25, DMF=1, yield=0.670, purity=0.680, repro=1.000
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 17 | HV=0.8654 | selected 10
  #1: temp=25, time_h=36, conc=0.15, DMF=1, yield=0.400, purity=0.710, repro=0.750
  #2: temp=40, time_h=24, conc=0.2, DMF=1, yield=0.550, purity=0.610, repro=1.000
  #3: temp=25, time_h=12, conc=0.35, DMF=1, yield=0.530, purity=0.650, repro=1.000
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 18 | HV=0.8654 | selected 10
  #1: temp=25, time_h=24, conc=0.2, DMF=1, yield=0.560, purity=0.730, repro=1.000
  #2: temp=25, time_h=24, conc=0.35, DMF=1, yield=0.590, purity=0.650, repro=1.000
  #3: temp=25, time_h=36, conc=0.3, DMF=1, yield=0.600, purity=0.660, repro=1.000
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 19 | HV=0.8654 | selected 10
  #1: temp=40, time_h=12, conc=0.3, DMF=1, yield=0.000, purity=0.470, repro=0.750
  #2: temp=40, time_h=36, conc=0.25, DMF=1, yield=0.430, purity=0.600, repro=1.000
  #3: temp=40, time_h=24, conc=0.35, DMF=1, yield=0.490, purity=0.480, repro=1.000
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iter 20 | HV=0.8654 | selected 10
  #1: temp=25, time_h=60, conc=0.25, DMF=1, yield=0.650, purity=0.680, repro=1.000
  #2: temp=25, time_h=12, conc=0.3, DMF=1, yield=0.510, purity=0.650, repro=1.000
  #3: temp=25, time_h=72, conc=0.2, DMF=1, yield=0.530, purity=0.730, repro=1.000
</pre></div>
</div>
</div>
</div>
<p>We can plot the results:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ---------------------------</span>
<span class="c1"># 8) Four-panel progress plot + Pareto before vs after (yield, purity)</span>
<span class="c1"># ---------------------------</span>

<span class="n">hv_trace</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;hv_trace&quot;</span><span class="p">]</span>
<span class="n">Y_hist</span>   <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;Y_hist&quot;</span><span class="p">]</span>
<span class="n">Y_start</span>  <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;Y_obs_start&quot;</span><span class="p">]</span>
<span class="n">Y_final</span>  <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;Y_obs_final&quot;</span><span class="p">]</span>

<span class="n">best_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">Y_hist</span><span class="p">]</span>
<span class="n">best_p</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">Y_hist</span><span class="p">]</span>
<span class="n">best_r</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">Y_hist</span><span class="p">]</span>
<span class="n">iters</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hv_trace</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iters</span><span class="p">,</span> <span class="n">hv_trace</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Hypervolume on yield, purity&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;iteration&quot;</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;hypervolume&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iters</span><span class="p">,</span> <span class="n">best_y</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Best yield observed&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;iteration&quot;</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;yield&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iters</span><span class="p">,</span> <span class="n">best_p</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Best purity observed&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;iteration&quot;</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;purity&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iters</span><span class="p">,</span> <span class="n">best_r</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Best reproducibility observed&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;iteration&quot;</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;reproducibility&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Pareto start vs end on yield–purity</span>
<span class="k">def</span><span class="w"> </span><span class="nf">nondominated_mask_2d</span><span class="p">(</span><span class="n">F2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">F2</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="n">dom</span> <span class="o">=</span> <span class="p">((</span><span class="n">F</span> <span class="o">&gt;=</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">F</span> <span class="o">&gt;</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">dom</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">dom</span><span class="p">):</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">mask</span>

<span class="n">Y2_start</span> <span class="o">=</span> <span class="n">Y_start</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">Y2_final</span> <span class="o">=</span> <span class="n">Y_final</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">front_start</span> <span class="o">=</span> <span class="n">Y2_start</span><span class="p">[</span><span class="n">nondominated_mask_2d</span><span class="p">(</span><span class="n">Y2_start</span><span class="p">)]</span>
<span class="n">front_final</span> <span class="o">=</span> <span class="n">Y2_final</span><span class="p">[</span><span class="n">nondominated_mask_2d</span><span class="p">(</span><span class="n">Y2_final</span><span class="p">)]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y2_start</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Y2_start</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;all start&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y2_final</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Y2_final</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;all final&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">front_start</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">front_start</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;front start&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">front_final</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">front_final</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;front final&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;yield&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;purity&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Pareto front before vs after&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/7924104ed4c5b27327227e39b0c6bef2fa983062f39bd68397257d7d8a1cfdd6.png" src="_images/7924104ed4c5b27327227e39b0c6bef2fa983062f39bd68397257d7d8a1cfdd6.png" />
<img alt="_images/4d5762c5be69fb4d5e4a5939190fd5f499c4c86e012c78a8ebcbb46ac19279c0.png" src="_images/4d5762c5be69fb4d5e4a5939190fd5f499c4c86e012c78a8ebcbb46ac19279c0.png" />
</div>
</div>
<p>Finally, we want to run the same MOBO loop four times per surrogate type (<code class="docutils literal notranslate"><span class="pre">GP</span></code> and <code class="docutils literal notranslate"><span class="pre">RF</span></code>), one for each acquisition: <code class="docutils literal notranslate"><span class="pre">EI</span></code>, <code class="docutils literal notranslate"><span class="pre">UCB</span></code>, <code class="docutils literal notranslate"><span class="pre">PI</span></code>, and <code class="docutils literal notranslate"><span class="pre">greedy</span> <span class="pre">mean</span></code>. The loop proposes only from the discrete <code class="docutils literal notranslate"><span class="pre">search_space</span></code>, gets outcomes only through <code class="docutils literal notranslate"><span class="pre">run_experiment(choice)</span></code>, and never reads targets from the dataframe. We track the <strong>user-defined scalarized value</strong> (fixed weights <code class="docutils literal notranslate"><span class="pre">[0.33,</span> <span class="pre">0.33,</span> <span class="pre">0.33]</span></code>) over iterations.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Callable</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.gaussian_process</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.gaussian_process.kernels</span><span class="w"> </span><span class="kn">import</span> <span class="n">Matern</span><span class="p">,</span> <span class="n">ConstantKernel</span> <span class="k">as</span> <span class="n">C</span><span class="p">,</span> <span class="n">WhiteKernel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>

<span class="c1"># ---------- Featurization (same as before, no dataframe access) ----------</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_smiles_ohe</span><span class="p">(</span><span class="n">search_space</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">OneHotEncoder</span><span class="p">:</span>
    <span class="n">ohe</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
    <span class="n">ohe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">search_space</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">ohe</span>

<span class="k">def</span><span class="w"> </span><span class="nf">choices_to_matrix</span><span class="p">(</span><span class="n">search_space</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">]],</span>
                      <span class="n">idx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                      <span class="n">ohe</span><span class="p">:</span> <span class="n">OneHotEncoder</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="p">[</span><span class="n">search_space</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">smi</span> <span class="o">=</span> <span class="n">ohe</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">num</span><span class="p">,</span> <span class="n">smi</span><span class="p">])</span>

<span class="c1"># ---------- Scalarization helpers ----------</span>

<span class="k">def</span><span class="w"> </span><span class="nf">scalarize</span><span class="p">(</span><span class="n">Y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">Y</span> <span class="o">*</span> <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">best_scalar_so_far</span><span class="p">(</span><span class="n">Y_obs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">scalarize</span><span class="p">(</span><span class="n">Y_obs</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="k">def</span><span class="w"> </span><span class="nf">best_each_so_far</span><span class="p">(</span><span class="n">Y_obs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">Y_obs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="nb">float</span><span class="p">(</span><span class="n">Y_obs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="nb">float</span><span class="p">(</span><span class="n">Y_obs</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="c1"># ---------- Acquisition on scalarized stats ----------</span>

<span class="k">def</span><span class="w"> </span><span class="nf">acq_scores</span><span class="p">(</span><span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sd</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">xi</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">kappa</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y_best</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">mu_g</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span> <span class="o">*</span> <span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">var_g</span> <span class="o">=</span> <span class="p">((</span><span class="n">sd</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sd_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">var_g</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;greedy&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mu_g</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;ucb&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mu_g</span> <span class="o">+</span> <span class="n">kappa</span> <span class="o">*</span> <span class="n">sd_g</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;pi&quot;</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu_g</span> <span class="o">-</span> <span class="n">y_best</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">/</span> <span class="n">sd_g</span>
        <span class="k">return</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;ei&quot;</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu_g</span> <span class="o">-</span> <span class="n">y_best</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">/</span> <span class="n">sd_g</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">mu_g</span> <span class="o">-</span> <span class="n">y_best</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">sd_g</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown acquisition kind&quot;</span><span class="p">)</span>

<span class="c1"># ---------- One run returns all four traces ----------</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_once_full_traces</span><span class="p">(</span><span class="n">search_space</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">]],</span>
                         <span class="n">run_experiment</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">]],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">]],</span>
                         <span class="n">initial_idx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                         <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                         <span class="n">rounds</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                         <span class="n">batch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                         <span class="n">cloud</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                         <span class="n">model_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>      <span class="c1"># &#39;gp&#39; or &#39;rf&#39;</span>
                         <span class="n">acq_kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>        <span class="c1"># &#39;ei&#39; | &#39;ucb&#39; | &#39;pi&#39; | &#39;greedy&#39;</span>
                         <span class="n">rng_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="n">kappa</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                         <span class="n">xi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">rng_seed</span><span class="p">)</span>
    <span class="n">ohe</span> <span class="o">=</span> <span class="n">build_smiles_ohe</span><span class="p">(</span><span class="n">search_space</span><span class="p">)</span>

    <span class="n">obs_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">initial_idx</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">pool_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">search_space</span><span class="p">)),</span> <span class="n">obs_idx</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Initial oracle eval</span>
    <span class="n">X_obs</span> <span class="o">=</span> <span class="n">choices_to_matrix</span><span class="p">(</span><span class="n">search_space</span><span class="p">,</span> <span class="n">obs_idx</span><span class="p">,</span> <span class="n">ohe</span><span class="p">)</span>
    <span class="n">Y_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">run_experiment</span><span class="p">(</span><span class="n">search_space</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">obs_idx</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Traces</span>
    <span class="n">best_scalar</span> <span class="o">=</span> <span class="p">[</span><span class="n">best_scalar_so_far</span><span class="p">(</span><span class="n">Y_obs</span><span class="p">,</span> <span class="n">w</span><span class="p">)]</span>
    <span class="n">by</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">br</span> <span class="o">=</span> <span class="n">best_each_so_far</span><span class="p">(</span><span class="n">Y_obs</span><span class="p">)</span>
    <span class="n">best_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">by</span><span class="p">];</span> <span class="n">best_p</span> <span class="o">=</span> <span class="p">[</span><span class="n">bp</span><span class="p">];</span> <span class="n">best_r</span> <span class="o">=</span> <span class="p">[</span><span class="n">br</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">rounds</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">scX</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_obs</span><span class="p">)</span>
        <span class="n">Xtr</span> <span class="o">=</span> <span class="n">scX</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_obs</span><span class="p">)</span>

        <span class="c1"># Surrogates</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;gp&quot;</span><span class="p">:</span>
            <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">Matern</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span> <span class="o">+</span> <span class="n">WhiteKernel</span><span class="p">(</span><span class="n">noise_level</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">gp</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">normalize_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_restarts_optimizer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                              <span class="n">random_state</span><span class="o">=</span><span class="mi">100</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">17</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
                <span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xtr</span><span class="p">,</span> <span class="n">Y_obs</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span>
                <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;rf&quot;</span><span class="p">:</span>
            <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_features</span><span class="o">=</span><span class="s2">&quot;sqrt&quot;</span><span class="p">,</span>
                                           <span class="n">random_state</span><span class="o">=</span><span class="mi">200</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">13</span><span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xtr</span><span class="p">,</span> <span class="n">Y_obs</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span>
                <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;model_type must be &#39;gp&#39; or &#39;rf&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pool_idx</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># record and stop</span>
            <span class="n">best_scalar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_scalar_so_far</span><span class="p">(</span><span class="n">Y_obs</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
            <span class="n">by</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">br</span> <span class="o">=</span> <span class="n">best_each_so_far</span><span class="p">(</span><span class="n">Y_obs</span><span class="p">)</span>
            <span class="n">best_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">by</span><span class="p">);</span> <span class="n">best_p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span> <span class="n">best_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">br</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="c1"># Candidate cloud from pool</span>
        <span class="n">cand_abs</span> <span class="o">=</span> <span class="n">pool_idx</span> <span class="k">if</span> <span class="n">pool_idx</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">cloud</span> <span class="k">else</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">pool_idx</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">cloud</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">Xc</span> <span class="o">=</span> <span class="n">scX</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">choices_to_matrix</span><span class="p">(</span><span class="n">search_space</span><span class="p">,</span> <span class="n">cand_abs</span><span class="p">,</span> <span class="n">ohe</span><span class="p">))</span>

        <span class="c1"># Predict</span>
        <span class="n">MU</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">SD</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;gp&quot;</span><span class="p">:</span>
                <span class="n">mu_j</span><span class="p">,</span> <span class="n">sd_j</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xc</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xc</span><span class="p">)</span> <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">estimators_</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">mu_j</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">sd_j</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span>
            <span class="n">MU</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mu_j</span><span class="p">);</span> <span class="n">SD</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sd_j</span><span class="p">)</span>
        <span class="n">MU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">MU</span><span class="p">)</span>
        <span class="n">SD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">SD</span><span class="p">)</span>

        <span class="c1"># Acquisition</span>
        <span class="n">y_best</span> <span class="o">=</span> <span class="n">best_scalar_so_far</span><span class="p">(</span><span class="n">Y_obs</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">acq_scores</span><span class="p">(</span><span class="n">MU</span><span class="p">,</span> <span class="n">SD</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">acq_kind</span><span class="p">,</span> <span class="n">xi</span><span class="o">=</span><span class="n">xi</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="n">kappa</span><span class="p">,</span> <span class="n">y_best</span><span class="o">=</span><span class="n">y_best</span><span class="p">)</span>

        <span class="c1"># Pick and query oracle</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">cand_abs</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">pick_rel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">scores</span><span class="p">)[:</span><span class="n">k</span><span class="p">]</span>
        <span class="n">new_abs</span> <span class="o">=</span> <span class="n">cand_abs</span><span class="p">[</span><span class="n">pick_rel</span><span class="p">]</span>

        <span class="n">X_new</span> <span class="o">=</span> <span class="n">choices_to_matrix</span><span class="p">(</span><span class="n">search_space</span><span class="p">,</span> <span class="n">new_abs</span><span class="p">,</span> <span class="n">ohe</span><span class="p">)</span>
        <span class="n">Y_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">run_experiment</span><span class="p">(</span><span class="n">search_space</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">new_abs</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">X_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X_obs</span><span class="p">,</span> <span class="n">X_new</span><span class="p">])</span>
        <span class="n">Y_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">Y_obs</span><span class="p">,</span> <span class="n">Y_new</span><span class="p">])</span>
        <span class="n">pool_idx</span> <span class="o">=</span> <span class="n">pool_idx</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pool_idx</span><span class="p">,</span> <span class="n">new_abs</span><span class="p">)]</span>

        <span class="c1"># Update traces</span>
        <span class="n">best_scalar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_scalar_so_far</span><span class="p">(</span><span class="n">Y_obs</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
        <span class="n">by</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">br</span> <span class="o">=</span> <span class="n">best_each_so_far</span><span class="p">(</span><span class="n">Y_obs</span><span class="p">)</span>
        <span class="n">best_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">by</span><span class="p">);</span> <span class="n">best_p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span> <span class="n">best_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">br</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;best_scalar&quot;</span><span class="p">:</span> <span class="n">best_scalar</span><span class="p">,</span>
        <span class="s2">&quot;best_yield&quot;</span><span class="p">:</span> <span class="n">best_y</span><span class="p">,</span>
        <span class="s2">&quot;best_purity&quot;</span><span class="p">:</span> <span class="n">best_p</span><span class="p">,</span>
        <span class="s2">&quot;best_repro&quot;</span><span class="p">:</span> <span class="n">best_r</span>
    <span class="p">}</span>

<span class="c1"># ---------- Runner and 8-panel plot ----------</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compare_rf_gp_acq_8panels</span><span class="p">(</span><span class="n">search_space</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">]],</span>
                              <span class="n">run_experiment</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">,</span><span class="n">Any</span><span class="p">]],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">]],</span>
                              <span class="n">initial_idx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                              <span class="n">rounds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
                              <span class="n">batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                              <span class="n">cloud</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6000</span><span class="p">,</span>
                              <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">]),</span>
                              <span class="n">rng_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">123</span><span class="p">,</span>
                              <span class="n">kappa</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                              <span class="n">xi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each surrogate∈{GP, RF} and acquisition∈{EI, UCB, PI, Greedy}, run the loop</span>
<span class="sd">    and plot one panel per combo. Each panel shows 4 lines:</span>
<span class="sd">      - best yield so far</span>
<span class="sd">      - best purity so far</span>
<span class="sd">      - best reproducibility so far</span>
<span class="sd">      - best scalarized value so far</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">);</span> <span class="n">w</span> <span class="o">/=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">acqs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ei&quot;</span><span class="p">,</span> <span class="s2">&quot;ucb&quot;</span><span class="p">,</span> <span class="s2">&quot;pi&quot;</span><span class="p">,</span> <span class="s2">&quot;greedy&quot;</span><span class="p">]</span>
    <span class="n">surgs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gp&quot;</span><span class="p">,</span> <span class="s2">&quot;rf&quot;</span><span class="p">]</span>

    <span class="n">traces</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gp&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;rf&quot;</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="n">acqs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">mt</span> <span class="ow">in</span> <span class="n">surgs</span><span class="p">:</span>
            <span class="n">traces</span><span class="p">[</span><span class="n">mt</span><span class="p">][</span><span class="n">acq</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_once_full_traces</span><span class="p">(</span>
                <span class="n">search_space</span><span class="p">,</span> <span class="n">run_experiment</span><span class="p">,</span> <span class="n">initial_idx</span><span class="p">,</span>
                <span class="n">w</span><span class="p">,</span> <span class="n">rounds</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">cloud</span><span class="p">,</span>
                <span class="n">model_type</span><span class="o">=</span><span class="n">mt</span><span class="p">,</span> <span class="n">acq_kind</span><span class="o">=</span><span class="n">acq</span><span class="p">,</span>
                <span class="n">rng_seed</span><span class="o">=</span><span class="n">rng_seed</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="n">kappa</span><span class="p">,</span> <span class="n">xi</span><span class="o">=</span><span class="n">xi</span>
            <span class="p">)</span>

    <span class="c1"># 8 panels: 2 rows (GP, RF) x 4 cols (EI, UCB, PI, Greedy)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">acq_titles</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ei&quot;</span><span class="p">:</span> <span class="s2">&quot;EI&quot;</span><span class="p">,</span> <span class="s2">&quot;ucb&quot;</span><span class="p">:</span> <span class="s2">&quot;UCB&quot;</span><span class="p">,</span> <span class="s2">&quot;pi&quot;</span><span class="p">:</span> <span class="s2">&quot;PI&quot;</span><span class="p">,</span> <span class="s2">&quot;greedy&quot;</span><span class="p">:</span> <span class="s2">&quot;Greedy mean&quot;</span><span class="p">}</span>
    <span class="n">surg_titles</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gp&quot;</span><span class="p">:</span> <span class="s2">&quot;GP&quot;</span><span class="p">,</span> <span class="s2">&quot;rf&quot;</span><span class="p">:</span> <span class="s2">&quot;RF&quot;</span><span class="p">}</span>
    
    <span class="c1"># Define palette </span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;yield&quot;</span><span class="p">:</span> <span class="s2">&quot;#b6d09e&quot;</span><span class="p">,</span>          <span class="c1"># green</span>
        <span class="s2">&quot;purity&quot;</span><span class="p">:</span> <span class="s2">&quot;#f5cfa8&quot;</span><span class="p">,</span>         <span class="c1"># peach</span>
        <span class="s2">&quot;repro&quot;</span><span class="p">:</span> <span class="s2">&quot;#94cee5&quot;</span><span class="p">,</span>          <span class="c1"># blue</span>
        <span class="s2">&quot;scalar&quot;</span><span class="p">:</span> <span class="s2">&quot;#e9a2a3&quot;</span>          <span class="c1"># pink</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">mt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">surgs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">acq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">acqs</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">traces</span><span class="p">[</span><span class="n">mt</span><span class="p">][</span><span class="n">acq</span><span class="p">]</span>
            <span class="n">it</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;best_scalar&quot;</span><span class="p">]))</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;best_yield&quot;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;best yield&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;best_purity&quot;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;best purity&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;best_repro&quot;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="s2">&quot;repro&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;best reproducibility&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;best_scalar&quot;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="s2">&quot;scalar&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;best scalarized&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">surg_titles</span><span class="p">[</span><span class="n">mt</span><span class="p">]</span><span class="si">}</span><span class="s2"> — </span><span class="si">{</span><span class="n">acq_titles</span><span class="p">[</span><span class="n">acq</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;iteration&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">traces</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">traces</span> <span class="o">=</span> <span class="n">compare_rf_gp_acq_8panels</span><span class="p">(</span>
    <span class="n">search_space</span><span class="o">=</span><span class="n">search_space</span><span class="p">,</span>
    <span class="n">run_experiment</span><span class="o">=</span><span class="n">run_experiment</span><span class="p">,</span>
    <span class="n">initial_idx</span><span class="o">=</span><span class="n">initial_idx</span><span class="p">,</span>   <span class="c1"># 50 starting indices in search_space</span>
    <span class="n">rounds</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">batch</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">cloud</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">]),</span>
    <span class="n">rng_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">kappa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">display</span>
<span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/zzhenglab/ai4chem/main/book/_data/lec-15-trace1.png&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><img src="https://raw.githubusercontent.com/zzhenglab/ai4chem/main/book/_data/lec-15-trace1.png"/></div></div>
</div>
<p>Below, we will see when we change the weights, the MOBO will pay attention to objectives with higher weights and results can be different.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">traces2</span> <span class="o">=</span> <span class="n">compare_rf_gp_acq_8panels</span><span class="p">(</span>
    <span class="n">search_space</span><span class="o">=</span><span class="n">search_space</span><span class="p">,</span>
    <span class="n">run_experiment</span><span class="o">=</span><span class="n">run_experiment</span><span class="p">,</span>
    <span class="n">initial_idx</span><span class="o">=</span><span class="n">initial_idx</span><span class="p">,</span>   <span class="c1"># 50 starting indices in search_space</span>
    <span class="n">rounds</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">batch</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">cloud</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]),</span> <span class="c1">#care more on reaction yield</span>
    <span class="n">rng_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">kappa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">xi</span><span class="o">=</span><span class="mf">0.01</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">display</span>
<span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/zzhenglab/ai4chem/main/book/_data/lec-15-trace2.png&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><img src="https://raw.githubusercontent.com/zzhenglab/ai4chem/main/book/_data/lec-15-trace2.png"/></div></div>
</div>
</section>
<hr class="docutils" />
<section id="glossary">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">8. Glossary</a><a class="headerlink" href="#glossary" title="Permalink to this heading">#</a></h2>
<dl class="simple glossary">
<dt id="term-Pareto-dominance">Pareto dominance<a class="headerlink" href="#term-Pareto-dominance" title="Permalink to this term">#</a></dt><dd><p>Point <span class="math notranslate nohighlight">\(a\)</span> dominates <span class="math notranslate nohighlight">\(b\)</span> if <span class="math notranslate nohighlight">\(a\)</span> is at least as good on all objectives and strictly better on one.</p>
</dd>
<dt id="term-Pareto-front">Pareto front<a class="headerlink" href="#term-Pareto-front" title="Permalink to this term">#</a></dt><dd><p>The set of nondominated objective vectors. Moving along the front trades objectives.</p>
</dd>
<dt id="term-Scalarization">Scalarization<a class="headerlink" href="#term-Scalarization" title="Permalink to this term">#</a></dt><dd><p>Combine multiple objectives into one with weights <span class="math notranslate nohighlight">\(w_m \ge 0\)</span> and <span class="math notranslate nohighlight">\(\sum w_m = 1\)</span> to apply single objective methods.</p>
</dd>
<dt id="term-Hypervolume">Hypervolume<a class="headerlink" href="#term-Hypervolume" title="Permalink to this term">#</a></dt><dd><p>Measure of the volume dominated by the current Pareto front compared to a reference point. Larger is better.</p>
</dd>
<dt id="term-Expected-Hypervolume-Improvement">Expected Hypervolume Improvement<a class="headerlink" href="#term-Expected-Hypervolume-Improvement" title="Permalink to this term">#</a></dt><dd><p>Acquisition used in multiobjective BO that prefers candidates expected to increase hypervolume.</p>
</dd>
</dl>
</section>
<section id="in-class-activity">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">9. In-class activity</a><a class="headerlink" href="#in-class-activity" title="Permalink to this heading">#</a></h2>
<section id="q1-build-a-tiny-bo-coach-with-an-llm">
<h3>Q1. Build a tiny BO “coach” with an LLM<a class="headerlink" href="#q1-build-a-tiny-bo-coach-with-an-llm" title="Permalink to this heading">#</a></h3>
<p>Use an LLM (ChatGPT or Claude) as your coding buddy to create a function in Colab or a small UI that runs Bayesian Optimization (BO) on a reaction you choose. You define the variable space and the objectives, feed a few data points, and your tool suggests 3 new experiments. After you run them, you type in the results and the tool updates, ready to suggest 3 more.</p>
<p>What you will produce out of this activity:
A function that:</p>
<ul class="simple">
<li><p>choose the reaction family and define the variable space</p></li>
<li><p>input your measured results</p></li>
<li><p>Output “Suggest 3” to get the next batch</p></li>
<li><p>Support “Add results” to append new data and keep going</p></li>
</ul>
<p>Suggested scope
Pick one of the following case:</p>
<ul class="simple">
<li><p>Organic reaction screening</p></li>
<li><p>Catalysis screening</p></li>
<li><p>Liquid nanoparticle synthesis</p></li>
<li><p>MOF or polymer synthesis</p></li>
</ul>
<p>Keep the variable space small at first. For example:</p>
<ul class="simple">
<li><p>temperature in {25, 50, 75, 100}</p></li>
<li><p>time in {1, 2, 4}</p></li>
<li><p>solvent flag in {0, 1}</p></li>
<li><p>catalyst choice in {A, B, C}
Your objectives can be one or more of: yield, particle size, selectivity.</p></li>
</ul>
<p>Interaction rules for the BO tool</p>
<ul class="simple">
<li><p>You input 3 measured points → tool suggests 3</p></li>
<li><p>You input 9 measured points → tool suggests 3</p></li>
<li><p>You can append results anytime and resuggest</p></li>
<li><p>Stay within your discrete grid. Suggestions must be valid choices from your space</p></li>
</ul>
<div class="admonition-note admonition">
<p class="admonition-title">Note</p>
<p>Hint: Below are examples of prompts you can give to an LLM to generate code.</p>
</div>
<p><strong>Version</strong> A (simpler):</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">**Task**  </span>
<span class="s2">Write Python code for Google Colab that performs multi-objective Bayesian optimization for chemists using only lists and a pandas DataFrame that the user edits by hand between runs. No widgets. No external UI. The workflow is: user defines variables and objectives, enters any existing experiments in lists, runs a function to get new suggestions, updates the lists with results after running the lab work, then calls the function again.</span>

<span class="s2">---</span>

<span class="s2">### Requirements</span>

<span class="s2">1) **Environment and packages**</span>
<span class="s2">- Use only standard Colab-friendly libraries: `numpy`, `pandas`, `itertools`, `scikit-learn` GaussianProcessRegressor and kernels, and `scipy` for acquisition optimization if needed.</span>
<span class="s2">- Random seed support for reproducibility: a single `seed` parameter.</span>

<span class="s2">2) **User inputs as plain Python lists**</span>
<span class="s2">- Independent variables: the user defines a dict named `variables` where each key is a clean name without prefix and each value is a dict with `start`, `end`, `interval`. Example:</span>
<span class="s2">  python</span>
<span class="s2">  variables = {</span>
<span class="s2">      &quot;temperature&quot;: {&quot;start&quot;: 50, &quot;end&quot;: 100, &quot;interval&quot;: 10},</span>
<span class="s2">      &quot;time&quot;: {&quot;start&quot;: 1, &quot;end&quot;: 5, &quot;interval&quot;: 1}</span>
<span class="s2">  }</span>
<span class="s2"> </span>
<span class="s2">- Objectives: the user defines a list `objectives` with 1 to 3 names, assumed normalized to 0..1. Example: `objectives = [&quot;yield&quot;, &quot;selectivity&quot;]`.</span>
<span class="s2">- Objective weights: list `objective_weights`. If 1 objective, weight is [1.0]. If multiple, user provides weights that sum to 1.0. Validate the sum equals 1.0 within a small tolerance.</span>

<span class="s2">3) **Internal naming scheme**</span>
<span class="s2">- Code must convert variable names to columns with `var_` prefix and objective names to `obj_` prefix. Example: `temperature` becomes `var_temperature`, `yield` becomes `obj_yield`.</span>
<span class="s2">- Add a column `iteration` to track status. Use:</span>
<span class="s2">  - `-1` for not tried</span>
<span class="s2">  - `1, 2, ...` for completed iterations</span>
<span class="s2">  - The next suggested set gets the next integer</span>

<span class="s2">4) **Space construction**</span>
<span class="s2">- Build the full Cartesian grid from `variables` based on start, end, interval. Validate that `(end - start)` is divisible by `interval`. Raise a clear error message if not.</span>
<span class="s2">- Create a DataFrame `df_space` with all `var_...` columns, empty `obj_...` columns, and `iteration` initialized to `-1`.</span>

<span class="s2">5) **Manual data entry by the user**</span>
<span class="s2">- The user maintains two Python lists of equal length that describe completed experiments:</span>
<span class="s2">  - `run_conditions`: list of dicts for variables. Example:</span>
<span class="s2">    python</span>
<span class="s2">    run_conditions = [</span>
<span class="s2">        {&quot;temperature&quot;: 70, &quot;time&quot;: 3},</span>
<span class="s2">        {&quot;temperature&quot;: 60, &quot;time&quot;: 4},</span>
<span class="s2">    ]</span>
<span class="s2">    </span>
<span class="s2">  - `run_results`: list of dicts for objectives. Example:</span>

<span class="s2">    python</span>
<span class="s2">    run_results = [</span>
<span class="s2">        {&quot;yield&quot;: 0.62, &quot;selectivity&quot;: 0.80},</span>
<span class="s2">        {&quot;yield&quot;: 0.55, &quot;selectivity&quot;: 0.83},</span>
<span class="s2">    ]</span>
<span class="s2">    </span>
<span class="s2">- Code must validate that lengths match and all names match defined variables and objectives.</span>

<span class="s2">6) **Merging runs into the master DataFrame**</span>
<span class="s2">- A utility function updates `df_space`:</span>
<span class="s2">  - Finds rows that match each `run_conditions` entry on all `var_...` columns.</span>
<span class="s2">  - Writes the `obj_...` values.</span>
<span class="s2">  - Sets `iteration` to the current completed iteration number. If no prior data, set to `1`. If prior exists, set to `max(iteration) + 1` only for new rows.</span>
<span class="s2">- If a run condition does not appear in `df_space`, raise a helpful error that the value is out of grid.</span>

<span class="s2">7) **Modeling and acquisition**</span>
<span class="s2">- Default model is Gaussian Process with RBF kernel and WhiteKernel noise term. Use one model per objective.</span>
<span class="s2">- Scale inputs to 0..1 across each variable dimension before modeling. Keep a small epsilon to avoid zero length.</span>
<span class="s2">- Acquisition: Expected Improvement on the **weighted scalarized objective**. Steps:</span>
<span class="s2">  - Fit one GP per objective on completed rows.</span>
<span class="s2">  - Predict mean and std for each objective across all candidate points with `iteration == -1`.</span>
<span class="s2">  - Compute a weighted sum of predicted means to get scalar mean. For variance, combine via a simple diagonal approximation by weighting the std terms. Document that this is an approximation.</span>
<span class="s2">  - Compute EI vs the best observed weighted scalar value among completed rows.</span>
<span class="s2">- Tie-breaking for equal scores should be stable by index order.</span>

<span class="s2">8) **Suggestion function**</span>
<span class="s2">- Provide a main function:</span>
<span class="s2">  python</span>
<span class="s2">  def suggest_experiments(variables, objectives, objective_weights, run_conditions, run_results, batch_size=3, seed=123, save_csv=False, csv_path=None):</span>
<span class="s2">      </span>
<span class="s2">      #Returns:</span>
<span class="s2">        #suggestions_df: DataFrame with the next set of suggested experiments (var_ columns only)</span>
<span class="s2">        #df_space: Updated master DataFrame with iteration values and any new writes</span>
<span class="s2">      #</span>

<span class="s2">- Behavior:</span>
<span class="s2">  - Build or rebuild `df_space` from `variables`.</span>
<span class="s2">  - Integrate `run_conditions` and `run_results` into `df_space`.</span>
<span class="s2">  - If there is no completed data yet, pick `batch_size` random points from `iteration == -1` as suggestions and set their `iteration` to `1`. Return suggestions.</span>
<span class="s2">  - Otherwise, fit GP models as above, compute EI on all `iteration == -1` rows, pick top `batch_size` rows, set their `iteration` to `max(iteration) + 1`, and return suggestions.</span>
<span class="s2">  - If `save_csv` is True, write `df_space` to `csv_path` if provided, otherwise to `experiment_&lt;timestamp&gt;.csv`.</span>

<span class="s2">9) **Outputs and instructions**</span>
<span class="s2">- Print a short summary:</span>
<span class="s2">  - Number of variables and total grid size</span>
<span class="s2">  - Number of completed runs found</span>
<span class="s2">  - Batch size and iteration number suggested</span>
<span class="s2">- Return `suggestions_df` that shows only `var_...` columns for the user to run in the lab.</span>
<span class="s2">- Also return the full `df_space` so the user can save or inspect it.</span>

<span class="s2">10) **Round trip workflow for the user**</span>
<span class="s2">- First call:</span>
<span class="s2">  - Define `variables`, `objectives`, `objective_weights`.</span>
<span class="s2">  - Set `run_conditions = []` and `run_results = []` if starting fresh.</span>
<span class="s2">  - Call `suggest_experiments(...)` to get initial suggestions.</span>
<span class="s2">- After the lab:</span>
<span class="s2">  - Append the new completed conditions to `run_conditions` and the measured results to `run_results`.</span>
<span class="s2">  - Call `suggest_experiments(...)` again to receive the next suggestions.</span>
<span class="s2">- Provide a short example section in the notebook with a tiny space and fake results to demonstrate 2 iterations.</span>

<span class="s2">11) **Validation and helpful errors**</span>
<span class="s2">- Check weights sum to 1.0 within 1e-6.</span>
<span class="s2">- Check variable ranges and intervals.</span>
<span class="s2">- Check names match exactly.</span>
<span class="s2">- If no available points remain, print a clear message and return empty suggestions.</span>

<span class="s2">12) **No UI, no widgets, no files required**</span>
<span class="s2">- Everything runs in cells.</span>
<span class="s2">- The only persistence is optional CSV save when `save_csv=True`.</span>

<span class="s2">---</span>

<span class="s2">### Example usage block to include in the notebook</span>

<span class="s2">python</span>
<span class="s2"># 1) Define variables and objectives</span>
<span class="s2">variables = {</span>
<span class="s2">    &quot;temperature&quot;: {&quot;start&quot;: 50, &quot;end&quot;: 70, &quot;interval&quot;: 10},</span>
<span class="s2">    &quot;time&quot;: {&quot;start&quot;: 1, &quot;end&quot;: 3, &quot;interval&quot;: 1},</span>
<span class="s2">}</span>
<span class="s2">objectives = [&quot;yield&quot;, &quot;selectivity&quot;]</span>
<span class="s2">objective_weights = [0.6, 0.4]  # sums to 1.0</span>

<span class="s2"># 2) Start with no completed data</span>
<span class="s2">run_conditions = []</span>
<span class="s2">run_results = []</span>

<span class="s2"># 3) First call: random suggestions</span>
<span class="s2">suggestions, df_space = suggest_experiments(</span>
<span class="s2">    variables, objectives, objective_weights,</span>
<span class="s2">    run_conditions, run_results,</span>
<span class="s2">    batch_size=2, seed=42, save_csv=False</span>
<span class="s2">)</span>
<span class="s2">print(&quot;Suggested experiments:&quot;)</span>
<span class="s2">print(suggestions)</span>

<span class="s2"># 4) Pretend we ran them in the lab, now enter results</span>
<span class="s2"># Convert suggested rows back to plain dicts with original names</span>
<span class="s2">run_conditions.extend([</span>
<span class="s2">    {&quot;temperature&quot;: int(row[&quot;var_temperature&quot;]), &quot;time&quot;: int(row[&quot;var_time&quot;])}</span>
<span class="s2">    for _, row in suggestions.iterrows()</span>
<span class="s2">])</span>
<span class="s2">run_results.extend([</span>
<span class="s2">    {&quot;yield&quot;: 0.55, &quot;selectivity&quot;: 0.78},</span>
<span class="s2">    {&quot;yield&quot;: 0.61, &quot;selectivity&quot;: 0.74},</span>
<span class="s2">])</span>

<span class="s2"># 5) Second call: model-based suggestions</span>
<span class="s2">suggestions, df_space = suggest_experiments(</span>
<span class="s2">    variables, objectives, objective_weights,</span>
<span class="s2">    run_conditions, run_results,</span>
<span class="s2">    batch_size=2, seed=42, save_csv=False</span>
<span class="s2">)</span>
<span class="s2">print(&quot;Next suggestions:&quot;)</span>
<span class="s2">print(suggestions)</span>


<span class="s2">Include all functions and imports needed to run this end to end in a fresh Colab session.</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>LLM output code from <strong>Version A</strong> prompt:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- Imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.gaussian_process</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.gaussian_process.kernels</span><span class="w"> </span><span class="kn">import</span> <span class="n">RBF</span><span class="p">,</span> <span class="n">WhiteKernel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>

<span class="c1"># --- Utility: validation</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_validate_variables</span><span class="p">(</span><span class="n">variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`variables` must be a non-empty dict of {name: {start, end, interval}}.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39; must map to a dict with keys start, end, interval.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;interval&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39; missing key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">interval</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;interval&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">interval</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39; has non-positive interval.&quot;</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
        <span class="c1"># allow ints or floats that divide cleanly</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">((</span><span class="n">diff</span> <span class="o">/</span> <span class="n">interval</span><span class="p">)</span> <span class="o">-</span> <span class="nb">round</span><span class="p">(</span><span class="n">diff</span> <span class="o">/</span> <span class="n">interval</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39; has (end - start) not divisible by interval. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Got start=</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">, end=</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2">, interval=</span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_validate_objectives_and_weights</span><span class="p">(</span><span class="n">objectives</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">objective_weights</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objectives</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">objectives</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">objectives</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`objectives` must be a list with 1 to 3 names.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objective_weights</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">objective_weights</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">objectives</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`objective_weights` must be a list the same length as `objectives`.&quot;</span><span class="p">)</span>
    <span class="n">wsum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">objective_weights</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">wsum</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`objective_weights` must sum to 1.0 within 1e-6. Got </span><span class="si">{</span><span class="n">wsum</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_validate_run_lists</span><span class="p">(</span><span class="n">run_conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">run_results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run_conditions</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run_results</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`run_conditions` and `run_results` must be lists.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">run_conditions</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">run_results</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`run_conditions` and `run_results` must have equal length.&quot;</span><span class="p">)</span>

<span class="c1"># --- Space construction</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_build_space_df</span><span class="p">(</span><span class="n">variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">objectives</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">_validate_variables</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
    <span class="n">var_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># Build per-variable discrete grids</span>
    <span class="n">grids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;interval&quot;</span><span class="p">]</span>
        <span class="c1"># inclusive end</span>
        <span class="n">n_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">interval</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">interval</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">)]</span>
        <span class="n">grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

    <span class="c1"># Cartesian product</span>
    <span class="n">all_rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">grids</span><span class="p">))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;var_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">])</span>

    <span class="c1"># Add empty objective columns</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objectives</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;obj_</span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># Iteration status</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="c1"># --- Merge completed runs</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_merge_runs_into_space</span><span class="p">(</span>
    <span class="n">df_space</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
    <span class="n">objectives</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">run_conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
    <span class="n">run_results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes completed runs into df_space.</span>
<span class="sd">    Returns updated df_space and max_completed_iteration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_validate_run_lists</span><span class="p">(</span><span class="n">run_conditions</span><span class="p">,</span> <span class="n">run_results</span><span class="p">)</span>
    <span class="n">var_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">obj_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">objectives</span><span class="p">)</span>

    <span class="c1"># Validate names in runs</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">run_conditions</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">var_names</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;run_conditions[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] keys must match variables exactly: </span><span class="si">{</span><span class="n">var_names</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">rc</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">run_results</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">obj_names</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;run_results[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] keys must match objectives exactly: </span><span class="si">{</span><span class="n">obj_names</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">run_conditions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df_space</span><span class="p">,</span> <span class="mi">0</span>

    <span class="c1"># Assign iteration numbers to completed rows in order of provided runs</span>
    <span class="n">next_it</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">matched_any</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Track which rows were already written in this pass to avoid double-assigning</span>
    <span class="c1"># if the same condition appears twice. Last one wins for objectives, but iteration</span>
    <span class="c1"># will follow the order provided.</span>
    <span class="k">for</span> <span class="n">idx_pair</span><span class="p">,</span> <span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">rr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">run_conditions</span><span class="p">,</span> <span class="n">run_results</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Build a boolean mask that matches all var_ columns</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_space</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">vname</span><span class="p">,</span> <span class="n">vval</span> <span class="ow">in</span> <span class="n">rc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">df_space</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;var_</span><span class="si">{</span><span class="n">vname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">vval</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">df_space</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;run_conditions[</span><span class="si">{</span><span class="n">idx_pair</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">] does not match any grid row. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;At least one value is outside the defined grid.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># If multiple identical rows exist, use the first by index to keep stability</span>
        <span class="n">tgt_idx</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">matched_any</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Write objectives</span>
        <span class="k">for</span> <span class="n">oname</span><span class="p">,</span> <span class="n">oval</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df_space</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tgt_idx</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;obj_</span><span class="si">{</span><span class="n">oname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">oval</span><span class="p">)</span>

        <span class="c1"># Set iteration number in sequential order of provided runs</span>
        <span class="n">df_space</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tgt_idx</span><span class="p">,</span> <span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_it</span>
        <span class="n">next_it</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">max_completed_it</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df_space</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="k">if</span> <span class="n">matched_any</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">df_space</span><span class="p">,</span> <span class="n">max_completed_it</span>

<span class="c1"># --- Scaling to [0, 1]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_scale_X</span><span class="p">(</span><span class="n">df_rows</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">var_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df_rows</span><span class="p">[[</span><span class="sa">f</span><span class="s2">&quot;var_</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">mins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">variables</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">maxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">variables</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">span</span> <span class="o">=</span> <span class="n">maxs</span> <span class="o">-</span> <span class="n">mins</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-12</span>
    <span class="n">span</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">span</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">span</span><span class="p">)</span>
    <span class="n">X_scaled</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">mins</span><span class="p">)</span> <span class="o">/</span> <span class="n">span</span>
    <span class="n">X_scaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X_scaled</span>

<span class="c1"># --- GP fitting and EI</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_fit_gp_models</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">Y_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">GaussianProcessRegressor</span><span class="p">]:</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">Y_list</span><span class="p">:</span>
        <span class="c1"># Drop NaNs if any are present</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># No data for this objective</span>
            <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">yt</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">RBF</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">+</span> <span class="n">WhiteKernel</span><span class="p">(</span><span class="n">noise_level</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">gp</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span>
            <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>            <span class="c1"># use WhiteKernel for noise</span>
            <span class="n">normalize_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
            <span class="n">n_restarts_optimizer</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xt</span><span class="p">,</span> <span class="n">yt</span><span class="p">)</span>
        <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">models</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_predict_objectives</span><span class="p">(</span><span class="n">models</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">GaussianProcessRegressor</span><span class="p">],</span> <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    
    <span class="c1">#Returns:</span>
      <span class="c1">#means: shape (n_points, n_obj)</span>
      <span class="c1">#stds:  shape (n_points, n_obj)</span>
    
    <span class="n">n_points</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_obj</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_points</span><span class="p">,</span> <span class="n">n_obj</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_points</span><span class="p">,</span> <span class="n">n_obj</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">gp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">gp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">means</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
        <span class="n">stds</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
    <span class="k">return</span> <span class="n">means</span><span class="p">,</span> <span class="n">stds</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_weighted_scalarization</span><span class="p">(</span><span class="n">means</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">stds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple diagonal approximation for variance:</span>
<span class="sd">      mu_s = sum_j w_j * mu_j</span>
<span class="sd">      sigma_s = sqrt(sum_j (w_j * sigma_j)^2)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mu_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">means</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sigma_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">((</span><span class="n">stds</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mu_s</span><span class="p">,</span> <span class="n">sigma_s</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_expected_improvement</span><span class="p">(</span><span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">best</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">xi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    EI against best observed scalar value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">imp</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">-</span> <span class="n">best</span> <span class="o">-</span> <span class="n">xi</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sigma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imp</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">ei</span> <span class="o">=</span> <span class="n">imp</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
        <span class="n">ei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sigma</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">ei</span><span class="p">)</span>
    <span class="c1"># Negative EI not useful</span>
    <span class="n">ei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">ei</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ei</span>

<span class="c1"># --- Main API</span>

<span class="k">def</span><span class="w"> </span><span class="nf">suggest_experiments</span><span class="p">(</span>
    <span class="n">variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
    <span class="n">objectives</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">objective_weights</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">run_conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
    <span class="n">run_results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">123</span><span class="p">,</span>
    <span class="n">save_csv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
    <span class="c1">#</span>
    <span class="c1">#Returns:</span>
      <span class="c1">#suggestions_df: DataFrame of suggested experiments (var_ columns only)</span>
      <span class="c1">#df_space: full updated DataFrame</span>
    <span class="c1">#</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">_validate_objectives_and_weights</span><span class="p">(</span><span class="n">objectives</span><span class="p">,</span> <span class="n">objective_weights</span><span class="p">)</span>

    <span class="c1"># Build space fresh each call</span>
    <span class="n">df_space</span> <span class="o">=</span> <span class="n">_build_space_df</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">objectives</span><span class="p">)</span>

    <span class="c1"># Merge completed runs</span>
    <span class="n">df_space</span><span class="p">,</span> <span class="n">max_completed_iteration</span> <span class="o">=</span> <span class="n">_merge_runs_into_space</span><span class="p">(</span>
        <span class="n">df_space</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">run_conditions</span><span class="p">,</span> <span class="n">run_results</span>
    <span class="p">)</span>

    <span class="c1"># Summary numbers</span>
    <span class="n">var_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_space</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;var_&quot;</span><span class="p">)]</span>
    <span class="n">obj_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;obj_</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objectives</span><span class="p">]</span>
    <span class="n">grid_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_space</span><span class="p">)</span>
    <span class="n">n_vars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_cols</span><span class="p">)</span>

    <span class="c1"># Completed rows have iteration &gt; 0 and no NaNs in objectives</span>
    <span class="n">completed_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_space</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">oc</span> <span class="ow">in</span> <span class="n">obj_cols</span><span class="p">:</span>
        <span class="n">completed_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">df_space</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
    <span class="n">n_completed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">completed_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="c1"># Candidates are rows not yet tried</span>
    <span class="n">cand_mask</span> <span class="o">=</span> <span class="n">df_space</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">n_candidates</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cand_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">n_candidates</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No available points remain. Grid size </span><span class="si">{</span><span class="n">grid_size</span><span class="si">}</span><span class="s2">. Completed runs </span><span class="si">{</span><span class="n">n_completed</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">var_cols</span><span class="p">),</span> <span class="n">df_space</span>

    <span class="c1"># If no completed data yet, return random suggestions</span>
    <span class="k">if</span> <span class="n">n_completed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">choose_k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">n_candidates</span><span class="p">)</span>
        <span class="n">cand_indices</span> <span class="o">=</span> <span class="n">df_space</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">cand_mask</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">cand_indices</span><span class="p">)</span>
        <span class="n">chosen</span> <span class="o">=</span> <span class="n">cand_indices</span><span class="p">[:</span><span class="n">choose_k</span><span class="p">]</span>
        <span class="c1"># Assign iteration numbers to suggested rows</span>
        <span class="n">next_it</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># first iteration of the campaign</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">chosen</span><span class="p">:</span>
            <span class="n">df_space</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_it</span>
        <span class="n">suggestions_df</span> <span class="o">=</span> <span class="n">df_space</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">chosen</span><span class="p">,</span> <span class="n">var_cols</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variables: </span><span class="si">{</span><span class="n">n_vars</span><span class="si">}</span><span class="s2">, grid size: </span><span class="si">{</span><span class="n">grid_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed runs found: </span><span class="si">{</span><span class="n">n_completed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Suggesting batch of </span><span class="si">{</span><span class="n">choose_k</span><span class="si">}</span><span class="s2"> for iteration </span><span class="si">{</span><span class="n">next_it</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_csv</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">csv_path</span> <span class="k">if</span> <span class="n">csv_path</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;experiment_</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2">.csv&quot;</span>
            <span class="n">df_space</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved df_space to: </span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">suggestions_df</span><span class="p">,</span> <span class="n">df_space</span>

    <span class="c1"># Model-based suggestions</span>
    <span class="c1"># Prepare training and candidate matrices in [0, 1]</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">_scale_X</span><span class="p">(</span><span class="n">df_space</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">completed_mask</span><span class="p">,</span> <span class="n">var_cols</span><span class="p">],</span> <span class="n">variables</span><span class="p">)</span>
    <span class="n">Y_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_space</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">completed_mask</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;obj_</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objectives</span><span class="p">]</span>
    <span class="n">models</span> <span class="o">=</span> <span class="n">_fit_gp_models</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_list</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># Predict on candidates</span>
    <span class="n">X_cand</span> <span class="o">=</span> <span class="n">_scale_X</span><span class="p">(</span><span class="n">df_space</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cand_mask</span><span class="p">,</span> <span class="n">var_cols</span><span class="p">],</span> <span class="n">variables</span><span class="p">)</span>
    <span class="n">means</span><span class="p">,</span> <span class="n">stds</span> <span class="o">=</span> <span class="n">_predict_objectives</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">X_cand</span><span class="p">)</span>

    <span class="c1"># Weighted scalarization of predictive distribution</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">objective_weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">mu_s</span><span class="p">,</span> <span class="n">sigma_s</span> <span class="o">=</span> <span class="n">_weighted_scalarization</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>

    <span class="c1"># Best observed weighted scalar on completed data</span>
    <span class="n">completed_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">df_space</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">completed_mask</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;obj_</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objectives</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">best_scalar</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">completed_means</span> <span class="o">*</span> <span class="n">w</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="c1"># EI on candidates</span>
    <span class="n">ei</span> <span class="o">=</span> <span class="n">_expected_improvement</span><span class="p">(</span><span class="n">mu_s</span><span class="p">,</span> <span class="n">sigma_s</span><span class="p">,</span> <span class="n">best_scalar</span><span class="p">,</span> <span class="n">xi</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># Stable tie-breaking by original index order</span>
    <span class="n">cand_idx</span> <span class="o">=</span> <span class="n">df_space</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">cand_mask</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">((</span><span class="o">-</span><span class="n">ei</span><span class="p">,</span> <span class="n">cand_idx</span><span class="p">))</span>  <span class="c1"># sort by EI desc, then index asc</span>
    <span class="n">chosen</span> <span class="o">=</span> <span class="n">cand_idx</span><span class="p">[</span><span class="n">order</span><span class="p">][:</span><span class="nb">min</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cand_idx</span><span class="p">))]</span>

    <span class="c1"># Assign next iteration number to suggestions</span>
    <span class="n">next_it</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_completed_iteration</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">max_completed_iteration</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">chosen</span><span class="p">:</span>
        <span class="n">df_space</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_it</span>

    <span class="n">suggestions_df</span> <span class="o">=</span> <span class="n">df_space</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">chosen</span><span class="p">,</span> <span class="n">var_cols</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variables: </span><span class="si">{</span><span class="n">n_vars</span><span class="si">}</span><span class="s2">, grid size: </span><span class="si">{</span><span class="n">grid_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed runs found: </span><span class="si">{</span><span class="n">n_completed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Suggesting batch of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">chosen</span><span class="p">)</span><span class="si">}</span><span class="s2"> for iteration </span><span class="si">{</span><span class="n">next_it</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_csv</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">csv_path</span> <span class="k">if</span> <span class="n">csv_path</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;experiment_</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="n">df_space</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved df_space to: </span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">suggestions_df</span><span class="p">,</span> <span class="n">df_space</span>

<span class="c1">##############################################################################</span>

  <span class="c1">###EXAMPLE USE#####  </span>
<span class="c1"># 1) Define variables and objectives</span>
<span class="n">variables</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
<span class="p">}</span>
<span class="n">objectives</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">,</span> <span class="s2">&quot;selectivity&quot;</span><span class="p">]</span>
<span class="n">objective_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]</span>  <span class="c1"># sums to 1.0</span>

<span class="c1"># 2) Start with no completed data</span>
<span class="n">run_conditions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">run_results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># 3) First call: random suggestions</span>
<span class="n">suggestions</span><span class="p">,</span> <span class="n">df_space</span> <span class="o">=</span> <span class="n">suggest_experiments</span><span class="p">(</span>
    <span class="n">variables</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">objective_weights</span><span class="p">,</span>
    <span class="n">run_conditions</span><span class="p">,</span> <span class="n">run_results</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">save_csv</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Suggested experiments:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">suggestions</span><span class="p">)</span>


<span class="c1"># 4) Pretend we ran them in the lab, now enter results</span>
<span class="c1"># Convert suggested rows back to plain dicts with original names</span>
<span class="n">run_conditions</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
    <span class="p">{</span><span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;var_temperature&quot;</span><span class="p">]),</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;var_time&quot;</span><span class="p">])}</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">suggestions</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
<span class="p">])</span>
<span class="n">run_results</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
    <span class="p">{</span><span class="s2">&quot;yield&quot;</span><span class="p">:</span> <span class="mf">0.55</span><span class="p">,</span> <span class="s2">&quot;selectivity&quot;</span><span class="p">:</span> <span class="mf">0.78</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;yield&quot;</span><span class="p">:</span> <span class="mf">0.61</span><span class="p">,</span> <span class="s2">&quot;selectivity&quot;</span><span class="p">:</span> <span class="mf">0.74</span><span class="p">},</span>
<span class="p">])</span>

<span class="c1"># 5) Second call: model-based suggestions</span>
<span class="n">suggestions</span><span class="p">,</span> <span class="n">df_space</span> <span class="o">=</span> <span class="n">suggest_experiments</span><span class="p">(</span>
    <span class="n">variables</span><span class="p">,</span> <span class="n">objectives</span><span class="p">,</span> <span class="n">objective_weights</span><span class="p">,</span>
    <span class="n">run_conditions</span><span class="p">,</span> <span class="n">run_results</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">save_csv</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Next suggestions:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">suggestions</span><span class="p">)</span>


<span class="c1"># THEN you can do third call.....</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Variables: 2, grid size: 9
Completed runs found: 0
Suggesting batch of 2 for iteration 1
Suggested experiments:
   var_temperature  var_time
0               60         1
1               50         1
Variables: 2, grid size: 9
Completed runs found: 2
Suggesting batch of 2 for iteration 3
Next suggestions:
   var_temperature  var_time
0               50         2
1               50         3
</pre></div>
</div>
</div>
</div>
<p>Now we can also consider <strong>Version B</strong> (more features), with UI and bottons for someone who does not code in your lab to use:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">promptB</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">**Task:**  </span>
<span class="s2">In Google Colab, write Python code that creates a **popup-style interactive UI** for *multi-objective Bayesian optimization* for chemists. The tool should guide users through setting up or continuing an optimization experiment with intuitive inputs and automated CSV handling.</span>

<span class="s2">---</span>

<span class="s2">### **General Requirements**</span>
<span class="s2">- Use **Google Colab UI elements** (`ipywidgets` or `gradio` if suitable) to create a popup-style or form-based interface.  </span>
<span class="s2">- Ensure all UI components are clearly labeled and organized in steps.  </span>
<span class="s2">- Include inline validation (e.g., weight sum equals 1, valid numeric intervals).  </span>
<span class="s2">- Save and read CSV files locally in the Colab environment.  </span>
<span class="s2">- Code must be modular, with functions for UI rendering, CSV generation, data validation, and Bayesian suggestion updates.</span>

<span class="s2">---</span>

<span class="s2">### **Step 1: Start Screen**</span>
<span class="s2">When the notebook runs, display a popup or landing panel with **two mode buttons**:</span>
<span class="s2">1. **Establish New Experiment**</span>
<span class="s2">2. **Start from Existing Experiment**</span>

<span class="s2">Each button triggers a separate workflow.</span>

<span class="s2">---</span>

<span class="s2">### **Step 2: Establish New Experiment Workflow**</span>
<span class="s2">When the user clicks **&quot;Establish New Experiment&quot;**, do the following:</span>

<span class="s2">#### **2.1 Variable Definition**</span>
<span class="s2">- Ask for **at least one independent variable** (e.g., temperature, pressure).  </span>
<span class="s2">  Each variable requires:</span>
<span class="s2">  - Name input field (e.g., “Temperature”)  </span>
<span class="s2">  - Numeric start value  </span>
<span class="s2">  - Numeric end value  </span>
<span class="s2">  - Interval value  </span>
<span class="s2">- Provide a **“+ Add another variable”** button to add more variables dynamically.</span>
<span class="s2">- Each variable name should automatically be prefixed as `var_&lt;name&gt;` in the output (e.g., `var_temperature`).</span>

<span class="s2">#### **2.2 Objective Definition**</span>
<span class="s2">- Ask for **1 to 3 objective variables** (e.g., yield, selectivity).</span>
<span class="s2">- Each objective name will be automatically prefixed as `obj_&lt;name&gt;`.</span>
<span class="s2">- All objectives are **assumed to be normalized (0–1)** values.</span>
<span class="s2">- If more than one objective is defined:</span>
<span class="s2">  - Ask the user to assign **weights** to each.</span>
<span class="s2">  - Validate that all weights sum to **1.0**.</span>
<span class="s2">- If only one objective is defined, it automatically receives a weight of **1.0**.</span>

<span class="s2">#### **2.3 Space and Experiment Setup**</span>
<span class="s2">Ask for the following:</span>
<span class="s2">- **Total number of reaction space points** (the total grid size generated from variable intervals).</span>
<span class="s2">- **Number of experiments to run at a time** (default = 3).</span>
<span class="s2">- **Whether existing experimental data is available** (Yes/No radio buttons).</span>

<span class="s2">#### **2.4 Handling Existing Data**</span>
<span class="s2">- If **Yes**:</span>
<span class="s2">  - Display a small data entry form (or file upload option) where the user can enter or upload:</span>
<span class="s2">    - Columns matching variable names (`var_...`)</span>
<span class="s2">    - Objective values (`obj_...`)</span>
<span class="s2">  - These entries are assigned **iteration = 1** in the CSV (indicating completed experiments).</span>
<span class="s2">- If **No**:</span>
<span class="s2">  - Perform **random sampling** to suggest the first N (default 3) experiments.</span>
<span class="s2">  - Assign these as **iteration = 1** (indicating suggested experiments).</span>

<span class="s2">#### **2.5 CSV Generation**</span>
<span class="s2">- Automatically generate a **CSV file** with the following:</span>
<span class="s2">  - Columns:</span>
<span class="s2">    - All `var_...` variables</span>
<span class="s2">    - All `obj_...` objectives (blank for suggested experiments)</span>
<span class="s2">    - `iteration` column (integer values)</span>
<span class="s2">  - Initially fill:</span>
<span class="s2">    - All possible variable combinations (full space)</span>
<span class="s2">    - Objective columns as blank</span>
<span class="s2">    - `iteration` = -1 for untested combinations</span>
<span class="s2">    - Suggested experiment rows marked with the **largest iteration number**</span>
<span class="s2">- Save the CSV file locally with a user-defined or auto-generated name (`experiment_&lt;timestamp&gt;.csv`).</span>

<span class="s2">#### **2.6 Default Algorithm**</span>
<span class="s2">- Default optimization algorithm: **Gaussian Process (GP)** with **Expected Improvement (EI)**.</span>
<span class="s2">- Display a summary of suggested experiments to the user before saving.</span>

<span class="s2">---</span>

<span class="s2">### **Step 3: Start from Existing Experiment Workflow**</span>
<span class="s2">When the user clicks **“Start from Existing Experiment”**:</span>
<span class="s2">- Prompt them to **upload or select an existing local CSV file**.</span>

<span class="s2">#### **3.1 CSV Parsing**</span>
<span class="s2">After upload:</span>
<span class="s2">- Automatically scan the CSV:</span>
<span class="s2">  - Identify variable columns (`var_...`)</span>
<span class="s2">  - Identify objective columns (`obj_...`)</span>
<span class="s2">  - Identify iteration column</span>
<span class="s2">- Verify:</span>
<span class="s2">  - At least one `obj_...` column exists.</span>
<span class="s2">  - The **largest iteration number** corresponds to completed experiments.</span>
<span class="s2">  - If objective values for the latest iteration are missing, display a **reminder** to fill them before proceeding.</span>

<span class="s2">#### **3.2 Next Suggestion Generation**</span>
<span class="s2">- Once validated:</span>
<span class="s2">  - Fit the **Bayesian model** using completed experiment data.</span>
<span class="s2">  - Suggest the next N experiments (using the same number as before unless the user specifies otherwise).</span>
<span class="s2">  - Append the new suggestions to the CSV file.</span>
<span class="s2">  - Assign these new rows **iteration = (max_iteration + 1)**.</span>
<span class="s2">  - Display the suggested experiments for user review.</span>

<span class="s2">---</span>

<span class="s2">### **Step 4: Additional Functional Features**</span>
<span class="s2">- **Validation Checks:**</span>
<span class="s2">  - Numeric range consistency (start &lt; end).</span>
<span class="s2">  - Interval divides the range evenly.</span>
<span class="s2">  - Objective weight sum = 1.0.</span>
<span class="s2">  - Variable and objective names cannot repeat.</span>
<span class="s2">- **UI Elements:**</span>
<span class="s2">  - Progress indicators between steps.</span>
<span class="s2">  - Clear success messages after saving CSV.</span>
<span class="s2">  - Option to reopen the main menu without rerunning the cell.</span>

<span class="s2">---</span>

<span class="s2">### **Step 5: Data Handling Notes**</span>
<span class="s2">- All CSV files should include:</span>
<span class="s2">  </span>
<span class="s2">  var_xxx | var_yyy | ... | obj_aaa | obj_bbb | iteration</span>
<span class="s2">  </span>
<span class="s2">- Default “unrun” rows → `iteration = -1`.</span>
<span class="s2">- Suggested (pending) experiments → next iteration number.</span>
<span class="s2">- Completed experiments → filled objective values.</span>

<span class="s2">---</span>

<span class="s2">### **Step 6: Suggested Extensions (Optional)**</span>
<span class="s2">You may include:</span>
<span class="s2">- Plotting functions (2D or 3D scatter for objectives and variables).  </span>
<span class="s2">- Export results to Excel.  </span>
<span class="s2">- Log system to track runs and timestamps.  </span>
<span class="s2">- Optional parameter for random seed for reproducibility.</span>

<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>LLM output code from <strong>Version B</strong> prompt:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">clear_output</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ipywidgets</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">w</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.gaussian_process</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.gaussian_process.kernels</span><span class="w"> </span><span class="kn">import</span> <span class="n">Matern</span><span class="p">,</span> <span class="n">WhiteKernel</span><span class="p">,</span> <span class="n">ConstantKernel</span> <span class="k">as</span> <span class="n">C</span>


<span class="c1"># =========================</span>
<span class="c1"># Helpers: validation</span>
<span class="c1"># =========================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_is_float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_variables</span><span class="p">(</span><span class="n">var_rows</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">var_rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Variable </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: name required&quot;</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Variable </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: duplicate name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">_is_float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">_is_float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">_is_float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">])):</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Variable </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: start, end, and interval must be numeric&quot;</span>

        <span class="n">start</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">])</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">])</span>
        <span class="n">step</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Variable </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: start must be less than end&quot;</span>
        <span class="k">if</span> <span class="n">step</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Variable </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: interval must be positive&quot;</span>

        <span class="n">span</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">span</span> <span class="o">/</span> <span class="n">step</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Variable </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: interval does not divide range evenly. Choose step so (end - start)/step is an integer&quot;</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_objectives</span><span class="p">(</span><span class="n">obj_rows</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">obj_rows</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;At least one objective required&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Maximum 3 objectives&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj_rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Objective </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: name required&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Objective </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: duplicate name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="c1"># weights</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">weights</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">obj_rows</span><span class="p">:</span>
        <span class="n">wv</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_float</span><span class="p">(</span><span class="n">wv</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Weight for objective &#39;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; must be numeric&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">wv</span><span class="p">))</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Weights must be finite numbers&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Weight sum must be 1.0. Current sum = </span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">weights</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Weights must be nonnegative&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">weights</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_grid_size</span><span class="p">(</span><span class="n">var_rows</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">claimed_total</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">var_rows</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">])</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">])</span>
        <span class="n">step</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">])</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">sizes</span><span class="p">))</span> <span class="k">if</span> <span class="n">sizes</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">claimed_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">claimed_total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">claimed_total</span> <span class="o">!=</span> <span class="n">total</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Computed grid size is </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> but you entered </span><span class="si">{</span><span class="n">claimed_total</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">total</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">total</span>


<span class="c1"># =========================</span>
<span class="c1"># Helpers: space, CSV, IO</span>
<span class="c1"># =========================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_grid_dataframe</span><span class="p">(</span><span class="n">var_rows</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">grids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">col_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">var_rows</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">])</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">])</span>
        <span class="n">step</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">])</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">step</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;var_</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">col_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">grids</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="n">all_points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">grids</span><span class="p">))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_points</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">col_names</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="k">def</span><span class="w"> </span><span class="nf">add_objective_columns</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">obj_rows</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">obj_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">obj_rows</span><span class="p">:</span>
        <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;obj_</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">obj_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">if</span> <span class="s2">&quot;iteration&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">obj_cols</span>

<span class="k">def</span><span class="w"> </span><span class="nf">save_experiment_csv</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;experiment_</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2">.csv&quot;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filename</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_uploaded_csv</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">detect_columns</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="n">var_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;var_&quot;</span><span class="p">)]</span>
    <span class="n">obj_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;obj_&quot;</span><span class="p">)]</span>
    <span class="n">it_col</span> <span class="o">=</span> <span class="s2">&quot;iteration&quot;</span> <span class="k">if</span> <span class="s2">&quot;iteration&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">var_cols</span><span class="p">,</span> <span class="n">obj_cols</span><span class="p">,</span> <span class="n">it_col</span>


<span class="c1"># =========================</span>
<span class="c1"># Bayesian Suggestion (GP + EI)</span>
<span class="c1"># =========================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fit_gp_ei_scorer</span><span class="p">(</span><span class="n">X_obs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_obs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="c1"># Kernel: C * Matern + White</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">))</span> <span class="o">*</span> <span class="n">Matern</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">X_obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">length_scale_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">),</span> <span class="n">nu</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span> <span class="o">+</span> <span class="n">WhiteKernel</span><span class="p">(</span><span class="n">noise_level</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">noise_level_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">,</span> <span class="mf">1e-1</span><span class="p">))</span>
    <span class="n">gp</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">n_restarts_optimizer</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">normalize_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_obs</span><span class="p">,</span> <span class="n">y_obs</span><span class="p">)</span>

    <span class="n">best_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_obs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ei</span><span class="p">(</span><span class="n">X_cand</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_cand</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">best_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>
        <span class="n">ei_vals</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">best_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span> <span class="o">+</span> <span class="n">std</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
        <span class="n">ei_vals</span><span class="p">[</span><span class="n">std</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">ei_vals</span>

    <span class="k">return</span> <span class="n">ei</span>

<span class="k">def</span><span class="w"> </span><span class="nf">suggest_next</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                 <span class="n">var_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                 <span class="n">obj_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                 <span class="n">n_suggest</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">random_seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
    <span class="c1"># Completed rows have all obj columns filled</span>
    <span class="n">completed_mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">obj_cols</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">untested_mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># If no completed data, pick random untested</span>
    <span class="k">if</span> <span class="n">completed_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cand_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">untested_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cand_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">pick</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">cand_idx</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">n_suggest</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cand_idx</span><span class="p">)),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pick</span><span class="p">]</span>

    <span class="c1"># Weighted sum objective (objectives assumed normalized 0..1)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">completed_mask</span><span class="p">,</span> <span class="n">obj_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">y_obs</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X_obs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">completed_mask</span><span class="p">,</span> <span class="n">var_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Candidates are untested rows</span>
    <span class="n">X_cand_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">untested_mask</span><span class="p">,</span> <span class="n">var_cols</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">X_cand_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># Fit GP and rank by EI</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">scorer</span> <span class="o">=</span> <span class="n">fit_gp_ei_scorer</span><span class="p">(</span><span class="n">X_obs</span><span class="p">,</span> <span class="n">y_obs</span><span class="p">)</span>
        <span class="n">ei_vals</span> <span class="o">=</span> <span class="n">scorer</span><span class="p">(</span><span class="n">X_cand_df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">ei_vals</span><span class="p">)</span>
        <span class="n">top_idx</span> <span class="o">=</span> <span class="n">X_cand_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">order</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="n">n_suggest</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">))]]</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">top_idx</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># Fallback to random if GP fails</span>
        <span class="n">cand_idx</span> <span class="o">=</span> <span class="n">X_cand_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="n">rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">cand_idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cand_idx</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="n">n_suggest</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cand_idx</span><span class="p">))]]</span>


<span class="c1"># =========================</span>
<span class="c1"># UI components</span>
<span class="c1"># =========================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ChemBOUI</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_box</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">VBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_start_screen</span><span class="p">()</span>
        <span class="n">display</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_box</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_start_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;h2&gt;Multi-objective Bayesian Optimization&lt;/h2&gt;&quot;</span><span class="p">)</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;Choose a mode to begin&quot;</span><span class="p">)</span>
        <span class="n">new_btn</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Establish New Experiment&quot;</span><span class="p">,</span> <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;primary&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;plus&quot;</span><span class="p">)</span>
        <span class="n">exist_btn</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Start from Existing Experiment&quot;</span><span class="p">,</span> <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;upload&quot;</span><span class="p">)</span>

        <span class="n">new_btn</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_experiment_flow</span><span class="p">())</span>
        <span class="n">exist_btn</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_existing_experiment_flow</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_menu</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">VBox</span><span class="p">([</span><span class="n">title</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">new_btn</span><span class="p">,</span> <span class="n">exist_btn</span><span class="p">])])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_menu</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">widget</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_back_to_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_menu</span><span class="p">)</span>

    <span class="c1"># ---------- New experiment workflow ----------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_new_experiment_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Step containers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_rows_ui</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># each: dict of widgets for a variable row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj_rows_ui</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># each: dict of widgets for an objective row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">existing_entries</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># manual data entry rows</span>

        <span class="c1"># Step 2.1 Variables</span>
        <span class="n">hdr1</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;h3&gt;Step 1 of 4: Define variables&lt;/h3&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_box</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">VBox</span><span class="p">([])</span>
        <span class="n">add_var_btn</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;+ Add another variable&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;plus&quot;</span><span class="p">)</span>
        <span class="n">add_var_btn</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_variable_row</span><span class="p">())</span>

        <span class="c1"># Add initial variable row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_variable_row</span><span class="p">()</span>

        <span class="c1"># Step 2.2 Objectives</span>
        <span class="n">hdr2</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;h3&gt;Step 2 of 4: Define objectives&lt;/h3&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj_box</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">VBox</span><span class="p">([])</span>
        <span class="n">add_obj_btn</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;+ Add objective&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;plus&quot;</span><span class="p">)</span>
        <span class="n">add_obj_btn</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_objective_row</span><span class="p">())</span>
        <span class="c1"># Add first objective row by default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_objective_row</span><span class="p">()</span>

        <span class="c1"># Step 2.3 Space and experiment setup</span>
        <span class="n">hdr3</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;h3&gt;Step 3 of 4: Space and experiment setup&lt;/h3&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_points_in</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">BoundedIntText</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Total grid points (check)&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;360px&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_in</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">BoundedIntText</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Experiments per batch&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;360px&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_existing_radio</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">RadioButtons</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;No&quot;</span><span class="p">,</span> <span class="s2">&quot;Yes&quot;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Existing data available?&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_in</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">BoundedIntText</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Random seed (optional)&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;360px&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename_in</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="s2">&quot;experiment_&lt;timestamp&gt;.csv&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;CSV name&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;420px&quot;</span><span class="p">))</span>

        <span class="c1"># Step 2.4 Existing data entry or upload</span>
        <span class="n">hdr4</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;h3&gt;Step 4 of 4: Existing data (optional)&lt;/h3&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upload_widget</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">FileUpload</span><span class="p">(</span><span class="n">accept</span><span class="o">=</span><span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manual_add_button</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;+ Add one completed row manually&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;edit&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manual_rows_box</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">VBox</span><span class="p">([])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_existing_radio</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_toggle_existing_data_ui</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manual_add_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_manual_completed_row</span><span class="p">)</span>

        <span class="c1"># Progress and actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">IntProgress</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_btn</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Generate CSV and suggestions&quot;</span><span class="p">,</span> <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;cogs&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_btn</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_finalize_new_experiment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">back_btn</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Back to main menu&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">back_btn</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_back_to_menu</span><span class="p">)</span>

        <span class="n">container</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">VBox</span><span class="p">([</span>
            <span class="n">hdr1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_box</span><span class="p">,</span> <span class="n">add_var_btn</span><span class="p">,</span>
            <span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;hr&gt;&quot;</span><span class="p">),</span>
            <span class="n">hdr2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_box</span><span class="p">,</span> <span class="n">add_obj_btn</span><span class="p">,</span>
            <span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;hr&gt;&quot;</span><span class="p">),</span>
            <span class="n">hdr3</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">total_points_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_in</span><span class="p">]),</span> <span class="n">w</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">use_existing_radio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed_in</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename_in</span><span class="p">,</span>
            <span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;hr&gt;&quot;</span><span class="p">),</span>
            <span class="n">hdr4</span><span class="p">,</span>
            <span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;Upload a CSV that matches the variable and objective columns OR add one or more completed rows manually&quot;</span><span class="p">),</span>
            <span class="n">w</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">w</span><span class="o">.</span><span class="n">VBox</span><span class="p">([</span><span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;b&gt;Upload CSV&lt;/b&gt;&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_widget</span><span class="p">]),</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">VBox</span><span class="p">([</span><span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;b&gt;Manual entry&lt;/b&gt;&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">manual_add_button</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">manual_rows_box</span><span class="p">])]</span> <span class="p">),</span>
            <span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;hr&gt;&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
            <span class="n">w</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">next_btn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">back_btn</span><span class="p">])</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_content</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toggle_existing_data_ui</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_variable_row</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">placeholder</span><span class="o">=</span><span class="s2">&quot;e.g., temperature&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;280px&quot;</span><span class="p">))</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">FloatText</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Start&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;200px&quot;</span><span class="p">))</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">FloatText</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;End&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;200px&quot;</span><span class="p">))</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">FloatText</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Interval&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;200px&quot;</span><span class="p">))</span>
        <span class="n">rm</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Remove&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;trash&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;120px&quot;</span><span class="p">))</span>
        <span class="n">row_widgets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">rm</span><span class="o">=</span><span class="n">rm</span><span class="p">)</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">rm</span><span class="p">])</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_rm</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var_rows_ui</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">row_widgets</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;rm&quot;</span><span class="p">]])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_rows_ui</span><span class="p">]</span>

        <span class="n">rm</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">_rm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_rows_ui</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_widgets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;rm&quot;</span><span class="p">]])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_rows_ui</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_objective_row</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">placeholder</span><span class="o">=</span><span class="s2">&quot;e.g., yield&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;280px&quot;</span><span class="p">))</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">FloatText</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Weight&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;200px&quot;</span><span class="p">))</span>
        <span class="n">rm</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Remove&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;trash&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;120px&quot;</span><span class="p">))</span>

        <span class="n">row_widgets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">rm</span><span class="o">=</span><span class="n">rm</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_rows_ui</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">weight</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># first objective default if only one</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">rm</span><span class="p">])</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_rm</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj_rows_ui</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">row_widgets</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;rm&quot;</span><span class="p">]])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_rows_ui</span><span class="p">]</span>

        <span class="n">rm</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">_rm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj_rows_ui</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_widgets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;rm&quot;</span><span class="p">]])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_rows_ui</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_toggle_existing_data_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
        <span class="n">use_existing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_existing_radio</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;Yes&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upload_widget</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">use_existing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manual_add_button</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">use_existing</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">manual_rows_box</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="s2">&quot;flex&quot;</span> <span class="k">if</span> <span class="n">use_existing</span> <span class="k">else</span> <span class="s2">&quot;none&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_manual_completed_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_rows_ui</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_rows_ui</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&lt;span style=&#39;color:red&#39;&gt;Add variables and objectives first&lt;/span&gt;&quot;</span>
            <span class="k">return</span>
        <span class="c1"># Build inputs based on current names</span>
        <span class="n">var_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;var_</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_rows_ui</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="n">obj_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;obj_</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_rows_ui</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

        <span class="n">row_widgets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">row_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vn</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">:</span>
            <span class="n">row_widgets</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">FloatText</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">vn</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;220px&quot;</span><span class="p">))</span>
            <span class="n">row_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_widgets</span><span class="p">[</span><span class="n">vn</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">on</span> <span class="ow">in</span> <span class="n">obj_names</span><span class="p">:</span>
            <span class="n">row_widgets</span><span class="p">[</span><span class="n">on</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">BoundedFloatText</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">on</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;240px&quot;</span><span class="p">))</span>
            <span class="n">row_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_widgets</span><span class="p">[</span><span class="n">on</span><span class="p">])</span>
        <span class="n">rm</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Remove row&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;trash&quot;</span><span class="p">)</span>
        <span class="n">row_widgets</span><span class="p">[</span><span class="s2">&quot;rm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rm</span>
        <span class="n">row_box</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">HBox</span><span class="p">(</span><span class="n">row_items</span> <span class="o">+</span> <span class="p">[</span><span class="n">rm</span><span class="p">])</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_rm</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">existing_entries</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">row_widgets</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manual_rows_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_manual_row_to_box</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">existing_entries</span><span class="p">]</span>

        <span class="n">rm</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">_rm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">existing_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_widgets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manual_rows_box</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_manual_row_to_box</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">existing_entries</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_manual_row_to_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row_widgets</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">w</span><span class="o">.</span><span class="n">Widget</span><span class="p">:</span>
        <span class="n">row_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">row_widgets</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">row_widgets</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;rm&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">w</span><span class="o">.</span><span class="n">HBox</span><span class="p">(</span><span class="n">row_items</span> <span class="o">+</span> <span class="p">[</span><span class="n">row_widgets</span><span class="p">[</span><span class="s2">&quot;rm&quot;</span><span class="p">]])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_collect_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_rows_ui</span><span class="p">:</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rows</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_collect_objs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_rows_ui</span><span class="p">:</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rows</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_finalize_new_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">var_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_vars</span><span class="p">()</span>
        <span class="n">ok</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">validate_variables</span><span class="p">(</span><span class="n">var_rows</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;span style=&#39;color:red&#39;&gt;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&lt;/span&gt;&quot;</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">obj_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_objs</span><span class="p">()</span>
        <span class="n">ok</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">validate_objectives</span><span class="p">(</span><span class="n">obj_rows</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;span style=&#39;color:red&#39;&gt;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&lt;/span&gt;&quot;</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="c1"># Grid and size check</span>
        <span class="n">grid_df</span> <span class="o">=</span> <span class="n">make_grid_dataframe</span><span class="p">(</span><span class="n">var_rows</span><span class="p">)</span>
        <span class="n">claimed_total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_points_in</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_points_in</span><span class="o">.</span><span class="n">value</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">ok</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="n">validate_grid_size</span><span class="p">(</span><span class="n">var_rows</span><span class="p">,</span> <span class="n">claimed_total</span> <span class="k">if</span> <span class="n">claimed_total</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;span style=&#39;color:orange&#39;&gt;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">. You can correct the input or leave Total grid points at 0 to accept </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">&lt;/span&gt;&quot;</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">claimed_total</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_points_in</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">total</span>

        <span class="c1"># Add objectives and iteration</span>
        <span class="n">obj_cols</span> <span class="o">=</span> <span class="n">add_objective_columns</span><span class="p">(</span><span class="n">grid_df</span><span class="p">,</span> <span class="n">obj_rows</span><span class="p">)</span>
        <span class="n">var_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;var_&quot;</span><span class="p">)]</span>
        <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">n_batch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_in</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed_in</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed_in</span><span class="o">.</span><span class="n">value</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># Load existing completed data if provided</span>
        <span class="n">completed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_existing_radio</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;Yes&quot;</span><span class="p">:</span>
            <span class="c1"># Uploaded CSV</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upload_widget</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
                <span class="n">up</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upload_widget</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df_up</span> <span class="o">=</span> <span class="n">parse_uploaded_csv</span><span class="p">(</span><span class="n">up</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">])</span>
                    <span class="n">up_var_cols</span><span class="p">,</span> <span class="n">up_obj_cols</span><span class="p">,</span> <span class="n">it_col</span> <span class="o">=</span> <span class="n">detect_columns</span><span class="p">(</span><span class="n">df_up</span><span class="p">)</span>
                    <span class="c1"># Basic column presence check</span>
                    <span class="n">missing_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">var_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_up</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                    <span class="n">missing_objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">obj_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_up</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">missing_vars</span> <span class="ow">or</span> <span class="n">missing_objs</span> <span class="ow">or</span> <span class="n">it_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&lt;span style=&#39;color:red&#39;&gt;Uploaded CSV must include matching var_*, obj_* columns and an iteration column&lt;/span&gt;&quot;</span>
                        <span class="k">return</span>
                    <span class="n">completed_rows</span> <span class="o">=</span> <span class="n">df_up</span><span class="p">[</span><span class="n">up_obj_cols</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">completed_df</span> <span class="o">=</span> <span class="n">df_up</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">completed_rows</span><span class="p">,</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df_up</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;span style=&#39;color:red&#39;&gt;Failed to parse uploaded CSV: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&lt;/span&gt;&quot;</span>
                    <span class="k">return</span>

            <span class="c1"># Manual rows</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">existing_entries</span><span class="p">:</span>
                <span class="n">rec</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
                <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;rm&quot;</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">rec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&lt;span style=&#39;color:red&#39;&gt;Manual row values must be numeric&lt;/span&gt;&quot;</span>
                    <span class="k">return</span>
                <span class="n">completed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">completed_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">rec</span><span class="p">])],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Merge completed into grid_df where coordinates match</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">completed_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># Key on all var columns</span>
                <span class="n">grid_df</span> <span class="o">=</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                    <span class="n">completed_df</span><span class="p">[</span><span class="n">var_cols</span> <span class="o">+</span> <span class="n">obj_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]],</span>
                    <span class="n">on</span><span class="o">=</span><span class="n">var_cols</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;_comp&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">oc</span> <span class="ow">in</span> <span class="n">obj_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]:</span>
                    <span class="n">c_new</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">oc</span><span class="si">}</span><span class="s2">_comp&quot;</span>
                    <span class="k">if</span> <span class="n">c_new</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">grid_df</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">grid_df</span><span class="p">[</span><span class="n">c_new</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span> <span class="n">grid_df</span><span class="p">[</span><span class="n">c_new</span><span class="p">],</span> <span class="n">grid_df</span><span class="p">[</span><span class="n">oc</span><span class="p">])</span>
                        <span class="n">grid_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">c_new</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="c1"># Suggest first batch</span>
        <span class="c1"># Mark suggested rows with iteration = 1 if none completed, else keep completed ones at their iteration and suggest next</span>
        <span class="n">has_completed</span> <span class="o">=</span> <span class="n">grid_df</span><span class="p">[</span><span class="n">obj_cols</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="n">current_iter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">has_completed</span><span class="p">:</span>
            <span class="c1"># set current_iter as 1 + max completed iteration found in data, else 1</span>
            <span class="k">if</span> <span class="s2">&quot;iteration&quot;</span> <span class="ow">in</span> <span class="n">grid_df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">current_iter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">grid_df</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_iter</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="c1"># Prepare weights from objs</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span>

        <span class="n">suggestions</span> <span class="o">=</span> <span class="n">suggest_next</span><span class="p">(</span><span class="n">grid_df</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">var_cols</span><span class="p">,</span> <span class="n">obj_cols</span><span class="p">,</span> <span class="n">n_batch</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">suggestions</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&lt;span style=&#39;color:orange&#39;&gt;No available untested rows to suggest&lt;/span&gt;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Mark iteration for suggested rows</span>
            <span class="n">sug_idx</span> <span class="o">=</span> <span class="n">suggestions</span><span class="o">.</span><span class="n">index</span>
            <span class="n">grid_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sug_idx</span><span class="p">,</span> <span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_iter</span>
            <span class="c1"># Suggested experiments have blank objectives</span>
            <span class="k">for</span> <span class="n">oc</span> <span class="ow">in</span> <span class="n">obj_cols</span><span class="p">:</span>
                <span class="n">grid_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sug_idx</span><span class="p">,</span> <span class="n">oc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Save CSV</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">save_experiment_csv</span><span class="p">(</span><span class="n">grid_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename_in</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="c1"># Show summary</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">suggestions</span><span class="p">[</span><span class="n">var_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">top</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_iter</span>
        <span class="n">html</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;b&gt;Algorithm&lt;/b&gt;: Gaussian Process with Expected Improvement&lt;br&gt;&quot;</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;b&gt;Suggested experiments (n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">top</span><span class="p">)</span><span class="si">}</span><span class="s2">)&lt;/b&gt;:&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">html</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV saved: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">done</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;span style=&#39;color:green&#39;&gt;Success. You can run experiments, fill objective values, then use Start from Existing Experiment to continue&lt;/span&gt;&quot;</span><span class="p">)</span>
        <span class="n">menu_btn</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Return to main menu&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>
        <span class="n">menu_btn</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_back_to_menu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_content</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">VBox</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">main_menu</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_menu</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">menu_btn</span><span class="p">])]))</span>

    <span class="c1"># ---------- Existing experiment workflow ----------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_existing_experiment_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;h3&gt;Continue from an existing CSV&lt;/h3&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex_upload</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">FileUpload</span><span class="p">(</span><span class="n">accept</span><span class="o">=</span><span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">override_n</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">BoundedIntText</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Next batch size (0 = use previous)&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;320px&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed2</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">BoundedIntText</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Random seed (optional)&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;320px&quot;</span><span class="p">))</span>
        <span class="n">go</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Generate next suggestions&quot;</span><span class="p">,</span> <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;cogs&quot;</span><span class="p">)</span>
        <span class="n">back</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Back to main menu&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status2</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress2</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">IntProgress</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">go</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_continue_from_csv</span><span class="p">)</span>
        <span class="n">back</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_back_to_menu</span><span class="p">)</span>

        <span class="n">box</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">VBox</span><span class="p">([</span><span class="n">title</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex_upload</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">override_n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed2</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status2</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">go</span><span class="p">,</span> <span class="n">back</span><span class="p">])])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_content</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_continue_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_upload</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&lt;span style=&#39;color:red&#39;&gt;Upload a CSV first&lt;/span&gt;&quot;</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">up</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ex_upload</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">parse_uploaded_csv</span><span class="p">(</span><span class="n">up</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;span style=&#39;color:red&#39;&gt;Failed to read CSV: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&lt;/span&gt;&quot;</span>
            <span class="k">return</span>

        <span class="n">var_cols</span><span class="p">,</span> <span class="n">obj_cols</span><span class="p">,</span> <span class="n">it_col</span> <span class="o">=</span> <span class="n">detect_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">it_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&lt;span style=&#39;color:red&#39;&gt;CSV must contain an iteration column&lt;/span&gt;&quot;</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj_cols</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&lt;span style=&#39;color:red&#39;&gt;CSV must contain at least one obj_* column&lt;/span&gt;&quot;</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">progress2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Determine latest completed iteration</span>
        <span class="c1"># Completed means all obj columns filled for that row</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;__completed__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">obj_cols</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;__completed__&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">last_completed_iter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;__completed__&quot;</span><span class="p">],</span> <span class="s2">&quot;iteration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_completed_iter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Warn if latest iteration rows are missing objective values</span>
        <span class="n">max_iter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">latest_rows</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_iter</span>
        <span class="n">latest_have_obj</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">latest_rows</span><span class="p">,</span> <span class="n">obj_cols</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">latest_have_obj</span> <span class="ow">and</span> <span class="n">max_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&lt;span style=&#39;color:orange&#39;&gt;Some rows in the latest iteration are missing objective values. Fill them before continuing for best results&lt;/span&gt;&quot;</span>

        <span class="c1"># Batch size detection</span>
        <span class="n">prev_batch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_iter</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="k">if</span> <span class="n">max_iter</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">3</span>
        <span class="n">n_batch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">override_n</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">override_n</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">prev_batch</span>

        <span class="c1"># Weights resolution</span>
        <span class="c1"># If only one objective, weight = 1.0. Else attempt to infer from a stored comment is out of scope.</span>
        <span class="n">wts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj_cols</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Ask user to input weights interactively would complicate this step.</span>
            <span class="c1"># As a practical path, normalize the column-wise max to estimate relative importance if objectives look scaled.</span>
            <span class="c1"># But the spec assumes normalized 0..1, so default equal weights unless user specified otherwise earlier.</span>
            <span class="n">wts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj_cols</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_cols</span><span class="p">)</span>

        <span class="c1"># Suggest next</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed2</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed2</span><span class="o">.</span><span class="n">value</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="n">suggest_next</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">var_cols</span><span class="p">,</span> <span class="n">obj_cols</span><span class="p">,</span> <span class="n">n_batch</span><span class="p">,</span> <span class="n">wts</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">progress2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="n">suggestions</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&lt;span style=&#39;color:orange&#39;&gt;No untested rows remain for suggestion&lt;/span&gt;&quot;</span>
            <span class="k">return</span>

        <span class="n">new_iter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_iter</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">max_iter</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">sug_idx</span> <span class="o">=</span> <span class="n">suggestions</span><span class="o">.</span><span class="n">index</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sug_idx</span><span class="p">,</span> <span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_iter</span>
        <span class="k">for</span> <span class="n">oc</span> <span class="ow">in</span> <span class="n">obj_cols</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sug_idx</span><span class="p">,</span> <span class="n">oc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Save in place with a timestamped backup</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">up</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">root</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="n">out_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">_updated_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;__completed__&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">progress2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="n">html</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;b&gt;Suggested next iteration&lt;/b&gt;: </span><span class="si">{</span><span class="n">new_iter</span><span class="si">}</span><span class="s2">&lt;br&gt;&quot;</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;b&gt;Algorithm&lt;/b&gt;: Gaussian Process with Expected Improvement&lt;br&gt;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">html</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="n">suggestions</span><span class="p">[</span><span class="n">var_cols</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV saved: </span><span class="si">{</span><span class="n">out_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">back</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Return to main menu&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>
        <span class="n">back</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_back_to_menu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_content</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">VBox</span><span class="p">([</span><span class="n">w</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;h3&gt;Next suggestions&lt;/h3&gt;&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status2</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">back</span><span class="p">]))</span>


<span class="c1"># Launch UI</span>
<span class="n">ChemBOUI</span><span class="p">()</span>


<span class="c1"># =========================</span>
<span class="c1"># Optional extensions</span>
<span class="c1"># =========================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_scatter_2d</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color_by</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="c1">#Quick 2D scatter with optional color. Works in Colab output cells.</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
    <span class="n">xvals</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">yvals</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">color_by</span> <span class="ow">and</span> <span class="n">color_by</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">color_by</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">color_by</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;2D scatter&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">export_to_excel</span><span class="p">(</span><span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">xlsx_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xlsx_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">root</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
        <span class="n">xlsx_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">.xlsx&quot;</span>
    <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="n">xlsx_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s2">&quot;experiment&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xlsx_path</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "4971220edc7b4300ad257ec66cc5b500"}</script></div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="lecture-14.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Lecture 14 - Bayesian Optimization for Synthesis Conditions</p>
      </div>
    </a>
    <a class="right-next"
       href="lecture-16.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Lecture 16 - Reinforcement Learning</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">0. Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-multiobjective-optimization">1. What is multiobjective optimization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-mof-toy-dataset">2. Load the MOF toy dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-engineering-for-multiobjective-modeling">3. Feature engineering for multiobjective modeling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#minimal-numeric-features">3.1 Minimal numeric features</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#one-hot-encoding-for-smiles">3.2 One-hot encoding for SMILES</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#targets-for-multiobjective-learning">3.3 Targets for multiobjective learning</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pareto-utilities-and-hypervolume-in-2d">4. Pareto utilities and hypervolume in 2D</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#scalarization-and-surrogate-models-for-each-objective">5. Scalarization and surrogate models for each objective</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#train-test-split-and-scaling">5.1 Train test split and scaling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#three-gps-with-matern-on-the-50-point-split">5.2 Three GPs with Matern on the 50 point split</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rf-trio-trained-only-on-the-50-point-split">5.3 RF trio trained only on the 50 point split</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#acquisition-for-multiobjective-bo">6. Acquisition for multiobjective BO</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#end-to-end-mobo-loop-on-the-mof-dataset">7. End to end MOBO loop on the MOF dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">8. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-class-activity">9. In-class activity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q1-build-a-tiny-bo-coach-with-an-llm">Q1. Build a tiny BO “coach” with an LLM</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>