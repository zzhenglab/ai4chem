
<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lecture 11 - Dimension Reduction for Data Visualization &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css?v=6ad1a40c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js?v=2b91c5f0"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js?v=afe5de03"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lecture-11';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Lecture 12 - Self-Supervised Learning" href="lecture-12.html" />
    <link rel="prev" title="Lecture 10 - Property &amp; Reaction Prediction" href="lecture-10.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to CHEM 5080: AI for Experimental Chemistry
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="lecture-01.html">Lecture 1 - Python Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-02.html">Lecture 2 - Pandas and Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-03.html">Lecture 3 - SMILES and RDKit</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-04.html">Lecture 4 - Chemical Structure Identifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-05.html">Lecture 5 - Regression and Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-06.html">Lecture 6 - Cross-Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-07.html">Lecture 7 - Decision Trees and Random Forests</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-08.html">Lecture 8 - Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-09.html">Lecture 9 - Graph Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-10.html">Lecture 10 - Property &amp; Reaction Prediction</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Lecture 11 - Dimension Reduction for Data Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-12.html">Lecture 12 - Self-Supervised Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-13.html">Lecture 13 - De Novo Molecule Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-14.html">Lecture 14 - Bayesian Optimization for Synthesis Conditions</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-15.html">Lecture 15 - Multi-objective Bayesian Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-16.html">Lecture 16 - Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-17.html">Lecture 17 - PU Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-18.html">Lecture 18 - Contrastive Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-19.html">Lecture 19 - Transformers</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-20.html">Lecture 20 - Large Language Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-21.html">Lecture 21 - Computer Vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-22.html">Lecture 22 - Vision Languge Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture-23.html">Lecture 23 - Prompt Engineering and Function Calling</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Flecture-11.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/lecture-11.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lecture 11 - Dimension Reduction for Data Visualization</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-and-data">1. Setup and data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#supervised-vs-unsupervised">2. Supervised vs unsupervised</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#principal-component-analysis-pca">2.1 Principal Component Analysis (PCA)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-leakage-in-unsupervised-settings">2.2 Data leakage in unsupervised settings</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#standardization-and-distance">3. Standardization and distance</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-standardize">3.1 Why standardize</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#which-distance-to-use">3.2 Which distance to use</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nonlinear-embeddings-t-sne-and-umap">4. Nonlinear embeddings: t-SNE and UMAP</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#t-sne">4.1 t-SNE</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#umap">4.2 UMAP</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">5. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-class-activity">6. In-class activity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q1-build-feature-sets-and-print-compact-summaries"><strong>Q1. Build feature sets and print compact summaries</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q2-pca-on-10-descriptors"><strong>Q2. PCA on 10 descriptors</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q3-t-sne-on-10-descriptors"><strong>Q3. t-SNE on 10 descriptors</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q4-pca-and-t-sne-on-morgan-64-fingerprints"><strong>Q4. PCA and t-SNE on Morgan-64 fingerprints</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q5-nearest-5-neighbors-descriptors-vs-fingerprints"><strong>Q5. Nearest 5 neighbors - descriptors vs fingerprints</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solution">7. Solution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q1">Q1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q2">Q2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q3">Q3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q4">Q4</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q5">Q5</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lecture-11-dimension-reduction-for-data-visualization">
<h1>Lecture 11 - Dimension Reduction for Data Visualization<a class="headerlink" href="#lecture-11-dimension-reduction-for-data-visualization" title="Permalink to this heading">#</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#learning-goals" id="id1">Learning goals</a></p></li>
<li><p><a class="reference internal" href="#setup-and-data" id="id2">1. Setup and data</a></p></li>
<li><p><a class="reference internal" href="#supervised-vs-unsupervised" id="id3">2. Supervised vs unsupervised</a></p></li>
<li><p><a class="reference internal" href="#standardization-and-distance" id="id4">3. Standardization and distance</a></p></li>
<li><p><a class="reference internal" href="#nonlinear-embeddings-t-sne-and-umap" id="id5">4. Nonlinear embeddings: t-SNE and UMAP</a></p></li>
<li><p><a class="reference internal" href="#glossary" id="id6">5. Glossary</a></p></li>
<li><p><a class="reference internal" href="#in-class-activity" id="id7">6. In-class activity</a></p></li>
<li><p><a class="reference internal" href="#solution" id="id8">7. Solution</a></p></li>
</ul>
</nav>
<section id="learning-goals">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Learning goals</a><a class="headerlink" href="#learning-goals" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Understand <strong>unsupervised learning</strong> vs <strong>supervised learning</strong> in chemistry.</p></li>
<li><p>Explain the intuition and math of <strong>PCA</strong> and read <strong>loadings</strong>, <strong>scores</strong>, and <strong>explained variance</strong>.</p></li>
<li><p>Use <strong>t-SNE</strong> and <strong>UMAP</strong> to embed high dimensional chemical features to 2D for visualization.</p></li>
</ul>
<p><a class="reference external" href="https://colab.research.google.com/drive/15nKl8LM8bkO7e4o4JjQ-hLQHxpW37kVh?usp=sharing"><img alt="Colab" src="https://img.shields.io/badge/Open-Colab-orange" /></a></p>
</section>
<section id="setup-and-data">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">1. Setup and data</a><a class="headerlink" href="#setup-and-data" title="Permalink to this heading">#</a></h2>
<p>We will reuse the C-H oxidation dataset and compute a small set of descriptors.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Core</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># ML</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.manifold</span><span class="w"> </span><span class="kn">import</span> <span class="n">TSNE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.cluster</span><span class="w"> </span><span class="kn">import</span> <span class="n">KMeans</span><span class="p">,</span> <span class="n">AgglomerativeClustering</span><span class="p">,</span> <span class="n">DBSCAN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">silhouette_score</span><span class="p">,</span> <span class="n">silhouette_samples</span><span class="p">,</span> <span class="n">pairwise_distances</span>

<span class="k">try</span><span class="p">:</span>
  <span class="kn">import</span><span class="w"> </span><span class="nn">umap.umap_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">umap</span>
  <span class="kn">from</span><span class="w"> </span><span class="nn">umap.umap_</span><span class="w"> </span><span class="kn">import</span> <span class="n">UMAP</span>
<span class="k">except</span><span class="p">:</span>
  <span class="o">%</span><span class="k">pip</span> install umap-learn
  <span class="kn">import</span><span class="w"> </span><span class="nn">umap.umap_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">umap</span>
  <span class="kn">from</span><span class="w"> </span><span class="nn">umap.umap_</span><span class="w"> </span><span class="kn">import</span> <span class="n">UMAP</span>

<span class="c1"># Utils</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">Descriptors</span><span class="p">,</span> <span class="n">Crippen</span><span class="p">,</span> <span class="n">rdMolDescriptors</span>
    <span class="n">RD</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="o">%</span><span class="k">pip</span> install rdkit
      <span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span>
      <span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">Descriptors</span><span class="p">,</span> <span class="n">Crippen</span><span class="p">,</span> <span class="n">rdMolDescriptors</span>
      <span class="n">RD</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="n">RD</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">Chem</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/zzhenglab/ai4chem/main/book/_data/C_H_oxidation_dataset.csv&quot;</span>
<span class="n">df_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">df_raw</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Compound Name</th>
      <th>CAS</th>
      <th>SMILES</th>
      <th>Solubility_mol_per_L</th>
      <th>pKa</th>
      <th>Toxicity</th>
      <th>Melting Point</th>
      <th>Reactivity</th>
      <th>Oxidation Site</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3,4-dihydro-1H-isochromene</td>
      <td>493-05-0</td>
      <td>c1ccc2c(c1)CCOC2</td>
      <td>0.103906</td>
      <td>5.80</td>
      <td>non_toxic</td>
      <td>65.8</td>
      <td>1</td>
      <td>8,10</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9H-fluorene</td>
      <td>86-73-7</td>
      <td>c1ccc2c(c1)Cc1ccccc1-2</td>
      <td>0.010460</td>
      <td>5.82</td>
      <td>toxic</td>
      <td>90.0</td>
      <td>1</td>
      <td>7</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1,2,3,4-tetrahydronaphthalene</td>
      <td>119-64-2</td>
      <td>c1ccc2c(c1)CCCC2</td>
      <td>0.020589</td>
      <td>5.74</td>
      <td>toxic</td>
      <td>69.4</td>
      <td>1</td>
      <td>7,10</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We compute four quick 4 descriptors for everyone. Different from we we did previously, we only have another function compute 10 descriptors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Original function (4 descriptors)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calc_descriptors</span><span class="p">(</span><span class="n">smiles</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">smiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="s2">&quot;MolWt&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;LogP&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;TPSA&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;NumRings&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">})</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="s2">&quot;MolWt&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;LogP&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;TPSA&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;NumRings&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span>
        <span class="s2">&quot;MolWt&quot;</span><span class="p">:</span> <span class="n">Descriptors</span><span class="o">.</span><span class="n">MolWt</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
        <span class="s2">&quot;LogP&quot;</span><span class="p">:</span> <span class="n">Crippen</span><span class="o">.</span><span class="n">MolLogP</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
        <span class="s2">&quot;TPSA&quot;</span><span class="p">:</span> <span class="n">rdMolDescriptors</span><span class="o">.</span><span class="n">CalcTPSA</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
        <span class="s2">&quot;NumRings&quot;</span><span class="p">:</span> <span class="n">rdMolDescriptors</span><span class="o">.</span><span class="n">CalcNumRings</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
    <span class="p">})</span>


<span class="c1"># New function (10 descriptors)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calc_descriptors10</span><span class="p">(</span><span class="n">smiles</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span>
        <span class="s2">&quot;MolWt&quot;</span><span class="p">:</span> <span class="n">Descriptors</span><span class="o">.</span><span class="n">MolWt</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
        <span class="s2">&quot;LogP&quot;</span><span class="p">:</span> <span class="n">Crippen</span><span class="o">.</span><span class="n">MolLogP</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
        <span class="s2">&quot;TPSA&quot;</span><span class="p">:</span> <span class="n">rdMolDescriptors</span><span class="o">.</span><span class="n">CalcTPSA</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
        <span class="s2">&quot;NumRings&quot;</span><span class="p">:</span> <span class="n">rdMolDescriptors</span><span class="o">.</span><span class="n">CalcNumRings</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
        <span class="s2">&quot;NumHAcceptors&quot;</span><span class="p">:</span> <span class="n">rdMolDescriptors</span><span class="o">.</span><span class="n">CalcNumHBA</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
        <span class="s2">&quot;NumHDonors&quot;</span><span class="p">:</span> <span class="n">rdMolDescriptors</span><span class="o">.</span><span class="n">CalcNumHBD</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
        <span class="s2">&quot;NumRotatableBonds&quot;</span><span class="p">:</span> <span class="n">rdMolDescriptors</span><span class="o">.</span><span class="n">CalcNumRotatableBonds</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
        <span class="s2">&quot;HeavyAtomCount&quot;</span><span class="p">:</span> <span class="n">Descriptors</span><span class="o">.</span><span class="n">HeavyAtomCount</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>   <span class="c1"># &lt;-- fixed</span>
        <span class="s2">&quot;FractionCSP3&quot;</span><span class="p">:</span> <span class="n">rdMolDescriptors</span><span class="o">.</span><span class="n">CalcFractionCSP3</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
        <span class="s2">&quot;NumAromaticRings&quot;</span><span class="p">:</span> <span class="n">rdMolDescriptors</span><span class="o">.</span><span class="n">CalcNumAromaticRings</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="p">})</span>

<span class="c1"># Example usage (choose which function you want to apply)</span>
<span class="n">desc4</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">calc_descriptors</span><span class="p">)</span>      <span class="c1"># 4 descriptors</span>
<span class="n">desc10</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">calc_descriptors10</span><span class="p">)</span>   <span class="c1"># 10 descriptors</span>

<span class="n">df4</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_raw</span><span class="p">,</span> <span class="n">desc4</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df10</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_raw</span><span class="p">,</span> <span class="n">desc10</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rows x Cols (4 desc):&quot;</span><span class="p">,</span> <span class="n">df4</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rows x Cols (10 desc):&quot;</span><span class="p">,</span> <span class="n">df10</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">df4</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Rows x Cols (4 desc): (575, 13)
Rows x Cols (10 desc): (575, 19)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Compound Name</th>
      <th>CAS</th>
      <th>SMILES</th>
      <th>Solubility_mol_per_L</th>
      <th>pKa</th>
      <th>Toxicity</th>
      <th>Melting Point</th>
      <th>Reactivity</th>
      <th>Oxidation Site</th>
      <th>MolWt</th>
      <th>LogP</th>
      <th>TPSA</th>
      <th>NumRings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3,4-dihydro-1H-isochromene</td>
      <td>493-05-0</td>
      <td>c1ccc2c(c1)CCOC2</td>
      <td>0.103906</td>
      <td>5.80</td>
      <td>non_toxic</td>
      <td>65.8</td>
      <td>1</td>
      <td>8,10</td>
      <td>134.178</td>
      <td>1.7593</td>
      <td>9.23</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9H-fluorene</td>
      <td>86-73-7</td>
      <td>c1ccc2c(c1)Cc1ccccc1-2</td>
      <td>0.010460</td>
      <td>5.82</td>
      <td>toxic</td>
      <td>90.0</td>
      <td>1</td>
      <td>7</td>
      <td>166.223</td>
      <td>3.2578</td>
      <td>0.00</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1,2,3,4-tetrahydronaphthalene</td>
      <td>119-64-2</td>
      <td>c1ccc2c(c1)CCCC2</td>
      <td>0.020589</td>
      <td>5.74</td>
      <td>toxic</td>
      <td>69.4</td>
      <td>1</td>
      <td>7,10</td>
      <td>132.206</td>
      <td>2.5654</td>
      <td>0.00</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ethylbenzene</td>
      <td>100-41-4</td>
      <td>CCc1ccccc1</td>
      <td>0.048107</td>
      <td>5.87</td>
      <td>non_toxic</td>
      <td>65.0</td>
      <td>1</td>
      <td>1,2</td>
      <td>106.168</td>
      <td>2.2490</td>
      <td>0.00</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cyclohexene</td>
      <td>110-83-8</td>
      <td>C1=CCCCC1</td>
      <td>0.060688</td>
      <td>5.66</td>
      <td>non_toxic</td>
      <td>96.4</td>
      <td>1</td>
      <td>3,6</td>
      <td>82.146</td>
      <td>2.1166</td>
      <td>0.00</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df10</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Compound Name</th>
      <th>CAS</th>
      <th>SMILES</th>
      <th>Solubility_mol_per_L</th>
      <th>pKa</th>
      <th>Toxicity</th>
      <th>Melting Point</th>
      <th>Reactivity</th>
      <th>Oxidation Site</th>
      <th>MolWt</th>
      <th>LogP</th>
      <th>TPSA</th>
      <th>NumRings</th>
      <th>NumHAcceptors</th>
      <th>NumHDonors</th>
      <th>NumRotatableBonds</th>
      <th>HeavyAtomCount</th>
      <th>FractionCSP3</th>
      <th>NumAromaticRings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3,4-dihydro-1H-isochromene</td>
      <td>493-05-0</td>
      <td>c1ccc2c(c1)CCOC2</td>
      <td>0.103906</td>
      <td>5.80</td>
      <td>non_toxic</td>
      <td>65.8</td>
      <td>1</td>
      <td>8,10</td>
      <td>134.178</td>
      <td>1.7593</td>
      <td>9.23</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>10.0</td>
      <td>0.333333</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9H-fluorene</td>
      <td>86-73-7</td>
      <td>c1ccc2c(c1)Cc1ccccc1-2</td>
      <td>0.010460</td>
      <td>5.82</td>
      <td>toxic</td>
      <td>90.0</td>
      <td>1</td>
      <td>7</td>
      <td>166.223</td>
      <td>3.2578</td>
      <td>0.00</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>13.0</td>
      <td>0.076923</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1,2,3,4-tetrahydronaphthalene</td>
      <td>119-64-2</td>
      <td>c1ccc2c(c1)CCCC2</td>
      <td>0.020589</td>
      <td>5.74</td>
      <td>toxic</td>
      <td>69.4</td>
      <td>1</td>
      <td>7,10</td>
      <td>132.206</td>
      <td>2.5654</td>
      <td>0.00</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>10.0</td>
      <td>0.400000</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ethylbenzene</td>
      <td>100-41-4</td>
      <td>CCc1ccccc1</td>
      <td>0.048107</td>
      <td>5.87</td>
      <td>non_toxic</td>
      <td>65.0</td>
      <td>1</td>
      <td>1,2</td>
      <td>106.168</td>
      <td>2.2490</td>
      <td>0.00</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>8.0</td>
      <td>0.250000</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cyclohexene</td>
      <td>110-83-8</td>
      <td>C1=CCCCC1</td>
      <td>0.060688</td>
      <td>5.66</td>
      <td>non_toxic</td>
      <td>96.4</td>
      <td>1</td>
      <td>3,6</td>
      <td>82.146</td>
      <td>2.1166</td>
      <td>0.00</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>6.0</td>
      <td>0.666667</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Now we build a 64-bit Morgan fingerprint (<span class="math notranslate nohighlight">\(r=2\)</span>). We keep both a <strong>small descriptor table</strong> and a <strong>high dimensional fingerprint</strong> table.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">rdFingerprintGenerator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataStructs</span>

<span class="c1"># --- Morgan fingerprint function (compact string) ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">morgan_bits</span><span class="p">(</span><span class="n">smiles</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n_bits</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span> <span class="n">radius</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">smiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">gen</span> <span class="o">=</span> <span class="n">rdFingerprintGenerator</span><span class="o">.</span><span class="n">GetMorganGenerator</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">fpSize</span><span class="o">=</span><span class="n">n_bits</span><span class="p">)</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">GetFingerprint</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_bits</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">DataStructs</span><span class="o">.</span><span class="n">ConvertToNumpyArray</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>

    <span class="c1"># join into one string of &quot;0101...&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">arr</span><span class="p">))</span>

<span class="c1">#1024bit</span>
<span class="n">df_morgan_1024</span> <span class="o">=</span> <span class="n">df_raw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_morgan_1024</span><span class="p">[</span><span class="s2">&quot;Fingerprint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_morgan_1024</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">morgan_bits</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n_bits</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

<span class="c1">#64 bit</span>
<span class="n">df_morgan</span> <span class="o">=</span> <span class="n">df_raw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_morgan</span><span class="p">[</span><span class="s2">&quot;Fingerprint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_morgan</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">morgan_bits</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n_bits</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rows x Cols:&quot;</span><span class="p">,</span> <span class="n">df_morgan</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_morgan</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Rows x Cols: (575, 10)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Compound Name</th>
      <th>CAS</th>
      <th>SMILES</th>
      <th>Solubility_mol_per_L</th>
      <th>pKa</th>
      <th>Toxicity</th>
      <th>Melting Point</th>
      <th>Reactivity</th>
      <th>Oxidation Site</th>
      <th>Fingerprint</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3,4-dihydro-1H-isochromene</td>
      <td>493-05-0</td>
      <td>c1ccc2c(c1)CCOC2</td>
      <td>0.103906</td>
      <td>5.80</td>
      <td>non_toxic</td>
      <td>65.8</td>
      <td>1</td>
      <td>8,10</td>
      <td>1000000010111000110010100000001001001000000010...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9H-fluorene</td>
      <td>86-73-7</td>
      <td>c1ccc2c(c1)Cc1ccccc1-2</td>
      <td>0.010460</td>
      <td>5.82</td>
      <td>toxic</td>
      <td>90.0</td>
      <td>1</td>
      <td>7</td>
      <td>1100000000000010010010101000101010001000000010...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1,2,3,4-tetrahydronaphthalene</td>
      <td>119-64-2</td>
      <td>c1ccc2c(c1)CCCC2</td>
      <td>0.020589</td>
      <td>5.74</td>
      <td>toxic</td>
      <td>69.4</td>
      <td>1</td>
      <td>7,10</td>
      <td>1000100000100000010010100000001000001000000010...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ethylbenzene</td>
      <td>100-41-4</td>
      <td>CCc1ccccc1</td>
      <td>0.048107</td>
      <td>5.87</td>
      <td>non_toxic</td>
      <td>65.0</td>
      <td>1</td>
      <td>1,2</td>
      <td>1000010100000001110000100010000001001010001000...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cyclohexene</td>
      <td>110-83-8</td>
      <td>C1=CCCCC1</td>
      <td>0.060688</td>
      <td>5.66</td>
      <td>non_toxic</td>
      <td>96.4</td>
      <td>1</td>
      <td>3,6</td>
      <td>0000101000000000010000000000001000000001100000...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="admonition-data-choices admonition">
<p class="admonition-title">Data choices</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>X_small</strong> uses 4 descriptors. Good for first PCA stories.</p></li>
<li><p><strong>X_fp</strong> has 64 bits. Good for t-SNE or UMAP since it is very high dimensional.</p></li>
</ul>
</div></blockquote>
</div>
<p>Now, lets compare their 4D, 10D descriptors with 64D fingerprints.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">Draw</span>

<span class="c1"># pick indices you want</span>
<span class="n">sample_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>

<span class="c1"># make sure you have all descriptor sets ready</span>
<span class="n">desc4</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">calc_descriptors</span><span class="p">)</span>
<span class="n">desc10</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">calc_descriptors10</span><span class="p">)</span>
<span class="n">df_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_raw</span><span class="p">,</span> <span class="n">desc4</span><span class="p">,</span> <span class="n">desc10</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;d10_&quot;</span><span class="p">),</span> <span class="n">df_morgan</span><span class="p">[</span><span class="s2">&quot;Fingerprint&quot;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># loop through chosen indices</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sample_indices</span><span class="p">:</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">])</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">Draw</span><span class="o">.</span><span class="n">MolToImage</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="n">legend</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Compound Name&quot;</span><span class="p">])</span>
    <span class="n">display</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Compound Name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SMILES:&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">])</span>

    <span class="c1"># 4-descriptor set</span>
    <span class="n">d4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;LogP&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;TPSA&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;NumRings&quot;</span><span class="p">]],</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Descriptors [MolWt, LogP, TPSA, NumRings]:&quot;</span><span class="p">,</span> <span class="n">d4</span><span class="p">)</span>

    <span class="c1"># 10-descriptor set</span>
    <span class="n">d10_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span><span class="s2">&quot;LogP&quot;</span><span class="p">,</span><span class="s2">&quot;TPSA&quot;</span><span class="p">,</span><span class="s2">&quot;NumRings&quot;</span><span class="p">,</span><span class="s2">&quot;NumHAcceptors&quot;</span><span class="p">,</span><span class="s2">&quot;NumHDonors&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NumRotatableBonds&quot;</span><span class="p">,</span><span class="s2">&quot;HeavyAtomCount&quot;</span><span class="p">,</span><span class="s2">&quot;FractionCSP3&quot;</span><span class="p">,</span><span class="s2">&quot;NumAromaticRings&quot;</span><span class="p">]</span>
    <span class="n">d10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;d10_&quot;</span><span class="o">+</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d10_keys</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;10-Descriptor Vector:&quot;</span><span class="p">,</span> <span class="n">d10</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fingerprint:&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Fingerprint&quot;</span><span class="p">][:</span><span class="mi">32</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/760dcf9794540efd72f90319c4122a60df78bf053e07e241bc6b6777d2f1f3e0.png" src="_images/760dcf9794540efd72f90319c4122a60df78bf053e07e241bc6b6777d2f1f3e0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== 9H-fluorene ===
SMILES: c1ccc2c(c1)Cc1ccccc1-2
Descriptors [MolWt, LogP, TPSA, NumRings]: [166.22   3.26   0.     3.  ]
10-Descriptor Vector: [1.6622e+02 3.2600e+00 0.0000e+00 3.0000e+00 0.0000e+00 0.0000e+00
 0.0000e+00 1.3000e+01 8.0000e-02 2.0000e+00]
Fingerprint: 11000000000000100100101010001010
</pre></div>
</div>
<img alt="_images/f3f8944f421eb1729e5555fd4b4c20c30d71702da731d3836a52d75e1433998b.png" src="_images/f3f8944f421eb1729e5555fd4b4c20c30d71702da731d3836a52d75e1433998b.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== thiolane ===
SMILES: C1CCSC1
Descriptors [MolWt, LogP, TPSA, NumRings]: [88.18  1.51  0.    1.  ]
10-Descriptor Vector: [88.18  1.51  0.    1.    1.    0.    0.    5.    1.    0.  ]
Fingerprint: 00001100000000010000010000000010
</pre></div>
</div>
<img alt="_images/7849d306ab4eb79df56edcbf11d2a3574fc05b0ea1d62088fae6876b50bccf8b.png" src="_images/7849d306ab4eb79df56edcbf11d2a3574fc05b0ea1d62088fae6876b50bccf8b.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== methoxymethylbenzene ===
SMILES: COCc1ccccc1
Descriptors [MolWt, LogP, TPSA, NumRings]: [122.17   1.83   9.23   1.  ]
10-Descriptor Vector: [122.17   1.83   9.23   1.     1.     0.     2.     9.     0.25   1.  ]
Fingerprint: 10000100010000001100001000100000
</pre></div>
</div>
<img alt="_images/9df9aa4433eaa344446429d5f65310b9b0745455a8664068aef6dbd2bc1ad8e0.png" src="_images/9df9aa4433eaa344446429d5f65310b9b0745455a8664068aef6dbd2bc1ad8e0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== oct-1-ene ===
SMILES: C=CCCCCCC
Descriptors [MolWt, LogP, TPSA, NumRings]: [112.22   3.14   0.     0.  ]
10-Descriptor Vector: [112.22   3.14   0.     0.     0.     0.     5.     8.     0.75   0.  ]
Fingerprint: 00000000000000011100001000100001
</pre></div>
</div>
<img alt="_images/6bef7bfd49dce8cac1023f03cc87fb37b0f643ce08dbacaed9360ccaf234db0a.png" src="_images/6bef7bfd49dce8cac1023f03cc87fb37b0f643ce08dbacaed9360ccaf234db0a.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== N,N-diethylacetamide ===
SMILES: CCN(CC)C(C)=O
Descriptors [MolWt, LogP, TPSA, NumRings]: [115.18   0.87  20.31   0.  ]
10-Descriptor Vector: [115.18   0.87  20.31   0.     1.     0.     2.     8.     0.83   0.  ]
Fingerprint: 00000000001000001010000000000100
</pre></div>
</div>
<img alt="_images/6ed476e36afd7db09150b19562b125442591abc157693a699a9c8155689091e3.png" src="_images/6ed476e36afd7db09150b19562b125442591abc157693a699a9c8155689091e3.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== cyclohexane ===
SMILES: C1CCCCC1
Descriptors [MolWt, LogP, TPSA, NumRings]: [84.16  2.34  0.    1.  ]
10-Descriptor Vector: [84.16  2.34  0.    1.    0.    0.    0.    6.    1.    0.  ]
Fingerprint: 00101000000000000000000000000010
</pre></div>
</div>
<img alt="_images/ae2e9a2ae742a429f69c6c56b78f99d5c06a5bb1108181c874240c9e29690655.png" src="_images/ae2e9a2ae742a429f69c6c56b78f99d5c06a5bb1108181c874240c9e29690655.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== 1,4-xylene ===
SMILES: Cc1ccc(C)cc1
Descriptors [MolWt, LogP, TPSA, NumRings]: [106.17   2.3    0.     1.  ]
10-Descriptor Vector: [106.17   2.3    0.     1.     0.     0.     0.     8.     0.25   1.  ]
Fingerprint: 10000000000000000100001000000001
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>The 4-descriptor table is easy to standardize and to interpret.</p></li>
<li><p>The 1024-bit fingerprint captures substructure presence or absence and is useful for neighborhood maps.</p></li>
</ul>
<p>With 4-desciptor, its easier to visualize:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.mplot3d</span><span class="w"> </span><span class="kn">import</span> <span class="n">Axes3D</span>

<span class="c1"># pick specific indices</span>
<span class="n">df_sel</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sample_indices</span><span class="p">]</span>   <span class="c1"># df_all includes your descriptors</span>

<span class="c1"># --- 3D scatter plot ---</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>

<span class="n">sc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">df_sel</span><span class="p">[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">],</span> <span class="n">df_sel</span><span class="p">[</span><span class="s2">&quot;LogP&quot;</span><span class="p">],</span> <span class="n">df_sel</span><span class="p">[</span><span class="s2">&quot;TPSA&quot;</span><span class="p">],</span>
    <span class="n">c</span><span class="o">=</span><span class="n">df_sel</span><span class="p">[</span><span class="s2">&quot;NumRings&quot;</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span>
<span class="p">)</span>

<span class="c1"># add labels to points</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_sel</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span> <span class="p">,</span>   <span class="c1"># shift value so no overlap</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;LogP&quot;</span><span class="p">]</span><span class="o">-</span><span class="mf">0.21</span><span class="p">,</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;TPSA&quot;</span><span class="p">]</span><span class="o">+</span><span class="mf">4.5</span><span class="p">,</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Compound Name&quot;</span><span class="p">],</span>
        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>   <span class="c1"># align text to the right</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span>
    <span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;MolWt&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;LogP&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;TPSA&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;NumRings&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;3D Descriptor Visualization (Selected Compounds)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/9bc82e5aea10d257270ddd7c9f0465dd0597c9902388e24040316bfcbcb1df8c.png" src="_images/9bc82e5aea10d257270ddd7c9f0465dd0597c9902388e24040316bfcbcb1df8c.png" />
</div>
</div>
<p>Now we can apply this to the entire C-H oxidation dataset.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>

<span class="n">sc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">df4</span><span class="p">[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">],</span>
    <span class="n">df4</span><span class="p">[</span><span class="s2">&quot;LogP&quot;</span><span class="p">],</span>
    <span class="n">df4</span><span class="p">[</span><span class="s2">&quot;TPSA&quot;</span><span class="p">],</span>
    <span class="n">c</span><span class="o">=</span><span class="n">df4</span><span class="p">[</span><span class="s2">&quot;NumRings&quot;</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span>
<span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;MolWt&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;LogP&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;TPSA&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;NumRings&quot;</span><span class="p">)</span>  <span class="c1"># 4th dimension</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;4D Descriptor Visualization (MolWt, LogP, TPSA, NumRings)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/ca3ed7b3831a96d657027981d193e4bbfc9e8068a2fcf71c925cd409ce5bea21.png" src="_images/ca3ed7b3831a96d657027981d193e4bbfc9e8068a2fcf71c925cd409ce5bea21.png" />
</div>
</div>
<p>And depending which three descriptors you used for XYZ, you can have different plottings.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.mplot3d</span><span class="w"> </span><span class="kn">import</span> <span class="n">Axes3D</span>

<span class="c1"># All 4 descriptors</span>
<span class="n">descs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span> <span class="s2">&quot;LogP&quot;</span><span class="p">,</span> <span class="s2">&quot;TPSA&quot;</span><span class="p">,</span> <span class="s2">&quot;NumRings&quot;</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">color_dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">descs</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="c1"># the other three go on axes</span>
    <span class="n">axes_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">descs</span> <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="n">color_dim</span><span class="p">]</span>
    <span class="n">xcol</span><span class="p">,</span> <span class="n">ycol</span><span class="p">,</span> <span class="n">zcol</span> <span class="o">=</span> <span class="n">axes_dims</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>

    <span class="n">sc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">df4</span><span class="p">[</span><span class="n">xcol</span><span class="p">],</span> <span class="n">df4</span><span class="p">[</span><span class="n">ycol</span><span class="p">],</span> <span class="n">df4</span><span class="p">[</span><span class="n">zcol</span><span class="p">],</span>
        <span class="n">c</span><span class="o">=</span><span class="n">df4</span><span class="p">[</span><span class="n">color_dim</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;cividis&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xcol</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ycol</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="n">zcol</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Color = </span><span class="si">{</span><span class="n">color_dim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># horizontal colorbar under each subplot</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">color_dim</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;4D Descriptor Visualization (All Permutations)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/4684c48eaa56de385445b010f6de8b734f25e2b2eb0070d09e4d7a89ce64b311.png" src="_images/4684c48eaa56de385445b010f6de8b734f25e2b2eb0070d09e4d7a89ce64b311.png" />
</div>
</div>
<p>But when it comes to 10-dimensional descriptors or even something like a 1024-dimensional Morgan fingerprint, it is nearly impossible to directly visualize them. It becomes even harder to know the neigbors to a specific molecule.</p>
<p>Humans can only intuitively grasp two or three axes at once. Once you go beyond that, you can only look at pairs of dimensions at a time, and the relationships quickly become hard to characterize.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="nb">vars</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span><span class="s2">&quot;LogP&quot;</span><span class="p">,</span><span class="s2">&quot;TPSA&quot;</span><span class="p">,</span><span class="s2">&quot;NumRings&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NumHAcceptors&quot;</span><span class="p">,</span><span class="s2">&quot;NumHDonors&quot;</span><span class="p">,</span><span class="s2">&quot;NumRotatableBonds&quot;</span><span class="p">,</span>
        <span class="s2">&quot;HeavyAtomCount&quot;</span><span class="p">,</span><span class="s2">&quot;FractionCSP3&quot;</span><span class="p">,</span><span class="s2">&quot;NumAromaticRings&quot;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">vars</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">vars</span><span class="p">):</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">df10</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">v</span><span class="p">,</span>   <span class="c1"># fix one descriptor on x-axis (e.g., MolWt)</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/533d59f0d7df11527c083f3195fc2a28d738e222ac1deb3fed0734a8333fa7a6.png" src="_images/533d59f0d7df11527c083f3195fc2a28d738e222ac1deb3fed0734a8333fa7a6.png" />
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># expand &quot;0101...&quot; strings into arrays of integers</span>
<span class="n">fp_matrix</span> <span class="o">=</span> <span class="n">df_morgan</span><span class="p">[</span><span class="s2">&quot;Fingerprint&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">fp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fp_matrix</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_morgan</span><span class="p">[</span><span class="s2">&quot;Compound Name&quot;</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">fp_df</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Morgan Fingerprint&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Bit Index&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Molecule&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/7f7a3bfd1a7b473db4969a85fdefafe22ca09b492234698ca97def44e8f3ffc9.png" src="_images/7f7a3bfd1a7b473db4969a85fdefafe22ca09b492234698ca97def44e8f3ffc9.png" />
</div>
</div>
<p>Thats why cheminformatics usually applies <strong>dimension reduction</strong> methods (PCA, t-SNE, UMAP) to compress high-dimensional data into a visualizable 2D or 3D form. We will get to these points today!</p>
</section>
<hr class="docutils" />
<section id="supervised-vs-unsupervised">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">2. Supervised vs unsupervised</a><a class="headerlink" href="#supervised-vs-unsupervised" title="Permalink to this heading">#</a></h2>
<p>In Lectures 6 to 8 we learned supervised models that map <span class="math notranslate nohighlight">\(x \to y\)</span> with labeled targets. Today we switch to <strong>unsupervised learning</strong>.</p>
<ul class="simple">
<li><p><strong>Dimension reduction</strong>: summarize high dimensional <span class="math notranslate nohighlight">\(x \in \mathbb{R}^p\)</span> to a few coordinates <span class="math notranslate nohighlight">\(z \in \mathbb{R}^k\)</span> with <span class="math notranslate nohighlight">\(k \ll p\)</span>. You do not use <span class="math notranslate nohighlight">\(y\)</span> during the fit.</p></li>
<li><p><strong>Clustering</strong>: group samples into clusters based on a similarity or distance rule. Again no labels during the fit.</p></li>
</ul>
<p>We will color plots using toxicity when available. That is only to <strong>interpret</strong> the embedding or clusters. It is not used in the algorithms.</p>
<div class="admonition-exercise-2 admonition">
<p class="admonition-title"> Exercise 2</p>
<p>State whether each task is supervised or unsupervised:</p>
<ul class="simple">
<li><p>Predict melting point from descriptors.</p></li>
<li><p>Group molecules by scaffold similarity.</p></li>
<li><p>Map 1024-bit fingerprints to 2D for plotting.</p></li>
<li><p>Predict toxicity from descriptors.</p></li>
</ul>
</div>
<section id="principal-component-analysis-pca">
<h3>2.1 Principal Component Analysis (PCA)<a class="headerlink" href="#principal-component-analysis-pca" title="Permalink to this heading">#</a></h3>
<p>Feature choices will drive everything downstream. You can use:</p>
<ul class="simple">
<li><p>Scalar descriptors like MolWt, LogP, TPSA, ring counts.</p></li>
<li><p>Fingerprints like Morgan bits or MACCS keys.</p></li>
<li><p>Learned embeddings from a graph neural network. We will not use those here, but the same methods apply.</p></li>
</ul>
<p>If two students use different features, their dimension reduction plots will look different. That is expected.</p>
<blockquote>
<div><p>So, how do we start with dimension reduction?
Lets first try <strong>Principal Component Analysis (PCA)</strong>
In the previous section, when we move from <strong>4 descriptors</strong> (MolWt, LogP, TPSA, NumRings) to <strong>10 descriptors</strong> or even <strong>64-bit Morgan fingerprints</strong>, direct visualization becomes impossible. You can only plot a few dimensions at a time, and the relationships across all features become hard to interpret.</p>
</div></blockquote>
<p>PCA addresses this challenge by finding <strong>new axes (principal components)</strong> that summarize the directions of greatest variance in the data. These axes are:</p>
<ul class="simple">
<li><p><strong>Orthogonal</strong> (uncorrelated).</p></li>
<li><p><strong>Ranked by importance</strong> (PC1 explains the most variance, PC2 the second most, and so on).</p></li>
<li><p><strong>Linear combinations</strong> of the original features.</p></li>
</ul>
<p>Thus, PCA compresses high-dimensional molecular representations into just <strong>2 or 3 coordinates</strong> that can be plotted.</p>
<p>Below is the mathematical pieces:</p>
<ol class="arabic simple">
<li><p>Start with standardized data <span class="math notranslate nohighlight">\(\tilde X\)</span> (mean 0, variance 1 across features).</p></li>
<li><p>Compute the covariance matrix:
<span class="math notranslate nohighlight">\(
S = \frac{1}{n-1}\tilde X^\top \tilde X
\)</span></p></li>
<li><p>Either:</p>
<ul class="simple">
<li><p>Eigen-decompose <span class="math notranslate nohighlight">\(S\)</span>  eigenvectors are principal directions.</p></li>
<li><p>Or compute SVD:
<span class="math notranslate nohighlight">\(
\tilde X = U \Sigma V^\top
\)</span></p></li>
</ul>
</li>
<li><p>The top <span class="math notranslate nohighlight">\(k\)</span> eigenvectors (or columns of <span class="math notranslate nohighlight">\(V\)</span>) form the principal directions.</p></li>
<li><p>The new coordinates are:
<span class="math notranslate nohighlight">\(
Z = \tilde X V_k
\)</span>
where <span class="math notranslate nohighlight">\(Z\)</span> are the principal component scores.</p></li>
</ol>
<hr class="docutils" />
<p>What this means for our chemistry dataset (<code class="docutils literal notranslate"><span class="pre">df10</span></code>)</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">df10</span></code> contains <strong>10 molecular descriptors</strong> for each compound:</p>
<ul>
<li><p>MolWt, LogP, TPSA, NumRings,</p></li>
<li><p>NumHAcceptors, NumHDonors,</p></li>
<li><p>NumRotatableBonds, HeavyAtomCount,</p></li>
<li><p>FractionCSP3, NumAromaticRings.</p></li>
</ul>
</li>
<li><p>These form a data matrix <span class="math notranslate nohighlight">\(X\)</span> of shape <strong>(n molecules  10 features)</strong>.</p></li>
<li><p>PCA standardizes each column (feature) so they are comparable on the same scale.<br />
For example, MolWt ranges in the hundreds, but FractionCSP3 is between 0 and 1. Standardization makes both contribute fairly.</p></li>
<li><p>Then PCA computes <strong>principal directions</strong> as linear combinations of these 10 descriptors.</p></li>
<li><p>The result is a new score matrix <span class="math notranslate nohighlight">\(Z\)</span> of shape <strong>(n molecules  k components)</strong>, usually with <span class="math notranslate nohighlight">\(k=2\)</span> or <span class="math notranslate nohighlight">\(3\)</span> for visualization.<br />
This means each molecule is now represented by just 23 numbers (PC1, PC2, PC3) instead of 10 descriptors.</p></li>
<li><p>The same approach works for fingerprints: instead of 10 columns, you may have 64, 1024, or 2048. PCA reduces that down to 23 interpretable axes.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.mplot3d</span><span class="w"> </span><span class="kn">import</span> <span class="n">Axes3D</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># ---- prepare matrices ----</span>
<span class="n">X_desc</span> <span class="o">=</span> <span class="n">df10</span><span class="p">[[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span><span class="s2">&quot;LogP&quot;</span><span class="p">,</span><span class="s2">&quot;TPSA&quot;</span><span class="p">,</span><span class="s2">&quot;NumRings&quot;</span><span class="p">,</span>
               <span class="s2">&quot;NumHAcceptors&quot;</span><span class="p">,</span><span class="s2">&quot;NumHDonors&quot;</span><span class="p">,</span><span class="s2">&quot;NumRotatableBonds&quot;</span><span class="p">,</span>
               <span class="s2">&quot;HeavyAtomCount&quot;</span><span class="p">,</span><span class="s2">&quot;FractionCSP3&quot;</span><span class="p">,</span><span class="s2">&quot;NumAromaticRings&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

<span class="n">X_morgan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">int</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">]</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">df_morgan</span><span class="p">[</span><span class="s2">&quot;Fingerprint&quot;</span><span class="p">]])</span>  <span class="c1"># 64 bits</span>

<span class="c1"># ---- standardize ----</span>
<span class="n">X_desc_std</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_desc</span><span class="p">)</span>
<span class="n">X_morgan_std</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_morgan</span><span class="p">)</span>

<span class="c1"># ---- PCA fit ----</span>
<span class="n">pca_desc</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_desc_std</span><span class="p">)</span>
<span class="n">pca_morgan</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_morgan_std</span><span class="p">)</span>

<span class="c1"># ---- scree plots ----</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">pca_desc</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">[:</span><span class="mi">10</span><span class="p">]),</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Explained Variance (10D descriptors)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Number of PCs&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative variance&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">pca_morgan</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">[:</span><span class="mi">20</span><span class="p">]),</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Explained Variance (64D Morgan)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Number of PCs&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative variance&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># ---- 2D PCA projections ----</span>
<span class="n">desc_2d</span> <span class="o">=</span> <span class="n">pca_desc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_desc_std</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">morgan_2d</span> <span class="o">=</span> <span class="n">pca_morgan</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_morgan_std</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">desc_2d</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">desc_2d</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;PCA 2D projection (10 descriptors)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;PC1&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;PC2&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">morgan_2d</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">morgan_2d</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;PCA 2D projection (64-bit Morgan)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;PC1&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;PC2&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># ---- 3D PCA projections ----</span>
<span class="n">desc_3d</span> <span class="o">=</span> <span class="n">pca_desc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_desc_std</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
<span class="n">morgan_3d</span> <span class="o">=</span> <span class="n">pca_morgan</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_morgan_std</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">desc_3d</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">desc_3d</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">desc_3d</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;PCA 3D projection (10 descriptors)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;PC1&quot;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;PC2&quot;</span><span class="p">);</span> <span class="n">ax1</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;PC3&quot;</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">morgan_3d</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">morgan_3d</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">morgan_3d</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;PCA 3D projection (64-bit Morgan)&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;PC1&quot;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;PC2&quot;</span><span class="p">);</span> <span class="n">ax2</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;PC3&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7f018fcf7b2739de2fd118eefeb5abf3ff33cc8396f8a697fad57c0a2dc507ce.png" src="_images/7f018fcf7b2739de2fd118eefeb5abf3ff33cc8396f8a697fad57c0a2dc507ce.png" />
<img alt="_images/3f1af266c91c6db598e7ff449e0c653984ec7d84618a87f5e8954b33f9f1a0a8.png" src="_images/3f1af266c91c6db598e7ff449e0c653984ec7d84618a87f5e8954b33f9f1a0a8.png" />
<img alt="_images/d9c7eb037f49dec18b85499ad956c6d1f2b60946b4a8b0efb0edafc21097ced7.png" src="_images/d9c7eb037f49dec18b85499ad956c6d1f2b60946b4a8b0efb0edafc21097ced7.png" />
</div>
</div>
<p>Now you can see, the 10D vector is converted to 2D or 3D vector, which become much easier to plot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">desc_2d</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[-1.85863457, -0.10406515],
       [-0.8662983 , -1.26269482],
       [-2.08798314, -0.77811   ],
       ...,
       [ 0.08373577, -0.58690452],
       [ 3.19411974, -0.85437761],
       [ 2.00081897, -0.04085639]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">desc_3d</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[-1.85863457, -0.10406515, -0.76130014],
       [-0.8662983 , -1.26269482, -1.55622595],
       [-2.08798314, -0.77811   , -0.75279025],
       ...,
       [ 0.08373577, -0.58690452,  0.27978755],
       [ 3.19411974, -0.85437761,  0.07107396],
       [ 2.00081897, -0.04085639,  0.17583671]])
</pre></div>
</div>
</div>
</div>
<p>In essence, PCA gives us coordinates for each molecule in a reduced 2D space.<br />
To make this more concrete, we can select specific molecules and compare them:</p>
<ul class="simple">
<li><p>A <strong>manual pair</strong> that we choose (indices 0 and 5).</p></li>
<li><p>The <strong>closest pair</strong> in PCA space (most similar according to the descriptors).</p></li>
<li><p>The <strong>farthest pair</strong> in PCA space (most dissimilar).</p></li>
</ul>
<p>We plot all molecules in grey, highlight the pairs with different colors, and draw a line connecting each pair.<br />
For the selected molecules we also show their <strong>structure, compound name, and PCA coordinates</strong>.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>

<span class="c1"># ---- prepare feature matrix ----</span>
<span class="n">X_desc</span> <span class="o">=</span> <span class="n">df10</span><span class="p">[[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span><span class="s2">&quot;LogP&quot;</span><span class="p">,</span><span class="s2">&quot;TPSA&quot;</span><span class="p">,</span><span class="s2">&quot;NumRings&quot;</span><span class="p">,</span>
               <span class="s2">&quot;NumHAcceptors&quot;</span><span class="p">,</span><span class="s2">&quot;NumHDonors&quot;</span><span class="p">,</span><span class="s2">&quot;NumRotatableBonds&quot;</span><span class="p">,</span>
               <span class="s2">&quot;HeavyAtomCount&quot;</span><span class="p">,</span><span class="s2">&quot;FractionCSP3&quot;</span><span class="p">,</span><span class="s2">&quot;NumAromaticRings&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># ---- standardize and PCA ----</span>
<span class="n">X_desc_std</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_desc</span><span class="p">)</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">X_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_desc_std</span><span class="p">)</span>

<span class="c1"># ---- distance matrix to find closest/farthest ----</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_pca</span><span class="p">)),</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">distances</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">X_pca</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">X_pca</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]</span>
<span class="n">farthest</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">distances</span><span class="p">)]</span>
<span class="n">closest</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">)]</span>

<span class="c1"># ---- chosen pairs ----</span>
<span class="n">manual_pair</span> <span class="o">=</span> <span class="p">(</span><span class="mi">225</span><span class="p">,</span><span class="mi">35</span><span class="p">)</span>
<span class="n">pairs_to_show</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;Manual pair&quot;</span><span class="p">,</span> <span class="n">manual_pair</span><span class="p">),</span>
                 <span class="p">(</span><span class="s2">&quot;Closest pair&quot;</span><span class="p">,</span> <span class="n">closest</span><span class="p">),</span>
                 <span class="p">(</span><span class="s2">&quot;Farthest pair&quot;</span><span class="p">,</span> <span class="n">farthest</span><span class="p">)]</span>

<span class="c1"># ---- scatter plot ----</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_pca</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">X_pca</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">,</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span><span class="s2">&quot;green&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="p">(</span><span class="n">label</span><span class="p">,(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)),</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pairs_to_show</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_pca</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">X_pca</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_pca</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">X_pca</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">X_pca</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">X_pca</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],[</span><span class="n">X_pca</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">X_pca</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;PC1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;PC2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;PCA of 10 Descriptors with Selected Pairs&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># ---- show structures + coordinates ----</span>
<span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pairs_to_show</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> ===&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">df10</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;Compound Name&quot;</span><span class="p">]</span>
        <span class="n">smiles</span> <span class="o">=</span> <span class="n">df10</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Draw</span><span class="o">.</span><span class="n">MolToImage</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">),</span> <span class="n">legend</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (index </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  PC1 = </span><span class="si">{</span><span class="n">X_pca</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, PC2 = </span><span class="si">{</span><span class="n">X_pca</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/53fdf638ef0263ed374502704e6703d6e4318cf05c8f3dbd540ef5968ba74a89.png" src="_images/53fdf638ef0263ed374502704e6703d6e4318cf05c8f3dbd540ef5968ba74a89.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== Manual pair ===
</pre></div>
</div>
<img alt="_images/f73508fc03c390a73977c3bdf913bd66d4c34673cc71fcc16cce1ed8a1158b84.png" src="_images/f73508fc03c390a73977c3bdf913bd66d4c34673cc71fcc16cce1ed8a1158b84.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1-benzyl-2-phenylbenzimidazole   (index 225)
  PC1 = 1.936, PC2 = -2.132
</pre></div>
</div>
<img alt="_images/29dc7153171469a90b903154d7d5c6d5060b52f7a240c23ff8189f913dab93eb.png" src="_images/29dc7153171469a90b903154d7d5c6d5060b52f7a240c23ff8189f913dab93eb.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>methyl (4aS,6aR,6aS,6bR,8aR,10S,12aR,14bS)-10-hydroxy-2,2,6a,6b,9,9,12a-heptamethyl-1,3,4,5,6,6a,7,8,8a,10,11,12,13,14b-tetradecahydropicene-4a-carboxylate (index 35)
  PC1 = 3.267, PC2 = -1.618

=== Closest pair ===
</pre></div>
</div>
<img alt="_images/d3b9d6f29b85581b9389e4f2f9bda00f12a3f0d46f2978d1eab67cfc1ae24a37.png" src="_images/d3b9d6f29b85581b9389e4f2f9bda00f12a3f0d46f2978d1eab67cfc1ae24a37.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1S,5S)-6,6-dimethyl-2-methylidenebicyclo[3.1.1]heptane (index 17)
  PC1 = -2.274, PC2 = -1.042
</pre></div>
</div>
<img alt="_images/fd9cad0598a64dfcf627480ad07e5b52b777c33ee8c6cabfae9753eb73c8721c.png" src="_images/fd9cad0598a64dfcf627480ad07e5b52b777c33ee8c6cabfae9753eb73c8721c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1R,5R)-2,6,6-trimethylbicyclo[3.1.1]hept-2-ene (index 27)
  PC1 = -2.274, PC2 = -1.042

=== Farthest pair ===
</pre></div>
</div>
<img alt="_images/6c234bd0c3e5683dd514b52cea0b53298542e40e393b3dc2ee5e96fa63728645.png" src="_images/6c234bd0c3e5683dd514b52cea0b53298542e40e393b3dc2ee5e96fa63728645.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2-[3,5-bis(1-phenylbenzimidazol-2-yl)phenyl]-1-phenylbenzimidazole (index 338)
  PC1 = 11.072, PC2 = -4.750
</pre></div>
</div>
<img alt="_images/983a10c2bef421600af6296ef6a475e0282a6b915f457849d9ef6614e7e47a03.png" src="_images/983a10c2bef421600af6296ef6a475e0282a6b915f457849d9ef6614e7e47a03.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sodium;perchlorate (index 462)
  PC1 = -2.699, PC2 = 5.531
</pre></div>
</div>
</div>
</div>
<p>We can also make this plot to be interactive:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>

<span class="c1"># ---- prepare feature matrix ----</span>
<span class="n">desc_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span><span class="s2">&quot;LogP&quot;</span><span class="p">,</span><span class="s2">&quot;TPSA&quot;</span><span class="p">,</span><span class="s2">&quot;NumRings&quot;</span><span class="p">,</span>
             <span class="s2">&quot;NumHAcceptors&quot;</span><span class="p">,</span><span class="s2">&quot;NumHDonors&quot;</span><span class="p">,</span><span class="s2">&quot;NumRotatableBonds&quot;</span><span class="p">,</span>
             <span class="s2">&quot;HeavyAtomCount&quot;</span><span class="p">,</span><span class="s2">&quot;FractionCSP3&quot;</span><span class="p">,</span><span class="s2">&quot;NumAromaticRings&quot;</span><span class="p">]</span>

<span class="n">X_desc</span> <span class="o">=</span> <span class="n">df10</span><span class="p">[</span><span class="n">desc_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># ---- standardize and PCA ----</span>
<span class="n">X_desc_std</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_desc</span><span class="p">)</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">X_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_desc_std</span><span class="p">)</span>

<span class="c1"># ---- build dataframe with PCA scores ----</span>
<span class="n">df_pca</span> <span class="o">=</span> <span class="n">df10</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_pca</span><span class="p">[</span><span class="s2">&quot;PC1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_pca</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">df_pca</span><span class="p">[</span><span class="s2">&quot;PC2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_pca</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># ---- scatter plot with matplotlib ----</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">df_pca</span><span class="p">[</span><span class="s2">&quot;PC1&quot;</span><span class="p">],</span>
    <span class="n">df_pca</span><span class="p">[</span><span class="s2">&quot;PC2&quot;</span><span class="p">],</span>
    <span class="n">c</span><span class="o">=</span><span class="n">df_pca</span><span class="p">[</span><span class="s2">&quot;NumRings&quot;</span><span class="p">],</span>  <span class="c1"># color by number of rings</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>                  <span class="c1"># marker size</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span>
<span class="p">)</span>

<span class="c1"># add colorbar</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;NumRings&quot;</span><span class="p">)</span>

<span class="c1"># titles and labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;PCA of 10 Descriptors&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;PC1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;PC2&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/4fc6846963fc543b4e33d421c9b45107fd5bb62b8d48d3f6d284e4b87f5679ab.png" src="_images/4fc6846963fc543b4e33d421c9b45107fd5bb62b8d48d3f6d284e4b87f5679ab.png" />
</div>
</div>
</section>
<section id="data-leakage-in-unsupervised-settings">
<h3>2.2 Data leakage in unsupervised settings<a class="headerlink" href="#data-leakage-in-unsupervised-settings" title="Permalink to this heading">#</a></h3>
<p>Even in unsupervised workflows, leakage can happen.<br />
A common mistake is to <strong>fit the scaler or PCA on the full dataset</strong> before splitting.<br />
This means the test set has already influenced the scaling or component directions, which is a subtle form of information leak.</p>
<p><strong>Safer pattern</strong>:</p>
<ol class="arabic simple">
<li><p>Split the dataset into train and test.</p></li>
<li><p>Fit the scaler only on the training subset.</p></li>
<li><p>Transform both train and test using the fitted scaler.</p></li>
<li><p>Fit PCA (or clustering) on the training data only, then apply the transform to the test set.</p></li>
</ol>
<p>This way the test set truly remains unseen during model fitting.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># ---- features ----</span>
<span class="n">desc_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span><span class="s2">&quot;LogP&quot;</span><span class="p">,</span><span class="s2">&quot;TPSA&quot;</span><span class="p">,</span><span class="s2">&quot;NumRings&quot;</span><span class="p">,</span>
             <span class="s2">&quot;NumHAcceptors&quot;</span><span class="p">,</span><span class="s2">&quot;NumHDonors&quot;</span><span class="p">,</span><span class="s2">&quot;NumRotatableBonds&quot;</span><span class="p">,</span>
             <span class="s2">&quot;HeavyAtomCount&quot;</span><span class="p">,</span><span class="s2">&quot;FractionCSP3&quot;</span><span class="p">,</span><span class="s2">&quot;NumAromaticRings&quot;</span><span class="p">]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df10</span><span class="p">[</span><span class="n">desc_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># ---- split first ----</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># ---- fit scaler on train only ----</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_train_std</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_std</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># ---- fit PCA on train only ----</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_std</span><span class="p">)</span>
<span class="n">X_train_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train_std</span><span class="p">)</span>
<span class="n">X_test_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_std</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train shape:&quot;</span><span class="p">,</span> <span class="n">X_train_pca</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test shape:&quot;</span><span class="p">,</span> <span class="n">X_test_pca</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># ---- visualize ----</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_train_pca</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">X_train_pca</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Train&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_test_pca</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">X_test_pca</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;PC1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;PC2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Leakage-safe PCA (Train vs Test)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train shape: (402, 2)
Test shape: (173, 2)
</pre></div>
</div>
<img alt="_images/70da5fba2380fd3d773e1d7418c801c08d6bbdeded6902a862fb58045938c98c.png" src="_images/70da5fba2380fd3d773e1d7418c801c08d6bbdeded6902a862fb58045938c98c.png" />
</div>
</div>
<p>If the test set overlaps reasonably with the distribution of the train set, thats a sign your train-derived scaling and PCA directions generalize.</p>
<p>If the test points lie far outside, that could mean:</p>
<ul class="simple">
<li><p>Train and test distributions are very different.</p></li>
<li><p>Or PCA didnt capture the structure of test molecules well.
Note:</p></li>
<li><p>In pure visualization use cases, the risk is smaller since we are not optimizing a predictive model.</p></li>
<li><p>For cluster analysis that will be compared to labels afterward, keep the split discipline.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="standardization-and-distance">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">3. Standardization and distance</a><a class="headerlink" href="#standardization-and-distance" title="Permalink to this heading">#</a></h2>
<p>Unsupervised methods depend on a distance or similarity rule. The choice of distance and the way you scale features can completely change neighborhoods, clusters, and embeddings. This section covers why we standardize, which distance to use for scalar descriptors vs fingerprints, and how to compute and visualize distance in a leakage safe way.</p>
<section id="why-standardize">
<h3>3.1 Why standardize<a class="headerlink" href="#why-standardize" title="Permalink to this heading">#</a></h3>
<p>Descriptor columns live on different scales. <code class="docutils literal notranslate"><span class="pre">MolWt</span></code> can be in the hundreds. <code class="docutils literal notranslate"><span class="pre">FractionCSP3</span></code> is in <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">1]</span></code>. If you compute Euclidean distance on the raw matrix, large scale columns dominate. Standardization fixes this by centering and scaling each column so that all features contribute fairly.</p>
<p>Common scalers:</p>
<ul class="simple">
<li><p><strong>StandardScaler</strong>: zero mean, unit variance. Good default.</p></li>
<li><p><strong>MinMaxScaler</strong>: rescales to [0, 1]. Useful when you want bounded ranges.</p></li>
<li><p><strong>RobustScaler</strong>: uses medians and IQR. Useful with outliers.</p></li>
</ul>
<p>Below is an example for <code class="docutils literal notranslate"><span class="pre">StandardScaler()</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="c1"># pick two columns</span>
<span class="n">cols2</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span> <span class="s2">&quot;TPSA&quot;</span><span class="p">]</span>
<span class="n">X2</span> <span class="o">=</span> <span class="n">df10</span><span class="p">[</span><span class="n">cols2</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="c1"># standardize both columns</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X2</span><span class="p">)</span>
<span class="n">X2_std</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X2</span><span class="p">)</span>

<span class="c1"># show means and std before vs after</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Raw means:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">X2</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Raw stds :&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">X2</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Std means:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">X2_std</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Std stds :&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">X2_std</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># quick scatter before vs after</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">X2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;MolWt&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;TPSA&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Raw&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X2_std</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">X2_std</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;MolWt (z)&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;TPSA (z)&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Standardized&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Raw means: [223.213  32.74 ]
Raw stds : [92.66  30.417]
Std means: [ 0. -0.]
Std stds : [1. 1.]
</pre></div>
</div>
<img alt="_images/58918b010fa0c0546fd6784a45ddf8254d3bd3bc19e055c866a1f698d78edcfd.png" src="_images/58918b010fa0c0546fd6784a45ddf8254d3bd3bc19e055c866a1f698d78edcfd.png" />
</div>
</div>
</section>
<section id="which-distance-to-use">
<h3>3.2 Which distance to use<a class="headerlink" href="#which-distance-to-use" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Scalar descriptors</strong> (10D):</p>
<ul>
<li><p><strong>Euclidean</strong> on standardized data is a good default.</p></li>
<li><p><strong>Cosine</strong> focuses on direction rather than magnitude. Try it when overall size varies a lot.</p></li>
</ul>
</li>
<li><p><strong>Fingerprints</strong> (64D or 1024D binary bits):</p>
<ul>
<li><p><strong>Tanimoto similarity</strong> is the chem-informatics standard. Tanimoto distance = 1  Tanimoto similarity.</p></li>
<li><p>You can also compute cosine, but Tanimoto aligns with bitset overlap and is more common for substructure style features.</p></li>
</ul>
</li>
</ul>
<p>Below are equations:</p>
<ul class="simple">
<li><p><strong>Euclidean distance</strong> between rows <span class="math notranslate nohighlight">\(x_i, x_j \in \mathbb{R}^d\)</span><br />
<span class="math notranslate nohighlight">\(
d_{\text{Euc}}(i,j)=\left\|x_i-x_j\right\|_2=\sqrt{\sum_{k=1}^{d}\left(x_{ik}-x_{jk}\right)^2}
\)</span></p></li>
<li><p><strong>Cosine distance</strong> (1 minus cosine similarity)<br />
<span class="math notranslate nohighlight">\(
d_{\text{Cos}}(i,j)=1-\frac{x_i^\top x_j}{\lVert x_i\rVert_2\,\lVert x_j\rVert_2}
\)</span></p></li>
<li><p><strong>Tanimoto distance</strong> for bit vectors <span class="math notranslate nohighlight">\(b_i,b_j\in\{0,1\}^m\)</span> with on-bit sets <span class="math notranslate nohighlight">\(A,B\)</span><br />
<span class="math notranslate nohighlight">\(
s_{\text{Tan}}(i,j)=\frac{|A\cap B|}{|A|+|B|-|A\cap B|},\qquad
d_{\text{Tan}}(i,j)=1-s_{\text{Tan}}(i,j)
\)</span></p></li>
</ul>
<p>Below we show Euclidean vs Cosine on two standardized columns</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">pairwise_distances</span>

<span class="c1"># two columns for a small, clear demo</span>
<span class="n">cols2</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span> <span class="s2">&quot;TPSA&quot;</span><span class="p">]</span>
<span class="n">X2</span> <span class="o">=</span> <span class="n">df10</span><span class="p">[</span><span class="n">cols2</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="c1"># standardize</span>
<span class="n">X2_std</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X2</span><span class="p">)</span>

<span class="c1"># take a tiny subset to keep visuals readable</span>
<span class="n">Xsmall</span> <span class="o">=</span> <span class="n">X2_std</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span>

<span class="c1"># pairwise distances</span>
<span class="n">D_eu</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">Xsmall</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;euclidean&quot;</span><span class="p">)</span>
<span class="n">D_co</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">Xsmall</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">)</span>

<span class="c1"># heatmaps side by side</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">im0</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">D_eu</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Euclidean distance&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;sample&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;sample&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>

<span class="n">im1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">D_co</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Cosine distance&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;sample&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;sample&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># highlight how neighbors can change across metrics</span>
<span class="n">q</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">eu_nn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">D_eu</span><span class="p">[</span><span class="n">q</span><span class="p">])[</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
<span class="n">co_nn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">D_co</span><span class="p">[</span><span class="n">q</span><span class="p">])[</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Euclidean Nearest Neighbor (rows) for sample #10:&quot;</span><span class="p">,</span> <span class="n">eu_nn</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cosine Nearest Neighbor (rows) for sample #10:&quot;</span><span class="p">,</span> <span class="n">co_nn</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/5fc9122a547b81d17f30e1b6957553b909ed85390d6373090edeada3c928e34a.png" src="_images/5fc9122a547b81d17f30e1b6957553b909ed85390d6373090edeada3c928e34a.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Euclidean Nearest Neighbor (rows) for sample #10: [23, 28, 21, 22, 11]
Cosine Nearest Neighbor (rows) for sample #10: [8, 1, 11, 28, 27]
</pre></div>
</div>
</div>
</div>
<div class="admonition-note admonition">
<p class="admonition-title">Note</p>
<p>Idea is that, the same query point can have different nearest neighbors under Euclidean vs Cosine because one metric cares about absolute offsets while the other cares about direction.</p>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># take first 30 molecules to keep plot compact</span>
<span class="n">fp_strings</span> <span class="o">=</span> <span class="n">df_morgan</span><span class="p">[</span><span class="s2">&quot;Fingerprint&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fp_string_to_bitvect</span><span class="p">(</span><span class="n">fp_str</span><span class="p">):</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">fp_str</span><span class="p">]</span>
    <span class="n">bv</span> <span class="o">=</span> <span class="n">DataStructs</span><span class="o">.</span><span class="n">ExplicitBitVect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">b</span><span class="p">:</span> <span class="n">bv</span><span class="o">.</span><span class="n">SetBit</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bv</span>

<span class="n">fps</span> <span class="o">=</span> <span class="p">[</span><span class="n">fp_string_to_bitvect</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">fp_strings</span><span class="p">]</span>

<span class="c1"># similarities and distances</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fps</span><span class="p">)</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">DataStructs</span><span class="o">.</span><span class="n">BulkTanimotoSimilarity</span><span class="p">(</span><span class="n">fps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fps</span><span class="p">)</span>

<span class="n">D_tan</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">S</span>

<span class="c1"># heatmap</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">D_tan</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Tanimoto distance (Morgan bits)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;sample&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;sample&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># nearest neighbors under Tanimoto</span>
<span class="n">q</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">nn_tan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">D_tan</span><span class="p">[</span><span class="n">q</span><span class="p">])[</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tanimoto NN (rows) for query 10:&quot;</span><span class="p">,</span> <span class="n">nn_tan</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/9a267b4403b808c4f07ff528eb324cbbeceae715e0ae476aabb244ef51893203.png" src="_images/9a267b4403b808c4f07ff528eb324cbbeceae715e0ae476aabb244ef51893203.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tanimoto NN (rows) for query 10: [7, 15, 11, 8, 29]
</pre></div>
</div>
</div>
</div>
<div class="admonition-note admonition">
<p class="admonition-title">Note</p>
<p>Idea is that, small Tanimoto distance means strong bit overlap, which often reflects shared substructures. This is why Tanimoto is standard for fingerprint similarity.</p>
</div>
<p>Below we add a simple 2D plot to <strong>show how nearest neighbors can differ</strong> under different metrics in the same fingerprint space.<br />
We compute a 2D embedding once (PCA on the 0/1 bit matrix) and then draw neighbor connections for all three kinds of distance calculation methods.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">pairwise_distances</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataStructs</span>

<span class="c1"># --- build matrices on the FULL set ---</span>
<span class="n">fp_strings</span> <span class="o">=</span> <span class="n">df_morgan</span><span class="p">[</span><span class="s2">&quot;Fingerprint&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fp_strings</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fp_strings</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fp_string_to_bitvect</span><span class="p">(</span><span class="n">fp_str</span><span class="p">):</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">fp_str</span><span class="p">]</span>
    <span class="n">bv</span> <span class="o">=</span> <span class="n">DataStructs</span><span class="o">.</span><span class="n">ExplicitBitVect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">b</span><span class="p">:</span> <span class="n">bv</span><span class="o">.</span><span class="n">SetBit</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bv</span>

<span class="c1"># RDKit bitvecs for Tanimoto</span>
<span class="n">fp_bvs</span> <span class="o">=</span> <span class="p">[</span><span class="n">fp_string_to_bitvect</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">fp_strings</span><span class="p">]</span>

<span class="c1"># 0/1 matrix for cosine and Euclidean</span>
<span class="n">Xfp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">int</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">fp_strings</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>  <span class="c1"># shape (n, m)</span>

<span class="c1"># --- pairwise distances in ORIGINAL space ---</span>
<span class="c1"># Tanimoto</span>
<span class="n">S_tani</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">S_tani</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">DataStructs</span><span class="o">.</span><span class="n">BulkTanimotoSimilarity</span><span class="p">(</span><span class="n">fp_bvs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fp_bvs</span><span class="p">)</span>
<span class="n">D_tani</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">S_tani</span>

<span class="c1"># Cosine and Euclidean on 0/1 bits</span>
<span class="n">D_cos</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">Xfp</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">)</span>
<span class="n">D_eu</span>  <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">Xfp</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;euclidean&quot;</span><span class="p">)</span>  <span class="c1"># for binary, relates to Hamming</span>

<span class="c1"># --- 2D coordinates for plotting ONLY ---</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">Xfp</span><span class="p">)</span>

<span class="c1"># --- helper for stable top-k excluding self ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">topk_neighbors</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;mergesort&quot;</span><span class="p">)</span>  <span class="c1"># stable</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">order</span> <span class="o">!=</span> <span class="n">q</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">order</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span>

<span class="n">q</span> <span class="o">=</span> <span class="mi">196</span>   <span class="c1"># your example index</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">nn_tani</span> <span class="o">=</span> <span class="n">topk_neighbors</span><span class="p">(</span><span class="n">D_tani</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<span class="n">nn_cos</span>  <span class="o">=</span> <span class="n">topk_neighbors</span><span class="p">(</span><span class="n">D_cos</span><span class="p">,</span>  <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<span class="n">nn_eu</span>   <span class="o">=</span> <span class="n">topk_neighbors</span><span class="p">(</span><span class="n">D_eu</span><span class="p">,</span>   <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tanimoto NN for query&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="n">nn_tani</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cosine   NN for query&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="n">nn_cos</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Euclidean NN for query&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="n">nn_eu</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="c1"># --- three-panel plot: same coords, different neighbor sets ---</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
    <span class="n">a</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Z</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Z</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;lightgrey&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;All points&quot;</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Z</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Query&quot;</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;PC1&quot;</span><span class="p">);</span> <span class="n">a</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;PC2&quot;</span><span class="p">)</span>

<span class="c1"># panel 1: Tanimoto</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="n">nn_tani</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Z</span><span class="p">[</span><span class="n">nn_tani</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;kNN&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">nn_tani</span><span class="p">:</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">Z</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Z</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">Z</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">Z</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Neighbors by Tanimoto&quot;</span><span class="p">)</span>

<span class="c1"># panel 2: Cosine</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="n">nn_cos</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Z</span><span class="p">[</span><span class="n">nn_cos</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;tab:green&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;kNN&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">nn_cos</span><span class="p">:</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">Z</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Z</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">Z</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">Z</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;tab:green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Neighbors by Cosine&quot;</span><span class="p">)</span>

<span class="c1"># panel 3: Euclidean</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="n">nn_eu</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Z</span><span class="p">[</span><span class="n">nn_eu</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;kNN&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">nn_eu</span><span class="p">:</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">Z</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Z</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">Z</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">Z</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Neighbors by Euclidean&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tanimoto NN for query
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 196 -&gt; [237, 414, 434, 11, 107]
Cosine   NN for query 196 -&gt; [237, 414, 434, 107, 11]
Euclidean NN for query 196 -&gt; [107, 122, 237, 414, 9]
</pre></div>
</div>
<img alt="_images/c8c64e2034815df2d40a5840ed332c92a45c7042d1506687dc528430fef225d5.png" src="_images/c8c64e2034815df2d40a5840ed332c92a45c7042d1506687dc528430fef225d5.png" />
</div>
</div>
<p>We can plot both the query molecule and the found neighbors to take a look:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1) Draw the query molecule</span>
<span class="n">q_name</span> <span class="o">=</span> <span class="n">df10</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s2">&quot;Compound Name&quot;</span><span class="p">]</span>
<span class="n">q_smiles</span> <span class="o">=</span> <span class="n">df10</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span>
<span class="n">q_mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">q_smiles</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query #</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">q_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Draw</span><span class="o">.</span><span class="n">MolToImage</span><span class="p">(</span><span class="n">q_mol</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">),</span> <span class="n">legend</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Query: </span><span class="si">{</span><span class="n">q_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>

<span class="c1"># 2) Build a 53 grid of neighbor structures</span>
<span class="c1">#    Row r: [Tanimoto_r, Cosine_r, Euclidean_r]</span>
<span class="n">mols</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">legends</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">add_neighbors</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">nn_idxs</span><span class="p">,</span> <span class="n">dists</span><span class="p">):</span>
    <span class="n">col_mols</span><span class="p">,</span> <span class="n">col_legs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">nn_idxs</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">df10</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;Compound Name&quot;</span><span class="p">]</span>
        <span class="n">smi</span>  <span class="o">=</span> <span class="n">df10</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span>
        <span class="n">mol</span>  <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
        <span class="n">col_mols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">col_legs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">idx=</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">  d=</span><span class="si">{</span><span class="n">dists</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">col_mols</span><span class="p">,</span> <span class="n">col_legs</span>

<span class="c1"># Prepare the three columns (5 neighbors each)</span>
<span class="n">m_tani</span><span class="p">,</span> <span class="n">l_tani</span> <span class="o">=</span> <span class="n">add_neighbors</span><span class="p">(</span><span class="s2">&quot;Tanimoto&quot;</span><span class="p">,</span> <span class="n">nn_tani</span><span class="p">,</span> <span class="n">D_tani</span><span class="p">)</span>
<span class="n">m_cos</span><span class="p">,</span>  <span class="n">l_cos</span>  <span class="o">=</span> <span class="n">add_neighbors</span><span class="p">(</span><span class="s2">&quot;Cosine&quot;</span><span class="p">,</span>   <span class="n">nn_cos</span><span class="p">,</span>  <span class="n">D_cos</span><span class="p">)</span>
<span class="n">m_eu</span><span class="p">,</span>   <span class="n">l_eu</span>   <span class="o">=</span> <span class="n">add_neighbors</span><span class="p">(</span><span class="s2">&quot;Euclidean&quot;</span><span class="p">,</span><span class="n">nn_eu</span><span class="p">,</span>   <span class="n">D_eu</span><span class="p">)</span>

<span class="c1"># Interleave as rows: (Tani[r], Cos[r], Euclid[r]) for r=0..4</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">mols</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">m_tani</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">m_cos</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">m_eu</span><span class="p">[</span><span class="n">r</span><span class="p">]])</span>
    <span class="n">legends</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">l_tani</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">l_cos</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">l_eu</span><span class="p">[</span><span class="n">r</span><span class="p">]])</span>

<span class="c1"># Draw 5 rows  3 columns (molsPerRow=3)</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">Draw</span><span class="o">.</span><span class="n">MolsToGridImage</span><span class="p">(</span>
    <span class="n">mols</span><span class="p">,</span>
    <span class="n">molsPerRow</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">subImgSize</span><span class="o">=</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span> <span class="mi">220</span><span class="p">),</span>
    <span class="n">legends</span><span class="o">=</span><span class="n">legends</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Query #196: 3-methylbutylbenzene
</pre></div>
</div>
<img alt="_images/10007613aa44cb4286c1e36bb8c5ffaab5c4b6b0d37b53cc2a95f9f7b2f6f1f1.png" src="_images/10007613aa44cb4286c1e36bb8c5ffaab5c4b6b0d37b53cc2a95f9f7b2f6f1f1.png" />
<img alt="_images/e59f809b7eaf0d3702fa7b5f4b6fc031fff75eca9f04815b588c5d073cfc7d66.png" src="_images/e59f809b7eaf0d3702fa7b5f4b6fc031fff75eca9f04815b588c5d073cfc7d66.png" />
</div>
</div>
</section>
</section>
<section id="nonlinear-embeddings-t-sne-and-umap">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">4. Nonlinear embeddings: t-SNE and UMAP</a><a class="headerlink" href="#nonlinear-embeddings-t-sne-and-umap" title="Permalink to this heading">#</a></h2>
<p>Linear PCA gives a fast global summary. For curved manifolds or cluster-heavy data, <strong>t-SNE</strong> and <strong>UMAP</strong> often reveal structure that PCA compresses. Both start from a notion of neighborhood in the original feature space and then optimize a 2D or 3D layout that tries to keep neighbors close.</p>
<p>We will use two feature sets:</p>
<ul class="simple">
<li><p><strong>10D scalar descriptors</strong> from <code class="docutils literal notranslate"><span class="pre">df10[desc_cols]</span></code></p></li>
<li><p><strong>64-bit Morgan fingerprints</strong> from <code class="docutils literal notranslate"><span class="pre">df_morgan[&quot;Fingerprint&quot;]</span></code></p></li>
</ul>
<section id="t-sne">
<h3>4.1 t-SNE<a class="headerlink" href="#t-sne" title="Permalink to this heading">#</a></h3>
<p><strong>Idea:</strong> Build probabilities that say which points are neighbors in high-dim, then find a low-dim map whose neighbor probabilities match.</p>
<p><strong>Math:</strong></p>
<ul class="simple">
<li><p>Convert distances to conditional probabilities with a Gaussian kernel per point:
<span class="math notranslate nohighlight">\(
p_{j\mid i}=\frac{\exp\!\left(-\frac{\lVert x_i-x_j\rVert^2}{2\sigma_i^2}\right)}{\sum_{k\ne i}\exp\!\left(-\frac{\lVert x_i-x_k\rVert^2}{2\sigma_i^2}\right)},\quad p_{i\mid i}=0
\)</span>
<span class="math notranslate nohighlight">\(\sigma_i\)</span> is chosen so that the <strong>perplexity</strong> matches a user target (roughly the effective number of neighbors).</p></li>
<li><p>Symmetrize:
<span class="math notranslate nohighlight">\(
P_{ij}=\frac{p_{j\mid i}+p_{i\mid j}}{2n}
\)</span></p></li>
<li><p>In 2D, use a heavy-tailed kernel to define
<span class="math notranslate nohighlight">\(
q_{ij}=\frac{\left(1+\lVert y_i-y_j\rVert^2\right)^{-1}}{\sum_{k\ne \ell}\left(1+\lVert y_k-y_\ell\rVert^2\right)^{-1}},\quad q_{ii}=0
\)</span></p></li>
<li><p>Optimize by minimizing the KullbackLeibler divergence
<span class="math notranslate nohighlight">\(
\operatorname{KL}(P\parallel Q)=\sum_{i\ne j}P_{ij}\log\frac{P_{ij}}{Q_{ij}}.
\)</span>/</p></li>
</ul>
<p><strong>Practical tips:</strong></p>
<ul class="simple">
<li><p>Choose <code class="docutils literal notranslate"><span class="pre">perplexity</span></code> about 5 to 50. For ~500 molecules, start at 30.</p></li>
<li><p>Standardize descriptor matrices. Fingerprints are binary. You can feed them as 0/1, or first reduce to 50 PCs for speed.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.manifold</span><span class="w"> </span><span class="kn">import</span> <span class="n">TSNE</span>

<span class="c1"># ----- features -----</span>
<span class="n">desc_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span><span class="s2">&quot;LogP&quot;</span><span class="p">,</span><span class="s2">&quot;TPSA&quot;</span><span class="p">,</span><span class="s2">&quot;NumRings&quot;</span><span class="p">,</span>
             <span class="s2">&quot;NumHAcceptors&quot;</span><span class="p">,</span><span class="s2">&quot;NumHDonors&quot;</span><span class="p">,</span><span class="s2">&quot;NumRotatableBonds&quot;</span><span class="p">,</span>
             <span class="s2">&quot;HeavyAtomCount&quot;</span><span class="p">,</span><span class="s2">&quot;FractionCSP3&quot;</span><span class="p">,</span><span class="s2">&quot;NumAromaticRings&quot;</span><span class="p">]</span>

<span class="c1"># 10D descriptors: standardize</span>
<span class="n">X_desc</span> <span class="o">=</span> <span class="n">df10</span><span class="p">[</span><span class="n">desc_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">X_desc_std</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_desc</span><span class="p">)</span>

<span class="c1"># 64-bit Morgan: turn &quot;0101...&quot; into 0/1 matrix</span>
<span class="n">X_fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">int</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">df_morgan</span><span class="p">[</span><span class="s2">&quot;Fingerprint&quot;</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># optional: speed-up via PCA(50) before t-SNE on fingerprints</span>
<span class="c1">#X_fp_50 = PCA(n_components=min(50, X_fp.shape[1], X_fp.shape[0]-1), random_state=0).fit_transform(X_fp)</span>

<span class="c1"># ----- t-SNE fits -----</span>
<span class="n">tsne_desc</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">perplexity</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                 <span class="n">init</span><span class="o">=</span><span class="s2">&quot;pca&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">Y_desc</span> <span class="o">=</span> <span class="n">tsne_desc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_desc_std</span><span class="p">)</span>

<span class="n">tsne_fp</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">perplexity</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
               <span class="n">init</span><span class="o">=</span><span class="s2">&quot;pca&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">Y_fp</span> <span class="o">=</span> <span class="n">tsne_fp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_fp</span><span class="p">)</span>

<span class="c1"># ----- plots -----</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_desc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Y_desc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;t-SNE on 10D descriptors&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;tSNE-1&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;tSNE-2&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_fp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Y_fp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;t-SNE on 64-bit Morgan&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;tSNE-1&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;tSNE-2&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0324707e670f07b1f2a4d53872adf45a0da3bdcf978349bbb8644e4c3116eab4.png" src="_images/0324707e670f07b1f2a4d53872adf45a0da3bdcf978349bbb8644e4c3116eab4.png" />
</div>
</div>
</section>
<section id="umap">
<h3>4.2 UMAP<a class="headerlink" href="#umap" title="Permalink to this heading">#</a></h3>
<p><strong>Idea:</strong> Build a weighted kNN graph in the original space, interpret it as a fuzzy set of edges, then find low dimensional coordinates that preserve this fuzzy structure.</p>
<p><strong>Math:</strong></p>
<ul class="simple">
<li><p>For each point (i), choose a local connectivity scale so that exactly (k) neighbors have significant membership. Convert distances to directed fuzzy memberships <span class="math notranslate nohighlight">\(\mu_{i\to j}\in[0,1]\)</span>.</p></li>
<li><p>Symmetrize with fuzzy union
<span class="math notranslate nohighlight">\(
\mu_{ij} = \mu_{i\to j} + \mu_{j\to i} - \mu_{i\to j}\mu_{j\to i}
\)</span></p></li>
<li><p>In low dimension, define a differentiable edge likelihood controlled by <strong>spread</strong> and <strong>min_dist</strong>. Optimize a cross entropy between the high dimensional and low dimensional fuzzy graphs with negative sampling.</p></li>
</ul>
<p><strong>Practice:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">n_neighbors</span></code> sets the balance of local vs global. Small values focus on fine detail, larger values keep more global structure. Start at 15 to 50.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">min_dist</span></code> controls cluster tightness. Smaller values allow tighter blobs, larger values spread points.</p></li>
<li><p>UMAP supports <code class="docutils literal notranslate"><span class="pre">.transform</span></code>, so you can fit on train then place test without leakage. For fingerprints, <code class="docutils literal notranslate"><span class="pre">metric=&quot;jaccard&quot;</span></code> matches Tanimoto on 0 or 1 bits.</p></li>
</ul>
<div class="admonition-note admonition">
<p class="admonition-title">Note</p>
<p>We will skip the code here, please them run in Colab.</p>
</div>
<p>So how these compare in chemistry?</p>
<p><strong>In terms of global shape:</strong></p>
<ul class="simple">
<li><p>PCA preserves coarse directions of variance and is easy to interpret through loadings.
-UMAP can keep some global relations if <code class="docutils literal notranslate"><span class="pre">n_neighbors</span></code> is set higher.
-t-SNE focuses on local neighborhoods and often distorts large scale distances.</p></li>
</ul>
<p><strong>For clusters:</strong></p>
<ul class="simple">
<li><p>t-SNE and UMAP usually separate clusters more clearly than PCA.</p></li>
<li><p>UMAP tends to preserve relative distances between clusters better than t-SNE.</p></li>
</ul>
<p><strong>Workflow tips.</strong></p>
<ol class="arabic simple">
<li><p>Decide the feature family. For scalar descriptors, standardize first. For fingerprints, keep bits and pick a metric that matches chemistry.</p></li>
<li><p>If you plan any evaluation, split first. Fit scalers and embedding models on train only. Transform test afterward.</p></li>
<li><p>Read maps with labels only for interpretation. Do not feed labels during fitting in unsupervised sections.</p></li>
</ol>
<p>Summary:
PCA finds orthogonal directions of variance. t-SNE preserves neighbor probabilities and is great for tight clusters. UMAP preserves a fuzzy kNN graph and supports transforming new points. On molecules, try both t-SNE and UMAP on descriptors and fingerprints, then read the plots with domain knowledge rather than expecting one single correct picture.</p>
</section>
</section>
<hr class="docutils" />
<section id="glossary">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">5. Glossary</a><a class="headerlink" href="#glossary" title="Permalink to this heading">#</a></h2>
<dl class="simple glossary">
<dt id="term-dimension-reduction">dimension reduction<a class="headerlink" href="#term-dimension-reduction" title="Permalink to this term">#</a></dt><dd><p>Map <span class="math notranslate nohighlight">\(p\)</span>-dimensional features to a few coordinates that keep the most structure for your task.</p>
</dd>
<dt id="term-PCA">PCA<a class="headerlink" href="#term-PCA" title="Permalink to this term">#</a></dt><dd><p>Linear method that finds orthogonal directions of maximum variance.</p>
</dd>
<dt id="term-loading">loading<a class="headerlink" href="#term-loading" title="Permalink to this term">#</a></dt><dd><p>The weight of each original feature for a principal component.</p>
</dd>
<dt id="term-scree-plot">scree plot<a class="headerlink" href="#term-scree-plot" title="Permalink to this term">#</a></dt><dd><p>Bar or line plot of explained variance ratio per PC.</p>
</dd>
<dt id="term-t-SNE">t-SNE<a class="headerlink" href="#term-t-SNE" title="Permalink to this term">#</a></dt><dd><p>Nonlinear embedding that preserves local neighbor relations. Uses a KL divergence objective.</p>
</dd>
<dt id="term-UMAP">UMAP<a class="headerlink" href="#term-UMAP" title="Permalink to this term">#</a></dt><dd><p>Graph-based embedding that models fuzzy set cross entropy on a kNN graph.</p>
</dd>
</dl>
</section>
<hr class="docutils" />
<section id="in-class-activity">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">6. In-class activity</a><a class="headerlink" href="#in-class-activity" title="Permalink to this heading">#</a></h2>
<p>Scenario:
You are screening 20 candidate bio-inhibitors from three chemotypes. Your goal is to build quick descriptor and fingerprint views, create 2D maps, and compare nearest neighbors under different distances before moving to assays.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fixed 20 compounds with groups (3 clusters)</span>
<span class="n">mol_records</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Group A - hydrophobic aromatics</span>
    <span class="p">(</span><span class="s2">&quot;Toluene&quot;</span><span class="p">,</span>               <span class="s2">&quot;Cc1ccccc1&quot;</span><span class="p">,</span>                <span class="s2">&quot;A_hydrophobic_aromatics&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Ethylbenzene&quot;</span><span class="p">,</span>          <span class="s2">&quot;CCc1ccccc1&quot;</span><span class="p">,</span>               <span class="s2">&quot;A_hydrophobic_aromatics&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Propylbenzene&quot;</span><span class="p">,</span>         <span class="s2">&quot;CCCc1ccccc1&quot;</span><span class="p">,</span>              <span class="s2">&quot;A_hydrophobic_aromatics&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;p-Xylene&quot;</span><span class="p">,</span>              <span class="s2">&quot;Cc1ccc(cc1)C&quot;</span><span class="p">,</span>             <span class="s2">&quot;A_hydrophobic_aromatics&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Cumene&quot;</span><span class="p">,</span>                <span class="s2">&quot;CC(C)c1ccccc1&quot;</span><span class="p">,</span>            <span class="s2">&quot;A_hydrophobic_aromatics&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Mesitylene&quot;</span><span class="p">,</span>            <span class="s2">&quot;Cc1cc(C)cc(C)c1&quot;</span><span class="p">,</span>          <span class="s2">&quot;A_hydrophobic_aromatics&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Isobutylbenzene&quot;</span><span class="p">,</span>       <span class="s2">&quot;CC(C)Cc1ccccc1&quot;</span><span class="p">,</span>           <span class="s2">&quot;A_hydrophobic_aromatics&quot;</span><span class="p">),</span>

    <span class="c1"># Group B - polar alcohols and acids</span>
    <span class="p">(</span><span class="s2">&quot;Acetic acid&quot;</span><span class="p">,</span>           <span class="s2">&quot;CC(=O)O&quot;</span><span class="p">,</span>                  <span class="s2">&quot;B_polar_alc_acid&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Propionic acid&quot;</span><span class="p">,</span>        <span class="s2">&quot;CCC(=O)O&quot;</span><span class="p">,</span>                 <span class="s2">&quot;B_polar_alc_acid&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Butanoic acid&quot;</span><span class="p">,</span>         <span class="s2">&quot;CCCC(=O)O&quot;</span><span class="p">,</span>                <span class="s2">&quot;B_polar_alc_acid&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Ethanol&quot;</span><span class="p">,</span>               <span class="s2">&quot;CCO&quot;</span><span class="p">,</span>                      <span class="s2">&quot;B_polar_alc_acid&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;1-Propanol&quot;</span><span class="p">,</span>            <span class="s2">&quot;CCCO&quot;</span><span class="p">,</span>                     <span class="s2">&quot;B_polar_alc_acid&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;1-Butanol&quot;</span><span class="p">,</span>             <span class="s2">&quot;CCCCO&quot;</span><span class="p">,</span>                    <span class="s2">&quot;B_polar_alc_acid&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Ethylene glycol&quot;</span><span class="p">,</span>       <span class="s2">&quot;OCCO&quot;</span><span class="p">,</span>                     <span class="s2">&quot;B_polar_alc_acid&quot;</span><span class="p">),</span>

    <span class="c1"># Group C - nitrogen hetero and amines</span>
    <span class="p">(</span><span class="s2">&quot;Pyridine&quot;</span><span class="p">,</span>              <span class="s2">&quot;n1ccccc1&quot;</span><span class="p">,</span>                 <span class="s2">&quot;C_N_hetero_amines&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Aniline&quot;</span><span class="p">,</span>               <span class="s2">&quot;Nc1ccccc1&quot;</span><span class="p">,</span>                <span class="s2">&quot;C_N_hetero_amines&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Dimethylaniline&quot;</span><span class="p">,</span>       <span class="s2">&quot;CN(C)c1ccccc1&quot;</span><span class="p">,</span>            <span class="s2">&quot;C_N_hetero_amines&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Imidazole&quot;</span><span class="p">,</span>             <span class="s2">&quot;c1ncc[nH]1&quot;</span><span class="p">,</span>               <span class="s2">&quot;C_N_hetero_amines&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Morpholine&quot;</span><span class="p">,</span>            <span class="s2">&quot;O1CCNCC1&quot;</span><span class="p">,</span>                 <span class="s2">&quot;C_N_hetero_amines&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Piperidine&quot;</span><span class="p">,</span>            <span class="s2">&quot;N1CCCCC1&quot;</span><span class="p">,</span>                 <span class="s2">&quot;C_N_hetero_amines&quot;</span><span class="p">),</span>
<span class="p">]</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="n">df_20</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mol_records</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Compound Name&quot;</span><span class="p">,</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span><span class="s2">&quot;Group&quot;</span><span class="p">])</span>
<span class="n">df_20</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Compound Name</th>
      <th>SMILES</th>
      <th>Group</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Toluene</td>
      <td>Cc1ccccc1</td>
      <td>A_hydrophobic_aromatics</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Ethylbenzene</td>
      <td>CCc1ccccc1</td>
      <td>A_hydrophobic_aromatics</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Propylbenzene</td>
      <td>CCCc1ccccc1</td>
      <td>A_hydrophobic_aromatics</td>
    </tr>
    <tr>
      <th>3</th>
      <td>p-Xylene</td>
      <td>Cc1ccc(cc1)C</td>
      <td>A_hydrophobic_aromatics</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Cumene</td>
      <td>CC(C)c1ccccc1</td>
      <td>A_hydrophobic_aromatics</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Mesitylene</td>
      <td>Cc1cc(C)cc(C)c1</td>
      <td>A_hydrophobic_aromatics</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Isobutylbenzene</td>
      <td>CC(C)Cc1ccccc1</td>
      <td>A_hydrophobic_aromatics</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Acetic acid</td>
      <td>CC(=O)O</td>
      <td>B_polar_alc_acid</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Propionic acid</td>
      <td>CCC(=O)O</td>
      <td>B_polar_alc_acid</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Butanoic acid</td>
      <td>CCCC(=O)O</td>
      <td>B_polar_alc_acid</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Ethanol</td>
      <td>CCO</td>
      <td>B_polar_alc_acid</td>
    </tr>
    <tr>
      <th>11</th>
      <td>1-Propanol</td>
      <td>CCCO</td>
      <td>B_polar_alc_acid</td>
    </tr>
    <tr>
      <th>12</th>
      <td>1-Butanol</td>
      <td>CCCCO</td>
      <td>B_polar_alc_acid</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Ethylene glycol</td>
      <td>OCCO</td>
      <td>B_polar_alc_acid</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Pyridine</td>
      <td>n1ccccc1</td>
      <td>C_N_hetero_amines</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Aniline</td>
      <td>Nc1ccccc1</td>
      <td>C_N_hetero_amines</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Dimethylaniline</td>
      <td>CN(C)c1ccccc1</td>
      <td>C_N_hetero_amines</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Imidazole</td>
      <td>c1ncc[nH]1</td>
      <td>C_N_hetero_amines</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Morpholine</td>
      <td>O1CCNCC1</td>
      <td>C_N_hetero_amines</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Piperidine</td>
      <td>N1CCCCC1</td>
      <td>C_N_hetero_amines</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="q1-build-feature-sets-and-print-compact-summaries">
<h3><strong>Q1. Build feature sets and print compact summaries</strong><a class="headerlink" href="#q1-build-feature-sets-and-print-compact-summaries" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Using <code class="docutils literal notranslate"><span class="pre">calc_descriptors10</span></code> we defined earlier today, create a 2010 descriptor table <code class="docutils literal notranslate"><span class="pre">df_fp_20</span></code> for these molecules.</p></li>
<li><p>Using <code class="docutils literal notranslate"><span class="pre">morgan_bits</span></code> with <code class="docutils literal notranslate"><span class="pre">n_bits=64</span></code> and <code class="docutils literal notranslate"><span class="pre">radius=2</span></code>, create a 64-bit fingerprint string for each molecule.</p></li>
<li><p>Show the first 24 bits of the fingerprint for all 20 molecules.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#TO DO</span>
</pre></div>
</div>
</section>
<section id="q2-pca-on-10-descriptors">
<h3><strong>Q2. PCA on 10 descriptors</strong><a class="headerlink" href="#q2-pca-on-10-descriptors" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Build a feature matrix <code class="docutils literal notranslate"><span class="pre">X_desc</span></code> from the 10 descriptor columns, then standardize with <code class="docutils literal notranslate"><span class="pre">StandardScaler()</span></code>, call it <code class="docutils literal notranslate"><span class="pre">X_desc_std</span></code>.</p></li>
<li><p>Fit <code class="docutils literal notranslate"><span class="pre">PCA()</span></code> on standardized data and project to 2D.</p></li>
<li><p>Create a scatter. Optional: add text labels for each molecule.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#TO DO</span>
</pre></div>
</div>
</section>
<section id="q3-t-sne-on-10-descriptors">
<h3><strong>Q3. t-SNE on 10 descriptors</strong><a class="headerlink" href="#q3-t-sne-on-10-descriptors" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Use the same standardized 10D matrix <code class="docutils literal notranslate"><span class="pre">X_desc_std</span></code>.</p></li>
<li><p>Fit t-SNE with <code class="docutils literal notranslate"><span class="pre">n_components=2</span></code>, <code class="docutils literal notranslate"><span class="pre">perplexity=5</span></code>, <code class="docutils literal notranslate"><span class="pre">init=&quot;pca&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">learning_rate=&quot;auto&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">n_iter=1000</span></code>, <code class="docutils literal notranslate"><span class="pre">random_state=0</span></code>.</p></li>
<li><p>Make a scatter with text labels</p></li>
<li><p>Change <code class="docutils literal notranslate"><span class="pre">perplexity</span></code> to <code class="docutils literal notranslate"><span class="pre">2</span></code>, <code class="docutils literal notranslate"><span class="pre">10</span></code>, and <code class="docutils literal notranslate"><span class="pre">15</span></code>, see how they are different from each other.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#TO DO</span>
</pre></div>
</div>
</section>
<section id="q4-pca-and-t-sne-on-morgan-64-fingerprints">
<h3><strong>Q4. PCA and t-SNE on Morgan-64 fingerprints</strong><a class="headerlink" href="#q4-pca-and-t-sne-on-morgan-64-fingerprints" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Convert each 64-bit fingerprint string to a row of 0 or 1 to form a 2064 matrix X_fp.</p></li>
<li><p>Run PCA to 2D and plot with labels <strong>and</strong> t-SNE to 2D on <code class="docutils literal notranslate"><span class="pre">X_fp</span></code> with the same t-SNE settings as Q3, and plot with labels.</p></li>
<li><p>Compare with Q3</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#TO DO</span>
</pre></div>
</div>
</section>
<section id="q5-nearest-5-neighbors-descriptors-vs-fingerprints">
<h3><strong>Q5. Nearest 5 neighbors - descriptors vs fingerprints</strong><a class="headerlink" href="#q5-nearest-5-neighbors-descriptors-vs-fingerprints" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Pick a query molecule index <code class="docutils literal notranslate"><span class="pre">q</span></code> between <code class="docutils literal notranslate"><span class="pre">0</span></code> and <code class="docutils literal notranslate"><span class="pre">19</span></code></p></li>
<li><p>Compute a 2020 Euclidean distance matrix on <code class="docutils literal notranslate"><span class="pre">X_desc_std</span></code> and list the 5 closest neighbors of <code class="docutils literal notranslate"><span class="pre">q</span></code> (exclude itself).</p></li>
<li><p>Compute a 2020 Tanimoto distance matrix for the fingerprints and list the 5 closest neighbors of <code class="docutils literal notranslate"><span class="pre">q</span></code>.</p></li>
<li><p>Compare the two neighbor lists. Which list better respects group membership for this query?</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#TO DO</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="solution">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">7. Solution</a><a class="headerlink" href="#solution" title="Permalink to this heading">#</a></h2>
<section id="q1">
<h3>Q1<a class="headerlink" href="#q1" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Q1 - Solution</span>

<span class="c1"># 10-descriptor table</span>
<span class="n">desc10_20</span> <span class="o">=</span> <span class="n">df_20</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">calc_descriptors10</span><span class="p">)</span>
<span class="n">df10_20</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_20</span><span class="p">[[</span><span class="s2">&quot;Compound Name&quot;</span><span class="p">,</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span><span class="s2">&quot;Group&quot;</span><span class="p">]],</span> <span class="n">desc10_20</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 64-bit Morgan fingerprints</span>
<span class="n">df_fp_20</span> <span class="o">=</span> <span class="n">df_20</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_fp_20</span><span class="p">[</span><span class="s2">&quot;Fingerprint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_fp_20</span><span class="p">[</span><span class="s2">&quot;SMILES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">morgan_bits</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n_bits</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;10-descriptor table (head):&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df10_20</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fingerprint preview (first 24 bits):&quot;</span><span class="p">)</span>
<span class="n">fp_preview</span> <span class="o">=</span> <span class="n">df_fp_20</span><span class="p">[[</span><span class="s2">&quot;Compound Name&quot;</span><span class="p">,</span><span class="s2">&quot;Group&quot;</span><span class="p">,</span><span class="s2">&quot;Fingerprint&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">fp_preview</span><span class="p">[</span><span class="s2">&quot;Fingerprint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp_preview</span><span class="p">[</span><span class="s2">&quot;Fingerprint&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
<span class="n">display</span><span class="p">(</span><span class="n">fp_preview</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Descriptor stats:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df10_20</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Compound Name&quot;</span><span class="p">,</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span><span class="s2">&quot;Group&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span><span class="s2">&quot;std&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10-descriptor table (head):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Compound Name</th>
      <th>SMILES</th>
      <th>Group</th>
      <th>MolWt</th>
      <th>LogP</th>
      <th>TPSA</th>
      <th>NumRings</th>
      <th>NumHAcceptors</th>
      <th>NumHDonors</th>
      <th>NumRotatableBonds</th>
      <th>HeavyAtomCount</th>
      <th>FractionCSP3</th>
      <th>NumAromaticRings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Toluene</td>
      <td>Cc1ccccc1</td>
      <td>A_hydrophobic_aromatics</td>
      <td>92.141</td>
      <td>1.995</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>7.0</td>
      <td>0.143</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Ethylbenzene</td>
      <td>CCc1ccccc1</td>
      <td>A_hydrophobic_aromatics</td>
      <td>106.168</td>
      <td>2.249</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>8.0</td>
      <td>0.250</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Propylbenzene</td>
      <td>CCCc1ccccc1</td>
      <td>A_hydrophobic_aromatics</td>
      <td>120.195</td>
      <td>2.639</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>9.0</td>
      <td>0.333</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>p-Xylene</td>
      <td>Cc1ccc(cc1)C</td>
      <td>A_hydrophobic_aromatics</td>
      <td>106.168</td>
      <td>2.303</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>8.0</td>
      <td>0.250</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Cumene</td>
      <td>CC(C)c1ccccc1</td>
      <td>A_hydrophobic_aromatics</td>
      <td>120.195</td>
      <td>2.810</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>9.0</td>
      <td>0.333</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fingerprint preview (first 24 bits):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Compound Name</th>
      <th>Group</th>
      <th>Fingerprint</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Toluene</td>
      <td>A_hydrophobic_aromatics</td>
      <td>100001000000000001000010...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Ethylbenzene</td>
      <td>A_hydrophobic_aromatics</td>
      <td>100001010000000111000010...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Propylbenzene</td>
      <td>A_hydrophobic_aromatics</td>
      <td>100001000000000111000110...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>p-Xylene</td>
      <td>A_hydrophobic_aromatics</td>
      <td>100000000000000001000010...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Cumene</td>
      <td>A_hydrophobic_aromatics</td>
      <td>110001000000100001000110...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Mesitylene</td>
      <td>A_hydrophobic_aromatics</td>
      <td>000000000000000001000000...</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Isobutylbenzene</td>
      <td>A_hydrophobic_aromatics</td>
      <td>110001000000000111000010...</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Acetic acid</td>
      <td>B_polar_alc_acid</td>
      <td>000001000010000000000000...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Propionic acid</td>
      <td>B_polar_alc_acid</td>
      <td>001001000110000010000000...</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Butanoic acid</td>
      <td>B_polar_alc_acid</td>
      <td>000001010110010010000000...</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Ethanol</td>
      <td>B_polar_alc_acid</td>
      <td>001000000000000010000000...</td>
    </tr>
    <tr>
      <th>11</th>
      <td>1-Propanol</td>
      <td>B_polar_alc_acid</td>
      <td>000000000000000010000000...</td>
    </tr>
    <tr>
      <th>12</th>
      <td>1-Butanol</td>
      <td>B_polar_alc_acid</td>
      <td>000000000000000110000000...</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Ethylene glycol</td>
      <td>B_polar_alc_acid</td>
      <td>000000000000000010000000...</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Pyridine</td>
      <td>C_N_hetero_amines</td>
      <td>100101000010000001000000...</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Aniline</td>
      <td>C_N_hetero_amines</td>
      <td>100001000000100001010010...</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Dimethylaniline</td>
      <td>C_N_hetero_amines</td>
      <td>100001001001000001000010...</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Imidazole</td>
      <td>C_N_hetero_amines</td>
      <td>001100000110000001000000...</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Morpholine</td>
      <td>C_N_hetero_amines</td>
      <td>000100000001000010000000...</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Piperidine</td>
      <td>C_N_hetero_amines</td>
      <td>001011000000000000000000...</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Descriptor stats:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>MolWt</th>
      <th>LogP</th>
      <th>TPSA</th>
      <th>NumRings</th>
      <th>NumHAcceptors</th>
      <th>NumHDonors</th>
      <th>NumRotatableBonds</th>
      <th>HeavyAtomCount</th>
      <th>FractionCSP3</th>
      <th>NumAromaticRings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>mean</th>
      <td>89.882</td>
      <td>1.198</td>
      <td>15.858</td>
      <td>0.650</td>
      <td>0.750</td>
      <td>0.600</td>
      <td>0.700</td>
      <td>6.500</td>
      <td>0.51</td>
      <td>0.55</td>
    </tr>
    <tr>
      <th>std</th>
      <td>24.965</td>
      <td>1.152</td>
      <td>15.012</td>
      <td>0.489</td>
      <td>0.639</td>
      <td>0.598</td>
      <td>0.801</td>
      <td>2.065</td>
      <td>0.38</td>
      <td>0.51</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="q2">
<h3>Q2<a class="headerlink" href="#q2" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Q2 - Solution</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>

<span class="n">desc_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MolWt&quot;</span><span class="p">,</span><span class="s2">&quot;LogP&quot;</span><span class="p">,</span><span class="s2">&quot;TPSA&quot;</span><span class="p">,</span><span class="s2">&quot;NumRings&quot;</span><span class="p">,</span>
             <span class="s2">&quot;NumHAcceptors&quot;</span><span class="p">,</span><span class="s2">&quot;NumHDonors&quot;</span><span class="p">,</span><span class="s2">&quot;NumRotatableBonds&quot;</span><span class="p">,</span>
             <span class="s2">&quot;HeavyAtomCount&quot;</span><span class="p">,</span><span class="s2">&quot;FractionCSP3&quot;</span><span class="p">,</span><span class="s2">&quot;NumAromaticRings&quot;</span><span class="p">]</span>

<span class="n">X_desc</span> <span class="o">=</span> <span class="n">df10_20</span><span class="p">[</span><span class="n">desc_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">X_desc_std</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_desc</span><span class="p">)</span>

<span class="n">pca_desc_full</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_desc_std</span><span class="p">)</span>
<span class="n">Z_desc</span> <span class="o">=</span> <span class="n">pca_desc_full</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_desc_std</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>

<span class="c1"># color map by group</span>
<span class="n">group_to_color</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;A_hydrophobic_aromatics&quot;</span><span class="p">:</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;B_polar_alc_acid&quot;</span><span class="p">:</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;C_N_hetero_amines&quot;</span><span class="p">:</span><span class="s2">&quot;tab:green&quot;</span><span class="p">}</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">df10_20</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">group_to_color</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="c1"># explained variance</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">pca_desc_full</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Number of PCs&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative EVR&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 2D scatter with labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Z_desc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Z_desc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df10_20</span><span class="p">[</span><span class="s2">&quot;Compound Name&quot;</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">Z_desc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">Z_desc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;PC1&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;PC2&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;PCA on 10 descriptors (n=20)&quot;</span><span class="p">)</span>
<span class="c1"># legend</span>
<span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">group_to_color</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7e788b72654f54bcc8a9f24d431a4ff4db1c81ee61d8aff98e263c957d57ead7.png" src="_images/7e788b72654f54bcc8a9f24d431a4ff4db1c81ee61d8aff98e263c957d57ead7.png" />
<img alt="_images/992760836a5b630003fff4f1c4301378e0439cde76005ffd9196f1cd4cd9b8a8.png" src="_images/992760836a5b630003fff4f1c4301378e0439cde76005ffd9196f1cd4cd9b8a8.png" />
</div>
</div>
</section>
<section id="q3">
<h3>Q3<a class="headerlink" href="#q3" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Q3 - Solution</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.manifold</span><span class="w"> </span><span class="kn">import</span> <span class="n">TSNE</span>

<span class="n">tsne_desc</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">perplexity</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                 <span class="n">init</span><span class="o">=</span><span class="s2">&quot;pca&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">Y_desc</span> <span class="o">=</span> <span class="n">tsne_desc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_desc_std</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_desc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Y_desc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df10_20</span><span class="p">[</span><span class="s2">&quot;Compound Name&quot;</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">Y_desc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">Y_desc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;tSNE-1&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;tSNE-2&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;t-SNE on 10 descriptors (n=20)&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">group_to_color</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e290a97d33408bff7cd357bd1f49d290d7c76d94442593123e7c547424799edf.png" src="_images/e290a97d33408bff7cd357bd1f49d290d7c76d94442593123e7c547424799edf.png" />
</div>
</div>
</section>
<section id="q4">
<h3>Q4<a class="headerlink" href="#q4" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Q4 - Solution</span>

<span class="c1"># 0/1 matrix from bitstrings</span>
<span class="n">X_fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">int</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">df_fp_20</span><span class="p">[</span><span class="s2">&quot;Fingerprint&quot;</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># PCA on fingerprint bits</span>
<span class="n">pca_fp</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_fp</span><span class="p">)</span>
<span class="n">Z_fp_pca</span> <span class="o">=</span> <span class="n">pca_fp</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_fp</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Z_fp_pca</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Z_fp_pca</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_fp_20</span><span class="p">[</span><span class="s2">&quot;Compound Name&quot;</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">Z_fp_pca</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">Z_fp_pca</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;PC1&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;PC2&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;PCA on Morgan-64 (n=20)&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">group_to_color</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># t-SNE on fingerprint bits</span>
<span class="n">tsne_fp</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">perplexity</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
               <span class="n">init</span><span class="o">=</span><span class="s2">&quot;pca&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">Y_fp</span> <span class="o">=</span> <span class="n">tsne_fp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_fp</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_fp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Y_fp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_fp_20</span><span class="p">[</span><span class="s2">&quot;Compound Name&quot;</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">Y_fp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">Y_fp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;tSNE-1&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;tSNE-2&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;t-SNE on Morgan-64 (n=20)&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">group_to_color</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/76d49a061ee52131dbf5839a2908900d819ea877641b11f65fed8f83191587c5.png" src="_images/76d49a061ee52131dbf5839a2908900d819ea877641b11f65fed8f83191587c5.png" />
<img alt="_images/5a7492af60ef4b30d6c7372bcbbe24f1a0430f23a957a810c6cef2a0ee113bf8.png" src="_images/5a7492af60ef4b30d6c7372bcbbe24f1a0430f23a957a810c6cef2a0ee113bf8.png" />
</div>
</div>
</section>
<section id="q5">
<h3>Q5<a class="headerlink" href="#q5" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Q5 - Solution</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">pairwise_distances</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataStructs</span>

<span class="c1"># choose a query row</span>
<span class="n">q</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># change during class to test different queries</span>

<span class="c1"># 1) Euclidean on standardized 10D descriptors</span>
<span class="n">D_eu</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">X_desc_std</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;euclidean&quot;</span><span class="p">)</span>
<span class="n">order_eu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">D_eu</span><span class="p">[</span><span class="n">q</span><span class="p">])</span>
<span class="n">nn_eu_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order_eu</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">q</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query: </span><span class="si">{</span><span class="n">df10_20</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;Compound Name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">  |  Group: </span><span class="si">{</span><span class="n">df10_20</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Nearest 5 by Euclidean (10 descriptors):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">nn_eu_idx</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">df10_20</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="s1">&#39;Compound Name&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">24s</span><span class="si">}</span><span class="s2">  group=</span><span class="si">{</span><span class="n">df10_20</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">22s</span><span class="si">}</span><span class="s2">  d_eu=</span><span class="si">{</span><span class="n">D_eu</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 2) Tanimoto on 64-bit fingerprints</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fp_string_to_bvect</span><span class="p">(</span><span class="n">fp_str</span><span class="p">):</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">fp_str</span><span class="p">]</span>
    <span class="n">bv</span> <span class="o">=</span> <span class="n">DataStructs</span><span class="o">.</span><span class="n">ExplicitBitVect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">b</span><span class="p">:</span> <span class="n">bv</span><span class="o">.</span><span class="n">SetBit</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bv</span>

<span class="n">fps</span> <span class="o">=</span> <span class="p">[</span><span class="n">fp_string_to_bvect</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">df_fp_20</span><span class="p">[</span><span class="s2">&quot;Fingerprint&quot;</span><span class="p">]]</span>
<span class="n">S_tan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fps</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">fps</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fps</span><span class="p">)):</span>
    <span class="n">S_tan</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">DataStructs</span><span class="o">.</span><span class="n">BulkTanimotoSimilarity</span><span class="p">(</span><span class="n">fps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fps</span><span class="p">)</span>
<span class="n">D_tan</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">S_tan</span>

<span class="n">order_tan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">D_tan</span><span class="p">[</span><span class="n">q</span><span class="p">])</span>
<span class="n">nn_tan_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order_tan</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">q</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Nearest 5 by Tanimoto (Morgan-64):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">nn_tan_idx</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">df10_20</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="s1">&#39;Compound Name&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">24s</span><span class="si">}</span><span class="s2">  group=</span><span class="si">{</span><span class="n">df10_20</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">22s</span><span class="si">}</span><span class="s2">  d_tan=</span><span class="si">{</span><span class="n">D_tan</span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Query: p-Xylene  |  Group: A_hydrophobic_aromatics

Nearest 5 by Euclidean (10 descriptors):
  Mesitylene                group=A_hydrophobic_aromatics  d_eu=0.840
  Toluene                   group=A_hydrophobic_aromatics  d_eu=0.859
  Ethylbenzene              group=A_hydrophobic_aromatics  d_eu=1.281
  Cumene                    group=A_hydrophobic_aromatics  d_eu=1.572
  Dimethylaniline           group=C_N_hetero_amines       d_eu=2.267

Nearest 5 by Tanimoto (Morgan-64):
  Toluene                   group=A_hydrophobic_aromatics  d_tan=0.300
  Mesitylene                group=A_hydrophobic_aromatics  d_tan=0.333
  Dimethylaniline           group=C_N_hetero_amines       d_tan=0.667
  Ethylbenzene              group=A_hydrophobic_aromatics  d_tan=0.688
  Cumene                    group=A_hydrophobic_aromatics  d_tan=0.688
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="lecture-10.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Lecture 10 - Property &amp; Reaction Prediction</p>
      </div>
    </a>
    <a class="right-next"
       href="lecture-12.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Lecture 12 - Self-Supervised Learning</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-and-data">1. Setup and data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#supervised-vs-unsupervised">2. Supervised vs unsupervised</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#principal-component-analysis-pca">2.1 Principal Component Analysis (PCA)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-leakage-in-unsupervised-settings">2.2 Data leakage in unsupervised settings</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#standardization-and-distance">3. Standardization and distance</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-standardize">3.1 Why standardize</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#which-distance-to-use">3.2 Which distance to use</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nonlinear-embeddings-t-sne-and-umap">4. Nonlinear embeddings: t-SNE and UMAP</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#t-sne">4.1 t-SNE</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#umap">4.2 UMAP</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">5. Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-class-activity">6. In-class activity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q1-build-feature-sets-and-print-compact-summaries"><strong>Q1. Build feature sets and print compact summaries</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q2-pca-on-10-descriptors"><strong>Q2. PCA on 10 descriptors</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q3-t-sne-on-10-descriptors"><strong>Q3. t-SNE on 10 descriptors</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q4-pca-and-t-sne-on-morgan-64-fingerprints"><strong>Q4. PCA and t-SNE on Morgan-64 fingerprints</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q5-nearest-5-neighbors-descriptors-vs-fingerprints"><strong>Q5. Nearest 5 neighbors - descriptors vs fingerprints</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solution">7. Solution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q1">Q1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q2">Q2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q3">Q3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q4">Q4</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q5">Q5</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>